<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <title>HUB UNO — Unified Minimal Glow (v3.4 · Monólito)</title>
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root {
      /* Paleta e tokens */
      --grad-a: #ff52e5;
      --grad-b: #00c5e5;
      --fg: #f5f7ff;
      --mut: rgba(245, 247, 255, .68);
      --surface: rgba(15, 17, 32, .50);
      --surface-strong: rgba(15, 17, 32, .88);
      --bd: 1px solid rgba(255, 255, 255, .12);
      --ok: #39ffb6;
      --warn: #ffb86b;
      --err: #ff6b6b;
      --r: 18px;
      --r2: 22px;
      --shadow: 0 14px 40px rgba(0, 0, 0, .45);
      --tabsH: 74px;
      --hdrH: 64px;
      --blur: 18px;
      --ease: cubic-bezier(.22, .61, .36, 1);
    }

    * { box-sizing: border-box }
    html, body { height: 100% }

    body {
      margin: 0;
      color: var(--fg);
      background: linear-gradient(42deg, var(--grad-a), var(--grad-b)) fixed;
      font: 14px/1.45 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      overflow: hidden;
    }

    /* ===== Micro-interações base ===== */
    .fx-trans { transition: transform .16s var(--ease), background .25s var(--ease), box-shadow .25s var(--ease), border-color .25s var(--ease), color .25s var(--ease), opacity .25s var(--ease) }
    .fx-lift:hover { transform: translateY(-1px) }
    .fx-press:active { transform: translateY(0) scale(.98) }
    .ring:focus-visible { outline: 0; box-shadow: 0 0 0 4px rgba(255,255,255,.14) }
    @media (prefers-reduced-motion: reduce) { .fx-trans { transition: none } }

    /* ===== Botões ===== */
    button, .btn, .ib { background: var(--surface); border: var(--bd); color: var(--fg); font-weight: 800; border-radius: 12px; cursor: pointer; position: relative }
    .btn { padding: .58rem .9rem; background: linear-gradient(180deg, #11162a, #0b1122) }
    .btn.prime { background: linear-gradient(90deg, #a66fff, #6db4ff); color: #0b0f14; border-color: transparent }
    .btn:hover { box-shadow: 0 8px 26px rgba(0,0,0,.36), 0 0 0 1px rgba(255,255,255,.10) inset }
    .btn.prime:hover { box-shadow: 0 10px 30px rgba(166,111,255,.26), 0 0 0 1px rgba(255,255,255,.18) inset }
    .btn:active { filter: saturate(1.02) brightness(.98) }
    .btn[disabled] { opacity: .55; pointer-events: none }

    /* Ripple */
    .ripple { position: absolute; inset: 0; overflow: hidden; border-radius: inherit }
    .ripple > i { position: absolute; border-radius: 999px; pointer-events: none; transform: translate(-50%, -50%); background: radial-gradient(closest-side, rgba(255,255,255,.35), rgba(255,255,255,0) 70%); animation: ripple .6s var(--ease) forwards }
    @keyframes ripple { from { opacity: .55; width: 0; height: 0 } to { opacity: 0; width: 260px; height: 260px } }

    /* ===== Header ===== */
    header.mast { position: relative; inset: 0 0 auto 0; height: var(--hdrH); z-index: 100; display: flex; align-items: center; gap: 10px; padding: 0 12px; backdrop-filter: blur(var(--blur)) saturate(130%); background: linear-gradient(180deg, rgba(0,0,0,.28), rgba(0,0,0,0)) }
    .ib { width: 42px; height: 42px; border-radius: 50%; display: grid; place-items: center; box-shadow: var(--shadow) }
    .ib.fx-trans:hover { box-shadow: 0 10px 28px rgba(0,0,0,.5), 0 0 0 2px rgba(255,255,255,.10) inset }
    .title { flex: 1; text-align: center; line-height: 1 }
    .title h1 { margin: 0; font-size: 18px; letter-spacing: .06em; font-weight: 900 }
    .title small { display: block; color: var(--mut); letter-spacing: .1em }

    /* ===== Layout ===== */
    main { position: relative; height: 100%; padding-top: calc(var(--hdrH) + env(safe-area-inset-top)); padding-bottom: calc(var(--tabsH) + env(safe-area-inset-bottom)); overflow: hidden }
    .view { position: absolute; inset: 0; padding: 12px 14px; overflow: auto; display: none }
    .view.active { display: block; animation: fade .18s var(--ease) }
    @keyframes fade { from { opacity: 0; transform: translateY(6px) } }

    /* ===== Cards / grids ===== */
    .grid { display: grid; gap: 12px; max-width: 820px; margin: 0 auto }
    .cards { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 12px }
    @media (max-width: 860px) { .cards { grid-template-columns: repeat(2, minmax(0,1fr)) } }
    @media (max-width: 560px) { .cards { grid-template-columns: 1fr } }
    .card { background: var(--surface); border: var(--bd); border-radius: var(--r2); box-shadow: var(--shadow); padding: 12px; display: flex; gap: 10px; align-items: center; position: relative }
    .card.fx-trans:hover { box-shadow: 0 16px 40px rgba(0,0,0,.5) }
    .ico { width: 44px; height: 44px; border-radius: 14px; display: grid; place-items: center; background: rgba(255,255,255,.06); border: var(--bd) }
    /* Ensure inline SVG icons fit within their containers */
    .ico img, .ib img { width: 24px; height: 24px; display: block; }
    .mut { color: var(--mut); font-size: 12px }
    .input, select, textarea { width: 100%; background: #0f1426; color: var(--fg); border: var(--bd); border-radius: 12px; padding: 10px }

    /* ===== Apps ===== */
    .apps-wrap { display: grid; gap: 12px }
    .app-card { display: flex; gap: 12px; align-items: center; background: var(--surface); border: var(--bd); border-radius: var(--r); padding: 12px }
    .app-card:hover { box-shadow: 0 12px 34px rgba(0,0,0,.46) }
    .app-icon { width: 42px; height: 42px; border-radius: 12px; display: grid; place-items: center; background: #0f1528; border: var(--bd); overflow: hidden }
    .app-title { font-weight: 800 }

    /* ===== Viewer (Stack) ===== */
    .session { background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); border: var(--bd); border-radius: 16px; box-shadow: var(--shadow); overflow: hidden }
    .session .hdr { display: flex; align-items: center; gap: 8px; padding: 10px; background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border-bottom: 1px solid #ffffff18 }
    .session .title { font-weight: 850; max-width: 56vw; white-space: nowrap; overflow: hidden; text-overflow: ellipsis }
    .session .tools { margin-left: auto; display: flex; gap: 6px }
    .session .tools .btn:hover { box-shadow: 0 0 0 1px rgba(255,255,255,.18) inset, 0 8px 22px rgba(0,0,0,.35) }
    .session iframe { display: block; width: 100%; height: 60vh; border: 0; background: #000 }
    .session.min iframe { display: none }

    /* ===== Dock + Tabs ===== */
    .dock { position: fixed; left: 10px; right: 10px; bottom: calc(var(--tabsH) + 8px + env(safe-area-inset-bottom)); display: flex; gap: 8px; flex-wrap: wrap; z-index: 80 }
    .badge { display: inline-flex; gap: 6px; align-items: center; padding: .38rem .65rem; border: 1px solid #ffffff18; background: #0f1428; border-radius: 999px; font-weight: 800; position: relative }
    .badge.fx-trans:hover { box-shadow: 0 10px 24px rgba(0,0,0,.5) }
    nav.tabbar { position: fixed; left: 0; right: 0; bottom: env(safe-area-inset-bottom, 0); height: var(--tabsH); z-index: 90; display: flex; justify-content: center; padding: 6px 14px }
    .tabbar .inner { width: 100%; max-width: 820px; display: flex; justify-content: space-around; align-items: center; background: var(--surface); border: var(--bd); border-radius: 22px; box-shadow: var(--shadow); padding: 10px 14px }
    .tab { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 6px; color: var(--mut); font-size: 11px; font-weight: 800; padding: 8px; border-radius: 14px; cursor: pointer; position: relative }
    .tab.fx-trans:hover { background: rgba(255,255,255,.06) }
    .tab.active { color: var(--fg); background: rgba(255,255,255,.10); box-shadow: 0 0 0 2px rgba(255,255,255,.10) }

  /* === Área de Arquétipos (central circle) === */
  .arch-container {
    display: flex;
    justify-content: center;
    margin-top: 24px;
  }
  .arch-circle {
    position: relative;
    width: min(80vw, 560px);
    aspect-ratio: 1 / 1;
    border-radius: 50%;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.12);
    background: radial-gradient(60% 60% at 50% 50%, rgba(0,255,255,.1), rgba(255,255,255,.02));
    box-shadow: var(--shadow, 0 14px 40px rgba(0,0,0,.45));
  }
  .arch-circle iframe {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    border: 0;
    background: transparent;
  }
  .arch-switcher {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 6px;
    align-items: center;
    background: rgba(15,17,32,.7);
    border: 1px solid rgba(255,255,255,.12);
    border-radius: 999px;
    padding: 6px 10px;
    backdrop-filter: blur(8px);
  }
  .arch-switcher select {
    appearance: none;
    background: rgba(255,255,255,.06);
    color: var(--fg);
    border: 1px solid rgba(255,255,255,.12);
    border-radius: 999px;
    padding: 6px 10px;
  }
  .arch-dotlogo {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: conic-gradient(#00c5e5, #ff52e5, #00c5e5);
    box-shadow: 0 0 18px rgba(0,255,255,.4);
  }
  #arch-fadeCover {
    position: absolute;
    inset: 0;
    background: var(--bg, #0b0f14);
    opacity: 0;
    pointer-events: none;
    transition: opacity .3s ease;
  }
  #arch-fadeCover.show { opacity: 1; }
    /* ===== Modal ===== */
    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 120; background: rgba(0,0,0,.45); backdrop-filter: blur(6px) }
    .modal.open { display: flex }
    .modal .panel { width: min(720px, 92vw); background: var(--surface-strong); border: var(--bd); border-radius: 16px; box-shadow: var(--shadow); padding: 16px }
    .kbd { border: 1px solid rgba(255,255,255,.2); background: rgba(255,255,255,.06); padding: 2px 6px; border-radius: 6px; font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 12px }
  </style>
</head>
<body>
  <!-- ===== Header ===== -->
  <header class="mast">
    <button class="ib fx-trans fx-press ring" id="btnBack" title="Voltar" aria-label="Voltar"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f5f7ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg><span class="ripple"></span></button>
    <div class="title">
      <h1>HUB UNO — Monólito</h1>
      <small>Dual · Trinity · Minimal</small>
    </div>
    <!-- Active archetype indicator in header -->
    <!-- Arquétipo ativo indicador -->
    <div id="headerArchDot" class="arch-dotlogo" style="display:none;width:18px;height:18px" title="Arquétipo ativo"></div>
    <button class="ib fx-trans fx-press ring" id="btnDownload" title="Baixar HTML"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f5f7ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v12"></path><path d="M6 9l6 6 6-6"></path><path d="M5 19h14"></path></svg><span class="ripple"></span></button>
    <button class="ib fx-trans fx-press ring" id="btnHelp" title="Ajuda / Atalhos"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f5f7ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 8a2 2 0 0 1 2 2 2 2 0 0 1-2 2v2"></path><circle cx="12" cy="18" r="1"></circle></svg><span class="ripple"></span></button>
    <button class="ib fx-trans fx-press ring" id="btnUser" title="Usuário"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f5f7ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="4"></circle><path d="M4 20c0-4 4-8 8-8s8 4 8 8"></path></svg><span class="ripple"></span></button>
  </header>

  <!-- ===== Views ===== -->
  <main>
    <!-- HOME -->
    <section id="v-home" class="view active">
      <div class="grid">
        <div class="card fx-trans fx-lift">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;width:100%">
            <div>
              <div style="font-weight:900;letter-spacing:.08em">UNO • foco e velocidade</div>
              <div class="mut">Monólito: Apps embutidos + Viewer + Dock + Atalhos</div>
            </div>
            <div class="ico"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f5f7ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 3L4 14h7l-2 7 9-11h-7l3-7z"></path></svg></div>
          </div>
        </div>
        <!-- Área de Arquétipos incorporada -->
        <div class="arch-container">
          <div class="arch-circle">
            <div id="arch-fadeCover"></div>
            <div class="arch-dotlogo" title="arquétipo ativo"></div>
            <div class="arch-switcher">
              <button class="btn fx-trans fx-press ring" id="arch-prev" title="Anterior"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f5f7ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
              <select id="arch-select" title="Escolher arquétipo"></select>
              <button class="btn fx-trans fx-press ring" id="arch-next" title="Próximo"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f5f7ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg></button>
            </div>
            <iframe id="arch-frame" title="Archetype Core" sandbox="allow-scripts" referrerpolicy="no-referrer"></iframe>
          </div>
        </div>
        <div class="cards">
          <button class="card fx-trans fx-press ring" data-nav="apps">
            <div class="ico"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f5f7ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect></svg></div>
            <div>
              <div style="font-weight:800">Apps</div>
              <div class="mut">Catálogo integrado</div>
            </div>
            <span class="ripple"></span>
          </button>
          <button class="card fx-trans fx-press ring" data-nav="stack">
            <div class="ico"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f5f7ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="16" height="4"></rect><rect x="6" y="10" width="12" height="4"></rect><rect x="8" y="16" width="8" height="4"></rect></svg></div>
            <div>
              <div style="font-weight:800">Stack</div>
              <div class="mut">Sessões abertas</div>
            </div>
            <span class="ripple"></span>
          </button>
          <button class="card fx-trans fx-press ring" data-nav="user">
            <div class="ico"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f5f7ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="4"></circle><path d="M4 20c0-4 4-8 8-8s8 4 8 8"></path></svg></div>
            <div>
              <div style="font-weight:800">Usuário</div>
              <div class="mut">Configurações & Estilo</div>
            </div>
            <span class="ripple"></span>
          </button>
        </div>
        <!-- Lista de apps carregados apresentada na Home -->
        <div id="homeAppsWrap" class="apps-wrap" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- APPS -->
    <section id="v-apps" class="view">
      <div class="grid">
        <div class="card fx-trans fx-lift" style="display:block">
          <div class="grid" style="gap:8px">
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
              <label class="mut" style="display:inline-flex;gap:6px;align-items:center">
                <input id="openInside" type="checkbox" checked /> abrir dentro
              </label>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
              <input id="fileLocal" type="file" accept=".html,.htm,.txt" multiple class="input ring" />
              <button id="btnImport" class="btn fx-trans fx-press ring" aria-label="Carregar HTML"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f5f7ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 21V9"></path><path d="M6 15l6-6 6 6"></path><path d="M5 5h14"></path></svg><span class="ripple"></span></button>
              <button id="btnExport" class="btn fx-trans fx-press ring">Exportar Locais<span class="ripple"></span></button>
              <button id="btnClear" class="btn fx-trans fx-press ring">Limpar Locais<span class="ripple"></span></button>
            </div>
            <div id="appsCount" class="mut">—</div>
          </div>
        </div>
        <div id="appsWrap" class="apps-wrap"></div>
      </div>
    </section>

    <!-- STACK -->
    <section id="v-stack" class="view">
      <div class="grid">
        <div class="card fx-trans fx-lift" style="display:block">
          <div style="font-weight:800; display:flex; align-items:center; gap:8px">
            Sessões
            <button id="btnCloseAll" class="btn fx-trans fx-press ring" title="Fechar todas">Fechar todas<span class="ripple"></span></button>
          </div>
          <div class="mut">Reabra rápido pelo dock abaixo.</div>
        </div>
        <div id="stackWrap" class="grid"></div>
      </div>
    </section>

    <!-- USER -->
    <section id="v-user" class="view">
      <div class="grid">
        <!-- Configuração de Usuário e API -->
        <div class="card fx-trans fx-lift" style="display:block">
          <div style="font-weight:800">Usuário</div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap">
            <input id="userName" class="input ring" placeholder="Seu nome" />
            <button id="saveName" class="btn prime fx-trans fx-press ring">Salvar<span class="ripple"></span></button>
          </div>
        </div>
        <div class="card fx-trans fx-lift" style="display:block">
          <div style="font-weight:800">OpenRouter</div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap">
            <select id="model" class="input ring" style="max-width:260px"></select>
            <input id="sk" class="input ring" placeholder="sk-or-v1-…" />
            <button id="saveSK" class="btn fx-trans fx-press ring">Salvar<span class="ripple"></span></button>
          </div>
        </div>
        <!-- Personalização de Fundo -->
        <div class="card fx-trans fx-lift" style="display:block">
          <div style="font-weight:800">Fundo</div>
          <div style="margin-top:6px; display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <input id="bgUpload" type="file" accept="image/*,video/*" class="input ring" style="max-width:260px" />
            <button id="bgClear" class="btn fx-trans fx-press ring">Limpar Fundo<span class="ripple"></span></button>
          </div>
          <div id="bgPreview" class="mut" style="margin-top:6px;font-size:12px">Nenhum fundo personalizado</div>
        </div>
        <!-- Tema & CSS -->
        <div class="card fx-trans fx-lift" style="display:block">
          <div style="font-weight:800">Tema & CSS</div>
          <div style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap; align-items:center">
            <select id="cssPreset" class="input ring" style="max-width:200px">
              <option value="base">Padrão Escuro</option>
              <option value="medium">Cinza Médio</option>
              <option value="light">Quase Branco</option>
            </select>
            <button id="applyPreset" class="btn fx-trans fx-press ring">Aplicar<span class="ripple"></span></button>
            <button id="downloadCSS" class="btn fx-trans fx-press ring">Baixar CSS<span class="ripple"></span></button>
          </div>
          <div style="margin-top:8px">
            <textarea id="cssCustom" class="input ring" placeholder="CSS personalizado..." rows="4"></textarea>
            <div style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap">
              <button id="applyCSS" class="btn fx-trans fx-press ring">Aplicar CSS<span class="ripple"></span></button>
              <button id="clearCSS" class="btn fx-trans fx-press ring">Limpar CSS<span class="ripple"></span></button>
            </div>
          </div>
        </div>
        <!-- Vozes dos arquétipos -->
        <div class="card fx-trans fx-lift" style="display:block">
          <div style="font-weight:800; margin-bottom:6px">Vozes dos Arquétipos</div>
          <div id="voicesWrap" style="display:grid; gap:10px"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- DOCK & TABS -->
  <div id="dock" class="dock"></div>
  <nav class="tabbar">
    <div class="inner">
      <button class="tab fx-trans fx-press ring active" data-nav="home"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f5f7ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2h-14a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg><span style="display:none">Home</span><span class="ripple"></span></button>
      <button class="tab fx-trans fx-press ring" data-nav="apps"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f5f7ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect></svg><span style="display:none">Apps</span><span class="ripple"></span></button>
      <button class="tab fx-trans fx-press ring" data-nav="stack"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f5f7ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="16" height="4"></rect><rect x="6" y="10" width="12" height="4"></rect><rect x="8" y="16" width="8" height="4"></rect></svg><span style="display:none">Stack</span><span class="ripple"></span></button>
      <button class="tab fx-trans fx-press ring" data-nav="user"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f5f7ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="4"></circle><path d="M4 20c0-4 4-8 8-8s8 4 8 8"></path></svg><span style="display:none">Usuário</span><span class="ripple"></span></button>
    </div>
  </nav>

  <!-- HELP MODAL -->
  <div id="modalHelp" class="modal" aria-hidden="true">
    <div class="panel">
      <div style="display:flex;align-items:center;gap:10px;justify-content:space-between">
        <h3 style="margin:0">Ajuda & Atalhos</h3>
        <button id="closeHelp" class="btn fx-trans fx-press ring">Fechar<span class="ripple"></span></button>
      </div>
      <div class="mut" style="margin-top:8px">Navegue mais rápido:</div>
      <ul>
        <li><span class="kbd">g</span> then <span class="kbd">h</span> → Home</li>
        <li><span class="kbd">g</span> then <span class="kbd">a</span> → Apps</li>
        <li><span class="kbd">g</span> then <span class="kbd">s</span> → Stack</li>
        <li><span class="kbd">g</span> then <span class="kbd">u</span> → Usuário</li>
        <li><span class="kbd">Ctrl / Cmd</span> + <span class="kbd">K</span> → Busca</li>
        <li><span class="kbd">Ctrl / Cmd</span> + <span class="kbd">S</span> → Baixar este HTML</li>
      </ul>
    </div>
  </div>

  <!-- ===== Catálogo Embutido (Monólito) ===== -->
  <script id="APPS_JSON" type="application/json">
  {
    "apps": [
      {"key":"atlas","title":"Atlas · Cartesius","desc":"Planejador estratégico com cronogramas e checklists.","url":"about:blank","icon":"atlas"},
      {"key":"nova","title":"Nova · Inspira","desc":"Criativa que desbloqueia ideias com mapas mentais e exercícios.","url":"about:blank","icon":"nova"},
      {"key":"vitalis","title":"Vitalis · Momentum","desc":"Rotinas físicas, hacks biológicos e motivação.","url":"about:blank","icon":"vitalis"},
      {"key":"pulse","title":"Pulse · Resona","desc":"Trilhas sonoras e ajuste de som emocional.","url":"about:blank","icon":"pulse"},
      {"key":"artemis","title":"Artemis · Naviga","desc":"Explora conhecimentos e rotas de aprendizado.","url":"about:blank","icon":"artemis"},
      {"key":"serena","title":"Serena · Ampara","desc":"Acolhimento e suporte emocional.","url":"about:blank","icon":"serena"},
      {"key":"kaos","title":"Kaos · Disruptor","desc":"Questiona padrões e propõe soluções ousadas.","url":"about:blank","icon":"kaos"},
      {"key":"genus","title":"Genus · Fabricus","desc":"Protótipos e materialização de ideias.","url":"about:blank","icon":"genus"},
      {"key":"lumine","title":"Lumine · Brilhare","desc":"Inspiração leve e atividades lúdicas.","url":"about:blank","icon":"lumine"},
      {"key":"rhea","title":"Rhea · Raízes","desc":"Vínculos e memórias emocionais.","url":"about:blank","icon":"rhea"},
      {"key":"solus","title":"Solus · Arcana","desc":"Harmonização energética e meditação.","url":"about:blank","icon":"solus"},
      {"key":"aion","title":"Aion · Evolutia","desc":"Microações estratégicas e evolução.","url":"about:blank","icon":"aion"}
    ]
  }
  </script>

  <script>
    /* ===================== Helpers ===================== */
    const $ = (q, r = document) => r.querySelector(q);
    const $$ = (q, r = document) => Array.from(r.querySelectorAll(q));
    const LS = {
      get: (k, d) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d } catch (e) { return d } },
      set: (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)) } catch (e) {} },
      raw: (k) => localStorage.getItem(k) || ''
    };

    /* Ripple */
    function addRipple(el) {
      if (!el) return;
      if (!el.querySelector('.ripple')) { const slot = document.createElement('span'); slot.className = 'ripple'; el.appendChild(slot); }
      el.addEventListener('pointerdown', (ev) => {
        const host = el.querySelector('.ripple'); if (!host) return;
        const dot = document.createElement('i');
        const rect = el.getBoundingClientRect(); const x = ev.clientX - rect.left; const y = ev.clientY - rect.top;
        dot.style.left = x + 'px'; dot.style.top = y + 'px'; host.appendChild(dot); setTimeout(() => dot.remove(), 650);
      }, { passive: true });
    }

    /* Toast */
    const toastBox = document.createElement('div');
    toastBox.style.cssText = 'position:fixed;right:14px;bottom:calc(var(--tabsH) + 16px);display:grid;gap:8px;z-index:120';
    document.body.appendChild(toastBox);
    function toast(msg, type = 'ok') {
      const el = document.createElement('div'); el.className = 'fx-trans';
      const bg = type === 'ok' ? 'linear-gradient(90deg,#1b2a2a,#123c2e)' : (type === 'warn' ? 'linear-gradient(90deg,#2f261b,#3c2d12)' : 'linear-gradient(90deg,#2f1b1b,#3c1212)');
      el.style.cssText = `background:${bg}; color:var(--fg); border:${getComputedStyle(document.documentElement).getPropertyValue('--bd')}; padding:.6rem .8rem; border-radius:12px; box-shadow:var(--shadow)`;
      el.textContent = msg; toastBox.appendChild(el);
      setTimeout(() => { el.style.opacity = .0; el.style.transform = 'translateY(6px)'; setTimeout(() => el.remove(), 220); }, 1600);
    }

    /* Apply ripple */
    $$('button').forEach(addRipple);
    const obs = new MutationObserver((muts) => { muts.forEach(m => m.addedNodes && m.addedNodes.forEach(n => { if (n.nodeType === 1) { if (n.matches?.('button')) addRipple(n); n.querySelectorAll?.('button').forEach(addRipple); } })) });
    obs.observe(document.body, { childList: true, subtree: true });

    /* ===================== Navegação + Estado ===================== */
    function nav(key) {
      const tabs = ['home', 'apps', 'stack', 'user'];
      tabs.forEach(k => { $('#v-' + k).classList.toggle('active', k === key); $(`.tab[data-nav="${k}"]`).classList.toggle('active', k === key); });
      LS.set('uno:lastTab', key);
    }
    $$('.tab,[data-nav]').forEach(b => b.addEventListener('click', () => nav(b.dataset.nav || 'home')));
    $('#btnBack').onclick = () => { try { history.length > 1 && history.back() } catch { } };
    $('#btnUser').onclick = () => nav('user');

    // Restaurar última aba
    const lastTab = LS.get('uno:lastTab', 'home');
    if (lastTab === 'brain') nav('user');
    else nav(lastTab);

    // Atalhos
    let gPressed = false;
    window.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') { e.preventDefault(); downloadSelf(); return; }
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') { e.preventDefault(); $('#appSearch')?.focus(); return; }
      if (e.key.toLowerCase() === 'g') { gPressed = true; setTimeout(() => gPressed = false, 600); return; }
      if (!gPressed) return;
      const k = e.key.toLowerCase();
      if (k === 'h') nav('home');
      if (k === 'a') nav('apps');
      if (k === 's') nav('stack');
      if (k === 'u' || k === 'b') nav('user');
      gPressed = false;
    });

    // Ajuda modal
    const modalHelp = $('#modalHelp');
    $('#btnHelp').onclick = () => { modalHelp.classList.add('open'); modalHelp.setAttribute('aria-hidden', 'false'); };
    $('#closeHelp').onclick = () => { modalHelp.classList.remove('open'); modalHelp.setAttribute('aria-hidden', 'true'); };
    modalHelp.addEventListener('click', (e) => { if (e.target === modalHelp) $('#closeHelp').click(); });

    // Baixar HTML
    function downloadSelf() {
      try {
        const clone = document.documentElement.cloneNode(true);
        const html = '<!doctype html>\n' + clone.outerHTML;
        const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'HUB-UNO-Glow-v3.4-monolito.html'; a.click(); setTimeout(() => URL.revokeObjectURL(a.href), 500);
        toast('HTML exportado', 'ok');
      } catch (e) { alert('Falha ao exportar: ' + e.message); }
    }
    $('#btnDownload').onclick = downloadSelf;

    /* ===================== Brain ===================== */
    const MODELS = ['openrouter/auto','anthropic/claude-3.5-sonnet','openai/gpt-4.1-mini','google/gemini-1.5-pro','meta/llama-3.1-405b-instruct','mistral/mistral-large-latest'];
    (function initBrain() {
      const sel = $('#model'); sel.innerHTML = ''; MODELS.forEach(m => { const o = document.createElement('option'); o.value = m; o.textContent = m; sel.appendChild(o) });
      sel.value = LS.get('dual.openrouter.model', MODELS[0]);
      $('#sk').value = LS.raw('dual.keys.openrouter');
      $('#saveSK').onclick = () => { LS.set('dual.openrouter.model', sel.value); localStorage.setItem('dual.keys.openrouter', $('#sk').value || ''); toast('Configurações salvas', 'ok'); };
      $('#saveName').onclick = () => { localStorage.setItem('infodose:userName', ($('#userName').value || '').trim()); toast('Nome salvo', 'ok'); };
    })();

    /* ===================== User Personalização ===================== */
    // Atualiza o fundo com base no armazenamento
    function updateBackground() {
      const data = LS.raw('infodose:bg') || '';
      if (data) {
        // If the stored data is a video (data URI starting with data:video), embed as <video>
        if (data.startsWith('data:video')) {
          // Remove any existing background video
          let vid = document.getElementById('bgVideo');
          if (!vid) {
            vid = document.createElement('video');
            vid.id = 'bgVideo';
            vid.autoplay = true;
            vid.loop = true;
            vid.muted = true;
            vid.playsInline = true;
            vid.style.position = 'fixed';
            vid.style.inset = '0';
            vid.style.width = '100%';
            vid.style.height = '100%';
            vid.style.objectFit = 'cover';
            vid.style.zIndex = '-1';
            document.body.prepend(vid);
          }
          vid.src = data;
          vid.style.display = 'block';
          // Ensure image background is cleared
          document.body.style.removeProperty('background-image');
        } else {
          // Remove video element if present
          const vid = document.getElementById('bgVideo');
          if (vid) {
            vid.pause();
            vid.remove();
          }
          document.body.style.backgroundImage = `url(${data})`;
          document.body.style.backgroundSize = 'cover';
          document.body.style.backgroundPosition = 'center';
          document.body.style.backgroundRepeat = 'no-repeat';
        }
      } else {
        // No custom background: remove both image and video
        document.body.style.removeProperty('background-image');
        const vid = document.getElementById('bgVideo');
        if (vid) {
          vid.pause();
          vid.remove();
        }
      }
      updateBgPreview();
    }
    function updateBgPreview() {
      const preview = $('#bgPreview');
      const data = LS.raw('infodose:bg') || '';
      if (preview) {
        preview.textContent = data ? 'Fundo personalizado definido' : 'Nenhum fundo personalizado';
      }
    }
    // Aplicar preset (tema)
    function applyPreset(p) {
      const root = document.documentElement;
      if (p === 'medium') {
        // Medium grey / light-dark palette with glasmorphism
        root.style.setProperty('--grad-a', '#2f343f');
        root.style.setProperty('--grad-b', '#434a5a');
        root.style.setProperty('--surface', 'rgba(35, 38, 50, .72)');
        root.style.setProperty('--surface-strong', 'rgba(35, 38, 50, .88)');
        root.style.setProperty('--bd', '1px solid rgba(255,255,255,.14)');
        root.style.setProperty('--fg', '#e8ecf1');
        root.style.setProperty('--mut', 'rgba(232,236,241,.68)');
      } else if (p === 'light') {
        root.style.setProperty('--grad-a', '#f0f3fa');
        root.style.setProperty('--grad-b', '#e3e7f2');
        root.style.setProperty('--surface', 'rgba(255,255,255,.85)');
        root.style.setProperty('--surface-strong', 'rgba(255,255,255,.95)');
        root.style.setProperty('--bd', '1px solid rgba(0,0,0,.14)');
        root.style.setProperty('--fg', '#0b0f14');
        root.style.setProperty('--mut', 'rgba(0,0,0,.55)');
      } else {
        ['--grad-a','--grad-b','--surface','--surface-strong','--bd','--fg','--mut'].forEach(k => root.style.removeProperty(k));
      }
      LS.set('infodose:preset', p);
      toast('Tema aplicado', 'ok');
    }
    // Aplicar CSS customizado
    function applyCSS() {
      let styleEl = document.getElementById('customStyle');
      if (!styleEl) {
        styleEl = document.createElement('style');
        styleEl.id = 'customStyle';
        document.head.appendChild(styleEl);
      }
      const css = localStorage.getItem('infodose:cssCustom') || '';
      styleEl.innerHTML = css || '';
    }
    // Inicializar voz
    function initVoices() {
      const wrap = $('#voicesWrap');
      if (!wrap) return;
      wrap.innerHTML = '';
      const archList = [
        'Luxara','Rhea','Aion','Atlas','Nova','Genus','Lumine','Kaion','Kaos','Horus','Elysha','Serena'
      ];
      function populate() {
        let voices = speechSynthesis.getVoices();
        // Filtrar por idiomas suportados (Português e Inglês) se disponível
        const filtered = voices.filter(v => v.lang && (v.lang.startsWith('pt') || v.lang.startsWith('en')));
        voices = filtered.length ? filtered : voices;
        const saved = LS.get('infodose:voices', {});
        archList.forEach(name => {
          const row = document.createElement('div');
          row.style.display = 'flex';
          row.style.alignItems = 'center';
          row.style.gap = '8px';
          row.style.flexWrap = 'wrap';
          const label = document.createElement('span');
          label.textContent = name;
          label.style.minWidth = '70px';
          label.style.fontWeight = '700';
          const sel = document.createElement('select');
          sel.className = 'input ring';
          sel.style.maxWidth = '220px';
          voices.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.name;
            opt.textContent = `${v.name} (${v.lang})`;
            sel.appendChild(opt);
          });
          if (saved[name]) sel.value = saved[name];
          sel.onchange = () => {
            saved[name] = sel.value;
            LS.set('infodose:voices', saved);
          };
          const btnTest = document.createElement('button');
          btnTest.className = 'btn fx-trans fx-press ring';
          btnTest.textContent = 'Teste';
          const rp = document.createElement('span');
          rp.className = 'ripple';
          btnTest.appendChild(rp);
          addRipple(btnTest);
          btnTest.onclick = () => {
            const utter = new SpeechSynthesisUtterance(`Olá, eu sou ${name}`);
            const voiceName = saved[name] || sel.value;
            const voice = voices.find(v => v.name === voiceName);
            if (voice) utter.voice = voice;
            utter.lang = voice && voice.lang ? voice.lang : 'pt-BR';
            speechSynthesis.speak(utter);
          };
          row.appendChild(label);
          row.appendChild(sel);
          row.appendChild(btnTest);
          wrap.appendChild(row);
        });
      }
      if (speechSynthesis.getVoices().length) populate();
      else {
        speechSynthesis.onvoiceschanged = () => { populate(); };
      }
    }
    // Inicialização da seção de usuário
    (function initUser() {
      const u = localStorage.getItem('infodose:userName') || '';
      if ($('#userName')) $('#userName').value = u;
      updateBackground();
      const preset = LS.get('infodose:preset', 'base');
      if ($('#cssPreset')) $('#cssPreset').value = preset;
      applyPreset(preset);
      const css = localStorage.getItem('infodose:cssCustom') || '';
      if ($('#cssCustom')) $('#cssCustom').value = css;
      applyCSS();
      updateBgPreview();
      initVoices();

      // Mostra mensagem de boas-vindas ou ativação dependendo do estado do usuário
      function welcome() {
        const name = (localStorage.getItem('infodose:userName') || '').trim();
        if (!name) {
          toast('Salve! Ative sua Dual Infodose', 'ok');
        } else {
          const assistant = 'UNO';
          toast(`Bem-vindo de volta, ${name} · ${assistant}`, 'ok');
        }
      }
      welcome();
    })();
    // Eventos do personalizador
    $('#bgUpload')?.addEventListener('change', async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = reader.result;
          localStorage.setItem('infodose:bg', data);
          updateBackground();
          toast('Fundo definido', 'ok');
        } catch (err) { alert('Falha ao definir fundo: ' + err.message); }
      };
      reader.readAsDataURL(file);
    });
    $('#bgClear')?.addEventListener('click', () => {
      localStorage.removeItem('infodose:bg');
      updateBackground();
      toast('Fundo removido', 'warn');
    });
    $('#applyPreset')?.addEventListener('click', () => {
      applyPreset($('#cssPreset').value);
    });
    $('#downloadCSS')?.addEventListener('click', () => {
      const css = localStorage.getItem('infodose:cssCustom') || '';
      const blob = new Blob([css], { type: 'text/css' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'custom.css';
      a.click();
      setTimeout(() => URL.revokeObjectURL(a.href), 500);
    });
    $('#applyCSS')?.addEventListener('click', () => {
      const css = ($('#cssCustom').value || '').trim();
      localStorage.setItem('infodose:cssCustom', css);
      applyCSS();
      toast('CSS aplicado', 'ok');
    });
    $('#clearCSS')?.addEventListener('click', () => {
      localStorage.removeItem('infodose:cssCustom');
      if ($('#cssCustom')) $('#cssCustom').value = '';
      applyCSS();
      toast('CSS removido', 'warn');
    });

    /* ===================== Ícones inline (data SVG) ===================== */
    function svgIcon(name){
      const common = 'xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%23f5f7ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"';
      const m = {
        atlas: `<svg ${common}><circle cx="12" cy="12" r="9"/><path d="M3 12h18M12 3v18"/><path d="M5 8c3 2 11 2 14 0M5 16c3-2 11-2 14 0"/></svg>`,
        nova: `<svg ${common}><path d="M12 2v4M12 18v4M2 12h4M18 12h4"/><path d="M5.6 5.6l2.8 2.8M15.6 15.6l2.8 2.8M18.4 5.6l-2.8 2.8M8.4 15.6l-2.8 2.8"/><circle cx="12" cy="12" r="3"/></svg>`,
        vitalis:`<svg ${common}><path d="M3 12h4l2-5 4 10 2-5h6"/><path d="M13 3l-2 4 3 1-2 4"/></svg>`,
        pulse: `<svg ${common}><path d="M2 12h3l2-4 3 8 2-4h8"/><path d="M20 8v-3M20 19v-3"/></svg>`,
        artemis:`<svg ${common}><path d="M3 12h12"/><path d="M13 6l6 6-6 6"/><circle cx="12" cy="12" r="9"/></svg>`,
        serena:`<svg ${common}><path d="M12 21s-6-3.5-6-8a4 4 0 0 1 6-3 4 4 0 0 1 6 3c0 4.5-6 8-6 8z"/></svg>`,
        kaos:  `<svg ${common}><path d="M4 4l7 7-7 7"/><path d="M20 4l-7 7 7 7"/></svg>`,
        genus: `<svg ${common}><rect x="7" y="7" width="10" height="10" rx="2"/><path d="M7 7l5-3 5 3M17 17l-5 3-5-3"/></svg>`,
        lumine:`<svg ${common}><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M2 12h2M20 12h2M4.9 4.9l1.4 1.4M17.7 17.7l1.4 1.4M4.9 19.1l1.4-1.4M17.7 6.3l1.4-1.4"/></svg>`,
        rhea:  `<svg ${common}><path d="M12 3v6"/><circle cx="12" cy="9" r="4"/><path d="M12 13v2l-2 2M12 15l2 2M12 17v3"/></svg>`,
        solus: `<svg ${common}><path d="M12 3v6M12 15v6"/><circle cx="12" cy="12" r="3"/><path d="M19 5l-3 3M5 19l3-3M5 5l3 3M19 19l-3-3"/></svg>`,
        aion:  `<svg ${common}><path d="M7 12c0-2.2 1.8-4 4-4 1.2 0 2.3.5 3 1.3M17 12c0 2.2-1.8 4-4 4-1.2 0-2.3-.5-3-1.3"/><path d="M3 12h4M17 12h4"/></svg>`,
        // Extra icons provided by the user. These are approximations of the requested
        // assets (e.g. audio.svg, bolt.svg, etc.) using simple line art. They
        // maintain the same stroke characteristics as the existing icons. To use
        // them elsewhere in the UI, call svgIcon('audio'), svgIcon('bolt'), etc.
        audio: `<svg ${common}><polygon points="3,9 8,9 12,5 12,19 8,15 3,15"/><path d="M15 9c1.5 1.5 1.5 4 0 5"/><path d="M17 7c3 3 3 7 0 10"/></svg>`,
        bolt: `<svg ${common}><path d="M13 3L4 14h7l-2 7 9-11h-7l3-7z"/></svg>`,
        download: `<svg ${common}><path d="M12 3v12"/><path d="M6 9l6 6 6-6"/><path d="M5 19h14"/></svg>`,
        grid: `<svg ${common}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>`,
        home: `<svg ${common}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2h-14a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
        json: `<svg ${common}><path d="M7 4c-2 0-2 2-2 4v8c0 2 0 4 2 4"/><path d="M17 4c2 0 2 2 2 4v8c0 2 0 4-2 4"/></svg>`,
        'logo-capsule': `<svg ${common}><rect x="4" y="7" width="16" height="10" rx="5"/><path d="M12 7v10"/></svg>`,
        'logo-seed-split': `<svg ${common}><path d="M12 12c0-4 4-8 8-8v8c0 4-4 8-8 8v-8z"/><path d="M12 12c0-4-4-8-8-8v8c0 4 4 8 8 8v-8z"/></svg>`,
        pause: `<svg ${common}><rect x="6" y="4" width="3" height="16"/><rect x="15" y="4" width="3" height="16"/></svg>`,
        play: `<svg ${common}><polygon points="6,4 20,12 6,20"/></svg>`,
        upload: `<svg ${common}><path d="M12 21V9"/><path d="M6 15l6-6 6 6"/><path d="M5 5h14"/></svg>`,
        user: `<svg ${common}><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 4-8 8-8s8 4 8 8"/></svg>`,
        sprites: `<svg ${common}></svg>`,
        // Additional navigation and utility icons for the unified UI
        back: `<svg ${common}><polyline points="15 18 9 12 15 6"/></svg>`,
        help: `<svg ${common}><circle cx="12" cy="12" r="10"/><path d="M12 8a2 2 0 0 1 2 2 2 2 0 0 1-2 2v2"/><circle cx="12" cy="18" r="1"/></svg>`,
        stack: `<svg ${common}><rect x="4" y="4" width="16" height="4"/><rect x="6" y="10" width="12" height="4"/><rect x="8" y="16" width="8" height="4"/></svg>`
        ,
        // UI control icons
        minus: `<svg ${common}><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
        refresh: `<svg ${common}><polyline points="23 4 23 10 17 10"/><path d="M21.24 15c-.84 4.31-4.51 7.5-8.98 7.5-5 0-9-4-9-9"/><polyline points="1 20 1 14 7 14"/><path d="M2.76 9c.84-4.31 4.51-7.5 8.98-7.5 5 0 9 4 9 9"/></svg>`,
        close: `<svg ${common}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`,
        'chevron-left': `<svg ${common}><polyline points="15 18 9 12 15 6"/></svg>`,
        'chevron-right': `<svg ${common}><polyline points="9 18 15 12 9 6"/></svg>`
      };
      const raw = m[name] || m['atlas'];
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(raw);
    }

    /* === Voz do arquétipo === */
    // Pronuncia o nome do arquétipo usando a voz selecionada pelo usuário
    function speakArchetype(name) {
      try {
        const archName = name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();
        const saved = LS.get('infodose:voices', {});
        const voices = speechSynthesis.getVoices();
        let voice = null;
        if (saved && saved[archName]) {
          voice = voices.find(v => v.name === saved[archName]);
        }
        // fallback: use first available voice (prefer Portuguese or English)
        if (!voice) {
          voice = voices.find(v => v.lang && (v.lang.startsWith('pt') || v.lang.startsWith('en')));
        }
        if (!voice && voices.length) voice = voices[0];
        if (!voice) return;
        const utter = new SpeechSynthesisUtterance(`Olá, eu sou ${archName}`);
        utter.voice = voice;
        speechSynthesis.cancel();
        speechSynthesis.speak(utter);
      } catch (e) { /* ignore */ }
    }

    /* ===================== Apps (embutido + locais) ===================== */
    const RAW = { apps: [] };
    const appsWrap = $('#appsWrap'), appsCount = $('#appsCount');

    function normalize(list) {
      return (list || []).map(x => ({
        key: x.key || x.url || x.title || Math.random().toString(36).slice(2),
        title: x.title || x.key || 'App',
        desc: x.desc || '',
        url: String(x.url || ''),
        icon: x.icon || '',
        tags: Array.isArray(x.tags) ? x.tags : []
      }))
    }
    function locals() {
      let arr = []; try { arr = JSON.parse(LS.raw('infodose:locals:v1') || '[]') } catch {}
      return arr.map(l => ({ key: 'local:' + l.id, title: l.name || 'Local', desc: 'HTML local', url: 'local:' + l.id, icon: 'local', tags: ['local'] }))
    }
    function getLocal(id) {
      let arr = []; try { arr = JSON.parse(LS.raw('infodose:locals:v1') || '[]') } catch {}
      return arr.find(x => x.id === id) || null
    }
    function blobURL(local) { const blob = new Blob([local.html || ''], { type: 'text/html;charset=utf-8' }); return URL.createObjectURL(blob) }

    function appIconFor(a){
      if(!a.icon) return svgIcon('atlas');
      if(/^(atlas|nova|vitalis|pulse|artemis|serena|kaos|genus|lumine|rhea|solus|aion|local)$/.test(a.icon)) return svgIcon(a.icon);
      return a.icon; // caminho externo
    }

    function cardApp(a) {
      const el = document.createElement('div'); el.className = 'app-card fx-trans fx-lift';
      const ic = document.createElement('div'); ic.className = 'app-icon';
      const img = document.createElement('img'); img.alt = ''; img.width = 24; img.height = 24;
      const src = appIconFor(a);
      img.src = src;
      // Fallback: if loading external icon fails, try local paths
      img.onerror = () => {
        if (!a.icon) return;
        img.onerror = null;
        // attempt to load from root (/svg or /icons), then assets/icons/UI
        const baseName = a.icon.replace(/\.svg$/i, '');
        const tryPaths = [
          `./${baseName}.svg`,
          `./icons/${baseName}.svg`,
          `./assets/icons/UI/${baseName}.svg`
        ];
        for (const p of tryPaths) {
          const testImg = new Image();
          testImg.onload = () => { img.src = p; };
          testImg.onerror = () => {};
          testImg.src = p;
        }
      };
      ic.appendChild(img);
      const meta = document.createElement('div'); meta.style.flex = '1';
      const t = document.createElement('div'); t.className = 'app-title'; t.textContent = a.title;
      const d = document.createElement('div'); d.className = 'mut'; d.textContent = a.desc || a.url;
      const open = document.createElement('button'); open.className = 'btn fx-trans fx-press ring'; open.textContent = 'Abrir';
      const rip = document.createElement('span'); rip.className = 'ripple'; open.appendChild(rip); addRipple(open);
      open.onclick = () => openApp(a);
      meta.appendChild(t); meta.appendChild(d); meta.appendChild(open);
      el.appendChild(ic); el.appendChild(meta);
      return el
    }

    function renderApps() {
      const qInput = document.getElementById('appSearch');
      const q = (qInput && qInput.value ? qInput.value : '').toLowerCase();
      const sortSel = document.getElementById('appSort');
      const mode = sortSel ? sortSel.value : 'az';
      let L = normalize(RAW.apps).concat(locals());
      if (q) {
        L = L.filter(a => (a.title + ' ' + a.desc + ' ' + a.key + ' ' + a.url + ' ' + (a.tags || []).join(' ')).toLowerCase().includes(q));
      }
      L.sort((a, b) => (mode === 'za' ? -1 : 1) * String(a.title || '').localeCompare(b.title || ''));
      appsWrap.innerHTML = '';
      L.forEach(a => appsWrap.appendChild(cardApp(a)));
      appsCount.textContent = L.length + ' apps';
    }

    // Também renderiza os aplicativos na Home (lista simples)
    function renderHomeApps() {
      const wrap = document.getElementById('homeAppsWrap');
      if (!wrap) return;
      let L = normalize(RAW.apps).concat(locals());
      L.sort((a, b) => String(a.title || '').localeCompare(b.title || ''));
      wrap.innerHTML = '';
      L.forEach(a => {
        const card = cardApp(a);
        wrap.appendChild(card);
      });
    }

    (function loadEmbeddedApps(){
      try {
        const raw = JSON.parse($('#APPS_JSON').textContent || '{}');
        RAW.apps = Array.isArray(raw.apps) ? raw.apps : (Array.isArray(raw) ? raw : []);
      } catch { RAW.apps = [] }
      renderApps();
      renderHomeApps();
    })();

    // Locais
    $('#btnImport').onclick = async () => {
      const fs = Array.from($('#fileLocal').files || []); if (!fs.length) return;
      const tasks = fs.map(f => new Promise(res => { const r = new FileReader(); r.onload = () => res({ id: 'l_' + Math.random().toString(36).slice(2), name: f.name.replace(/\.(html?|txt)$/i, ''), html: String(r.result || ''), ts: Date.now() }); r.readAsText(f) }));
      const list = await Promise.all(tasks); const cur = JSON.parse(LS.raw('infodose:locals:v1') || '[]'); list.forEach(x => cur.unshift(x));
      localStorage.setItem('infodose:locals:v1', JSON.stringify(cur));
      renderApps();
      renderHomeApps();
      toast('HTMLs locais adicionados', 'ok');
    };
    $('#btnExport').onclick = () => { const data = { v: 1, when: Date.now(), items: JSON.parse(LS.raw('infodose:locals:v1') || '[]') }; const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })); a.download = 'locals_pack.json'; a.click(); };
    $('#btnClear').onclick = () => {
      if (confirm('Limpar HTMLs locais salvos?')) {
        localStorage.removeItem('infodose:locals:v1');
        renderApps();
        renderHomeApps();
        toast('Locais limpos', 'warn');
      }
    };

    /* ===================== Stack ===================== */
    const stackWrap = $('#stackWrap'), dock = $('#dock');
    function badge(item) { const b = document.createElement('button'); b.className = 'badge fx-trans fx-press ring'; b.textContent = item.title || 'App'; b.title = 'Reabrir ' + (item.title || 'App'); const rp = document.createElement('span'); rp.className = 'ripple'; b.appendChild(rp); addRipple(b); b.onclick = () => { const s = document.querySelector('[data-sid="' + item.sid + '"]'); if (s) { s.scrollIntoView({ behavior: 'smooth' }); s.classList.remove('min'); } }; return b }
    function updateDock() { dock.innerHTML = ''; $$('.session').forEach(s => { const meta = JSON.parse(s.dataset.meta || '{}'); dock.appendChild(badge({ title: meta.title, sid: s.dataset.sid })) }) }
    function openApp(a) {
      const sid = 's_' + Math.random().toString(36).slice(2);
      const isLocal = String(a.url || '').startsWith('local:'); const lr = isLocal ? getLocal(String(a.url).slice(6)) : null; const url = lr ? blobURL(lr) : a.url;
      const card = document.createElement('div'); card.className = 'session fx-trans fx-lift'; card.dataset.sid = sid; card.dataset.meta = JSON.stringify({ title: a.title || 'App', url: a.url || '' });
      const svgMinus = svgIcon('minus');
      const svgRefresh = svgIcon('refresh');
      const svgClose = svgIcon('close');
      card.innerHTML = `
        <div class="hdr">
          <div class="title">${(a.title || 'App')}</div>
          <div class="tools">
            <button class="btn ring fx-trans fx-press" data-act="min"><img src="${svgMinus}" alt="minimizar" width="20" height="20" /><span class="ripple"></span></button>
            <button class="btn ring fx-trans fx-press" data-act="ref"><img src="${svgRefresh}" alt="recarregar" width="20" height="20" /><span class="ripple"></span></button>
            <button class="btn ring fx-trans fx-press" data-act="close"><img src="${svgClose}" alt="fechar" width="20" height="20" /><span class="ripple"></span></button>
          </div>
        </div>
        <iframe src="${url || 'about:blank'}" allow="autoplay; clipboard-read; clipboard-write; picture-in-picture; fullscreen"></iframe>`;
      stackWrap.prepend(card); card.querySelectorAll('.btn').forEach(addRipple);
      card.querySelector('[data-act=min]').onclick = () => { card.classList.toggle('min'); updateDock(); };
      card.querySelector('[data-act=ref]').onclick = () => { const fr = card.querySelector('iframe'); try { fr.contentWindow.location.reload() } catch { fr.src = fr.src } };
      card.querySelector('[data-act=close]').onclick = () => { card.remove(); updateDock(); };
      if ($('#openInside').checked) nav('stack'); updateDock(); toast('App aberto: ' + (a.title || 'App'), 'ok');
    }
    $('#btnCloseAll').onclick = () => { if (!confirm('Fechar todas as sessões abertas?')) return; $$('.session').forEach(s => s.remove()); updateDock(); toast('Todas as sessões fechadas', 'warn'); };

    /* ===================== Archetypes (Central Circle) ===================== */
    // Integrates the original UNO archetype viewer into this unified monolith.
    // Define the list of archetype HTML files. These should reside under an
    // "archetypes" folder relative to this HTML. The names correspond to the
    // available archetype pages shipped with the original UNO Hub.
    (function () {
      const archList = [
        'luxara.html',
        'rhea.html',
        'aion.html',
        'atlas.html',
        'nova.html',
        'genus.html',
        'lumine.html',
        'kaion.html',
        'kaos.html',
        'horus.html',
        'elysha.html'
      ];
      const select = document.getElementById('arch-select');
      const frame = document.getElementById('arch-frame');
      const fade = document.getElementById('arch-fadeCover');
      // Populate the selector with available archetypes
      function populate() {
        select.innerHTML = '';
        archList.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          select.appendChild(opt);
        });
      }
      // Update iframe source based on current index
      function setSrcByIndex(idx) {
        if (!archList.length) return;
        const n = (idx + archList.length) % archList.length;
        select.selectedIndex = n;
        frame.src = './archetypes/' + archList[n];

        // Mostrar indicador de arquétipo ativo no cabeçalho
        const headerDot = document.getElementById('headerArchDot');
        if (headerDot) {
          headerDot.style.display = 'block';
        }
        // Falar o nome do arquétipo se disponível
        try {
          const file = archList[n] || '';
          const name = file.replace(/\.html$/i, '');
          speakArchetype(name);
        } catch {}
      }
      // Initialize
      let current = 0;
      populate();
      if (archList.length) setSrcByIndex(0);
      // Navigate to previous archetype
      document.getElementById('arch-prev').addEventListener('click', () => {
        current = (current - 1 + archList.length) % archList.length;
        fade.classList.add('show');
        setTimeout(() => {
          setSrcByIndex(current);
          setTimeout(() => fade.classList.remove('show'), 200);
        }, 140);
      });
      // Navigate to next archetype
      document.getElementById('arch-next').addEventListener('click', () => {
        current = (current + 1) % archList.length;
        fade.classList.add('show');
        setTimeout(() => {
          setSrcByIndex(current);
          setTimeout(() => fade.classList.remove('show'), 200);
        }, 140);
      });
      // Change archetype via selector
      select.addEventListener('change', () => {
        current = select.selectedIndex;
        fade.classList.add('show');
        setTimeout(() => {
          setSrcByIndex(current);
          setTimeout(() => fade.classList.remove('show'), 200);
        }, 140);
      });
    })();

    /* ===================== Init ===================== */
    $$('button').forEach(addRipple);

  </script>
</body>
</html>
