<!doctype html>
<html lang="pt-BR" style="--arch-overlay: rgba(64, 158, 255, 0.22);"><head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
  <title>HUB UNO — PROD (safe)</title>
  <meta name="theme-color" content="#0b0f14">
  <style>
    :root {
      /* Paleta padrão (rosa/azul) */
      --grad-a: #ff52e5;
      --grad-b: #00c5e5;
      --fg: #f5f7ff;
      --mut: rgba(245, 247, 255, .68);
      /* Superfícies levemente mais opacas para melhorar a legibilidade em fundos complexos */
      --surface: rgba(15, 17, 32, .65);
      --surface-strong: rgba(15, 17, 32, .92);
      --bd: 1px solid rgba(255, 255, 255, .12);
      --ok: #39ffb6;
      --warn: #ffb86b;
      --err: #ff6b6b;
      --r: 18px;
      --r2: 22px;
      --shadow: 0 14px 40px rgba(0, 0, 0, .45);
      --tabsH: 74px;
      --hdrH: 64px;
      --blur: 24px;
  /* Deslocamento opcional para o cabeçalho.  Ajuste este valor para
     empurrar o cabeçalho (header.mast) alguns pixels para baixo.  O
     padding superior do main será ajustado automaticamente. */
  --hdrOffset: 0px;

  /* Cor de overlay por arquétipo (gradiente sólido).  Esta variável
     será atualizada dinamicamente via script conforme o arquétipo
     ativo.  O valor padrão é transparente para não interferir na
     estética quando nenhum arquétipo estiver selecionado. */
  --arch-overlay: rgba(0,0,0,0);
      --ease: cubic-bezier(.22, .61, .36, 1);
    }

    /* Tema alternativo: medium gray / glasmorfismo. Quando body[data-theme="medium"] estiver definido, estas variáveis substituem as originais. */
    body[data-theme="medium"] {
      /* Ajustamos a paleta “medium” para um visual ainda mais tecnológico,
         com tons de cinza-escuro/azulado e transparências suaves para
         reforçar o glasmorfismo. */
      --grad-a: #2c313c;
      --grad-b: #1f242d;
      --fg: #f1f2f5;
      --mut: rgba(241, 242, 245, .68);
      /* No tema médio, aumente a opacidade das superfícies para reforçar o efeito de vidro */
      --surface: rgba(44, 47, 56, .55);
      --surface-strong: rgba(44, 47, 56, .85);
      --bd: 1px solid rgba(255, 255, 255, .06);
      --ok: #68d391;
      --warn: #f6ad55;
      --err: #fc8181;
      --blur: 24px;
    }

    * { box-sizing: border-box }
    html, body { height: 100% }

    body {
      margin: 0;
      color: var(--fg);
      background: linear-gradient(42deg, var(--grad-a), var(--grad-b)) fixed;
      font: 14px/1.45 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      overflow: hidden;
  /* Permite que o pseudo-elemento ::after fique posicionado em relação ao corpo */
  position: relative;
    }

/* Overlay de cor do arquétipo ativo.  Usa a variável --arch-overlay definida no
   :root e atualizada via script.  O overlay cobre toda a tela, tem pointer-events
   desativado e fica atrás dos demais elementos (z-index: 0). */
body::after{content:'';position:fixed;inset:0;background:none !important;pointer-events:none;}

    /* ===== Micro-interações base ===== */
    .fx-trans { transition: transform .16s var(--ease), background .25s var(--ease), box-shadow .25s var(--ease), border-color .25s var(--ease), color .25s var(--ease), opacity .25s var(--ease) }
    .fx-lift:hover { transform: translateY(-1px) }
    .fx-press:active { transform: translateY(0) scale(.98) }
    .ring:focus-visible { outline: 0; box-shadow: 0 0 0 4px rgba(255,255,255,.14) }
    @media (prefers-reduced-motion: reduce) { .fx-trans { transition: none } }

    /* ===== Botões ===== */
    button, .btn, .ib { background: var(--surface); border: var(--bd); color: var(--fg); font-weight: 800; border-radius: 12px; cursor: pointer; position: relative }
    .btn { padding: .58rem .9rem; background: linear-gradient(180deg, #11162a, #0b1122) }
    .btn.prime { background: linear-gradient(90deg, #a66fff, #6db4ff); color: #0b0f14; border-color: transparent }
    .btn:hover { box-shadow: 0 8px 26px rgba(0,0,0,.36), 0 0 0 1px rgba(255,255,255,.10) inset }
    .btn.prime:hover { box-shadow: 0 10px 30px rgba(166,111,255,.26), 0 0 0 1px rgba(255,255,255,.18) inset }
    .btn:active { filter: saturate(1.02) brightness(.98) }
    .btn[disabled] { opacity: .55; pointer-events: none }

    /* Ripple */
    .ripple { position: absolute; inset: 0; overflow: hidden; border-radius: inherit }
    .ripple > i { position: absolute; border-radius: 999px; pointer-events: none; transform: translate(-50%, -50%); background: radial-gradient(closest-side, rgba(255,255,255,.35), rgba(255,255,255,0) 70%); animation: ripple .6s var(--ease) forwards }
    @keyframes ripple { from { opacity: .55; width: 0; height: 0 } to { opacity: 0; width: 260px; height: 260px } }

    /* ===== Header ===== */
    header.mast { position: relative; inset: 0 0 auto 0; height: var(--hdrH); z-index: 100; display: flex; align-items: center; gap: 10px; padding: 0 12px; backdrop-filter: blur(var(--blur)) saturate(130%); background: linear-gradient(180deg, rgba(0,0,0,.28), rgba(0,0,0,0)); margin-top: var(--hdrOffset); }
    .ib { width: 42px; height: 42px; border-radius: 50%; display: grid; place-items: center; box-shadow: var(--shadow) }
    .ib.fx-trans:hover { box-shadow: 0 10px 28px rgba(0,0,0,.5), 0 0 0 2px rgba(255,255,255,.10) inset }
    .title { flex: 1; text-align: center; line-height: 1 }
    .title h1 { margin: 0; font-size: 18px; letter-spacing: .06em; font-weight: 900 }
    .title small { display: block; color: var(--mut); letter-spacing: .1em }

    /* ===== Layout ===== */
    main { position: relative; height: 100%; padding-top: calc(var(--hdrH) + env(safe-area-inset-top) + var(--hdrOffset)); padding-bottom: calc(var(--tabsH) + env(safe-area-inset-bottom)); overflow: hidden }
    .view { position: absolute; inset: 0; padding: 12px 14px; overflow: auto; display: none }
    .view.active {
      display: block;
      /* Animação de transição mais simples: apenas fade com leve zoom. */
      animation: fadeSimple .6s var(--ease);
    }
    /* Esta animação remove o filtro de blur e utiliza apenas opacidade e escala
       para uma transição mais suave. Você pode ajustar os valores para
       personalizar o timing. */
    @keyframes fadeSimple {
      /* Para um efeito de zoom mais sutil, usamos valores de escala
         mais próximos de 1. Altere estes valores caso deseje ajustar a
         intensidade do zoom. */
      0%   { opacity: 0; transform: scale(0.995); }
      60%  { opacity: 0.8; transform: scale(1.005); }
      100% { opacity: 1; transform: scale(1); }
    }

    /* ===== Cards / grids ===== */
    .grid { display: grid; gap: 12px; max-width: 820px; margin: 0 auto }
    /* Distribua os cartões de status da Home em duas colunas para melhor encaixe.
       Em telas estreitas (<560px) eles se empilham em uma única coluna. */
    .cards { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px }
    @media (max-width: 560px) { .cards { grid-template-columns: 1fr } }

    /* Ocultar o menu de opções (Apps, Stack, Brain, Revo) na Home quando apenas a bola dos arquétipos deve aparecer */
    /* Hide the UNO info card on home. The cards row is now used for status notifications */
    #v-home #unoCard {
      display: none;
    }

    /* Esconde a grade de cards na Home e abre espaço para o feed de IA */
    #v-home .cards {
      display: none !important;
    }

    /* O feed de IA na Home foi substituído pelo preview laranja; esconda o feed original */
    #v-home #iaFeed {
      display: none !important;
    }

    /* ===== Estilos para ícones fixados na barra ===== */
    .tabbar .tab[data-pinned] {
      /* Estilo semelhante às abas padrão, mas com cor diferenciada no hover */
      position: relative;
    }
    .pin-letter {
      width: 18px;
      height: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-size: 12px;
      font-weight: 800;
      background: rgba(255, 255, 255, 0.15);
      color: var(--fg);
      line-height: 1;
    }

    /* Estiliza o feed de mensagens da IA em formato de conversa */
    #iaFeed {
      margin: 12px auto 0;
      max-width: 820px;
      background: var(--surface);
      border: var(--bd);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      padding: 12px;
      font-size: 14px;
      line-height: 1.5;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    #iaFeed .msg {
      margin: 0;
      padding: 8px 12px;
      border-radius: 16px;
      max-width: 75%;
      word-wrap: break-word;
    }
    #iaFeed .msg.user {
      align-self: flex-end;
      background: rgba(255,255,255,0.1);
      border-radius: 16px 16px 0 16px;
    }
    #iaFeed .msg.ai {
      align-self: flex-start;
      background: rgba(57,255,182,0.12);
      border-radius: 16px 16px 16px 0;
    }
    #iaFeed .status {
      color: var(--mut);
      font-size: 12px;
      align-self: center;
    }

    /* ===== Apps Page customizations ===== */
    /* Estilizar botão de upload de HTML local para destaque */
    #btnImport {
      font-weight: 700;
      color: var(--ink);
      background: var(--glass);
      border-color: var(--line);
    }
    /* Favorite icon/button dentro de cada cartão de app */
    .app-card {
      position: relative;
    }
    .fav-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 22px;
      height: 22px;
      background: transparent;
      border: none;
      padding: 0;
      cursor: pointer;
      opacity: 0.6;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
    }
    .fav-btn.fav {
      opacity: 1;
    }
    .fav-btn img {
      width: 100%;
      height: 100%;
      /* Ícones não favoritados ficam em tons de cinza para indicar estado off */
      filter: grayscale(1) brightness(0.5);
    }
    .fav-btn.fav img {
      /* Ícone favoritado mantém cor original (amarelo) */
      filter: none;
    }
    .card { background: var(--surface); border: var(--bd); border-radius: var(--r2); box-shadow: var(--shadow); padding: 12px; display: flex; gap: 10px; align-items: center; position: relative; backdrop-filter: blur(8px) saturate(160%) }
    .card.fx-trans:hover { box-shadow: 0 16px 40px rgba(0,0,0,.5) }
    .ico { width: 44px; height: 44px; border-radius: 14px; display: grid; place-items: center; background: rgba(255,255,255,.06); border: var(--bd) }
    .mut { color: var(--mut); font-size: 12px }
    .input, select, textarea { width: 100%; background: #0f1426; color: var(--fg); border: var(--bd); border-radius: 12px; padding: 10px }

    /* Ajuste para ícones SVG externos: invertê-los para que fiquem claros em temas escuros */
    header.mast img,
    .tabbar img,
    .card .ico img,
    .session .tools img,
    .dock img {
      filter: invert(1) brightness(1.2);
    }

    /* ===== Apps ===== */
.apps-wrap {
      display: grid;
      gap: 12px;
      /* Distribui os apps em colunas responsivas: cada cartão terá no mínimo 240px. */
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      /* Adiciona uma margem inferior generosa para que o dock/tabbar não sobreponha os últimos elementos. */
      padding-bottom: 80px;
    }
.app-card {
      display: flex;
      gap: 12px;
      align-items: center;
      /* Use um fundo com maior opacidade e um leve blur para destacar cada app e melhorar a legibilidade */
      background: var(--surface);
      backdrop-filter: blur(8px) saturate(160%);
      border: var(--bd);
      border-radius: var(--r);
      padding: 14px;
    }
    .app-card:hover { box-shadow: 0 12px 34px rgba(0,0,0,.46) }
    .app-icon { width: 42px; height: 42px; border-radius: 12px; display: grid; place-items: center; background: #0f1528; border: var(--bd); overflow: hidden }

    /* Ícone com a letra do app no cabeçalho das sessões. Utiliza a
       primeira letra do título e cores do gradiente para destacar o
       aplicativo em cada cartão. */
    .session .hdr .app-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 6px;
      background: var(--grad-a);
      color: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
    }
    .app-title {
      font-weight: 800;
      /* Evitar quebra de linhas em títulos longos e mostrar reticências */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    /* Âncora para sessões abertas no topo da página (modo "abrir dentro"). */
    #sessionsAnchor {
      display: grid;
      gap: 12px;
      margin: 12px 14px;
    }
    /* Estilos para o painel Brain (perfil, performance, voz, logs). */
    #brain { position: fixed; top: calc(var(--hdrH) + 12px); right: 14px; width: min(92vw, 440px); z-index: 130; }
    #brain.hide { display: none !important; }
    .popover { border-radius: 24px; padding: 12px; background: var(--surface-strong); border: var(--bd); backdrop-filter: blur(var(--blur)); }
    .menuItem { display: flex; gap: 12px; align-items: center; border: var(--bd); background: var(--surface); border-radius: 16px; padding: 12px; }
    .menuItem + .menuItem { margin-top: 9px; }
    .input { display: flex; gap: 8px; align-items: center; background: var(--surface); border: var(--bd); border-radius: 14px; padding: 9px 11px; }
    .input input, .input select { flex: 1; background: transparent; border: 0; outline: 0; color: var(--fg); font-size: 13px; }
    .notice { font-size: 12px; color: var(--mut); }

    /* ===== Viewer (Stack) ===== */
    .session { background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); border: var(--bd); border-radius: 16px; box-shadow: var(--shadow); overflow: hidden }
    .session .hdr { display: flex; align-items: center; gap: 8px; padding: 10px; background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border-bottom: 1px solid #ffffff18 }
    .session .title { font-weight: 850; max-width: 56vw; white-space: nowrap; overflow: hidden; text-overflow: ellipsis }
    .session .tools { margin-left: auto; display: flex; gap: 6px }
    .session .tools .btn:hover { box-shadow: 0 0 0 1px rgba(255,255,255,.18) inset, 0 8px 22px rgba(0,0,0,.35) }
    .session iframe { display: block; width: 100%; height: 60vh; border: 0; background: #000 }
    .session.min iframe { display: none }

    /* Permite redimensionar a altura do iframe dentro das sessões arrastando o canto inferior esquerdo */
    .session { position: relative; }
    .session .resize-handle {
      position: absolute;
      left: 8px;
      bottom: 8px;
      width: 16px;
      height: 16px;
      cursor: ns-resize;
      border-radius: 4px;
      background: rgba(255,255,255,.15);
      border: 1px solid rgba(255,255,255,.25);
    }
    .session .resize-handle:hover { background: rgba(255,255,255,.25); }

    /* ===== Dock + Tabs ===== */
    .dock { position: fixed; left: 10px; right: 10px; bottom: calc(var(--tabsH) + 8px + env(safe-area-inset-bottom)); display: none; gap: 8px; flex-wrap: wrap; z-index: 80 }
    .badge { display: inline-flex; gap: 6px; align-items: center; padding: .38rem .65rem; border: 1px solid #ffffff18; background: #0f1428; border-radius: 999px; font-weight: 800; position: relative }
    .badge.fx-trans:hover { box-shadow: 0 10px 24px rgba(0,0,0,.5) }
    nav.tabbar { position: fixed; left: 0; right: 0; bottom: env(safe-area-inset-bottom, 0); height: var(--tabsH); z-index: 1500; display: flex; justify-content: center; padding: 6px 14px }
    .tabbar .inner { width: 100%; max-width: 820px; display: flex; justify-content: space-around; align-items: center; background: var(--surface); border: var(--bd); border-radius: 22px; box-shadow: var(--shadow); padding: 10px 14px }
    .tab { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 6px; color: var(--mut); font-size: 11px; font-weight: 800; padding: 8px; border-radius: 14px; cursor: pointer; position: relative }
    .tab.fx-trans:hover { background: rgba(255,255,255,.06) }
    .tab.active { color: var(--fg); background: rgba(255,255,255,.10); box-shadow: 0 0 0 2px rgba(255,255,255,.10) }

    /* === Área de Arquétipos (central circle) === */
    .arch-container {
      /* Organize o círculo e o seletor em coluna.  Alinhe os elementos ao centro
         e adicione um pequeno espaçamento vertical.  A propriedade position
         relative permite posicionar o menu de opções de forma absoluta logo
         abaixo do círculo. */
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      justify-content: center;
      /* Dá mais espaço do topo, relativo à altura da viewport */
      margin-top: 5vh;
    }
    .arch-circle {
      position: relative;
      width: min(80vw, 560px);
      aspect-ratio: 1 / 1;
      border-radius: 50%;
      /* O conteúdo deve permanecer dentro da forma circular para evitar
         que o iframe quadrado “vaze” e pareça um quadrado. */
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.12);
      background: radial-gradient(60% 60% at 50% 50%, rgba(0,255,255,.1), rgba(255,255,255,.02));
      box-shadow: var(--shadow, 0 14px 40px rgba(0,0,0,.45));
      /* Animação de clique: quando a classe .pressed é aplicada via JS, reduza
         levemente o tamanho para simular pressão. */
      transition: transform .18s var(--ease);
    }

    .arch-circle.pressed {
      transform: scale(0.96);
    }

    .arch-circle iframe {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: 0;
      /*
       * Defina um plano de fundo escuro para o iframe do arquétipo. Quando um
       * PNG ou outro recurso não estiver disponível ou demora a carregar,
       * alguns navegadores exibem uma cor de fundo branca padrão. Ao
       * especificar explicitamente uma cor escura aqui, evitamos flashes
       * de branco e mantemos a estética coesa durante as transições.
       */
      background: #0b0f14;
    }

    /* ===== Splash overlay ===== */
    /* O elemento #appSplash cobre toda a tela enquanto o app carrega.
       Ele utiliza o loader UNO personalizado definido abaixo. */
    #appSplash {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      background: linear-gradient(42deg, var(--grad-a), var(--grad-b));
      z-index: 200;
      opacity: 1;
      visibility: visible;
      transition: opacity .3s var(--ease), visibility 0s linear .3s;
    }
    #appSplash.hidden {
      opacity: 0;
      visibility: hidden;
    }
    /* Crie elementos de fundo difuso atrás do loader para um efeito de luz suave.
       Estes pseudoelementos adicionam manchas coloridas em tons das cores do gradiente,
       ajudando a diferenciar o loader do plano de fundo. */
    #appSplash::before,
    #appSplash::after {
      content: "";
      position: absolute;
      width: 420px;
      height: 420px;
      border-radius: 50%;
      filter: blur(100px);
      opacity: .35;
      pointer-events: none;
    }
    #appSplash::before {
      background: var(--grad-a);
      top: -180px;
      left: -120px;
    }
    #appSplash::after {
      background: var(--grad-b);
      bottom: -180px;
      right: -120px;
    }

    /* ===== Loaders UNO e outros loaders ===== */
    /* Estes estilos são incorporados diretamente para evitar dependência externa. */
    .di{ --di-size:40px; --di-stroke:2px; --di-gold: color-mix(in oklab, var(--grad-a) 60%, var(--grad-b) 40%);
      position:relative;width:var(--di-size);height:var(--di-size); }
    /* Ajuste as cores do anel do loader para maior contraste no splash.
       Utilize um branco semi-transparente para destacá-lo contra o fundo colorido. */
    .di .ring{
      position:absolute;
      inset:0;
      /* Ajuste a opacidade do contorno branco para obter um efeito mais sutil no anel. */
      border:var(--di-stroke) solid rgba(255,255,255,0.35);
      border-radius:50%;
      animation:di-spin 6s linear infinite;
    }
    .di .stroke{position:absolute;left:50%;top:50%;width:62%;height:var(--di-stroke);
      background:linear-gradient(90deg,var(--grad-a),var(--grad-b));transform:translate(-50%,-50%);
      border-radius:999px;animation:di-breathe 2.4s ease-in-out infinite; }
    .di .dots{position:absolute;inset:0;transform:rotate(-90deg);animation:di-orbit 4.2s linear infinite; }
    .di .dots i{--i:0;position:absolute;left:50%;top:50%;width:4px;height:4px;border-radius:50%;
      background:conic-gradient(var(--grad-a),var(--grad-b));
      -webkit-mask: radial-gradient(circle, #000 62%, transparent 63%);
      mask: radial-gradient(circle, #000 62%, transparent 63%);
      opacity:.85;transform:rotate(calc(var(--i)*51deg)) translate(calc(7px + var(--i)*2.2px)) rotate(calc(var(--i)*-51deg));
      animation:di-pulse 4.2s linear infinite;animation-delay:calc(var(--i)*.6s); }
    @keyframes di-orbit{to{transform:rotate(270deg);}}
    @keyframes di-spin{to{transform:rotate(360deg);}}
    @keyframes di-breathe{0%,100%{opacity:.9;}50%{opacity:1;}}
    @keyframes di-pulse{0%,70%{opacity:.55;transform:scale(.92);}76%,84%{opacity:1;transform:scale(1.12);}100%{opacity:.7;transform:scale(.96);}}

    .simbio{position:relative;width:40px;height:40px; }
    .simbio .ringA,.simbio .ringB{position:absolute;inset:0;border-radius:50%;
      -webkit-mask:radial-gradient(farthest-side,transparent calc(50% - 1px),#000 calc(50% - 1px),#000 100%);
      mask:radial-gradient(farthest-side,transparent calc(50% - 1px),#000 calc(50% - 1px),#000 100%); }
    .simbio .ringA{background:conic-gradient(from 0deg,var(--grad-a),transparent 60%);animation:rotA 4.8s linear infinite; }
    .simbio .ringB{background:conic-gradient(from 180deg,var(--grad-b),transparent 60%);animation:rotB 6.2s linear infinite; }
    .simbio .stroke{position:absolute;left:50%;top:50%;width:60%;height:2px;background:linear-gradient(90deg,var(--grad-a),var(--grad-b));
      transform:translate(-50%,-50%);border-radius:999px;opacity:.9; }
    @keyframes rotA{to{transform:rotate(360deg);}}
    @keyframes rotB{to{transform:rotate(-360deg);}}

    .pulse{position:relative;width:40px;height:40px;display:grid;place-items:center; }
    .pulse .dot{width:8px;height:8px;border-radius:50%;background:linear-gradient(90deg,var(--grad-a),var(--grad-b)); }
    .pulse .wave{position:absolute;inset:0;border-radius:50%;animation:wave 2.4s ease-out infinite;opacity:.6; }
    .pulse .wave::before{content:"";position:absolute;inset:0;border-radius:50%;
      background:conic-gradient(var(--grad-a),var(--grad-b));
      -webkit-mask:radial-gradient(farthest-side,transparent calc(50% - 1px),#000 calc(50% - 1px),#000 100%);
      mask:radial-gradient(farthest-side,transparent calc(50% - 1px),#000 calc(50% - 1px),#000 100%); }
    .pulse .wave:nth-child(1){animation-delay:0s;} .pulse .wave:nth-child(2){animation-delay:.7s;} .pulse .wave:nth-child(3){animation-delay:1.4s; }
    @keyframes wave{0%{transform:scale(.5);opacity:.36;}50%{transform:scale(1.4);opacity:.58;}100%{transform:scale(1.35);opacity:.0;}}

    .coblux{position:relative;width:40px;height:40px;filter:drop-shadow(0 0 10px color-mix(in oklab,var(--grad-a) 35%, transparent)) drop-shadow(0 0 14px color-mix(in oklab,var(--grad-b) 25%, transparent)); }
    .coblux .ring{position:absolute;inset:0;border-radius:50%;background:conic-gradient(from 90deg,var(--grad-a),var(--grad-b));
      -webkit-mask:radial-gradient(farthest-side,transparent calc(50% - 1px),#000 calc(50% - 1px),#000 100%);animation:spinFast 2.4s linear infinite; }
    .coblux .trail{position:absolute;left:50%;top:50%;width:4px;height:4px;border-radius:50%;background:radial-gradient(circle at 35% 35%,#fff 0 20%,var(--grad-a) 40%,var(--grad-b) 100%);transform-origin:-12px 0;animation:trail 1.8s linear infinite; }
    @keyframes spinFast{to{transform:rotate(360deg);}}
    @keyframes trail{to{transform:rotate(360deg);}}

    .icon56{position:relative;width:56px;height:56px;display:block; }
    .home-base{position:absolute;left:50%;top:50%;width:36px;height:24px;border:3px solid var(--grad-b);border-top:3px solid transparent;
      transform:translate(-50%,-10px) scale(0);border-radius:5px;box-shadow:0 0 10px color-mix(in oklab,var(--grad-b) 60%, transparent);animation:homeBase 2.4s ease-in-out infinite; }
    .home-roof{position:absolute;left:50%;top:30%;width:0;height:0;border-left:18px solid transparent;border-right:18px solid transparent;border-bottom:20px solid var(--grad-b);
      transform:translateX(-50%) scaleX(0);filter:drop-shadow(0 0 8px color-mix(in oklab,var(--grad-a) 60%, transparent));animation:homeRoof 2.4s ease-in-out infinite; }
    @keyframes homeBase{0%{transform:translate(-50%,-10px) scale(0);}40%{transform:translate(-50%,-10px) scale(1);}80%{transform:translate(-50%,-10px) scale(1);}100%{transform:translate(-50%,-10px) scale(0);}}
    @keyframes homeRoof{0%{transform:translateX(-50%) scaleX(0);}50%{transform:translateX(-50%) scaleX(1);}100%{transform:translateX(-50%) scaleX(0);}}
    .asst-left,.asst-right{position:absolute;left:50%;top:50%;width:26px;height:26px;border-radius:50%;filter:drop-shadow(0 0 6px color-mix(in oklab,var(--grad-a) 50%, transparent)); }
    .asst-left{background:radial-gradient(circle at 50% 35%, var(--grad-b) 38%, transparent 39%), radial-gradient(circle at 50% 90%, var(--grad-b) 32%, transparent 33%);
      transform:translate(-50%,-50%) translateX(0);animation:aL 1.6s ease-in-out infinite; }
    .asst-right{background:radial-gradient(circle at 50% 35%, color-mix(in oklab, var(--grad-a) 70%, #ff7a00) 38%, transparent 39%), radial-gradient(circle at 50% 90%, color-mix(in oklab, var(--grad-a) 70%, #ff7a00) 32%, transparent 33%);
      transform:translate(-50%,-50%) translateX(0);animation:aR 1.6s ease-in-out infinite; }
    @keyframes aL{0%,100%{transform:translate(-50%,-50%) translateX(0) scale(1);}50%{transform:translate(-50%,-50%) translateX(-10px) scale(.95);}}
    @keyframes aR{0%,100%{transform:translate(-50%,-50%) translateX(0) scale(1);}50%{transform:translate(-50%,-50%) translateX(10px) scale(.95);}}
    .kob-ring{position:absolute;inset:6px;border-radius:50%;background:conic-gradient(from 0deg, var(--grad-b) 0 350deg, transparent 350deg 360deg);
      filter:drop-shadow(0 0 8px color-mix(in oklab,var(--grad-a) 60%, transparent));animation:spin 1.2s linear infinite; }
    .kob-spiral{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:22px;animation:spin 1.6s linear infinite reverse;
      filter:drop-shadow(0 0 6px color-mix(in oklab,var(--grad-b) 60%, transparent)); }
    @keyframes spin{to{transform:rotate(360deg);}}

    /* Texto animado no splash */
    #appSplash .loading-text {
      margin-top: 20px;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.04em;
      color: #f8f9fc;
      opacity: 1;
      /* Ajuste a animação para que o texto apareça suavemente,
         tornando-se totalmente visível no meio do ciclo e
         desaparecendo delicadamente. */
      animation: fadeUp 2.4s ease-in-out infinite;
    }
    @keyframes fadeUp {
      0%, 20% { opacity: 0; transform: translateY(12px); }
      40%, 60% { opacity: 1; transform: translateY(0); }
      80%, 100% { opacity: 0; transform: translateY(-12px); }
    }

  /* Certifique-se de que o logotipo de ponto e o círculo de arquétipo
     fiquem sobrepostos ao iframe. O seletor (arch-switcher) é
     configurado separadamente e fica fora do círculo. */
  .arch-dotlogo, .arch-circle {
    position: relative;
    z-index: 60;
  }
    .arch-switcher {
      /* O seletor fica fora do círculo, como um elemento próprio da
         coluna.  Não é posicionado de forma absoluta; sua posição é
         determinada pelo fluxo flex da .arch-container. */
      display: flex;
      gap: 6px;
      align-items: center;
      background: rgba(15,17,32,.7);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      padding: 4px 8px;
      backdrop-filter: blur(8px);
      z-index: 70;
    }
    .arch-switcher select {
      appearance: none;
      background: rgba(255,255,255,.06);
      color: var(--fg);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      /* Reduzir padding e tamanho de fonte para caber melhor fora do círculo */
      padding: 4px 8px;
      font-size: 12px;
    }

  /* Redimensionar botões do seletor de arquétipos para um tamanho mais compacto */
  .arch-switcher button {
    width: 30px;
    height: 30px;
    padding: 0;
    border-radius: 8px;
  }

    /* Quando o modo áudio está ativo, destaque o círculo com uma borda sutil */
    .arch-circle.audio-on {
      box-shadow: 0 0 0 2px var(--ok), var(--shadow);
    }

    /* Mensagem exibida fora do círculo do arquétipo.  Ela fica abaixo
       da bolinha e utiliza um fundo translúcido para garantir
       legibilidade.  O elemento aparece e desaparece com uma transição
       de opacidade. */
    .arch-msg {
      margin-top: 8px;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(15,17,32,.72);
      color: var(--fg);
      font-size: 13px;
      max-width: 90%;
      text-align: center;
      pointer-events: none;
      opacity: 0;
      transition: opacity .3s ease;
    }
    .arch-msg.show { opacity: 1; }

    /* Estilização do menu de arquétipos acionado ao tocar a bola.  O menu
       exibe opções de navegação (Apps, Stack, Usuário, Arquétipo e Revo)
       e fica escondido por padrão.  Quando a classe .show é aplicada,
       ele usa flexbox para alinhar os botões. */
    .arch-menu {
      /* O menu é posicionado de forma absoluta abaixo do círculo.  Por
         padrão, ele fica invisível até que a classe .show seja aplicada.
         A propriedade transform centraliza o menu horizontalmente em
         relação ao contêiner. */
      position: absolute;
      top: calc(100% + 10px);
      left: 50%;
      transform: translateX(-50%);
      display: none;
      gap: 10px;
      z-index: 70;
    }
    .arch-menu.show {
      display: flex;
    }
    .arch-menu button {
      border: var(--bd);
      background: var(--surface);
      border-radius: 12px;
      padding: 6px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--fg);
      font-size: 10px;
      cursor: pointer;
    }
    .arch-menu button:hover {
      box-shadow: 0 10px 24px rgba(0,0,0,.5);
    }

    /* Quando o botão de áudio está ativado, destaque-o com a cor "ok" */
    .arch-menu button.on {
      background: var(--ok);
      color: var(--surface-strong);
    }
    .arch-menu button.on img {
      filter: none;
    }
    .arch-menu button img {
      width: 20px;
      height: 20px;
      margin-bottom: 2px;
      filter: invert(1) brightness(1.2);
    }
    #arch-fadeCover {
      position: absolute;
      inset: 0;
      /* Use a cor do arquétipo ativo, se definida, para o fade. Isso
         torna a transição mais perceptível quando um novo arquétipo
         é selecionado.  Caso não haja overlay, caia para a cor de
         fundo padrão. */
      background: var(--arch-overlay, var(--bg, #0b0f14));
      opacity: 0;
      pointer-events: none;
      transition: opacity .3s ease;
    }
    #arch-fadeCover.show { opacity: 1; }

    /* Camada para ripples de áudio: fica sobre o conteúdo do círculo e ajusta a opacidade
       conforme a intensidade capturada pelo microfone. Utilizamos mix-blend-mode
       para adicionar um brilho sutil sem quebrar a estética minimalista. */
    .audio-ripple {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      /* A camada de ripple agora serve também como área de clique para ativar o modo áudio. */
      pointer-events: auto;
      /* Retire o gradiente, pois o efeito visual passa a ser aplicado via box-shadow no círculo */
      background: transparent;
      /* Mantenha um z-index alto para captar cliques acima do iframe */
      z-index: 70;
    }

    /* ===== Modal ===== */
    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 120; background: rgba(0,0,0,.45); backdrop-filter: blur(6px) }
    .modal.open { display: flex }
    .modal .panel { width: min(720px, 92vw); background: var(--surface-strong); border: var(--bd); border-radius: 16px; box-shadow: var(--shadow); padding: 16px }
    .kbd { border: 1px solid rgba(255,255,255,.2); background: rgba(255,255,255,.06); padding: 2px 6px; border-radius: 6px; font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 12px }

    /* ===== Chat (Dual • Chat) ===== */
    /* Configuração da seção de chat */
    #v-chat {
      padding: 0;
      /* Não defina display aqui; ele será controlado pela classe .view e .active */
      flex-direction: column;
      gap: 12px;
    }

    /* Certifique-se de que a seção de chat seja exibida somente quando ativa.
       A classe .view define display:none; quando .active é adicionada, tornamos flex para layout vertical. */
    #v-chat.view.active, #v-chat.active {
      display: flex;
    }
    #chatFeed {
      /* Mantenha um tamanho mínimo para que mensagens apareçam mesmo sem altura flex */
      min-height: 120px;
      overflow-y: auto;
      max-height: 46svh;
      background: var(--surface);
      border: var(--bd);
      border-radius: var(--r2);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    #chatFeed .msg {
      max-width: 75%;
      margin: 0;
      padding: 8px 12px;
      border-radius: 16px;
      word-wrap: break-word;
    }
    #chatFeed .msg.user {
      align-self: flex-end;
      background: rgba(255,255,255,0.10);
      border-radius: 16px 16px 0 16px;
    }
    #chatFeed .msg.ai {
      align-self: flex-start;
      background: rgba(57,255,182,0.12);
      border-radius: 16px 16px 16px 0;
    }
    #chatFeed .msg.status {
      align-self: center;
      color: var(--mut);
      font-size: 12px;
    }
    /* O formulário #chatForm e o campo #chatInput foram removidos.  O envio
       de mensagens é feito exclusivamente pelo overlay de texto fixo. */
    #msgPreview {
      position: fixed;
      left: 14px;
      right: 14px;
      bottom: calc(var(--tabsH) + 20px + env(safe-area-inset-bottom, 0));
      background: var(--warn);
      color: #0b0f14;
      border-radius: 18px;
      padding: 10px 14px;
      font-weight: 800;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      box-shadow: var(--shadow);
      z-index: 95;
      cursor: pointer;
      display: none;
  /* Limite de altura para o preview; evita estourar o layout e permite arrastar no chat */
  max-height: 33px;
  overflow: hidden;
    }
    /* Ajuste para preview quando nav está na lateral direita */
    body.nav-right #msgPreview {
      right: calc(88px + 14px);
      bottom: 14px;
    }

    /* ===== Overlay de entrada rápida na Home ===== */
    /* Removido: o botão #homeInputToggle não é mais utilizado; os controles
       de texto/voz são representados pelas bolinhas de ação. */
    #homeInputOverlay {
      position: fixed;
      left: 14px;
      right: 14px;
      bottom: calc(var(--tabsH) + env(safe-area-inset-bottom, 0));
      background: var(--surface-strong);
      border-radius: 18px 18px 0 0;
      border: var(--bd);
      padding: 12px;
      box-shadow: var(--shadow);
      z-index: 97;
      display: none;
    }
    #homeInputOverlay form {
      display: flex;
      gap: 8px;
    }
    #homeInputOverlay input {
      flex: 1;
      background: #0f1426;
      color: var(--fg);
      border: var(--bd);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 18px;
    }
    #homeInputOverlay input::placeholder {
      color: var(--mut);
    }
    #homeInputOverlay button {
      background: var(--ok);
      border: none;
      border-radius: 12px;
      padding: 0 16px;
      color: #0b0f14;
      font-weight: 700;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    /* Ajustes quando a navegação está na direita: reposicione o botão e overlay para não colidir com a barra */
    /* body.nav-right #homeInputToggle removido */
    body.nav-right #homeInputOverlay {
      left: 14px;
      right: calc(88px + 14px);
      bottom: calc(14px + env(safe-area-inset-bottom, 0));
    }

    /* ===== Botões duplos (texto/voz) na Home ===== */
    /* Variante lateral empilhada: os botões ficam no canto direito,
       empilhados um sobre o outro (coluna) para indicar ações distintas
       (texto e voz).  Ajustamos a posição para cima da barra de
       navegação. */
    .home-btns {
      position: fixed;
      right: 14px;
      left: auto;
      transform: none;
      bottom: calc(var(--tabsH) + 30px + env(safe-area-inset-bottom, 0));
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 10px;
      z-index: 97;
    }
    .home-btn {
      width: 42px;
      height: 42px;
      border-radius: 21px;
      background: var(--surface);
      border: var(--bd);
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .home-btn img {
      width: 20px;
      height: 20px;
    }
    .home-btn.active {
      background: var(--ok);
      color: #0b0f14;
    }
    /* Layout da barra de abas no modo nav-right */
    body.nav-right nav.tabbar {
      left: auto;
      right: 0;
      top: var(--hdrH);
      bottom: env(safe-area-inset-bottom, 0);
      width: 78px;
      height: auto;
      display: flex;
      justify-content: flex-start;
      padding: 6px 6px;
    }
    body.nav-right .tabbar .inner {
      width: 100%;
      max-width: none;
      flex-direction: column;
      align-items: center;
    }
    body.nav-right .tab {
      flex: none;
      width: 100%;
      margin: 4px 0;
    }
    body.nav-right main {
      padding-right: calc(78px + 14px);
      padding-bottom: calc(env(safe-area-inset-bottom, 0) + 12px);
    }
    /* ===== Estilos adicionais para grupos de sessões e fullscreen no Stack ===== */
    /* Container do grupo de sessões. Utiliza <details> para permitir colapsar/expandir. */
    .stack-group { margin-top: 12px; border: var(--bd); border-radius: var(--r); overflow: hidden; }
    .stack-group summary { background: var(--surface); padding: 8px 12px; font-weight: 800; cursor: pointer; list-style: none; display:flex; align-items:center; justify-content:space-between; }
    .stack-group summary::-webkit-details-marker { display: none; }
    .stack-group .group-content { padding: 8px 12px; }
    .stack-group .group-content .session { margin-top: 8px; }

    /* Deixe espaço no fim do Stack para a barra de navegação.  Isso evita que
       as sessões sobreponham os botões da nav inferior. */
    #stackWrap {
      padding-bottom: calc(var(--tabsH) + 16px);
    }

    /* Tela cheia de uma sessão: ocupa toda a tela, esconde cabeçalho e tabs */
    .session.full { position: fixed !important; inset: 0; z-index: 1000; margin: 0; width: 100%; height: 100%; display: flex; flex-direction: column; }
    .session.full iframe { flex: 1 1 auto !important; height: 100% !important; }
    /* No modo de tela cheia, esconda apenas o cabeçalho e o botão flutuante, mas mantenha a barra de navegação visível. */
    body.session-full header.mast,
    body.session-full .tabs-wrap,
    body.session-full .fab { display: none !important; }


/* --- Blue‑1 typing indicator (helper) --- */
.kb-typing{display:inline-flex;gap:6px;align-items:center}
.kb-typing i{width:6px;height:6px;border-radius:50%;background:currentColor;opacity:.6;animation:kbblink 1.2s infinite ease-in-out}
.kb-typing i:nth-child(2){animation-delay:.15s}
.kb-typing i:nth-child(3){animation-delay:.3s}
@keyframes kbblink{0%,80%,100%{transform:translateY(0);opacity:.5}40%{transform:translateY(-4px);opacity:1}}

</style>
<style id="blue1Theme">
/* === Blue‑1 Theme (UI) === */
:root {
  --bg: #070b12;
  --fg: #e6f2ff;
  --muted: #94b6d6;
  --brandA: #00c2ff;
  --brandB: #4b6fff;
  --brandHi: #8fd3ff;
  --glass: rgba(12,16,24,.64);
  --glass-2: rgba(12,16,24,.42);
  --ring: 0 0 0 1px rgba(143,211,255,.3), 0 0 18px rgba(0,194,255,.25);
}
body { background: radial-gradient(1200px 800px at 60% -10%, #0a1220 0%, #070b12 55%, #05080f 100%); color: var(--fg); }
.topbar, .subbar, .dock, .pane, .card, .tile, .shelf { background: var(--glass); backdrop-filter: blur(10px); border: 1px solid rgba(143,211,255,.12); box-shadow: var(--ring); }
button, .btn, .chip { background: linear-gradient(180deg, rgba(13,22,34,.7), rgba(9,14,22,.7)); border: 1px solid rgba(143,211,255,.18); }
a { color: var(--brandHi); }
</style><style id="customStyle">/* --------------------------------------------
   KOBLLUX • Compact Mode — Mobile-first Vertical
   Colar após o CSS atual
--------------------------------------------- */

/* Base compacta + segurança */
*,
*::before,
*::after { box-sizing: border-box; }
html, body { max-width: 100%; overflow-x: hidden; }
body { padding-bottom: calc(16px + env(safe-area-inset-bottom)); }

/* Container nunca estoura, sem “gambiarra” de largura */
.response-container {
  inline-size: min(100%, calc(100% - 0px)) !important;
  padding: 1rem 0 2.75rem; /* + espaço safe-area já no body */
}

/* Nada lado a lado por padrão — empilha tudo */
.row,
.controls,
.kv,
.columns,
.split {
  display: block !important;
}

/* Qualquer tentativa de grid vira 1 coluna */
[class*="grid"],
[style*="grid-template-columns"],
.columns,
.split,
.panel,
.kv {
  display: grid !important;
  grid-template-columns: 1fr !important;
  align-items: stretch;
  gap: .5rem !important;
}

/* Pares “key→value” agora empilhados */
.kv > * { margin: 0 0 .4rem 0; }

/* Grupos de controles em coluna, ocupando 100% */
.controls .group {
  display: block !important;
  width: 100%;
  padding: .5rem .6rem;
  margin: 0 0 .6rem 0;
}
.controls .group > label,
.controls .group > select,
.controls .group > input,
.controls .group > button { display: block; width: 100%; }

/* Botões e inputs: alvo de toque ≥44px */
.btn,
select,
input[type="text"],
input[type="file"],
input[type="range"],
input[type="checkbox"],
input[type="radio"],
label[for],
textarea {
  min-height: 44px;
}

/* Botão Único: respeita safe-area no iOS */
#btnKOBLLUX { 
  bottom: calc(1rem + env(safe-area-inset-bottom));
}

/* Navegações/chips SOMENTE na header: scroll horizontal, sem wrap */
.header .row {
  display: block !important;
  overflow-x: auto;
  white-space: nowrap;
  scrollbar-width: thin;
  -webkit-overflow-scrolling: touch;
  padding-bottom: .25rem;
  margin-bottom: .25rem;
}
.header .row > * {
  display: inline-block;
  vertical-align: top;
  margin-right: .5rem;
}

/* Dropzone 100% vertical */
.dropzone .dz-area { display: block !important; }
.dropzone .row { display: block !important; }
.dropzone .row > * { display: block; width: 100%; margin: .5rem 0 0; }

/* Editor e Preview sempre empilhados (Preview abaixo)
   Use #analysis como Preview, ou crie #preview se preferir. */
.editor {
  width: 100%;
  min-height: 48vh;
  height: 52vh;          /* alvo ~50–60vh */
  max-height: 60vh;
  overflow: auto;
}
#analysis,
#preview {
  display: block;
  width: 100%;
  min-height: 42vh;
  height: 50vh;          /* alvo ~50–60vh */
  max-height: 60vh;
  overflow: auto;
  white-space: pre-wrap;  /* evita overflow lateral */
  word-wrap: break-word;
}

/* Cards/listas/painéis: pilha vertical com scroll interno quando necessário */
.response-block.glass,
.panel {
  max-height: unset;     /* deixe rolar a página */
}
.panel[data-scroll],
.response-block.glass[data-scroll],
.card[data-scroll],
[list][data-scroll] {
  max-height: 60vh;
  overflow: auto;
}

/* Controles verticais: sliders + labels exibidos em coluna */
.controls label { margin: 0 0 .25rem 0; }
.controls input[type="range"] { margin: .25rem 0 .5rem; }

/* Sliders com preenchimento dinâmico (mantém seu gradiente) */
input[type="range"]{
  /* estes tokens são calculados por JS no seu app, mantidos aqui */
  inline-size: 100%;
}

/* Toggle (Auto‑detectar): aumenta para tap ≥44px */
#autoDetect{
  --w: 72px; --h: 44px; --pad: 4px;
  min-height: 44px;
}

/* SELECT e BTN ocupam a linha inteira no modo compact */
select,
.btn { width: 100%; }

/* Grids/tabelas internas que insistem em múltiplas colunas → força 1fr */
[role="grid"],
[role="table"],
table,
.table,
.list,
.cards,
.cards-grid,
.items-grid {
  display: grid !important;
  grid-template-columns: 1fr !important;
}

/* Editor/Preview evitando sangrar lateralmente (longas strings/URLs) */
.editor,
pre { word-break: break-word; }

/* Header único (nenhum footer fixo) — nenhuma regra extra de footer */

/* Safe-area e “tap spacing” no rodapé de ações flutuantes/badges */
.badge-reopen { 
  bottom: calc(1rem + env(safe-area-inset-bottom));
}

/* Animação e sombras mais discretas (versão compact) */
.glass { padding: .75rem .9rem; }
.btn { padding: .7rem 1rem; }

/* Scroll horizontal utilitário (caso queira aplicar em outra nav) */
.h-scroll { overflow-x: auto; white-space: nowrap; }
.h-scroll > * { display: inline-block; }

/* Qualquer .columns e .split SEMPRE block (reforço final) */
.columns, .split { display: block !important; }

/* Segurança extra: força colunas únicas em componentes “teimosos” */
[class*="columns-"],
[class*="cols-"],
[class*="grid-"] {
  grid-template-columns: 1fr !important;
}

/* Evitar wrap de ícones/textos em chips sem quebrar layout */
.pill { display: inline-block; }

/* Garantir que iFrame seguro não crie overflow lateral */
.ifr { inline-size: 100%; max-inline-size: 100%; }
.ifr .bar { display: block; }
.ifr .bar .spacer { display: none; }
.ifr .bar .btn,
.ifr .bar .btn.ghost { width: 100%; margin-top: .4rem; }

/* Acessibilidade: foco visível “compact” */
:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(57,255,182,.18); }

/* Restrições finais — nada lado a lado fora da header */
main .row { display: block !important; }
main .row > * + * { margin-top: .5rem; }

/* (Opcional) reduz micro gaps gerais para versão compacta */
.stack { gap: .5rem !important; }
:root{--radius:12px;--blur:16px;--shadow:0 6px 26px rgba(0,255,255,.22);--fast:.12s;--med:.2s;--slow:.45s;--focus-ring:0 0 0 3px rgba(57,255,182,.22);font-synthesis-weight:none}html,body{overflow-x:hidden}body{padding-bottom:max(12px,env(safe-area-inset-bottom))}.response-container{width:min(100%,100% - 0px)!important;padding:1rem 0 4rem}.glass{border-radius:var(--radius);backdrop-filter:blur(var(--blur));box-shadow:var(--shadow);transition:box-shadow var(--med) ease,filter var(--med) ease,transform var(--med) ease}.glass:hover{filter:brightness(1.02)}.row,.controls,.controls .group,.kv,.panel,.stack,.dropzone .dz-area,.header,.sheet,.ifr,.ifr .bar{display:block!important}.row>*,.controls>*,.controls .group>*,.panel>*{margin-block:.55rem}.columns,.split{display:block!important}.header,.panel,.kv,.stack,[class*="grid"],[style*="grid-template-columns"]{grid-template-columns:1fr!important}.editor{min-height:52svh;max-height:60svh;width:100%;resize:vertical;overflow:auto}.preview,#preview{display:block;margin-top:.8rem;min-height:48svh;max-height:58svh;overflow:auto}.header .row.small{display:flex!important;flex-direction:row;flex-wrap:nowrap!important;gap:.5rem;overflow-x:auto;overflow-y:hidden;white-space:nowrap;-webkit-overflow-scrolling:touch;scroll-snap-type:x proximity}.header .row.small>*{flex:0 0 auto;scroll-snap-align:start}:where(button,.btn,[role="button"],label,select,input,textarea,.pill){min-block-size:44px;touch-action:manipulation;-webkit-tap-highlight-color:rgba(255,255,255,.08)}.btn{width:100%;justify-content:center;text-align:center;transition:transform var(--fast) ease,filter var(--fast) ease,box-shadow var(--fast) ease!important}.btn:active{transform:translateY(1px) scale(.995)}#btnKOBLLUX{bottom:calc(1rem + env(safe-area-inset-bottom))}select,.select,textarea,input[type="text"],input[type="email"],input[type="search"],input[type="number"]{width:100%;max-width:100%}input[type="range"]{width:100%!important;min-block-size:44px}.card,.list,.grid,.panel,.sheet,.overlay .sheet,.ifr{max-height:86svh;overflow:auto}footer{position:static!important;inset:auto!important}.header .title{font-weight:700;letter-spacing:.2px}.kv{display:block!important}.kv .muted,.kv .val{display:block}.controls .group{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.08);padding:.6rem .7rem}.pill{padding:.44rem .66rem}.meter{width:100%}.ifr{grid-template-rows:auto 1fr!important}.ifr .bar>*{margin-block:.4rem}@media (prefers-reduced-motion:reduce){*{animation-duration:.001ms!important;animation-iteration-count:1!important;transition-duration:.001ms!important;scroll-behavior:auto!important}}</style><style id="multiagent-styles">
  #chatFeed .msg.horus{align-self:flex-start;background:rgba(255,195,0,.16);border-radius:16px 16px 16px 0;padding:8px 12px;max-width:75%}
  #chatFeed .msg.atlas{align-self:flex-start;background:rgba(64,158,255,.16);border-radius:16px 16px 16px 0;padding:8px 12px;max-width:75%}
  #chatFeed .msg.ion{align-self:flex-start;background:rgba(255,159,67,.16);border-radius:16px 16px 16px 0;padding:8px 12px;max-width:75%}
  #chatFeed .msg.status{align-self:center;color:var(--mut);background:transparent}
  .ai-tag{font-weight:900;letter-spacing:.02em;margin:0 0 4px 0;opacity:.9}
  .ai-meta{font-size:12px;color:var(--mut)}
  .plan-list{margin:6px 0 0 0;padding-left:18px}
  .plan-list li{margin:4px 0}
  </style>
<style id="patch-blue1-theme">

/* === PATCH • Blue‑1 UI theme (entire UI) === */
body[data-theme="blue1"] {
  --grad-a: #0b1e3b;
  --grad-b: #113a7b;
  --fg: #e8f0ff;
  --mut: rgba(232,240,255,.68);
  --surface: rgba(10,16,28,.55);
  --surface-strong: rgba(10,16,28,.88);
  --bd: 1px solid rgba(126,170,255,.16);
  --ok: #39ffb6;
  --warn: #ffb86b;
  --err: #ff6b6b;
  --blur: 28px;
}
/* Chat styling tuned to Blue‑1 */
body[data-theme="blue1"] #chatFeed .msg.ai { background: rgba(77, 148, 255, 0.14); }
body[data-theme="blue1"] #chatFeed .msg.user { background: rgba(232,240,255,0.10); }

</style>
</head>
<body data-theme="blue1">
  <!-- Splash screen displayed on initial load -->
  
  <!-- Som do splash: coloque seu arquivo de áudio na pasta especificada e ajuste o caminho abaixo.
       O som será reproduzido automaticamente quando o splash aparecer. -->
  <audio id="splashSound" src="Cassettes/Barra Sounds/Suave Underline e Portal.mp3" preload="auto"></audio>
  <!-- ===== Header ===== -->
  <header class="mast">
    <button class="ib fx-trans fx-press ring" id="btnBack" title="Voltar" aria-label="Voltar">
    <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/arrow-left.svg" alt="Voltar" width="20" height="20" onerror="this.onerror=null;this.src='icons/arrow-left.svg'">
      <span class="ripple"></span>
    </button>
    <div class="title">
      <h1>HUB UNO</h1>
      <small>Dual · Trinity</small>
    </div>
    <button class="ib fx-trans fx-press ring" id="btnDownload" title="Baixar HTML">
<img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/download.svg" alt="Download" width="20" height="20" onerror="this.onerror=null;this.src='icons/download.svg'">
      <span class="ripple"></span>
    </button>
    <button class="ib fx-trans fx-press ring" id="btnHelp" title="Ajuda / Atalhos">
<img src="icons/question-circle.svg" alt="Ajuda" width="20" height="20" onerror="this.onerror=null;this.src='icons/question-circle.svg'">
      <span class="ripple"></span>
    </button>
    <button class="ib fx-trans fx-press ring" id="btnBrain" title="Brain">
<img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/brain.svg" alt="Brain" width="20" height="20" onerror="this.onerror=null;this.src='icons/brain.svg'">
      <span class="ripple"></span>
    </button>
  <button class="ib fx-trans fx-press ring" id="btnLS" title="Local Storage" aria-label="Local Storage">
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f5f7ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
    <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
    <path d="M3 5v7c0 1.7 4 3 9 3s9-1.3 9-3V5"></path>
    <path d="M3 12c0 1.7 4 3 9 3s9-1.3 9-3"></path>
  </svg>
  <span class="ripple"></span>
</button>
  </header>

  <!-- Âncora para sessões abertas quando o usuário optar por abrir dentro da página -->
  <section id="sessionsAnchor"></section>

  <!-- Container para fundo personalizado (imagem ou vídeo).  Será preenchido via JS quando o usuário escolher
       um tema customizado.  Fica no início do body para garantir que fique abaixo de todos os conteúdos -->
  <div id="custom-bg" style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;overflow:hidden;pointer-events:none"></div>

  <!-- ===== Views ===== -->
  <main>
    <!-- HOME -->
    <section id="v-home" class="view">
      <div class="grid">
          <!-- Saudação / chamada para cadastro. Visível quando o usuário precisa ativar a Dual Infodose ou quando já houver nome salvo -->
          <div id="greetingCard" class="card fx-trans fx-lift" style="display:none">
            <div id="greetingMsg" style="font-weight:800"></div>
          </div>
        <div id="unoCard" class="card fx-trans fx-lift" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;width:100%">
            <div>
              <div style="font-weight:900;letter-spacing:.08em">UNO • foco e velocidade</div>
              <div class="mut">Monólito: Apps embutidos + Viewer + Dock + Atalhos</div>
            </div>
            <div class="ico">
<img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/bolt.svg" alt="Energia" width="24" height="24" onerror="this.onerror=null;this.src='icons/bolt.svg'">
            </div>
          </div>
        </div>
        <!-- Área de Arquétipos incorporada -->
        <div class="arch-container">
          <!-- Mover o seletor de arquétipos para fora do círculo.  Ele ficará acima
               da bolinha e seguirá o layout vertical da arch-container. -->
          <div class="arch-switcher">
            <button class="btn fx-trans fx-press ring" id="arch-prev" title="Anterior">
              <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/chevron-left.svg" alt="Anterior" width="16" height="16" onerror="this.onerror=null;this.src='icons/chevron-left.svg'">
            <span class="ripple"></span></button>
            <select id="arch-select" title="Escolher arquétipo"><option value="atlas.html">atlas.html</option><option value="nova.html">nova.html</option><option value="vitalis.html">vitalis.html</option><option value="pulse.html">pulse.html</option><option value="artemis.html">artemis.html</option><option value="serena.html">serena.html</option><option value="kaos.html">kaos.html</option><option value="genus.html">genus.html</option><option value="lumine.html">lumine.html</option><option value="rhea.html">rhea.html</option><option value="solus.html">solus.html</option><option value="aion.html">aion.html</option></select>
            <button class="btn fx-trans fx-press ring" id="arch-next" title="Próximo">
              <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/chevron-right.svg" alt="Próximo" width="16" height="16" onerror="this.onerror=null;this.src='icons/chevron-right.svg'">
            <span class="ripple"></span></button>
          </div>
          <div class="arch-circle">
            <div id="arch-fadeCover"></div>
            <!-- Camada de ripple auditivo fica sobre o conteúdo do círculo -->
            <div id="audioRipple" class="audio-ripple"></div>
            <iframe id="arch-frame" title="Archetype Core" sandbox="allow-scripts" referrerpolicy="no-referrer" src="./archetypes/atlas.html"></iframe>
          </div>
          <!-- Mensagem de feedback aparece fora da bolinha, logo abaixo dela -->
          <div id="archMsg" class="arch-msg show" style="background: rgba(57, 255, 182, 0.75); color: rgb(11, 15, 20);">Bem-vindo de volta, KODUX. UNO está ao seu lado.</div>
          <!-- Menu de arquétipos: permite acessar Apps, Stack, Usuário, Revo e Home -->
          <div id="archMenu" class="arch-menu">
            <button data-nav="apps">
              <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/folder-open.svg" alt="Apps" width="20" height="20" onerror="this.onerror=null;this.src='icons/folder-open.svg'">
              <span>Apps</span>
            <span class="ripple"></span></button>
            <button data-nav="stack">
              <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/layer-group.svg" alt="Stack" width="20" height="20" onerror="this.onerror=null;this.src='icons/layer-group.svg'">
              <span>Stack</span>
            <span class="ripple"></span></button>
            <button data-nav="brain">
              <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/user.svg" alt="Usuário" width="20" height="20" onerror="this.onerror=null;this.src='icons/user.svg'">
              <span>Usuário</span>
            <span class="ripple"></span></button>
            <button data-nav="home">
              <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/yin-yang.svg" alt="Arquétipo" width="20" height="20" onerror="this.onerror=null;this.src='icons/yin-yang.svg'">
              <span>Arquétipo</span>
            <span class="ripple"></span></button>
            <button data-nav="chat">
              <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/comments.svg" alt="Chat" width="20" height="20" onerror="this.onerror=null;this.src='icons/comments.svg'">
              <span>Chat</span>
            <span class="ripple"></span></button>
          <button data-audio="true" id="archAudioBtn">
            <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/microphone-lines.svg" alt="Áudio" width="20" height="20" onerror="this.onerror=null;this.src='icons/microphone-lines.svg'">
            <span>Áudio</span>
          <span class="ripple"></span></button>
          </div>
        </div><div class="cards">
          <button class="card fx-trans fx-press ring" data-nav="apps">
            <div class="ico">
<img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/folder-open.svg" alt="Apps" width="24" height="24" onerror="this.onerror=null;this.src='icons/folder-open.svg'">
            </div>
            <div>
              <div style="font-weight:800">Apps</div>
              <div class="mut" id="homeAppsStatus">15 apps</div>
            </div>
            <span class="ripple"></span>
          </button>
          <button class="card fx-trans fx-press ring" data-nav="stack">
            <div class="ico">
<img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/layer-group.svg" alt="Stack" width="24" height="24" onerror="this.onerror=null;this.src='icons/layer-group.svg'">
            </div>
            <div>
              <div style="font-weight:800">Stack</div>
              <div class="mut" id="homeStackStatus">0 sessãos</div>
            </div>
            <span class="ripple"></span>
          </button>
          <button class="card fx-trans fx-press ring" data-nav="brain">
            <div class="ico">
<img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/user.svg" alt="Usuário" width="24" height="24" onerror="this.onerror=null;this.src='icons/user.svg'">
            </div>
            <div>
              <div style="font-weight:800">Usuário</div>
              <div class="mut" id="homeUserStatus">KODUX · padrão</div>
            </div>
            <span class="ripple"></span>
          </button>
          <button class="card fx-trans fx-press ring" data-nav="home">
            <div class="ico">
<img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/yin-yang.svg" alt="Arquétipo" width="24" height="24" onerror="this.onerror=null;this.src='icons/yin-yang.svg'">
            </div>
            <div>
              <div style="font-weight:800">Arquétipo</div>
              <div class="mut" id="homeArchStatus">atlas</div>
            </div>
            <span class="ripple"></span>
          </button>
        </div>
        <!-- Feed de texto da IA -->
        <div id="iaFeed" aria-live="polite" aria-atomic="false">
          <div class="status">Toque a bolinha para falar com a IA.</div>
        </div>
        
      </div>
    </section>

    <!-- APPS -->
    <section id="v-apps" class="view">
      <div class="grid">
        <div class="card fx-trans fx-lift" style="display:block">
          <div class="grid" style="gap:8px">
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
              <!-- Removemos a busca e o sort. Agora apenas a opção de abrir dentro e o botão para mostrar locais -->
              <label class="mut" style="display:inline-flex;gap:6px;align-items:center">
                <input id="openInside" type="checkbox" checked=""> abrir dentro
              </label>
              <button id="btnToggleLocal" class="btn fx-trans fx-press ring">
                <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/folder-open.svg" alt="Locais" width="16" height="16" onerror="this.onerror=null;this.src='icons/folder-open.svg'" style="margin-right:4px">
                Mostrar Locais<span class="ripple"></span>
              </button>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
              <!-- Aceita arquivos .json além de HTML/TXT para permitir upload de catálogos personalizados -->
              <input id="fileLocal" type="file" accept=".html,.htm,.txt,.json" multiple="" class="input ring">
              <button id="btnImport" class="btn fx-trans fx-press ring">
                <img src="icons/plus-circle.svg" alt="Adicionar" width="16" height="16" onerror="this.onerror=null;this.src='icons/plus-circle.svg'" style="margin-right:4px">
                Adicionar Locais<span class="ripple"></span>
              </button>
              <button id="btnExport" class="btn fx-trans fx-press ring">
                <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/file-export.svg" alt="Exportar" width="16" height="16" onerror="this.onerror=null;this.src='icons/file-export.svg'" style="margin-right:4px">
                Exportar Locais<span class="ripple"></span>
              </button>
              <button id="btnClear" class="btn fx-trans fx-press ring">
                <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/trash.svg" alt="Limpar" width="16" height="16" onerror="this.onerror=null;this.src='icons/trash.svg'" style="margin-right:4px">
                Limpar Locais<span class="ripple"></span>
              </button>
            </div>
            <div id="appsCount" class="mut">15 apps</div>
          </div>
        </div>
        <div id="appsWrap" class="apps-wrap"><div class="apps-group"><h3 style="margin: 16px 4px 8px; font-size: 15px; font-weight: 800; color: var(--mut);">Ampara</h3><div class="grid"><div class="app-card fx-trans fx-lift"><button class="fav-btn"><img alt="Favorito" src="icons/star.svg"><span class="ripple"></span></button><div class="app-icon"><img alt="" width="24" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Cpath%20d%3D%22M12%2021s-6-3.5-6-8a4%204%200%200%201%206-3%204%204%200%200%201%206%203c0%204.5-6%208-6%208z%22%2F%3E%3C%2Fsvg%3E"></div><div style="flex: 1 1 0%;"><div class="app-title" title="Serena · Ampara">Serena ·…</div><div class="mut">Acolhimento e suporte emocional.</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div></div></div><div class="apps-group"><h3 style="margin: 16px 4px 8px; font-size: 15px; font-weight: 800; color: var(--mut);">Arcana</h3><div class="grid"><div class="app-card fx-trans fx-lift"><button class="fav-btn"><img alt="Favorito" src="icons/star.svg"><span class="ripple"></span></button><div class="app-icon"><img alt="" width="24" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Cpath%20d%3D%22M12%203v6M12%2015v6%22%2F%3E%3Ccircle%20cx%3D%2212%22%20cy%3D%2212%22%20r%3D%223%22%2F%3E%3Cpath%20d%3D%22M19%205l-3%203M5%2019l3-3M5%205l3%203M19%2019l-3-3%22%2F%3E%3C%2Fsvg%3E"></div><div style="flex: 1 1 0%;"><div class="app-title" title="Solus · Arcana">Solus ·…</div><div class="mut">Harmonização energética e meditação.</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div></div></div><div class="apps-group"><h3 style="margin: 16px 4px 8px; font-size: 15px; font-weight: 800; color: var(--mut);">Brilhare</h3><div class="grid"><div class="app-card fx-trans fx-lift"><button class="fav-btn"><img alt="Favorito" src="icons/star.svg"><span class="ripple"></span></button><div class="app-icon"><img alt="" width="24" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Ccircle%20cx%3D%2212%22%20cy%3D%2212%22%20r%3D%224%22%2F%3E%3Cpath%20d%3D%22M12%202v2M12%2020v2M2%2012h2M20%2012h2M4.9%204.9l1.4%201.4M17.7%2017.7l1.4%201.4M4.9%2019.1l1.4-1.4M17.7%206.3l1.4-1.4%22%2F%3E%3C%2Fsvg%3E"></div><div style="flex: 1 1 0%;"><div class="app-title" title="Lumine · Brilhare">Lumine ·…</div><div class="mut">Inspiração leve e atividades lúdicas.</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div></div></div><div class="apps-group"><h3 style="margin: 16px 4px 8px; font-size: 15px; font-weight: 800; color: var(--mut);">Cartesius</h3><div class="grid"><div class="app-card fx-trans fx-lift"><button class="fav-btn"><img alt="Favorito" src="icons/star.svg"><span class="ripple"></span></button><div class="app-icon"><img alt="" width="24" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Ccircle%20cx%3D%2212%22%20cy%3D%2212%22%20r%3D%229%22%2F%3E%3Cpath%20d%3D%22M3%2012h18M12%203v18%22%2F%3E%3Cpath%20d%3D%22M5%208c3%202%2011%202%2014%200M5%2016c3-2%2011-2%2014%200%22%2F%3E%3C%2Fsvg%3E"></div><div style="flex: 1 1 0%;"><div class="app-title" title="Atlas · Cartesius">Atlas ·…</div><div class="mut">Planejador estratégico com cronogramas e checklists.</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div></div></div><div class="apps-group"><h3 style="margin: 16px 4px 8px; font-size: 15px; font-weight: 800; color: var(--mut);">Disruptor</h3><div class="grid"><div class="app-card fx-trans fx-lift"><button class="fav-btn"><img alt="Favorito" src="icons/star.svg"><span class="ripple"></span></button><div class="app-icon"><img alt="" width="24" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Cpath%20d%3D%22M4%204l7%207-7%207%22%2F%3E%3Cpath%20d%3D%22M20%204l-7%207%207%207%22%2F%3E%3C%2Fsvg%3E"></div><div style="flex: 1 1 0%;"><div class="app-title" title="Kaos · Disruptor">Kaos ·…</div><div class="mut">Questiona padrões e propõe soluções ousadas.</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div></div></div><div class="apps-group"><h3 style="margin: 16px 4px 8px; font-size: 15px; font-weight: 800; color: var(--mut);">Evolutia</h3><div class="grid"><div class="app-card fx-trans fx-lift"><button class="fav-btn"><img alt="Favorito" src="icons/star.svg"><span class="ripple"></span></button><div class="app-icon"><img alt="" width="24" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Cpath%20d%3D%22M7%2012c0-2.2%201.8-4%204-4%201.2%200%202.3.5%203%201.3M17%2012c0%202.2-1.8%204-4%204-1.2%200-2.3-.5-3-1.3%22%2F%3E%3Cpath%20d%3D%22M3%2012h4M17%2012h4%22%2F%3E%3C%2Fsvg%3E"></div><div style="flex: 1 1 0%;"><div class="app-title" title="Aion · Evolutia">Aion ·…</div><div class="mut">Microações estratégicas e evolução.</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div></div></div><div class="apps-group"><h3 style="margin: 16px 4px 8px; font-size: 15px; font-weight: 800; color: var(--mut);">Fabricus</h3><div class="grid"><div class="app-card fx-trans fx-lift"><button class="fav-btn"><img alt="Favorito" src="icons/star.svg"><span class="ripple"></span></button><div class="app-icon"><img alt="" width="24" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Crect%20x%3D%227%22%20y%3D%227%22%20width%3D%2210%22%20height%3D%2210%22%20rx%3D%222%22%2F%3E%3Cpath%20d%3D%22M7%207l5-3%205%203M17%2017l-5%203-5-3%22%2F%3E%3C%2Fsvg%3E"></div><div style="flex: 1 1 0%;"><div class="app-title" title="Genus · Fabricus">Genus ·…</div><div class="mut">Protótipos e materialização de ideias.</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div></div></div><div class="apps-group"><h3 style="margin: 16px 4px 8px; font-size: 15px; font-weight: 800; color: var(--mut);">Inspira</h3><div class="grid"><div class="app-card fx-trans fx-lift"><button class="fav-btn"><img alt="Favorito" src="icons/star.svg"><span class="ripple"></span></button><div class="app-icon"><img alt="" width="24" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Cpath%20d%3D%22M12%202v4M12%2018v4M2%2012h4M18%2012h4%22%2F%3E%3Cpath%20d%3D%22M5.6%205.6l2.8%202.8M15.6%2015.6l2.8%202.8M18.4%205.6l-2.8%202.8M8.4%2015.6l-2.8%202.8%22%2F%3E%3Ccircle%20cx%3D%2212%22%20cy%3D%2212%22%20r%3D%223%22%2F%3E%3C%2Fsvg%3E"></div><div style="flex: 1 1 0%;"><div class="app-title" title="Nova · Inspira">Nova ·…</div><div class="mut">Criativa que desbloqueia ideias com mapas mentais e exercícios.</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div></div></div><div class="apps-group"><h3 style="margin: 16px 4px 8px; font-size: 15px; font-weight: 800; color: var(--mut);">Momentum</h3><div class="grid"><div class="app-card fx-trans fx-lift"><button class="fav-btn"><img alt="Favorito" src="icons/star.svg"><span class="ripple"></span></button><div class="app-icon"><img alt="" width="24" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Cpath%20d%3D%22M3%2012h4l2-5%204%2010%202-5h6%22%2F%3E%3Cpath%20d%3D%22M13%203l-2%204%203%201-2%204%22%2F%3E%3C%2Fsvg%3E"></div><div style="flex: 1 1 0%;"><div class="app-title" title="Vitalis · Momentum">Vitalis ·…</div><div class="mut">Rotinas físicas, hacks biológicos e motivação.</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div></div></div><div class="apps-group"><h3 style="margin: 16px 4px 8px; font-size: 15px; font-weight: 800; color: var(--mut);">Naviga</h3><div class="grid"><div class="app-card fx-trans fx-lift"><button class="fav-btn"><img alt="Favorito" src="icons/star.svg"><span class="ripple"></span></button><div class="app-icon"><img alt="" width="24" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Cpath%20d%3D%22M3%2012h12%22%2F%3E%3Cpath%20d%3D%22M13%206l6%206-6%206%22%2F%3E%3Ccircle%20cx%3D%2212%22%20cy%3D%2212%22%20r%3D%229%22%2F%3E%3C%2Fsvg%3E"></div><div style="flex: 1 1 0%;"><div class="app-title" title="Artemis · Naviga">Artemis ·…</div><div class="mut">Explora conhecimentos e rotas de aprendizado.</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div></div></div><div class="apps-group"><h3 style="margin: 16px 4px 8px; font-size: 15px; font-weight: 800; color: var(--mut);">Outros</h3><div class="grid"><div class="app-card fx-trans fx-lift"><button class="fav-btn"><img alt="Favorito" src="icons/star.svg"><span class="ripple"></span></button><div class="app-icon"><img alt="" width="24" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Ccircle%20cx%3D%2212%22%20cy%3D%2212%22%20r%3D%229%22%2F%3E%3Cpath%20d%3D%22M3%2012h18M12%203v18%22%2F%3E%3Cpath%20d%3D%22M5%208c3%202%2011%202%2014%200M5%2016c3-2%2011-2%2014%200%22%2F%3E%3C%2Fsvg%3E"></div><div style="flex: 1 1 0%;"><div class="app-title" title="Dual_esqueci">Dual_esqueci</div><div class="mut">HTML local</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div><div class="app-card fx-trans fx-lift"><button class="fav-btn"><img alt="Favorito" src="icons/star.svg"><span class="ripple"></span></button><div class="app-icon"><img alt="" width="24" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Ccircle%20cx%3D%2212%22%20cy%3D%2212%22%20r%3D%229%22%2F%3E%3Cpath%20d%3D%22M3%2012h18M12%203v18%22%2F%3E%3Cpath%20d%3D%22M5%208c3%202%2011%202%2014%200M5%2016c3-2%2011-2%2014%200%22%2F%3E%3C%2Fsvg%3E"></div><div style="flex: 1 1 0%;"><div class="app-title" title="index_kobllux_voicefix">index_kobllux_voicefix</div><div class="mut">HTML local</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div><div class="app-card fx-trans fx-lift"><button class="fav-btn"><img alt="Favorito" src="icons/star.svg"><span class="ripple"></span></button><div class="app-icon"><img alt="" width="24" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Ccircle%20cx%3D%2212%22%20cy%3D%2212%22%20r%3D%229%22%2F%3E%3Cpath%20d%3D%22M3%2012h18M12%203v18%22%2F%3E%3Cpath%20d%3D%22M5%208c3%202%2011%202%2014%200M5%2016c3-2%2011-2%2014%200%22%2F%3E%3C%2Fsvg%3E"></div><div style="flex: 1 1 0%;"><div class="app-title" title="index-100">index-100</div><div class="mut">HTML local</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div></div></div><div class="apps-group"><h3 style="margin: 16px 4px 8px; font-size: 15px; font-weight: 800; color: var(--mut);">Raízes</h3><div class="grid"><div class="app-card fx-trans fx-lift"><button class="fav-btn"><img alt="Favorito" src="icons/star.svg"><span class="ripple"></span></button><div class="app-icon"><img alt="" width="24" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Cpath%20d%3D%22M12%203v6%22%2F%3E%3Ccircle%20cx%3D%2212%22%20cy%3D%229%22%20r%3D%224%22%2F%3E%3Cpath%20d%3D%22M12%2013v2l-2%202M12%2015l2%202M12%2017v3%22%2F%3E%3C%2Fsvg%3E"></div><div style="flex: 1 1 0%;"><div class="app-title" title="Rhea · Raízes">Rhea ·…</div><div class="mut">Vínculos e memórias emocionais.</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div></div></div><div class="apps-group"><h3 style="margin: 16px 4px 8px; font-size: 15px; font-weight: 800; color: var(--mut);">Resona</h3><div class="grid"><div class="app-card fx-trans fx-lift"><button class="fav-btn"><img alt="Favorito" src="icons/star.svg"><span class="ripple"></span></button><div class="app-icon"><img alt="" width="24" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Cpath%20d%3D%22M2%2012h3l2-4%203%208%202-4h8%22%2F%3E%3Cpath%20d%3D%22M20%208v-3M20%2019v-3%22%2F%3E%3C%2Fsvg%3E"></div><div style="flex: 1 1 0%;"><div class="app-title" title="Pulse · Resona">Pulse ·…</div><div class="mut">Trilhas sonoras e ajuste de som emocional.</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div></div></div></div>
      </div>
    </section>

    <!-- STACK -->
    <section id="v-stack" class="view">
      <div class="grid">
        <div class="card fx-trans fx-lift" style="display:block">
          <div style="font-weight:800; display:flex; align-items:center; gap:8px">
            Sessões
            <button id="btnCloseAll" class="btn fx-trans fx-press ring" title="Fechar todas">
              <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/xmark.svg" alt="Fechar todas" width="16" height="16" onerror="this.onerror=null;this.src='icons/xmark.svg'" style="margin-right:4px">
              Fechar todas<span class="ripple"></span>
            </button>
            <!-- Botão para criar grupos de sessões -->
            <button id="btnAddGroup" class="btn fx-trans fx-press ring" title="Novo grupo">
              <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/folder-plus.svg" alt="Novo grupo" width="16" height="16" onerror="this.onerror=null;this.src='icons/folder-plus.svg'" style="margin-right:4px">
              Novo grupo<span class="ripple"></span>
            </button>
            <!-- Botão para enviar um HTML local e abrir como sessão -->
            <button id="btnStackUpload" class="btn fx-trans fx-press ring" title="Upload HTML">
              <img src="icons/file-upload.svg" alt="Upload HTML" width="16" height="16" onerror="this.onerror=null;this.src='icons/file-upload.svg'" style="margin-right:4px">
              Upload HTML<span class="ripple"></span>
            </button>
            <input id="stackUpload" type="file" accept=".html,text/html" style="display:none">
          </div>
          <div class="mut">Reabra rápido pelo dock abaixo.</div>
        </div>
        <!-- Área de grupos e sessões -->
        <div id="stackWrap" class="grid"></div>
      </div>
    </section>

    <!-- BRAIN -->
    <section id="v-brain" class="view active">
      <div class="grid">
        <div class="card fx-trans fx-lift" style="display:block">
          <div style="font-weight:800">Usuário</div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
            <input id="userName" class="input ring" placeholder="Seu nome">
            <button id="saveName" class="btn prime fx-trans fx-press ring">Salvar<span class="ripple"></span></button>
          </div>
        </div>
        <!-- Configuração do assistente (Dual) -->
        <div class="card fx-trans fx-lift" style="display:block">
          <div style="font-weight:800">Assistente</div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
            <input id="assistantName" class="input ring" placeholder="Nome do assistente">
            <button id="saveAssistant" class="btn prime fx-trans fx-press ring">Salvar<span class="ripple"></span></button>
          </div>
        </div>
        <!-- Seleção da voz de boas-vindas -->
        <div class="card fx-trans fx-lift" style="display:block">
          <div style="font-weight:800">Voz do assistente</div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap">
            <select id="selectVoice" class="input ring" style="max-width:260px"><option value="Karen">Karen (en-AU)</option><option value="Rocko">Rocko (en-GB)</option><option value="Shelley">Shelley (en-GB)</option><option value="Daniel">Daniel (en-GB)</option><option value="Grandma">Grandma (en-GB)</option><option value="Grandpa">Grandpa (en-GB)</option><option value="Flo">Flo (en-GB)</option><option value="Eddy">Eddy (en-GB)</option><option value="Reed">Reed (en-GB)</option><option value="Sandy">Sandy (en-GB)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Flo">Flo (en-US)</option><option value="Bahh">Bahh (en-US)</option><option value="Albert">Albert (en-US)</option><option value="Fred">Fred (en-US)</option><option value="Jester">Jester (en-US)</option><option value="Organ">Organ (en-US)</option><option value="Cellos">Cellos (en-US)</option><option value="Zarvox">Zarvox (en-US)</option><option value="Rocko">Rocko (en-US)</option><option value="Shelley">Shelley (en-US)</option><option value="Superstar">Superstar (en-US)</option><option value="Grandma">Grandma (en-US)</option><option value="Eddy">Eddy (en-US)</option><option value="Bells">Bells (en-US)</option><option value="Grandpa">Grandpa (en-US)</option><option value="Trinoids">Trinoids (en-US)</option><option value="Kathy">Kathy (en-US)</option><option value="Reed">Reed (en-US)</option><option value="Boing">Boing (en-US)</option><option value="Whisper">Whisper (en-US)</option><option value="Good News">Good News (en-US)</option><option value="Wobble">Wobble (en-US)</option><option value="Bad News">Bad News (en-US)</option><option value="Bolhas">Bolhas (en-US)</option><option value="Samantha">Samantha (en-US)</option><option value="Sandy">Sandy (en-US)</option><option value="Junior">Junior (en-US)</option><option value="Ralph">Ralph (en-US)</option><option value="Tessa">Tessa (en-ZA)</option><option value="Reed">Reed (pt-BR)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Shelley">Shelley (pt-BR)</option><option value="Grandma">Grandma (pt-BR)</option><option value="Grandpa">Grandpa (pt-BR)</option><option value="Rocko">Rocko (pt-BR)</option><option value="Flo">Flo (pt-BR)</option><option value="Sandy">Sandy (pt-BR)</option><option value="Eddy">Eddy (pt-BR)</option><option value="Joana">Joana (pt-PT)</option><option value="Daniel">Daniel (en-GB)</option><option value="Samantha">Samantha (en-US)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Karen">Karen (en-AU)</option><option value="Joana">Joana (pt-PT)</option><option value="Tessa">Tessa (en-ZA)</option></select>
            <button id="saveVoice" class="btn fx-trans fx-press ring">Salvar<span class="ripple"></span></button>
          </div>
        </div>
        <div class="card fx-trans fx-lift" style="display:block">
          <div style="font-weight:800">OpenRouter</div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap">
            <select id="model" class="input ring" style="max-width:260px"><option value="openrouter/auto">openrouter/auto</option><option value="anthropic/claude-3.5-sonnet">anthropic/claude-3.5-sonnet</option><option value="openai/gpt-4.1-mini">openai/gpt-4.1-mini</option><option value="google/gemini-1.5-pro">google/gemini-1.5-pro</option><option value="meta/llama-3.1-405b-instruct">meta/llama-3.1-405b-instruct</option><option value="mistral/mistral-large-latest">mistral/mistral-large-latest</option></select>
            <input id="sk" class="input ring" placeholder="sk-or-v1-…">
            <button id="saveSK" class="btn fx-trans fx-press ring">Salvar<span class="ripple"></span></button>
          </div>

          <!-- Modelo personalizado e treino -->
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap">
            <input id="customModel" class="input ring" placeholder="Modelo personalizado (ex: openai/gpt-4-custom)" style="flex:1">
            <button id="addModel" class="btn fx-trans fx-press ring">Adicionar Modelo<span class="ripple"></span></button>
          </div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap">
            <input id="trainingFile" type="file" accept=".json,.txt,.dxt" class="input ring" style="max-width:260px">
            <span class="mut" style="font-size:11px">Treinamento (DXT)</span>
          </div>
        </div>

          <!-- Tema e Fundo personalizados -->
          <div class="card fx-trans fx-lift" style="display:block">
            <div style="font-weight:800">Tema &amp; Fundo</div>
            <div style="margin-top:8px;display:flex;flex-direction:column;gap:12px">
              <label style="display:flex;align-items:center;gap:8px">
                <span>Escolha o tema:</span>
                <select id="themeSelect" class="input ring" style="max-width:200px">
                  <option value="default">Padrão (colorido)</option>
                  <option value="medium">Cinza médio (tecnológico)</option>
                  <option value="custom">Personalizado (sua imagem/vídeo)</option>
                </select>
              </label>
              <label style="display:flex;align-items:center;gap:8px">
                <span>Fundo personalizado:</span>
                <input id="bgUpload" type="file" accept="image/*,video/*" class="input ring" style="max-width:260px">
              </label>
              <div class="mut" style="font-size:11px">Envie uma imagem ou vídeo para usar como plano de fundo quando o tema personalizado estiver selecionado. O fundo será salvo automaticamente no seu navegador.</div>
            </div>
          </div>

          <!-- CSS personalizado -->
          <div class="card fx-trans fx-lift" style="display:block">
            <div style="font-weight:800">CSS Personalizado</div>
            <div style="margin-top:8px">
              <textarea id="cssCustom" class="input ring" placeholder="CSS personalizado..." rows="4"></textarea>
              <div style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap">
                <button id="applyCSS" class="btn fx-trans fx-press ring">Aplicar CSS<span class="ripple"></span></button>
                <button id="clearCSS" class="btn fx-trans fx-press ring">Limpar CSS<span class="ripple"></span></button>
                <button id="downloadCSS" class="btn fx-trans fx-press ring">Baixar CSS<span class="ripple"></span></button>
              </div>
            </div>
          </div>

          <!-- Vozes dos Arquétipos -->
          <div class="card fx-trans fx-lift" style="display:block">
            <div style="font-weight:800; margin-bottom:6px">Vozes dos Arquétipos</div>
            <!-- Área de seleção de voz por arquétipo.  Cada arquétipo possui
                 um seletor de voz e um botão de teste.  Essa grade será
                 preenchida dinamicamente pelo código em initVoices(). -->
            <div id="voicesWrap" style="display:grid; gap:10px"><div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;"><span style="min-width: 70px; font-weight: 700;">Atlas</span><select class="input ring" style="max-width: 220px;"><option value="Karen">Karen (en-AU)</option><option value="Rocko">Rocko (en-GB)</option><option value="Shelley">Shelley (en-GB)</option><option value="Daniel">Daniel (en-GB)</option><option value="Grandma">Grandma (en-GB)</option><option value="Grandpa">Grandpa (en-GB)</option><option value="Flo">Flo (en-GB)</option><option value="Eddy">Eddy (en-GB)</option><option value="Reed">Reed (en-GB)</option><option value="Sandy">Sandy (en-GB)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Flo">Flo (en-US)</option><option value="Bahh">Bahh (en-US)</option><option value="Albert">Albert (en-US)</option><option value="Fred">Fred (en-US)</option><option value="Jester">Jester (en-US)</option><option value="Organ">Organ (en-US)</option><option value="Cellos">Cellos (en-US)</option><option value="Zarvox">Zarvox (en-US)</option><option value="Rocko">Rocko (en-US)</option><option value="Shelley">Shelley (en-US)</option><option value="Superstar">Superstar (en-US)</option><option value="Grandma">Grandma (en-US)</option><option value="Eddy">Eddy (en-US)</option><option value="Bells">Bells (en-US)</option><option value="Grandpa">Grandpa (en-US)</option><option value="Trinoids">Trinoids (en-US)</option><option value="Kathy">Kathy (en-US)</option><option value="Reed">Reed (en-US)</option><option value="Boing">Boing (en-US)</option><option value="Whisper">Whisper (en-US)</option><option value="Good News">Good News (en-US)</option><option value="Wobble">Wobble (en-US)</option><option value="Bad News">Bad News (en-US)</option><option value="Bolhas">Bolhas (en-US)</option><option value="Samantha">Samantha (en-US)</option><option value="Sandy">Sandy (en-US)</option><option value="Junior">Junior (en-US)</option><option value="Ralph">Ralph (en-US)</option><option value="Tessa">Tessa (en-ZA)</option><option value="Reed">Reed (pt-BR)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Shelley">Shelley (pt-BR)</option><option value="Grandma">Grandma (pt-BR)</option><option value="Grandpa">Grandpa (pt-BR)</option><option value="Rocko">Rocko (pt-BR)</option><option value="Flo">Flo (pt-BR)</option><option value="Sandy">Sandy (pt-BR)</option><option value="Eddy">Eddy (pt-BR)</option><option value="Joana">Joana (pt-PT)</option><option value="Daniel">Daniel (en-GB)</option><option value="Samantha">Samantha (en-US)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Karen">Karen (en-AU)</option><option value="Joana">Joana (pt-PT)</option><option value="Tessa">Tessa (en-ZA)</option></select><button class="btn fx-trans fx-press ring">Teste<span class="ripple"></span></button></div><div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;"><span style="min-width: 70px; font-weight: 700;">Nova</span><select class="input ring" style="max-width: 220px;"><option value="Karen">Karen (en-AU)</option><option value="Rocko">Rocko (en-GB)</option><option value="Shelley">Shelley (en-GB)</option><option value="Daniel">Daniel (en-GB)</option><option value="Grandma">Grandma (en-GB)</option><option value="Grandpa">Grandpa (en-GB)</option><option value="Flo">Flo (en-GB)</option><option value="Eddy">Eddy (en-GB)</option><option value="Reed">Reed (en-GB)</option><option value="Sandy">Sandy (en-GB)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Flo">Flo (en-US)</option><option value="Bahh">Bahh (en-US)</option><option value="Albert">Albert (en-US)</option><option value="Fred">Fred (en-US)</option><option value="Jester">Jester (en-US)</option><option value="Organ">Organ (en-US)</option><option value="Cellos">Cellos (en-US)</option><option value="Zarvox">Zarvox (en-US)</option><option value="Rocko">Rocko (en-US)</option><option value="Shelley">Shelley (en-US)</option><option value="Superstar">Superstar (en-US)</option><option value="Grandma">Grandma (en-US)</option><option value="Eddy">Eddy (en-US)</option><option value="Bells">Bells (en-US)</option><option value="Grandpa">Grandpa (en-US)</option><option value="Trinoids">Trinoids (en-US)</option><option value="Kathy">Kathy (en-US)</option><option value="Reed">Reed (en-US)</option><option value="Boing">Boing (en-US)</option><option value="Whisper">Whisper (en-US)</option><option value="Good News">Good News (en-US)</option><option value="Wobble">Wobble (en-US)</option><option value="Bad News">Bad News (en-US)</option><option value="Bolhas">Bolhas (en-US)</option><option value="Samantha">Samantha (en-US)</option><option value="Sandy">Sandy (en-US)</option><option value="Junior">Junior (en-US)</option><option value="Ralph">Ralph (en-US)</option><option value="Tessa">Tessa (en-ZA)</option><option value="Reed">Reed (pt-BR)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Shelley">Shelley (pt-BR)</option><option value="Grandma">Grandma (pt-BR)</option><option value="Grandpa">Grandpa (pt-BR)</option><option value="Rocko">Rocko (pt-BR)</option><option value="Flo">Flo (pt-BR)</option><option value="Sandy">Sandy (pt-BR)</option><option value="Eddy">Eddy (pt-BR)</option><option value="Joana">Joana (pt-PT)</option><option value="Daniel">Daniel (en-GB)</option><option value="Samantha">Samantha (en-US)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Karen">Karen (en-AU)</option><option value="Joana">Joana (pt-PT)</option><option value="Tessa">Tessa (en-ZA)</option></select><button class="btn fx-trans fx-press ring">Teste<span class="ripple"></span></button></div><div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;"><span style="min-width: 70px; font-weight: 700;">Vitalis</span><select class="input ring" style="max-width: 220px;"><option value="Karen">Karen (en-AU)</option><option value="Rocko">Rocko (en-GB)</option><option value="Shelley">Shelley (en-GB)</option><option value="Daniel">Daniel (en-GB)</option><option value="Grandma">Grandma (en-GB)</option><option value="Grandpa">Grandpa (en-GB)</option><option value="Flo">Flo (en-GB)</option><option value="Eddy">Eddy (en-GB)</option><option value="Reed">Reed (en-GB)</option><option value="Sandy">Sandy (en-GB)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Flo">Flo (en-US)</option><option value="Bahh">Bahh (en-US)</option><option value="Albert">Albert (en-US)</option><option value="Fred">Fred (en-US)</option><option value="Jester">Jester (en-US)</option><option value="Organ">Organ (en-US)</option><option value="Cellos">Cellos (en-US)</option><option value="Zarvox">Zarvox (en-US)</option><option value="Rocko">Rocko (en-US)</option><option value="Shelley">Shelley (en-US)</option><option value="Superstar">Superstar (en-US)</option><option value="Grandma">Grandma (en-US)</option><option value="Eddy">Eddy (en-US)</option><option value="Bells">Bells (en-US)</option><option value="Grandpa">Grandpa (en-US)</option><option value="Trinoids">Trinoids (en-US)</option><option value="Kathy">Kathy (en-US)</option><option value="Reed">Reed (en-US)</option><option value="Boing">Boing (en-US)</option><option value="Whisper">Whisper (en-US)</option><option value="Good News">Good News (en-US)</option><option value="Wobble">Wobble (en-US)</option><option value="Bad News">Bad News (en-US)</option><option value="Bolhas">Bolhas (en-US)</option><option value="Samantha">Samantha (en-US)</option><option value="Sandy">Sandy (en-US)</option><option value="Junior">Junior (en-US)</option><option value="Ralph">Ralph (en-US)</option><option value="Tessa">Tessa (en-ZA)</option><option value="Reed">Reed (pt-BR)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Shelley">Shelley (pt-BR)</option><option value="Grandma">Grandma (pt-BR)</option><option value="Grandpa">Grandpa (pt-BR)</option><option value="Rocko">Rocko (pt-BR)</option><option value="Flo">Flo (pt-BR)</option><option value="Sandy">Sandy (pt-BR)</option><option value="Eddy">Eddy (pt-BR)</option><option value="Joana">Joana (pt-PT)</option><option value="Daniel">Daniel (en-GB)</option><option value="Samantha">Samantha (en-US)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Karen">Karen (en-AU)</option><option value="Joana">Joana (pt-PT)</option><option value="Tessa">Tessa (en-ZA)</option></select><button class="btn fx-trans fx-press ring">Teste<span class="ripple"></span></button></div><div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;"><span style="min-width: 70px; font-weight: 700;">Pulse</span><select class="input ring" style="max-width: 220px;"><option value="Karen">Karen (en-AU)</option><option value="Rocko">Rocko (en-GB)</option><option value="Shelley">Shelley (en-GB)</option><option value="Daniel">Daniel (en-GB)</option><option value="Grandma">Grandma (en-GB)</option><option value="Grandpa">Grandpa (en-GB)</option><option value="Flo">Flo (en-GB)</option><option value="Eddy">Eddy (en-GB)</option><option value="Reed">Reed (en-GB)</option><option value="Sandy">Sandy (en-GB)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Flo">Flo (en-US)</option><option value="Bahh">Bahh (en-US)</option><option value="Albert">Albert (en-US)</option><option value="Fred">Fred (en-US)</option><option value="Jester">Jester (en-US)</option><option value="Organ">Organ (en-US)</option><option value="Cellos">Cellos (en-US)</option><option value="Zarvox">Zarvox (en-US)</option><option value="Rocko">Rocko (en-US)</option><option value="Shelley">Shelley (en-US)</option><option value="Superstar">Superstar (en-US)</option><option value="Grandma">Grandma (en-US)</option><option value="Eddy">Eddy (en-US)</option><option value="Bells">Bells (en-US)</option><option value="Grandpa">Grandpa (en-US)</option><option value="Trinoids">Trinoids (en-US)</option><option value="Kathy">Kathy (en-US)</option><option value="Reed">Reed (en-US)</option><option value="Boing">Boing (en-US)</option><option value="Whisper">Whisper (en-US)</option><option value="Good News">Good News (en-US)</option><option value="Wobble">Wobble (en-US)</option><option value="Bad News">Bad News (en-US)</option><option value="Bolhas">Bolhas (en-US)</option><option value="Samantha">Samantha (en-US)</option><option value="Sandy">Sandy (en-US)</option><option value="Junior">Junior (en-US)</option><option value="Ralph">Ralph (en-US)</option><option value="Tessa">Tessa (en-ZA)</option><option value="Reed">Reed (pt-BR)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Shelley">Shelley (pt-BR)</option><option value="Grandma">Grandma (pt-BR)</option><option value="Grandpa">Grandpa (pt-BR)</option><option value="Rocko">Rocko (pt-BR)</option><option value="Flo">Flo (pt-BR)</option><option value="Sandy">Sandy (pt-BR)</option><option value="Eddy">Eddy (pt-BR)</option><option value="Joana">Joana (pt-PT)</option><option value="Daniel">Daniel (en-GB)</option><option value="Samantha">Samantha (en-US)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Karen">Karen (en-AU)</option><option value="Joana">Joana (pt-PT)</option><option value="Tessa">Tessa (en-ZA)</option></select><button class="btn fx-trans fx-press ring">Teste<span class="ripple"></span></button></div><div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;"><span style="min-width: 70px; font-weight: 700;">Artemis</span><select class="input ring" style="max-width: 220px;"><option value="Karen">Karen (en-AU)</option><option value="Rocko">Rocko (en-GB)</option><option value="Shelley">Shelley (en-GB)</option><option value="Daniel">Daniel (en-GB)</option><option value="Grandma">Grandma (en-GB)</option><option value="Grandpa">Grandpa (en-GB)</option><option value="Flo">Flo (en-GB)</option><option value="Eddy">Eddy (en-GB)</option><option value="Reed">Reed (en-GB)</option><option value="Sandy">Sandy (en-GB)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Flo">Flo (en-US)</option><option value="Bahh">Bahh (en-US)</option><option value="Albert">Albert (en-US)</option><option value="Fred">Fred (en-US)</option><option value="Jester">Jester (en-US)</option><option value="Organ">Organ (en-US)</option><option value="Cellos">Cellos (en-US)</option><option value="Zarvox">Zarvox (en-US)</option><option value="Rocko">Rocko (en-US)</option><option value="Shelley">Shelley (en-US)</option><option value="Superstar">Superstar (en-US)</option><option value="Grandma">Grandma (en-US)</option><option value="Eddy">Eddy (en-US)</option><option value="Bells">Bells (en-US)</option><option value="Grandpa">Grandpa (en-US)</option><option value="Trinoids">Trinoids (en-US)</option><option value="Kathy">Kathy (en-US)</option><option value="Reed">Reed (en-US)</option><option value="Boing">Boing (en-US)</option><option value="Whisper">Whisper (en-US)</option><option value="Good News">Good News (en-US)</option><option value="Wobble">Wobble (en-US)</option><option value="Bad News">Bad News (en-US)</option><option value="Bolhas">Bolhas (en-US)</option><option value="Samantha">Samantha (en-US)</option><option value="Sandy">Sandy (en-US)</option><option value="Junior">Junior (en-US)</option><option value="Ralph">Ralph (en-US)</option><option value="Tessa">Tessa (en-ZA)</option><option value="Reed">Reed (pt-BR)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Shelley">Shelley (pt-BR)</option><option value="Grandma">Grandma (pt-BR)</option><option value="Grandpa">Grandpa (pt-BR)</option><option value="Rocko">Rocko (pt-BR)</option><option value="Flo">Flo (pt-BR)</option><option value="Sandy">Sandy (pt-BR)</option><option value="Eddy">Eddy (pt-BR)</option><option value="Joana">Joana (pt-PT)</option><option value="Daniel">Daniel (en-GB)</option><option value="Samantha">Samantha (en-US)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Karen">Karen (en-AU)</option><option value="Joana">Joana (pt-PT)</option><option value="Tessa">Tessa (en-ZA)</option></select><button class="btn fx-trans fx-press ring">Teste<span class="ripple"></span></button></div><div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;"><span style="min-width: 70px; font-weight: 700;">Serena</span><select class="input ring" style="max-width: 220px;"><option value="Karen">Karen (en-AU)</option><option value="Rocko">Rocko (en-GB)</option><option value="Shelley">Shelley (en-GB)</option><option value="Daniel">Daniel (en-GB)</option><option value="Grandma">Grandma (en-GB)</option><option value="Grandpa">Grandpa (en-GB)</option><option value="Flo">Flo (en-GB)</option><option value="Eddy">Eddy (en-GB)</option><option value="Reed">Reed (en-GB)</option><option value="Sandy">Sandy (en-GB)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Flo">Flo (en-US)</option><option value="Bahh">Bahh (en-US)</option><option value="Albert">Albert (en-US)</option><option value="Fred">Fred (en-US)</option><option value="Jester">Jester (en-US)</option><option value="Organ">Organ (en-US)</option><option value="Cellos">Cellos (en-US)</option><option value="Zarvox">Zarvox (en-US)</option><option value="Rocko">Rocko (en-US)</option><option value="Shelley">Shelley (en-US)</option><option value="Superstar">Superstar (en-US)</option><option value="Grandma">Grandma (en-US)</option><option value="Eddy">Eddy (en-US)</option><option value="Bells">Bells (en-US)</option><option value="Grandpa">Grandpa (en-US)</option><option value="Trinoids">Trinoids (en-US)</option><option value="Kathy">Kathy (en-US)</option><option value="Reed">Reed (en-US)</option><option value="Boing">Boing (en-US)</option><option value="Whisper">Whisper (en-US)</option><option value="Good News">Good News (en-US)</option><option value="Wobble">Wobble (en-US)</option><option value="Bad News">Bad News (en-US)</option><option value="Bolhas">Bolhas (en-US)</option><option value="Samantha">Samantha (en-US)</option><option value="Sandy">Sandy (en-US)</option><option value="Junior">Junior (en-US)</option><option value="Ralph">Ralph (en-US)</option><option value="Tessa">Tessa (en-ZA)</option><option value="Reed">Reed (pt-BR)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Shelley">Shelley (pt-BR)</option><option value="Grandma">Grandma (pt-BR)</option><option value="Grandpa">Grandpa (pt-BR)</option><option value="Rocko">Rocko (pt-BR)</option><option value="Flo">Flo (pt-BR)</option><option value="Sandy">Sandy (pt-BR)</option><option value="Eddy">Eddy (pt-BR)</option><option value="Joana">Joana (pt-PT)</option><option value="Daniel">Daniel (en-GB)</option><option value="Samantha">Samantha (en-US)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Karen">Karen (en-AU)</option><option value="Joana">Joana (pt-PT)</option><option value="Tessa">Tessa (en-ZA)</option></select><button class="btn fx-trans fx-press ring">Teste<span class="ripple"></span></button></div><div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;"><span style="min-width: 70px; font-weight: 700;">Kaos</span><select class="input ring" style="max-width: 220px;"><option value="Karen">Karen (en-AU)</option><option value="Rocko">Rocko (en-GB)</option><option value="Shelley">Shelley (en-GB)</option><option value="Daniel">Daniel (en-GB)</option><option value="Grandma">Grandma (en-GB)</option><option value="Grandpa">Grandpa (en-GB)</option><option value="Flo">Flo (en-GB)</option><option value="Eddy">Eddy (en-GB)</option><option value="Reed">Reed (en-GB)</option><option value="Sandy">Sandy (en-GB)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Flo">Flo (en-US)</option><option value="Bahh">Bahh (en-US)</option><option value="Albert">Albert (en-US)</option><option value="Fred">Fred (en-US)</option><option value="Jester">Jester (en-US)</option><option value="Organ">Organ (en-US)</option><option value="Cellos">Cellos (en-US)</option><option value="Zarvox">Zarvox (en-US)</option><option value="Rocko">Rocko (en-US)</option><option value="Shelley">Shelley (en-US)</option><option value="Superstar">Superstar (en-US)</option><option value="Grandma">Grandma (en-US)</option><option value="Eddy">Eddy (en-US)</option><option value="Bells">Bells (en-US)</option><option value="Grandpa">Grandpa (en-US)</option><option value="Trinoids">Trinoids (en-US)</option><option value="Kathy">Kathy (en-US)</option><option value="Reed">Reed (en-US)</option><option value="Boing">Boing (en-US)</option><option value="Whisper">Whisper (en-US)</option><option value="Good News">Good News (en-US)</option><option value="Wobble">Wobble (en-US)</option><option value="Bad News">Bad News (en-US)</option><option value="Bolhas">Bolhas (en-US)</option><option value="Samantha">Samantha (en-US)</option><option value="Sandy">Sandy (en-US)</option><option value="Junior">Junior (en-US)</option><option value="Ralph">Ralph (en-US)</option><option value="Tessa">Tessa (en-ZA)</option><option value="Reed">Reed (pt-BR)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Shelley">Shelley (pt-BR)</option><option value="Grandma">Grandma (pt-BR)</option><option value="Grandpa">Grandpa (pt-BR)</option><option value="Rocko">Rocko (pt-BR)</option><option value="Flo">Flo (pt-BR)</option><option value="Sandy">Sandy (pt-BR)</option><option value="Eddy">Eddy (pt-BR)</option><option value="Joana">Joana (pt-PT)</option><option value="Daniel">Daniel (en-GB)</option><option value="Samantha">Samantha (en-US)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Karen">Karen (en-AU)</option><option value="Joana">Joana (pt-PT)</option><option value="Tessa">Tessa (en-ZA)</option></select><button class="btn fx-trans fx-press ring">Teste<span class="ripple"></span></button></div><div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;"><span style="min-width: 70px; font-weight: 700;">Genus</span><select class="input ring" style="max-width: 220px;"><option value="Karen">Karen (en-AU)</option><option value="Rocko">Rocko (en-GB)</option><option value="Shelley">Shelley (en-GB)</option><option value="Daniel">Daniel (en-GB)</option><option value="Grandma">Grandma (en-GB)</option><option value="Grandpa">Grandpa (en-GB)</option><option value="Flo">Flo (en-GB)</option><option value="Eddy">Eddy (en-GB)</option><option value="Reed">Reed (en-GB)</option><option value="Sandy">Sandy (en-GB)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Flo">Flo (en-US)</option><option value="Bahh">Bahh (en-US)</option><option value="Albert">Albert (en-US)</option><option value="Fred">Fred (en-US)</option><option value="Jester">Jester (en-US)</option><option value="Organ">Organ (en-US)</option><option value="Cellos">Cellos (en-US)</option><option value="Zarvox">Zarvox (en-US)</option><option value="Rocko">Rocko (en-US)</option><option value="Shelley">Shelley (en-US)</option><option value="Superstar">Superstar (en-US)</option><option value="Grandma">Grandma (en-US)</option><option value="Eddy">Eddy (en-US)</option><option value="Bells">Bells (en-US)</option><option value="Grandpa">Grandpa (en-US)</option><option value="Trinoids">Trinoids (en-US)</option><option value="Kathy">Kathy (en-US)</option><option value="Reed">Reed (en-US)</option><option value="Boing">Boing (en-US)</option><option value="Whisper">Whisper (en-US)</option><option value="Good News">Good News (en-US)</option><option value="Wobble">Wobble (en-US)</option><option value="Bad News">Bad News (en-US)</option><option value="Bolhas">Bolhas (en-US)</option><option value="Samantha">Samantha (en-US)</option><option value="Sandy">Sandy (en-US)</option><option value="Junior">Junior (en-US)</option><option value="Ralph">Ralph (en-US)</option><option value="Tessa">Tessa (en-ZA)</option><option value="Reed">Reed (pt-BR)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Shelley">Shelley (pt-BR)</option><option value="Grandma">Grandma (pt-BR)</option><option value="Grandpa">Grandpa (pt-BR)</option><option value="Rocko">Rocko (pt-BR)</option><option value="Flo">Flo (pt-BR)</option><option value="Sandy">Sandy (pt-BR)</option><option value="Eddy">Eddy (pt-BR)</option><option value="Joana">Joana (pt-PT)</option><option value="Daniel">Daniel (en-GB)</option><option value="Samantha">Samantha (en-US)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Karen">Karen (en-AU)</option><option value="Joana">Joana (pt-PT)</option><option value="Tessa">Tessa (en-ZA)</option></select><button class="btn fx-trans fx-press ring">Teste<span class="ripple"></span></button></div><div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;"><span style="min-width: 70px; font-weight: 700;">Lumine</span><select class="input ring" style="max-width: 220px;"><option value="Karen">Karen (en-AU)</option><option value="Rocko">Rocko (en-GB)</option><option value="Shelley">Shelley (en-GB)</option><option value="Daniel">Daniel (en-GB)</option><option value="Grandma">Grandma (en-GB)</option><option value="Grandpa">Grandpa (en-GB)</option><option value="Flo">Flo (en-GB)</option><option value="Eddy">Eddy (en-GB)</option><option value="Reed">Reed (en-GB)</option><option value="Sandy">Sandy (en-GB)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Flo">Flo (en-US)</option><option value="Bahh">Bahh (en-US)</option><option value="Albert">Albert (en-US)</option><option value="Fred">Fred (en-US)</option><option value="Jester">Jester (en-US)</option><option value="Organ">Organ (en-US)</option><option value="Cellos">Cellos (en-US)</option><option value="Zarvox">Zarvox (en-US)</option><option value="Rocko">Rocko (en-US)</option><option value="Shelley">Shelley (en-US)</option><option value="Superstar">Superstar (en-US)</option><option value="Grandma">Grandma (en-US)</option><option value="Eddy">Eddy (en-US)</option><option value="Bells">Bells (en-US)</option><option value="Grandpa">Grandpa (en-US)</option><option value="Trinoids">Trinoids (en-US)</option><option value="Kathy">Kathy (en-US)</option><option value="Reed">Reed (en-US)</option><option value="Boing">Boing (en-US)</option><option value="Whisper">Whisper (en-US)</option><option value="Good News">Good News (en-US)</option><option value="Wobble">Wobble (en-US)</option><option value="Bad News">Bad News (en-US)</option><option value="Bolhas">Bolhas (en-US)</option><option value="Samantha">Samantha (en-US)</option><option value="Sandy">Sandy (en-US)</option><option value="Junior">Junior (en-US)</option><option value="Ralph">Ralph (en-US)</option><option value="Tessa">Tessa (en-ZA)</option><option value="Reed">Reed (pt-BR)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Shelley">Shelley (pt-BR)</option><option value="Grandma">Grandma (pt-BR)</option><option value="Grandpa">Grandpa (pt-BR)</option><option value="Rocko">Rocko (pt-BR)</option><option value="Flo">Flo (pt-BR)</option><option value="Sandy">Sandy (pt-BR)</option><option value="Eddy">Eddy (pt-BR)</option><option value="Joana">Joana (pt-PT)</option><option value="Daniel">Daniel (en-GB)</option><option value="Samantha">Samantha (en-US)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Karen">Karen (en-AU)</option><option value="Joana">Joana (pt-PT)</option><option value="Tessa">Tessa (en-ZA)</option></select><button class="btn fx-trans fx-press ring">Teste<span class="ripple"></span></button></div><div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;"><span style="min-width: 70px; font-weight: 700;">Rhea</span><select class="input ring" style="max-width: 220px;"><option value="Karen">Karen (en-AU)</option><option value="Rocko">Rocko (en-GB)</option><option value="Shelley">Shelley (en-GB)</option><option value="Daniel">Daniel (en-GB)</option><option value="Grandma">Grandma (en-GB)</option><option value="Grandpa">Grandpa (en-GB)</option><option value="Flo">Flo (en-GB)</option><option value="Eddy">Eddy (en-GB)</option><option value="Reed">Reed (en-GB)</option><option value="Sandy">Sandy (en-GB)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Flo">Flo (en-US)</option><option value="Bahh">Bahh (en-US)</option><option value="Albert">Albert (en-US)</option><option value="Fred">Fred (en-US)</option><option value="Jester">Jester (en-US)</option><option value="Organ">Organ (en-US)</option><option value="Cellos">Cellos (en-US)</option><option value="Zarvox">Zarvox (en-US)</option><option value="Rocko">Rocko (en-US)</option><option value="Shelley">Shelley (en-US)</option><option value="Superstar">Superstar (en-US)</option><option value="Grandma">Grandma (en-US)</option><option value="Eddy">Eddy (en-US)</option><option value="Bells">Bells (en-US)</option><option value="Grandpa">Grandpa (en-US)</option><option value="Trinoids">Trinoids (en-US)</option><option value="Kathy">Kathy (en-US)</option><option value="Reed">Reed (en-US)</option><option value="Boing">Boing (en-US)</option><option value="Whisper">Whisper (en-US)</option><option value="Good News">Good News (en-US)</option><option value="Wobble">Wobble (en-US)</option><option value="Bad News">Bad News (en-US)</option><option value="Bolhas">Bolhas (en-US)</option><option value="Samantha">Samantha (en-US)</option><option value="Sandy">Sandy (en-US)</option><option value="Junior">Junior (en-US)</option><option value="Ralph">Ralph (en-US)</option><option value="Tessa">Tessa (en-ZA)</option><option value="Reed">Reed (pt-BR)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Shelley">Shelley (pt-BR)</option><option value="Grandma">Grandma (pt-BR)</option><option value="Grandpa">Grandpa (pt-BR)</option><option value="Rocko">Rocko (pt-BR)</option><option value="Flo">Flo (pt-BR)</option><option value="Sandy">Sandy (pt-BR)</option><option value="Eddy">Eddy (pt-BR)</option><option value="Joana">Joana (pt-PT)</option><option value="Daniel">Daniel (en-GB)</option><option value="Samantha">Samantha (en-US)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Karen">Karen (en-AU)</option><option value="Joana">Joana (pt-PT)</option><option value="Tessa">Tessa (en-ZA)</option></select><button class="btn fx-trans fx-press ring">Teste<span class="ripple"></span></button></div><div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;"><span style="min-width: 70px; font-weight: 700;">Solus</span><select class="input ring" style="max-width: 220px;"><option value="Karen">Karen (en-AU)</option><option value="Rocko">Rocko (en-GB)</option><option value="Shelley">Shelley (en-GB)</option><option value="Daniel">Daniel (en-GB)</option><option value="Grandma">Grandma (en-GB)</option><option value="Grandpa">Grandpa (en-GB)</option><option value="Flo">Flo (en-GB)</option><option value="Eddy">Eddy (en-GB)</option><option value="Reed">Reed (en-GB)</option><option value="Sandy">Sandy (en-GB)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Flo">Flo (en-US)</option><option value="Bahh">Bahh (en-US)</option><option value="Albert">Albert (en-US)</option><option value="Fred">Fred (en-US)</option><option value="Jester">Jester (en-US)</option><option value="Organ">Organ (en-US)</option><option value="Cellos">Cellos (en-US)</option><option value="Zarvox">Zarvox (en-US)</option><option value="Rocko">Rocko (en-US)</option><option value="Shelley">Shelley (en-US)</option><option value="Superstar">Superstar (en-US)</option><option value="Grandma">Grandma (en-US)</option><option value="Eddy">Eddy (en-US)</option><option value="Bells">Bells (en-US)</option><option value="Grandpa">Grandpa (en-US)</option><option value="Trinoids">Trinoids (en-US)</option><option value="Kathy">Kathy (en-US)</option><option value="Reed">Reed (en-US)</option><option value="Boing">Boing (en-US)</option><option value="Whisper">Whisper (en-US)</option><option value="Good News">Good News (en-US)</option><option value="Wobble">Wobble (en-US)</option><option value="Bad News">Bad News (en-US)</option><option value="Bolhas">Bolhas (en-US)</option><option value="Samantha">Samantha (en-US)</option><option value="Sandy">Sandy (en-US)</option><option value="Junior">Junior (en-US)</option><option value="Ralph">Ralph (en-US)</option><option value="Tessa">Tessa (en-ZA)</option><option value="Reed">Reed (pt-BR)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Shelley">Shelley (pt-BR)</option><option value="Grandma">Grandma (pt-BR)</option><option value="Grandpa">Grandpa (pt-BR)</option><option value="Rocko">Rocko (pt-BR)</option><option value="Flo">Flo (pt-BR)</option><option value="Sandy">Sandy (pt-BR)</option><option value="Eddy">Eddy (pt-BR)</option><option value="Joana">Joana (pt-PT)</option><option value="Daniel">Daniel (en-GB)</option><option value="Samantha">Samantha (en-US)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Karen">Karen (en-AU)</option><option value="Joana">Joana (pt-PT)</option><option value="Tessa">Tessa (en-ZA)</option></select><button class="btn fx-trans fx-press ring">Teste<span class="ripple"></span></button></div><div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;"><span style="min-width: 70px; font-weight: 700;">Aion</span><select class="input ring" style="max-width: 220px;"><option value="Karen">Karen (en-AU)</option><option value="Rocko">Rocko (en-GB)</option><option value="Shelley">Shelley (en-GB)</option><option value="Daniel">Daniel (en-GB)</option><option value="Grandma">Grandma (en-GB)</option><option value="Grandpa">Grandpa (en-GB)</option><option value="Flo">Flo (en-GB)</option><option value="Eddy">Eddy (en-GB)</option><option value="Reed">Reed (en-GB)</option><option value="Sandy">Sandy (en-GB)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Flo">Flo (en-US)</option><option value="Bahh">Bahh (en-US)</option><option value="Albert">Albert (en-US)</option><option value="Fred">Fred (en-US)</option><option value="Jester">Jester (en-US)</option><option value="Organ">Organ (en-US)</option><option value="Cellos">Cellos (en-US)</option><option value="Zarvox">Zarvox (en-US)</option><option value="Rocko">Rocko (en-US)</option><option value="Shelley">Shelley (en-US)</option><option value="Superstar">Superstar (en-US)</option><option value="Grandma">Grandma (en-US)</option><option value="Eddy">Eddy (en-US)</option><option value="Bells">Bells (en-US)</option><option value="Grandpa">Grandpa (en-US)</option><option value="Trinoids">Trinoids (en-US)</option><option value="Kathy">Kathy (en-US)</option><option value="Reed">Reed (en-US)</option><option value="Boing">Boing (en-US)</option><option value="Whisper">Whisper (en-US)</option><option value="Good News">Good News (en-US)</option><option value="Wobble">Wobble (en-US)</option><option value="Bad News">Bad News (en-US)</option><option value="Bolhas">Bolhas (en-US)</option><option value="Samantha">Samantha (en-US)</option><option value="Sandy">Sandy (en-US)</option><option value="Junior">Junior (en-US)</option><option value="Ralph">Ralph (en-US)</option><option value="Tessa">Tessa (en-ZA)</option><option value="Reed">Reed (pt-BR)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Shelley">Shelley (pt-BR)</option><option value="Grandma">Grandma (pt-BR)</option><option value="Grandpa">Grandpa (pt-BR)</option><option value="Rocko">Rocko (pt-BR)</option><option value="Flo">Flo (pt-BR)</option><option value="Sandy">Sandy (pt-BR)</option><option value="Eddy">Eddy (pt-BR)</option><option value="Joana">Joana (pt-PT)</option><option value="Daniel">Daniel (en-GB)</option><option value="Samantha">Samantha (en-US)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Karen">Karen (en-AU)</option><option value="Joana">Joana (pt-PT)</option><option value="Tessa">Tessa (en-ZA)</option></select><button class="btn fx-trans fx-press ring">Teste<span class="ripple"></span></button></div></div>

          <!-- Preferências de Performance -->
          <div class="card fx-trans fx-lift" style="display:block">
            <div style="font-weight:800">Performance</div>
            <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
              <select id="selPerf" class="input ring" style="max-width:200px">
                <option value="low">Low</option>
                <option value="med">Med</option>
                <option value="high">High</option>
              </select>
              <button id="btnPerf" class="btn fx-trans fx-press ring">Aplicar<span class="ripple"></span></button>
            </div>
          </div>

          <!-- Preferências de Voz -->
          <div class="card fx-trans fx-lift" style="display:block">
            <div style="font-weight:800">Voz</div>
            <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
              <select id="selVoice" class="input ring" style="max-width:200px">
                <option>Nova</option>
                <option>Elysha</option>
                <option>Kaion</option>
                <option>Serena</option>
              </select>
              <button id="btnVoice" class="btn fx-trans fx-press ring">Salvar<span class="ripple"></span></button>
            </div>
          </div>

          <!-- Logs -->
          <div class="card fx-trans fx-lift" style="display:block">
            <div style="font-weight:800">Logs</div>
            <div class="mut" style="font-size:11px;margin-bottom:4px">Eventos recentes</div>
            <pre id="logs" style="margin:0;font:12px/1.4 ui-monospace,monospace;color:var(--mut);max-height:140px;overflow:auto"></pre>
          </div>
          </div>
      </div>
    </section>

    <!-- CHAT (Dual • Chat) -->
    <section id="v-chat" class="view">
      <!-- Feed de mensagens do chat -->
      <div id="chatFeed"><div class="msg user">Você: Essa versão tá daora</div><div class="msg user">Você: Essa versão tá daora</div><div class="msg user">Você: Essa versão tá daora</div><div class="msg user">Você: Dual e aí beleza como está</div><div class="msg user">Você: Dual e aí beleza como está</div><div class="msg user">Você: Dual e aí beleza como está</div><div class="msg user">Você: E aí alô</div><div class="msg user">Você: E aí alô</div><div class="msg user">Você: E aí alô</div><div class="msg user">Você: E aí beleza</div><div class="msg user">Você: E aí beleza</div><div class="msg user">Você: E aí beleza</div><div class="msg user">Você: Essa versão tá daora</div><div class="msg user">Você: Essa versão tá daora</div><div class="msg user">Você: Essa versão tá daora</div><div class="msg user">Você: Dual e aí beleza como está</div><div class="msg user">Você: Dual e aí beleza como está</div><div class="msg user">Você: Dual e aí beleza como está</div><div class="msg user">Você: E aí alô</div><div class="msg user">Você: E aí alô</div><div class="msg user">Você: E aí alô</div><div class="msg user">Você: E aí beleza</div><div class="msg user">Você: E aí beleza</div><div class="msg user">Você: E aí beleza</div></div>
    </section>
  </main>

  <!-- DOCK & TABS -->
  <div id="dock" class="dock"></div>
  <nav class="tabbar">
    <div class="inner">
      <button class="tab fx-trans fx-press ring" data-nav="home">
<img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/house.svg" alt="Home" width="18" height="18" onerror="this.onerror=null;this.src='icons/house.svg'">
        <span style="display:none">Home</span><span class="ripple"></span>
      </button>
      <button class="tab fx-trans fx-press ring" data-nav="apps">
<img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/folder-open.svg" alt="Apps" width="18" height="18" onerror="this.onerror=null;this.src='icons/folder-open.svg'">
        <span style="display:none">Apps</span><span class="ripple"></span>
      </button>
      <button class="tab fx-trans fx-press ring" data-nav="stack">
<img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/layer-group.svg" alt="Stack" width="18" height="18" onerror="this.onerror=null;this.src='icons/layer-group.svg'">
        <span style="display:none">Stack</span><span class="ripple"></span>
      </button>
      <button class="tab fx-trans fx-press ring active" data-nav="brain">
<img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/brain.svg" alt="Brain" width="18" height="18" onerror="this.onerror=null;this.src='icons/brain.svg'">
        <span style="display:none">Brain</span><span class="ripple"></span>
      </button>
      <!-- Botão da nova aba Chat -->
      <button class="tab fx-trans fx-press ring" data-nav="chat">
<img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/comments.svg" alt="Chat" width="18" height="18" onerror="this.onerror=null;this.src='icons/comments.svg'">
        <span style="display:none">Chat</span><span class="ripple"></span>
      </button>
    </div>
  </nav>
  <!-- Preview da última mensagem recebida (aparece na home e leva ao chat) -->
  <div id="msgPreview" style="display: none;"></div>

  <!-- Controles de texto e voz empilhados acima da barra de navegação -->
  <div id="homeButtons" class="home-btns">
    <button id="homeTextBtn" class="home-btn">
      <img src="icons/pen-to-square.svg" alt="Texto" width="20" height="20" onerror="this.onerror=null;this.src='icons/pen-to-square.svg'">
    <span class="ripple"></span></button>
    <button id="homeVoiceBtn" class="home-btn">
      <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/microphone.svg" alt="Voz" width="20" height="20" onerror="this.onerror=null;this.src='icons/microphone.svg'">
    <span class="ripple"></span></button>
  </div>
  <!-- Overlay de input para envio rápido de mensagens na Home -->
  <div id="homeInputOverlay">
    <form id="homeInputForm" autocomplete="off">
      <input id="homeInput" type="text" placeholder="Escreva aqui…" autocomplete="off">
      <button type="submit">
        <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/paper-plane.svg" alt="Enviar" width="18" height="18" onerror="this.onerror=null;this.src='icons/paper-plane.svg'">
      <span class="ripple"></span></button>
    </form>
  </div>

  <!-- HELP MODAL -->
  <div id="modalHelp" class="modal" aria-hidden="true">
    <div class="panel">
      <div style="display:flex;align-items:center;gap:10px;justify-content:space-between">
        <h3 style="margin:0">Ajuda &amp; Atalhos</h3>
        <button id="closeHelp" class="btn fx-trans fx-press ring">Fechar<span class="ripple"></span></button>
      </div>
      <div class="mut" style="margin-top:8px">Navegue mais rápido:</div>
      <ul>
        <li><span class="kbd">g</span> then <span class="kbd">h</span> → Home</li>
        <li><span class="kbd">g</span> then <span class="kbd">a</span> → Apps</li>
        <li><span class="kbd">g</span> then <span class="kbd">s</span> → Stack</li>
        <li><span class="kbd">g</span> then <span class="kbd">b</span> → Brain</li>
        <li><span class="kbd">g</span> then <span class="kbd">r</span> → Chat</li>
        <li><span class="kbd">Ctrl / Cmd</span> + <span class="kbd">K</span> → Busca</li>
        <li><span class="kbd">Ctrl / Cmd</span> + <span class="kbd">S</span> → Baixar este HTML</li>
      </ul>
    </div>
  </div>

  <!-- ===== Catálogo Embutido (Monólito) ===== -->
  <script id="APPS_JSON" type="application/json">
  {
    "apps": [
      {"key":"atlas","title":"Atlas · Cartesius","desc":"Planejador estratégico com cronogramas e checklists.","url":"about:blank","icon":"atlas"},
      {"key":"nova","title":"Nova · Inspira","desc":"Criativa que desbloqueia ideias com mapas mentais e exercícios.","url":"about:blank","icon":"nova"},
      {"key":"vitalis","title":"Vitalis · Momentum","desc":"Rotinas físicas, hacks biológicos e motivação.","url":"about:blank","icon":"vitalis"},
      {"key":"pulse","title":"Pulse · Resona","desc":"Trilhas sonoras e ajuste de som emocional.","url":"about:blank","icon":"pulse"},
      {"key":"artemis","title":"Artemis · Naviga","desc":"Explora conhecimentos e rotas de aprendizado.","url":"about:blank","icon":"artemis"},
      {"key":"serena","title":"Serena · Ampara","desc":"Acolhimento e suporte emocional.","url":"about:blank","icon":"serena"},
      {"key":"kaos","title":"Kaos · Disruptor","desc":"Questiona padrões e propõe soluções ousadas.","url":"about:blank","icon":"kaos"},
      {"key":"genus","title":"Genus · Fabricus","desc":"Protótipos e materialização de ideias.","url":"about:blank","icon":"genus"},
      {"key":"lumine","title":"Lumine · Brilhare","desc":"Inspiração leve e atividades lúdicas.","url":"about:blank","icon":"lumine"},
      {"key":"rhea","title":"Rhea · Raízes","desc":"Vínculos e memórias emocionais.","url":"about:blank","icon":"rhea"},
      {"key":"solus","title":"Solus · Arcana","desc":"Harmonização energética e meditação.","url":"about:blank","icon":"solus"},
      {"key":"aion","title":"Aion · Evolutia","desc":"Microações estratégicas e evolução.","url":"about:blank","icon":"aion"}
    ]
  }
  </script>

  <script>
  // Redefine the global toast function to suppress popup messages. If you
  // later decide to re-enable notifications, remove or comment out this line.
  window.toast = function(){};
    /* ===================== Helpers ===================== */
    const $ = (q, r = document) => r.querySelector(q);
    const $$ = (q, r = document) => Array.from(r.querySelectorAll(q));
    const LS = {
      get: (k, d) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d } catch (e) { return d } },
      set: (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)) } catch (e) {} },
      raw: (k) => localStorage.getItem(k) || ''
    };

    /* ===================== DualHub State & Logging ===================== */
    // Armazena preferências de performance, voz e registros de eventos para a funcionalidade "Dual" aprimorada.
    const dualState = {
      perf: localStorage.getItem('hub.perf') || 'med',
      voice: localStorage.getItem('hub.voice') || 'Nova',
      logs: []
    };
    // Adiciona uma entrada ao log e atualiza o painel de logs no Brain.
    function dualLog(msg) {
      const entry = '[' + new Date().toLocaleTimeString() + '] ' + msg;
      dualState.logs.unshift(entry);
      const logsEl = document.getElementById('logs');
      if (logsEl) logsEl.textContent = dualState.logs.slice(0, 60).join('\n');
    }

    /* Ripple */
    function addRipple(el) {
      if (!el) return;
      // Ensure a ripple host exists on the element. The global ripple handler will create dots on pointerdown.
      if (!el.querySelector('.ripple')) {
        const slot = document.createElement('span');
        slot.className = 'ripple';
        el.appendChild(slot);
      }
      // Do not attach individual pointerdown events here; ripple will be handled globally.
    }

    /* Toast */
    const toastBox = document.createElement('div');
    toastBox.style.cssText = 'position:fixed;right:14px;bottom:calc(var(--tabsH) + 16px);display:grid;gap:8px;z-index:120';
    document.body.appendChild(toastBox);
    function toast(msg, type = 'ok') {
      const el = document.createElement('div'); el.className = 'fx-trans';
      const bg = type === 'ok' ? 'linear-gradient(90deg,#1b2a2a,#123c2e)' : (type === 'warn' ? 'linear-gradient(90deg,#2f261b,#3c2d12)' : 'linear-gradient(90deg,#2f1b1b,#3c1212)');
      el.style.cssText = `background:${bg}; color:var(--fg); border:${getComputedStyle(document.documentElement).getPropertyValue('--bd')}; padding:.6rem .8rem; border-radius:12px; box-shadow:var(--shadow)`;
      el.textContent = msg; toastBox.appendChild(el);
      setTimeout(() => { el.style.opacity = .0; el.style.transform = 'translateY(6px)'; setTimeout(() => el.remove(), 220); }, 1600);
    }

    /* ===================== Saudação / último estado ===================== */
    function displayGreeting() {
      const card = document.getElementById('greetingCard');
      // Não exibir o cartão de saudação; usamos mensagens na bolinha
      if (card) card.style.display = 'none';
      const name = (localStorage.getItem('infodose:userName') || '').trim();
      const sessions = document.querySelectorAll('.session').length;
      if (!name) {
        showArchMessage('Salve! Ative sua Dual Infodose registrando seu nome na seção Brain.', 'warn');
      } else {
        showArchMessage(`Bem-vindo de volta, ${name}. UNO está ao seu lado. Você tem ${sessions} sessão(ões) ativa(s).`, 'ok');
      }
    }

    /* ===================== Tema & Fundo personalizados ===================== */
    // Aplica o tema salvo no localStorage. Os temas possíveis são: 'default' (remove data-theme), 'medium'
    // e 'custom'.  Quando 'custom' estiver ativo, usa a imagem/vídeo salvo em LS ('uno:bg') como
    // plano de fundo.  Se 'medium' estiver selecionado, adiciona data-theme='medium'.
    function applyTheme() {
      const theme = LS.get('uno:theme', 'medium');
      // Limpe qualquer dataset para que CSS default seja aplicado quando 'default'
      if (theme === 'default') {
        delete document.body.dataset.theme;
      } else {
        document.body.dataset.theme = theme;
      }
      // Gerenciar fundo personalizado
      const bgContainer = document.getElementById('custom-bg');
      if (!bgContainer) return;
      if (theme !== 'custom') {
        bgContainer.innerHTML = '';
        return;
      }
      // Carregar dados do fundo
      const bgData = LS.get('uno:bg', '');
      bgContainer.innerHTML = '';
      if (!bgData) return;
      // Determine se é vídeo ou imagem
      if (/^data:video\//.test(bgData)) {
        const vid = document.createElement('video');
        vid.src = bgData;
        vid.autoplay = true;
        vid.loop = true;
        vid.muted = true;
        vid.playsInline = true;
        vid.style.width = '100%';
        vid.style.height = '100%';
        vid.style.objectFit = 'cover';
        bgContainer.appendChild(vid);
      } else {
        const img = document.createElement('img');
        img.src = bgData;
        img.alt = '';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        bgContainer.appendChild(img);
      }
    }

    /* ===================== CSS Personalizado ===================== */
    // Aplica o CSS salvo em localStorage (chave 'infodose:cssCustom')
    function applyCSS() {
      let styleEl = document.getElementById('customStyle');
      if (!styleEl) {
        styleEl = document.createElement('style');
        styleEl.id = 'customStyle';
        document.head.appendChild(styleEl);
      }
      const css = localStorage.getItem('infodose:cssCustom') || '';
      styleEl.innerHTML = css || '';
    }

    // Inicializa seleção de vozes para cada arquétipo
    function initVoices() {
      const wrap = document.getElementById('voicesWrap');
      if (!wrap) return;
      wrap.innerHTML = '';
      const archList = [
        'atlas.html',
        'nova.html',
        'vitalis.html',
        'pulse.html',
        'artemis.html',
        'serena.html',
        'kaos.html',
        'genus.html',
        'lumine.html',
        'solus.html',
        'rhea.html',
        'aion.html'
      ];
      function populateVoices() {
        let voices = speechSynthesis.getVoices();
        // Filtrar por idiomas suportados (Português e Inglês) se disponível
        const filtered = voices.filter(v => v.lang && (v.lang.startsWith('pt') || v.lang.startsWith('en')));
        voices = filtered.length ? filtered : voices;
        const saved = LS.get('infodose:voices', {}) || {};
        // Se ainda não houver vozes salvas, defina um mapeamento padrão
        if (Object.keys(saved).length === 0 && voices.length) {
          archList.forEach((name, idx) => {
            const v = voices[idx % voices.length];
            if (v) saved[name] = v.name;
          });
          LS.set('infodose:voices', saved);
        }
        archList.forEach(name => {
          const row = document.createElement('div');
          row.style.display = 'flex';
          row.style.alignItems = 'center';
          row.style.gap = '8px';
          row.style.flexWrap = 'wrap';
          const label = document.createElement('span');
          label.textContent = name;
          label.style.minWidth = '70px';
          label.style.fontWeight = '700';
          const sel = document.createElement('select');
          sel.className = 'input ring';
          sel.style.maxWidth = '220px';
          voices.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.name;
            opt.textContent = `${v.name} (${v.lang})`;
            sel.appendChild(opt);
          });
          if (saved[name]) sel.value = saved[name];
          sel.onchange = () => {
            saved[name] = sel.value;
            LS.set('infodose:voices', saved);
          };
          const btnTest = document.createElement('button');
          btnTest.className = 'btn fx-trans fx-press ring';
          btnTest.textContent = 'Teste';
          const rp = document.createElement('span'); rp.className = 'ripple'; btnTest.appendChild(rp);
          addRipple(btnTest);
          btnTest.onclick = () => {
            const utter = new SpeechSynthesisUtterance(`Olá, eu sou ${name}`);
            const voiceName = saved[name] || sel.value;
            const voice = voices.find(v => v.name === voiceName);
            if (voice) utter.voice = voice;
            speechSynthesis.cancel();
            speechSynthesis.speak(utter);
          };
          row.appendChild(label);
          row.appendChild(sel);
          row.appendChild(btnTest);
          wrap.appendChild(row);
        });
      }
      populateVoices();
      // Re-populate when voices list changes
      window.speechSynthesis.onvoiceschanged = () => populateVoices();
    }

    // Pronuncia o nome do arquétipo usando a voz selecionada
    function speakArchetype(name) {
      try {
        const archName = name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();
        const saved = LS.get('infodose:voices', {});
        const voices = speechSynthesis.getVoices();
        let voice = null;
        if (saved && saved[archName]) {
          voice = voices.find(v => v.name === saved[archName]);
        }
        if (!voice) {
          voice = voices.find(v => v.lang && (v.lang.startsWith('pt') || v.lang.startsWith('en')));
        }
        if (!voice && voices.length) voice = voices[0];
        if (!voice) return;
        const utter = new SpeechSynthesisUtterance(`Olá, eu sou ${archName}`);
        utter.voice = voice;
        speechSynthesis.cancel();
        speechSynthesis.speak(utter);
      } catch (e) {}
    }

    // Fala um texto usando a voz associada ao arquétipo atualmente ativo.  Utiliza a lista
    // de vozes do Speech Synthesis e o mapeamento salvo em LS para encontrar a voz
    // correta. Se não houver voz definida, escolhe a primeira disponível (PT/EN).
    function speakWithActiveArch(text) {
      try {
        const select = document.getElementById('arch-select');
        let archFile = select ? select.value || '' : '';
        let base = archFile.replace(/\.html$/i, '');
        const key = base.charAt(0).toUpperCase() + base.slice(1).toLowerCase();
        const saved = LS.get('infodose:voices', {}) || {};
        const voices = speechSynthesis.getVoices();
        let voice = null;
        if (saved[key]) {
          voice = voices.find(v => v.name === saved[key]);
        }
        if (!voice) {
          voice = voices.find(v => v.lang && (v.lang.startsWith('pt') || v.lang.startsWith('en')));
        }
        if (!voice && voices.length) voice = voices[0];
        if (!voice) return;
        const utter = new SpeechSynthesisUtterance(text);
        utter.voice = voice;
        speechSynthesis.cancel();
        speechSynthesis.speak(utter);
      } catch (e) {}
    }

    // Exibe uma mensagem dentro do círculo do arquétipo. A mensagem desaparece após alguns segundos.
    function showArchMessage(text, type = 'info') {
      try {
        const el = document.getElementById('archMsg');
        if (!el) return;
        el.textContent = text;
        // Ajuste a cor de fundo conforme o tipo
        if (type === 'ok') {
          el.style.background = 'rgba(57,255,182,0.75)';
          el.style.color = '#0b0f14';
        } else if (type === 'warn') {
          el.style.background = 'rgba(255,184,107,0.78)';
          el.style.color = '#0b0f14';
        } else if (type === 'err') {
          el.style.background = 'rgba(255,107,107,0.78)';
          el.style.color = '#0b0f14';
        } else {
          el.style.background = 'rgba(15,17,32,0.72)';
          el.style.color = '';
        }
        el.classList.add('show');
        clearTimeout(el._tm);
        el._tm = setTimeout(() => {
          el.classList.remove('show');
        }, 4000);
      } catch (e) {}
    }

    // Configura o modo de ripple que responde ao áudio do microfone.  Cria um
    // analisador de áudio usando Web Audio API e ajusta a opacidade da camada
    // "audioRipple" conforme a intensidade do som capturado. Um botão
    // (arch-audio) ativa/desativa o efeito de forma discreta.
    function initAudioRipple() {
      const clickLayer = document.getElementById('audioRipple');
      const archCircleEl = document.querySelector('.arch-circle');
      if (!clickLayer || !archCircleEl) return;
      let enabled = false;
      let audioCtx = null;
      let analyser = null;
      let micStream = null;
      // Inicia a captura de áudio e animação
      async function start() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          micStream = stream;
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          const src = audioCtx.createMediaStreamSource(stream);
          analyser = audioCtx.createAnalyser();
          analyser.fftSize = 256;
          src.connect(analyser);
          animate();
        } catch (e) {
          toast('Não foi possível acessar o microfone.', 'err');
          enabled = false;
          archCircleEl.classList.remove('audio-on');
        }
      }
      // Para a captura de áudio e reseta a camada
      function stop() {
        if (micStream) {
          micStream.getTracks().forEach(t => t.stop());
          micStream = null;
        }
        if (audioCtx) {
          try { audioCtx.close(); } catch {}
          audioCtx = null;
        }
        // Remova o efeito de sombra quando desligar
        archCircleEl.style.boxShadow = '';
      }
      // Atualiza a opacidade da camada conforme o volume (RMS)
      function animate() {
        if (!enabled || !analyser) return;
        const buf = new Uint8Array(analyser.fftSize);
        analyser.getByteTimeDomainData(buf);
        let sum = 0;
        for (let i = 0; i < buf.length; i++) {
          const v = (buf[i] - 128) / 128;
          sum += v * v;
        }
        const rms = Math.sqrt(sum / buf.length);
        // Ajuste a intensidade: multiplique por um fator e limite a 0.6
        // Aplique um brilho em torno do círculo proporcional ao volume
        const intensity = Math.min(0.8, rms * 4);
        // envia nível para o iframe do arquétipo (se existir)
        try { const fr = document.getElementById('arch-frame'); if (fr && fr.contentWindow) fr.contentWindow.postMessage({ audioLevel: Math.min(1, rms*3) }, '*'); } catch (e) {}
        const blur = rms * 80;
        archCircleEl.style.boxShadow = `0 0 ${blur}px rgba(255,255,255,${intensity})`;
        requestAnimationFrame(animate);
      }
      // Clique simples no círculo inicia a interação Dual: anima a bolinha,
      // faz a saudação e inicia a captura de voz para conversar com a IA.
      clickLayer.addEventListener('click', () => {
        startDualInteraction();
      });

      // Função global para alternar o modo de visualização do áudio (ripple).  
      // Mantemos para compatibilidade com o botão de áudio no menu.
      window.toggleAudio = function () {
        enabled = !enabled;
        archCircleEl.classList.toggle('audio-on', enabled);
        if (enabled) {
          start();
        } else {
          stop();
        }
      };
    }

    // Mensagem de boas-vindas/ativação
    function welcome() {
      const name = (localStorage.getItem('infodose:userName') || '').trim();
      if (!name) {
        const msg = 'Salve! Ative sua Dual Infodose registrando seu nome na seção Brain.';
        showArchMessage(msg, 'warn');
        try { speakWithActiveArch(msg); } catch {}
      } else {
        const msg = `Bem-vindo de volta, ${name}. UNO está ao seu lado.`;
        showArchMessage(msg, 'ok');
        try { speakWithActiveArch(msg); } catch {}
      }
    }

    /* Apply ripple */
    $$('button').forEach(addRipple);
    // Move the arquétipos circle below the menu in the home view after initialization
    (function() {
      try {
        const home = document.getElementById('v-home');
        if (!home) return;
        const arch = home.querySelector('.arch-container');
        const cards = home.querySelector('.cards');
        // Se ambos existirem, garanta que as cartas apareçam depois do círculo de arquétipos.
        if (arch && cards) {
          arch.insertAdjacentElement('afterend', cards);
        }
      } catch (e) {
        console.warn('Falha ao reposicionar arquétipo:', e);
      }
    })();
    const obs = new MutationObserver((muts) => { muts.forEach(m => m.addedNodes && m.addedNodes.forEach(n => { if (n.nodeType === 1) { if (n.matches?.('button')) addRipple(n); n.querySelectorAll?.('button').forEach(addRipple); } })) });
    obs.observe(document.body, { childList: true, subtree: true });

    /* ===================== Navegação + Estado ===================== */
    function nav(key) {
      // Remapeia a antiga aba 'revo' para 'chat'
      if (key === 'revo') key = 'chat';
      // Adicionamos 'chat' à lista de abas para suportar a nova seção
      const tabs = ['home', 'apps', 'stack', 'brain', 'chat'];
      tabs.forEach(k => {
        const viewEl = document.getElementById('v-' + k);
        if (viewEl) viewEl.classList.toggle('active', k === key);
        const tabEl = document.querySelector(`.tab[data-nav="${k}"]`);
        if (tabEl) tabEl.classList.toggle('active', k === key);
      });
      LS.set('uno:lastTab', key);
      // Quando entrar na aba Home, apresente mensagem de saudação / última sessão
      if (key === 'home') {
        try { displayGreeting(); } catch (e) { console.warn(e); }
        try {
          const nameG = (localStorage.getItem('infodose:userName') || '').trim();
          if (!nameG) {
            toast('Salve! Ative sua Dual Infodose registrando seu nome na seção Brain.', 'warn');
          } else {
            // Saudação rápida na forma de toast quando o usuário retorna ao home.
            toast(`Bem-vindo de volta, ${nameG}. UNO está ao seu lado.`, 'ok');
          }
        } catch (e) {}
        // Atualize também os status quando entrar no Home
        try { updateHomeStatus(); } catch {}
      }
      // Nenhuma ação especial ao entrar na aba de chat por enquanto

      // Falar uma frase curta ao trocar de aba, usando a voz do arquétipo ativo
      try {
        let phrase = '';
        let type = 'info';
        switch (key) {
          case 'home': phrase = 'Página inicial'; break;
          case 'apps': phrase = 'Abrindo apps'; break;
          case 'stack': phrase = 'Abrindo stack'; break;
          case 'brain': phrase = 'Abrindo usuário'; break;
          case 'chat': phrase = 'Abrindo chat'; break;
          default: phrase = '';
        }
        if (phrase) {
          speakWithActiveArch(phrase);
          showArchMessage(phrase, type);
        }
        // Mostrar o preview laranja somente na Home; escondê-lo nas outras abas
        try {
          const prev = document.getElementById('msgPreview');
          if (prev) {
            prev.style.display = (key === 'home' && prev.textContent) ? 'block' : 'none';
          }
        } catch (e) { console.warn(e); }
      } catch (e) {}
    }

    // Alterna a visibilidade do menu de arquétipos.  O menu fica
    // escondido/mostrado ao clicar no círculo (toque curto).  Este
    // helper é chamado por initAudioRipple().
    function toggleArchMenu() {
      const menu = document.getElementById('archMenu');
      if (!menu) return;
      menu.classList.toggle('show');
    }

    /**
     * Inicia a interação Dual ao tocar a bolinha.  Esta função aplica uma
     * animação breve de pressão à bolinha, fala a saudação “Oi DUAL” (ou
     * outra frase definida) usando a voz do arquétipo ativo e, em seguida,
     * verifica se o usuário está conectado (nome, chave do OpenRouter e
     * modelo selecionados).  Caso esteja tudo configurado, ativa o
     * reconhecimento de voz para captar a fala do usuário e prosseguir
     * com a conversa.  Caso contrário, exibe uma mensagem orientando o
     * usuário a preencher suas configurações no Brain.
     */
    function startDualInteraction() {
      const archCircle = document.querySelector('.arch-circle');
      if (!archCircle) return;
      // Animação de clique: adiciona classe 'pressed' brevemente
      archCircle.classList.add('pressed');
      setTimeout(() => archCircle.classList.remove('pressed'), 180);
      // Saudação falada
      const greet = 'Oi Dual';
      showArchMessage(greet, 'ok');
      try { speakWithActiveArch(greet); } catch {}
      // Após a saudação, aguarde um curto intervalo antes de iniciar a verificação
      setTimeout(() => {
        const sk = localStorage.getItem('dual.keys.openrouter') || '';
        const userName = (localStorage.getItem('infodose:userName') || '').trim();
        const model = LS.get('dual.openrouter.model');
        if (!sk || !userName || !model) {
          const warn = 'Configure nome, chave e modelo no Brain para conversar.';
          showArchMessage(warn, 'warn');
          return;
        }
        // Se estiver tudo configurado, inicie o reconhecimento de voz
        startSpeechConversation(userName, sk, model);
      }, 600);
    }

    /**
     * Inicia o reconhecimento de fala via Web Speech API.  Quando o usuário
     * terminar de falar, a transcrição é encaminhada para a função de
     * manipulação de mensagens, que enviará a pergunta ao modelo de IA e
     * lidará com a resposta.
     * @param {string} userName Nome do usuário (para personalizar respostas)
     * @param {string} sk Chave da API do OpenRouter
     * @param {string} model Modelo selecionado
     */

    // Insere mensagens no feed de IA da Home. Mantém somente as últimas 10 entradas.
    function feedPush(type, text) {
      // Adiciona mensagem ao feed de IA se existir (mantido para compatibilidade)
      const box = document.getElementById('iaFeed');
      if (box) {
        const div = document.createElement('div');
        div.className = 'msg ' + (type || 'status');
        div.textContent = text;
        box.appendChild(div);
        const msgs = box.querySelectorAll('.msg');
        const limit = 10;
        if (msgs.length > limit) {
          box.removeChild(msgs[0]);
        }
        box.scrollTop = box.scrollHeight;
      }
      // Envia a mensagem também ao feed de chat e atualiza o preview
      try {
        chatPush(type, text);
        if (type === 'ai') updatePreview(text);
      } catch (e) { console.warn(e); }
    }
    // Função auxiliar para adicionar mensagens ao feed de chat
    function chatPush(type, text) {
      const feed = document.getElementById('chatFeed');
      if (!feed) return;
      const div = document.createElement('div');
      div.className = 'msg ' + (type || 'status');
      div.textContent = text;
      feed.appendChild(div);
      const msgs = feed.querySelectorAll('.msg');
      const limit = 50;
      if (msgs.length > limit) {
        feed.removeChild(msgs[0]);
      }
      feed.scrollTop = feed.scrollHeight;
    }
    // Atualiza o preview laranja com a última resposta da IA
    function updatePreview(text) {
      const prev = document.getElementById('msgPreview');
      if (!prev) return;
      prev.textContent = text.replace(/\s+/g, ' ').trim();
      // Exibe o preview apenas se a página Home estiver ativa.  Caso
      // contrário, mantenha-o oculto para não interferir na visualização
      // das outras abas (chat, apps etc.).
      const homeView = document.getElementById('v-home');
      const isHomeActive = homeView && homeView.classList.contains('active');
      prev.style.display = isHomeActive ? 'block' : 'none';
    }
    function startSpeechConversation(userName, sk, model) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        showArchMessage('Reconhecimento de fala não suportado neste navegador.', 'err');
        return;
      }
      const recognition = new SpeechRecognition();
      recognition.lang = 'pt-BR';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.onstart = () => {
        showArchMessage('Estou ouvindo…', 'ok');
        feedPush('status', '🎙️ Ouvindo…');
      };
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.trim();
        if (transcript) {
          feedPush('user', 'Você: ' + transcript);
          showArchMessage('Pulso enviado. Recebendo intenção…', 'ok');
          feedPush('status', '⚡ Pulso enviado · recebendo intenção…');
          handleUserMessage(transcript, userName, sk, model);
        }
      };
      recognition.onerror = (e) => {
        console.error('Erro no reconhecimento de fala:', e);
        showArchMessage('Erro no reconhecimento de fala.', 'err');
        feedPush('status', '❌ Erro no reconhecimento de fala.');
      };
      recognition.start();
    }

    /**
     * Processa a mensagem falada pelo usuário.  Exibe a transcrição no
     * feedback, envia a mensagem ao modelo de IA via OpenRouter e, ao
     * receber a resposta, exibe e fala a resposta de volta.
     * @param {string} text Texto transcrito da fala do usuário
     * @param {string} userName Nome do usuário
     * @param {string} sk Chave OpenRouter
     * @param {string} model Modelo de IA
     */
    async function handleUserMessage(text, userName, sk, model) {
      // A mensagem do usuário já foi adicionada ao feed no evento onresult do reconhecimento de fala
      // Monta prompt incluindo o nome do usuário para personalização
      const prompt = `${userName} disse: ${text}`;
      // Envia ao modelo de IA
      let reply = '';
      try {
        reply = await sendAIMessage(prompt, sk, model);
      } catch (err) {
        console.error('Falha ao consultar IA:', err);
        reply = 'Desculpe, não consegui responder no momento.';
      }
      if (reply) {
        // Determine o arquétipo ativo para prefixar as respostas no feed
        let archName = 'Dual';
        try {
          const select = document.getElementById('arch-select');
          let base = (select?.value || '').replace(/\.html$/i, '');
          archName = base.charAt(0).toUpperCase() + base.slice(1).toLowerCase();
        } catch (e) {}
        feedPush('ai', archName + ': ' + reply);
        showArchMessage(reply, 'ok');
        try { speakWithActiveArch(reply); } catch {}
      }
    }

    /**
     * Envia uma mensagem ao endpoint de chat do OpenRouter.  Esta função
     * utiliza a API de chat completions para obter uma resposta do modelo
     * selecionado.  Caso não seja possível acessar a API (por exemplo,
     * se a aplicação estiver offline), uma resposta de erro é retornada.
     * @param {string} content Conteúdo da mensagem/prompt
     * @param {string} sk Chave de API
     * @param {string} model Identificador do modelo
     * @returns {Promise<string>} Resposta do modelo
     */
    async function sendAIMessage(content, sk, model) {
      // Estrutura de payload conforme especificação do OpenRouter
      const payload = {
        model: model,
        messages: [
          { role: 'system', content: 'Você é um assistente amistoso que responde em português.' },
          { role: 'user', content: content }
        ],
        max_tokens: 200,
        temperature: 0.7
      };
      const url = 'https://openrouter.ai/api/v1/chat/completions';
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${sk}`
        },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        throw new Error('Erro na API: ' + res.status);
      }
      const data = await res.json();
      const reply = data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content;
      return reply || '';
    }

    // Delegue cliques dentro do menu para a função de navegação.
    document.addEventListener('DOMContentLoaded', () => {
      const menu = document.getElementById('archMenu');
      if (menu) {
      menu.addEventListener('click', (e) => {
        // Primeiro verifique se o botão de áudio foi clicado
        const audioBtn = e.target.closest('button[data-audio]');
        if (audioBtn) {
          // Alterna modo áudio usando a função global
          if (typeof toggleAudio === 'function') {
            toggleAudio();
          }
          // Atualize o estado visual do botão
          const archCircle = document.querySelector('.arch-circle');
          if (archCircle) {
            audioBtn.classList.toggle('on', archCircle.classList.contains('audio-on'));
          }
          // Não feche o menu ao alternar áudio
          return;
        }
        // Caso contrário, delegue a navegação para botões com data-nav
        const btn = e.target.closest('button[data-nav]');
        if (btn) {
          nav(btn.getAttribute('data-nav'));
          menu.classList.remove('show');
        }
      });
      }
      // Clique no preview direciona ao chat
      const mp = document.getElementById('msgPreview');
      if (mp) mp.addEventListener('click', () => nav('chat'));

      /* Formulário de chat removido: a captura de mensagens é feita via
         overlay de entrada. */

      // Inicialização dos botões de texto e voz na Home (overlay).  Dois botões
      // empilhados acima da barra: o superior inicia reconhecimento de voz e
      // o inferior mostra o campo de texto. O envio do formulário do
      // overlay dispara a mesma lógica do chat padrão.
      const textBtn = document.getElementById('homeTextBtn');
      const voiceBtn = document.getElementById('homeVoiceBtn');
      const hiOverlay = document.getElementById('homeInputOverlay');
      const hiForm = document.getElementById('homeInputForm');
      const hiInput = document.getElementById('homeInput');
      // Exibe/oculta o overlay ao tocar no botão de texto
      if (textBtn && hiOverlay && hiForm && hiInput) {
        textBtn.addEventListener('click', () => {
          const show = hiOverlay.style.display !== 'block';
          hiOverlay.style.display = show ? 'block' : 'none';
          textBtn.classList.toggle('active', show);
          if (show) setTimeout(() => hiInput.focus(), 60);
        });
        hiForm.addEventListener('submit', (ev) => {
          ev.preventDefault();
          const msg = hiInput.value.trim();
          if (!msg) return;
          feedPush('user', 'Você: ' + msg);
          showArchMessage('Pulso enviado. Recebendo intenção…', 'ok');
          feedPush('status', '⚡ Pulso enviado · recebendo intenção…');
          const userName = (localStorage.getItem('dual.name') || localStorage.getItem('infodose:userName') || '').trim();
          const sk = (localStorage.getItem('dual.keys.openrouter') || localStorage.getItem('infodose:sk') || '').trim();
          let mdl = LS.get('dual.openrouter.model');
          if (!mdl) mdl = (localStorage.getItem('infodose:model') || '').trim() || 'openrouter/auto';
          try { handleUserMessage(msg, userName, sk, mdl); } catch (e) { console.warn(e); }
          hiInput.value = '';
        });
      }
      // Inicia conversa por voz ao tocar no botão de voz
      if (voiceBtn) {
        voiceBtn.addEventListener('click', () => {
          const userName = (localStorage.getItem('dual.name') || localStorage.getItem('infodose:userName') || '').trim();
          const sk = (localStorage.getItem('dual.keys.openrouter') || localStorage.getItem('infodose:sk') || '').trim();
          let mdl = LS.get('dual.openrouter.model');
          if (!mdl) mdl = (localStorage.getItem('infodose:model') || '').trim() || 'openrouter/auto';
          if (hiOverlay) hiOverlay.style.display = 'none';
          if (typeof startSpeechConversation === 'function') {
            startSpeechConversation(userName, sk, mdl);
          }
        });
      }
    });

    // Helper: se a aba Revo estiver ativa, envia a lista atual de apps ao iframe.  
    function maybeSendAppsToRevo() {
      // Revo foi substituído pelo Chat; nenhuma mensagem precisa ser enviada
      return;
    }
    $$('.tab,[data-nav]').forEach(b => b.addEventListener('click', () => nav(b.dataset.nav || 'home')));
    $('#btnBack').onclick = () => { try { history.length > 1 && history.back() } catch { } };
    $('#btnBrain').onclick = () => nav('brain');

    // Restaurar última aba
    let last = LS.get('uno:lastTab', 'home');
    // Se o último tab salvo for 'revo', redirecione para home para evitar páginas vazias
    if (last === 'revo') last = 'home';
    nav(last);
    // Se a aba inicial for home, exibir saudação
    if (last === 'home') {
      try { displayGreeting(); } catch(e) {}
    }

    // Atalhos
    let gPressed = false;
    window.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') { e.preventDefault(); downloadSelf(); return; }
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') { e.preventDefault(); $('#appSearch')?.focus(); return; }
      if (e.key.toLowerCase() === 'g') { gPressed = true; setTimeout(() => gPressed = false, 600); return; }
      if (!gPressed) return; const k = e.key.toLowerCase();
      if (k === 'h') nav('home'); if (k === 'a') nav('apps'); if (k === 's') nav('stack'); if (k === 'b') nav('brain'); if (k === 'r') nav('chat'); gPressed = false;
    });

    // Ajuda modal
    const modalHelp = $('#modalHelp');
    $('#btnHelp').onclick = () => { modalHelp.classList.add('open'); modalHelp.setAttribute('aria-hidden', 'false'); };
    $('#closeHelp').onclick = () => { modalHelp.classList.remove('open'); modalHelp.setAttribute('aria-hidden', 'true'); };
    modalHelp.addEventListener('click', (e) => { if (e.target === modalHelp) $('#closeHelp').click(); });

    // Baixar HTML
    function downloadSelf() {
      try {
        const clone = document.documentElement.cloneNode(true);
        const html = '<!doctype html>\n' + clone.outerHTML;
        const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'HUB-UNO-Revo.html'; a.click(); setTimeout(() => URL.revokeObjectURL(a.href), 500);
        toast('HTML exportado', 'ok');
      } catch (e) { alert('Falha ao exportar: ' + e.message); }
    }
    $('#btnDownload').onclick = downloadSelf;

    /* ===================== Brain ===================== */
    const MODELS = ['openrouter/auto','anthropic/claude-3.5-sonnet','openai/gpt-4.1-mini','google/gemini-1.5-pro','meta/llama-3.1-405b-instruct','mistral/mistral-large-latest'];
    (function initBrain() {
      const sel = $('#model'); sel.innerHTML = ''; MODELS.forEach(m => { const o = document.createElement('option'); o.value = m; o.textContent = m; sel.appendChild(o) });
      sel.value = LS.get('dual.openrouter.model', MODELS[0]);
      $('#sk').value = LS.raw('dual.keys.openrouter');
      $('#saveSK').onclick = () => { LS.set('dual.openrouter.model', sel.value); localStorage.setItem('dual.keys.openrouter', $('#sk').value || ''); toast('Configurações salvas', 'ok'); };
      $('#saveName').onclick = () => {
        localStorage.setItem('infodose:userName', ($('#userName').value || '').trim());
        // Toque som especial ao salvar o nome do usuário (Tech Pop)
        try { if (typeof window.playTechPopSound === 'function') window.playTechPopSound(); } catch {}
        // Mensagens de toast foram desativadas globalmente
        try { displayGreeting(); } catch (e) {}
        try { updateHomeStatus(); } catch {}
      };

      // Preencher campo de assistente com valor salvo
      const assistantInput = document.getElementById('assistantName');
      if (assistantInput) {
        assistantInput.value = (localStorage.getItem('infodose:assistantName') || '').trim();
      }
      // Salvar nome do assistente
      const btnAssistant = document.getElementById('saveAssistant');
      if (btnAssistant) {
        btnAssistant.onclick = () => {
          const nameVal = (assistantInput.value || '').trim();
          localStorage.setItem('infodose:assistantName', nameVal);
          try { if (typeof window.playTechPopSound === 'function') window.playTechPopSound(); } catch {}
        };
      }

      // Preencher lista de vozes para seleção global de fala
      const voiceSel = document.getElementById('selectVoice');
      function populateVoiceSel() {
        if (!voiceSel) return;
        voiceSel.innerHTML = '';
        let voices = speechSynthesis.getVoices();
        if (!voices || !voices.length) return;
        // Filtrar por idiomas suportados (Português e Inglês) se disponível
        const filtered = voices.filter(v => v.lang && (v.lang.toLowerCase().startsWith('pt') || v.lang.toLowerCase().startsWith('en')));
        voices = filtered.length ? filtered : voices;
        const savedVoice = localStorage.getItem('infodose:speechVoice') || '';
        voices.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v.name;
          opt.textContent = v.name + ' (' + v.lang + ')';
          if (savedVoice && savedVoice === v.name) opt.selected = true;
          voiceSel.appendChild(opt);
        });
      }
      if (voiceSel) {
        // Populate now and when voices change
        populateVoiceSel();
        speechSynthesis.onvoiceschanged = populateVoiceSel;
      }
      const btnVoice = document.getElementById('saveVoice');
      if (btnVoice && voiceSel) {
        btnVoice.onclick = () => {
          const val = voiceSel.value;
          localStorage.setItem('infodose:speechVoice', val || '');
          try { if (typeof window.playTechPopSound === 'function') window.playTechPopSound(); } catch {}
        };
      }

      // Permitir adicionar modelo personalizado
      const addBtn = $('#addModel');
      const customInput = $('#customModel');
      if (addBtn && customInput) {
        addBtn.onclick = () => {
          const val = (customInput.value || '').trim();
          if (!val) return;
          const opt = document.createElement('option');
          opt.value = val; opt.textContent = val;
          sel.appendChild(opt);
          sel.value = val;
          LS.set('dual.openrouter.model', val);
          customInput.value = '';
          toast('Modelo adicionado', 'ok');
        };
      }
      // Permitir carregamento de arquivo de treino
      const trainInp = $('#trainingFile');
      if (trainInp) {
        trainInp.addEventListener('change', (ev) => {
          const file = ev.target.files && ev.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            try {
              LS.set('dual.openrouter.training', { name: file.name, data: reader.result });
              toast('Treinamento carregado', 'ok');
            } catch (err) { console.error(err); toast('Erro ao carregar treino', 'err'); }
          };
          reader.readAsDataURL(file);
        });
      }
    })();

    /* ===================== Inicialização do tema & personalização de fundo ===================== */
    (function initThemeSettings() {
      // Se o usuário nunca selecionou um tema antes, defina o padrão como "medium" (cinza).
      if (!LS.get('uno:theme')) {
        LS.set('uno:theme', 'medium');
      }
      // Aplique o tema salvo imediatamente
      applyTheme();
      // Configure o seletor de tema
      const sel = document.getElementById('themeSelect');
      if (sel) {
        sel.value = LS.get('uno:theme', 'medium');
        sel.addEventListener('change', () => {
          LS.set('uno:theme', sel.value);
          applyTheme();
          toast('Tema atualizado', 'ok');
          try { updateHomeStatus(); } catch {}
        });
      }
      const upload = document.getElementById('bgUpload');
      if (upload) {
        upload.addEventListener('change', (e) => {
          const f = e.target.files && e.target.files[0];
          if (!f) return;
          const reader = new FileReader();
          reader.onload = () => {
            try {
              LS.set('uno:bg', reader.result);
              LS.set('uno:theme', 'custom');
              if (sel) sel.value = 'custom';
              applyTheme();
              toast('Fundo personalizado salvo', 'ok');
              try { updateHomeStatus(); } catch {}
            } catch (err) { console.error(err); toast('Erro ao salvar fundo', 'err'); }
          };
          reader.readAsDataURL(f);
        });
      }
    })();

    /* ===================== Ícones inline (data SVG) ===================== */
    function svgIcon(name){
      const common = 'xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%23f5f7ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"';
      const m = {
        atlas: `<svg ${common}><circle cx="12" cy="12" r="9"/><path d="M3 12h18M12 3v18"/><path d="M5 8c3 2 11 2 14 0M5 16c3-2 11-2 14 0"/></svg>`,
        nova: `<svg ${common}><path d="M12 2v4M12 18v4M2 12h4M18 12h4"/><path d="M5.6 5.6l2.8 2.8M15.6 15.6l2.8 2.8M18.4 5.6l-2.8 2.8M8.4 15.6l-2.8 2.8"/><circle cx="12" cy="12" r="3"/></svg>`,
        vitalis:`<svg ${common}><path d="M3 12h4l2-5 4 10 2-5h6"/><path d="M13 3l-2 4 3 1-2 4"/></svg>`,
        pulse: `<svg ${common}><path d="M2 12h3l2-4 3 8 2-4h8"/><path d="M20 8v-3M20 19v-3"/></svg>`,
        artemis:`<svg ${common}><path d="M3 12h12"/><path d="M13 6l6 6-6 6"/><circle cx="12" cy="12" r="9"/></svg>`,
        serena:`<svg ${common}><path d="M12 21s-6-3.5-6-8a4 4 0 0 1 6-3 4 4 0 0 1 6 3c0 4.5-6 8-6 8z"/></svg>`,
        kaos:  `<svg ${common}><path d="M4 4l7 7-7 7"/><path d="M20 4l-7 7 7 7"/></svg>`,
        genus: `<svg ${common}><rect x="7" y="7" width="10" height="10" rx="2"/><path d="M7 7l5-3 5 3M17 17l-5 3-5-3"/></svg>`,
        lumine:`<svg ${common}><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M2 12h2M20 12h2M4.9 4.9l1.4 1.4M17.7 17.7l1.4 1.4M4.9 19.1l1.4-1.4M17.7 6.3l1.4-1.4"/></svg>`,
        rhea:  `<svg ${common}><path d="M12 3v6"/><circle cx="12" cy="9" r="4"/><path d="M12 13v2l-2 2M12 15l2 2M12 17v3"/></svg>`,
        solus: `<svg ${common}><path d="M12 3v6M12 15v6"/><circle cx="12" cy="12" r="3"/><path d="M19 5l-3 3M5 19l3-3M5 5l3 3M19 19l-3-3"/></svg>`,
        aion:  `<svg ${common}><path d="M7 12c0-2.2 1.8-4 4-4 1.2 0 2.3.5 3 1.3M17 12c0 2.2-1.8 4-4 4-1.2 0-2.3-.5-3-1.3"/><path d="M3 12h4M17 12h4"/></svg>`,
        // Extra icons provided by the user. These are approximations of the requested
        // assets (e.g. audio.svg, bolt.svg, etc.) using simple line art. They
        // maintain the same stroke characteristics as the existing icons. To use
        // them elsewhere in the UI, call svgIcon('audio'), svgIcon('bolt'), etc.
        audio: `<svg ${common}><polygon points="3,9 8,9 12,5 12,19 8,15 3,15"/><path d="M15 9c1.5 1.5 1.5 4 0 5"/><path d="M17 7c3 3 3 7 0 10"/></svg>`,
        bolt: `<svg ${common}><path d="M13 3L4 14h7l-2 7 9-11h-7l3-7z"/></svg>`,
        download: `<svg ${common}><path d="M12 3v12"/><path d="M6 9l6 6 6-6"/><path d="M5 19h14"/></svg>`,
        grid: `<svg ${common}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>`,
        home: `<svg ${common}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2h-14a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
        json: `<svg ${common}><path d="M7 4c-2 0-2 2-2 4v8c0 2 0 4 2 4"/><path d="M17 4c2 0 2 2 2 4v8c0 2 0 4-2 4"/></svg>`,
        'logo-capsule': `<svg ${common}><rect x="4" y="7" width="16" height="10" rx="5"/><path d="M12 7v10"/></svg>`,
        'logo-seed-split': `<svg ${common}><path d="M12 12c0-4 4-8 8-8v8c0 4-4 8-8 8v-8z"/><path d="M12 12c0-4-4-8-8-8v8c0 4 4 8 8 8v-8z"/></svg>`,
        pause: `<svg ${common}><rect x="6" y="4" width="3" height="16"/><rect x="15" y="4" width="3" height="16"/></svg>`,
        play: `<svg ${common}><polygon points="6,4 20,12 6,20"/></svg>`,
        upload: `<svg ${common}><path d="M12 21V9"/><path d="M6 15l6-6 6 6"/><path d="M5 5h14"/></svg>`,
        user: `<svg ${common}><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 4-8 8-8s8 4 8 8"/></svg>`,
        sprites: `<svg ${common}></svg>`
      };
      const raw = m[name] || m['atlas'];
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(raw);
    }

    /* ===================== Apps (embutido + locais) ===================== */
    const RAW = { apps: [] };

    // Controle para exibir apenas apps locais ou todos
    let showOnlyLocal = false;
    // Lista de apps favoritados (por chave). Carregada do localStorage
    let favoriteKeys = [];
    try { favoriteKeys = JSON.parse(localStorage.getItem('infodose:favApps') || '[]') || []; } catch { favoriteKeys = []; }

    /**
     * Alterna um app na lista de favoritos. Salva no localStorage e re-renderiza.
     * @param {string} key
     */
    function toggleFav(key) {
      const idx = favoriteKeys.indexOf(key);
      if (idx >= 0) {
        favoriteKeys.splice(idx, 1);
      } else {
        favoriteKeys.push(key);
      }
      localStorage.setItem('infodose:favApps', JSON.stringify(favoriteKeys));
      renderApps();
    }
    /** Verifica se um app está favoritado. */
    function isFav(key) {
      return favoriteKeys.includes(key);
    }
    const appsWrap = $('#appsWrap'), appsCount = $('#appsCount');

    function normalize(list) {
      return (list || []).map(x => ({
        key: x.key || x.url || x.title || Math.random().toString(36).slice(2),
        title: x.title || x.key || 'App',
        desc: x.desc || '',
        url: String(x.url || ''),
        icon: x.icon || '',
        tags: Array.isArray(x.tags) ? x.tags : []
      }))
    }
    function locals() {
      let arr = []; try { arr = JSON.parse(LS.raw('infodose:locals:v1') || '[]') } catch {}
      return arr.map(l => ({ key: 'local:' + l.id, title: l.name || 'Local', desc: 'HTML local', url: 'local:' + l.id, icon: 'local', tags: ['local'] }))
    }
    function getLocal(id) {
      let arr = []; try { arr = JSON.parse(LS.raw('infodose:locals:v1') || '[]') } catch {}
      return arr.find(x => x.id === id) || null
    }
    function blobURL(local) { const blob = new Blob([local.html || ''], { type: 'text/html;charset=utf-8' }); return URL.createObjectURL(blob) }

    /**
     * Atualiza os cartões de status na Home com informações atuais sobre apps, sessões,
     * preferências do usuário e arquétipo ativo. Chamado sempre que o
     * catálogo muda, quando sessões são abertas/fechadas, quando
     * configurações são salvas ou ao navegar para o Home.
     */
    function updateHomeStatus() {
      try {
        // Apps: número total ou locais se estiver filtrando
        const total = normalize(RAW.apps).concat(locals()).length;
        const localCount = locals().length;
        const txtApps = showOnlyLocal ? (localCount + ' local' + (localCount === 1 ? '' : 's')) : (total + ' app' + (total === 1 ? '' : 's'));
        const elApps = document.getElementById('homeAppsStatus');
        if (elApps) elApps.textContent = txtApps;
      } catch (e) {}
      try {
        // Sessões abertas (Stack)
        const sess = document.querySelectorAll('#stackWrap .session').length;
        const txtSess = sess + ' sessão' + (sess === 1 ? '' : 's');
        const elStack = document.getElementById('homeStackStatus');
        if (elStack) elStack.textContent = txtSess;
      } catch (e) {}
      try {
        // Usuário: nome + tema atual (mapa)
        const name = (localStorage.getItem('infodose:userName') || '').trim();
        const theme = LS.get('uno:theme', 'medium');
        const themeLabel = { 'default': 'padrão', 'medium': 'cinza', 'custom': 'personalizado' }[theme] || theme;
        let txtUser = name || 'Usuário';
        txtUser += ' · ' + themeLabel;
        const elUser = document.getElementById('homeUserStatus');
        if (elUser) elUser.textContent = txtUser;
      } catch (e) {}
      try {
        // Arquétipo ativo: obtém o nome sem extensão
        const sel = document.getElementById('arch-select');
        let archName = '';
        if (sel && sel.options.length > 0) {
          const opt = sel.options[sel.selectedIndex] || null;
          if (opt) archName = opt.textContent.replace(/\.html$/i, '');
        }
        const elArch = document.getElementById('homeArchStatus');
        if (elArch) elArch.textContent = archName || 'Nenhum';
      } catch (e) {}
    }

    function appIconFor(a){
      if(!a.icon) return svgIcon('atlas');
      if(/^(atlas|nova|vitalis|pulse|artemis|serena|kaos|genus|lumine|rhea|solus|aion|local)$/.test(a.icon)) return svgIcon(a.icon);
      return a.icon; // caminho externo
    }

    function cardApp(a) {
      const el = document.createElement('div'); el.className = 'app-card fx-trans fx-lift';
      // Botão de favorito (estrela). Aparece no canto superior direito
      const fav = document.createElement('button'); fav.className = 'fav-btn';
      const favImg = document.createElement('img');
      favImg.alt = 'Favorito';
      // Use ícone local para favorito; evita depender de CDN
      favImg.src = 'icons/star.svg';
      fav.appendChild(favImg);
      // Marque como favoritado se a chave estiver na lista
      if (isFav(a.key)) fav.classList.add('fav');
      fav.onclick = (e) => { e.stopPropagation(); toggleFav(a.key); };
      el.appendChild(fav);
      const ic = document.createElement('div'); ic.className = 'app-icon';
      const img = document.createElement('img'); img.alt = ''; img.width = 24; img.height = 24; img.src = appIconFor(a); ic.appendChild(img);
      const meta = document.createElement('div'); meta.style.flex = '1';
      // Truncar o título para exibir apenas as três primeiras palavras; adicionar reticências quando houver mais.
      const fullTitle = String(a.title || a.key || '').trim();
      const words = fullTitle.split(/\s+/);
      const truncated = words.slice(0, 2).join(' ');
      const displayTitle = words.length > 2 ? truncated + '…' : truncated;
      const t = document.createElement('div');
      t.className = 'app-title';
      t.textContent = displayTitle || fullTitle;
      // O título completo fica como tooltip para acesso total via hover
      t.title = fullTitle;
      const d = document.createElement('div'); d.className = 'mut'; d.textContent = a.desc || a.url;
      const open = document.createElement('button'); open.className = 'btn fx-trans fx-press ring'; open.textContent = 'Abrir';
      const rip = document.createElement('span'); rip.className = 'ripple'; open.appendChild(rip); addRipple(open);
      open.onclick = () => openApp(a);
      meta.appendChild(t); meta.appendChild(d); meta.appendChild(open);
      el.appendChild(ic); el.appendChild(meta);
      return el
    }

    function renderApps() {
      // Busque valores de busca e ordenação apenas se os campos existirem (evita erros se ocultos)
      const searchEl = document.getElementById('appSearch');
      const sortEl = document.getElementById('appSort');
      const q = searchEl ? (searchEl.value || '').toLowerCase() : '';
      const mode = sortEl ? sortEl.value : 'az';
      // Combine apps embutidos e locais
      let L = normalize(RAW.apps).concat(locals());
      // Filtrar apenas locais se ativado
      if (showOnlyLocal) {
        L = L.filter(a => String(a.url || '').startsWith('local:'));
      }
      // Aplicar busca (mantendo compatibilidade se o usuário ainda possuir o campo)
      if (q) {
        L = L.filter(a => (a.title + ' ' + a.desc + ' ' + a.key + ' ' + a.url + ' ' + (a.tags || []).join(' ')).toLowerCase().includes(q));
      }
      // Ordenar: favoritos primeiro, depois título A-Z ou Z-A conforme o select (padrão A-Z)
      L.sort((a, b) => {
        const favA = isFav(a.key); const favB = isFav(b.key);
        if (favA !== favB) return favB - favA; // true=1, false=0 => favoritos no topo
        const dir = mode === 'za' ? -1 : 1;
        return dir * String(a.title || '').localeCompare(b.title || '');
      });
      // Organize os apps por grupo (arquetipo).  Considera-se o nome
      // após o ponto "·" no título como o nome do grupo.  Se não houver,
      // coloca em "Outros".
      const grouped = {};
      L.forEach(a => {
        let gName = '';
        if (a.title && a.title.includes('·')) {
          const parts = a.title.split('·');
          gName = (parts[1] || '').trim();
        }
        if (!gName) gName = 'Outros';
        if (!grouped[gName]) grouped[gName] = [];
        grouped[gName].push(a);
      });
      // Limpar o container
      appsWrap.innerHTML = '';
      // Ordenar grupos alfabeticamente para exibir em ordem consistente
      const groupNames = Object.keys(grouped).sort((a,b) => a.localeCompare(b));
      let total = 0;
      groupNames.forEach(gName => {
        const container = document.createElement('div');
        container.className = 'apps-group';
        const header = document.createElement('h3');
        header.textContent = gName;
        header.style.margin = '16px 4px 8px';
        header.style.fontSize = '15px';
        header.style.fontWeight = '800';
        header.style.color = 'var(--mut)';
        const grid = document.createElement('div');
        grid.className = 'grid';
        grouped[gName].forEach(app => {
          const card = cardApp(app);
          grid.appendChild(card);
          total++;
        });
        container.appendChild(header);
        container.appendChild(grid);
        appsWrap.appendChild(container);
      });
      appsCount.textContent = total + ' apps';
      // Reaplicar ícones após adicionar novos cards (garante que as estrelas e ícones de apps carreguem)
      try { applyIcons(); } catch {}
      // Notifique o Revo de que os apps mudaram, se estiver ativo
      maybeSendAppsToRevo();
      // Atualize o painel de status na home com o novo número de apps
      try { updateHomeStatus(); } catch {}
    }

    (function loadEmbeddedApps(){
      try {
        const raw = JSON.parse($('#APPS_JSON').textContent || '{}');
        RAW.apps = Array.isArray(raw.apps) ? raw.apps : (Array.isArray(raw) ? raw : []);
      } catch { RAW.apps = [] }
      renderApps();
      // Após renderizar os apps, crie grupos padrão no Stack para cada
      // arquetipo, se ainda não existirem.  Isso permite que as sessões
      // abertas sejam automaticamente organizadas por grupo.
      try { ensureDefaultGroups(); } catch (e) { console.warn('Falha ao criar grupos padrão', e); }
      // Sempre envie o catálogo atualizado ao iframe do Revo após carregar os apps embutidos.
      try {
        const iframe = document.getElementById('revoEmbed');
        if (iframe) {
          const apps = RAW && Array.isArray(RAW.apps) ? RAW.apps : [];
          const send = () => { if (iframe.contentWindow) iframe.contentWindow.postMessage({ type: 'apps', apps }, '*'); };
          // Envie após pequeno atraso para garantir que o iframe esteja pronto
          setTimeout(send, 100);
          // E também quando o iframe terminar de carregar
          iframe.removeEventListener('load', iframe._sendAppsEmbedded);
          iframe._sendAppsEmbedded = send;
          iframe.addEventListener('load', send, { once: true });
        }
      } catch(e) { console.warn('Falha ao postMessage apps após embed:', e); }
    })();

    // Locais
    $('#btnImport').onclick = async () => {
      const fs = Array.from($('#fileLocal').files || []);
      if (!fs.length) return;
      const tasks = fs.map(f => new Promise(res => {
        const r = new FileReader();
        r.onload = () => {
          const content = String(r.result || '');
          // Se for um arquivo JSON, tente carregá-lo como catálogo de apps
          if (/\.json$/i.test(f.name)) {
            try {
              const obj = JSON.parse(content);
              const apps = Array.isArray(obj.apps) ? obj.apps : (Array.isArray(obj) ? obj : []);
              // Substitua o catálogo embutido pelo JSON local e recarregue a lista
              RAW.apps = apps;
              renderApps();
              toast('apps.json local carregado', 'ok');
            } catch (err) {
              console.error(err);
              toast('Erro ao ler apps.json', 'err');
            }
            // Não adicionar JSON à lista de locais; retorne null
            res(null);
          } else {
            // Trate como HTML local
            res({ id: 'l_' + Math.random().toString(36).slice(2), name: f.name.replace(/\.(html?|txt)$/i, ''), html: content, ts: Date.now() });
          }
        };
        r.readAsText(f);
      }));
      const list = (await Promise.all(tasks)).filter(Boolean);
      const cur = JSON.parse(LS.raw('infodose:locals:v1') || '[]');
      list.forEach(x => cur.unshift(x));
      localStorage.setItem('infodose:locals:v1', JSON.stringify(cur));
      renderApps();
      if (list.length) toast('HTMLs locais adicionados', 'ok');
    };
    $('#btnExport').onclick = () => { const data = { v: 1, when: Date.now(), items: JSON.parse(LS.raw('infodose:locals:v1') || '[]') }; const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })); a.download = 'locals_pack.json'; a.click(); };
    $('#btnClear').onclick = () => { if (confirm('Limpar HTMLs locais salvos?')) { localStorage.removeItem('infodose:locals:v1'); renderApps(); toast('Locais limpos', 'warn'); } };

    // Alterna exibição de apps locais/apenas locais
    try {
      const btnToggleLocal = document.getElementById('btnToggleLocal');
      if (btnToggleLocal) {
        btnToggleLocal.onclick = () => {
          showOnlyLocal = !showOnlyLocal;
          // Atualize o texto do botão conforme o modo
          btnToggleLocal.firstChild && (btnToggleLocal.firstChild.nodeValue = showOnlyLocal ? 'Mostrar Todos' : 'Mostrar Locais');
          renderApps();
        };
      }
    } catch (e) { console.warn('Falha ao associar btnToggleLocal:', e); }

    /* ===================== Stack ===================== */
    const stackWrap = $('#stackWrap'), dock = $('#dock');
    function badge(item) { const b = document.createElement('button'); b.className = 'badge fx-trans fx-press ring'; b.textContent = item.title || 'App'; b.title = 'Reabrir ' + (item.title || 'App'); const rp = document.createElement('span'); rp.className = 'ripple'; b.appendChild(rp); addRipple(b); b.onclick = () => { const s = document.querySelector('[data-sid="' + item.sid + '"]'); if (s) { s.scrollIntoView({ behavior: 'smooth' }); s.classList.remove('min'); } }; return b }
    function updateDock() {
      dock.innerHTML = '';
      $$('.session').forEach(s => {
        const meta = JSON.parse(s.dataset.meta || '{}');
        dock.appendChild(badge({ title: meta.title, sid: s.dataset.sid }))
      });
      // Atualize o status de sessões na home
      try { updateHomeStatus(); } catch {}
    }
    function openApp(a) {
      // Permite receber um SID externo (para restaurar sessões) ou gera um novo se ausente
      const sid = a.sid || ('s_' + Math.random().toString(36).slice(2));
      const isLocal = String(a.url || '').startsWith('local:'); const lr = isLocal ? getLocal(String(a.url).slice(6)) : null; const url = lr ? blobURL(lr) : a.url;
      const card = document.createElement('div'); card.className = 'session fx-trans fx-lift';
      card.dataset.sid = sid;
      // Armazene metadados de título/url no dataset.meta para persistência
      card.dataset.meta = JSON.stringify({ title: a.title || 'App', url: a.url || '' });
      // Se nenhum grupo foi fornecido, tente atribuir com base no nome após o ponto no título (ex.: "Atlas · Cartesius").
      if (!a.gid && a.title && a.title.includes('·')) {
        const parts = a.title.split('·');
        const gName = (parts[1] || '').trim();
        if (gName) {
          a.gid = 'g_' + gName.toLowerCase().replace(/\s+/g, '_');
        }
      }
      // Se um grupo específico foi fornecido, salve no dataset.gid para persistência
      if (a.gid) card.dataset.gid = a.gid;
      card.innerHTML = `
        <div class="hdr">
          <div class="title"><span class="app-icon">${((a.title || 'App')[0] || 'A')}</span>${(a.title || 'App')}</div>
          <div class="tools">
            <button class="btn ring fx-trans fx-press" data-act="min" title="Minimizar">
              <span style="font-size:16px;line-height:1">&minus;</span>
              <span class="ripple"></span>
            </button>
            <button class="btn ring fx-trans fx-press" data-act="ref" title="Recarregar">
              <span style="font-size:16px;line-height:1">&#8635;</span>
              <span class="ripple"></span>
            </button>
            <button class="btn ring fx-trans fx-press" data-act="full" title="Tela cheia">
              <span style="font-size:16px;line-height:1">⤢</span>
              <span class="ripple"></span>
            </button>
            <!-- Botão para fixar/desafixar na navegação -->
            <button class="btn ring fx-trans fx-press" data-act="pin" title="Fixar na barra">
              <span class="pin-icon" style="font-size:16px;line-height:1">☆</span>
              <span class="ripple"></span>
            </button>
            <!-- Botão para mover entre grupos -->
            <button class="btn ring fx-trans fx-press" data-act="move" title="Mover sessão">
              <span style="font-size:16px;line-height:1">⇄</span>
              <span class="ripple"></span>
            </button>
            <button class="btn ring fx-trans fx-press" data-act="close" title="Fechar">
              <span style="font-size:16px;line-height:1">&times;</span>
              <span class="ripple"></span>
            </button>
          </div>
        </div>
        <iframe src="${url || 'about:blank'}" allow="autoplay; clipboard-read; clipboard-write; picture-in-picture; fullscreen"></iframe>
        <div class="resize-handle" title="Arraste para ajustar a altura"></div>`;
      // Redimensionar altura do iframe arrastando o handle
      (function bindResize(){
        const handle = card.querySelector('.resize-handle');
        const iframe = card.querySelector('iframe');
        if(!handle || !iframe) return;
        let startY = 0, startH = 0, dragging = false;
        handle.addEventListener('pointerdown', (ev) => {
          dragging = true;
          startY = ev.clientY;
          startH = iframe.clientHeight;
          handle.setPointerCapture(ev.pointerId);
        });
        handle.addEventListener('pointermove', (ev) => {
          if(!dragging) return;
          const dy = ev.clientY - startY;
          const h = Math.max(120, startH + dy);
          iframe.style.height = h + 'px';
        });
        const stop = () => { dragging = false; };
        handle.addEventListener('pointerup', stop);
        handle.addEventListener('pointercancel', stop);
      })();
      // Prepend the session card dependendo do modo de abertura. Se "abrir dentro" estiver marcado,
      // insira a sessão no topo da página (sessionsAnchor); caso contrário, use o stackWrap padrão.
      const anchor = document.getElementById('sessionsAnchor');
      if ($('#openInside').checked && anchor) {
        anchor.prepend(card);
      } else {
        // Se houver um grupo selecionado, adicione a sessão dentro desse grupo; caso contrário, insira no stackWrap
        // Escolha o grupo de destino: se houver um grupo selecionado manualmente
        // use-o; caso contrário, utilize o grupo inferido do título (a.gid).
        const gid = window.currentGroupId || a.gid;
        let placed = false;
        if (gid) {
          const grp = stackWrap && stackWrap.querySelector('.stack-group[data-group-id="' + gid + '"] .group-content');
          if (grp) {
            grp.prepend(card);
            card.dataset.gid = gid;
            placed = true;
          }
        }
        if (!placed) {
          stackWrap.prepend(card);
          // Remova qualquer associação de grupo se a sessão não estiver atribuída
          delete card.dataset.gid;
        }
      }
      // Não chamar applyIcons aqui: ícones embutidos manualmente nos botões de sessão
      card.querySelector('[data-act=min]').onclick = () => {
        card.classList.toggle('min');
        updateDock();
        saveStackState();
        dualLog('Sessão minimizada: ' + (a.title || 'App'));
      };
      card.querySelector('[data-act=ref]').onclick = () => { const fr = card.querySelector('iframe'); try { fr.contentWindow.location.reload() } catch { fr.src = fr.src } };
      card.querySelector('[data-act=close]').onclick = () => {
        // Se a sessão estiver fixada, remova-a também da lista de fixados
        if (card.classList.contains('pinned')) {
          removePinnedByMeta(JSON.parse(card.dataset.meta || '{}'));
        }
        card.remove();
        updateDock();
        saveStackState();
        dualLog('Sessão fechada: ' + (a.title || 'App'));
        // Toque som de fechamento de sessão
        try { playCloseSound(); } catch {}
      };
      // Botão tela cheia
      const fullBtn = card.querySelector('[data-act=full]');
      if (fullBtn) {
        fullBtn.onclick = () => {
          card.classList.toggle('full');
          document.body.classList.toggle('session-full');
        };
      }
      // Botão fixar/desafixar
      const pinBtn = card.querySelector('[data-act=pin]');
      if (pinBtn) {
        // Inicialize o estado do botão conforme o dado de entrada
        const meta = JSON.parse(card.dataset.meta || '{}');
        if (a.pinned) {
          card.classList.add('pinned');
          pinBtn.querySelector('.pin-icon').textContent = '★';
        }
        pinBtn.onclick = () => {
          const meta = JSON.parse(card.dataset.meta || '{}');
          if (card.classList.contains('pinned')) {
            // Desafixar
            card.classList.remove('pinned');
            pinBtn.querySelector('.pin-icon').textContent = '☆';
            removePinnedByMeta(meta);
            // Não exiba toast ao desafixar
          } else {
            // Fixar
            card.classList.add('pinned');
            pinBtn.querySelector('.pin-icon').textContent = '★';
            addPinned(meta);
            // Não exiba toast ao fixar
          }
        };
      }
      // Botão mover sessão entre grupos
      const moveBtn = card.querySelector('[data-act=move]');
      if (moveBtn) {
        moveBtn.onclick = () => {
          // Liste os grupos disponíveis com seus nomes
          const groups = Array.from(document.querySelectorAll('#stackWrap .stack-group'));
          if (!groups.length) {
            // Sem grupos: simplesmente remova do grupo atual, se houver
            delete card.dataset.gid;
            stackWrap.prepend(card);
            saveStackState();
            // Não exiba toast ao mover para a raiz
            return;
          }
          const names = groups.map(g => g.querySelector('summary')?.textContent || '').filter(n => n);
          const choices = names.map((n,i) => `${i+1}. ${n}`).join('\n');
          const ans = prompt('Mover para qual grupo?\n' + choices + '\n0. Sem grupo');
          if (ans === null) return;
          const idx = parseInt(ans.trim(), 10);
          if (!isNaN(idx) && idx >= 1 && idx <= groups.length) {
            const targetGroup = groups[idx-1];
            const content = targetGroup.querySelector('.group-content');
            if (content) {
              content.prepend(card);
              card.dataset.gid = targetGroup.getAttribute('data-group-id') || '';
              updateDock();
              saveStackState();
              // Não exiba toast ao mover para um grupo específico
              return;
            }
          }
          // Se o usuário digitou 0 ou algo não válido, mova para a raiz
          delete card.dataset.gid;
          stackWrap.prepend(card);
          updateDock();
          saveStackState();
          // Não exiba toast ao mover para a raiz
        };
      }
      // Não navegue automaticamente para a view Stack na versão estendida.
      // if (!$('#openInside').checked) nav('stack');
      updateDock();
      // Após abrir uma sessão, persista o estado (grupos, sessões e fixados)
      saveStackState();
      // Não exiba toast ao abrir uma nova sessão
      dualLog('Sessão aberta: ' + (a.title || 'App'));
      // Toque som de abertura de app, se definido
      try { playOpenSound(); } catch {}
    }
    $('#btnCloseAll').onclick = () => {
      if (!confirm('Fechar todas as sessões abertas?')) return;
      $$('.session').forEach(s => s.remove());
      updateDock();
      try { saveStackState(); } catch {}
      toast('Todas as sessões fechadas', 'warn');
    };

    /* ===================== Archetypes (Central Circle) ===================== */
    (function () {
      const archList = [
        'atlas.html',
        'nova.html',
        'vitalis.html',
        'pulse.html',
        'artemis.html',
        'serena.html',
        'kaos.html',
        'genus.html',
        'lumine.html',
        'solus.html',
        'rhea.html',
        'aion.html'
      ];
      const select = document.getElementById('arch-select');
      const frame = document.getElementById('arch-frame');
      const fade = document.getElementById('arch-fadeCover');

      // Mapeamento de cores/gradientes por arquétipo.  Cada chave
      // corresponde ao nome do arquivo sem a extensão .html e define
      // um valor CSS (cor sólida ou gradiente) com opacidade baixa
      // para aplicar como overlay.  Ajuste as cores conforme o
      // significado simbólico de cada arquétipo.
      const ARCH_OVERLAYS = {
        atlas: 'rgba(64, 158, 255, 0.22)',
        nova: 'rgba(255, 82, 177, 0.22)',
        vitalis: 'rgba(72, 218, 168, 0.22)',
        pulse: 'rgba(255, 99, 132, 0.22)',
        artemis: 'rgba(186, 130, 219, 0.22)',
        serena: 'rgba(140, 190, 255, 0.22)',
        kaos: 'rgba(255, 77, 109, 0.22)',
        genus: 'rgba(87, 207, 112, 0.22)',
        lumine: 'rgba(255, 213, 79, 0.22)',
        rhea: 'rgba(0, 209, 178, 0.22)',
        solus: 'rgba(100, 149, 237, 0.22)',
        aion: 'rgba(255, 159, 67, 0.22)',
        default: 'rgba(255,255,255,0.0)'
      };

      // Aplica a cor/gradiente de overlay correspondente ao arquétipo
      function applyArchOverlay(name) {
        const key = (name || '').toLowerCase();
        const color = ARCH_OVERLAYS[key] || ARCH_OVERLAYS.default;
        document.documentElement.style.setProperty('--arch-overlay', color);
      }
      function populate() {
        select.innerHTML = '';
        archList.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          select.appendChild(opt);
        });
      }
      function setSrcByIndex(idx) {
        if (!archList.length) return;
        const n = (idx + archList.length) % archList.length;
        select.selectedIndex = n;
        const file = archList[n];
        frame.src = './archetypes/' + file;
        // Pronuncia o nome do arquétipo sempre que for selecionado
        try {
          const base = file.replace(/\.html$/i, '');
          speakArchetype(base);
        } catch (e) {}
        // Atualiza as informações da Home (cartões) quando o arquétipo muda
        try {
          updateHomeStatus();
        } catch (e) {}

        // Ajusta o overlay de cor para o arquétipo selecionado
        try {
          const base = file.replace(/\.html$/i, '');
          applyArchOverlay(base);
        } catch (e) {}
      }
      let current = 0;
      populate();
      if (archList.length) setSrcByIndex(0);
      document.getElementById('arch-prev').addEventListener('click', () => {
        current = (current - 1 + archList.length) % archList.length;
        fade.classList.add('show');
        setTimeout(() => {
          setSrcByIndex(current);
          setTimeout(() => fade.classList.remove('show'), 200);
        }, 140);
      });
      document.getElementById('arch-next').addEventListener('click', () => {
        current = (current + 1) % archList.length;
        fade.classList.add('show');
        setTimeout(() => {
          setSrcByIndex(current);
          setTimeout(() => fade.classList.remove('show'), 200);
        }, 140);
      });
      select.addEventListener('change', () => {
        current = select.selectedIndex;
        fade.classList.add('show');
        setTimeout(() => {
          setSrcByIndex(current);
          setTimeout(() => fade.classList.remove('show'), 200);
        }, 140);
      });
    })();

    /* ===================== Custom CSS & Voices: Event Handlers ===================== */
    // Aplicar CSS personalizado salvo no carregamento inicial
    try { applyCSS(); } catch (e) {}
    // Inicializar vozes na aba Brain
    try { initVoices(); } catch (e) {}
    // Inicializar ripple de áudio (modo que responde ao microfone)
    try { initAudioRipple(); } catch (e) {}
    // Exibir saudação inicial se aplicável
    try { welcome(); } catch (e) {}
    // Conectar botões de CSS personalizado
    const btnApplyCSS = document.getElementById('applyCSS');
    const btnClearCSS = document.getElementById('clearCSS');
    const btnDownloadCSS = document.getElementById('downloadCSS');
    if (btnApplyCSS) {
      btnApplyCSS.addEventListener('click', () => {
        const textarea = document.getElementById('cssCustom');
        const css = (textarea && textarea.value || '').trim();
        localStorage.setItem('infodose:cssCustom', css);
        applyCSS();
        toast('CSS aplicado', 'ok');
      });
    }
    if (btnClearCSS) {
      btnClearCSS.addEventListener('click', () => {
        localStorage.removeItem('infodose:cssCustom');
        const textarea = document.getElementById('cssCustom');
        if (textarea) textarea.value = '';
        applyCSS();
        toast('CSS removido', 'warn');
      });
    }
    if (btnDownloadCSS) {
      btnDownloadCSS.addEventListener('click', () => {
        const css = localStorage.getItem('infodose:cssCustom') || '';
        const blob = new Blob([css], { type: 'text/css' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'custom.css';
        a.click();
        setTimeout(() => URL.revokeObjectURL(a.href), 500);
      });
    }

    /* ===================== Init ===================== */
    // Inicialize preferências de performance e voz e associe botões no Brain
    (function initDualPrefs(){
      const perfSel = document.getElementById('selPerf');
      const voiceSel = document.getElementById('selVoice');
      if (perfSel) perfSel.value = dualState.perf;
      if (voiceSel) voiceSel.value = dualState.voice;
      const perfBtn = document.getElementById('btnPerf');
      const voiceBtn = document.getElementById('btnVoice');
      if (perfBtn && perfSel) {
        perfBtn.addEventListener('click', () => {
          dualState.perf = perfSel.value;
          localStorage.setItem('hub.perf', dualState.perf);
          dualLog('Performance atualizada: ' + dualState.perf);
          toast('Performance atualizada', 'ok');
        });
      }
      if (voiceBtn && voiceSel) {
        voiceBtn.addEventListener('click', () => {
          dualState.voice = voiceSel.value;
          localStorage.setItem('hub.voice', dualState.voice);
          dualLog('Voz selecionada: ' + dualState.voice);
          toast('Voz atualizada', 'ok');
        });
      }
    })();
    $$('button').forEach(addRipple);
  </script><div style="position: fixed; right: 14px; bottom: calc(var(--tabsH) + 16px); display: grid; gap: 8px; z-index: 120;"></div><div style="position: fixed; right: 14px; bottom: calc(var(--tabsH) + 16px); display: grid; gap: 8px; z-index: 120;"></div>
<!-- Local Storage Modal (safe-placed near end of body) -->
<div id="modalLS" class="modal" aria-hidden="true">
  <div class="panel">
    <div style="display:flex;align-items:center;gap:10px;justify-content:space-between">
      <h3 style="margin:0">Local Storage</h3>
      <button id="lsClose" class="btn fx-trans fx-press ring">Fechar<span class="ripple"></span></button>
    </div>
    <div class="mut" id="lsStats" style="margin-top:8px;font-size:12px">–</div>
    <!-- Informações rápidas do usuário, assistente e arquétipo ativo -->
    <div id="lsInfo" style="margin-top:8px;font-size:12px;line-height:1.4">
      <div><strong>Usuário:</strong> <span id="lsUserDisplay">–</span></div>
      <div><strong>Assistente:</strong> <span id="lsAssistantDisplay">–</span></div>
      <div><strong>Arquétipo ativo:</strong> <span id="lsArchDisplay">–</span></div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
      <button id="lsExport" class="btn fx-trans fx-press ring">Exportar<span class="ripple"></span></button>
      <button id="lsImport" class="btn fx-trans fx-press ring">Importar<span class="ripple"></span></button>
      <button id="lsClear" class="btn fx-trans fx-press ring">Limpar LS<span class="ripple"></span></button>
      <button id="lsClearIDB" class="btn fx-trans fx-press ring">Limpar IndexDB<span class="ripple"></span></button>
      <button id="lsReloadPage" class="btn fx-trans fx-press ring">Atualizar página<span class="ripple"></span></button>
    </div>
    <!-- Lista dinâmica de itens armazenados no LocalStorage -->
    <div id="lsList" style="margin-top:12px; max-height:200px; overflow:auto; font-size:12px; color:var(--fg);"></div>
    <!-- Botão para adicionar novo item ao LocalStorage -->
    <div style="margin-top:10px; display:flex; gap:6px;">
      <button id="lsAdd" class="btn fx-trans fx-press ring">Adicionar item<span class="ripple"></span></button>
    </div>
    <div class="mut" style="margin-top:10px;font-size:11px">Dica: exporte antes de limpar. O tamanho é aproximado (UTF-16).</div>
  </div>
</div>
<script>
// === Fala por voz usando Web Speech API ===
// Estas funções utilizam a API de síntese de fala do navegador para
// pronunciar mensagens. A voz padrão é configurada para o português do Brasil.
// Fala uma mensagem opcionalmente selecionando uma voz preferida.
function pickVoice(pref) {
  try {
    const voices = speechSynthesis.getVoices();
    if (!voices || !voices.length) return null;
    // Se houver uma preferência, tente encontrá-la pelo nome
    if (pref) {
      const found = voices.find(v => v.name && v.name.toLowerCase().includes(pref.toLowerCase()));
      if (found) return found;
    }
    // Caso contrário, escolha uma voz em português ou a primeira disponível
    const ptVoice = voices.find(v => v.lang && v.lang.toLowerCase().startsWith('pt'));
    return ptVoice || voices[0];
  } catch (err) {
    return null;
  }
}
function speakMsg(msg, voicePref) {
  try {
    const utter = new SpeechSynthesisUtterance(msg);
    utter.lang = 'pt-BR';
    const voice = pickVoice(voicePref);
    if (voice) utter.voice = voice;
    speechSynthesis.speak(utter);
  } catch (e) {
    console.warn('Speech synthesis not supported', e);
  }
}
function speakSplash() {
  // Recupera o nome do usuário salvo no localStorage para personalizar a mensagem
  const name = (localStorage.getItem('infodose:userName') || '').trim();
  // Se houver nome de usuário, use-o; caso contrário utilize "Dual" como padrão
  const msg = name ? `${name}, pulso ativo.` : 'Oi Dual, pulso ativo.';
  // Use a voz selecionada pelo usuário no Brain, ou "Joana" como fallback
  const prefVoice = (localStorage.getItem('infodose:speechVoice') || '').trim() || 'Joana';
  speakMsg(msg, prefVoice);
}
function speakHomeGreeting() {
  // Esta função pode ser chamada manualmente para saudar o usuário na home.
  // Não é chamada automaticamente para evitar saudações inesperadas.
  const assistant = (localStorage.getItem('dual.assistantName') || localStorage.getItem('infodose:assistantName') || 'Dual').trim();
  // Determine arquétipo selecionado a partir do select (remove .html)
  let archName = '';
  const sel = document.getElementById('arch-select');
  if (sel && sel.options.length > 0) {
    const opt = sel.options[sel.selectedIndex];
    if (opt) archName = opt.textContent.replace(/\.html$/i, '');
  }
  let msg = '';
  // Determine o nome de saudação ou utilize "Dual" como padrão
  const userName = (localStorage.getItem('infodose:userName') || '').trim();
  const greet = userName || 'Dual';
  if (assistant && archName) {
    msg = `Oi ${greet}, eu sou ${assistant}. Ativo o impulso com o arquétipo ${archName}.`;
  } else if (assistant) {
    msg = `Oi ${greet}, eu sou ${assistant}.`;
  } else {
    msg = `Oi ${greet}, ative seu impulso configurando um arquétipo.`;
  }
  // Use a voz salva pelo usuário ou o nome do arquétipo; se ambos vazios, use Joana
  const prefVoice = (localStorage.getItem('infodose:speechVoice') || '').trim();
  speakMsg(msg, archName || prefVoice || 'Joana');
}
// ===== LS Control (isolated; safe append) =====
(function(){
  function toast(msg, type){ try{ window.toast(msg, type || 'ok') }catch{ console.log(msg) } }
  const modal = document.getElementById('modalLS');
  const stats = document.getElementById('lsStats');
  const btn = document.getElementById('btnLS');
  const btnClose = document.getElementById('lsClose');
  const btnExport = document.getElementById('lsExport');
  const btnImport = document.getElementById('lsImport');
  const btnClear = document.getElementById('lsClear');
  const btnClearIDB = document.getElementById('lsClearIDB');
  // Elementos adicionais para exibir e editar LocalStorage
  const lsList = document.getElementById('lsList');
  const btnAdd  = document.getElementById('lsAdd');

  function approxSize(){
    let bytes = 0;
    for (let i=0; i<localStorage.length; i++){
      const k = localStorage.key(i) || '';
      const v = localStorage.getItem(k) || '';
      bytes += 2 * (k.length + v.length);
    }
    const KB = 1024, MB = KB*1024;
    const human = bytes > MB ? (bytes/MB).toFixed(2)+' MB' : (bytes>KB ? (bytes/KB).toFixed(1)+' KB' : bytes+' B');
    return { bytes, human, keys: localStorage.length };
  }
  function updateStats(){ if (!stats) return; const s = approxSize(); stats.textContent = 'Chaves: ' + s.keys + ' · Tamanho aprox: ' + s.human; }
  // Renderiza a lista de itens no LocalStorage dentro do modal.  Cada item possui campos
  // editáveis para chave e valor, além de botões para salvar ou excluir.
  function renderLS(){
    if (!lsList) return;
    lsList.innerHTML = '';
    const keys = [];
    for (let i=0; i<localStorage.length; i++){
      const k = localStorage.key(i);
      if (k != null) keys.push(k);
    }
    // Ordene as chaves para exibir de forma consistente
    keys.sort();
    keys.forEach((key) => {
      const value = localStorage.getItem(key) ?? '';
      const row = document.createElement('div');
      row.style.display = 'flex';
      row.style.alignItems = 'center';
      row.style.gap = '6px';
      row.style.marginTop = '6px';
      // Campo de chave
      const keyInput = document.createElement('input');
      keyInput.value = key;
      keyInput.placeholder = 'chave';
      keyInput.style.flex = '1 1 30%';
      keyInput.style.padding = '4px';
      keyInput.style.borderRadius = '6px';
      keyInput.style.border = '1px solid rgba(255,255,255,0.15)';
      keyInput.style.background = 'rgba(255,255,255,0.05)';
      keyInput.style.color = 'inherit';
      // Campo de valor
      const valInput = document.createElement('input');
      valInput.value = value;
      valInput.placeholder = 'valor';
      valInput.style.flex = '1 1 50%';
      valInput.style.padding = '4px';
      valInput.style.borderRadius = '6px';
      valInput.style.border = '1px solid rgba(255,255,255,0.15)';
      valInput.style.background = 'rgba(255,255,255,0.05)';
      valInput.style.color = 'inherit';
      // Botão salvar
      const btnSave = document.createElement('button');
      btnSave.textContent = 'Salvar';
      btnSave.className = 'btn fx-trans fx-press ring';
      btnSave.style.fontSize = '11px';
      // Botão excluir
      const btnDel = document.createElement('button');
      btnDel.textContent = 'Del';
      btnDel.className = 'btn fx-trans fx-press ring';
      btnDel.style.fontSize = '11px';
      // Ações
      btnSave.addEventListener('click', () => {
        const newKey = keyInput.value.trim();
        const newVal = valInput.value;
        if (!newKey) { toast('Chave vazia', 'warn'); return; }
        if (newKey !== key) localStorage.removeItem(key);
        try { localStorage.setItem(newKey, newVal); toast('Item salvo', 'ok'); } catch(e){ toast('Erro ao salvar', 'err'); }
        renderLS(); updateStats();
      });
      btnDel.addEventListener('click', () => {
        if (!confirm('Excluir a chave "'+keyInput.value+'"?')) return;
        localStorage.removeItem(keyInput.value);
        renderLS(); updateStats(); toast('Item removido', 'warn');
      });
      row.appendChild(keyInput);
      row.appendChild(valInput);
      row.appendChild(btnSave);
      row.appendChild(btnDel);
      lsList.appendChild(row);
    });
  }
  function openModal(){ if (!modal) return; updateStats(); modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); }
  function closeModal(){ if (!modal) return; modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }

  // Ao abrir o modal, também carregue a lista de itens atuais
  const _openModalRef = openModal;
  function openModalLS(){
    _openModalRef();
    renderLS();
    // Preencha informações do usuário, assistente e arquétipo ativo
    try {
      const uDisplay = document.getElementById('lsUserDisplay');
      const aDisplay = document.getElementById('lsAssistantDisplay');
      const archDisplay = document.getElementById('lsArchDisplay');
      // Tente recuperar o nome do usuário das chaves salvas
      const userName = (localStorage.getItem('dual.name') || localStorage.getItem('infodose:userName') || '').trim();
      const assistantName = (localStorage.getItem('dual.assistantName') || localStorage.getItem('infodose:assistantName') || 'Dual').trim();
      // Obtenha o arquétipo ativo a partir do seletor
      let arch = '';
      const archSel = document.getElementById('arch-select');
      if (archSel && archSel.value) arch = archSel.value.replace(/\.html$/i, '');
      if (uDisplay) uDisplay.textContent = userName || '–';
      if (aDisplay) aDisplay.textContent = assistantName || '–';
      if (archDisplay) archDisplay.textContent = arch || '–';
    } catch {}
    // Botão para recarregar a página
    const btnReload = document.getElementById('lsReloadPage');
    if (btnReload) {
      btnReload.onclick = () => { location.reload(); };
    }
  }
  // Redefina o evento para usar a nova função
  if (btn) btn.addEventListener('click', openModalLS);

  // O botão LS já foi associado à função openModalLS acima.
  if (btnClose) btnClose.addEventListener('click', closeModal);
  if (modal) modal.addEventListener('click', (e)=>{ if (e.target === modal) closeModal(); });

  // Botão para adicionar novo item
  if (btnAdd) btnAdd.addEventListener('click', () => {
    if (!lsList) return;
    // Insira uma nova linha em branco no início para o usuário digitar
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.alignItems = 'center';
    row.style.gap = '6px';
    row.style.marginTop = '6px';
    const keyInput = document.createElement('input');
    keyInput.placeholder = 'nova chave';
    keyInput.style.flex = '1 1 30%';
    keyInput.style.padding = '4px';
    keyInput.style.borderRadius = '6px';
    keyInput.style.border = '1px solid rgba(255,255,255,0.15)';
    keyInput.style.background = 'rgba(255,255,255,0.05)';
    keyInput.style.color = 'inherit';
    const valInput = document.createElement('input');
    valInput.placeholder = 'novo valor';
    valInput.style.flex = '1 1 50%';
    valInput.style.padding = '4px';
    valInput.style.borderRadius = '6px';
    valInput.style.border = '1px solid rgba(255,255,255,0.15)';
    valInput.style.background = 'rgba(255,255,255,0.05)';
    valInput.style.color = 'inherit';
    const btnSave = document.createElement('button');
    btnSave.textContent = 'Salvar';
    btnSave.className = 'btn fx-trans fx-press ring';
    btnSave.style.fontSize = '11px';
    const btnCancel = document.createElement('button');
    btnCancel.textContent = 'Cancelar';
    btnCancel.className = 'btn fx-trans fx-press ring';
    btnCancel.style.fontSize = '11px';
    btnSave.addEventListener('click', () => {
      const newKey = keyInput.value.trim();
      const newVal = valInput.value;
      if (!newKey) { toast('Chave vazia', 'warn'); return; }
      try {
        localStorage.setItem(newKey, newVal);
        toast('Item adicionado', 'ok');
      } catch(e) { toast('Erro ao adicionar', 'err'); }
      renderLS(); updateStats();
    });
    btnCancel.addEventListener('click', () => {
      row.remove();
    });
    row.appendChild(keyInput);
    row.appendChild(valInput);
    row.appendChild(btnSave);
    row.appendChild(btnCancel);
    lsList.prepend(row);
  });

  if (btnExport) btnExport.addEventListener('click', () => {
    const dump = {};
    for (let i=0; i<localStorage.length; i++){ const k = localStorage.key(i); if (!k) continue; dump[k] = localStorage.getItem(k); }
    const blob = new Blob([JSON.stringify({ when: Date.now(), dump }, null, 2)], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'localStorage_backup.json'; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 400);
    toast('LS exportado', 'ok');
  });

  if (btnImport) btnImport.addEventListener('click', () => {
    const inp = document.createElement('input'); inp.type = 'file'; inp.accept = '.json,application/json';
    inp.onchange = (ev) => {
      const f = ev.target.files && ev.target.files[0]; if (!f) return;
      const r = new FileReader();
      r.onload = () => {
        try {
          const obj = JSON.parse(String(r.result||'') || '{}'); const data = obj.dump || obj || {};
          Object.keys(data).forEach(k => { try { localStorage.setItem(k, String(data[k])) } catch{} });
          updateStats(); toast('LS importado', 'ok');
        } catch { toast('Erro no JSON', 'err'); }
      };
      r.readAsText(f);
    };
    inp.click();
  });

  if (btnClear) btnClear.addEventListener('click', () => {
    if (!confirm('Limpar TODO o Local Storage?')) return;
    try { localStorage.clear(); updateStats(); toast('LS limpo', 'warn'); } catch(e){ alert(e.message) }
  });

  if (btnClearIDB) btnClearIDB.addEventListener('click', async () => {
    if (!confirm('Apagar bancos do IndexDB?')) return;
    try {
      if ('databases' in indexedDB) {
        const dbs = await indexedDB.databases();
        for (const db of dbs) { if (db && db.name) indexedDB.deleteDatabase(db.name); }
      } else {
        ['infodose','dual','uno'].forEach(name => { try { indexedDB.deleteDatabase(name) } catch{} });
      }
      toast('IndexDB limpo', 'warn');
    } catch(e){ alert('Falha no IndexDB: ' + e.message) }
  });
})();
</script>

<!-- Script para ocultar o splash screen após o carregamento completo da página -->
<!-- Script adicional para o Stacks estendido: upload de HTML e criação de grupos -->
<script>
(() => {
  const uploadBtn = document.getElementById('btnStackUpload');
  const uploadInput = document.getElementById('stackUpload');
  if (uploadBtn && uploadInput) {
    uploadBtn.addEventListener('click', () => uploadInput.click());
    uploadInput.addEventListener('change', (ev) => {
      const file = ev.target.files && ev.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const content = String(reader.result || '');
        const blob = new Blob([content], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        openApp({ title: file.name.replace(/\.(html?|txt)$/i,''), url });
      };
      reader.readAsText(file);
      // Permite escolher o mesmo arquivo novamente
      ev.target.value = '';
    });
  }
  const btnAddGroup = document.getElementById('btnAddGroup');
  const stackWrapEl = document.getElementById('stackWrap');
  window.currentGroupId = null;
  if (btnAddGroup && stackWrapEl) {
      btnAddGroup.addEventListener('click', () => {
      const name = prompt('Nome do grupo:');
      if (!name) return;
      const gid = 'g_' + Math.random().toString(36).slice(2);
      const details = document.createElement('details');
      details.className = 'stack-group';
      details.setAttribute('data-group-id', gid);
      details.open = true;
      const summary = document.createElement('summary');
      summary.textContent = name;
      const content = document.createElement('div');
      content.className = 'group-content';
      details.appendChild(summary);
      details.appendChild(content);
      stackWrapEl.prepend(details);
      window.currentGroupId = gid;
      // Salve o estado após criar um novo grupo
      try { saveStackState(); } catch {}
    });
  }
})();
</script>
<script>
window.addEventListener('load', () => {
  const splash = document.getElementById('appSplash');
  if (!splash) return;
  // Reproduza o som do splash assim que a página carregar, se houver um elemento de áudio.
  const audioElem = document.getElementById('splashSound');
  if (audioElem) {
    try {
      audioElem.currentTime = 0;
      audioElem.play().catch(() => {
        /* Alguns navegadores bloqueiam a reprodução automática.  Ignore erros aqui. */
      });
    } catch (err) {}
  }
  // Fale durante o splash usando a síntese de voz
  try {
    if (typeof speakSplash === 'function') speakSplash();
  } catch {}
  // Em seguida, faça a saudação completa alguns instantes depois do splash
  try {
    if (typeof speakHomeGreeting === 'function') setTimeout(() => speakHomeGreeting(), 400);
  } catch {}
  // Aguarde um breve instante após o carregamento para garantir que o loader seja exibido.
  // Aumente este valor (ms) para manter o splash por mais tempo. Aqui usamos 1200ms (1.2s).
  setTimeout(() => {
    splash.classList.add('hidden');
    // Remova o elemento do DOM após a transição de opacidade
    setTimeout(() => {
      if (splash && splash.parentNode) splash.parentNode.removeChild(splash);
    }, 400);
  }, 1200);
});
</script>

<!-- Script para persistência de grupos/sessões e apps fixados na navegação -->
<script>
(() => {
  /**
   * Cria um grupo de stack com id e nome fornecidos. Usado ao restaurar grupos.
   * @param {string} gid
   * @param {string} name
   */
  function createStackGroup(gid, name) {
    const stackWrapEl = document.getElementById('stackWrap');
    if (!stackWrapEl) return;
    const details = document.createElement('details');
    details.className = 'stack-group';
    details.setAttribute('data-group-id', gid);
    details.open = true;
    const summary = document.createElement('summary');
    summary.textContent = name;
    const content = document.createElement('div');
    content.className = 'group-content';
    details.appendChild(summary);
    details.appendChild(content);
    stackWrapEl.prepend(details);
  }

  /**
   * Salva a estrutura de grupos e sessões no LocalStorage.
   */
  function saveStackState() {
    try {
      // Salve grupos
      const groups = [];
      document.querySelectorAll('#stackWrap .stack-group').forEach(g => {
        const id = g.getAttribute('data-group-id');
        const name = g.querySelector('summary')?.textContent || '';
        if (id && name) groups.push({ id, name });
      });
      localStorage.setItem('unoStackGroups', JSON.stringify(groups));
      // Salve sessões (Stack e sessionsAnchor)
      const sess = [];
      document.querySelectorAll('#stackWrap .session, #sessionsAnchor .session').forEach(card => {
        const sid = card.dataset.sid;
        const meta = card.dataset.meta;
        const gid = card.dataset.gid || null;
        const min = card.classList.contains('min');
        const pinned = card.classList.contains('pinned');
        if (sid && meta) sess.push({ sid, meta, gid, min, pinned });
      });
      localStorage.setItem('unoStackSessions', JSON.stringify(sess));
    } catch (e) {
      console.warn('Erro ao salvar estado do stack', e);
    }
    // Salve apps fixados (o array já está armazenado em unoPinnedApps via add/remove)
  }
  window.saveStackState = saveStackState;

  /**
   * Garante que existam grupos de stack correspondentes a cada categoria de apps
   * (arquetipos).  Obtém os nomes de grupo da variável RAW.apps e cria
   * grupos com IDs fixos baseados no nome.  Se um grupo já existir, não o
   * duplica.  Use para organizar sessões automaticamente por arquetipo.
   */
  function ensureDefaultGroups() {
    try {
      const stackWrapEl = document.getElementById('stackWrap');
      if (!stackWrapEl) return;
      // Obtenha lista de nomes de grupos a partir dos apps embutidos
      const names = {};
      (RAW.apps || []).forEach(a => {
        if (a && a.title && a.title.includes('·')) {
          const parts = a.title.split('·');
          const gName = (parts[1] || '').trim();
          if (gName) names[gName] = true;
        }
      });
      // Para cada nome, crie grupo se não existir
      Object.keys(names).forEach(name => {
        const gid = 'g_' + name.toLowerCase().replace(/\s+/g, '_');
        if (!document.querySelector('#stackWrap .stack-group[data-group-id="' + gid + '"]')) {
          createStackGroup(gid, name);
        }
      });
    } catch (e) {
      console.warn('Falha ao garantir grupos padrão', e);
    }
  }
  // Exponha função globalmente para poder chamar de outros lugares
  window.ensureDefaultGroups = ensureDefaultGroups;

  /**
   * Restaura grupos e sessões do LocalStorage.
   */
  function restoreStackState() {
    try {
      const groups = JSON.parse(localStorage.getItem('unoStackGroups') || '[]');
      if (Array.isArray(groups)) {
        groups.forEach(g => {
          if (g && g.id && g.name) createStackGroup(g.id, g.name);
        });
      }
      const sessions = JSON.parse(localStorage.getItem('unoStackSessions') || '[]');
      if (Array.isArray(sessions)) {
        sessions.forEach(s => {
          try {
            const meta = JSON.parse(s.meta || '{}');
            openApp({ sid: s.sid, title: meta.title, url: meta.url, gid: s.gid, pinned: s.pinned });
            const card = document.querySelector('[data-sid="' + s.sid + '"]');
            if (card) {
              if (s.min) card.classList.add('min');
            }
          } catch (e) {}
        });
      }
    } catch (e) {
      console.warn('Falha ao restaurar grupos/sessões', e);
    }
    updateDock();
  }
  window.restoreStackState = restoreStackState;

  /**
   * Obtém a lista de apps fixados a partir do LocalStorage.
   * @returns {Array<{title:string,url:string}>}
   */
  function getPinnedList() {
    try { return JSON.parse(localStorage.getItem('unoPinnedApps') || '[]') || []; } catch { return []; }
  }

  /**
   * Atualiza o LocalStorage e a UI com o novo item fixado.
   * Evita duplicatas com base no título e URL.
   * @param {{title:string,url:string}} meta
   */
  function addPinned(meta) {
    if (!meta || !meta.title) return;
    const list = getPinnedList();
    const exists = list.some(item => item.title === meta.title && item.url === meta.url);
    if (!exists) {
      list.push({ title: meta.title, url: meta.url });
      localStorage.setItem('unoPinnedApps', JSON.stringify(list));
    }
    updatePinnedNav();
  }
  window.addPinned = addPinned;

  /**
   * Remove um item fixado com base no título e URL.
   * @param {{title:string,url:string}} meta
   */
  function removePinnedByMeta(meta) {
    if (!meta) return;
    let list = getPinnedList();
    list = list.filter(item => !(item.title === meta.title && item.url === meta.url));
    localStorage.setItem('unoPinnedApps', JSON.stringify(list));
    updatePinnedNav();
  }
  window.removePinnedByMeta = removePinnedByMeta;

  /**
   * Atualiza a barra de navegação para refletir os itens fixados.
   * Cria botões dinâmicos para cada app fixado.
   */
  function updatePinnedNav() {
    const navInner = document.querySelector('.tabbar .inner');
    if (!navInner) return;
    // Remova botões fixados existentes
    navInner.querySelectorAll('button.tab[data-pinned]').forEach(btn => btn.remove());
    const list = getPinnedList();
    list.forEach(item => {
      const btn = document.createElement('button');
      btn.className = 'tab fx-trans fx-press ring';
      btn.setAttribute('data-pinned', 'true');
      btn.title = item.title;
      // Use a primeira letra do título como ícone
      const letter = (item.title || '?').trim().charAt(0).toUpperCase();
      btn.innerHTML = `<span class="pin-letter">${letter}</span><span class="ripple"></span>`;
      btn.onclick = () => {
        openApp({ title: item.title, url: item.url });
      };
      navInner.appendChild(btn);
    });
  }
  window.updatePinnedNav = updatePinnedNav;

  // Restaure o estado e pinte a navegação assim que o DOM estiver pronto
  document.addEventListener('DOMContentLoaded', () => {
    try {
      window.__RESTORING_CHAT = true;
      restoreStackState();
      updatePinnedNav();
    } catch (e) {
      console.warn(e);
    }
  });
})();
</script>
  <!-- Sons da interface.  Coloque os arquivos em sounds/ui/*.wav conforme distribuídos no pacote UNO_UISounds_Pack_v1. -->
  <!-- Use o som Back Action como clique principal -->
  <audio id="sndClick" src="sounds/ui/back-action.wav" preload="auto"></audio>
  <audio id="sndHover" src="sounds/ui/hover.wav" preload="auto"></audio>
  <audio id="sndOpen" src="sounds/ui/open.wav" preload="auto"></audio>
  <audio id="sndClose" src="sounds/ui/close.wav" preload="auto"></audio>
  <audio id="sndTab" src="sounds/ui/tab.wav" preload="auto"></audio>
  <audio id="sndNav" src="sounds/ui/nav.wav" preload="auto"></audio>
  <audio id="sndBack" src="sounds/ui/back.wav" preload="auto"></audio>
  <audio id="sndDrag" src="sounds/ui/drag.wav" preload="auto"></audio>
  <audio id="sndSuccess" src="sounds/ui/success.wav" preload="auto"></audio>
  <audio id="sndWarn" src="sounds/ui/warn.wav" preload="auto"></audio>
  <audio id="sndError" src="sounds/ui/error.wav" preload="auto"></audio>
  <!-- Som Tech Pop usado para ações especiais (ex: salvar nome) -->
  <audio id="sndTechPop" src="sounds/ui/tech-pop.wav" preload="auto"></audio>
  <script>
  // Associe sons aos principais elementos de interface.  Cada botão com a
  // classe .btn toca o som de clique; os itens de navegação tocam som de
  // tab ou nav; a abertura/fechamento de sessões dispara sons específicos.
  (function(){
    const getAudio = id => document.getElementById(id);
    const play = (id) => {
      const audio = getAudio(id);
      if (audio) {
        try { audio.currentTime = 0; audio.play(); } catch {}
      }
    };
    // Clique em qualquer botão
    document.body.addEventListener('click', (e) => {
      const btn = e.target.closest('.btn');
      if (btn) play('sndClick');
      // Navegação inferior (tabs)
      const navBtn = e.target.closest('nav .btn');
      if (navBtn) play('sndTab');
    });
    // Hover (mouseenter) em botões
    document.body.addEventListener('mouseenter', (e) => {
      const btn = e.target.closest('.btn');
      if (btn) play('sndHover');
    }, true);
    // Sobrescreva open/close de sessões para tocar sons
    window.playOpenSound = () => play('sndOpen');
    window.playCloseSound = () => play('sndClose');
    // Exponha também som especial Tech Pop
    window.playTechPopSound = () => play('sndTechPop');
  })();
  </script>

<style id="chatplus-styles">

/* ===== ChatPlus (emoji buttons, 3-block replies, HTML rendering) ===== */
#chatFeed .msg.ai-rich {
  background: rgba(57,255,182,0.12);
  border-radius: 16px 16px 16px 0;
  padding: 8px 12px;
  max-width: 75%;
}
#chatFeed .ai-block {
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 12px;
  margin: 6px 0;
  overflow: hidden;
  background: rgba(15, 17, 32, 0.5);
}
#chatFeed .ai-block > summary {
  list-style: none;
  cursor: pointer;
  font-weight: 800;
  padding: 8px 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}
#chatFeed .ai-block > summary::-webkit-details-marker { display: none; }
#chatFeed .ai-block .block-body {
  padding: 8px 10px;
  line-height: 1.55;
}
#chatFeed .ai-block .block-body :where(p, ul, ol, pre, code, h1, h2, h3, h4, h5, h6) { margin: 6px 0 }
#chatFeed .ai-block .block-body pre {
  background: rgba(0,0,0,.35);
  padding: 8px;
  border-radius: 8px;
  overflow:auto;
}
/* Emoji buttons */
.emoji-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  margin: 0 2px;
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.18);
  background: rgba(255,255,255,0.06);
  cursor: pointer;
  font-size: 18px;
  line-height: 1;
  transition: transform .12s var(--ease), background .2s var(--ease);
}
.emoji-btn:hover { transform: translateY(-1px); background: rgba(255,255,255,0.1); }
.emoji-suggestions {
  margin-top: 6px;
  display: flex; flex-wrap: wrap; gap: 4px;
}
/* Rendered HTML box (safe) */
.render-html {
  border: 1px dashed rgba(255,255,255,0.18);
  background: rgba(255,255,255,0.03);
  padding: 8px;
  border-radius: 10px;
}
.render-html iframe {
  width: 100%; border: 0; background: #0b0f14; border-radius: 8px;
}

</style>
<script>
// ===================== ChatPlus — v1 (2025-09-26) =====================
// Adds: emoji buttons, 3-block expandable answers, safe HTML rendering,
// autosave + compaction, and speech cues "Pulso enviado / Recebendo intenção".

(function(){
  const $ = (q, r=document)=>r.querySelector(q);
  const $$ = (q, r=document)=>Array.from(r.querySelectorAll(q));
  const LS = {
    get: (k, d) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d } catch { return d } },
    set: (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)) } catch {} },
    raw:(k)=>localStorage.getItem(k)||''
  };

  // ---------- 1) Safe HTML sanitizer ----------
  function sanitizeHTML(input){
    try{
      const parser = new DOMParser();
      const doc = parser.parseFromString(String(input||''), 'text/html');
      const disallowed = ['script','style','link','iframe','object','embed','meta'];
      disallowed.forEach(tag => doc.querySelectorAll(tag).forEach(n=>n.remove()));
      // Remove on* attributes and style; harden URLs
      const walker = doc.createTreeWalker(doc.body, NodeFilter.SHOW_ELEMENT);
      const allowedProtocols = ['http:', 'https:', 'data:'];
      while (walker.nextNode()) {
        const el = walker.currentNode;
        // Remove event handlers and style
        [...el.attributes].forEach(a => {
          if (/^on/i.test(a.name) || a.name === 'style') el.removeAttribute(a.name);
        });
        if (el.tagName === 'A') {
          el.setAttribute('target', '_blank');
          el.setAttribute('rel', 'noopener noreferrer');
          const href = el.getAttribute('href') || '';
          try {
            const u = new URL(href, location.href);
            if (!allowedProtocols.includes(u.protocol)) el.removeAttribute('href');
          } catch { el.removeAttribute('href'); }
        }
        if (el.tagName === 'IMG') {
          const src = el.getAttribute('src') || '';
          if (!/^https?:|^data:image\//i.test(src)) {
            el.removeAttribute('src');
          } else if (src.startsWith('data:') && src.length > 200000) {
            el.setAttribute('src', '');
          }
          el.setAttribute('loading','lazy');
          el.setAttribute('decoding','async');
          el.style.maxWidth = '100%';
          el.style.height = 'auto';
          el.style.borderRadius = '8px';
        }
      }
      return doc.body.innerHTML;
    }catch(e){
      return String(input||'').replace(/[<>]/g, c => c === '<' ? '&lt;' : '&gt;');
    }
  }

  // ---------- 2) Emoji wrapper & quick-reply ----------
  const emojiRegex = /([\p{Extended_Pictographic}\u2600-\u27BF](?:\uFE0F|\u200D[\p{Extended_Pictographic}\u2600-\u27BF])*)/gu;
  function wrapEmojisInEl(root){
    if (!root) return;
    // Walk text nodes and replace emojis with buttons
    const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT);
    const toReplace = [];
    while (walker.nextNode()) {
      const node = walker.currentNode;
      if (!node.nodeValue) continue;
      if (emojiRegex.test(node.nodeValue)) {
        toReplace.push(node);
      }
      emojiRegex.lastIndex = 0;
    }
    toReplace.forEach(node => {
      const frag = document.createDocumentFragment();
      const parts = node.nodeValue.split(emojiRegex);
      parts.forEach(part => {
        if (!part) return;
        if (emojiRegex.test(part)) {
          const btn = document.createElement('button');
          btn.className = 'emoji-btn';
          btn.textContent = part;
          btn.setAttribute('data-emoji', part);
          frag.appendChild(btn);
          emojiRegex.lastIndex = 0;
        } else {
          frag.appendChild(document.createTextNode(part));
        }
      });
      node.parentNode.replaceChild(frag, node);
    });
  }

  // Delegation: clicking an emoji sends it as a new message
  const chatFeed = document.getElementById('chatFeed');
  if (chatFeed) {
    chatFeed.addEventListener('click', (e) => {
      const btn = e.target.closest('.emoji-btn');
      if (!btn) return;
      const emoji = btn.getAttribute('data-emoji') || btn.textContent || '';
      if (emoji) {
        if (typeof window.sendUserMessage === 'function') {
          window.sendUserMessage(emoji);
        }
      }
    });
  }

  // ---------- 3) Chat store + compaction ----------
  const ChatStore = {
    key: 'uno:chat:v2',
    memKey: 'uno:chat:mem',
    maxPairs: 12,
    maxChars: 100000,
    load(){ return LS.get(this.key, []); },
    save(list){ LS.set(this.key, list||[]); },
    memory(){ return LS.get(this.memKey, ''); },
    setMemory(text){ LS.set(this.memKey, String(text||'')); },
    append(role, content){
      const list = this.load();
      list.push({ role, content: String(content||''), ts: Date.now() });
      this.save(list);
      this.compact();
    },
    clear(){ LS.set(this.key, []); LS.set(this.memKey, ''); },
    compact(){
      try {
        let list = this.load();
        const textLen = list.map(x => x.content||'').join('\n').length;
        if (list.length > 120 || textLen > this.maxChars) {
          const keep = list.filter(m => m.role === 'user' || m.role === 'assistant');
          // Keep last N pairs, summarize the rest
          const cutoffIndex = Math.max(0, keep.length - (this.maxPairs*2));
          const older = keep.slice(0, cutoffIndex);
          const newer = keep.slice(cutoffIndex);
          const summary = this.naiveSummarize(older);
          this.setMemory(summary);
          // Rebuild list with summary marker + newer
          const rebuilt = [];
          if (summary) rebuilt.push({ role: 'system', content: 'Contexto resumido: ' + summary, ts: Date.now() });
          newer.forEach(m => rebuilt.push(m));
          this.save(rebuilt);
        }
      } catch (e) {}
    },
    naiveSummarize(msgs){
      if (!Array.isArray(msgs) || !msgs.length) return '';
      const lines = [];
      let count = 0;
      for (const m of msgs) {
        const role = m.role === 'assistant' ? 'IA' : (m.role === 'user' ? 'Você' : m.role);
        const t = String(m.content||'').replace(/\s+/g,' ').trim();
        if (!t) continue;
        const first = t.split(/[.!?]/)[0];
        if (first) {
          lines.push('• ' + role + ': ' + first.slice(0, 160));
          count += first.length;
        }
        if (count > 1200) break;
      }
      return lines.join('\n');
    },
    buildMessages(userContent){
      // System directives to enforce 3 blocks.
      const sys = {
        role: 'system',
        content: [
          'Você é um assistente em português.',
          'Estruture SEMPRE a resposta em 3 blocos, com estes títulos exatos:',
          '### Recompensa Inicial',
          '### Curiosidade & Expansão',
          '### Antecipação Vibracional',
          'Cada bloco pode conter HTML simples seguro (sem scripts).'
        ].join(' ')
      };
      const memory = this.memory();
      const memMsg = memory ? { role: 'system', content: 'Contexto resumido (memória):\n' + memory } : null;
      const prev = this.load().filter(m => m.role === 'user' || m.role === 'assistant');
      // Keep last pairs
      const sliceStart = Math.max(0, prev.length - (this.maxPairs*2));
      const context = prev.slice(sliceStart);
      const msgs = [sys];
      if (memMsg) msgs.push(memMsg);
      context.forEach(m => msgs.push({ role: m.role === 'assistant' ? 'assistant' : 'user', content: m.content }));
      msgs.push({ role: 'user', content: userContent });
      return msgs;
    }
  };
  window.ChatStore = ChatStore;

  // ---------- 4) Render expandable 3-block reply with optional HTML ----------
  function extractHTMLFromFences(text){
    const m = /```html\s*([\s\S]*?)\s*```/i.exec(text||'');
    return m ? m[1] : null;
  }
  function splitIntoBlocks(raw){
    const t = String(raw||'');
    const re1 = /###\s*Recompensa\s*Inicial[\s\S]*?(?=###\s*Curiosidade\s*&\s*Expans[aã]o|$)/i;
    const re2 = /###\s*Curiosidade\s*&\s*Expans[aã]o[\s\S]*?(?=###\s*Antecip[aã]o\s*Vibracional|$)/i;
    const re3 = /###\s*Antecip[aã]o\s*Vibracional[\s\S]*/i;
    const b1 = (t.match(re1)||[''])[0].replace(/###.*?\n?/,'').trim();
    const b2 = (t.match(re2)||[''])[0].replace(/###.*?\n?/,'').trim();
    const b3 = (t.match(re3)||[''])[0].replace(/###.*?\n?/,'').trim();
    if (b1 || b2 || b3) return { reward:b1, curious:b2, vibe:b3 };
    // Fallback: split roughly
    const parts = t.split(/\n\n+/);
    const n = parts.length;
    const reward = parts.slice(0, Math.max(1, Math.ceil(n*0.3))).join('\n\n');
    const curious = parts.slice(Math.max(1, Math.ceil(n*0.3)), Math.max(2, Math.ceil(n*0.7))).join('\n\n');
    const vibe = parts.slice(Math.max(2, Math.ceil(n*0.7))).join('\n\n');
    return { reward, curious, vibe };
  }
  function paraToHTML(s){
    const esc = s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    return esc.split(/\n{2,}/).map(p => '<p>'+p.replace(/\n/g,'<br>')+'</p>').join('');
  }
  function createBlockEl(title, content){
    const details = document.createElement('details');
    details.className = 'ai-block';
    const summary = document.createElement('summary');
    summary.innerHTML = title;
    const body = document.createElement('div');
    body.className = 'block-body';
    // If fenced HTML present, render sanitized HTML
    const fenced = extractHTMLFromFences(content||'');
    if (fenced) {
      const safe = sanitizeHTML(fenced);
      body.innerHTML = '<div class="render-html">'+ safe +'</div>';
    } else if (/<[a-z][\s\S]*>/i.test(content||'')) {
      body.innerHTML = '<div class="render-html">'+ sanitizeHTML(content) +'</div>';
    } else {
      body.innerHTML = paraToHTML(content||'');
    }
    details.appendChild(summary);
    details.appendChild(body);
    return details;
  }
  function renderAssistantReply(raw){
    const feed = document.getElementById('chatFeed');
    if (!feed) return;
    const { reward, curious, vibe } = splitIntoBlocks(raw||'');
    const wrap = document.createElement('div');
    wrap.className = 'msg ai ai-rich';
    // Build the three blocks
    const b1 = createBlockEl('1) <strong>Recompensa Inicial</strong> ⚡', reward||'');
    const b2 = createBlockEl('2) <strong>Curiosidade &amp; Expansão</strong> 🔎', curious||'');
    const b3 = createBlockEl('3) <strong>Antecipação Vibracional</strong> ✨', vibe||'');
    // Open first block by default
    b1.open = true;
    wrap.appendChild(b1);
    wrap.appendChild(b2);
    wrap.appendChild(b3);
    // Extract emojis to suggestion row
    const ems = (raw||'').match(/([\p{Extended_Pictographic}\u2600-\u27BF])/gu) || [];
    const uniq = Array.from(new Set(ems)).slice(0,8);
    if (uniq.length) {
      const sug = document.createElement('div');
      sug.className = 'emoji-suggestions';
      uniq.forEach(e => {
        const btn = document.createElement('button');
        btn.className = 'emoji-btn';
        btn.textContent = e;
        btn.setAttribute('data-emoji', e);
        sug.appendChild(btn);
      });
      wrap.appendChild(sug);
    }
    feed.appendChild(wrap);
    wrapEmojisInEl(wrap);
    feed.scrollTop = feed.scrollHeight;
    // Update preview and voice (speak only the reward block text stripped)
    try {
      const txt = (reward||'').replace(/<[^>]*>/g,'').replace(/```[\s\S]*?```/g,'').trim();
      if (typeof updatePreview === 'function') updatePreview(txt || (raw||'').slice(0,180));
      if (typeof speakWithActiveArch === 'function' && txt) speakWithActiveArch(txt);
    } catch{}
    // Save to chat store
    try { if (!window.__RESTORING_CHAT) ChatStore.append('assistant', raw||''); } catch{}
  }
  window.renderAssistantReply = renderAssistantReply;

  // ---------- 5) Unified sendUserMessage ----------
  async function sendUserMessage(msg){
    const text = String(msg||'').trim();
    if (!text) return;
    // Show in feeds + voice status
    if (typeof feedPush === 'function') feedPush('user', 'Você: ' + text);
    try {
      if (typeof showArchMessage === 'function') showArchMessage('Pulso enviado. Recebendo intenção…', 'ok');
      if (typeof speakWithActiveArch === 'function') {
        speakWithActiveArch('Pulso enviado');
        setTimeout(()=>speakWithActiveArch('Recebendo intenção'), 380);
      }
    } catch{}
    if (typeof feedPush === 'function') feedPush('status', '⚡ Pulso enviado · recebendo intenção…');
    try { ChatStore.append('user', text); } catch{}
    // Build OpenRouter call
    const userName = (localStorage.getItem('dual.name') || localStorage.getItem('infodose:userName') || '').trim();
    const sk = (localStorage.getItem('dual.keys.openrouter') || localStorage.getItem('infodose:sk') || '').trim();
    let model = (window.LS && LS.get && LS.get('dual.openrouter.model')) || (localStorage.getItem('infodose:model') || '').trim() || 'openrouter/auto';
    // Call
    try {
      const reply = await sendAIMessageCtx({ userContent: text, sk, model });
      if (reply) {
        renderAssistantReply(reply);
      }
    } catch (err) {
      console.error(err);
      if (typeof feedPush === 'function') feedPush('status', '❌ Erro ao obter resposta.');
    }
  }
  window.sendUserMessage = sendUserMessage;

  // ---------- 6) Override/extend existing functions non-intrusively ----------
  // a) StartSpeech: override to route to sendUserMessage()
  if (typeof startSpeechConversation === 'function') {
    window._startSpeechConversationOrig = startSpeechConversation;
  }
  window.startSpeechConversation = function(userName, sk, model){
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      try { showArchMessage('Reconhecimento de fala não suportado neste navegador.', 'err'); } catch {}
      try { feedPush('status', '❌ Reconhecimento de fala não suportado.'); } catch {}
      return;
    }
    const recognition = new SpeechRecognition();
    recognition.lang = 'pt-BR';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    recognition.onstart = () => {
      try { showArchMessage('Estou ouvindo…', 'ok'); } catch {}
      try { feedPush('status', '🎙️ Ouvindo…'); } catch {}
    };
    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript.trim();
      if (transcript) sendUserMessage(transcript);
    };
    recognition.onerror = (e) => {
      console.error('Erro no reconhecimento de fala:', e);
      try { showArchMessage('Erro no reconhecimento de fala.', 'err'); } catch {}
      try { feedPush('status', '❌ Erro no reconhecimento de fala.'); } catch {}
    };
    recognition.start();
  };

  // b) Override sendAIMessage to support full context + 3-block instruction
  if (typeof sendAIMessage === 'function') window._sendAIMessageOrig = sendAIMessage;
  async function sendAIMessageCtx({ userContent, sk, model }){
    const url = 'https://openrouter.ai/api/v1/chat/completions';
    const messages = ChatStore.buildMessages(userContent);
    const payload = {
      model: model,
      messages: messages,
      max_tokens: 600,
      temperature: 0.7
    };
    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${sk}`
      },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error('Erro na API: ' + res.status);
    const data = await res.json();
    const reply = data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content;
    return reply || '';
  }
  window.sendAIMessageCtx = sendAIMessageCtx;
  window.sendAIMessage = async function(content, sk, model){
    return sendAIMessageCtx({ userContent: content, sk, model });
  };

  // c) Wrap openApp to speak app title on open
  if (typeof openApp === 'function') {
    const _openApp = openApp;
    window.openApp = function(a){
      try {
        if (typeof speakWithActiveArch === 'function') speakWithActiveArch('Abrindo ' + (a && (a.title||'app')));
      } catch{}
      return _openApp(a);
    }
  }

  // d) Force app card titles to 2 words + ellipsis (post-render safety)
  if (typeof cardApp === 'function') {
    const _cardApp = cardApp;
    window.cardApp = function(a){
      const el = _cardApp(a);
      try {
        const fullTitle = String(a.title || a.key || '').trim();
        const words = fullTitle.split(/\s+/);
        const two = words.slice(0,2).join(' ');
        const display = words.length > 2 ? two + '…' : two;
        const tEl = el.querySelector('.app-title');
        if (tEl) { tEl.textContent = display || fullTitle; tEl.title = fullTitle; }
      } catch{}
      return el;
    }
  }

  // e) Feed autosave: patch feedPush/chatPush to store messages (without breaking UI)
  const _feedPush = (typeof feedPush === 'function') ? feedPush : null;
  window.feedPush = function(type, text){
    if (_feedPush) _feedPush(type, text);
    try {
      if (type === 'user') {
        const t = String(text||'').replace(/^Você:\s*/i,'');
        ChatStore.append('user', t);
      } else if (type === 'ai') {
        const t = String(text||'').replace(/^[^:]+:\s*/i,'');
        ChatStore.append('assistant', t);
      }
    } catch {}
  };
  if (typeof chatPush === 'function') {
    const _chatPush = chatPush;
    window.chatPush = function(type, text){
      _chatPush(type, text);
      try {
        if (type === 'user') {
          const t = String(text||'').replace(/^Você:\s*/i,'');
          ChatStore.append('user', t);
        } else if (type === 'ai') {
          const t = String(text||'').replace(/^[^:]+:\s*/i,'');
          ChatStore.append('assistant', t);
        }
      } catch {}
    }
  }

  // ---------- 7) Restore chat on load ----------
  document.addEventListener('DOMContentLoaded', () => {
    try {
      window.__RESTORING_CHAT = true;
      const list = ChatStore.load();
      if (!list || !list.length) return;
      const feed = document.getElementById('chatFeed');
      if (!feed) return;
      list.forEach(m => {
        if (m.role === 'assistant') {
          // Render as blocks if possible
          window.renderAssistantReply(m.content);
        } else if (m.role === 'user') {
          const div = document.createElement('div');
          div.className = 'msg user';
          div.textContent = 'Você: ' + (m.content||'');
          feed.appendChild(div);
        }
      });
      feed.scrollTop = feed.scrollHeight;
      window.__RESTORING_CHAT = false;
    } catch (e) { console.warn('Restore chat failed', e); window.__RESTORING_CHAT = false; }
  });

  // ---------- 8) Intercept home input form submit (capture) to route to sendUserMessage ----------
  document.addEventListener('DOMContentLoaded', () => {
    const hiForm = document.getElementById('homeInputForm');
    const hiInput = document.getElementById('homeInput');
    if (hiForm && hiInput) {
      hiForm.addEventListener('submit', (ev) => {
        ev.preventDefault();
        ev.stopPropagation();
        ev.stopImmediatePropagation();
        const msg = (hiInput.value || '').trim();
        if (msg) window.sendUserMessage(msg);
        hiInput.value = '';
        return false;
      }, true); // capture to preempt previous handler
    }
  });

})(); // end ChatPlus
</script>
  <script src="dual_multiagent_v1.js"></script>
  <script src="dual_multiagent_v12_locked.js"></script>
  <script src="openrouter_hardlock_model_v1.js" defer=""></script>


<style>
/* --------------------------------------------
   KOBLLUX • Compact Mode — Mobile-first Vertical
   Colar após o CSS atual
--------------------------------------------- */

/* Base compacta + segurança */
*,
*::before,
*::after { box-sizing: border-box; }
html, body { max-width: 100%; overflow-x: hidden; }
body { padding-bottom: calc(16px + env(safe-area-inset-bottom)); }

/* Container nunca estoura, sem “gambiarra” de largura */
.response-container {
  inline-size: min(100%, calc(100% - 0px)) !important;
  padding: 1rem 0 2.75rem; /* + espaço safe-area já no body */
}

/* Nada lado a lado por padrão — empilha tudo */
.row,
.controls,
.kv,
.columns,
.split {
  display: block !important;
}

/* Qualquer tentativa de grid vira 1 coluna */
[class*="grid"],
[style*="grid-template-columns"],
.columns,
.split,
.panel,
.kv {
  display: grid !important;
  grid-template-columns: 1fr !important;
  align-items: stretch;
  gap: .5rem !important;
}

/* Pares “key→value” agora empilhados */
.kv > * { margin: 0 0 .4rem 0; }

/* Grupos de controles em coluna, ocupando 100% */
.controls .group {
  display: block !important;
  width: 100%;
  padding: .5rem .6rem;
  margin: 0 0 .6rem 0;
}
.controls .group > label,
.controls .group > select,
.controls .group > input,
.controls .group > button { display: block; width: 100%; }

/* Botões e inputs: alvo de toque ≥44px */
.btn,
select,
input[type="text"],
input[type="file"],
input[type="range"],
input[type="checkbox"],
input[type="radio"],
label[for],
textarea {
  min-height: 44px;
}

/* Botão Único: respeita safe-area no iOS */
#btnKOBLLUX { 
  bottom: calc(1rem + env(safe-area-inset-bottom));
}

/* Navegações/chips SOMENTE na header: scroll horizontal, sem wrap */
.header .row {
  display: block !important;
  overflow-x: auto;
  white-space: nowrap;
  scrollbar-width: thin;
  -webkit-overflow-scrolling: touch;
  padding-bottom: .25rem;
  margin-bottom: .25rem;
}
.header .row > * {
  display: inline-block;
  vertical-align: top;
  margin-right: .5rem;
}

/* Dropzone 100% vertical */
.dropzone .dz-area { display: block !important; }
.dropzone .row { display: block !important; }
.dropzone .row > * { display: block; width: 100%; margin: .5rem 0 0; }

/* Editor e Preview sempre empilhados (Preview abaixo)
   Use #analysis como Preview, ou crie #preview se preferir. */
.editor {
  width: 100%;
  min-height: 48vh;
  height: 52vh;          /* alvo ~50–60vh */
  max-height: 60vh;
  overflow: auto;
}
#analysis,
#preview {
  display: block;
  width: 100%;
  min-height: 42vh;
  height: 50vh;          /* alvo ~50–60vh */
  max-height: 60vh;
  overflow: auto;
  white-space: pre-wrap;  /* evita overflow lateral */
  word-wrap: break-word;
}

/* Cards/listas/painéis: pilha vertical com scroll interno quando necessário */
.response-block.glass,
.panel {
  max-height: unset;     /* deixe rolar a página */
}
.panel[data-scroll],
.response-block.glass[data-scroll],
.card[data-scroll],
[list][data-scroll] {
  max-height: 60vh;
  overflow: auto;
}

/* Controles verticais: sliders + labels exibidos em coluna */
.controls label { margin: 0 0 .25rem 0; }
.controls input[type="range"] { margin: .25rem 0 .5rem; }

/* Sliders com preenchimento dinâmico (mantém seu gradiente) */
input[type="range"]{
  /* estes tokens são calculados por JS no seu app, mantidos aqui */
  inline-size: 100%;
}

/* Toggle (Auto‑detectar): aumenta para tap ≥44px */
#autoDetect{
  --w: 72px; --h: 44px; --pad: 4px;
  min-height: 44px;
}

/* SELECT e BTN ocupam a linha inteira no modo compact */
select,
.btn { width: 100%; }

/* Grids/tabelas internas que insistem em múltiplas colunas → força 1fr */
[role="grid"],
[role="table"],
table,
.table,
.list,
.cards,
.cards-grid,
.items-grid {
  display: grid !important;
  grid-template-columns: 1fr !important;
}

/* Editor/Preview evitando sangrar lateralmente (longas strings/URLs) */
.editor,
pre { word-break: break-word; }

/* Header único (nenhum footer fixo) — nenhuma regra extra de footer */

/* Safe-area e “tap spacing” no rodapé de ações flutuantes/badges */
.badge-reopen { 
  bottom: calc(1rem + env(safe-area-inset-bottom));
}

/* Animação e sombras mais discretas (versão compact) */
.glass { padding: .75rem .9rem; }
.btn { padding: .7rem 1rem; }

/* Scroll horizontal utilitário (caso queira aplicar em outra nav) */
.h-scroll { overflow-x: auto; white-space: nowrap; }
.h-scroll > * { display: inline-block; }

/* Qualquer .columns e .split SEMPRE block (reforço final) */
.columns, .split { display: block !important; }

/* Segurança extra: força colunas únicas em componentes “teimosos” */
[class*="columns-"],
[class*="cols-"],
[class*="grid-"] {
  grid-template-columns: 1fr !important;
}

/* Evitar wrap de ícones/textos em chips sem quebrar layout */
.pill { display: inline-block; }

/* Garantir que iFrame seguro não crie overflow lateral */
.ifr { inline-size: 100%; max-inline-size: 100%; }
.ifr .bar { display: block; }
.ifr .bar .spacer { display: none; }
.ifr .bar .btn,
.ifr .bar .btn.ghost { width: 100%; margin-top: .4rem; }

/* Acessibilidade: foco visível “compact” */
:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(57,255,182,.18); }

/* Restrições finais — nada lado a lado fora da header */
main .row { display: block !important; }
main .row > * + * { margin-top: .5rem; }

/* (Opcional) reduz micro gaps gerais para versão compacta */
.stack { gap: .5rem !important; }

</style>


<script id="patch-visual-presets">
(function(){
  // Helpers
  const $ = (q, r = document) => r.querySelector(q);
  const LS = {
    get: (k, d) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d } catch (e) { return d } },
    set: (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)) } catch (e) {} }
  };

  // Inject "Blue‑1" into theme select if missing
  document.addEventListener('DOMContentLoaded', function(){
    try {
      const sel = document.getElementById('themeSelect');
      if (sel && !Array.from(sel.options).some(o => o.value === 'blue1')) {
        const opt = document.createElement('option');
        opt.value = 'blue1'; opt.textContent = 'Blue‑1 (azul)';
        sel.appendChild(opt);
      }
    } catch(e){}
  });

  // Build and inject a Visual & 3D card into Brain view (non-destructive)
  document.addEventListener('DOMContentLoaded', function(){
    const grid = document.querySelector('#v-brain .grid');
    if (!grid) return;
    const panel = document.createElement('div');
    panel.className = 'card fx-trans fx-lift';
    panel.style.display = 'block';
    panel.innerHTML = `
      <div style="font-weight:800">Visual & 3D (presets)</div>
      <div style="margin-top:8px;display:grid;gap:10px">
        <label style="display:flex;align-items:center;gap:8px">
          <span>Preset:</span>
          <select id="visualPreset" class="input ring" style="max-width:260px">
            <option value="blue1">Blue‑1 (shader)</option>
            <option value="strong">Strong</option>
            <option value="cinematic-soft">Cinematic Soft</option>
          </select>
        </label>
        <label style="display:flex;align-items:center;gap:8px">
          <input id="overlayToggle" type="checkbox" />
          <span>Overlay de cor por arquétipo</span>
        </label>
        <label style="display:flex;align-items:center;gap:8px">
          <input id="bloomToggle" type="checkbox" />
          <span>Bloom fotográfico (post)</span>
        </label>
        <label style="display:flex;align-items:center;gap:8px">
          <span>Glow/Toon:</span>
          <input id="glowRange" type="range" min="0" max="1" step="0.05" style="flex:1" />
          <span id="glowVal" class="mut" style="width:42px;text-align:right">0.80</span>
        </label>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="applyVisual" class="btn prime fx-trans fx-press ring">Aplicar<span class="ripple"></span></button>
          <button id="resetVisual" class="btn fx-trans fx-press ring">Padrão<span class="ripple"></span></button>
        </div>
        <div class="mut" style="font-size:11px">
          As preferências são salvas no seu navegador e enviadas ao arquétipo ativo.
        </div>
      </div>
    `;
    grid.appendChild(panel);

    // Defaults
    const defaults = {
      preset: LS.get('arch:visualPreset', 'blue1'),
      overlayOn: LS.get('arch:overlayOn', false),
      bloomOn: LS.get('arch:bloomOn', false),
      glow: LS.get('arch:glowStrength', 0.80)
    };

    // UI references
    const selPreset = $('#visualPreset', panel);
    const chkOverlay = $('#overlayToggle', panel);
    const chkBloom = $('#bloomToggle', panel);
    const rngGlow = $('#glowRange', panel);
    const spnGlow = $('#glowVal', panel);
    const btnApply = $('#applyVisual', panel);
    const btnReset = $('#resetVisual', panel);

    // Populate
    selPreset.value = defaults.preset;
    chkOverlay.checked = !!defaults.overlayOn;
    chkBloom.checked = !!defaults.bloomOn;
    rngGlow.value = defaults.glow;
    spnGlow.textContent = Number(defaults.glow).toFixed(2);

    rngGlow.addEventListener('input', () => { spnGlow.textContent = Number(rngGlow.value).toFixed(2); });

    function saveAndApply(){
      const state = {
        preset: selPreset.value,
        overlayOn: !!chkOverlay.checked,
        bloomOn: !!chkBloom.checked,
        glow: Number(rngGlow.value)
      };
      LS.set('arch:visualPreset', state.preset);
      LS.set('arch:overlayOn', state.overlayOn);
      LS.set('arch:bloomOn', state.bloomOn);
      LS.set('arch:glowStrength', state.glow);
      // Update overlay color right away
      try {
        const sel = document.getElementById('arch-select');
        const base = (sel?.value || '').replace(/\.html$/i, '');
        if (window.applyArchOverlay) window.applyArchOverlay(base);
      } catch(e){}
      // Send to iframe
      try { sendVisualSettingsToFrame(); } catch(e){}
    }

    btnApply.addEventListener('click', saveAndApply);
    btnReset.addEventListener('click', () => {
      selPreset.value = 'blue1';
      chkOverlay.checked = false;
      chkBloom.checked = false;
      rngGlow.value = 0.80;
      spnGlow.textContent = '0.80';
      saveAndApply();
    });
  });

  // Canonical overlay colors for the 12 archetypes
  const ARCH_OVERLAYS_PATCHED = {
    atlas:  'rgba(64,158,255,0.22)',
    nova:   'rgba(255,82,177,0.22)',
    vitalis:'rgba(87,207,112,0.22)',
    pulse:  'rgba(0,191,255,0.22)',
    artemis:'rgba(255,195,0,0.22)',
    serena: 'rgba(186,130,219,0.22)',
    kaos:   'rgba(255,77,109,0.22)',
    genus:  'rgba(87,207,112,0.22)',
    lumine: 'rgba(255,213,79,0.22)',
    solus:  'rgba(186,130,219,0.22)',
    rhea:   'rgba(0,209,178,0.22)',
    aion:   'rgba(255,159,67,0.22)',
    default:'rgba(255,255,255,0.0)'
  };

  // Override applyArchOverlay to honor overlay toggle
  (function overrideApplyArchOverlay(){
    const LSget = (k,d)=>{ try{ const v = localStorage.getItem(k); return v?JSON.parse(v):d }catch(e){ return d } };
    window.applyArchOverlay = function(name){
      const key = (name || '').toLowerCase();
      const on = !!LSget('arch:overlayOn', false);
      const color = on ? (ARCH_OVERLAYS_PATCHED[key] || ARCH_OVERLAYS_PATCHED.default) : 'rgba(0,0,0,0)';
      document.documentElement.style.setProperty('--arch-overlay', color);
    };
    // Apply once at startup for current selection
    document.addEventListener('DOMContentLoaded', function(){
      const sel = document.getElementById('arch-select');
      const base = (sel?.value || '').replace(/\.html$/i, '');
      window.applyArchOverlay(base);
    });
  })();

  // PostMessage: send visual settings to archetype iframe
  function currentVisualSettings(){
    const LSget = (k,d)=>{ try{ const v = localStorage.getItem(k); return v?JSON.parse(v):d }catch(e){ return d } };
    return {
      preset: LSget('arch:visualPreset','blue1'),
      bloom: !!LSget('arch:bloomOn', false),
      glow: Number(LSget('arch:glowStrength', 0.80)),
      overlayOn: !!LSget('arch:overlayOn', false)
    };
  }
  window.sendVisualSettingsToFrame = function(){
    try {
      const f = document.getElementById('arch-frame');
      if (f && f.contentWindow) {
        f.contentWindow.postMessage({ type:'visualSettings', data: currentVisualSettings() }, '*');
      }
    } catch(e){}
  };

  // Send settings whenever the iframe loads or signals readiness
  document.addEventListener('DOMContentLoaded', function(){
    const f = document.getElementById('arch-frame');
    if (f) {
      f.addEventListener('load', () => { try { sendVisualSettingsToFrame(); } catch(e){} });
      // small delay to ensure child is ready
      setTimeout(() => { try { sendVisualSettingsToFrame(); } catch(e){} }, 800);
    }
  });
  window.addEventListener('message', (ev) => {
    const msg = ev?.data || {};
    if (msg && msg.type === 'archReady') {
      try { sendVisualSettingsToFrame(); } catch(e){}
    }
  });

})();
</script>


  <!-- Blue‑1 skin & helpers -->
  <link rel="stylesheet" href="blue-1.css">
  <script src="blue-1.js" defer></script>

  <!-- 3D overlay for Archetypes (Platonic solids + particles) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r155/three.min.js" defer></script>
  <script src="UNO_patch_arch3d_particles.js" defer></script>

  <!-- Horus Dual (multi‑agente) — dispara com prefixo @horus -->
  <script src="dual_multiagent_v12_locked_fixed.js" defer></script>

  <!-- Glue layer (feed/chat + archetype pulse + overlay toggle) -->
  <script>
  (function(){
    const $ = (q,r=document)=>r.querySelector(q);
    const feed = $('#chatFeed');
    const archCircle = document.querySelector('.arch-circle');
    const msgPreview = $('#msgPreview');
    const archMsg = $('#archMsg');
    const archFrame = $('#arch-frame');

    // Simple feed appender used by Blue‑1 & Horus plugin
    window.feedPush = function(kind, text){
      try {
        if(!feed) return;
        const el = document.createElement('div');
        el.className = kind === 'user' ? 'msg user' : (kind === 'status' ? 'msg status' : 'msg ai');
        el.textContent = String(text||'');
        feed.appendChild(el);
        feed.scrollTop = feed.scrollHeight;
        // Animate archetype bubble on every message
        if (archCircle){
          archCircle.classList.add('pressed');
          setTimeout(()=>archCircle.classList.remove('pressed'), 180);
        }
        // Preview on home
        if (msgPreview && kind!=='status'){
          msgPreview.textContent = (kind==='user' ? 'Você: ' : 'Dual: ') + text;
          msgPreview.style.display = 'block';
          setTimeout(()=>{ msgPreview.style.display = 'none' }, 3000);
        }
      } catch {}
    };
    // AI renderer used by Blue‑1 (rich blocks already handled inside blue-1.js)
    window.renderAssistantReply = function(markdownText){
      window.feedPush('ai', markdownText);
    };

    // Minimal sender (can be wrapped by Horus plugin)
    window.sendUserMessage = function(message){
      const msg = String(message||'').trim();
      if (!msg) return;
      window.feedPush('user', msg);
      // Default: if not intercepted, ping Blue-1 to try Gemini on KOBLLUX or fallback
      try {
        if (typeof window.__blue1_sendAsAssistant === 'function'){
          window.__blue1_sendAsAssistant(msg);
        }
      } catch {}
    };

    // Overlay (tint) toggle — off by default; respects UNO_ARCH3D.disableTint
    try {
      const disableTint = (window.UNO_ARCH3D && window.UNO_ARCH3D.disableTint) || true;
      if (disableTint){
        document.body.style.setProperty('--arch-overlay', 'rgba(0,0,0,0)');
        const a = document.querySelector('body::after');
      }
    } catch {}

    // Open Home input overlay to send message quickly
    const homeTextBtn = $('#homeTextBtn');
    const homeVoiceBtn = $('#homeVoiceBtn');
    const homeInputOverlay = $('#homeInputOverlay');
    const homeInputForm = $('#homeInputForm');
    const homeInput = $('#homeInput');
    if (homeTextBtn && homeInputOverlay && homeInputForm && homeInput){
      homeTextBtn.addEventListener('click', ()=>{
        homeInputOverlay.style.display = 'block';
        homeInput.focus();
      });
      homeInputForm.addEventListener('submit', (e)=>{
        e.preventDefault();
        const v = (homeInput.value||'').trim();
        if (v){ window.sendUserMessage(v); homeInput.value=''; homeInputOverlay.style.display='none'; }
      });
    }
    if (homeVoiceBtn){
      homeVoiceBtn.addEventListener('click', ()=>{
        if (archMsg){
          archMsg.textContent = '🎙️ Áudio reativo ligado — use @horus para orquestrar os 12.';
          archMsg.classList.add('show');
          setTimeout(()=>archMsg.classList.remove('show'), 2600);
        }
      });
    }

    // Make sure the SELECT gets rebuilt by the patcher even if the original populated it
    window.addEventListener('load', ()=>{
      try{
        if (typeof window.UNO_ARCH3D !== 'undefined'){
          // nothing to do; patch scripts rebuild on load
        }
      }catch{}
    });
  })();
  </script>

</body></html>