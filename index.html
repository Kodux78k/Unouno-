<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1"/>
<title>Dual Mobile Mockup v0.3.1 — UNO → DUAL → TRINITY</title>
<meta name="theme-color" content="#0b0f17" />
<link rel="icon" href="assets/icons/app.svg">
<style>
  :root{
    --bg:#0b0f17;--panel:#0f1522;--glass:rgba(255,255,255,.06);--line:rgba(255,255,255,.14);
    --ink:#e9f6ff;--muted:#97b1c6;--accent:#29d3ff;--accent2:#ff5af4;--ok:#39ffb6;--warn:#ffb74d;--err:#ff5a6e;
    --rad:18px;--pad:14px;--shadow:0 12px 40px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.04);
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 800px at 20% -10%, rgba(41,211,255,.14), transparent 60%),
       radial-gradient(900px 600px at 110% 20%, rgba(255,90,244,.10), transparent 60%),
       linear-gradient(0deg, #0a0d14, #0b0f17);
       color:var(--ink);font:500 15px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif}
  .app{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr auto;min-width:0}
  header{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:10px env(safe-area-inset-right) 8px env(safe-area-inset-left);}
  .logo{flex:0 0 auto;width:36px;height:36px;border-radius:50%;background:conic-gradient(from 0deg, var(--accent), var(--accent2), var(--accent));
        box-shadow:0 0 24px rgba(41,211,255,.4);animation:spin 9s linear infinite}
  @keyframes spin{to{transform:rotate(1turn)}}
  .title{font-weight:800;letter-spacing:.4px;min-width:0}
  .sub{color:var(--muted);font-size:12px}
  .row{display:flex;gap:10px;align-items:center;min-width:0;flex-wrap:wrap}
  .grow{flex:1 1 auto;min-width:0}
  .btn{appearance:none;border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--ink);
       padding:10px 12px;border-radius:14px;font-weight:700;letter-spacing:.3px;box-shadow:var(--shadow);
       display:inline-flex;align-items:center;gap:8px}
  .btn:active{transform:translateY(1px);opacity:.9}
  .chip{font-size:12px;border-radius:999px;border:1px solid var(--line);padding:6px 10px;background:rgba(255,255,255,.04);color:var(--muted)}
  select{appearance:none;background:rgba(255,255,255,.06);color:var(--ink);border:1px solid var(--line);border-radius:12px;padding:8px 10px;max-width:45vw}
  .water{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);background:rgba(255,255,255,.04);
         padding:6px 8px;border-radius:10px;font-size:11px;color:var(--muted);white-space:nowrap}

  .stage{position:relative;overflow:hidden;margin:6px; border:1px solid var(--line); border-radius:24px;
         background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00)); box-shadow:var(--shadow)}
  canvas{position:absolute;inset:0;width:100%;height:100%}
  .overlay{position:absolute;inset:0;pointer-events:none;display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--muted);text-align:center;padding:8px}

  .card{background:var(--glass);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);
        border:1px solid var(--line);border-radius:var(--rad);padding:var(--pad);box-shadow:var(--shadow)}
  .apps{padding:10px;display:grid;gap:10px}
  .appItem{display:flex;align-items:center;gap:10px;min-width:0}
  .appItem .meta{font-size:12px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:42vw}
  .sandboxWrap{margin:10px;border:1px solid var(--line);border-radius:16px;overflow:hidden}
  iframe.sandbox{display:block;width:100%;height:420px;background:#0a0d14;border:0}

  .fab{position:fixed;right:12px;bottom:calc(84px + env(safe-area-inset-bottom));display:flex;flex-direction:column;gap:10px}
  .fab .btn{padding:10px 12px}

  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(72px + env(safe-area-inset-bottom));
         background:rgba(20,28,44,.9);border:1px solid var(--line);backdrop-filter:blur(10px);padding:8px 12px;border-radius:12px;font-size:12px;color:var(--ink);display:none}
  .toast.show{display:block}

  .stage{height:calc(100vh - 320px)}
  @media (min-height:760px){.stage{height:calc(100vh - 350px)}}

/* Ajustes globais mobile */
html, body { max-width: 100vw; overflow-x: hidden; }

/* Layouts flexíveis */
.response-container, .pages-wrapper {
  display: flex; flex-direction: column; gap: 1rem; width: 100%;
}

/* Botão Único adaptado */
#btnInfodose {
  position: fixed; bottom: 1rem; right: 1rem; z-index: 1000;
  width: 56px; height: 56px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  border: 1px solid var(--line); background: rgba(255,255,255,.06); color: var(--ink);
  box-shadow: var(--shadow);
}

/* iFrame responsivo */
.ifr-wrap { width: 90vw; max-height: 90vh; }
@media(min-width: 768px){ .ifr-wrap { width: 66vw; } }

/* Truncamento de textos longos */
.ellip { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-inline-size: 18ch; }


/* Speed‑menu circular */
#speedMenu {
  position: fixed; bottom: 1rem; right: 1rem; z-index: 1100; pointer-events: none;
}
#speedMenu .node {
  position: absolute; width: 48px; height: 48px; border-radius: 50%;
  display:flex; align-items:center; justify-content:center;
  border:1px solid var(--line); background: rgba(255,255,255,.10); color: var(--ink);
  box-shadow: var(--shadow); transform: translate(0,0) scale(.8); opacity: 0; transition: transform .22s ease, opacity .22s ease;
  pointer-events: auto;
}
#speedMenu.open .node { opacity: 1; transform: scale(1); }
#speedMenu .label { position:absolute; top:-22px; font-size:11px; color:var(--muted); white-space:nowrap; }


/* --- Infodose bottom‑sheet menu (mobile‑first) --- */
.infodose-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:999; backdrop-filter:blur(2px); }
.infodose-menu{ position:fixed; left:50%; transform:translateX(-50%); bottom:.5rem; width:min(92vw, 420px); z-index:1001;
  border-radius:20px; overflow:hidden; border:1px solid color-mix(in oklab, #fff 15%, transparent); }
@media (min-width:768px){ .infodose-menu{ bottom:4.5rem; } }
.infodose-menu .menu-head{ display:flex; align-items:center; justify-content:space-between; padding:.8rem 1rem; font-weight:600; }
.infodose-menu .menu-close{ inline-size:32px; block-size:32px; border-radius:8px; }
.infodose-menu .menu-items{ display:flex; flex-direction:column; gap:.25rem; padding:.25rem .5rem .6rem; }
.menu-item{ display:grid; grid-template-columns:28px 1fr; align-items:center; gap:.75rem; padding:.7rem .6rem; border-radius:14px; text-align:left; }
.menu-item:hover{ outline:1px solid color-mix(in oklab, #fff 20%, transparent); }
.menu-item > span{ font-size:1.1rem; line-height:1; } .menu-item > b{ font-weight:600; }
.menu-item > .hint{ font-size:.8rem; opacity:.8; display:block; margin-top:.15rem; }
.sr-only{ position:absolute; inline-size:1px; block-size:1px; overflow:hidden; clip:rect(0 0 0 0); white-space:nowrap; clip-path:inset(50%); }


/* UNO UI — limpar botões extras e radial */
.fab{ display:none !important; } /* esconde Console/Hotspots antigos */
#speedMenu{ display:none !important; }

</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="logo"></div>
    <div>
      <div class="title">Dual Mobile Mockup <span class="chip">v0.3.1</span></div>
      <div class="sub">Cheio de Nada · Local‑first · Ritual 3‑6‑9</div>
    </div>
    <div class="grow"></div>
    <div class="row">
      <img src="assets/icons/voice.svg" alt="" width="18" height="18" />
      <select id="voiceSelect" title="Voz/Arquétipo">
        <option>Nova</option><option>Kaion</option><option>Elysha</option><option>Genus</option>
        <option>Custom A (packs)</option><option>Custom B (packs)</option>
      </select>
    </div>
    <div class="water" title="Custo d'água">
      <span class="badge">FPS <b id="fps">~</b></span>
      <span class="badge">LAT <b id="lat">~</b>ms</span>
      <span class="badge">LT <b id="lt">0</b></span>
      <span class="badge">CLS <b id="cls">0.00</b></span>
    </div>
    <button class="btn" id="btnPlay">▶︎ Áudio</button>
  </header>

  <main>
    <section class="stage" id="stage">
      <canvas id="layerBack"></canvas>
      <canvas id="layerMid"></canvas>
      <canvas id="layerFore"></canvas>
      <div class="overlay">double‑tap = accent • long‑press = 3→6→9 • 2 dedos/2s = Console</div>
    </section>

    <section class="card" style="margin:10px">
      <div class="row" style="flex-wrap:wrap">
        <strong>Mixer Trinity</strong>
        <div class="grow"></div>
        <button class="btn" id="btnBlend">▶︎ Blend (A+B+FX)</button>
        <button class="btn" id="btnStop">■</button>
      </div>
      <div style="font-size:12px;color:var(--muted)">Escolhe dois packs importados (A e B) e um efeito procedural (sub/noise) — procedural, ao vivo.</div>
      <div class="row" style="margin-top:8px;flex-wrap:wrap">
        <select id="selA"><option value="">Pack A</option></select>
        <select id="selB"><option value="">Pack B</option></select>
        <select id="selFX"><option value="sub">Efeito: Sub</option><option value="noise">Efeito: Noise</option></select>
      </div>
    </section>

    <!-- APPS JSON + Sandbox -->
    <section class="apps card" id="appsPane">
      <div class="row">
        <strong>Apps (Cheio de Nada)</strong>
        <div class="grow"></div>
        <button class="btn" id="btnLoadApps">Carregar apps.json</button>
        <button class="btn" id="btnOpenSandbox">Abrir Sandbox</button>
      </div>
      <div id="appsList"></div>
      <div class="sandboxWrap ifr-wrap" id="sandboxWrap" style="display:none">
        <iframe class="sandbox" id="sandbox"></iframe>
      </div>
    </section>

    <section class="card" id="packsPane" style="margin:10px">
      <div class="row" style="flex-wrap:wrap">
        <strong>Packs (IndexedDB)</strong>
        <div class="grow"></div>
        <input type="file" id="fileImport" accept="application/json,audio/*" multiple />
        <button class="btn" id="btnImport">Importar</button>
        <button class="btn" id="btnExport">Exportar JSON</button>
        <button class="btn" id="btnClear">Limpar</button>
      </div>
      <div id="packsList" style="margin-top:8px"></div>
    </section>

    <div class="card" id="console" style="display:none"></div>
  </main>

  <nav class="fab">
    <button class="btn" id="btnConsole">☰ Console</button>
    <button class="btn" id="btnHotspots">◎ Hotspots</button>
  </nav>

  <div class="toast" id="toast"></div>

  <button id="btnInfodose" title="Infodose • Ação Rápida">⚡</button>


<script>
const truth_contract={capabilities:["procedural_blend","granular_loop","apps_json_permissions","dynamic_iframe_allow","perf_observer","mobile_fix_wrap","starter_mini_apps"]};
const S={mode:3, consoleOpen:false, audioReady:false, lastTap:0, longPressTimer:null, phi:0, apps:[], packs:[], rafCount:0, lastFpsT:performance.now(), lt:0, cls:0, blend:{A:null,B:null,FX:"sub"}};
const $=s=>document.querySelector(s); const toast=m=>{const t=$("#toast"); t.textContent=m; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1400);};

/* Canvas */
const cvs=[$("#layerBack"),$("#layerMid"),$("#layerFore")]; const ctx=cvs.map(c=>c.getContext("2d"));
function resize(){ for(const c of cvs){ c.width=c.clientWidth*devicePixelRatio; c.height=c.clientHeight*devicePixelRatio; } }
addEventListener("resize", resize, {passive:true}); resize();
let t0=performance.now();
function draw(now){
  const dt=now-t0; t0=now; $("#lat").textContent=Math.max(1,Math.round(dt)); S.rafCount++; if(now-S.lastFpsT>1000){ $("#fps").textContent=S.rafCount; S.rafCount=0; S.lastFpsT=now; }
  const w=cvs[0].width,h=cvs[0].height,cx=w/2,cy=h/2; S.phi=(S.phi+dt*0.001)%(Math.PI*2);
  const b=ctx[0]; b.clearRect(0,0,w,h);
  for(let i=0;i<6;i++){ const r=(Math.sin(S.phi*0.7+i)*0.5+0.5)*200+80; const x=cx+Math.cos(S.phi*0.5+i)*w*0.25; const y=cy+Math.sin(S.phi*0.6+i)*h*0.25; const g=b.createRadialGradient(x,y,0,x,y,r); g.addColorStop(0,`rgba(41,211,255,${0.10+i*0.02})`); g.addColorStop(1,"transparent"); b.fillStyle=g; b.beginPath(); b.arc(x,y,r,0,Math.PI*2); b.fill(); }
  const m=ctx[1]; m.clearRect(0,0,w,h); m.lineWidth=2*devicePixelRatio; m.strokeStyle="rgba(255,255,255,0.25)";
  for(let r=40*devicePixelRatio;r<Math.min(w,h)/2;r+=28*devicePixelRatio){ const off=Math.sin(S.phi*1.1+r*0.01)*(S.mode===6? r*0.02 : r*0.01); m.beginPath(); m.arc(cx+off, cy, r, 0, Math.PI*2); m.stroke(); }
  const f=ctx[2]; f.clearRect(0,0,w,h); if(S.mode===9 && Math.sin(S.phi*6)>0.85){ f.fillStyle="rgba(255,90,244,0.22)"; f.fillRect(0,0,w,h); }
  requestAnimationFrame(draw);
}
requestAnimationFrame(draw);

/* PerformanceObserver */
if("PerformanceObserver" in window){
  try{ new PerformanceObserver(list=>{ for(const e of list.getEntries()){ if(e.duration>50){ S.lt++; $("#lt").textContent=S.lt; } } }).observe({entryTypes:["longtask"]}); }catch(e){}
  try{ let cls=0; new PerformanceObserver(list=>{ for(const e of list.getEntries()){ if(!e.hadRecentInput){ cls+=e.value; } } S.cls=cls; $("#cls").textContent=S.cls.toFixed(3); }).observe({type:"layout-shift", buffered:true}); }catch(e){}
}

/* Audio */
let actx, out, gain, filter, convolver, impulse;
let sourceA=null, sourceB=null, fxNode=null;
async function initAudio(){ if(S.audioReady) return; actx=new (window.AudioContext||window.webkitAudioContext)();
  const worklet = `class Burst extends AudioWorkletProcessor{ constructor(){super(); this.on=0;} static get parameterDescriptors(){return[{name:'on',defaultValue:0},{name:'freq',defaultValue:220}]}
  process(i,o,p){ const out=o[0]; const on=p.on[0]; const f=p.freq[0]; for(let ch=0; ch<out.length; ch++){ const b=out[ch]; for(let n=0;n<b.length;n++){ let s=0; if(on>0.5){ s=(Math.random()*2-1)*0.18 + Math.sin(2*Math.PI*(currentFrame+n)/sampleRate*f)*0.22; } b[n]=s; } } return true; } } registerProcessor('burst',Burst);`;
  await actx.audioWorklet.addModule(URL.createObjectURL(new Blob([worklet],{type:'text/javascript'})));
  out=new AudioWorkletNode(actx,'burst');
  gain=actx.createGain(); gain.gain.value=0.0;
  filter=actx.createBiquadFilter(); filter.type='highpass'; filter.frequency.value=220;
  convolver=actx.createConvolver(); impulse=makeImpulse(actx,0.22); convolver.buffer=impulse; const mixVerb=actx.createGain(); mixVerb.gain.value=0.25;
  out.connect(filter); filter.connect(gain); const master=actx.createGain(); master.gain.value=0.9;
  gain.connect(master).connect(actx.destination); gain.connect(mixVerb).connect(convolver).connect(actx.destination);
  S.audioReady=true; toast('Áudio pronto'); $("#btnPlay").textContent='✓ Áudio';
}
function makeImpulse(ctx, duration){ const rate=ctx.sampleRate; const len=rate*duration|0; const buf=ctx.createBuffer(2,len,rate); for(let ch=0; ch<2; ch++){ const d=buf.getChannelData(ch); for(let i=0;i<len;i++){ d[i]=(Math.random()*2-1)*Math.pow(1-i/len, 2); } } return buf; }
function accent(){ if(!S.audioReady) return; const base=220 + (S.mode===6?2:0)*40 + (S.mode===9?4:0)*40; out.parameters.get('freq').setValueAtTime(base, actx.currentTime); out.parameters.get('on').setValueAtTime(1, actx.currentTime); gain.gain.cancelScheduledValues(actx.currentTime); gain.gain.linearRampToValueAtTime(0.9, actx.currentTime+0.01); gain.gain.exponentialRampToValueAtTime(0.0001, actx.currentTime+0.35); setTimeout(()=> out.parameters.get('on').setValueAtTime(0, actx.currentTime), 120); }
$("#btnPlay").onclick=async()=>{ await initAudio(); if(actx.state==='suspended') await actx.resume(); accent(); };

/* Packs IDB */
const DB={ name:'dual-packs', ver:1, db:null};
function idbOpen(){ return new Promise((res,rej)=>{ const r=indexedDB.open(DB.name, DB.ver); r.onupgradeneeded=ev=>{ const db=ev.target.result; if(!db.objectStoreNames.contains('packs')) db.createObjectStore('packs', {keyPath:'id'}); }; r.onsuccess=ev=>{ DB.db=ev.target.result; res(); }; r.onerror=()=>rej(r.error); }); }
async function idbAll(){ await idbOpen(); return new Promise(res=>{ const tx=DB.db.transaction('packs','readonly'); const st=tx.objectStore('packs'); const rq=st.getAll(); rq.onsuccess=()=>res(rq.result||[]); }); }
async function idbPut(p){ await idbOpen(); return new Promise(res=>{ const tx=DB.db.transaction('packs','readwrite'); tx.objectStore('packs').put(p); tx.oncomplete=()=>res(true); }); }
async function idbClear(){ await idbOpen(); return new Promise(res=>{ const tx=DB.db.transaction('packs','readwrite'); tx.objectStore('packs').clear(); tx.oncomplete=()=>res(true); }); }
function toB64(u8){ let s=''; for(const b of u8) s+=String.fromCharCode(b); return btoa(s); }

async function refreshPacksUI(){
  S.packs = await idbAll();
  const list=$("#packsList"); list.innerHTML='';
  const selA=$("#selA"), selB=$("#selB"); selA.innerHTML='<option value=\"\">Pack A</option>'; selB.innerHTML='<option value=\"\">Pack B</option>';
  for(const p of S.packs){
    const row=document.createElement('div'); row.className='appItem';
    row.innerHTML=`<span class="chip">pack</span><div style="min-width:0"><div><strong>${p.name||p.id}</strong></div><div class="meta ellip">${p.type}</div></div>`;
    list.appendChild(row);
    if((p.type||'').startsWith('audio')){ const optA=document.createElement('option'); optA.value=p.id; optA.textContent=p.name||p.id; selA.appendChild(optA); const optB=optA.cloneNode(true); selB.appendChild(optB); }
  }
}

$("#btnImport").onclick=async()=>{
  const files=$("#fileImport").files; if(!files?.length){ toast('Selecione arquivos'); return; }
  for(const f of files){
    if(f.type && f.type.startsWith('audio/')){
      const arr=await f.arrayBuffer(); await idbPut({ id:`wav:${f.name}`, type:f.type, name:f.name, data: toB64(new Uint8Array(arr)) });
    }else{
      try{ const txt=await f.text(); await idbPut({ id:`json:${f.name}`, type:'json', name:f.name, data: JSON.parse(txt) }); }
      catch(e){ console.warn('JSON inválido', e); }
    }
  }
  await refreshPacksUI(); toast('Importado');
};
$("#btnExport").onclick=async()=>{ const data=await idbAll(); const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='dual_packs_export.json'; a.click(); };
$("#btnClear").onclick=async()=>{ await idbClear(); await refreshPacksUI(); stopBlend(); toast('Packs limpos'); };

/* Procedural Blend: 2 buffers + 1 FX (sub/noise), live */
async function decodeById(id){
  const item = (S.packs||[]).find(p=>p.id===id);
  if(!item){ throw new Error('pack not found'); }
  const bin = Uint8Array.from(atob(item.data), c=>c.charCodeAt(0)).buffer;
  return await actx.decodeAudioData(bin.slice(0));
}
function makeSub(){ const osc=actx.createOscillator(); osc.type='sine'; osc.frequency.value=55; const g=actx.createGain(); g.gain.value=0.25; osc.connect(g); return { node:g, start:()=>osc.start(), stop:()=>{try{osc.stop()}catch{}} }; }
function makeNoise(){ const buf=actx.createBuffer(1, actx.sampleRate*1, actx.sampleRate); const d=buf.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1; const src=actx.createBufferSource(); src.buffer=buf; src.loop=true; const g=actx.createGain(); g.gain.value=0.12; src.connect(g); return { node:g, start:()=>src.start(), stop:()=>{try{src.stop()}catch{}} }; }

let blendChain=null;
async function startBlend(){
  await initAudio(); if(actx.state==='suspended') await actx.resume();
  stopBlend();
  const ida=$("#selA").value, idb=$("#selB").value, fx=$("#selFX").value;
  if(!ida || !idb){ toast('Escolha Pack A e Pack B (áudio)'); return; }
  const [bufA, bufB] = await Promise.all([decodeById(ida), decodeById(idb)]);
  const a=actx.createBufferSource(); a.buffer=bufA; a.loop=true; a.loopStart=0.02; a.loopEnd=Math.min(0.25, bufA.duration); a.playbackRate.value=0.98;
  const b=actx.createBufferSource(); b.buffer=bufB; b.loop=true; b.loopStart=0.02; b.loopEnd=Math.min(0.22, bufB.duration); b.playbackRate.value=1.03;
  const gA=actx.createGain(); gA.gain.value=0.6; const gB=actx.createGain(); gB.gain.value=0.6;
  a.connect(gA); b.connect(gB);
  let fxObj = fx==='sub' ? makeSub() : makeNoise();
  const gFX=actx.createGain(); gFX.gain.value = fx==='sub'?0.3:0.15; fxObj.node.connect(gFX);

  // sum -> filter -> (verb) -> destination
  const sum=actx.createGain(); sum.gain.value=0.9;
  gA.connect(sum); gB.connect(sum); gFX.connect(sum);
  const biq=actx.createBiquadFilter(); biq.type='lowpass'; biq.frequency.value=3200; sum.connect(biq).connect(actx.destination);
  const vMix=actx.createGain(); vMix.gain.value=0.22; sum.connect(vMix).connect(convolver).connect(actx.destination);

  a.start(); b.start(); fxObj.start();
  blendChain={ a,b,fxObj, nodes:[gA,gB,gFX,sum,biq,vMix] };
  toast('Blend ON (A+B+FX)');
}
function stopBlend(){ if(!blendChain) return; try{ blendChain.a.stop(); }catch{} try{ blendChain.b.stop(); }catch{} try{ blendChain.fxObj.stop(); }catch{} blendChain=null; }
$("#btnBlend").onclick=startBlend; $("#btnStop").onclick=stopBlend;

/* Apps.json + Dynamic iframe allow/sandbox */
$("#btnLoadApps").onclick=async()=>{ try{ const res=await fetch('apps/apps.json'); const json=await res.json(); S.apps=json.apps||json; renderApps(); toast('apps.json carregado'); }catch(e){ toast('Falha ao carregar apps.json'); console.error(e); } };
function renderApps(){ const list=$("#appsList"); list.innerHTML=''; const df=document.createDocumentFragment();
  (S.apps||[]).forEach((a,i)=>{ const row=document.createElement('div'); row.className='appItem';
    row.innerHTML = `<span class="chip">#${i+1}</span><div style="min-width:0"><div><strong>${a.name||'App'}</strong></div><div class="meta ellip">${a.url}</div></div><div class="grow"></div><button class="btn" data-open="${i}">Abrir</button>`;
    df.appendChild(row);
  }); list.appendChild(df);
  list.onclick=e=>{ const i=e.target?.dataset?.open; if(i!=null){ openSandbox(S.apps[i]); } }
}
function openSandbox(app){
  const f=$("#sandbox"); $("#sandboxWrap").style.display='block'; f.src = app.url;
  f.setAttribute('referrerpolicy','no-referrer');
  f.setAttribute('allow', app.allow || 'autoplay; clipboard-read; clipboard-write');
  f.setAttribute('sandbox', app.sandbox || 'allow-scripts');
}

/* Console */
$("#btnConsole").onclick=()=>{ S.consoleOpen=!S.consoleOpen; const c=$("#console"); c.style.display=S.consoleOpen?'block':'none'; c.innerHTML='<pre>'+JSON.stringify({truth_contract, metrics:{fps:$("#fps").textContent, lat:$("#lat").textContent, lt:$("#lt").textContent, cls:$("#cls").textContent}, packs:S.packs.map(p=>p.id), apps:(S.apps||[]).map(a=>({name:a.name,allow:a.allow,sandbox:a.sandbox}))}, null, 2)+'</pre>'; };

/* Hotspots mock */
$("#btnHotspots").onclick=()=>toast('Hotspots visuais (mock)');


/* ---- Speed-menu circular ---- */
(function(){
  const menu = document.getElementById('speedMenu');
  const BTN = document.getElementById('btnInfodose');
  const backdrop = document.getElementById('infodoseBackdrop');
  const sheet = document.getElementById('infodoseMenu');
  const items = [
    { id:'speedPacks',   txt:'Packs',   action: ()=>{ const p=document.querySelector('#packsPane'); if(p){ p.style.display = (getComputedStyle(p).display==='none'?'block':'none'); } } },
    { id:'speedApps',    txt:'Apps',    action: ()=>{ const w=document.querySelector('#sandboxWrap'); if(w){ w.style.display = (w.style.display==='none'?'block':'none'); } } },
    { id:'speedConsole', txt:'Console', action: ()=>{ const c=document.querySelector('#console'); if(c){ const on=getComputedStyle(c).display!=='none'; c.style.display= on?'none':'block'; if(!on){ c.scrollTop=0; } } } },
    { id:'speedMixer',   txt:'Mixer',   action: ()=>{ const m=document.getElementById('selA'); if(m){ m.focus(); toast('Mixer pronto'); } } },
  ];

  function build(){
    menu.innerHTML='';
    items.forEach((it,i)=>{
      const b=document.createElement('button'); b.className='node'; b.id=it.id; b.textContent=['📦','🗂️','☰','🎚️'][i]||'•'; b.title=it.txt;
      const label=document.createElement('div'); label.className='label'; label.textContent=it.txt; b.appendChild(label);
      b.onclick=(e)=>{ e.stopPropagation(); it.action(); toggle(false); };
      menu.appendChild(b);
    });
  }

  // adaptive semicircle based on N items (spreads over 140°–180°)
  function place(open){
    const nodes = menu.querySelectorAll('.node'); const N = nodes.length || 1;
    const arc = Math.min(180, 120 + N*10); // widen a bit with more items, max 180
    const start = -90 - arc/2; // center above the FAB
    const R = 92;
    nodes.forEach((n,idx)=>{
      const a = (start + (arc*(idx/(Math.max(1,N-1))))) * Math.PI/180;
      const dx = Math.cos(a)*R;
      const dy = Math.sin(a)*R;
      n.style.right='0px'; n.style.bottom='0px';
      n.style.transform = open ? `translate(${-dx}px, ${-dy}px) scale(1)` : 'translate(0,0) scale(.8)';
      n.style.opacity = open ? '1' : '0';
    });
  }

  function toggle(force){
    const open = force!==undefined ? force : !menu.classList.contains('open');
    if(open){ build(); menu.classList.add('open'); menu.setAttribute('aria-hidden','false'); place(true); }
    else{ menu.classList.remove('open'); menu.setAttribute('aria-hidden','true'); place(false); }
  }

  // tap = radial quick actions; long-press (~500ms) = open bottom sheet
  let tId=null, downAt=0;
  BTN.addEventListener('touchstart', e=>{ downAt=Date.now(); clearTimeout(tId); tId=setTimeout(()=>{ openSheet(); }, 500); }, {passive:true});
  BTN.addEventListener('touchend', e=>{ const dt=Date.now()-downAt; clearTimeout(tId); if(dt<500){ toggle(); } });
  BTN.addEventListener('mousedown', e=>{ downAt=Date.now(); clearTimeout(tId); tId=setTimeout(()=>{ openSheet(); }, 500); });
  BTN.addEventListener('mouseup', e=>{ const dt=Date.now()-downAt; clearTimeout(tId); if(dt<500){ toggle(); } });

  function openSheet(){ sheet.hidden=false; backdrop.hidden=false; sheet.focus(); }
  function closeSheet(){ sheet.hidden=true; backdrop.hidden=true; }
  backdrop.addEventListener('click', closeSheet);
  sheet.addEventListener('click', (e)=>{ const c=e.target.closest('[data-close]'); if(c){ closeSheet(); } });

  document.addEventListener('click', (e)=>{ if(menu.classList.contains('open')) toggle(false); });
})();
/* File load & init */
$("#btnInfodose").onclick=()=>{
  const p=document.querySelector('#packsPane');
  if(!p) return; const v=getComputedStyle(p).display; p.style.display = (v==='none'?'block':'none');
};

window.addEventListener('load', async ()=>{ await refreshPacksUI(); });

/* PWA SW inline */
if('serviceWorker' in navigator){
  const sw=`self.addEventListener('install',e=>{e.waitUntil(caches.open('dual-mock-v3-1').then(c=>c.addAll(['./','apps/apps.json','assets/icons/app.svg']).catch(()=>{})))});self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)))})`;
  navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw],{type:'text/javascript'})));
}
</script>

<!-- Botão Único (já existe) -->

<!-- Backdrop do menu -->
<div id="infodoseBackdrop" class="infodose-backdrop" hidden></div>

<!-- Sheet do menu -->
<div id="infodoseMenu" class="infodose-menu glass" role="menu" tabindex="-1" aria-label="Menu Infodose" hidden>
  <header class="menu-head">
    <strong>Infodose</strong>
    <button class="menu-close" data-close aria-label="Fechar">×</button>
  </header>
  <nav class="menu-items">
    <button class="menu-item" data-action="novo"    role="menuitem">
      <span>➕</span><b>Novo</b><i class="hint ellip" title="Criar algo do zero">Criar algo do zero</i>
    </button>
    <button class="menu-item" data-action="abrir"   role="menuitem">
      <span>📂</span><b>Abrir</b><i class="hint ellip" title="Abrir item recente">Abrir item recente</i>
    </button>
    <label  class="menu-item" role="menuitem" title="Enviar arquivo">
      <span>⤴️</span><b>Upload</b><i class="hint ellip">Enviar arquivo</i>
      <input id="infodoseUpload" type="file" hidden>
    </label>
    <button class="menu-item" data-action="configs" role="menuitem">
      <span>⚙️</span><b>Configs</b><i class="hint ellip">Preferências</i>
    </button>
    <button class="menu-item" data-action="arteasc" role="menuitem">
      <span>⟐</span><b>ArteASC</b><i class="hint ellip">Seal Trinity v2</i>
    </button>
  </nav>
</div>

</body>
</html>
