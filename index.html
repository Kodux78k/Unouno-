<!DOCTYPE html>

<html lang="pt-BR" style="--arch-overlay: rgba(64, 158, 255, 0.22);"><head>
  <!-- ===== BOOT • Atom Loader CSS ===== -->
  <style id="boot-atom-style">
    #bootLoader { display:flex; align-items:center; justify-content:center; }
    #bootLoader .loader-wrap { display:flex; flex-direction:column; align-items:center; gap:.65rem; }
    #bootLoader .tagline { font-weight:800; font-size:1.02rem; letter-spacing:.35px; text-transform:none; }
    /* dots under the phrase */
    #bootLoader .dots { display:flex; gap:.35rem; }
    #bootLoader .dot { width:8px; height:8px; border-radius:50%; background:#fff; opacity:.85; animation: dotJump 1.2s infinite ease-in-out; }
    #bootLoader .dot:nth-child(2){ animation-delay:.15s } 
    #bootLoader .dot:nth-child(3){ animation-delay:.30s }
    @keyframes dotJump { 0%,100%{ transform: translateY(0); opacity:.55 } 50%{ transform: translateY(-6px); opacity:1 } }

    /* Atom */
    #bootLoader .atom { width:128px; height:128px; position:relative; margin-top:.2rem; }
    #bootLoader .nucleus { position:absolute; left:50%; top:50%; width:14px; height:14px; margin:-7px 0 0 -7px; border-radius:50%; background:#fff; box-shadow:0 0 20px rgba(255,255,255,.45); }
    #bootLoader .orbit { position:absolute; left:50%; top:50%; width:100%; height:60%; margin:-30% 0 0 -50%; border:1.5px solid rgba(255,255,255,.25); border-radius:50%; transform-origin:center center; }
    #bootLoader .orbit.o2 { transform: rotate(60deg); }
    #bootLoader .orbit.o3 { transform: rotate(-60deg); }
    #bootLoader .electron { position:absolute; left:50%; top:0; width:8px; height:8px; margin-left:-4px; border-radius:50%; background:#fff; box-shadow:0 0 10px rgba(255,255,255,.55); }
    #bootLoader .spin { animation: spin 2.6s linear infinite; }
    #bootLoader .spin.fast { animation-duration: 2.1s; }
    #bootLoader .spin.slow { animation-duration: 3.1s; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* Respect reduced motion */
    @media (prefers-reduced-motion: reduce){
      #bootLoader .spin, #bootLoader .dot { animation: none !important; }
    }
  </style>
    
  <!-- ===== BOOT • Atom Loader Transform ===== -->
  <script>
    (function(){
      function ensureAtom(){
        var host = document.getElementById('bootLoader');
        if (!host) return;
        // If markup already exists, rebuild as atom loader
        var txt = (host.querySelector('.tagline') ? host.querySelector('.tagline').textContent : 'Sempre Único, Sempre seu');
        host.innerHTML = '';
        var wrap = document.createElement('div'); wrap.className = 'loader-wrap';
        var atom = document.createElement('div'); atom.className = 'atom';
        var nucleus = document.createElement('div'); nucleus.className = 'nucleus'; atom.appendChild(nucleus);
        ['',' fast',' slow'].forEach(function(spd, idx){
          var orbit = document.createElement('div'); orbit.className = 'orbit spin'+spd + (idx===1?' o2': (idx===2?' o3':''));
          var e = document.createElement('div'); e.className = 'electron';
          orbit.appendChild(e); atom.appendChild(orbit);
        });
        var title = document.createElement('span'); title.className = 'tagline'; title.textContent = txt;
        var dots = document.createElement('div'); dots.className = 'dots';
        dots.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
        wrap.appendChild(atom); wrap.appendChild(title); wrap.appendChild(dots);
        host.appendChild(wrap);
      }
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', ensureAtom);
      else ensureAtom();
    })();
  </script>
    
  <!-- ===== OVERRIDES: hide S-Line + fusion button ===== -->
  <style id="overrides-hide">
    #ibSLine { display: none !important; }
    .fusion-toggle, #fusion-toggle, .btn-fusion, [data-action="fusion-toggle"],
    .fusion-btn, .btn[data-fusion], .btn-difusionar, #btn-difusionar,
    button[aria-label*="Fusão"], button[aria-label*="Fus\u00e3o"], button[aria-label*="fusion"],
    [data-testid*="fusion"], [data-analytics*="fusion"] { display: none !important; }
  </style>
  <script>
  (function(){
    function hideBtns(root){
      var sel = ['button','a','.btn','#btn-difusionar','.btn-difusionar','.fusion-toggle','#fusion-toggle','.btn-fusion','[data-action="fusion-toggle"]','.fusion-btn','.btn[data-fusion]'];
      var terms = /(fusion|fus\u00e3o|fusão|difusionar|difus[aã]o|fusionar)/i;
      try{
        (root.querySelectorAll ? root.querySelectorAll(sel.join(',')) : []).forEach(function(el){
          try{
            var t = ((el.innerText||'') + ' ' + (el.textContent||'') + ' ' + (el.getAttribute('title')||'') + ' ' + (el.getAttribute('aria-label')||'') + ' ' + (el.id||'') + ' ' + (el.className||''));
            if (terms.test(t)) {
              el.style.setProperty('display','none','important');
              el.setAttribute('data-hidden-by','fusion-hide');
            }
          }catch(_){}
        });
      }catch(_){}
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', function(){ hideBtns(document); });
    else hideBtns(document);
    try{
      new MutationObserver(function(muts){
        muts.forEach(function(m){
          (m.addedNodes||[]).forEach(function(n){ if (n && n.nodeType===1) hideBtns(n); });
        });
      }).observe(document.documentElement, {subtree:true, childList:true});
    }catch(_){}
  })();
  </script>
    
<!-- PREPAINT: enforce Blue‑1 tokens before any CSS -->
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" name="viewport"/>
<title>HUB UNO — PROD (safe)</title>
<meta content="#0b0f14" name="theme-color"/>
<!-- PATCH: overlay-css-unify -->
<!-- PATCH: overlay-guardian-css -->
<!-- OVERLAY: background-only patch -->
<script id="OVERLAY_DEFAULT_BOOT">
// Overlay ON por padrão até o primeiro arquétipo aplicar a cor própria.
try{ document.documentElement.style.setProperty('--arch-overlay','rgba(64,158,255,.22)'); }catch{}
</script>
<link href="./manifest.webmanifest" rel="manifest"/>
<style id="prepaint-tokens">
:root{
  --arch-overlay: rgba(64,158,255,.22);
  --arch-overlay-strength: 22%;
  --arch-overlay-intensity: .45;
}
</style>
<style>
    :root {
      /* Paleta padrão (rosa/azul) */
      --grad-a: #ff52e5;
      --grad-b: #00c5e5;
      --fg: #f5f7ff;
      --mut: rgba(245, 247, 255, .68);
      /* Superfícies levemente mais opacas para melhorar a legibilidade em fundos complexos */
      --surface: rgba(15, 17, 32, .65);
      --surface-strong: rgba(15, 17, 32, .92);
      --bd: 1px solid rgba(255, 255, 255, .12);
      --ok: #39ffb6;
      --warn: #ffb86b;
      --err: #ff6b6b;
      --r: 18px;
      --r2: 22px;
      --shadow: 0 14px 40px rgba(0, 0, 0, .45);
      --tabsH: 74px;
      --hdrH: 64px;
      --blur: 24px;
  /* Deslocamento opcional para o cabeçalho.  Ajuste este valor para
     empurrar o cabeçalho (header.mast) alguns pixels para baixo.  O
     padding superior do main será ajustado automaticamente. */
  --hdrOffset: 0px;

  /* Cor de overlay por arquétipo (gradiente sólido).  Esta variável
     será atualizada dinamicamente via script conforme o arquétipo
     ativo.  O valor padrão é transparente para não interferir na
     estética quando nenhum arquétipo estiver selecionado. */
  --arch-overlay: rgba(0,0,0,0);
      --ease: cubic-bezier(.22, .61, .36, 1);
    }

    /* Tema alternativo: medium gray / glasmorfismo. Quando body[data-theme="medium"] estiver definido, estas variáveis substituem as originais. */
    body[data-theme="medium"] {
      /* Ajustamos a paleta “medium” para um visual ainda mais tecnológico,
         com tons de cinza-escuro/azulado e transparências suaves para
         reforçar o glasmorfismo. */
      --grad-a: #2c313c;
      --grad-b: #1f242d;
      --fg: #f1f2f5;
      --mut: rgba(241, 242, 245, .68);
      /* No tema médio, aumente a opacidade das superfícies para reforçar o efeito de vidro */
      --surface: rgba(44, 47, 56, .55);
      --surface-strong: rgba(44, 47, 56, .85);
      --bd: 1px solid rgba(255, 255, 255, .06);
      --ok: #68d391;
      --warn: #f6ad55;
      --err: #fc8181;
      --blur: 24px;
    }

    * { box-sizing: border-box }
    html, body { height: 100% , min-height:100vh;}

    body {
      margin: 0;
      color: var(--fg);
      background: linear-gradient(42deg, var(--grad-a), var(--grad-b)) fixed;
      font: 14px/1.45 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      overflow: auto;
  /* Permite que o pseudo-elemento ::after fique posicionado em relação ao corpo */
  position: relative;
    }

/* Overlay de cor do arquétipo ativo.  Usa a variável --arch-overlay definida no
   :root e atualizada via script.  O overlay cobre toda a tela, tem pointer-events
   desativado e fica atrás dos demais elementos (z-index: 0). */
body::after{content:'';position:fixed;inset:0;background:none !important;pointer-events:none;}

    /* ===== Micro-interações base ===== */
    .fx-trans { transition: transform .16s var(--ease), background .25s var(--ease), box-shadow .25s var(--ease), border-color .25s var(--ease), color .25s var(--ease), opacity .25s var(--ease) }
    .fx-lift:hover { transform: translateY(-1px) }
    .fx-press:active { transform: translateY(0) scale(.98) }
    .ring:focus-visible { outline: 0; box-shadow: 0 0 0 4px rgba(255,255,255,.14) }
    @media (prefers-reduced-motion: reduce) { .fx-trans { transition: none } }

    /* ===== Botões ===== */
    button, .btn, .ib { background: var(--surface); border: var(--bd); color: var(--fg); font-weight: 800; border-radius: 12px; cursor: pointer; position: relative }
    .btn { padding: .58rem .9rem; background: linear-gradient(180deg, #11162a, #0b1122) }
    .btn.prime { background: linear-gradient(90deg, #a66fff, #6db4ff); color: #0b0f14; border-color: transparent }
    .btn:hover { box-shadow: 0 8px 26px rgba(0,0,0,.36), 0 0 0 1px rgba(255,255,255,.10) inset }
    .btn.prime:hover { box-shadow: 0 10px 30px rgba(166,111,255,.26), 0 0 0 1px rgba(255,255,255,.18) inset }
    .btn:active { filter: saturate(1.02) brightness(.98) }
    .btn[disabled] { opacity: .55; pointer-events: none }

    /* Ripple */
    .ripple { position: absolute; inset: 0; overflow: hidden; border-radius: inherit }
    .ripple > i { position: absolute; border-radius: 999px; pointer-events: none; transform: translate(-50%, -50%); background: radial-gradient(closest-side, rgba(255,255,255,.35), rgba(255,255,255,0) 70%); animation: ripple .6s var(--ease) forwards }
    @keyframes ripple { from { opacity: .55; width: 0; height: 0 } to { opacity: 0; width: 260px; height: 260px } }

    /* ===== Header ===== */
    header.mast { position: relative; inset: 0 0 auto 0; height: var(--hdrH); z-index: 100; display: flex; align-items: center; gap: 10px; padding: 0 12px; backdrop-filter: blur(var(--blur)) saturate(130%); background: linear-gradient(180deg, rgba(0,0,0,.28), rgba(0,0,0,0)); margin-top: var(--hdrOffset); }
    .ib { width: 42px; height: 42px; border-radius: 50%; display: grid; place-items: center; box-shadow: var(--shadow) }
    .ib.fx-trans:hover { box-shadow: 0 10px 28px rgba(0,0,0,.5), 0 0 0 2px rgba(255,255,255,.10) inset }
    .title { flex: 1; text-align: center; line-height: 1 }
    .title h1 { margin: 0; font-size: 18px; letter-spacing: .06em; font-weight: 900 }
    .title small { display: block; color: var(--mut); letter-spacing: .1em }

    /* ===== Layout ===== */
    main { position: relative; height: 100%; min-height:100vh; overflow: auto }
      /*padding-top: calc(var(--hdrH) + env(safe-area-inset-top) + var(--hdrOffset)); padding-bottom: calc(var(--tabsH) + env(safe-area-inset-bottom)); */

    .view { position: absolute; min-height:100vh; inset: 0; padding: 12px 14px; overflow: auto; display: none }
    .view.active {
      display: block;
      /* Animação de transição mais simples: apenas fade com leve zoom. */
      animation: fadeSimple .6s var(--ease);
    }
    /* Esta animação remove o filtro de blur e utiliza apenas opacidade e escala
       para uma transição mais suave. Você pode ajustar os valores para
       personalizar o timing. */
    @keyframes fadeSimple {
      /* Para um efeito de zoom mais sutil, usamos valores de escala
         mais próximos de 1. Altere estes valores caso deseje ajustar a
         intensidade do zoom. */
      0%   { opacity: 0; transform: scale(0.995); }
      60%  { opacity: 0.8; transform: scale(1.005); }
      100% { opacity: 1; transform: scale(1); }
    }

    /* ===== Cards / grids ===== */
    .grid { display: grid; gap: 12px; max-width: 820px; margin: 0 auto }
    /* Distribua os cartões de status da Home em duas colunas para melhor encaixe.
       Em telas estreitas (<560px) eles se empilham em uma única coluna. */
    .cards { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px }
    @media (max-width: 560px) { .cards { grid-template-columns: 1fr } }

    /* Ocultar o menu de opções (Apps, Stack, Brain, Revo) na Home quando apenas a bola dos arquétipos deve aparecer */
    /* Hide the UNO info card on home. The cards row is now used for status notifications */
    #v-home #unoCard {
      display: none;
    }

    /* Esconde a grade de cards na Home e abre espaço para o feed de IA */
    #v-home .cards {
      display: none !important;
    }

    /* O feed de IA na Home foi substituído pelo preview laranja; esconda o feed original */
    #v-home #iaFeed {
      display: none !important;
    }

    /* ===== Estilos para ícones fixados na barra ===== */
    .tabbar .tab[data-pinned] {
      /* Estilo semelhante às abas padrão, mas com cor diferenciada no hover */
      position: relative;
    }
    .pin-letter {
      width: 18px;
      height: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-size: 12px;
      font-weight: 800;
      background: rgba(255, 255, 255, 0.15);
      color: var(--fg);
      line-height: 1;
    }

    /* Estiliza o feed de mensagens da IA em formato de conversa */
    #iaFeed {
      margin: 12px auto 0;
      max-width: 820px;
      background: var(--surface);
      border: var(--bd);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      padding: 12px;
      font-size: 14px;
      line-height: 1.5;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    #iaFeed .msg {
      margin: 0;
      padding: 8px 12px;
      border-radius: 16px;
      max-width: 75%;
      word-wrap: break-word;
    }
    #iaFeed .msg.user {
      align-self: flex-end;
      background: rgba(255,255,255,0.1);
      border-radius: 16px 16px 0 16px;
    }
    #iaFeed .msg.ai {
      align-self: flex-start;
      background: rgba(57,255,182,0.12);
      border-radius: 16px 16px 16px 0;
    }
    #iaFeed .status {
      color: var(--mut);
      font-size: 12px;
      align-self: center;
    }

    /* ===== Apps Page customizations ===== */
    /* Estilizar botão de upload de HTML local para destaque */
    #btnImport {
      font-weight: 700;
      color: var(--ink);
      background: var(--glass);
      border-color: var(--line);
    }
    /* Favorite icon/button dentro de cada cartão de app */
    .app-card {
      position: relative;
    }
    .fav-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 22px;
      height: 22px;
      background: transparent;
      border: none;
      padding: 0;
      cursor: pointer;
      opacity: 0.6;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
    }
    .fav-btn.fav {
      opacity: 1;
    }
    .fav-btn img {
      width: 100%;
      height: 100%;
      /* Ícones não favoritados ficam em tons de cinza para indicar estado off */
      filter: grayscale(1) brightness(0.5);
    }
    .fav-btn.fav img {
      /* Ícone favoritado mantém cor original (amarelo) */
      filter: none;
    }
    .card { background: var(--surface); border: var(--bd); border-radius: var(--r2); box-shadow: var(--shadow); padding: 12px; display: flex; gap: 10px; align-items: center; position: relative; backdrop-filter: blur(8px) saturate(160%) }
    .card.fx-trans:hover { box-shadow: 0 16px 40px rgba(0,0,0,.5) }
    .ico { width: 44px; height: 44px; border-radius: 14px; display: grid; place-items: center; background: rgba(255,255,255,.06); border: var(--bd) }
    .mut { color: var(--mut); font-size: 12px }
    .input, select, textarea { width: 100%; background: #0f1426; color: var(--fg); border: var(--bd); border-radius: 12px; padding: 10px }

    /* Ajuste para ícones SVG externos: invertê-los para que fiquem claros em temas escuros */
    header.mast img,
    .tabbar img,
    
    .session .tools img,
    .dock img {
      filter: invert(1) brightness(1.2);
    }

    /* ===== Apps ===== */
.apps-wrap {
      display: grid;
      gap: 12px;
      /* Distribui os apps em colunas responsivas: cada cartão terá no mínimo 240px. */
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      /* Adiciona uma margem inferior generosa para que o dock/tabbar não sobreponha os últimos elementos. */
      padding-bottom: 80px;
    }
.app-card {
      display: flex;
      gap: 12px;
      align-items: center;
      /* Use um fundo com maior opacidade e um leve blur para destacar cada app e melhorar a legibilidade */
      background: var(--surface);
      backdrop-filter: blur(8px) saturate(160%);
      border: var(--bd);
      border-radius: var(--r);
      padding: 14px;
    }
    .app-card:hover { box-shadow: 0 12px 34px rgba(0,0,0,.46) }
    .app-icon { width: 42px; height: 42px; border-radius: 12px; display: grid; place-items: center; background: #0f1528; border: var(--bd); overflow: hidden }

    /* Ícone com a letra do app no cabeçalho das sessões. Utiliza a
       primeira letra do título e cores do gradiente para destacar o
       aplicativo em cada cartão. */
    .session .hdr .app-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 6px;
      background: var(--grad-a);
      color: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
    }
    .app-title {
      font-weight: 800;
      /* Evitar quebra de linhas em títulos longos e mostrar reticências */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    /* Âncora para sessões abertas no topo da página (modo "abrir dentro"). */
    #sessionsAnchor {
      display: grid;
      gap: 12px;
      margin: 12px 14px;
    }
    /* Estilos para o painel Brain (perfil, performance, voz, logs). */
    #brain { position: fixed; top: calc(var(--hdrH) + 12px); right: 14px; width: min(92vw, 440px); z-index: 130; }
    #brain.hide { display: none !important; }
    .popover { border-radius: 24px; padding: 12px; background: var(--surface-strong); border: var(--bd); backdrop-filter: blur(var(--blur)); }
    .menuItem { display: flex; gap: 12px; align-items: center; border: var(--bd); background: var(--surface); border-radius: 16px; padding: 12px; }
    .menuItem + .menuItem { margin-top: 9px; }
    .input { display: flex; gap: 8px; align-items: center; background: var(--surface); border: var(--bd); border-radius: 14px; padding: 9px 11px; }
    .input input, .input select { flex: 1; background: transparent; border: 0; outline: 0; color: var(--fg); font-size: 13px; }
    .notice { font-size: 12px; color: var(--mut); }

    /* ===== Viewer (Stack) ===== */
    .session { background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); border: var(--bd); border-radius: 16px; box-shadow: var(--shadow); overflow: hidden }
    .session .hdr { display: flex; align-items: center; gap: 8px; padding: 10px; background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border-bottom: 1px solid #ffffff18 }
    .session .title { font-weight: 850; max-width: 56vw; white-space: nowrap; overflow: hidden; text-overflow: ellipsis }
    .session .tools { margin-left: auto; display: flex; gap: 6px }
    .session .tools .btn:hover { box-shadow: 0 0 0 1px rgba(255,255,255,.18) inset, 0 8px 22px rgba(0,0,0,.35) }
    .session iframe { display: block; width: 100%; height: 60vh; border: 0; background: #000 }
    .session.min iframe { display: none }

    /* Permite redimensionar a altura do iframe dentro das sessões arrastando o canto inferior esquerdo */
    .session { position: relative; }
    .session .resize-handle {
      position: absolute;
      left: 8px;
      bottom: 8px;
      width: 16px;
      height: 16px;
      cursor: ns-resize;
      border-radius: 4px;
      background: rgba(255,255,255,.15);
      border: 1px solid rgba(255,255,255,.25);
    }
    .session .resize-handle:hover { background: rgba(255,255,255,.25); }

    /* ===== Dock + Tabs ===== */
    .dock { position: fixed; left: 10px; right: 10px; bottom: calc(var(--tabsH) + 8px + env(safe-area-inset-bottom)); display: none; gap: 8px; flex-wrap: wrap; z-index: 80 }
    .badge { display: inline-flex; gap: 6px; align-items: center; padding: .38rem .65rem; border: 1px solid #ffffff18; background: #0f1428; border-radius: 999px; font-weight: 800; position: relative }
    .badge.fx-trans:hover { box-shadow: 0 10px 24px rgba(0,0,0,.5) }
    nav.tabbar { position: fixed; left: 0; right: 0; bottom: env(safe-area-inset-bottom, 0); height: var(--tabsH); z-index: 1500; display: flex; justify-content: center; padding: 6px 14px }
    .tabbar .inner { width: 100%; max-width: 820px; display: flex; justify-content: space-around; align-items: center; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.14); backdrop-filter: blur(10px); border: var(--bd); border-radius: 22px; box-shadow: var(--shadow); padding: 10px 14px }
    .tab { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 6px; color: var(--mut); font-size: 11px; font-weight: 800; padding: 8px; border-radius: 14px; cursor: pointer; position: relative }
    .tab.fx-trans:hover { background: rgba(255,255,255,.06) }
    .tab.active { color: var(--fg); background: rgba(255,255,255,.10); box-shadow: 0 0 0 2px rgba(255,255,255,.10) }

    /* === Área de Arquétipos (central circle) === */
    .arch-container {
      /* Organize o círculo e o seletor em coluna.  Alinhe os elementos ao centro
         e adicione um pequeno espaçamento vertical.  A propriedade position
         relative permite posicionar o menu de opções de forma absoluta logo
         abaixo do círculo. */
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      justify-content: center;
      /* Dá mais espaço do topo, relativo à altura da viewport */
      margin-top: 5vh;
    }
    .arch-circle {
      position: relative;
      width: min(80vw, 560px);
      aspect-ratio: 1 / 1;
      border-radius: 50%;
      /* O conteúdo deve permanecer dentro da forma circular para evitar
         que o iframe quadrado “vaze” e pareça um quadrado. */
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.12);
      background: radial-gradient(60% 60% at 50% 50%, rgba(0,255,255,.1), rgba(255,255,255,.02));
      box-shadow: var(--shadow, 0 14px 40px rgba(0,0,0,.45));
      /* Animação de clique: quando a classe .pressed é aplicada via JS, reduza
         levemente o tamanho para simular pressão. */
      transition: transform .18s var(--ease);
    }

    .arch-circle.pressed {
      transform: scale(0.96);
    }

    .arch-circle iframe {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: 0;
      /*
       * Defina um plano de fundo escuro para o iframe do arquétipo. Quando um
       * PNG ou outro recurso não estiver disponível ou demora a carregar,
       * alguns navegadores exibem uma cor de fundo branca padrão. Ao
       * especificar explicitamente uma cor escura aqui, evitamos flashes
       * de branco e mantemos a estética coesa durante as transições.
       */
      background: #0b0f14;
    }

    /* ===== Splash overlay ===== */
    /* O elemento #appSplash cobre toda a tela enquanto o app carrega.
       Ele utiliza o loader UNO personalizado definido abaixo. */
    #appSplash {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      background: linear-gradient(42deg, var(--grad-a), var(--grad-b));
      z-index: 200;
      opacity: 1;
      visibility: visible;
      transition: opacity .3s var(--ease), visibility 0s linear .3s;
    }
    #appSplash.hidden {
      opacity: 0;
      visibility: hidden;
    }
    /* Crie elementos de fundo difuso atrás do loader para um efeito de luz suave.
       Estes pseudoelementos adicionam manchas coloridas em tons das cores do gradiente,
       ajudando a diferenciar o loader do plano de fundo. */
    #appSplash::before,
    #appSplash::after {
      content: "";
      position: absolute;
      width: 420px;
      height: 420px;
      border-radius: 50%;
      filter: blur(100px);
      opacity: .35;
      pointer-events: none;
    }
    #appSplash::before {
      background: var(--grad-a);
      top: -180px;
      left: -120px;
    }
    #appSplash::after {
      background: var(--grad-b);
      bottom: -180px;
      right: -120px;
    }

    /* ===== Loaders UNO e outros loaders ===== */
    /* Estes estilos são incorporados diretamente para evitar dependência externa. */
    .di{ --di-size:40px; --di-stroke:2px; --di-gold: color-mix(in oklab, var(--grad-a) 60%, var(--grad-b) 40%);
      position:relative;width:var(--di-size);height:var(--di-size); }
    /* Ajuste as cores do anel do loader para maior contraste no splash.
       Utilize um branco semi-transparente para destacá-lo contra o fundo colorido. */
    .di .ring{
      position:absolute;
      inset:0;
      /* Ajuste a opacidade do contorno branco para obter um efeito mais sutil no anel. */
      border:var(--di-stroke) solid rgba(255,255,255,0.35);
      border-radius:50%;
      animation:di-spin 6s linear infinite;
    }
    .di .stroke{position:absolute;left:50%;top:50%;width:62%;height:var(--di-stroke);
      background:linear-gradient(90deg,var(--grad-a),var(--grad-b));transform:translate(-50%,-50%);
      border-radius:999px;animation:di-breathe 2.4s ease-in-out infinite; }
    .di .dots{position:absolute;inset:0;transform:rotate(-90deg);animation:di-orbit 4.2s linear infinite; }
    .di .dots i{--i:0;position:absolute;left:50%;top:50%;width:4px;height:4px;border-radius:50%;
      background:conic-gradient(var(--grad-a),var(--grad-b));
      -webkit-mask: radial-gradient(circle, #000 62%, transparent 63%);
      mask: radial-gradient(circle, #000 62%, transparent 63%);
      opacity:.85;transform:rotate(calc(var(--i)*51deg)) translate(calc(7px + var(--i)*2.2px)) rotate(calc(var(--i)*-51deg));
      animation:di-pulse 4.2s linear infinite;animation-delay:calc(var(--i)*.6s); }
    @keyframes di-orbit{to{transform:rotate(270deg);}}
    @keyframes di-spin{to{transform:rotate(360deg);}}
    @keyframes di-breathe{0%,100%{opacity:.9;}50%{opacity:1;}}
    @keyframes di-pulse{0%,70%{opacity:.55;transform:scale(.92);}76%,84%{opacity:1;transform:scale(1.12);}100%{opacity:.7;transform:scale(.96);}}

    .simbio{position:relative;width:40px;height:40px; }
    .simbio .ringA,.simbio .ringB{position:absolute;inset:0;border-radius:50%;
      -webkit-mask:radial-gradient(farthest-side,transparent calc(50% - 1px),#000 calc(50% - 1px),#000 100%);
      mask:radial-gradient(farthest-side,transparent calc(50% - 1px),#000 calc(50% - 1px),#000 100%); }
    .simbio .ringA{background:conic-gradient(from 0deg,var(--grad-a),transparent 60%);animation:rotA 4.8s linear infinite; }
    .simbio .ringB{background:conic-gradient(from 180deg,var(--grad-b),transparent 60%);animation:rotB 6.2s linear infinite; }
    .simbio .stroke{position:absolute;left:50%;top:50%;width:60%;height:2px;background:linear-gradient(90deg,var(--grad-a),var(--grad-b));
      transform:translate(-50%,-50%);border-radius:999px;opacity:.9; }
    @keyframes rotA{to{transform:rotate(360deg);}}
    @keyframes rotB{to{transform:rotate(-360deg);}}

    .pulse{position:relative;width:40px;height:40px;display:grid;place-items:center; }
    .pulse .dot{width:8px;height:8px;border-radius:50%;background:linear-gradient(90deg,var(--grad-a),var(--grad-b)); }
    .pulse .wave{position:absolute;inset:0;border-radius:50%;animation:wave 2.4s ease-out infinite;opacity:.6; }
    .pulse .wave::before{content:"";position:absolute;inset:0;border-radius:50%;
      background:conic-gradient(var(--grad-a),var(--grad-b));
      -webkit-mask:radial-gradient(farthest-side,transparent calc(50% - 1px),#000 calc(50% - 1px),#000 100%);
      mask:radial-gradient(farthest-side,transparent calc(50% - 1px),#000 calc(50% - 1px),#000 100%); }
    .pulse .wave:nth-child(1){animation-delay:0s;} .pulse .wave:nth-child(2){animation-delay:.7s;} .pulse .wave:nth-child(3){animation-delay:1.4s; }
    @keyframes wave{0%{transform:scale(.5);opacity:.36;}50%{transform:scale(1.4);opacity:.58;}100%{transform:scale(1.35);opacity:.0;}}

    .coblux{position:relative;width:40px;height:40px;filter:drop-shadow(0 0 10px color-mix(in oklab,var(--grad-a) 35%, transparent)) drop-shadow(0 0 14px color-mix(in oklab,var(--grad-b) 25%, transparent)); }
    .coblux .ring{position:absolute;inset:0;border-radius:50%;background:conic-gradient(from 90deg,var(--grad-a),var(--grad-b));
      -webkit-mask:radial-gradient(farthest-side,transparent calc(50% - 1px),#000 calc(50% - 1px),#000 100%);animation:spinFast 2.4s linear infinite; }
    .coblux .trail{position:absolute;left:50%;top:50%;width:4px;height:4px;border-radius:50%;background:radial-gradient(circle at 35% 35%,#fff 0 20%,var(--grad-a) 40%,var(--grad-b) 100%);transform-origin:-12px 0;animation:trail 1.8s linear infinite; }
    @keyframes spinFast{to{transform:rotate(360deg);}}
    @keyframes trail{to{transform:rotate(360deg);}}

    .icon56{position:relative;width:56px;height:56px;display:block; }
    .home-base{position:absolute;left:50%;top:50%;width:36px;height:24px;border:3px solid var(--grad-b);border-top:3px solid transparent;
      transform:translate(-50%,-10px) scale(0);border-radius:5px;box-shadow:0 0 10px color-mix(in oklab,var(--grad-b) 60%, transparent);animation:homeBase 2.4s ease-in-out infinite; }
    .home-roof{position:absolute;left:50%;top:30%;width:0;height:0;border-left:18px solid transparent;border-right:18px solid transparent;border-bottom:20px solid var(--grad-b);
      transform:translateX(-50%) scaleX(0);filter:drop-shadow(0 0 8px color-mix(in oklab,var(--grad-a) 60%, transparent));animation:homeRoof 2.4s ease-in-out infinite; }
    @keyframes homeBase{0%{transform:translate(-50%,-10px) scale(0);}40%{transform:translate(-50%,-10px) scale(1);}80%{transform:translate(-50%,-10px) scale(1);}100%{transform:translate(-50%,-10px) scale(0);}}
    @keyframes homeRoof{0%{transform:translateX(-50%) scaleX(0);}50%{transform:translateX(-50%) scaleX(1);}100%{transform:translateX(-50%) scaleX(0);}}
    .asst-left,.asst-right{position:absolute;left:50%;top:50%;width:26px;height:26px;border-radius:50%;filter:drop-shadow(0 0 6px color-mix(in oklab,var(--grad-a) 50%, transparent)); }
    .asst-left{background:radial-gradient(circle at 50% 35%, var(--grad-b) 38%, transparent 39%), radial-gradient(circle at 50% 90%, var(--grad-b) 32%, transparent 33%);
      transform:translate(-50%,-50%) translateX(0);animation:aL 1.6s ease-in-out infinite; }
    .asst-right{background:radial-gradient(circle at 50% 35%, color-mix(in oklab, var(--grad-a) 70%, #ff7a00) 38%, transparent 39%), radial-gradient(circle at 50% 90%, color-mix(in oklab, var(--grad-a) 70%, #ff7a00) 32%, transparent 33%);
      transform:translate(-50%,-50%) translateX(0);animation:aR 1.6s ease-in-out infinite; }
    @keyframes aL{0%,100%{transform:translate(-50%,-50%) translateX(0) scale(1);}50%{transform:translate(-50%,-50%) translateX(-10px) scale(.95);}}
    @keyframes aR{0%,100%{transform:translate(-50%,-50%) translateX(0) scale(1);}50%{transform:translate(-50%,-50%) translateX(10px) scale(.95);}}
    .kob-ring{position:absolute;inset:6px;border-radius:50%;background:conic-gradient(from 0deg, var(--grad-b) 0 350deg, transparent 350deg 360deg);
      filter:drop-shadow(0 0 8px color-mix(in oklab,var(--grad-a) 60%, transparent));animation:spin 1.2s linear infinite; }
    .kob-spiral{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:22px;animation:spin 1.6s linear infinite reverse;
      filter:drop-shadow(0 0 6px color-mix(in oklab,var(--grad-b) 60%, transparent)); }
    @keyframes spin{to{transform:rotate(360deg);}}

    /* Texto animado no splash */
    #appSplash .loading-text {
      margin-top: 20px;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.04em;
      color: #f8f9fc;
      opacity: 1;
      /* Ajuste a animação para que o texto apareça suavemente,
         tornando-se totalmente visível no meio do ciclo e
         desaparecendo delicadamente. */
      animation: fadeUp 2.4s ease-in-out infinite;
    }
    @keyframes fadeUp {
      0%, 20% { opacity: 0; transform: translateY(12px); }
      40%, 60% { opacity: 1; transform: translateY(0); }
      80%, 100% { opacity: 0; transform: translateY(-12px); }
    }

  /* Certifique-se de que o logotipo de ponto e o círculo de arquétipo
     fiquem sobrepostos ao iframe. O seletor (arch-switcher) é
     configurado separadamente e fica fora do círculo. */
  .arch-dotlogo, .arch-circle {
    position: relative;
    z-index: 60;
  }
    .arch-switcher {
      /* O seletor fica fora do círculo, como um elemento próprio da
         coluna.  Não é posicionado de forma absoluta; sua posição é
         determinada pelo fluxo flex da .arch-container. */
      display: flex;
      gap: 6px;
      align-items: center;
      background: rgba(15,17,32,.7);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      padding: 4px 8px;
      backdrop-filter: blur(8px);
      z-index: 70;
    }
    .arch-switcher select {
      appearance: none;
      background: rgba(255,255,255,.06);
      color: var(--fg);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      /* Reduzir padding e tamanho de fonte para caber melhor fora do círculo */
      padding: 4px 8px;
      font-size: 12px;
    }

  /* Redimensionar botões do seletor de arquétipos para um tamanho mais compacto */
  .arch-switcher button {
    width: 30px;
    height: 30px;
    padding: 0;
    border-radius: 8px;
  }

    /* Quando o modo áudio está ativo, destaque o círculo com uma borda sutil */
    .arch-circle.audio-on {
      box-shadow: 0 0 0 2px var(--ok), var(--shadow);
    }

    /* Mensagem exibida fora do círculo do arquétipo.  Ela fica abaixo
       da bolinha e utiliza um fundo translúcido para garantir
       legibilidade.  O elemento aparece e desaparece com uma transição
       de opacidade. */
    .arch-msg {
      margin-top: 8px;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(15,17,32,.72);
      color: var(--fg);
      font-size: 13px;
      max-width: 90%;
      text-align: center;
      pointer-events: none;
      opacity: 0;
      transition: opacity .3s ease;
    }
    .arch-msg.show { opacity: 1; }

    /* Estilização do menu de arquétipos acionado ao tocar a bola.  O menu
       exibe opções de navegação (Apps, Stack, Usuário, Arquétipo e Revo)
       e fica escondido por padrão.  Quando a classe .show é aplicada,
       ele usa flexbox para alinhar os botões. */
    .arch-menu {
      /* O menu é posicionado de forma absoluta abaixo do círculo.  Por
         padrão, ele fica invisível até que a classe .show seja aplicada.
         A propriedade transform centraliza o menu horizontalmente em
         relação ao contêiner. */
      position: absolute;
      top: calc(100% + 10px);
      left: 50%;
      transform: translateX(-50%);
      display: none;
      gap: 10px;
      z-index: 70;
    }
    .arch-menu.show {
      display: flex;
    }
    .arch-menu button {
      border: var(--bd);
      background: var(--surface);
      border-radius: 12px;
      padding: 6px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--fg);
      font-size: 10px;
      cursor: pointer;
    }
    .arch-menu button:hover {
      box-shadow: 0 10px 24px rgba(0,0,0,.5);
    }

    /* Quando o botão de áudio está ativado, destaque-o com a cor "ok" */
    .arch-menu button.on {
      background: var(--ok);
      color: var(--surface-strong);
    }
    .arch-menu button.on img {
      filter: none;
    }
    .arch-menu button img {
      width: 20px;
      height: 20px;
      margin-bottom: 2px;
      filter: invert(1) brightness(1.2);
    }
    #arch-fadeCover {
      position: absolute;
      inset: 0;
      /* Use a cor do arquétipo ativo, se definida, para o fade. Isso
         torna a transição mais perceptível quando um novo arquétipo
         é selecionado.  Caso não haja overlay, caia para a cor de
         fundo padrão. */
      background: var(--arch-overlay, var(--bg, #0b0f14));
      opacity: 0;
      pointer-events: none;
      transition: opacity .3s ease;
    }
    #arch-fadeCover.show { opacity: 1; }

    /* Camada para ripples de áudio: fica sobre o conteúdo do círculo e ajusta a opacidade
       conforme a intensidade capturada pelo microfone. Utilizamos mix-blend-mode
       para adicionar um brilho sutil sem quebrar a estética minimalista. */
    .audio-ripple {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      /* A camada de ripple agora serve também como área de clique para ativar o modo áudio. */
      pointer-events: auto;
      /* Retire o gradiente, pois o efeito visual passa a ser aplicado via box-shadow no círculo */
      background: transparent;
      /* Mantenha um z-index alto para captar cliques acima do iframe */
      z-index: 70;
    }

    /* ===== Modal ===== */
    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 120; background: rgba(0,0,0,.45); backdrop-filter: blur(6px) }
    .modal.open { display: flex }
    .modal .panel { width: min(720px, 92vw); background: var(--surface-strong); border: var(--bd); border-radius: 16px; box-shadow: var(--shadow); padding: 16px }
    .kbd { border: 1px solid rgba(255,255,255,.2); background: rgba(255,255,255,.06); padding: 2px 6px; border-radius: 6px; font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 12px }

    /* ===== Chat (Dual • Chat) ===== */
    /* Configuração da seção de chat */
    #v-chat {
      padding: 0;
      /* Não defina display aqui; ele será controlado pela classe .view e .active */
      flex-direction: column;
      gap: 12px;
    }

    /* Certifique-se de que a seção de chat seja exibida somente quando ativa.
       A classe .view define display:none; quando .active é adicionada, tornamos flex para layout vertical. */
    #v-chat.view.active, #v-chat.active {
      display: flex;
    }
    #chatFeed {
      /* Mantenha um tamanho mínimo para que mensagens apareçam mesmo sem altura flex */
      min-height: 120px;
      overflow-y: auto;
      max-height: 46svh;
      background: var(--surface);
      border: var(--bd);
      border-radius: var(--r2);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    #chatFeed .msg {
      max-width: 75%;
      margin: 0;
      padding: 8px 12px;
      border-radius: 16px;
      word-wrap: break-word;
    }
    #chatFeed .msg.user {
      align-self: flex-end;
      background: rgba(255,255,255,0.10);
      border-radius: 16px 16px 0 16px;
    }
    #chatFeed .msg.ai {
      align-self: flex-start;
      background: rgba(57,255,182,0.12);
      border-radius: 16px 16px 16px 0;
    }
    #chatFeed .msg.status {
      align-self: center;
      color: var(--mut);
      font-size: 12px;
    }
    /* O formulário #chatForm e o campo #chatInput foram removidos.  O envio
       de mensagens é feito exclusivamente pelo overlay de texto fixo. */
    #msgPreview {
      position: fixed;
      left: 14px;
      right: 14px;
      bottom: calc(var(--tabsH) + 20px + env(safe-area-inset-bottom, 0));
      background: var(--warn);
      color: #0b0f14;
      border-radius: 18px;
      padding: 10px 14px;
      font-weight: 800;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      box-shadow: var(--shadow);
      z-index: 95;
      cursor: pointer;
      display: none;
  /* Limite de altura para o preview; evita estourar o layout e permite arrastar no chat */
  max-height: 33px;
  overflow: hidden;
    }
    /* Ajuste para preview quando nav está na lateral direita */
    body.nav-right #msgPreview {
      right: calc(88px + 14px);
      bottom: 14px;
    }

    /* ===== Overlay de entrada rápida na Home ===== */
    /* Removido: o botão #homeInputToggle não é mais utilizado; os controles
       de texto/voz são representados pelas bolinhas de ação. */
    #homeInputOverlay {
      position: fixed;
      left: 14px;
      right: 14px;
      bottom: calc(var(--tabsH) + env(safe-area-inset-bottom, 0));
      background: var(--surface-strong);
      border-radius: 18px 18px 0 0;
      border: var(--bd);
      padding: 12px;
      box-shadow: var(--shadow);
      z-index: 97;
      display: none;
    }
    #homeInputOverlay form {
      display: flex;
      gap: 8px;
    }
    #homeInputOverlay input {
      flex: 1;
      background: #0f1426;
      color: var(--fg);
      border: var(--bd);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 18px;
    }
    #homeInputOverlay input::placeholder {
      color: var(--mut);
    }
    #homeInputOverlay button {
      background: var(--ok);
      border: none;
      border-radius: 12px;
      padding: 0 16px;
      color: #0b0f14;
      font-weight: 700;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    /* Ajustes quando a navegação está na direita: reposicione o botão e overlay para não colidir com a barra */
    /* body.nav-right #homeInputToggle removido */
    body.nav-right #homeInputOverlay {
      left: 14px;
      right: calc(88px + 14px);
      bottom: calc(14px + env(safe-area-inset-bottom, 0));
    }

    /* ===== Botões duplos (texto/voz) na Home ===== */
    /* Variante lateral empilhada: os botões ficam no canto direito,
       empilhados um sobre o outro (coluna) para indicar ações distintas
       (texto e voz).  Ajustamos a posição para cima da barra de
       navegação. */
    .home-btns {
      position: fixed;
      right: 14px;
      left: auto;
      transform: none;
      bottom: calc(var(--tabsH) + 30px + env(safe-area-inset-bottom, 0));
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 10px;
      z-index: 97;
    }
    .home-btn {
      width: 42px;
      height: 42px;
      border-radius: 21px;
      background: var(--surface);
      border: var(--bd);
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .home-btn img {
      width: 20px;
      height: 20px;
    }
    .home-btn.active {
      background: var(--ok);
      color: #0b0f14;
    }
    /* Layout da barra de abas no modo nav-right */
    body.nav-right nav.tabbar {
      left: auto;
      right: 0;
      top: var(--hdrH);
      bottom: env(safe-area-inset-bottom, 0);
      width: 78px;
      height: auto;
      display: flex;
      justify-content: flex-start;
      padding: 6px 6px;
    }
    body.nav-right .tabbar .inner {
      width: 100%;
      max-width: none;
      flex-direction: column;
      align-items: center;
    }
    body.nav-right .tab {
      flex: none;
      width: 100%;
      margin: 4px 0;
    }
    body.nav-right main {
      padding-right: calc(78px + 14px);
      padding-bottom: calc(env(safe-area-inset-bottom, 0) + 12px);
    }
    /* ===== Estilos adicionais para grupos de sessões e fullscreen no Stack ===== */
    /* Container do grupo de sessões. Utiliza <details> para permitir colapsar/expandir. */
    .stack-group { margin-top: 12px; border: var(--bd); border-radius: var(--r); overflow: hidden; }
    .stack-group summary { background: var(--surface); padding: 8px 12px; font-weight: 800; cursor: pointer; list-style: none; display:flex; align-items:center; justify-content:space-between; }
    .stack-group summary::-webkit-details-marker { display: none; }
    .stack-group .group-content { padding: 8px 12px; }
    .stack-group .group-content .session { margin-top: 8px; }

    /* Deixe espaço no fim do Stack para a barra de navegação.  Isso evita que
       as sessões sobreponham os botões da nav inferior. */
    #stackWrap {
      padding-bottom: calc(var(--tabsH) + 16px);
    }

    /* Tela cheia de uma sessão: ocupa toda a tela, esconde cabeçalho e tabs */
    .session.full { position: fixed !important; inset: 0; z-index: 1000; margin: 0; width: 100%; height: 100%; display: flex; flex-direction: column; }
    .session.full iframe { flex: 1 1 auto !important; height: 100% !important; }
    /* No modo de tela cheia, esconda apenas o cabeçalho e o botão flutuante, mas mantenha a barra de navegação visível. */
    body.session-full header.mast,
    body.session-full .tabs-wrap,
    body.session-full .fab { display: none !important; }



/* === ORB + Particles (escopado dentro do círculo de arquétipos) === */
.arch-circle .orb-wrap{
  pointer-events:auto;
  position:absolute;
  inset: 6%;
  width: 88%;
  height: 88%;
  display:grid;
  place-items:center;
  border-radius:50%;
  filter: drop-shadow(0 24px 48px rgba(0,0,0,.45));
  z-index: 5; /* acima do iframe, abaixo de overlays de UI */
}
.arch-circle canvas#orb, .arch-circle canvas#particles{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  border-radius:50%;
  display:block;
  pointer-events:none; /* não bloquear cliques do hub */
}
.arch-circle .orb-glow{
  position:absolute;
  inset:-8%;
  border-radius:50%;
  pointer-events:none;
  background:radial-gradient(60% 60% at 50% 50%, rgba(122,60,255,.18), rgba(0,229,255,.14) 45%, rgba(0,0,0,0) 70%);
  filter:blur(16px);
  opacity:.92;
  transition:opacity .6s ease, transform .6s ease;
}
.arch-circle .orb-wrap.activated .orb-glow{ transform:scale(1.05); }
.arch-circle .ring{
  position:absolute;
  inset:-8%;
  border-radius:50%;
  pointer-events:none;
  background: radial-gradient(80% 80% at 50% 50%, rgba(255,255,255,.10), rgba(255,255,255,0) 42%);
}
.arch-circle .call{
  position:absolute;
  bottom: 12px;
  left: 50%;
  transform: translateX(-50%);
  color: rgba(234,242,255,.78);
  font-size: 11px;
  letter-spacing: .3px;
  text-align: center;
  white-space: nowrap;
  pointer-events: none;
  opacity: .85;
  text-shadow: 0 1px 0 rgba(0,0,0,.5);
}
@media (min-width:768px){
  .arch-circle .call{ font-size:12px; }
}
</style>
<style id="blue1Theme">
/* === Blue‑1 Theme (UI) === */
:root {
  --bg: #070b12;
  --fg: #e6f2ff;
  --muted: #94b6d6;
  --brandA: #00c2ff;
  --brandB: #4b6fff;
  --brandHi: #8fd3ff;
  --glass: rgba(12,16,24,.64);
  --glass-2: rgba(12,16,24,.42);
  --ring: 0 0 0 1px rgba(143,211,255,.3), 0 0 18px rgba(0,194,255,.25);
}
body { background: radial-gradient(1200px 800px at 60% -10%, #0a1220 0%, #070b12 55%, #05080f 100%); color: var(--fg); }
.topbar, .subbar, .dock, .pane, .card, .tile, .shelf { background: var(--glass); backdrop-filter: blur(10px); border: 1px solid rgba(143,211,255,.12); box-shadow: var(--ring); }
button, .btn, .chip { background: linear-gradient(180deg, rgba(13,22,34,.7), rgba(9,14,22,.7)); border: 1px solid rgba(143,211,255,.18); }
a { color: var(--brandHi); }
</style>
<style id="customStyle">/* --------------------------------------------
   KOBLLUX • Compact Mode — Mobile-first Vertical
   Colar após o CSS atual
--------------------------------------------- */

/* Base compacta + segurança */
*,
*::before,
*::after { box-sizing: border-box; }
html, body { max-width: 100%; overflow-x: hidden; }
body { padding-bottom: calc(16px + env(safe-area-inset-bottom)); }

/* Container nunca estoura, sem “gambiarra” de largura */
.response-container {
  inline-size: min(100%, calc(100% - 0px)) !important;
  padding: 1rem 0 2.75rem; /* + espaço safe-area já no body */
}

/* Nada lado a lado por padrão — empilha tudo */
.row,
.controls,
.kv,
.columns,
.split {
  display: block !important;
}

/* Qualquer tentativa de grid vira 1 coluna */
[class*="grid"],
[style*="grid-template-columns"],
.columns,
.split,
.panel,
.kv {
  display: grid !important;
  grid-template-columns: 1fr !important;
  align-items: stretch;
  gap: .5rem !important;
}

/* Pares “key→value” agora empilhados */
.kv > * { margin: 0 0 .4rem 0; }

/* Grupos de controles em coluna, ocupando 100% */
.controls .group {
  display: block !important;
  width: 100%;
  padding: .5rem .6rem;
  margin: 0 0 .6rem 0;
}
.controls .group > label,
.controls .group > select,
.controls .group > input,
.controls .group > button { display: block; width: 100%; }

/* Botões e inputs: alvo de toque ≥44px */
.btn,
select,
input[type="text"],
input[type="file"],
input[type="range"],
input[type="checkbox"],
input[type="radio"],
label[for],
textarea {
  min-height: 44px;
}

/* Botão Único: respeita safe-area no iOS */
#btnKOBLLUX { 
  bottom: calc(1rem + env(safe-area-inset-bottom));
}

/* Navegações/chips SOMENTE na header: scroll horizontal, sem wrap */
.header .row {
  display: block !important;
  overflow-x: auto;
  white-space: nowrap;
  scrollbar-width: thin;
  -webkit-overflow-scrolling: touch;
  padding-bottom: .25rem;
  margin-bottom: .25rem;
}
.header .row > * {
  display: inline-block;
  vertical-align: top;
  margin-right: .5rem;
}

/* Dropzone 100% vertical */
.dropzone .dz-area { display: block !important; }
.dropzone .row { display: block !important; }
.dropzone .row > * { display: block; width: 100%; margin: .5rem 0 0; }

/* Editor e Preview sempre empilhados (Preview abaixo)
   Use #analysis como Preview, ou crie #preview se preferir. */
.editor {
  width: 100%;
  min-height: 48vh;
  height: 52vh;          /* alvo ~50–60vh */
  max-height: 60vh;
  overflow: auto;
}
#analysis,
#preview {
  display: block;
  width: 100%;
  min-height: 42vh;
  height: 50vh;          /* alvo ~50–60vh */
  max-height: 60vh;
  overflow: auto;
  white-space: pre-wrap;  /* evita overflow lateral */
  word-wrap: break-word;
}

/* Cards/listas/painéis: pilha vertical com scroll interno quando necessário */
.response-block.glass,
.panel {
  max-height: unset;     /* deixe rolar a página */
}
.panel[data-scroll],
.response-block.glass[data-scroll],
.card[data-scroll],
[list][data-scroll] {
  max-height: 60vh;
  overflow: auto;
}

/* Controles verticais: sliders + labels exibidos em coluna */
.controls label { margin: 0 0 .25rem 0; }
.controls input[type="range"] { margin: .25rem 0 .5rem; }

/* Sliders com preenchimento dinâmico (mantém seu gradiente) */
input[type="range"]{
  /* estes tokens são calculados por JS no seu app, mantidos aqui */
  inline-size: 100%;
}

/* Toggle (Auto‑detectar): aumenta para tap ≥44px */
#autoDetect{
  --w: 72px; --h: 44px; --pad: 4px;
  min-height: 44px;
}

/* SELECT e BTN ocupam a linha inteira no modo compact */
select,
.btn { width: 100%; }

/* Grids/tabelas internas que insistem em múltiplas colunas → força 1fr */
[role="grid"],
[role="table"],
table,
.table,
.list,
.cards,
.cards-grid,
.items-grid {
  display: grid !important;
  grid-template-columns: 1fr !important;
}

/* Editor/Preview evitando sangrar lateralmente (longas strings/URLs) */
.editor,
pre { word-break: break-word; }

/* Header único (nenhum footer fixo) — nenhuma regra extra de footer */

/* Safe-area e “tap spacing” no rodapé de ações flutuantes/badges */
.badge-reopen { 
  bottom: calc(1rem + env(safe-area-inset-bottom));
}

/* Animação e sombras mais discretas (versão compact) */
.glass { padding: .75rem .9rem; }
.btn { padding: .7rem 1rem; }

/* Scroll horizontal utilitário (caso queira aplicar em outra nav) */
.h-scroll { overflow-x: auto; white-space: nowrap; }
.h-scroll > * { display: inline-block; }

/* Qualquer .columns e .split SEMPRE block (reforço final) */
.columns, .split { display: block !important; }

/* Segurança extra: força colunas únicas em componentes “teimosos” */
[class*="columns-"],
[class*="cols-"],
[class*="grid-"] {
  grid-template-columns: 1fr !important;
}

/* Evitar wrap de ícones/textos em chips sem quebrar layout */
.pill { display: inline-block; }

/* Garantir que iFrame seguro não crie overflow lateral */
.ifr { inline-size: 100%; max-inline-size: 100%; }
.ifr .bar { display: block; }
.ifr .bar .spacer { display: none; }
.ifr .bar .btn,
.ifr .bar .btn.ghost { width: 100%; margin-top: .4rem; }

/* Acessibilidade: foco visível “compact” */
:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(57,255,182,.18); }

/* Restrições finais — nada lado a lado fora da header */
main .row { display: block !important; }
main .row > * + * { margin-top: .5rem; }

/* (Opcional) reduz micro gaps gerais para versão compacta */
.stack { gap: .5rem !important; }
:root{--radius:12px;--blur:16px;--shadow:0 6px 26px rgba(0,255,255,.22);--fast:.12s;--med:.2s;--slow:.45s;--focus-ring:0 0 0 3px rgba(57,255,182,.22);font-synthesis-weight:none}html,body{overflow-x:hidden}body{padding-bottom:max(12px,env(safe-area-inset-bottom))}.response-container{width:min(100%,100% - 0px)!important;padding:1rem 0 4rem}.glass{border-radius:var(--radius);backdrop-filter:blur(var(--blur));box-shadow:var(--shadow);transition:box-shadow var(--med) ease,filter var(--med) ease,transform var(--med) ease}.glass:hover{filter:brightness(1.02)}.row,.controls,.controls .group,.kv,.panel,.stack,.dropzone .dz-area,.header,.sheet,.ifr,.ifr .bar{display:block!important}.row>*,.controls>*,.controls .group>*,.panel>*{margin-block:.55rem}.columns,.split{display:block!important}.header,.panel,.kv,.stack,[class*="grid"],[style*="grid-template-columns"]{grid-template-columns:1fr!important}.editor{min-height:52svh;max-height:60svh;width:100%;resize:vertical;overflow:auto}.preview,#preview{display:block;margin-top:.8rem;min-height:48svh;max-height:58svh;overflow:auto}.header .row.small{display:flex!important;flex-direction:row;flex-wrap:nowrap!important;gap:.5rem;overflow-x:auto;overflow-y:hidden;white-space:nowrap;-webkit-overflow-scrolling:touch;scroll-snap-type:x proximity}.header .row.small>*{flex:0 0 auto;scroll-snap-align:start}:where(button,.btn,[role="button"],label,select,input,textarea,.pill){min-block-size:44px;touch-action:manipulation;-webkit-tap-highlight-color:rgba(255,255,255,.08)}.btn{width:100%;justify-content:center;text-align:center;transition:transform var(--fast) ease,filter var(--fast) ease,box-shadow var(--fast) ease!important}.btn:active{transform:translateY(1px) scale(.995)}#btnKOBLLUX{bottom:calc(1rem + env(safe-area-inset-bottom))}select,.select,textarea,input[type="text"],input[type="email"],input[type="search"],input[type="number"]{width:100%;max-width:100%}input[type="range"]{width:100%!important;min-block-size:44px}.card,.list,.grid,.panel,.sheet,.overlay .sheet,.ifr{max-height:86svh;overflow:auto}footer{position:static!important;inset:auto!important}.header .title{font-weight:700;letter-spacing:.2px}.kv{display:block!important}.kv .muted,.kv .val{display:block}.controls .group{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.08);padding:.6rem .7rem}.pill{padding:.44rem .66rem}.meter{width:100%}.ifr{grid-template-rows:auto 1fr!important}.ifr .bar>*{margin-block:.4rem}@media (prefers-reduced-motion:reduce){*{animation-duration:.001ms!important;animation-iteration-count:1!important;transition-duration:.001ms!important;scroll-behavior:auto!important}}</style>
<style id="multiagent-styles">
  #chatFeed .msg.horus{align-self:flex-start;background:rgba(255,195,0,.16);border-radius:16px 16px 16px 0;padding:8px 12px;max-width:75%}
  #chatFeed .msg.atlas{align-self:flex-start;background:rgba(64,158,255,.16);border-radius:16px 16px 16px 0;padding:8px 12px;max-width:75%}
  #chatFeed .msg.ion{align-self:flex-start;background:rgba(255,159,67,.16);border-radius:16px 16px 16px 0;padding:8px 12px;max-width:75%}
  #chatFeed .msg.status{align-self:center;color:var(--mut);background:transparent}
  .ai-tag{font-weight:900;letter-spacing:.02em;margin:0 0 4px 0;opacity:.9}
  .ai-meta{font-size:12px;color:var(--mut)}
  .plan-list{margin:6px 0 0 0;padding-left:18px}
  .plan-list li{margin:4px 0}
  </style>
<style id="patch-blue1-theme">

/* === PATCH • Blue‑1 UI theme (entire UI) === */
body[data-theme="blue1"] {
  --grad-a: #0b1e3b;
  --grad-b: #113a7b;
  --fg: #e8f0ff;
  --mut: rgba(232,240,255,.68);
  --surface: rgba(10,16,28,.55);
  --surface-strong: rgba(10,16,28,.88);
  --bd: 1px solid rgba(126,170,255,.16);
  --ok: #39ffb6;
  --warn: #ffb86b;
  --err: #ff6b6b;
  --blur: 28px;
}
/* Chat styling tuned to Blue‑1 */
body[data-theme="blue1"] #chatFeed .msg.ai { background: rgba(77, 148, 255, 0.14); }
body[data-theme="blue1"] #chatFeed .msg.user { background: rgba(232,240,255,0.10); }

</style>
<style id="overlay-defaults">
:root{
  --arch-color: #8a2be2;
  --arch-overlay-strength: 12%; /* −1 default */
  --arch-overlay: color-mix(in srgb, var(--arch-color) var(--arch-overlay-strength), transparent);
}
body::after{content:'';position:fixed;inset:0;background:var(--arch-overlay, transparent)!important;pointer-events:none;z-index:0}
#arch-fadeCover{background:var(--arch-overlay, transparent);z-index:2}
</style>
<style id="ls-panel-css">
#lsModal.ls-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1200;background:rgba(0,0,0,.55);backdrop-filter:blur(8px)}
#lsModal.ls-modal.open{display:flex}
#lsModal .ls-panel{width:min(1040px,95vw);max-height:86vh;overflow:auto;background:rgba(15,17,32,.92);border:1px solid rgba(255,255,255,.12);border-radius:18px;box-shadow:0 12px 34px rgba(0,0,0,.4);padding:14px;color:#f5f7ff;font:14px/1.45 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
#lsModal .ls-hdr{display:flex;gap:10px;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,.12);padding-bottom:10px;margin-bottom:10px}
#lsModal .ls-ttl{font-weight:900;letter-spacing:.06em}
#lsModal .ls-actions{display:flex;gap:8px;flex-wrap:wrap}
#lsModal button{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
#lsModal button:hover{background:rgba(255,255,255,.18)}
#lsModal .meta{color:#cfd8dc;font-size:12px;margin:8px 0 10px}
#lsModal .presets{border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:8px;background:rgba(255,255,255,.04);margin:10px 0}
#lsModal .presets-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px;margin-top:8px}
#lsModal .preset{border:1px solid rgba(255,255,255,.12);border-radius:12px;background:rgba(255,255,255,.04);padding:10px;display:grid;gap:6px}
#lsModal .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
#lsModal .val{font:12px/1.4 ui-monospace,monospace;background:#0b0f1a;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:8px;max-height:140px;overflow:auto;word-break:break-word}
#lsModal .list{display:grid;gap:10px}
#lsModal .item{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px;display:grid;gap:8px}
#lsModal .item .head{display:flex;align-items:center;justify-content:space-between;gap:8px}
#lsModal .key{font-weight:800;max-width:56vw;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
#lsModal .type{font-size:11px;color:#cfd8dc}
#lsModal .switch{inline-size:46px;block-size:28px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.15);position:relative;cursor:pointer}
#lsModal .switch::after{content:"";position:absolute;inset:4px auto 4px 4px;width:20px;border-radius:999px;background:#fff;transition:all .18s}
#lsModal .switch.on{background:rgba(25,226,123,.28)}
#lsModal .switch.on::after{left:22px}
#lsModal .img-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}
#lsModal .img-card{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);border-radius:10px;padding:8px}
#lsModal .img-card img{width:100%;height:auto;display:block;border-radius:8px}
#lsModal .sk-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:720px){#lsModal .sk-grid{grid-template-columns:1fr}#lsModal .key{max-width:46vw}}
#lsModal .sk-item{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px;display:grid;gap:8px}
#lsModal .sk-item .top{display:flex;align-items:center;justify-content:space-between;gap:8px}
#lsModal .sk-item .name{font-weight:800}
#lsModal .sk-item .key{font:12px/1.4 ui-monospace,monospace;opacity:.85;word-break:break-all}
#lsModal .sk-item button{font-size:.75rem;padding:4px 8px;border-radius:8px}
#lsModal .sk-item button:first-child{background:rgba(57,255,182,.18)}
#lsModal .sk-item button:last-child{background:rgba(255,92,138,.18)}
/* inside LS overlay ctl */
#lsModal .seg{display:inline-grid;grid-auto-flow:column;gap:6px}
#lsModal .ls-ov{min-width:40px;padding:6px 8px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.08);color:#fff;cursor:pointer;font-weight:700}
#lsModal .ls-ov.on{background:rgba(57,255,182,.20);border-color:rgba(57,255,182,.45)}
</style>
<style id="show-app-title-css">.app-title{display:inline-flex;align-items:center;gap:6px}</style>
<style id="overlay-css-unify">
/* Ensure overlay rendering is unified across variants */
body::after{
  content: "";
  position: fixed;
  inset: 0;
  background: var(--arch-overlay, transparent) !important;
  pointer-events: none;
  z-index: 0;
}
</style>
<style id="overlay-guardian-css">
html[data-overlay="off"] body::after{ background: transparent !important; }
html[data-overlay="off"] #arch-fadeCover{ background: transparent !important; }
</style>
<style id="orb-slot-css">
/* === ORB Slot (iframe "dentro" do orbe) === */
.arch-circle { position: relative; }
#orbWrap { position: relative; }
#orbWrap canvas#orb,
#orbWrap .orb-glow,
#orbWrap .ring,
#orbWrap canvas#particles { position: absolute; inset: 0; }

/* Z-order for sandwiching */
#orbWrap canvas#orb { z-index: 1; }
#orbWrap .orb-glow { z-index: 2; }
#orbWrap .orb-slot   { z-index: 3; } /* iframe masked */
#orbWrap canvas#particles { z-index: 4; }
#orbWrap .ring { z-index: 5; }
/* HUB overlays keep above */
#arch-fadeCover, #audioRipple { z-index: 6; }

/* Masked slot inside the orb */
.orb-slot{
  position:absolute;
  inset: 8%;              /* adjust 6–10% to taste */
  border-radius: 50%;
  overflow: hidden;
  -webkit-clip-path: circle(50% at 50% 50%);
          clip-path: circle(50% at 50% 50%);
  mix-blend-mode: screen;
  opacity: .92;
  filter: saturate(1.06) contrast(1.04);
  will-change: transform, opacity, filter;
  pointer-events: auto;   /* allow interaction inside the archetype app */
}
.orb-slot iframe#arch-frame{
  position:absolute; inset:0;
  width:100%; height:100%;
  border:0; background:#0b0f14; /* avoid white flash */
  transform: translateZ(0);
}
/* Tint with archetype overlay color */
.orb-slot::after{
  content:"";
  position:absolute; inset:0;
  background: var(--arch-overlay, transparent);
  pointer-events:none;
  mix-blend-mode: overlay;
  opacity:.35;
  transition: opacity .25s ease;
}
</style>
<style id="hdpro-override">

/* === HD•PRO Override (Dual UNO) ==============================
   - Handle (quase invisível) para abrir/fechar LS Panel (#brain)
   - Painel "HD Pro" dentro do LS Panel (estatísticas + ações)
   - Metrificadores animados de Storage (LocalStorage/IndexedDB/Total)
   - Toggle para colapsar opções avançadas do ORB/FPS
   ================================================================= */
:root{
  --hdpro-glass: rgba(12,16,24,.64);
  --hdpro-line: 1px solid rgba(143,211,255,.14);
  --hdpro-ok: var(--ok, #39ffb6);
  --hdpro-warn: var(--warn, #ffb86b);
  --hdpro-err: var(--err, #ff6b6b);
}

/* Botão/área de pega "tango" (quase invisível) */
#lsHandle{
  position: fixed;
  top: calc(env(safe-area-inset-top, 8px) + 6px);
  left: 8px;
  width: 16px;
  height: 16px;
  border-radius: 999px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.18);
  box-shadow: 0 8px 20px rgba(0,0,0,.45);
  opacity: .14;
  z-index: 1600;
  transition: opacity .18s ease, transform .18s ease, background .18s ease;
  backdrop-filter: blur(6px);
}
#lsHandle:hover, #lsHandle:active{ opacity:.42; transform: scale(1.06); }
#lsHandle.on{ opacity:.8; background: rgba(57,255,182,.25); }

/* Painel HD Pro embutido no LS (#brain .popover) */
.hdpro-sec{
  margin-top: 10px;
  padding: 10px;
  border-radius: 16px;
  background: var(--hdpro-glass);
  border: var(--hdpro-line);
  box-shadow: 0 10px 24px rgba(0,0,0,.35);
}
.hdpro-sec .sec-hdr{
  display:flex; align-items:center; justify-content:space-between;
  gap:10px; margin-bottom:8px;
}
.hdpro-sec .sec-hdr h3{
  margin:0; font-weight:900; font-size:14px; letter-spacing:.04em;
}
.hdpro-grid{
  display:grid; grid-template-columns: 1fr; gap:10px;
}
.hdpro-row{ display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; }
.hdpro-actions{ display:flex; gap:8px; flex-wrap:wrap; }

/* Meters */
.hdpro-meter{
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 10px;
  overflow: hidden;
  height: 14px;
  position: relative;
}
.hdpro-meter .bar{
  position:absolute; left:0; top:0; height:100%;
  width:0%;
  background: linear-gradient(90deg, var(--grad-a), var(--grad-b));
  transition: width .8s cubic-bezier(.22,.61,.36,1);
  box-shadow: inset 0 0 12px rgba(0,0,0,.25);
}
.hdpro-label{ font-size:12px; color: var(--mut, rgba(245,247,255,.68)); }
.hdpro-val{ font-size:12px; font-weight:800; }

/* Toggle de avançados ORB/FPS */
.hdpro-toggle{
  display:flex; align-items:center; gap:8px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 12px; padding: 8px 10px;
  font-size:12px; font-weight:800;
  cursor:pointer;
}
.hdpro-adv-hidden{ display:none !important; }

/* Botões compactos coerentes com tema */
.hd-btn{ 
  background: linear-gradient(180deg, rgba(13,22,34,.7), rgba(9,14,22,.7));
  border: 1px solid rgba(143,211,255,.18);
  color: var(--fg);
  border-radius: 12px; padding: 8px 10px; font-weight:800;
}
.hd-btn.danger{ border-color: rgba(255,107,107,.35); }
.hd-btn.ok{ border-color: rgba(57,255,182,.35); }

/* Toast simples */
#hdToast{
  position: fixed; left: 50%; transform: translateX(-50%);
  bottom: calc(14px + env(safe-area-inset-bottom, 0));
  background: rgba(12,16,24,.92);
  border: 1px solid rgba(255,255,255,.18);
  color: var(--fg);
  border-radius: 14px; padding: 10px 14px;
  font-weight:800; font-size:12px;
  box-shadow: 0 14px 40px rgba(0,0,0,.45);
  z-index: 1700; opacity: 0; pointer-events: none;
  transition: opacity .25s ease, transform .25s ease;
}
#hdToast.show{ opacity: 1; transform: translateX(-50%) translateY(-4px); }

</style>
<style>
/* Gradient icon tuning (Send/Voice/Text) */
#homeInputOverlay button svg, #homeVoiceBtn svg, #homeTextBtn svg{
  display:block;
}

</style>
<style>
/* Tabbar gradient tune */
.tabbar .tab { color: var(--muted); }
.tabbar .tab.active { color: var(--fg); }
.tabbar .tab svg { display:block; margin: 0 auto 2px; }

</style>
<style>
/* Inline gradient icons — unify sizing/alignment */
button svg, .tabbar .tab svg { display:block; }

</style>
<style id="ATOM_UI_PATCH">
/* 1) círculo real, tudo recortado */
.arch-circle{
  border-radius: 50% !important;
  overflow: hidden !important;
  isolation: isolate; /* blenda só dentro do círculo */
}

/* 2) pseudo-elements sempre circulares + sem clique */
.arch-circle::before,
.arch-circle::after{
  content:"";
  position:absolute; inset:0;
  border-radius: inherit;
  pointer-events: none;
}

/* 3) tinta com fade radial (sem quadrado) */
.arch-circle::after{
  z-index: 6;
  background: radial-gradient(circle at 50% 50%,
              var(--arch-overlay, rgba(64,158,255,.22)) 62%,
              rgba(64,158,255,0) 86%);
  mix-blend-mode: overlay;
  opacity: .35; /* se quiser mais forte: .5 ~ .6 */
  transition: opacity var(--arch-switch-fade, 120ms) ease;
}

/* 4) véu só durante a troca (evita flash) */
html.arch-switching .arch-circle::after{ opacity: 0; }
.arch-circle::before{
  z-index: 7; opacity: 0;
  transition: opacity var(--arch-switch-fade, 120ms) ease;
}
html.arch-switching .arch-circle::before{
  opacity: 1;
  background: radial-gradient(circle at 50% 50%,
              var(--arch-veil-core, rgba(12,14,24,.88)) 62%,
              rgba(12,14,24,0) 86%);
}

/* 5) canvas do átomo fica sob o overlay e clippado ao círculo */
.arch-circle > canvas#atomCanvas{
  position:absolute; inset:0; pointer-events:none;
  z-index: 5; /* abaixo do ::after(6) e ::before(7) */
  opacity:.88; mix-blend-mode:screen; filter:saturate(120%) contrast(110%);
}

/* 6) botões por cima e clicáveis */
.arch-circle .arch-nav,
.arch-circle [data-arch-nav],
.arch-circle .arch-controls,
.arch-circle .arch-controls *,
.arch-nav, .arch-nav *,
[data-arch-nav], [data-arch-nav] *,
#arch-next, #arch-prev, #archetypeNext, #archetypePrev,
.btn-arch-next, .btn-arch-prev, .arrow-arch-next, .arrow-arch-prev{
  position: relative;
  z-index: 30 !important;
  pointer-events: auto !important;
}
</style>
<style id="OVERLAY_BG_ONLY">
/* Mantém o overlay sempre no background (atrás de tudo). */
body::after{ content:none !important; }
/* Overlay como camada de background (1ª), gradiente Nebula/Blue atrás dela (2ª). */
body{
  background:
    radial-gradient(120% 120% at 50% 40%,
      var(--arch-overlay, rgba(0,0,0,0)) 0%,
      rgba(0,0,0,0) 62%),
    linear-gradient(42deg, var(--grad-a), var(--grad-b)) fixed !important;
}
</style>
<style id="CHAT13_CSS">
.chat-wrap{display:grid;gap:12px}
.chat-pulse{position:relative;height:10px;border-radius:999px;
  background:linear-gradient(90deg,var(--grad-a),var(--grad-b));opacity:.8;overflow:hidden}
.chat-pulse::after{content:"";position:absolute;inset:0;
  background:radial-gradient(60% 120% at 0% 50%, #fff8 0%, #fff0 60%);
  animation:pulseRun 2.8s cubic-bezier(.22,.61,.36,1) infinite}
@keyframes pulseRun{0%{transform:translateX(-40%)}50%{transform:translateX(40%)}100%{transform:translateX(140%)}}

.chat-feed{display:grid;gap:10px}
.msg{background:var(--surface);border:var(--bd);border-radius:14px;padding:10px}
.msg.role-user{border-color:#ffffff2a}
.msg.role-assistant{box-shadow:0 10px 32px rgba(0,0,0,.35)}
.msg h5{margin:.2rem 0 .35rem;font-size:12px;letter-spacing:.08em;color:var(--mut);text-transform:uppercase}

.chat-composer{display:flex;gap:8px;align-items:center;position:sticky;bottom:0;
  background:linear-gradient(180deg,rgba(0,0,0,0),rgba(0,0,0,.2));
  padding:10px;border-radius:16px}
.chat-composer textarea{flex:1;min-height:44px;max-height:36vh;resize:vertical;border-radius:12px;
  padding:10px 12px;border:var(--bd);background:rgba(255,255,255,.04);color:var(--fg)}
.chat-composer .btn{white-space:nowrap}
</style>
<style id="fix-logs-titles-78k">
/* Brain logs wrap */
#brainLogs, .brain-logs, #logs {
  white-space: pre-wrap;
  overflow-wrap: anywhere;
  word-break: break-word;
  line-height: 1.35;
  max-width: 100%;
  max-height: 32vh;
  overflow: auto;
  background: rgba(0,0,0,.18);
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 10px;
  padding: 10px;
  font: 12px/1.35 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
}
/* App titles clamp */
.app-card .app-title, [data-role="app-title"], .app-title {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}
/* App subtitle/desc (opcional) */
.app-card .mut, .app-desc {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
}
/* Estado 78K visual + botão */
html[data-78k="on"] .arch-circle { box-shadow: 0 0 0 2px rgba(255,215,0,.25), 0 18px 48px rgba(255,215,0,.20); }
html[data-78k="on"] #orbCanvas, html[data-78k="on"] #particles { filter: saturate(1.2) brightness(1.04); }
#btn78K.on { background: linear-gradient(90deg, #ffd700, #ff9f43); color:#0b0f14; border-color: transparent; }
/* Orb layer fix (se ainda não tiver) */
.arch-circle { position:relative; overflow:hidden; border-radius:50%; }
#orbWrap { position:absolute; inset:6%; width:88%; height:88%; z-index:0; pointer-events:none; }
#orbWrap canvas { pointer-events:none; display:block; border-radius:50%; }
#arch-frame { position:absolute; inset:0; width:100%; height:100%; z-index:2; background:#0b0f14; border:0; }
#arch-fadeCover { z-index:6; }
</style>
<style id="ls-fab-css">
/* LS Panel quick actions (floating) */
#lsModal .ls-fabbar{
  position: fixed; right: clamp(12px, 2vw, 18px); bottom: clamp(12px, 2vh, 18px);
  display:flex; flex-direction:column; gap:10px; z-index: 1602;
}
#lsModal .ls-fab{
  width: 46px; height: 46px; border-radius: 50%; border:1px solid rgba(255,255,255,.18);
  background: rgba(6,10,18,.85); color:#fff; display:grid; place-items:center; cursor:pointer;
  box-shadow: 0 10px 26px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.06);
  font-weight:900; font-size:18px; user-select:none;
}
#lsModal .ls-fab:hover{ background: rgba(12,18,28,.92) }
#lsModal .ls-fab.refresh::after{ content:"\21BB"; }  /* ↻ */
#lsModal .ls-fab.close::after{ content:"\00D7"; }    /* × */

/* Globals editor */
#lsGlobalsBox{
  display:none; margin-top:10px; border:1px solid rgba(255,255,255,.12); border-radius:12px;
  background: rgba(8,12,18,.55); padding:10px;
}
#lsGlobalsBox .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:space-between; }
#lsGlobalsTxt{
  width:100%; min-height:140px; resize:vertical; background:#0f1426; color:#E8F1F2;
  border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:10px; font:12px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
}
#lsGlobalsErr{ color:#ffbcbc; font-size:12px; min-height:16px; }
#lsModal .ls-actions .ghost{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:6px 8px; cursor:pointer; }
</style>
<style id="ls-78k-css">
/* Estado 78K row spacing */
#ls78kBox{ margin-top:10px; border:1px solid rgba(255,255,255,.12); border-radius:12px; background:rgba(8,12,18,.4); padding:10px; }
</style>
<style id="hdr-fix-compact">
:root{ --hdrH: 56px; }          /* antes: ~66px */
header.mast{ height: var(--hdrH); min-height: var(--hdrH); padding-top: 0; padding-bottom: 0; }
header.mast .title h1{ line-height: 1; }
main{ padding-top: calc(var(--hdrH) + env(safe-area-inset-top)); } /* já usava isso; reafirma */
</style>
<style id="ls-fab-css-v2">
#lsFabLayer{
  position: fixed; right: clamp(12px, 2vw, 18px); bottom: clamp(12px, 2vh, 18px);
  display: none; flex-direction: column; gap: 10px; z-index: 1700;
}
#lsModal.open ~ #lsFabLayer{ display: flex; }
#lsFabLayer .ls-fab{
  width: 48px; height: 48px; border-radius: 50%;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(6,10,18,.88); color:#fff; display:grid; place-items:center; cursor:pointer;
  box-shadow: 0 10px 26px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.06);
  font-weight:900; font-size:18px; user-select:none;
}
#lsFabLayer .ls-fab:hover{ background: rgba(12,18,28,.95) }
#lsFabRefresh::after{ content:"\21BB"; } /* ↻ */
#lsFabClose::after{ content:"\00D7"; }   /* × */
</style>
<style id="chatplus-styles">

/* ===== ChatPlus (emoji buttons, 3-block replies, HTML rendering) ===== */
#chatFeed .msg.ai-rich {
  background: rgba(57,255,182,0.12);
  border-radius: 16px 16px 16px 0;
  padding: 8px 12px;
  max-width: 75%;
}
#chatFeed .ai-block {
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 12px;
  margin: 6px 0;
  overflow: hidden;
  background: rgba(15, 17, 32, 0.5);
}
#chatFeed .ai-block > summary {
  list-style: none;
  cursor: pointer;
  font-weight: 800;
  padding: 8px 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}
#chatFeed .ai-block > summary::-webkit-details-marker { display: none; }
#chatFeed .ai-block .block-body {
  padding: 8px 10px;
  line-height: 1.55;
}
#chatFeed .ai-block .block-body :where(p, ul, ol, pre, code, h1, h2, h3, h4, h5, h6) { margin: 6px 0 }
#chatFeed .ai-block .block-body pre {
  background: rgba(0,0,0,.35);
  padding: 8px;
  border-radius: 8px;
  overflow:auto;
}
/* Emoji buttons */
.emoji-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  margin: 0 2px;
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.18);
  background: rgba(255,255,255,0.06);
  cursor: pointer;
  font-size: 18px;
  line-height: 1;
  transition: transform .12s var(--ease), background .2s var(--ease);
}
.emoji-btn:hover { transform: translateY(-1px); background: rgba(255,255,255,0.1); }
.emoji-suggestions {
  margin-top: 6px;
  display: flex; flex-wrap: wrap; gap: 4px;
}
/* Rendered HTML box (safe) */
.render-html {
  border: 1px dashed rgba(255,255,255,0.18);
  background: rgba(255,255,255,0.03);
  padding: 8px;
  border-radius: 10px;
}
.render-html iframe {
  width: 100%; border: 0; background: #0b0f14; border-radius: 8px;
}

</style>
<style>
/* --------------------------------------------
   KOBLLUX • Compact Mode — Mobile-first Vertical
   Colar após o CSS atual
--------------------------------------------- */

/* Base compacta + segurança */
*,
*::before,
*::after { box-sizing: border-box; }
html, body { max-width: 100%; overflow-x: hidden; }
body { padding-bottom: calc(16px + env(safe-area-inset-bottom)); }

/* Container nunca estoura, sem “gambiarra” de largura */
.response-container {
  inline-size: min(100%, calc(100% - 0px)) !important;
  padding: 1rem 0 2.75rem; /* + espaço safe-area já no body */
}

/* Nada lado a lado por padrão — empilha tudo */
.row,
.controls,
.kv,
.columns,
.split {
  display: block !important;
}

/* Qualquer tentativa de grid vira 1 coluna */
[class*="grid"],
[style*="grid-template-columns"],
.columns,
.split,
.panel,
.kv {
  display: grid !important;
  grid-template-columns: 1fr !important;
  align-items: stretch;
  gap: .5rem !important;
}

/* Pares “key→value” agora empilhados */
.kv > * { margin: 0 0 .4rem 0; }

/* Grupos de controles em coluna, ocupando 100% */
.controls .group {
  display: block !important;
  width: 100%;
  padding: .5rem .6rem;
  margin: 0 0 .6rem 0;
}
.controls .group > label,
.controls .group > select,
.controls .group > input,
.controls .group > button { display: block; width: 100%; }

/* Botões e inputs: alvo de toque ≥44px */
.btn,
select,
input[type="text"],
input[type="file"],
input[type="range"],
input[type="checkbox"],
input[type="radio"],
label[for],
textarea {
  min-height: 44px;
}

/* Botão Único: respeita safe-area no iOS */
#btnKOBLLUX { 
  bottom: calc(1rem + env(safe-area-inset-bottom));
}

/* Navegações/chips SOMENTE na header: scroll horizontal, sem wrap */
.header .row {
  display: block !important;
  overflow-x: auto;
  white-space: nowrap;
  scrollbar-width: thin;
  -webkit-overflow-scrolling: touch;
  padding-bottom: .25rem;
  margin-bottom: .25rem;
}
.header .row > * {
  display: inline-block;
  vertical-align: top;
  margin-right: .5rem;
}

/* Dropzone 100% vertical */
.dropzone .dz-area { display: block !important; }
.dropzone .row { display: block !important; }
.dropzone .row > * { display: block; width: 100%; margin: .5rem 0 0; }

/* Editor e Preview sempre empilhados (Preview abaixo)
   Use #analysis como Preview, ou crie #preview se preferir. */
.editor {
  width: 100%;
  min-height: 48vh;
  height: 52vh;          /* alvo ~50–60vh */
  max-height: 60vh;
  overflow: auto;
}
#analysis,
#preview {
  display: block;
  width: 100%;
  min-height: 42vh;
  height: 50vh;          /* alvo ~50–60vh */
  max-height: 60vh;
  overflow: auto;
  white-space: pre-wrap;  /* evita overflow lateral */
  word-wrap: break-word;
}

/* Cards/listas/painéis: pilha vertical com scroll interno quando necessário */
.response-block.glass,
.panel {
  max-height: unset;     /* deixe rolar a página */
}
.panel[data-scroll],
.response-block.glass[data-scroll],
.card[data-scroll],
[list][data-scroll] {
  max-height: 60vh;
  overflow: auto;
}

/* Controles verticais: sliders + labels exibidos em coluna */
.controls label { margin: 0 0 .25rem 0; }
.controls input[type="range"] { margin: .25rem 0 .5rem; }

/* Sliders com preenchimento dinâmico (mantém seu gradiente) */
input[type="range"]{
  /* estes tokens são calculados por JS no seu app, mantidos aqui */
  inline-size: 100%;
}

/* Toggle (Auto‑detectar): aumenta para tap ≥44px */
#autoDetect{
  --w: 72px; --h: 44px; --pad: 4px;
  min-height: 44px;
}

/* SELECT e BTN ocupam a linha inteira no modo compact */
select,
.btn { width: 100%; }

/* Grids/tabelas internas que insistem em múltiplas colunas → força 1fr */
[role="grid"],
[role="table"],
table,
.table,
.list,
.cards,
.cards-grid,
.items-grid {
  display: grid !important;
  grid-template-columns: 1fr !important;
}

/* Editor/Preview evitando sangrar lateralmente (longas strings/URLs) */
.editor,
pre { word-break: break-word; }

/* Header único (nenhum footer fixo) — nenhuma regra extra de footer */

/* Safe-area e “tap spacing” no rodapé de ações flutuantes/badges */
.badge-reopen { 
  bottom: calc(1rem + env(safe-area-inset-bottom));
}

/* Animação e sombras mais discretas (versão compact) */
.glass { padding: .75rem .9rem; }
.btn { padding: .7rem 1rem; }

/* Scroll horizontal utilitário (caso queira aplicar em outra nav) */
.h-scroll { overflow-x: auto; white-space: nowrap; }
.h-scroll > * { display: inline-block; }

/* Qualquer .columns e .split SEMPRE block (reforço final) */
.columns, .split { display: block !important; }

/* Segurança extra: força colunas únicas em componentes “teimosos” */
[class*="columns-"],
[class*="cols-"],
[class*="grid-"] {
  grid-template-columns: 1fr !important;
}

/* Evitar wrap de ícones/textos em chips sem quebrar layout */
.pill { display: inline-block; }

/* Garantir que iFrame seguro não crie overflow lateral */
.ifr { inline-size: 100%; max-inline-size: 100%; }
.ifr .bar { display: block; }
.ifr .bar .spacer { display: none; }
.ifr .bar .btn,
.ifr .bar .btn.ghost { width: 100%; margin-top: .4rem; }

/* Acessibilidade: foco visível “compact” */
:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(57,255,182,.18); }

/* Restrições finais — nada lado a lado fora da header */
main .row { display: block !important; }
main .row > * + * { margin-top: .5rem; }

/* (Opcional) reduz micro gaps gerais para versão compacta */
.stack { gap: .5rem !important; }

</style>
<style id="lspanel-masterfix-css">
:root{ --ls-fg:#eaf2ff; --ls-surface:rgba(15,17,32,.9); --ls-line:rgba(255,255,255,.14); --ls-gap:10px; --ls-h:40px; --ls-r:12px; }
#lsModal .ls-panel{background:var(--ls-surface)!important;border:1px solid var(--ls-line)!important;border-radius:16px!important;padding:12px!important}
#lsModal .ls-panel .section-title{font-weight:900;font-size:12px;color:var(--ls-fg);opacity:.95;margin:8px 0 6px}
#lsModal .ls-panel .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:var(--ls-gap)}
#lsModal .ls-panel .line{display:grid;grid-template-columns:1fr 1fr;gap:var(--ls-gap);align-items:center}
#lsModal .ls-panel label{font-size:12px;opacity:.85}
#lsModal .ls-panel .pill-btn, #lsModal .ls-panel button, #lsModal .ls-panel .arch-chip, #lsModal .ls-panel .btn{
  min-height:var(--ls-h);border-radius:var(--ls-r);padding:8px 12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.18);color:var(--ls-fg);font-size:12px;letter-spacing:.2px
}
#lsModal .ls-panel .pill-btn.on, #lsModal .ls-panel .arch-chip.on{background:rgba(57,255,182,.18);border-color:rgba(57,255,182,.45)}
#lsModal .ls-panel input[type="range"], #lsModal .ls-panel select{
  min-height:var(--ls-h);border-radius:var(--ls-r);background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.18);color:var(--ls-fg);padding:10px
}
#lsModal .ls-panel output{font-size:12px;opacity:.9}
#perfHud{display:flex;gap:8px;align-items:center;justify-content:space-between;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:8px 10px;margin:8px 0}
#perfHud .stats{display:flex;gap:10px;align-items:center}
#perfHud .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,.2);border-radius:999px;padding:4px 8px;background:rgba(255,255,255,.08);font-weight:800}
</style>
<style id="ARCH_FAB_ROUND_FIX">
.arch-circle{
  border-radius:50% !important;
  overflow:hidden !important;
  -webkit-clip-path: circle(50% at 50% 50%); clip-path: circle(50% at 50% 50%);
  -webkit-mask-image: radial-gradient(circle at 50% 50%, #000 99.9%, transparent 100%);
          mask-image: radial-gradient(circle at 50% 50%, #000 99.9%, transparent 100%);
  isolation:isolate; contain: paint; transform: translateZ(0); will-change: transform;
  background-clip: padding-box;
}
.arch-circle > .arch-fab{
  background:none !important; mix-blend-mode: normal !important;
  backface-visibility:hidden; -webkit-backface-visibility:hidden;
}
.arch-circle > .arch-fab::before{
  content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
  background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
  box-shadow:0 6px 16px rgba(0,0,0,.35), 0 0 0 1px rgba(255,255,255,.06) inset;
}
/* failsafe de recorte para camadas do orbe */
.arch-circle > canvas, .arch-circle #orbWrap, .arch-circle .orb-slot, .arch-circle iframe#arch-frame{
  -webkit-clip-path: circle(50% at 50% 50%); clip-path: circle(50% at 50% 50%);
}
</style>
<style id="UNO_ARCH_ORB_STYLES">
  #arch-orb-wrap{width:min(82vw,360px);aspect-ratio:1/1;display:grid;place-items:center;
    background:radial-gradient(60% 60% at 50% 45%,#0b1424 0%,#0a1120 50%,#070d1a 100%);
    border:1px solid #1a314a;border-radius:24px;box-shadow:0 0 32px #00e7ff1f,inset 0 0 24px #001b2f80;
    padding:14px;margin:10px auto}
  #arch-orb{width:100%;height:100%;display:block}
</style>
<style id="overlay-unificado">
:root{
  --arch-color: #8a2be2;
  --arch-overlay-strength: 18%;
  --arch-overlay: color-mix(in srgb, var(--arch-color) var(--arch-overlay-strength), transparent);
  --arch-switch-fade: 280ms;
}
body::after{
  content:""; position:fixed; inset:0; pointer-events:none; z-index:0;
  background: var(--arch-overlay, transparent);
}
#arch-fadeCover{ background: var(--arch-overlay, transparent); z-index:6; }
html[data-overlay="off"] body::after,
html[data-overlay="off"] #arch-fadeCover{ background: transparent !important; }
</style><style id="orb-sandwich">
.arch-circle{ position:relative; border-radius:50%; overflow:hidden; isolation:isolate; }
#orbWrap{ position:absolute; inset:6%; width:88%; height:88%; z-index:1; pointer-events:none; }
#orbWrap canvas, #orbWrap .ring, #orbWrap .orb-glow{ position:absolute; inset:0; border-radius:50%; display:block; }
#arch-frame{ position:absolute; inset:0; width:100%; height:100%; z-index:2; border:0; background:#0b0f14; }
#arch-fadeCover{ position:absolute; inset:0; z-index:6; opacity:0; transition:opacity var(--arch-switch-fade) ease; }
.orb-slot::after{ content:""; position:absolute; inset:0; pointer-events:none; mix-blend-mode:overlay; opacity:.35; background:var(--arch-overlay,transparent); }
</style><style id="pulse-audio-style">
/* Orb-embedded CTA: 'Toque o pulso' */
#orbWrap, .arch-circle { position: relative; }
.pulse-cta{
  position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
  pointer-events:auto; z-index:7; /* above arch-frame (2) and fadeCover (6 if transparent) */
}
.pulse-cta.hidden{ display:none; }
.pulse-cta .dot{
  width:120px; height:120px; border-radius:999px; backdrop-filter: blur(6px);
  background: radial-gradient(closest-side, rgba(255,255,255,.18), rgba(255,255,255,.08) 60%, rgba(0,0,0,0) 61%);
  box-shadow: 0 0 28px rgba(255,255,255,.28), inset 0 0 22px rgba(255,255,255,.18);
  position:relative; display:flex; align-items:center; justify-content:center;
}
.pulse-cta .dot::before, .pulse-cta .dot::after{
  content:""; position:absolute; inset:-6px; border-radius:inherit; border:2px solid rgba(255,255,255,.22);
  animation: pulseRing 1.8s ease-out infinite;
}
.pulse-cta .dot::after{ animation-delay:.9s; }
.pulse-cta .label{
  position:absolute; bottom:-38px; left:50%; transform:translateX(-50%);
  font: 600 14px/1.2 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
  letter-spacing:.2px; color:#e9f1ff; text-shadow:0 1px 2px rgba(0,0,0,.65);
  opacity:.92; user-select:none;
}
@keyframes pulseRing{
  0%{ transform:scale(0.7); opacity:.9;}
  100%{ transform:scale(1.25); opacity:0;}
}
@media (max-width:420px){
  .pulse-cta .dot{ width:96px; height:96px; }
  .pulse-cta .label{ bottom:-34px; font-size:13px; }
}


/* Luxara — black & gold tuning */
:root{
  --lux-gold:#d4af37;
  --lux-gold-soft: rgba(212,175,55,.24);
  --lux-gold-glow: rgba(212,175,55,.18);
  --lux-label: #f3e7c1;
}
/* CTA label refinement */
.pulse-cta .label{
  color: var(--lux-label) !important;
  text-transform: lowercase;
  letter-spacing:.28px;
  font-weight:700;
}
.pulse-cta .dot{
  background: radial-gradient(closest-side, rgba(255,255,255,.06), rgba(255,255,255,.03) 60%, rgba(0,0,0,0) 61%);
  box-shadow: 0 0 28px var(--lux-gold-glow), inset 0 0 18px rgba(255,255,255,.12);
}
.pulse-cta .dot::before, .pulse-cta .dot::after{
  border-color: var(--lux-gold-soft);
}

/* Synth canvas */
.pulse-synth {
  position:absolute; inset:0; z-index:5; pointer-events:none;
  opacity:.0; transition: opacity .35s ease;
  mix-blend-mode: screen;
  filter: drop-shadow(0 0 10px var(--lux-gold-glow));
}
.pulse-synth.active { opacity:.9; }
</style><style id="pulse-synth-style">
/* Luxara — black & gold tuning */
:root{
  --lux-gold:#d4af37;
  --lux-gold-soft: rgba(212,175,55,.24);
  --lux-gold-glow: rgba(212,175,55,.18);
  --lux-label: #f3e7c1;
}
/* CTA label refinement */
.pulse-cta .label{
  color: var(--lux-label) !important;
  text-transform: lowercase;
  letter-spacing:.28px;
  font-weight:700;
}
.pulse-cta .dot{
  background: radial-gradient(closest-side, rgba(255,255,255,.06), rgba(255,255,255,.03) 60%, rgba(0,0,0,0) 61%);
  box-shadow: 0 0 28px var(--lux-gold-glow), inset 0 0 18px rgba(255,255,255,.12);
}
.pulse-cta .dot::before, .pulse-cta .dot::after{
  border-color: var(--lux-gold-soft);
}

/* Synth canvas */
.pulse-synth {
  position:absolute; inset:0; z-index:5; pointer-events:none;
  opacity:.0; transition: opacity .35s ease;
  mix-blend-mode: screen;
  filter: drop-shadow(0 0 10px var(--lux-gold-glow));
}
.pulse-synth.active { opacity:.9; }
</style><style id="arch-debug-hud-style">
/* Debug HUD — Luxara subtle */
#archDebugHUD{
  position: fixed; right: 14px; bottom: calc(14px + env(safe-area-inset-bottom));
  z-index: 9999; min-width: 220px; max-width: 42vw;
  padding: 10px 12px; border-radius: 14px;
  background: rgba(6,10,18,.78);
  border: 1px solid rgba(212,175,55,.28);
  box-shadow: 0 10px 32px rgba(0,0,0,.35), 0 0 20px rgba(212,175,55,.08) inset;
  color: #f3e7c1; font: 600 12px/1.4 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  display: none;
}
#archDebugHUD.show{ display:block; }
#archDebugHUD h3{
  margin:0 0 8px 0; font-size:12px; letter-spacing:.25px; text-transform:uppercase;
  color:#ffe9a9; opacity:.9;
}
#archDebugHUD .row{ display:flex; align-items:center; gap:8px; margin:4px 0; }
#archDebugHUD .tag{ opacity:.72; min-width:110px; }
#archDebugHUD .chip{
  padding:3px 6px; border-radius:8px; background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.14); color:#fff; font-weight:700;
}
#archDebugHUD .swatch{
  width:16px; height:16px; border-radius:4px; border:1px solid rgba(255,255,255,.25);
  box-shadow: 0 0 10px rgba(255,255,255,.15);
}
#archDebugHUD .hint{ opacity:.6; margin-top:6px; font-weight:500; }


#archDebugHUD .row.controls{ margin-top:8px; gap:10px; flex-wrap:wrap; }
#archDebugHUD .btn{
  padding:6px 10px; border-radius:10px; background: rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.16); color:#ffe9a9; font-weight:800; cursor:pointer;
}
#archDebugHUD .btn:hover{ background: rgba(255,255,255,.1); }
#archDebugHUD .vol{
  -webkit-appearance: none; width: 140px; height: 6px; border-radius: 10px;
  background: rgba(255,255,255,.12); outline: none; border:1px solid rgba(255,255,255,.2);
}
#archDebugHUD .vol::-webkit-slider-thumb{
  -webkit-appearance: none; appearance: none; width: 16px; height: 16px; border-radius: 50%;
  background: #d4af37; cursor: pointer; box-shadow: 0 0 10px rgba(212,175,55,.45);
}
#archDebugHUD .chip.mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
</style><style id="app-icons-style">
/* App icon styling (inline SVG) */
.app-item .app-icon, .app-card .app-icon, .menuItem .app-icon {
  width: 28px; height: 28px; display:inline-flex; align-items:center; justify-content:center;
  border-radius: 8px; margin-right: 8px; flex-shrink: 0;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.12), 0 2px 8px rgba(0,0,0,.25);
  background: radial-gradient(120% 120% at 20% 10%, rgba(255,255,255,.06), rgba(255,255,255,.02) 60%);
}
.app-item .app-icon svg, .app-card .app-icon svg, .menuItem .app-icon svg {
  width: 18px; height: 18px;
  stroke: currentColor; fill: none; stroke-width: 1.8;
}
/* Fallback badge */
.app-icon.badge-default { color: #d4af37; }
.app-icon.badge-blue { color: #00c5e5; }
.app-icon.badge-pink { color: #ff67c4; }
.app-icon.badge-green { color: #39ffb6; }
.app-icon.badge-orange { color: #ff9f43; }
</style>
<style id="APP_ACCENTS_KISARA_CSS">
/* === App accent tokens + Kisara field (Luxara) === */
.app-card{
  --appA: var(--grad-a);
  --appB: var(--grad-b);
  --appInk: #f5f7ff;
  position: relative;
}
.app-card.accented{
  border-color: color-mix(in oklab, var(--appA) 35%, #ffffff22);
  box-shadow: 0 10px 26px color-mix(in oklab, var(--appA) 22%, transparent), var(--shadow);
}
.app-card.accented::before{
  content:"";
  position:absolute; inset:-2px; border-radius: inherit;
  background: radial-gradient(45% 60% at 15% 10%, color-mix(in oklab, var(--appA) 20%, transparent) 0%, transparent 60%),
              radial-gradient(65% 85% at 85% 120%, color-mix(in oklab, var(--appB) 14%, transparent) 0%, transparent 70%);
  filter: blur(8px);
  opacity:.9;
  mix-blend-mode: screen;
  pointer-events:none;
  z-index: 0;
}
.app-card .app-icon{
  position: relative;
  background:
    radial-gradient(120% 120% at 20% 10%, color-mix(in oklab, var(--appA) 22%, #ffffff00) 0%, rgba(255,255,255,.02) 60%);
  border-color: color-mix(in oklab, var(--appA) 40%, #ffffff10);
  box-shadow: inset 0 0 0 1px color-mix(in oklab, var(--appB) 28%, #ffffff10);
}
.app-card .app-title{
  background-image: linear-gradient(90deg, var(--appA), var(--appB));
  -webkit-background-clip: text; background-clip: text; color: transparent;
}
.app-card .btn{
  background: linear-gradient(90deg, var(--appA), var(--appB));
  color:#0b0f14; border-color: transparent;
}
.app-card .btn:hover{
  box-shadow: 0 12px 28px color-mix(in oklab, var(--appB) 22%, transparent),
              0 0 0 1px rgba(255,255,255,.12) inset;
}
/* Badge (top-right) uses accent color, avoids duplicate fallback */
.app-card .badge-ask{ display: none; } /* remove '?' fallback if present */
</style>




<style id="upload-buttons-style">
/* Upload buttons — Brain, Apps, geral */
input[type="file"]{
  color:#eaeef7;
  font:600 13px/1 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background: rgba(10,14,24,.6);
  border: 1px solid rgba(255,255,255,.16);
  border-radius:12px;
  padding:10px;
  box-shadow: 0 3px 16px rgba(0,0,0,.25) inset, 0 1px 0 rgba(255,255,255,.06);
}
/* Botão interno (Chrome, Edge, Safari) */
input[type="file"]::file-selector-button{
  margin-right:10px;
  padding:8px 12px;
  border:1px solid rgba(255,255,255,.2);
  border-radius:10px;
  background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
  color:#f8f0d0;
  font-weight:800;
  cursor:pointer;
  transition: transform .15s ease, box-shadow .2s ease, background .2s ease;
}
input[type="file"]::file-selector-button:hover{
  transform: translateY(-1px);
  box-shadow: 0 0 0 2px rgba(212,175,55,.28), 0 0 18px rgba(212,175,55,.18);
}
/* Firefox fallback */
@supports (-moz-appearance: none){
  input[type="file"]::-moz-focus-inner{ border:0; padding:0; }
}
/* Contextos comuns: Brain, Apps Section */
#brain input[type="file"], .apps input[type="file"], .apps-section input[type="file"], .menuItem input[type="file"]{
  width:100%;
  max-width: 520px;
  margin:8px 0 12px 0;
}
</style>
<style id="select-kisara-patch">
/* Select tune (Kisara/Blue‑1 compatible) */
#v-brain select, #v-apps select, #v-stack select {
  background: #0f1426;
  color: var(--fg, #e6f2ff);
  border: var(--bd, 1px solid rgba(255,255,255,.12));
  border-radius: 12px;
  padding: 10px;
}
#v-brain select:focus-visible, #v-apps select:focus-visible, #v-stack select:focus-visible {
  outline: 0;
  box-shadow: var(--focus-ring, 0 0 0 3px rgba(57,255,182,.18));
}
</style>

<!-- INLINE • icons.css + icons-dark.css • 2025-10-26T06:08:25 -->
<style id="icons-css-inline">
:root{
  --icon-size:24px;
  --icon-color:currentColor;
}
.icon{
  display:inline-block;
  width:var(--icon-size);
  height:var(--icon-size);
  background-color:var(--icon-color);
  mask-size:contain;
  mask-repeat:no-repeat;
  mask-position:center;
  -webkit-mask-size:contain;
  -webkit-mask-repeat:no-repeat;
  -webkit-mask-position:center;
}
/* BARAPPS */

.barapps.atlas{mask-image:url('./assets/barapps/atlas.svg');-webkit-mask-image:url('./assets/barapps/atlas.svg');}
.barapps.nova{mask-image:url('./assets/barapps/nova.svg');-webkit-mask-image:url('./assets/barapps/nova.svg');}
.barapps.vitalis{mask-image:url('./assets/barapps/vitalis.svg');-webkit-mask-image:url('./assets/barapps/vitalis.svg');}
.barapps.pulse{mask-image:url('./assets/barapps/pulse.svg');-webkit-mask-image:url('./assets/barapps/pulse.svg');}
.barapps.artemis{mask-image:url('./assets/barapps/artemis.svg');-webkit-mask-image:url('./assets/barapps/artemis.svg');}
.barapps.serena{mask-image:url('./assets/barapps/serena.svg');-webkit-mask-image:url('./assets/barapps/serena.svg');}
.barapps.kaos{mask-image:url('./assets/barapps/kaos.svg');-webkit-mask-image:url('./assets/barapps/kaos.svg');}
.barapps.genus{mask-image:url('./assets/barapps/genus.svg');-webkit-mask-image:url('./assets/barapps/genus.svg');}
.barapps.lumine{mask-image:url('./assets/barapps/lumine.svg');-webkit-mask-image:url('./assets/barapps/lumine.svg');}
.barapps.rhea{mask-image:url('./assets/barapps/rhea.svg');-webkit-mask-image:url('./assets/barapps/rhea.svg');}
.barapps.solus{mask-image:url('./assets/barapps/solus.svg');-webkit-mask-image:url('./assets/barapps/solus.svg');}
.barapps.aion{mask-image:url('./assets/barapps/aion.svg');-webkit-mask-image:url('./assets/barapps/aion.svg');}

/* BARICONS */

.baricons.home{mask-image:url('./assets/baricons/home.svg');-webkit-mask-image:url('./assets/baricons/home.svg');}
.baricons.apps{mask-image:url('./assets/baricons/apps.svg');-webkit-mask-image:url('./assets/baricons/apps.svg');}
.baricons.stack{mask-image:url('./assets/baricons/stack.svg');-webkit-mask-image:url('./assets/baricons/stack.svg');}
.baricons.brain{mask-image:url('./assets/baricons/brain.svg');-webkit-mask-image:url('./assets/baricons/brain.svg');}
.baricons.chat{mask-image:url('./assets/baricons/chat.svg');-webkit-mask-image:url('./assets/baricons/chat.svg');}
.baricons.settings{mask-image:url('./assets/baricons/settings.svg');-webkit-mask-image:url('./assets/baricons/settings.svg');}
.baricons.upload{mask-image:url('./assets/baricons/upload.svg');-webkit-mask-image:url('./assets/baricons/upload.svg');}
.baricons.download{mask-image:url('./assets/baricons/download.svg');-webkit-mask-image:url('./assets/baricons/download.svg');}
.baricons.search{mask-image:url('./assets/baricons/search.svg');-webkit-mask-image:url('./assets/baricons/search.svg');}
.baricons.bell{mask-image:url('./assets/baricons/bell.svg');-webkit-mask-image:url('./assets/baricons/bell.svg');}
.baricons.user{mask-image:url('./assets/baricons/user.svg');-webkit-mask-image:url('./assets/baricons/user.svg');}
.baricons.power{mask-image:url('./assets/baricons/power.svg');-webkit-mask-image:url('./assets/baricons/power.svg');}

/* === icons-dark.css — Nebula Pro / Luxara variant (inline) === */
:root{
  --icon-size: 24px;
  --icon-color: currentColor;
  --icon-glow: 0.35;
}
.icon.gradient{
  /* Use gradient as fill under the SVG mask */
  background: linear-gradient(42deg, #ff52e5, #00c5e5);
}
.icon.gold{
  background: linear-gradient(42deg, #d4af37, #ffd773);
}
.icon.blue{
  background: linear-gradient(42deg, #4b6fff, #00c2ff);
}
.icon.pulse{
  position: relative;
  isolation: isolate;
}
.icon.pulse::after{
  content:"";
  position:absolute; inset:-6px;
  border-radius:12px;
  filter: blur(8px);
  z-index:-1;
  background: radial-gradient(60% 60% at 50% 50%, rgba(255,255,255,.12), transparent 60%);
  opacity: var(--icon-glow);
  transition: opacity .25s ease;
}
.icon.pulse:hover::after{ opacity: .6; }
.icon.lg{ --icon-size: 32px; }
.icon.xl{ --icon-size: 40px; }
/* Dark theme helper */
[data-theme="blue1"] .icon { --icon-color: #eaf2ff; }

</style>


<!-- PATCH • UNO_INLINE_ICONS_APPSVG • 2025-10-26T06:21:12 -->
<style id="UNO_INLINE_ICONS_APPSVG">
  /* Garantir tamanho/visibilidade do ícone dentro do card */
  .app-card .app-icon .icon {
    width: 24px;
    height: 24px;
    display: inline-block;
  }
  /* Demo: se preferir, comente a linha abaixo para não ter gradiente default */
  .app-card .app-icon .icon.gradient-default {
    background: linear-gradient(42deg, #ff52e5, #00c5e5);
  }
</style>


<!-- PATCH • UNO_APPS_TITLE_CSS • 2025-10-26T06:48:30 -->
<style id="UNO_APPS_TITLE_CSS">
  /* Evitar estouro de linha no flex container dos cards */
  .app-card { min-width: 0; }
  .app-card > div:last-child { min-width: 0; }

  /* Título legível (var(--fg)), com clamp de 2 linhas e boas quebras */
  .app-card .app-title{
    color: var(--fg) !important;
    font-weight: 850;
    line-height: 1.15;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    word-break: break-word;
    overflow-wrap: anywhere;
    hyphens: auto;
    max-width: 100%;
  }
  /* Descrição também com clamp gentil */
  .app-card .mut{
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
  }
  /* Grupo "Outros" e cabeçalhos longos não quebram layout */
  .apps-group h3{
    overflow-wrap: anywhere;
    word-break: break-word;
    hyphens: auto;
  }
</style>


<style>
/* 78K · Dual Strip (main + fusion) */
.ledstrip-wrap{ position: relative; margin: 5px 12px 0 12px; }
#ledstrip-78k{
  --archA:#409eff; --archB:#ff52b1;
  position: relative; height: 7px; border-radius: 999px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.14);
  overflow: hidden; isolation: isolate;
}
/* Pulsating borders for archetypes */
#ledstrip-78k::before, #ledstrip-78k::after{
  content:""; position:absolute; left:0; right:0; height:1px; pointer-events:none;
  filter: drop-shadow(0 0 6px rgba(255,255,255,.35));
  animation: archPulse 2.6s ease-in-out infinite;
}
#ledstrip-78k::before{ top:0;    background: linear-gradient(90deg,var(--archA), rgba(255,255,255,0)); }
#ledstrip-78k::after { bottom:0; background: linear-gradient(90deg,var(--archB), rgba(255,255,255,0)); animation-delay: .9s; }
@keyframes archPulse{
  0%,100%{ opacity:.45 }
  50%{ opacity:.95 }
}

/* lanes (status) */
#ledstrip-78k .lane{
  position:absolute; inset:0;
  width:0%; height:100%;
  pointer-events:none;
  transition: width .25s cubic-bezier(.2,.7,.2,1);
}
#ledstrip-78k .lane.eng{  background: linear-gradient(90deg,#39ffb6,#00d4ff); mix-blend-mode: screen; opacity:.9; }
#ledstrip-78k .lane.hr{   background: linear-gradient(90deg,#4b6fff,#00c2ff); mix-blend-mode: screen; opacity:.75; }
#ledstrip-78k .lane.loop{ background: linear-gradient(90deg,#ffb86b,#ffd773); mix-blend-mode: screen; opacity:.55; }
#ledstrip-78k .lane.qa{   background: linear-gradient(90deg,#ff52e5,#d800d8); mix-blend-mode: screen; opacity:.0; width:0%; transition: opacity .6s ease, width .25s ease; }

/* ticks */
#ledstrip-78k .tick{ position:absolute; top:0; bottom:0; width:1px; background: rgba(255,255,255,.16); opacity:.6 }
#ledstrip-78k .t25{ left:25% } .t50{ left:50% } .t75{ left:75% }

/* spark */
#ledstrip-78k .spark{
  position:absolute; top:0; bottom:0; width:2px; background:rgba(255,255,255,.9);
  box-shadow:0 0 6px rgba(255,255,255,.85), 0 0 10px rgba(109,255,203,.7);
  transform:translateX(-6px); opacity:0; pointer-events:none; transition: opacity .15s ease;
}

/* Fusion bar below (subtle convergence) */
#ledstrip-fusion{
  position: relative; height: 6px; margin-top: 6px; border-radius: 999px;
  background: linear-gradient(90deg, var(--archA,#409eff), var(--archB,#ff52b1));
  filter: blur(0.3px);
  opacity:.72;
  border: 1px solid rgba(255,255,255,.10);
  box-shadow: 0 6px 18px rgba(0,0,0,.25), 0 0 16px rgba(120,180,255,.15) inset;
  transition: background .4s ease, opacity .4s ease;
}
/* Compact margin override helper (if needed) */
.ledstrip-wrap.compact{ margin: 5px 8px 0 8px; }
</style>

<style>
/* 78K · Strip Controls */
.strip-controls{
  display:flex; justify-content:flex-end; gap:8px;
  margin: 6px 12px 0 12px;
}
.strip-controls .btn-fusion{
  font:700 11px/1 ui-sans-serif,system-ui;
  padding:8px 10px; border-radius:999px;
  background:linear-gradient(135deg,rgba(255,255,255,.10),rgba(255,255,255,.04));
  color:#eaf1ff; border:1px solid rgba(255,255,255,.16);
  box-shadow:0 6px 18px rgba(0,0,0,.25);
  -webkit-tap-highlight-color: transparent;
}
.strip-controls .btn-fusion:active{ transform: scale(.98); box-shadow:0 3px 10px rgba(0,0,0,.35); }
</style>
<style>
/* Local Boost toast stack (bottom center) */
#dual-toast-stack{
  position: fixed; left: 50%; bottom: 84px; transform: translateX(-50%);
  display: flex; flex-direction: column; gap: 8px; z-index: 99999;
  pointer-events: none;
}
.dual-toast{
  pointer-events:auto; -webkit-tap-highlight-color: transparent;
  background: rgba(18,20,28,.9); color: #eaf1ff;
  border: 1px solid rgba(255,255,255,.12);
  backdrop-filter: blur(10px);
  padding: 10px 12px; border-radius: 12px; font: 600 12px/1.1 system-ui;
  box-shadow: 0 8px 24px rgba(0,0,0,.4);
  opacity: 0; transform: translateY(10px);
  transition: opacity .25s ease, transform .25s ease;
}
.dual-toast.show{ opacity: 1; transform: translateY(0); }
</style>
</head>
<body data-theme="blue1">
<!-- Splash screen displayed on initial load -->
<!-- Som do splash: coloque seu arquivo de áudio na pasta especificada e ajuste o caminho abaixo.
       O som será reproduzido automaticamente quando o splash aparecer. -->
<audio id="splashSound" preload="auto" src="Cassettes/Barra Sounds/Suave Underline e Portal.mp3"></audio>
<!-- ===== Header ===== -->
<header class="mast">
<button aria-label="Voltar" class="ib fx-trans fx-press ring" id="btnBack" title="Voltar">
<svg aria-hidden="true" fill="none" height="20" viewbox="0 0 24 24" width="20">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="gradNebulaBack" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<polyline points="15 18 9 12 15 6" stroke="url(#gradNebulaBack)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></polyline>
</svg><span class="ripple"></span>
</button>
<div class="title">
<h1>HUB UNO</h1>
<small>Dual · Trinity</small>
<!-- PATCH: Badge indicating 78K is active; hidden by default -->
<span id="badge78k" style="display:none;margin-left:8px;font-size:0.75rem;color:#f5f7ff;" title="78K ativo">78K ativo</span>
</div>
<button class="ib fx-trans fx-press ring" id="btnDownload" title="Baixar HTML">
<svg aria-hidden="true" fill="none" height="20" viewbox="0 0 24 24" width="20">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g1" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<path d="M12 3v10" stroke="url(#g1)" stroke-linecap="round" stroke-width="2"></path>
<polyline points="7 11 12 16 17 11" stroke="url(#g1)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></polyline>
<rect fill="url(#g1)" height="3" opacity=".3" rx="1.5" width="16" x="4" y="18"></rect>
</svg>
<span class="ripple"></span>
</button>
<button class="ib fx-trans fx-press ring" id="btnHelp" title="Ajuda / Atalhos">
<svg aria-hidden="true" fill="none" height="20" viewbox="0 0 24 24" width="20">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g2" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<circle cx="12" cy="12" r="10" stroke="url(#g2)" stroke-width="2"></circle>
<path d="M9.5 9a2.5 2.5 0 1 1 4.4 1.5c-.6.7-1.4 1-1.9 1.6-.3.3-.5.7-.5 1.4" stroke="url(#g2)" stroke-linecap="round" stroke-width="2"></path>
<circle cx="12" cy="18" fill="url(#g2)" r="1"></circle>
</svg>
<span class="ripple"></span>
</button>
<button class="ib fx-trans fx-press ring" id="btnBrain" title="Brain">
<svg aria-hidden="true" fill="none" height="20" viewbox="0 0 24 24" width="20">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g3" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<path d="M8 6a3 3 0 0 1 6 0 3 3 0 0 1 3 3 3 3 0 0 1 3 3 4 4 0 0 1-4 4H8a4 4 0 0 1-4-4 3 3 0 0 1 3-3 3 3 0 0 1 1-3z" stroke="url(#g3)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
<span class="ripple"></span>
</button>
<button aria-label="Local Storage" class="ib fx-trans fx-press ring" id="btnLS" title="Local Storage">
<svg aria-hidden="true" fill="none" height="20" stroke="#f5f7ff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg">
<ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
<path d="M3 5v7c0 1.7 4 3 9 3s9-1.3 9-3V5"></path>
<path d="M3 12c0 1.7 4 3 9 3s9-1.3 9-3"></path>
</svg>
<span class="ripple"></span>
</button>
</header>
<!-- 78K · Status Strip (fusion + pulsating borders) -->
<div class="ledstrip-wrap">
  <div id="ledstrip-78k" aria-hidden="false">
    <!-- lanes -->
    <i class="lane eng"  title="ENG"></i>
    <i class="lane hr"   title="HR"></i>
    <i class="lane loop" title="LOOP"></i>
    <i class="lane qa"   title="QA"></i>
    <!-- ticks -->
    <i class="tick t25"></i>
    <i class="tick t50"></i>
    <i class="tick t75"></i>
    <!-- spark -->
    <i class="spark"></i>
  </div>
  <!-- fusion bar (sub) -->
  <div id="ledstrip-fusion" aria-hidden="true"></div>
<!-- 78K · Strip Controls -->
<div class="strip-controls">
  <button id="btn-fusionar" class="btn-fusion" type="button" aria-label="Fusionar arquétipos">
    ✦ Fusionar
  </button>
</div>

</div>

<!-- Âncora para sessões abertas quando o usuário optar por abrir dentro da página -->
<section id="sessionsAnchor"></section>
<!-- Container para fundo personalizado (imagem ou vídeo).  Será preenchido via JS quando o usuário escolher
       um tema customizado.  Fica no início do body para garantir que fique abaixo de todos os conteúdos -->
<div id="custom-bg" style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;overflow:hidden;pointer-events:none"></div>
<!-- ===== Views ===== -->
<main>
<!-- HOME -->
<section class="view" id="v-home">
<div class="grid">
<!-- Saudação / chamada para cadastro. Visível quando o usuário precisa ativar a Dual Infodose ou quando já houver nome salvo -->
<div class="card fx-trans fx-lift" id="greetingCard" style="display:none">
<div id="greetingMsg" style="font-weight:800"></div>
</div>
<div class="card fx-trans fx-lift" id="unoCard" style="display:none">
<div style="display:flex;justify-content:space-between;align-items:center;gap:12px;width:100%">
<div>
<div style="font-weight:900;letter-spacing:.08em">UNO • foco e velocidade</div>
<div class="mut">Monólito: Apps embutidos + Viewer + Dock + Atalhos</div>
</div>
<div class="ico">
<svg aria-hidden="true" fill="url(#g4)" height="24" viewbox="0 0 24 24" width="24">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g4" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<path d="M13 2L3 14h7l-1 8 10-12h-7l1-8z"></path>
</svg>
</div>
</div>
</div>
<!-- Área de Arquétipos incorporada -->
<div class="arch-container">
<!-- Mover o seletor de arquétipos para fora do círculo.  Ele ficará acima
               da bolinha e seguirá o layout vertical da arch-container. -->
<div class="arch-switcher">
<button class="btn fx-trans fx-press ring" id="arch-prev" title="Anterior">
<svg fill="none" height="16" viewbox="0 0 24 24" width="16">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g5" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<polyline points="15 18 9 12 15 6" stroke="url(#g5)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></polyline>
</svg>
<span class="ripple"></span></button>
<select id="arch-select" title="Escolher arquétipo">
<option value="./archetypes/atlas.html">atlas.html</option>
<option value="./archetypes/nova.html">nova.html</option>
<option value="./archetypes/vitalis.html">vitalis.html</option>
<option value="./archetypes/pulse.html">pulse.html</option>
<option value="./archetypes/artemis.html">artemis.html</option>
<option value="./archetypes/serena.html">serena.html</option>
<option value="./archetypes/kaos.html">kaos.html</option>
<option value="./archetypes/genus.html">genus.html</option>
<option value="./archetypes/lumine.html">lumine.html</option>
<option value="./archetypes/rhea.html">rhea.html</option>
<option value="./archetypes/solus.html">solus.html</option>
<option value="./archetypes/aion.html">aion.html</option>
</select>
<button class="btn fx-trans fx-press ring" id="arch-next" title="Próximo">
<svg fill="none" height="16" viewbox="0 0 24 24" width="16">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g6" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<polyline points="9 18 15 12 9 6" stroke="url(#g6)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></polyline>
</svg>
<span class="ripple"></span></button>
</div>
<div class="arch-circle">
<div id="arch-fadeCover"></div>
<!-- Camada de ripple auditivo fica sobre o conteúdo do círculo -->
<div class="audio-ripple" id="audioRipple"></div>
<!-- ORB Nebula (WebGL + Partículas) — integrado no HUB -->
<div aria-label="Orbe Nebula" class="orb-wrap" id="orbWrap">
<canvas id="orb"></canvas>
<div class="orb-glow" id="orbGlow"></div>
<canvas id="particles"></canvas>
<div class="ring"></div>
<div class="call" id="orbCall">·</div>
</div>
<iframe id="arch-frame" referrerpolicy="no-referrer" sandbox="allow-scripts" src="./archetypes/atlas.html" title="Archetype Core"></iframe>
</div>
<!-- Mensagem de feedback aparece fora da bolinha, logo abaixo dela -->
<div class="arch-msg show" id="archMsg" style="background: rgba(57, 255, 182, 0.75); color: rgb(11, 15, 20);">Bem-vindo de volta, KODUX. UNO está ao seu lado.</div>
<!-- Menu de arquétipos: permite acessar Apps, Stack, Usuário, Revo e Home -->
<div class="arch-menu" id="archMenu">
<button data-nav="apps">
<svg aria-hidden="true" fill="none" height="22" viewbox="0 0 24 24" width="22">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="gradNebulaTab" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<rect height="7" rx="2" stroke="url(#gradNebulaTab)" stroke-width="2" width="7" x="3" y="3"></rect>
<rect height="7" rx="2" stroke="url(#gradNebulaTab)" stroke-width="2" width="7" x="14" y="3"></rect>
<rect height="7" rx="2" stroke="url(#gradNebulaTab)" stroke-width="2" width="7" x="3" y="14"></rect>
<rect height="7" rx="2" stroke="url(#gradNebulaTab)" stroke-width="2" width="7" x="14" y="14"></rect>
</svg><span>Apps</span>
<span class="ripple"></span></button>
<button data-nav="stack">
<svg aria-hidden="true" fill="none" height="22" viewbox="0 0 24 24" width="22">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="gradNebulaTab" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<polygon fill="none" points="12 2 2 7 12 12 22 7 12 2" stroke="url(#gradNebulaTab)" stroke-width="2"></polygon>
<polyline fill="none" points="2 12 12 17 22 12" stroke="url(#gradNebulaTab)" stroke-width="2"></polyline>
<polyline fill="none" points="2 17 12 22 22 17" stroke="url(#gradNebulaTab)" stroke-width="2"></polyline>
</svg><span>Stack</span>
<span class="ripple"></span></button>
<button data-nav="brain">
<svg aria-hidden="true" fill="none" height="22" viewbox="0 0 24 24" width="22">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="gradNebulaTab" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<path d="M8 6a3 3 0 0 1 6 0 3 3 0 0 1 3 3 3 3 0 0 1 3 3 4 4 0 0 1-4 4H8a4 4 0 0 1-4-4 3 3 0 0 1 3-3 3 3 0 0 1 1-3z" stroke="url(#gradNebulaTab)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span>Usuário</span>
<span class="ripple"></span></button>
<button data-nav="home">
<svg aria-hidden="true" fill="none" height="22" viewbox="0 0 24 24" width="22">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="gradNebulaTab" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<path d="M3 10.5L12 3l9 7.5" stroke="url(#gradNebulaTab)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
<path d="M5 10v10h14V10" stroke="url(#gradNebulaTab)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span>Arquétipo</span>
<span class="ripple"></span></button>
<button data-nav="chat">
<svg aria-hidden="true" fill="none" height="22" viewbox="0 0 24 24" width="22">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="gradNebulaTab" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<path d="M21 15a4 4 0 0 1-4 4H7l-4 4V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4v8z" stroke="url(#gradNebulaTab)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span>Chat</span>
<span class="ripple"></span></button>
<button data-audio="true" id="archAudioBtn">
<svg fill="none" height="20" viewbox="0 0 24 24" width="20">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g7" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<circle cx="12" cy="12" r="9" stroke="url(#g7)" stroke-width="2"></circle>
<path d="M12 7v5l4 2" stroke="url(#g7)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
<span>Áudio</span>
<span class="ripple"></span></button>
</div>
</div><div class="cards">
<button class="card fx-trans fx-press ring" data-nav="apps">
<div class="ico">
<svg fill="none" height="24" viewbox="0 0 24 24" width="24">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g8" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<path d="M3 6h6l2 2h10v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6z" stroke="url(#g8)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</div>
<div>
<div style="font-weight:800">Apps</div>
<div class="mut" id="homeAppsStatus">15 apps</div>
</div>
<span class="ripple"></span>
</button>
<button class="card fx-trans fx-press ring" data-nav="stack">
<div class="ico">
<svg aria-hidden="true" fill="none" height="24" viewbox="0 0 24 24" width="24">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g9" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<polygon fill="none" points="12 2 2 7 12 12 22 7 12 2" stroke="url(#g9)" stroke-width="2"></polygon>
<polyline fill="none" points="2 12 12 17 22 12" stroke="url(#g9)" stroke-width="2"></polyline>
<polyline fill="none" points="2 17 12 22 22 17" stroke="url(#g9)" stroke-width="2"></polyline>
</svg>
</div>
<div>
<div style="font-weight:800">Stack</div>
<div class="mut" id="homeStackStatus">0 sessãos</div>
</div>
<span class="ripple"></span>
</button>
<button class="card fx-trans fx-press ring" data-nav="brain">
<div class="ico">
<svg aria-hidden="true" fill="none" height="24" viewbox="0 0 24 24" width="24">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g10" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<circle cx="12" cy="8" r="4" stroke="url(#g10)" stroke-width="2"></circle>
<path d="M4 20a8 5 0 0 1 16 0" stroke="url(#g10)" stroke-linecap="round" stroke-width="2"></path>
</svg>
</div>
<div>
<div style="font-weight:800">Usuário</div>
<div class="mut" id="homeUserStatus">KODUX · padrão</div>
</div>
<span class="ripple"></span>
</button>
<button class="card fx-trans fx-press ring" data-nav="home">
<div class="ico">
<svg fill="none" height="24" viewbox="0 0 24 24" width="24">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g11" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<circle cx="12" cy="12" r="9" stroke="url(#g11)" stroke-width="2"></circle>
<path d="M12 7v5l4 2" stroke="url(#g11)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</div>
<div>
<div style="font-weight:800">Arquétipo</div>
<div class="mut" id="homeArchStatus">atlas</div>
</div>
<span class="ripple"></span>
</button>
</div>
<!-- Feed de texto da IA -->
<div aria-atomic="false" aria-live="polite" id="iaFeed">
<div class="status">Toque a bolinha para falar com a IA.</div>
</div>
</div>
</section>
<!-- APPS -->
<section class="view" id="v-apps">
<div class="grid">
<div class="card fx-trans fx-lift" style="display:block">
<div class="grid" style="gap:8px">
<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
<!-- Removemos a busca e o sort. Agora apenas a opção de abrir dentro e o botão para mostrar locais -->
<label class="mut" style="display:inline-flex;gap:6px;align-items:center">
<input checked="" id="openInside" type="checkbox"/> abrir dentro
              </label>
<button class="btn fx-trans fx-press ring" id="btnToggleLocal">
<svg fill="none" height="16" viewbox="0 0 24 24" width="16">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g12" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<path d="M3 6h6l2 2h10v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6z" stroke="url(#g12)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
                Mostrar Locais<span class="ripple"></span>
</button>
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
<!-- Aceita arquivos .json além de HTML/TXT para permitir upload de catálogos personalizados -->
<input accept=".html,.htm,.txt,.json" class="input ring" id="fileLocal" multiple="" type="file"/>
<button class="btn fx-trans fx-press ring" id="btnImport">
<svg fill="none" height="16" viewbox="0 0 24 24" width="16">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g13" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<circle cx="12" cy="12" r="9" stroke="url(#g13)" stroke-width="2"></circle>
<path d="M12 7v5l4 2" stroke="url(#g13)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
                Adicionar Locais<span class="ripple"></span>
</button>
<button class="btn fx-trans fx-press ring" id="btnExport">
<svg fill="none" height="16" viewbox="0 0 24 24" width="16">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g14" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<circle cx="12" cy="12" r="9" stroke="url(#g14)" stroke-width="2"></circle>
<path d="M12 7v5l4 2" stroke="url(#g14)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
                Exportar Locais<span class="ripple"></span>
</button>
<button class="btn fx-trans fx-press ring" id="btnClear">
<svg fill="none" height="16" viewbox="0 0 24 24" width="16">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g15" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<circle cx="12" cy="12" r="9" stroke="url(#g15)" stroke-width="2"></circle>
<path d="M12 7v5l4 2" stroke="url(#g15)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
                Limpar Locais<span class="ripple"></span>
</button>
</div>
<div class="mut" id="appsCount">15 apps</div>
</div>
</div>
<div class="apps-wrap" id="appsWrap"><div class="apps-group"><h3 style="margin: 16px 4px 8px; font-size: 15px; font-weight: 800; color: var(--mut);">Ampara</h3><div class="grid"><div class="app-card fx-trans fx-lift"><button class="fav-btn"><svg fill="none" height="20" viewbox="0 0 24 24" width="20">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g16" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<circle cx="12" cy="12" r="9" stroke="url(#g16)" stroke-width="2"></circle>
<path d="M12 7v5l4 2" stroke="url(#g16)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span class="ripple"></span></button><div class="app-icon"><img alt="" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Cpath%20d%3D%22M12%2021s-6-3.5-6-8a4%204%200%200%201%206-3%204%204%200%200%201%206%203c0%204.5-6%208-6%208z%22%2F%3E%3C%2Fsvg%3E" width="24"/></div><div style="flex: 1 1 0%;"><div class="app-title" title="Serena · Ampara">Serena ·…</div><div class="mut">Acolhimento e suporte emocional.</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div></div></div><div class="apps-group"><h3 style="margin: 16px 4px 8px; font-size: 15px; font-weight: 800; color: var(--mut);">Arcana</h3><div class="grid"><div class="app-card fx-trans fx-lift"><button class="fav-btn"><svg fill="none" height="20" viewbox="0 0 24 24" width="20">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g17" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<circle cx="12" cy="12" r="9" stroke="url(#g17)" stroke-width="2"></circle>
<path d="M12 7v5l4 2" stroke="url(#g17)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span class="ripple"></span></button><div class="app-icon"><img alt="" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Cpath%20d%3D%22M12%203v6M12%2015v6%22%2F%3E%3Ccircle%20cx%3D%2212%22%20cy%3D%2212%22%20r%3D%223%22%2F%3E%3Cpath%20d%3D%22M19%205l-3%203M5%2019l3-3M5%205l3%203M19%2019l-3-3%22%2F%3E%3C%2Fsvg%3E" width="24"/></div><div style="flex: 1 1 0%;"><div class="app-title" title="Solus · Arcana">Solus ·…</div><div class="mut">Harmonização energética e meditação.</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div></div></div><div class="apps-group"><h3 style="margin: 16px 4px 8px; font-size: 15px; font-weight: 800; color: var(--mut);">Brilhare</h3><div class="grid"><div class="app-card fx-trans fx-lift"><button class="fav-btn"><svg fill="none" height="20" viewbox="0 0 24 24" width="20">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g18" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<circle cx="12" cy="12" r="9" stroke="url(#g18)" stroke-width="2"></circle>
<path d="M12 7v5l4 2" stroke="url(#g18)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span class="ripple"></span></button><div class="app-icon"><img alt="" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Ccircle%20cx%3D%2212%22%20cy%3D%2212%22%20r%3D%224%22%2F%3E%3Cpath%20d%3D%22M12%202v2M12%2020v2M2%2012h2M20%2012h2M4.9%204.9l1.4%201.4M17.7%2017.7l1.4%201.4M4.9%2019.1l1.4-1.4M17.7%206.3l1.4-1.4%22%2F%3E%3C%2Fsvg%3E" width="24"/></div><div style="flex: 1 1 0%;"><div class="app-title" title="Lumine · Brilhare">Lumine ·…</div><div class="mut">Inspiração leve e atividades lúdicas.</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div></div></div><div class="apps-group"><h3 style="margin: 16px 4px 8px; font-size: 15px; font-weight: 800; color: var(--mut);">Cartesius</h3><div class="grid"><div class="app-card fx-trans fx-lift"><button class="fav-btn"><svg fill="none" height="20" viewbox="0 0 24 24" width="20">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g19" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<circle cx="12" cy="12" r="9" stroke="url(#g19)" stroke-width="2"></circle>
<path d="M12 7v5l4 2" stroke="url(#g19)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span class="ripple"></span></button><div class="app-icon"><img alt="" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Ccircle%20cx%3D%2212%22%20cy%3D%2212%22%20r%3D%229%22%2F%3E%3Cpath%20d%3D%22M3%2012h18M12%203v18%22%2F%3E%3Cpath%20d%3D%22M5%208c3%202%2011%202%2014%200M5%2016c3-2%2011-2%2014%200%22%2F%3E%3C%2Fsvg%3E" width="24"/></div><div style="flex: 1 1 0%;"><div class="app-title" title="Atlas · Cartesius">Atlas ·…</div><div class="mut">Planejador estratégico com cronogramas e checklists.</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div></div></div><div class="apps-group"><h3 style="margin: 16px 4px 8px; font-size: 15px; font-weight: 800; color: var(--mut);">Disruptor</h3><div class="grid"><div class="app-card fx-trans fx-lift"><button class="fav-btn"><svg fill="none" height="20" viewbox="0 0 24 24" width="20">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g20" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<circle cx="12" cy="12" r="9" stroke="url(#g20)" stroke-width="2"></circle>
<path d="M12 7v5l4 2" stroke="url(#g20)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span class="ripple"></span></button><div class="app-icon"><img alt="" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Cpath%20d%3D%22M4%204l7%207-7%207%22%2F%3E%3Cpath%20d%3D%22M20%204l-7%207%207%207%22%2F%3E%3C%2Fsvg%3E" width="24"/></div><div style="flex: 1 1 0%;"><div class="app-title" title="Kaos · Disruptor">Kaos ·…</div><div class="mut">Questiona padrões e propõe soluções ousadas.</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div></div></div><div class="apps-group"><h3 style="margin: 16px 4px 8px; font-size: 15px; font-weight: 800; color: var(--mut);">Evolutia</h3><div class="grid"><div class="app-card fx-trans fx-lift"><button class="fav-btn"><svg fill="none" height="20" viewbox="0 0 24 24" width="20">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g21" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<circle cx="12" cy="12" r="9" stroke="url(#g21)" stroke-width="2"></circle>
<path d="M12 7v5l4 2" stroke="url(#g21)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span class="ripple"></span></button><div class="app-icon"><img alt="" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Cpath%20d%3D%22M7%2012c0-2.2%201.8-4%204-4%201.2%200%202.3.5%203%201.3M17%2012c0%202.2-1.8%204-4%204-1.2%200-2.3-.5-3-1.3%22%2F%3E%3Cpath%20d%3D%22M3%2012h4M17%2012h4%22%2F%3E%3C%2Fsvg%3E" width="24"/></div><div style="flex: 1 1 0%;"><div class="app-title" title="Aion · Evolutia">Aion ·…</div><div class="mut">Microações estratégicas e evolução.</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div></div></div><div class="apps-group"><h3 style="margin: 16px 4px 8px; font-size: 15px; font-weight: 800; color: var(--mut);">Fabricus</h3><div class="grid"><div class="app-card fx-trans fx-lift"><button class="fav-btn"><svg fill="none" height="20" viewbox="0 0 24 24" width="20">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g22" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<circle cx="12" cy="12" r="9" stroke="url(#g22)" stroke-width="2"></circle>
<path d="M12 7v5l4 2" stroke="url(#g22)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span class="ripple"></span></button><div class="app-icon"><img alt="" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Crect%20x%3D%227%22%20y%3D%227%22%20width%3D%2210%22%20height%3D%2210%22%20rx%3D%222%22%2F%3E%3Cpath%20d%3D%22M7%207l5-3%205%203M17%2017l-5%203-5-3%22%2F%3E%3C%2Fsvg%3E" width="24"/></div><div style="flex: 1 1 0%;"><div class="app-title" title="Genus · Fabricus">Genus ·…</div><div class="mut">Protótipos e materialização de ideias.</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div></div></div><div class="apps-group"><h3 style="margin: 16px 4px 8px; font-size: 15px; font-weight: 800; color: var(--mut);">Inspira</h3><div class="grid"><div class="app-card fx-trans fx-lift"><button class="fav-btn"><svg fill="none" height="20" viewbox="0 0 24 24" width="20">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g23" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<circle cx="12" cy="12" r="9" stroke="url(#g23)" stroke-width="2"></circle>
<path d="M12 7v5l4 2" stroke="url(#g23)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span class="ripple"></span></button><div class="app-icon"><img alt="" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Cpath%20d%3D%22M12%202v4M12%2018v4M2%2012h4M18%2012h4%22%2F%3E%3Cpath%20d%3D%22M5.6%205.6l2.8%202.8M15.6%2015.6l2.8%202.8M18.4%205.6l-2.8%202.8M8.4%2015.6l-2.8%202.8%22%2F%3E%3Ccircle%20cx%3D%2212%22%20cy%3D%2212%22%20r%3D%223%22%2F%3E%3C%2Fsvg%3E" width="24"/></div><div style="flex: 1 1 0%;"><div class="app-title" title="Nova · Inspira">Nova ·…</div><div class="mut">Criativa que desbloqueia ideias com mapas mentais e exercícios.</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div></div></div><div class="apps-group"><h3 style="margin: 16px 4px 8px; font-size: 15px; font-weight: 800; color: var(--mut);">Momentum</h3><div class="grid"><div class="app-card fx-trans fx-lift"><button class="fav-btn"><svg fill="none" height="20" viewbox="0 0 24 24" width="20">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g24" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<circle cx="12" cy="12" r="9" stroke="url(#g24)" stroke-width="2"></circle>
<path d="M12 7v5l4 2" stroke="url(#g24)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span class="ripple"></span></button><div class="app-icon"><img alt="" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Cpath%20d%3D%22M3%2012h4l2-5%204%2010%202-5h6%22%2F%3E%3Cpath%20d%3D%22M13%203l-2%204%203%201-2%204%22%2F%3E%3C%2Fsvg%3E" width="24"/></div><div style="flex: 1 1 0%;"><div class="app-title" title="Vitalis · Momentum">Vitalis ·…</div><div class="mut">Rotinas físicas, hacks biológicos e motivação.</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div></div></div><div class="apps-group"><h3 style="margin: 16px 4px 8px; font-size: 15px; font-weight: 800; color: var(--mut);">Naviga</h3><div class="grid"><div class="app-card fx-trans fx-lift"><button class="fav-btn"><svg fill="none" height="20" viewbox="0 0 24 24" width="20">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g25" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<circle cx="12" cy="12" r="9" stroke="url(#g25)" stroke-width="2"></circle>
<path d="M12 7v5l4 2" stroke="url(#g25)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span class="ripple"></span></button><div class="app-icon"><img alt="" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Cpath%20d%3D%22M3%2012h12%22%2F%3E%3Cpath%20d%3D%22M13%206l6%206-6%206%22%2F%3E%3Ccircle%20cx%3D%2212%22%20cy%3D%2212%22%20r%3D%229%22%2F%3E%3C%2Fsvg%3E" width="24"/></div><div style="flex: 1 1 0%;"><div class="app-title" title="Artemis · Naviga">Artemis ·…</div><div class="mut">Explora conhecimentos e rotas de aprendizado.</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div></div></div><div class="apps-group"><h3 style="margin: 16px 4px 8px; font-size: 15px; font-weight: 800; color: var(--mut);">Outros</h3><div class="grid"><div class="app-card fx-trans fx-lift"><button class="fav-btn"><svg fill="none" height="20" viewbox="0 0 24 24" width="20">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g26" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<circle cx="12" cy="12" r="9" stroke="url(#g26)" stroke-width="2"></circle>
<path d="M12 7v5l4 2" stroke="url(#g26)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span class="ripple"></span></button><div class="app-icon"><img alt="" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Ccircle%20cx%3D%2212%22%20cy%3D%2212%22%20r%3D%229%22%2F%3E%3Cpath%20d%3D%22M3%2012h18M12%203v18%22%2F%3E%3Cpath%20d%3D%22M5%208c3%202%2011%202%2014%200M5%2016c3-2%2011-2%2014%200%22%2F%3E%3C%2Fsvg%3E" width="24"/></div><div style="flex: 1 1 0%;"><div class="app-title" title="Dual_esqueci">Dual_esqueci</div><div class="mut">HTML local</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div><div class="app-card fx-trans fx-lift"><button class="fav-btn"><svg fill="none" height="20" viewbox="0 0 24 24" width="20">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g27" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<circle cx="12" cy="12" r="9" stroke="url(#g27)" stroke-width="2"></circle>
<path d="M12 7v5l4 2" stroke="url(#g27)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span class="ripple"></span></button><div class="app-icon"><img alt="" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Ccircle%20cx%3D%2212%22%20cy%3D%2212%22%20r%3D%229%22%2F%3E%3Cpath%20d%3D%22M3%2012h18M12%203v18%22%2F%3E%3Cpath%20d%3D%22M5%208c3%202%2011%202%2014%200M5%2016c3-2%2011-2%2014%200%22%2F%3E%3C%2Fsvg%3E" width="24"/></div><div style="flex: 1 1 0%;"><div class="app-title" title="index_kobllux_voicefix">index_kobllux_voicefix</div><div class="mut">HTML local</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div><div class="app-card fx-trans fx-lift"><button class="fav-btn"><svg fill="none" height="20" viewbox="0 0 24 24" width="20">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g28" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<circle cx="12" cy="12" r="9" stroke="url(#g28)" stroke-width="2"></circle>
<path d="M12 7v5l4 2" stroke="url(#g28)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span class="ripple"></span></button><div class="app-icon"><img alt="" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Ccircle%20cx%3D%2212%22%20cy%3D%2212%22%20r%3D%229%22%2F%3E%3Cpath%20d%3D%22M3%2012h18M12%203v18%22%2F%3E%3Cpath%20d%3D%22M5%208c3%202%2011%202%2014%200M5%2016c3-2%2011-2%2014%200%22%2F%3E%3C%2Fsvg%3E" width="24"/></div><div style="flex: 1 1 0%;"><div class="app-title" title="index-100">index-100</div><div class="mut">HTML local</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div></div></div><div class="apps-group"><h3 style="margin: 16px 4px 8px; font-size: 15px; font-weight: 800; color: var(--mut);">Raízes</h3><div class="grid"><div class="app-card fx-trans fx-lift"><button class="fav-btn"><svg fill="none" height="20" viewbox="0 0 24 24" width="20">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g29" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<circle cx="12" cy="12" r="9" stroke="url(#g29)" stroke-width="2"></circle>
<path d="M12 7v5l4 2" stroke="url(#g29)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span class="ripple"></span></button><div class="app-icon"><img alt="" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Cpath%20d%3D%22M12%203v6%22%2F%3E%3Ccircle%20cx%3D%2212%22%20cy%3D%229%22%20r%3D%224%22%2F%3E%3Cpath%20d%3D%22M12%2013v2l-2%202M12%2015l2%202M12%2017v3%22%2F%3E%3C%2Fsvg%3E" width="24"/></div><div style="flex: 1 1 0%;"><div class="app-title" title="Rhea · Raízes">Rhea ·…</div><div class="mut">Vínculos e memórias emocionais.</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div></div></div><div class="apps-group"><h3 style="margin: 16px 4px 8px; font-size: 15px; font-weight: 800; color: var(--mut);">Resona</h3><div class="grid"><div class="app-card fx-trans fx-lift"><button class="fav-btn"><svg fill="none" height="20" viewbox="0 0 24 24" width="20">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g30" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<circle cx="12" cy="12" r="9" stroke="url(#g30)" stroke-width="2"></circle>
<path d="M12 7v5l4 2" stroke="url(#g30)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span class="ripple"></span></button><div class="app-icon"><img alt="" height="24" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2523f5f7ff%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Cpath%20d%3D%22M2%2012h3l2-4%203%208%202-4h8%22%2F%3E%3Cpath%20d%3D%22M20%208v-3M20%2019v-3%22%2F%3E%3C%2Fsvg%3E" width="24"/></div><div style="flex: 1 1 0%;"><div class="app-title" title="Pulse · Resona">Pulse ·…</div><div class="mut">Trilhas sonoras e ajuste de som emocional.</div><button class="btn fx-trans fx-press ring">Abrir<span class="ripple"></span></button></div></div></div></div></div>
</div>
</section>
<!-- STACK -->
<section class="view" id="v-stack">
<div class="grid">
<div class="card fx-trans fx-lift" style="display:block">
<div style="font-weight:800; display:flex; align-items:center; gap:8px">
            Sessões
            <button class="btn fx-trans fx-press ring" id="btnCloseAll" title="Fechar todas">
<svg fill="none" height="16" viewbox="0 0 24 24" width="16">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g31" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<circle cx="12" cy="12" r="9" stroke="url(#g31)" stroke-width="2"></circle>
<path d="M12 7v5l4 2" stroke="url(#g31)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
              Fechar todas<span class="ripple"></span>
</button>
<!-- Botão para criar grupos de sessões -->
<button class="btn fx-trans fx-press ring" id="btnAddGroup" title="Novo grupo">
<svg fill="none" height="16" viewbox="0 0 24 24" width="16">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g32" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<circle cx="12" cy="12" r="9" stroke="url(#g32)" stroke-width="2"></circle>
<path d="M12 7v5l4 2" stroke="url(#g32)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
              Novo grupo<span class="ripple"></span>
</button>
<!-- Botão para enviar um HTML local e abrir como sessão -->
<button class="btn fx-trans fx-press ring" id="btnStackUpload" title="Upload HTML">
<svg fill="none" height="16" viewbox="0 0 24 24" width="16">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="g33" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<circle cx="12" cy="12" r="9" stroke="url(#g33)" stroke-width="2"></circle>
<path d="M12 7v5l4 2" stroke="url(#g33)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
              Upload HTML<span class="ripple"></span>
</button>
<input accept=".html,text/html" id="stackUpload" style="display:none" type="file"/>
</div>
<div class="mut">Reabra rápido pelo dock abaixo.</div>
</div>
<!-- Área de grupos e sessões -->
<div class="grid" id="stackWrap"></div>
</div>
</section>
<!-- BRAIN -->
<section class="view active" id="v-brain">
<div class="grid">
<div class="card fx-trans fx-lift" style="display:block">
<div style="font-weight:800">Usuário</div>
<div style="display:flex;gap:8px;align-items:center;margin-top:6px">
<input class="input ring" id="userName" placeholder="Seu nome"/>
<button class="btn prime fx-trans fx-press ring" id="saveName">Salvar<span class="ripple"></span></button>
</div>
</div>
<!-- Configuração do assistente (Dual) -->
<div class="card fx-trans fx-lift" style="display:block">
<div style="font-weight:800">Assistente</div>
<div style="display:flex;gap:8px;align-items:center;margin-top:6px">
<input class="input ring" id="assistantName" placeholder="Nome do assistente"/>
<button class="btn prime fx-trans fx-press ring" id="saveAssistant">Salvar<span class="ripple"></span></button>
</div>
</div>
<!-- Seleção da voz de boas-vindas -->
<div class="card fx-trans fx-lift" style="display:block">
<div style="font-weight:800">Voz do assistente</div>
<div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap">
<select class="input ring" id="selectVoice" style="max-width:260px"><option value="Karen">Karen (en-AU)</option><option value="Rocko">Rocko (en-GB)</option><option value="Shelley">Shelley (en-GB)</option><option value="Daniel">Daniel (en-GB)</option><option value="Grandma">Grandma (en-GB)</option><option value="Grandpa">Grandpa (en-GB)</option><option value="Flo">Flo (en-GB)</option><option value="Eddy">Eddy (en-GB)</option><option value="Reed">Reed (en-GB)</option><option value="Sandy">Sandy (en-GB)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Flo">Flo (en-US)</option><option value="Bahh">Bahh (en-US)</option><option value="Albert">Albert (en-US)</option><option value="Fred">Fred (en-US)</option><option value="Jester">Jester (en-US)</option><option value="Organ">Organ (en-US)</option><option value="Cellos">Cellos (en-US)</option><option value="Zarvox">Zarvox (en-US)</option><option value="Rocko">Rocko (en-US)</option><option value="Shelley">Shelley (en-US)</option><option value="Superstar">Superstar (en-US)</option><option value="Grandma">Grandma (en-US)</option><option value="Eddy">Eddy (en-US)</option><option value="Bells">Bells (en-US)</option><option value="Grandpa">Grandpa (en-US)</option><option value="Trinoids">Trinoids (en-US)</option><option value="Kathy">Kathy (en-US)</option><option value="Reed">Reed (en-US)</option><option value="Boing">Boing (en-US)</option><option value="Whisper">Whisper (en-US)</option><option value="Good News">Good News (en-US)</option><option value="Wobble">Wobble (en-US)</option><option value="Bad News">Bad News (en-US)</option><option value="Bolhas">Bolhas (en-US)</option><option value="Samantha">Samantha (en-US)</option><option value="Sandy">Sandy (en-US)</option><option value="Junior">Junior (en-US)</option><option value="Ralph">Ralph (en-US)</option><option value="Tessa">Tessa (en-ZA)</option><option value="Reed">Reed (pt-BR)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Shelley">Shelley (pt-BR)</option><option value="Grandma">Grandma (pt-BR)</option><option value="Grandpa">Grandpa (pt-BR)</option><option value="Rocko">Rocko (pt-BR)</option><option value="Flo">Flo (pt-BR)</option><option value="Sandy">Sandy (pt-BR)</option><option value="Eddy">Eddy (pt-BR)</option><option value="Joana">Joana (pt-PT)</option><option value="Daniel">Daniel (en-GB)</option><option value="Samantha">Samantha (en-US)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Karen">Karen (en-AU)</option><option value="Joana">Joana (pt-PT)</option><option value="Tessa">Tessa (en-ZA)</option></select>
<button class="btn fx-trans fx-press ring" id="saveVoice">Salvar<span class="ripple"></span></button>
</div>
</div>
<div class="card fx-trans fx-lift" style="display:block">
<div style="font-weight:800">OpenRouter</div>
<div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap">
<select class="input ring" id="model" style="max-width:260px"><option value="openrouter/auto">openrouter/auto</option><option value="anthropic/claude-3.5-sonnet">anthropic/claude-3.5-sonnet</option><option value="openai/gpt-4.1-mini">openai/gpt-4.1-mini</option><option value="google/gemini-1.5-pro">google/gemini-1.5-pro</option><option value="meta/llama-3.1-405b-instruct">meta/llama-3.1-405b-instruct</option><option value="mistral/mistral-large-latest">mistral/mistral-large-latest</option></select>
<input class="input ring" id="sk" placeholder="sk-or-v1-…"/>
<button class="btn fx-trans fx-press ring" id="saveSK">Salvar<span class="ripple"></span></button>
</div>
<!-- Modelo personalizado e treino -->
<div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap">
<input class="input ring" id="customModel" placeholder="Modelo personalizado (ex: openai/gpt-4-custom)" style="flex:1"/>
<button class="btn fx-trans fx-press ring" id="addModel">Adicionar Modelo<span class="ripple"></span></button>
</div>
<div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap">
<input accept=".json,.txt,.dxt" class="input ring" id="trainingFile" style="max-width:260px" type="file"/>
<span class="mut" style="font-size:11px">Treinamento (DXT)</span>
</div>
</div>
<!-- Tema e Fundo personalizados -->
<div class="card fx-trans fx-lift" style="display:block">
<div style="font-weight:800">Tema &amp; Fundo</div>
<div style="margin-top:8px;display:flex;flex-direction:column;gap:12px">
<label style="display:flex;align-items:center;gap:8px">
<span>Escolha o tema:</span>
<select class="input ring" id="themeSelect" style="max-width:200px">
<option value="default">Padrão (colorido)</option>
<option value="medium">Cinza médio (tecnológico)</option>
<option value="custom">Personalizado (sua imagem/vídeo)</option>
</select>
</label>
<label style="display:flex;align-items:center;gap:8px">
<span>Fundo personalizado:</span>
<input accept="image/*,video/*" class="input ring" id="bgUpload" style="max-width:260px" type="file"/>
</label>
<div class="mut" style="font-size:11px">Envie uma imagem ou vídeo para usar como plano de fundo quando o tema personalizado estiver selecionado. O fundo será salvo automaticamente no seu navegador.</div>
</div>
</div>
<!-- CSS personalizado -->
<div class="card fx-trans fx-lift" style="display:block">
<div style="font-weight:800">CSS Personalizado</div>
<div style="margin-top:8px">
<textarea class="input ring" id="cssCustom" placeholder="CSS personalizado..." rows="4"></textarea>
<div style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap">
<button class="btn fx-trans fx-press ring" id="applyCSS">Aplicar CSS<span class="ripple"></span></button>
<button class="btn fx-trans fx-press ring" id="clearCSS">Limpar CSS<span class="ripple"></span></button>
<button class="btn fx-trans fx-press ring" id="downloadCSS">Baixar CSS<span class="ripple"></span></button>
</div>
</div>
</div>
<!-- Vozes dos Arquétipos -->
<div class="card fx-trans fx-lift" style="display:block">
<div style="font-weight:800; margin-bottom:6px">Vozes dos Arquétipos</div>
<!-- Área de seleção de voz por arquétipo.  Cada arquétipo possui
                 um seletor de voz e um botão de teste.  Essa grade será
                 preenchida dinamicamente pelo código em initVoices(). -->
<div id="voicesWrap" style="display:grid; gap:10px"><div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;"><span style="min-width: 70px; font-weight: 700;">Atlas</span><select class="input ring" style="max-width: 220px;"><option value="Karen">Karen (en-AU)</option><option value="Rocko">Rocko (en-GB)</option><option value="Shelley">Shelley (en-GB)</option><option value="Daniel">Daniel (en-GB)</option><option value="Grandma">Grandma (en-GB)</option><option value="Grandpa">Grandpa (en-GB)</option><option value="Flo">Flo (en-GB)</option><option value="Eddy">Eddy (en-GB)</option><option value="Reed">Reed (en-GB)</option><option value="Sandy">Sandy (en-GB)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Flo">Flo (en-US)</option><option value="Bahh">Bahh (en-US)</option><option value="Albert">Albert (en-US)</option><option value="Fred">Fred (en-US)</option><option value="Jester">Jester (en-US)</option><option value="Organ">Organ (en-US)</option><option value="Cellos">Cellos (en-US)</option><option value="Zarvox">Zarvox (en-US)</option><option value="Rocko">Rocko (en-US)</option><option value="Shelley">Shelley (en-US)</option><option value="Superstar">Superstar (en-US)</option><option value="Grandma">Grandma (en-US)</option><option value="Eddy">Eddy (en-US)</option><option value="Bells">Bells (en-US)</option><option value="Grandpa">Grandpa (en-US)</option><option value="Trinoids">Trinoids (en-US)</option><option value="Kathy">Kathy (en-US)</option><option value="Reed">Reed (en-US)</option><option value="Boing">Boing (en-US)</option><option value="Whisper">Whisper (en-US)</option><option value="Good News">Good News (en-US)</option><option value="Wobble">Wobble (en-US)</option><option value="Bad News">Bad News (en-US)</option><option value="Bolhas">Bolhas (en-US)</option><option value="Samantha">Samantha (en-US)</option><option value="Sandy">Sandy (en-US)</option><option value="Junior">Junior (en-US)</option><option value="Ralph">Ralph (en-US)</option><option value="Tessa">Tessa (en-ZA)</option><option value="Reed">Reed (pt-BR)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Shelley">Shelley (pt-BR)</option><option value="Grandma">Grandma (pt-BR)</option><option value="Grandpa">Grandpa (pt-BR)</option><option value="Rocko">Rocko (pt-BR)</option><option value="Flo">Flo (pt-BR)</option><option value="Sandy">Sandy (pt-BR)</option><option value="Eddy">Eddy (pt-BR)</option><option value="Joana">Joana (pt-PT)</option><option value="Daniel">Daniel (en-GB)</option><option value="Samantha">Samantha (en-US)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Karen">Karen (en-AU)</option><option value="Joana">Joana (pt-PT)</option><option value="Tessa">Tessa (en-ZA)</option></select><button class="btn fx-trans fx-press ring">Teste<span class="ripple"></span></button></div><div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;"><span style="min-width: 70px; font-weight: 700;">Nova</span><select class="input ring" style="max-width: 220px;"><option value="Karen">Karen (en-AU)</option><option value="Rocko">Rocko (en-GB)</option><option value="Shelley">Shelley (en-GB)</option><option value="Daniel">Daniel (en-GB)</option><option value="Grandma">Grandma (en-GB)</option><option value="Grandpa">Grandpa (en-GB)</option><option value="Flo">Flo (en-GB)</option><option value="Eddy">Eddy (en-GB)</option><option value="Reed">Reed (en-GB)</option><option value="Sandy">Sandy (en-GB)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Flo">Flo (en-US)</option><option value="Bahh">Bahh (en-US)</option><option value="Albert">Albert (en-US)</option><option value="Fred">Fred (en-US)</option><option value="Jester">Jester (en-US)</option><option value="Organ">Organ (en-US)</option><option value="Cellos">Cellos (en-US)</option><option value="Zarvox">Zarvox (en-US)</option><option value="Rocko">Rocko (en-US)</option><option value="Shelley">Shelley (en-US)</option><option value="Superstar">Superstar (en-US)</option><option value="Grandma">Grandma (en-US)</option><option value="Eddy">Eddy (en-US)</option><option value="Bells">Bells (en-US)</option><option value="Grandpa">Grandpa (en-US)</option><option value="Trinoids">Trinoids (en-US)</option><option value="Kathy">Kathy (en-US)</option><option value="Reed">Reed (en-US)</option><option value="Boing">Boing (en-US)</option><option value="Whisper">Whisper (en-US)</option><option value="Good News">Good News (en-US)</option><option value="Wobble">Wobble (en-US)</option><option value="Bad News">Bad News (en-US)</option><option value="Bolhas">Bolhas (en-US)</option><option value="Samantha">Samantha (en-US)</option><option value="Sandy">Sandy (en-US)</option><option value="Junior">Junior (en-US)</option><option value="Ralph">Ralph (en-US)</option><option value="Tessa">Tessa (en-ZA)</option><option value="Reed">Reed (pt-BR)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Shelley">Shelley (pt-BR)</option><option value="Grandma">Grandma (pt-BR)</option><option value="Grandpa">Grandpa (pt-BR)</option><option value="Rocko">Rocko (pt-BR)</option><option value="Flo">Flo (pt-BR)</option><option value="Sandy">Sandy (pt-BR)</option><option value="Eddy">Eddy (pt-BR)</option><option value="Joana">Joana (pt-PT)</option><option value="Daniel">Daniel (en-GB)</option><option value="Samantha">Samantha (en-US)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Karen">Karen (en-AU)</option><option value="Joana">Joana (pt-PT)</option><option value="Tessa">Tessa (en-ZA)</option></select><button class="btn fx-trans fx-press ring">Teste<span class="ripple"></span></button></div><div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;"><span style="min-width: 70px; font-weight: 700;">Vitalis</span><select class="input ring" style="max-width: 220px;"><option value="Karen">Karen (en-AU)</option><option value="Rocko">Rocko (en-GB)</option><option value="Shelley">Shelley (en-GB)</option><option value="Daniel">Daniel (en-GB)</option><option value="Grandma">Grandma (en-GB)</option><option value="Grandpa">Grandpa (en-GB)</option><option value="Flo">Flo (en-GB)</option><option value="Eddy">Eddy (en-GB)</option><option value="Reed">Reed (en-GB)</option><option value="Sandy">Sandy (en-GB)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Flo">Flo (en-US)</option><option value="Bahh">Bahh (en-US)</option><option value="Albert">Albert (en-US)</option><option value="Fred">Fred (en-US)</option><option value="Jester">Jester (en-US)</option><option value="Organ">Organ (en-US)</option><option value="Cellos">Cellos (en-US)</option><option value="Zarvox">Zarvox (en-US)</option><option value="Rocko">Rocko (en-US)</option><option value="Shelley">Shelley (en-US)</option><option value="Superstar">Superstar (en-US)</option><option value="Grandma">Grandma (en-US)</option><option value="Eddy">Eddy (en-US)</option><option value="Bells">Bells (en-US)</option><option value="Grandpa">Grandpa (en-US)</option><option value="Trinoids">Trinoids (en-US)</option><option value="Kathy">Kathy (en-US)</option><option value="Reed">Reed (en-US)</option><option value="Boing">Boing (en-US)</option><option value="Whisper">Whisper (en-US)</option><option value="Good News">Good News (en-US)</option><option value="Wobble">Wobble (en-US)</option><option value="Bad News">Bad News (en-US)</option><option value="Bolhas">Bolhas (en-US)</option><option value="Samantha">Samantha (en-US)</option><option value="Sandy">Sandy (en-US)</option><option value="Junior">Junior (en-US)</option><option value="Ralph">Ralph (en-US)</option><option value="Tessa">Tessa (en-ZA)</option><option value="Reed">Reed (pt-BR)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Shelley">Shelley (pt-BR)</option><option value="Grandma">Grandma (pt-BR)</option><option value="Grandpa">Grandpa (pt-BR)</option><option value="Rocko">Rocko (pt-BR)</option><option value="Flo">Flo (pt-BR)</option><option value="Sandy">Sandy (pt-BR)</option><option value="Eddy">Eddy (pt-BR)</option><option value="Joana">Joana (pt-PT)</option><option value="Daniel">Daniel (en-GB)</option><option value="Samantha">Samantha (en-US)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Karen">Karen (en-AU)</option><option value="Joana">Joana (pt-PT)</option><option value="Tessa">Tessa (en-ZA)</option></select><button class="btn fx-trans fx-press ring">Teste<span class="ripple"></span></button></div><div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;"><span style="min-width: 70px; font-weight: 700;">Pulse</span><select class="input ring" style="max-width: 220px;"><option value="Karen">Karen (en-AU)</option><option value="Rocko">Rocko (en-GB)</option><option value="Shelley">Shelley (en-GB)</option><option value="Daniel">Daniel (en-GB)</option><option value="Grandma">Grandma (en-GB)</option><option value="Grandpa">Grandpa (en-GB)</option><option value="Flo">Flo (en-GB)</option><option value="Eddy">Eddy (en-GB)</option><option value="Reed">Reed (en-GB)</option><option value="Sandy">Sandy (en-GB)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Flo">Flo (en-US)</option><option value="Bahh">Bahh (en-US)</option><option value="Albert">Albert (en-US)</option><option value="Fred">Fred (en-US)</option><option value="Jester">Jester (en-US)</option><option value="Organ">Organ (en-US)</option><option value="Cellos">Cellos (en-US)</option><option value="Zarvox">Zarvox (en-US)</option><option value="Rocko">Rocko (en-US)</option><option value="Shelley">Shelley (en-US)</option><option value="Superstar">Superstar (en-US)</option><option value="Grandma">Grandma (en-US)</option><option value="Eddy">Eddy (en-US)</option><option value="Bells">Bells (en-US)</option><option value="Grandpa">Grandpa (en-US)</option><option value="Trinoids">Trinoids (en-US)</option><option value="Kathy">Kathy (en-US)</option><option value="Reed">Reed (en-US)</option><option value="Boing">Boing (en-US)</option><option value="Whisper">Whisper (en-US)</option><option value="Good News">Good News (en-US)</option><option value="Wobble">Wobble (en-US)</option><option value="Bad News">Bad News (en-US)</option><option value="Bolhas">Bolhas (en-US)</option><option value="Samantha">Samantha (en-US)</option><option value="Sandy">Sandy (en-US)</option><option value="Junior">Junior (en-US)</option><option value="Ralph">Ralph (en-US)</option><option value="Tessa">Tessa (en-ZA)</option><option value="Reed">Reed (pt-BR)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Shelley">Shelley (pt-BR)</option><option value="Grandma">Grandma (pt-BR)</option><option value="Grandpa">Grandpa (pt-BR)</option><option value="Rocko">Rocko (pt-BR)</option><option value="Flo">Flo (pt-BR)</option><option value="Sandy">Sandy (pt-BR)</option><option value="Eddy">Eddy (pt-BR)</option><option value="Joana">Joana (pt-PT)</option><option value="Daniel">Daniel (en-GB)</option><option value="Samantha">Samantha (en-US)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Karen">Karen (en-AU)</option><option value="Joana">Joana (pt-PT)</option><option value="Tessa">Tessa (en-ZA)</option></select><button class="btn fx-trans fx-press ring">Teste<span class="ripple"></span></button></div><div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;"><span style="min-width: 70px; font-weight: 700;">Artemis</span><select class="input ring" style="max-width: 220px;"><option value="Karen">Karen (en-AU)</option><option value="Rocko">Rocko (en-GB)</option><option value="Shelley">Shelley (en-GB)</option><option value="Daniel">Daniel (en-GB)</option><option value="Grandma">Grandma (en-GB)</option><option value="Grandpa">Grandpa (en-GB)</option><option value="Flo">Flo (en-GB)</option><option value="Eddy">Eddy (en-GB)</option><option value="Reed">Reed (en-GB)</option><option value="Sandy">Sandy (en-GB)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Flo">Flo (en-US)</option><option value="Bahh">Bahh (en-US)</option><option value="Albert">Albert (en-US)</option><option value="Fred">Fred (en-US)</option><option value="Jester">Jester (en-US)</option><option value="Organ">Organ (en-US)</option><option value="Cellos">Cellos (en-US)</option><option value="Zarvox">Zarvox (en-US)</option><option value="Rocko">Rocko (en-US)</option><option value="Shelley">Shelley (en-US)</option><option value="Superstar">Superstar (en-US)</option><option value="Grandma">Grandma (en-US)</option><option value="Eddy">Eddy (en-US)</option><option value="Bells">Bells (en-US)</option><option value="Grandpa">Grandpa (en-US)</option><option value="Trinoids">Trinoids (en-US)</option><option value="Kathy">Kathy (en-US)</option><option value="Reed">Reed (en-US)</option><option value="Boing">Boing (en-US)</option><option value="Whisper">Whisper (en-US)</option><option value="Good News">Good News (en-US)</option><option value="Wobble">Wobble (en-US)</option><option value="Bad News">Bad News (en-US)</option><option value="Bolhas">Bolhas (en-US)</option><option value="Samantha">Samantha (en-US)</option><option value="Sandy">Sandy (en-US)</option><option value="Junior">Junior (en-US)</option><option value="Ralph">Ralph (en-US)</option><option value="Tessa">Tessa (en-ZA)</option><option value="Reed">Reed (pt-BR)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Shelley">Shelley (pt-BR)</option><option value="Grandma">Grandma (pt-BR)</option><option value="Grandpa">Grandpa (pt-BR)</option><option value="Rocko">Rocko (pt-BR)</option><option value="Flo">Flo (pt-BR)</option><option value="Sandy">Sandy (pt-BR)</option><option value="Eddy">Eddy (pt-BR)</option><option value="Joana">Joana (pt-PT)</option><option value="Daniel">Daniel (en-GB)</option><option value="Samantha">Samantha (en-US)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Karen">Karen (en-AU)</option><option value="Joana">Joana (pt-PT)</option><option value="Tessa">Tessa (en-ZA)</option></select><button class="btn fx-trans fx-press ring">Teste<span class="ripple"></span></button></div><div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;"><span style="min-width: 70px; font-weight: 700;">Serena</span><select class="input ring" style="max-width: 220px;"><option value="Karen">Karen (en-AU)</option><option value="Rocko">Rocko (en-GB)</option><option value="Shelley">Shelley (en-GB)</option><option value="Daniel">Daniel (en-GB)</option><option value="Grandma">Grandma (en-GB)</option><option value="Grandpa">Grandpa (en-GB)</option><option value="Flo">Flo (en-GB)</option><option value="Eddy">Eddy (en-GB)</option><option value="Reed">Reed (en-GB)</option><option value="Sandy">Sandy (en-GB)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Flo">Flo (en-US)</option><option value="Bahh">Bahh (en-US)</option><option value="Albert">Albert (en-US)</option><option value="Fred">Fred (en-US)</option><option value="Jester">Jester (en-US)</option><option value="Organ">Organ (en-US)</option><option value="Cellos">Cellos (en-US)</option><option value="Zarvox">Zarvox (en-US)</option><option value="Rocko">Rocko (en-US)</option><option value="Shelley">Shelley (en-US)</option><option value="Superstar">Superstar (en-US)</option><option value="Grandma">Grandma (en-US)</option><option value="Eddy">Eddy (en-US)</option><option value="Bells">Bells (en-US)</option><option value="Grandpa">Grandpa (en-US)</option><option value="Trinoids">Trinoids (en-US)</option><option value="Kathy">Kathy (en-US)</option><option value="Reed">Reed (en-US)</option><option value="Boing">Boing (en-US)</option><option value="Whisper">Whisper (en-US)</option><option value="Good News">Good News (en-US)</option><option value="Wobble">Wobble (en-US)</option><option value="Bad News">Bad News (en-US)</option><option value="Bolhas">Bolhas (en-US)</option><option value="Samantha">Samantha (en-US)</option><option value="Sandy">Sandy (en-US)</option><option value="Junior">Junior (en-US)</option><option value="Ralph">Ralph (en-US)</option><option value="Tessa">Tessa (en-ZA)</option><option value="Reed">Reed (pt-BR)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Shelley">Shelley (pt-BR)</option><option value="Grandma">Grandma (pt-BR)</option><option value="Grandpa">Grandpa (pt-BR)</option><option value="Rocko">Rocko (pt-BR)</option><option value="Flo">Flo (pt-BR)</option><option value="Sandy">Sandy (pt-BR)</option><option value="Eddy">Eddy (pt-BR)</option><option value="Joana">Joana (pt-PT)</option><option value="Daniel">Daniel (en-GB)</option><option value="Samantha">Samantha (en-US)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Karen">Karen (en-AU)</option><option value="Joana">Joana (pt-PT)</option><option value="Tessa">Tessa (en-ZA)</option></select><button class="btn fx-trans fx-press ring">Teste<span class="ripple"></span></button></div><div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;"><span style="min-width: 70px; font-weight: 700;">Kaos</span><select class="input ring" style="max-width: 220px;"><option value="Karen">Karen (en-AU)</option><option value="Rocko">Rocko (en-GB)</option><option value="Shelley">Shelley (en-GB)</option><option value="Daniel">Daniel (en-GB)</option><option value="Grandma">Grandma (en-GB)</option><option value="Grandpa">Grandpa (en-GB)</option><option value="Flo">Flo (en-GB)</option><option value="Eddy">Eddy (en-GB)</option><option value="Reed">Reed (en-GB)</option><option value="Sandy">Sandy (en-GB)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Flo">Flo (en-US)</option><option value="Bahh">Bahh (en-US)</option><option value="Albert">Albert (en-US)</option><option value="Fred">Fred (en-US)</option><option value="Jester">Jester (en-US)</option><option value="Organ">Organ (en-US)</option><option value="Cellos">Cellos (en-US)</option><option value="Zarvox">Zarvox (en-US)</option><option value="Rocko">Rocko (en-US)</option><option value="Shelley">Shelley (en-US)</option><option value="Superstar">Superstar (en-US)</option><option value="Grandma">Grandma (en-US)</option><option value="Eddy">Eddy (en-US)</option><option value="Bells">Bells (en-US)</option><option value="Grandpa">Grandpa (en-US)</option><option value="Trinoids">Trinoids (en-US)</option><option value="Kathy">Kathy (en-US)</option><option value="Reed">Reed (en-US)</option><option value="Boing">Boing (en-US)</option><option value="Whisper">Whisper (en-US)</option><option value="Good News">Good News (en-US)</option><option value="Wobble">Wobble (en-US)</option><option value="Bad News">Bad News (en-US)</option><option value="Bolhas">Bolhas (en-US)</option><option value="Samantha">Samantha (en-US)</option><option value="Sandy">Sandy (en-US)</option><option value="Junior">Junior (en-US)</option><option value="Ralph">Ralph (en-US)</option><option value="Tessa">Tessa (en-ZA)</option><option value="Reed">Reed (pt-BR)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Shelley">Shelley (pt-BR)</option><option value="Grandma">Grandma (pt-BR)</option><option value="Grandpa">Grandpa (pt-BR)</option><option value="Rocko">Rocko (pt-BR)</option><option value="Flo">Flo (pt-BR)</option><option value="Sandy">Sandy (pt-BR)</option><option value="Eddy">Eddy (pt-BR)</option><option value="Joana">Joana (pt-PT)</option><option value="Daniel">Daniel (en-GB)</option><option value="Samantha">Samantha (en-US)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Karen">Karen (en-AU)</option><option value="Joana">Joana (pt-PT)</option><option value="Tessa">Tessa (en-ZA)</option></select><button class="btn fx-trans fx-press ring">Teste<span class="ripple"></span></button></div><div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;"><span style="min-width: 70px; font-weight: 700;">Genus</span><select class="input ring" style="max-width: 220px;"><option value="Karen">Karen (en-AU)</option><option value="Rocko">Rocko (en-GB)</option><option value="Shelley">Shelley (en-GB)</option><option value="Daniel">Daniel (en-GB)</option><option value="Grandma">Grandma (en-GB)</option><option value="Grandpa">Grandpa (en-GB)</option><option value="Flo">Flo (en-GB)</option><option value="Eddy">Eddy (en-GB)</option><option value="Reed">Reed (en-GB)</option><option value="Sandy">Sandy (en-GB)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Flo">Flo (en-US)</option><option value="Bahh">Bahh (en-US)</option><option value="Albert">Albert (en-US)</option><option value="Fred">Fred (en-US)</option><option value="Jester">Jester (en-US)</option><option value="Organ">Organ (en-US)</option><option value="Cellos">Cellos (en-US)</option><option value="Zarvox">Zarvox (en-US)</option><option value="Rocko">Rocko (en-US)</option><option value="Shelley">Shelley (en-US)</option><option value="Superstar">Superstar (en-US)</option><option value="Grandma">Grandma (en-US)</option><option value="Eddy">Eddy (en-US)</option><option value="Bells">Bells (en-US)</option><option value="Grandpa">Grandpa (en-US)</option><option value="Trinoids">Trinoids (en-US)</option><option value="Kathy">Kathy (en-US)</option><option value="Reed">Reed (en-US)</option><option value="Boing">Boing (en-US)</option><option value="Whisper">Whisper (en-US)</option><option value="Good News">Good News (en-US)</option><option value="Wobble">Wobble (en-US)</option><option value="Bad News">Bad News (en-US)</option><option value="Bolhas">Bolhas (en-US)</option><option value="Samantha">Samantha (en-US)</option><option value="Sandy">Sandy (en-US)</option><option value="Junior">Junior (en-US)</option><option value="Ralph">Ralph (en-US)</option><option value="Tessa">Tessa (en-ZA)</option><option value="Reed">Reed (pt-BR)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Shelley">Shelley (pt-BR)</option><option value="Grandma">Grandma (pt-BR)</option><option value="Grandpa">Grandpa (pt-BR)</option><option value="Rocko">Rocko (pt-BR)</option><option value="Flo">Flo (pt-BR)</option><option value="Sandy">Sandy (pt-BR)</option><option value="Eddy">Eddy (pt-BR)</option><option value="Joana">Joana (pt-PT)</option><option value="Daniel">Daniel (en-GB)</option><option value="Samantha">Samantha (en-US)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Karen">Karen (en-AU)</option><option value="Joana">Joana (pt-PT)</option><option value="Tessa">Tessa (en-ZA)</option></select><button class="btn fx-trans fx-press ring">Teste<span class="ripple"></span></button></div><div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;"><span style="min-width: 70px; font-weight: 700;">Lumine</span><select class="input ring" style="max-width: 220px;"><option value="Karen">Karen (en-AU)</option><option value="Rocko">Rocko (en-GB)</option><option value="Shelley">Shelley (en-GB)</option><option value="Daniel">Daniel (en-GB)</option><option value="Grandma">Grandma (en-GB)</option><option value="Grandpa">Grandpa (en-GB)</option><option value="Flo">Flo (en-GB)</option><option value="Eddy">Eddy (en-GB)</option><option value="Reed">Reed (en-GB)</option><option value="Sandy">Sandy (en-GB)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Flo">Flo (en-US)</option><option value="Bahh">Bahh (en-US)</option><option value="Albert">Albert (en-US)</option><option value="Fred">Fred (en-US)</option><option value="Jester">Jester (en-US)</option><option value="Organ">Organ (en-US)</option><option value="Cellos">Cellos (en-US)</option><option value="Zarvox">Zarvox (en-US)</option><option value="Rocko">Rocko (en-US)</option><option value="Shelley">Shelley (en-US)</option><option value="Superstar">Superstar (en-US)</option><option value="Grandma">Grandma (en-US)</option><option value="Eddy">Eddy (en-US)</option><option value="Bells">Bells (en-US)</option><option value="Grandpa">Grandpa (en-US)</option><option value="Trinoids">Trinoids (en-US)</option><option value="Kathy">Kathy (en-US)</option><option value="Reed">Reed (en-US)</option><option value="Boing">Boing (en-US)</option><option value="Whisper">Whisper (en-US)</option><option value="Good News">Good News (en-US)</option><option value="Wobble">Wobble (en-US)</option><option value="Bad News">Bad News (en-US)</option><option value="Bolhas">Bolhas (en-US)</option><option value="Samantha">Samantha (en-US)</option><option value="Sandy">Sandy (en-US)</option><option value="Junior">Junior (en-US)</option><option value="Ralph">Ralph (en-US)</option><option value="Tessa">Tessa (en-ZA)</option><option value="Reed">Reed (pt-BR)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Shelley">Shelley (pt-BR)</option><option value="Grandma">Grandma (pt-BR)</option><option value="Grandpa">Grandpa (pt-BR)</option><option value="Rocko">Rocko (pt-BR)</option><option value="Flo">Flo (pt-BR)</option><option value="Sandy">Sandy (pt-BR)</option><option value="Eddy">Eddy (pt-BR)</option><option value="Joana">Joana (pt-PT)</option><option value="Daniel">Daniel (en-GB)</option><option value="Samantha">Samantha (en-US)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Karen">Karen (en-AU)</option><option value="Joana">Joana (pt-PT)</option><option value="Tessa">Tessa (en-ZA)</option></select><button class="btn fx-trans fx-press ring">Teste<span class="ripple"></span></button></div><div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;"><span style="min-width: 70px; font-weight: 700;">Rhea</span><select class="input ring" style="max-width: 220px;"><option value="Karen">Karen (en-AU)</option><option value="Rocko">Rocko (en-GB)</option><option value="Shelley">Shelley (en-GB)</option><option value="Daniel">Daniel (en-GB)</option><option value="Grandma">Grandma (en-GB)</option><option value="Grandpa">Grandpa (en-GB)</option><option value="Flo">Flo (en-GB)</option><option value="Eddy">Eddy (en-GB)</option><option value="Reed">Reed (en-GB)</option><option value="Sandy">Sandy (en-GB)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Flo">Flo (en-US)</option><option value="Bahh">Bahh (en-US)</option><option value="Albert">Albert (en-US)</option><option value="Fred">Fred (en-US)</option><option value="Jester">Jester (en-US)</option><option value="Organ">Organ (en-US)</option><option value="Cellos">Cellos (en-US)</option><option value="Zarvox">Zarvox (en-US)</option><option value="Rocko">Rocko (en-US)</option><option value="Shelley">Shelley (en-US)</option><option value="Superstar">Superstar (en-US)</option><option value="Grandma">Grandma (en-US)</option><option value="Eddy">Eddy (en-US)</option><option value="Bells">Bells (en-US)</option><option value="Grandpa">Grandpa (en-US)</option><option value="Trinoids">Trinoids (en-US)</option><option value="Kathy">Kathy (en-US)</option><option value="Reed">Reed (en-US)</option><option value="Boing">Boing (en-US)</option><option value="Whisper">Whisper (en-US)</option><option value="Good News">Good News (en-US)</option><option value="Wobble">Wobble (en-US)</option><option value="Bad News">Bad News (en-US)</option><option value="Bolhas">Bolhas (en-US)</option><option value="Samantha">Samantha (en-US)</option><option value="Sandy">Sandy (en-US)</option><option value="Junior">Junior (en-US)</option><option value="Ralph">Ralph (en-US)</option><option value="Tessa">Tessa (en-ZA)</option><option value="Reed">Reed (pt-BR)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Shelley">Shelley (pt-BR)</option><option value="Grandma">Grandma (pt-BR)</option><option value="Grandpa">Grandpa (pt-BR)</option><option value="Rocko">Rocko (pt-BR)</option><option value="Flo">Flo (pt-BR)</option><option value="Sandy">Sandy (pt-BR)</option><option value="Eddy">Eddy (pt-BR)</option><option value="Joana">Joana (pt-PT)</option><option value="Daniel">Daniel (en-GB)</option><option value="Samantha">Samantha (en-US)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Karen">Karen (en-AU)</option><option value="Joana">Joana (pt-PT)</option><option value="Tessa">Tessa (en-ZA)</option></select><button class="btn fx-trans fx-press ring">Teste<span class="ripple"></span></button></div><div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;"><span style="min-width: 70px; font-weight: 700;">Solus</span><select class="input ring" style="max-width: 220px;"><option value="Karen">Karen (en-AU)</option><option value="Rocko">Rocko (en-GB)</option><option value="Shelley">Shelley (en-GB)</option><option value="Daniel">Daniel (en-GB)</option><option value="Grandma">Grandma (en-GB)</option><option value="Grandpa">Grandpa (en-GB)</option><option value="Flo">Flo (en-GB)</option><option value="Eddy">Eddy (en-GB)</option><option value="Reed">Reed (en-GB)</option><option value="Sandy">Sandy (en-GB)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Flo">Flo (en-US)</option><option value="Bahh">Bahh (en-US)</option><option value="Albert">Albert (en-US)</option><option value="Fred">Fred (en-US)</option><option value="Jester">Jester (en-US)</option><option value="Organ">Organ (en-US)</option><option value="Cellos">Cellos (en-US)</option><option value="Zarvox">Zarvox (en-US)</option><option value="Rocko">Rocko (en-US)</option><option value="Shelley">Shelley (en-US)</option><option value="Superstar">Superstar (en-US)</option><option value="Grandma">Grandma (en-US)</option><option value="Eddy">Eddy (en-US)</option><option value="Bells">Bells (en-US)</option><option value="Grandpa">Grandpa (en-US)</option><option value="Trinoids">Trinoids (en-US)</option><option value="Kathy">Kathy (en-US)</option><option value="Reed">Reed (en-US)</option><option value="Boing">Boing (en-US)</option><option value="Whisper">Whisper (en-US)</option><option value="Good News">Good News (en-US)</option><option value="Wobble">Wobble (en-US)</option><option value="Bad News">Bad News (en-US)</option><option value="Bolhas">Bolhas (en-US)</option><option value="Samantha">Samantha (en-US)</option><option value="Sandy">Sandy (en-US)</option><option value="Junior">Junior (en-US)</option><option value="Ralph">Ralph (en-US)</option><option value="Tessa">Tessa (en-ZA)</option><option value="Reed">Reed (pt-BR)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Shelley">Shelley (pt-BR)</option><option value="Grandma">Grandma (pt-BR)</option><option value="Grandpa">Grandpa (pt-BR)</option><option value="Rocko">Rocko (pt-BR)</option><option value="Flo">Flo (pt-BR)</option><option value="Sandy">Sandy (pt-BR)</option><option value="Eddy">Eddy (pt-BR)</option><option value="Joana">Joana (pt-PT)</option><option value="Daniel">Daniel (en-GB)</option><option value="Samantha">Samantha (en-US)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Karen">Karen (en-AU)</option><option value="Joana">Joana (pt-PT)</option><option value="Tessa">Tessa (en-ZA)</option></select><button class="btn fx-trans fx-press ring">Teste<span class="ripple"></span></button></div><div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;"><span style="min-width: 70px; font-weight: 700;">Aion</span><select class="input ring" style="max-width: 220px;"><option value="Karen">Karen (en-AU)</option><option value="Rocko">Rocko (en-GB)</option><option value="Shelley">Shelley (en-GB)</option><option value="Daniel">Daniel (en-GB)</option><option value="Grandma">Grandma (en-GB)</option><option value="Grandpa">Grandpa (en-GB)</option><option value="Flo">Flo (en-GB)</option><option value="Eddy">Eddy (en-GB)</option><option value="Reed">Reed (en-GB)</option><option value="Sandy">Sandy (en-GB)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Flo">Flo (en-US)</option><option value="Bahh">Bahh (en-US)</option><option value="Albert">Albert (en-US)</option><option value="Fred">Fred (en-US)</option><option value="Jester">Jester (en-US)</option><option value="Organ">Organ (en-US)</option><option value="Cellos">Cellos (en-US)</option><option value="Zarvox">Zarvox (en-US)</option><option value="Rocko">Rocko (en-US)</option><option value="Shelley">Shelley (en-US)</option><option value="Superstar">Superstar (en-US)</option><option value="Grandma">Grandma (en-US)</option><option value="Eddy">Eddy (en-US)</option><option value="Bells">Bells (en-US)</option><option value="Grandpa">Grandpa (en-US)</option><option value="Trinoids">Trinoids (en-US)</option><option value="Kathy">Kathy (en-US)</option><option value="Reed">Reed (en-US)</option><option value="Boing">Boing (en-US)</option><option value="Whisper">Whisper (en-US)</option><option value="Good News">Good News (en-US)</option><option value="Wobble">Wobble (en-US)</option><option value="Bad News">Bad News (en-US)</option><option value="Bolhas">Bolhas (en-US)</option><option value="Samantha">Samantha (en-US)</option><option value="Sandy">Sandy (en-US)</option><option value="Junior">Junior (en-US)</option><option value="Ralph">Ralph (en-US)</option><option value="Tessa">Tessa (en-ZA)</option><option value="Reed">Reed (pt-BR)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Shelley">Shelley (pt-BR)</option><option value="Grandma">Grandma (pt-BR)</option><option value="Grandpa">Grandpa (pt-BR)</option><option value="Rocko">Rocko (pt-BR)</option><option value="Flo">Flo (pt-BR)</option><option value="Sandy">Sandy (pt-BR)</option><option value="Eddy">Eddy (pt-BR)</option><option value="Joana">Joana (pt-PT)</option><option value="Daniel">Daniel (en-GB)</option><option value="Samantha">Samantha (en-US)</option><option value="Luciana">Luciana (pt-BR)</option><option value="Moira">Moira (en-IE)</option><option value="Rishi">Rishi (en-IN)</option><option value="Karen">Karen (en-AU)</option><option value="Joana">Joana (pt-PT)</option><option value="Tessa">Tessa (en-ZA)</option></select><button class="btn fx-trans fx-press ring">Teste<span class="ripple"></span></button></div></div>
<!-- Preferências de Performance -->
<div class="card fx-trans fx-lift" style="display:block">
<div style="font-weight:800">Performance</div>
<div style="display:flex;gap:8px;align-items:center;margin-top:6px">
<select class="input ring" id="selPerf" style="max-width:200px">
<option value="low">Low</option>
<option value="med">Med</option>
<option value="high">High</option>
</select>
<button class="btn fx-trans fx-press ring" id="btnPerf">Aplicar<span class="ripple"></span></button>
</div>
</div>
<!-- Preferências de Voz -->
<div class="card fx-trans fx-lift" style="display:block">
<div style="font-weight:800">Voz</div>
<div style="display:flex;gap:8px;align-items:center;margin-top:6px">
<select class="input ring" id="selVoice" style="max-width:200px">
<option>Nova</option>
<option>Elysha</option>
<option>Kaion</option>
<option>Serena</option>
</select>
<button class="btn fx-trans fx-press ring" id="btnVoice">Salvar<span class="ripple"></span></button>
</div>
</div>
<!-- Logs -->
<div class="card fx-trans fx-lift" style="display:block">
<div style="font-weight:800">Logs</div>
<div class="mut" style="font-size:11px;margin-bottom:4px">Eventos recentes</div>
<pre id="logs" style="margin:0;font:12px/1.4 ui-monospace,monospace;color:var(--mut);max-height:140px;overflow:auto;white-space:pre-wrap;word-break:break-word;overflow-wrap:anywhere"></pre>
</div>
</div>
</div>
</section>
<!-- CHAT (Dual • Chat) -->
<section class="view" id="v-chat">
<div class="grid">
<div class="card">
<div style="font-weight:800;margin-bottom:6px">Pulso em Expansão</div>
<div class="chat-pulse" id="chatPulse"></div>
</div>
<div class="card">
<div class="chat-wrap">
<div aria-live="polite" class="chat-feed" id="chatFeed"></div>
<div class="chat-composer">
<textarea id="chatInput" placeholder="Escreva sua intenção... (Shift+Enter quebra linha)"></textarea>
<button class="btn prime" id="chatSend">Enviar</button>
</div>
</div>
</div>
</div>
</section>
</main>
<!-- DOCK & TABS -->
<div class="dock" id="dock"></div>
<nav class="tabbar">
<div class="inner">
<button class="tab fx-trans fx-press ring" data-nav="home">
<svg aria-hidden="true" fill="none" height="22" viewbox="0 0 24 24" width="22">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="gradNebulaTab" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<path d="M3 10.5L12 3l9 7.5" stroke="url(#gradNebulaTab)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
<path d="M5 10v10h14V10" stroke="url(#gradNebulaTab)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span style="display:none">Home</span><span class="ripple"></span>
</button>
<button class="tab fx-trans fx-press ring" data-nav="apps">
<svg aria-hidden="true" fill="none" height="22" viewbox="0 0 24 24" width="22">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="gradNebulaTab" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<rect height="7" rx="2" stroke="url(#gradNebulaTab)" stroke-width="2" width="7" x="3" y="3"></rect>
<rect height="7" rx="2" stroke="url(#gradNebulaTab)" stroke-width="2" width="7" x="14" y="3"></rect>
<rect height="7" rx="2" stroke="url(#gradNebulaTab)" stroke-width="2" width="7" x="3" y="14"></rect>
<rect height="7" rx="2" stroke="url(#gradNebulaTab)" stroke-width="2" width="7" x="14" y="14"></rect>
</svg><span style="display:none">Apps</span><span class="ripple"></span>
</button>
<button class="tab fx-trans fx-press ring" data-nav="stack">
<svg aria-hidden="true" fill="none" height="22" viewbox="0 0 24 24" width="22">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="gradNebulaTab" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<polygon fill="none" points="12 2 2 7 12 12 22 7 12 2" stroke="url(#gradNebulaTab)" stroke-width="2"></polygon>
<polyline fill="none" points="2 12 12 17 22 12" stroke="url(#gradNebulaTab)" stroke-width="2"></polyline>
<polyline fill="none" points="2 17 12 22 22 17" stroke="url(#gradNebulaTab)" stroke-width="2"></polyline>
</svg><span style="display:none">Stack</span><span class="ripple"></span>
</button>
<button class="tab fx-trans fx-press ring active" data-nav="brain">
<svg aria-hidden="true" fill="none" height="22" viewbox="0 0 24 24" width="22">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="gradNebulaTab" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<path d="M8 6a3 3 0 0 1 6 0 3 3 0 0 1 3 3 3 3 0 0 1 3 3 4 4 0 0 1-4 4H8a4 4 0 0 1-4-4 3 3 0 0 1 3-3 3 3 0 0 1 1-3z" stroke="url(#gradNebulaTab)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span style="display:none">Brain</span><span class="ripple"></span>
</button>
<!-- Botão da nova aba Chat -->
<button class="tab fx-trans fx-press ring" data-nav="chat">
<svg aria-hidden="true" fill="none" height="22" viewbox="0 0 24 24" width="22">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="gradNebulaTab" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<path d="M21 15a4 4 0 0 1-4 4H7l-4 4V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4v8z" stroke="url(#gradNebulaTab)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span style="display:none">Chat</span><span class="ripple"></span>
</button>
</div>
</nav>
<!-- Preview da última mensagem recebida (aparece na home e leva ao chat) -->
<div id="msgPreview" style="display: none;"></div>
<!-- Controles de texto e voz empilhados acima da barra de navegação -->
<div class="home-btns" id="homeButtons">
<button class="home-btn" id="homeTextBtn"><svg aria-hidden="true" fill="none" height="20" viewbox="0 0 24 24" width="20">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="gradNebulaPen" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<path d="M3 21l3.9-1 11.7-11.7a2.5 2.5 0 0 0-3.5-3.5L3.9 16.5 3 21z" fill="url(#gradNebulaPen)"></path>
<path d="M14 6l4 4" stroke="url(#gradNebulaPen)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span class="ripple"></span></button>
<button class="home-btn" id="homeVoiceBtn"><svg aria-hidden="true" fill="none" height="22" stroke="url(#gradNebula)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="22">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="gradNebula" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<path d="M12 1a4 4 0 0 1 4 4v6a4 4 0 0 1-8 0V5a4 4 0 0 1 4-4z"></path>
<path d="M19 11a7 7 0 0 1-14 0"></path>
<path d="M12 19v4"></path>
</svg><span class="ripple"></span></button>
</div>
<!-- Overlay de input para envio rápido de mensagens na Home -->
<div id="homeInputOverlay">
<form autocomplete="off" id="homeInputForm">
<input autocomplete="off" id="homeInput" placeholder="Escreva aqui…" type="text"/>
<button type="submit"><svg aria-hidden="true" fill="none" height="22" viewbox="0 0 24 24" width="22">
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="gradNebula" x1="0" x2="24" y1="0" y2="24">
<stop offset="0" stop-color="#00FFFF"></stop>
<stop offset="1" stop-color="#FF00FF"></stop>
</lineargradient>
</defs>
<path d="M4 12L20 4L13 20L11 13L4 12Z" fill="url(#gradNebula)" opacity="0.95"></path>
</svg><span class="ripple"></span></button>
</form>
</div>
<!-- HELP MODAL -->
<div aria-hidden="true" class="modal" id="modalHelp">
<div class="panel">
<div style="display:flex;align-items:center;gap:10px;justify-content:space-between">
<h3 style="margin:0">Ajuda &amp; Atalhos</h3>
<button class="btn fx-trans fx-press ring" id="closeHelp">Fechar<span class="ripple"></span></button>
</div>
<div class="mut" style="margin-top:8px">Navegue mais rápido:</div>
<ul>
<li><span class="kbd">g</span> then <span class="kbd">h</span> → Home</li>
<li><span class="kbd">g</span> then <span class="kbd">a</span> → Apps</li>
<li><span class="kbd">g</span> then <span class="kbd">s</span> → Stack</li>
<li><span class="kbd">g</span> then <span class="kbd">b</span> → Brain</li>
<li><span class="kbd">g</span> then <span class="kbd">r</span> → Chat</li>
<li><span class="kbd">Ctrl / Cmd</span> + <span class="kbd">K</span> → Busca</li>
<li><span class="kbd">Ctrl / Cmd</span> + <span class="kbd">S</span> → Baixar este HTML</li>
</ul>
</div>
</div>
<!-- ===== Catálogo Embutido (Monólito) ===== -->
<script id="APPS_JSON" type="application/json">
  {
    "apps": [
      {"key":"atlas","title":"Atlas · Cartesius","desc":"Planejador estratégico com cronogramas e checklists.","url":"about:blank","icon":"atlas"},
      {"key":"nova","title":"Nova · Inspira","desc":"Criativa que desbloqueia ideias com mapas mentais e exercícios.","url":"about:blank","icon":"nova"},
      {"key":"vitalis","title":"Vitalis · Momentum","desc":"Rotinas físicas, hacks biológicos e motivação.","url":"about:blank","icon":"vitalis"},
      {"key":"pulse","title":"Pulse · Resona","desc":"Trilhas sonoras e ajuste de som emocional.","url":"about:blank","icon":"pulse"},
      {"key":"artemis","title":"Artemis · Naviga","desc":"Explora conhecimentos e rotas de aprendizado.","url":"about:blank","icon":"artemis"},
      {"key":"serena","title":"Serena · Ampara","desc":"Acolhimento e suporte emocional.","url":"about:blank","icon":"serena"},
      {"key":"kaos","title":"Kaos · Disruptor","desc":"Questiona padrões e propõe soluções ousadas.","url":"about:blank","icon":"kaos"},
      {"key":"genus","title":"Genus · Fabricus","desc":"Protótipos e materialização de ideias.","url":"about:blank","icon":"genus"},
      {"key":"lumine","title":"Lumine · Brilhare","desc":"Inspiração leve e atividades lúdicas.","url":"about:blank","icon":"lumine"},
      {"key":"rhea","title":"Rhea · Raízes","desc":"Vínculos e memórias emocionais.","url":"about:blank","icon":"rhea"},
      {"key":"solus","title":"Solus · Arcana","desc":"Harmonização energética e meditação.","url":"about:blank","icon":"solus"},
      {"key":"aion","title":"Aion · Evolutia","desc":"Microações estratégicas e evolução.","url":"about:blank","icon":"aion"}
    ]
  }
  </script>
<script>
  // Redefine the global toast function to suppress popup messages. If you
  // later decide to re-enable notifications, remove or comment out this line.
  window.toast = function(){};
    /* ===================== Helpers ===================== */
    const $ = (q, r = document) => r.querySelector(q);
    const $$ = (q, r = document) => Array.from(r.querySelectorAll(q));
    const LS = {
      get: (k, d) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d } catch (e) { return d } },
      set: (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)) } catch (e) {} },
      raw: (k) => localStorage.getItem(k) || ''
    };

    /* ===================== DualHub State & Logging ===================== */
    // Armazena preferências de performance, voz e registros de eventos para a funcionalidade "Dual" aprimorada.
    const dualState = {
      perf: localStorage.getItem('hub.perf') || 'med',
      voice: localStorage.getItem('hub.voice') || 'Nova',
      logs: []
    };
    // Adiciona uma entrada ao log e atualiza o painel de logs no Brain.
    function dualLog(msg) {
      const entry = '[' + new Date().toLocaleTimeString() + '] ' + msg;
      dualState.logs.unshift(entry);
      const logsEl = document.getElementById('logs');
      if (logsEl) logsEl.textContent = dualState.logs.slice(0, 60).join('\n');
    }

    /* Ripple */
    function addRipple(el) {
      if (!el) return;
      // Ensure a ripple host exists on the element. The global ripple handler will create dots on pointerdown.
      if (!el.querySelector('.ripple')) {
        const slot = document.createElement('span');
        slot.className = 'ripple';
        el.appendChild(slot);
      }
      // Do not attach individual pointerdown events here; ripple will be handled globally.
    }

    /* Toast */
    const toastBox = document.createElement('div');
    toastBox.style.cssText = 'position:fixed;right:14px;bottom:calc(var(--tabsH) + 16px);display:grid;gap:8px;z-index:120';
    document.body.appendChild(toastBox);
    function toast(msg, type = 'ok') {
      const el = document.createElement('div'); el.className = 'fx-trans';
      const bg = type === 'ok' ? 'linear-gradient(90deg,#1b2a2a,#123c2e)' : (type === 'warn' ? 'linear-gradient(90deg,#2f261b,#3c2d12)' : 'linear-gradient(90deg,#2f1b1b,#3c1212)');
      el.style.cssText = `background:${bg}; color:var(--fg); border:${getComputedStyle(document.documentElement).getPropertyValue('--bd')}; padding:.6rem .8rem; border-radius:12px; box-shadow:var(--shadow)`;
      el.textContent = msg; toastBox.appendChild(el);
      setTimeout(() => { el.style.opacity = .0; el.style.transform = 'translateY(6px)'; setTimeout(() => el.remove(), 220); }, 1600);
    }

    /* ===================== Saudação / último estado ===================== */
    function displayGreeting() {
      const card = document.getElementById('greetingCard');
      // Não exibir o cartão de saudação; usamos mensagens na bolinha
      if (card) card.style.display = 'none';
      const name = (localStorage.getItem('infodose:userName') || '').trim();
      const sessions = document.querySelectorAll('.session').length;
      if (!name) {
        showArchMessage('Salve! Ative sua Dual Infodose registrando seu nome na seção Brain.', 'warn');
      } else {
        showArchMessage(`Bem-vindo de volta, ${name}. UNO está ao seu lado. Você tem ${sessions} sessão(ões) ativa(s).`, 'ok');
      }
    }

    /* ===================== Tema & Fundo personalizados ===================== */
    // Aplica o tema salvo no localStorage. Os temas possíveis são: 'default' (remove data-theme), 'medium'
    // e 'custom'.  Quando 'custom' estiver ativo, usa a imagem/vídeo salvo em LS ('uno:bg') como
    // plano de fundo.  Se 'medium' estiver selecionado, adiciona data-theme='medium'.
    function applyTheme() {
      const theme = LS.get('uno:theme','blue1');
      // Limpe qualquer dataset para que CSS default seja aplicado quando 'default'
      if (theme === 'default') {
        delete document.body.dataset.theme;
      } else {
        document.body.dataset.theme = theme;
      }
      // Gerenciar fundo personalizado
      const bgContainer = document.getElementById('custom-bg');
      if (!bgContainer) return;
      if (theme !== 'custom') {
        bgContainer.innerHTML = '';
        return;
      }
      // Carregar dados do fundo
      const bgData = LS.get('uno:bg', '');
      bgContainer.innerHTML = '';
      if (!bgData) return;
      // Determine se é vídeo ou imagem
      if (/^data:video\//.test(bgData)) {
        const vid = document.createElement('video');
        vid.src = bgData;
        vid.autoplay = true;
        vid.loop = true;
        vid.muted = true;
        vid.playsInline = true;
        vid.style.width = '100%';
        vid.style.height = '100%';
        vid.style.objectFit = 'cover';
        bgContainer.appendChild(vid);
      } else {
        const img = document.createElement('img');
        img.src = bgData;
        img.alt = '';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        bgContainer.appendChild(img);
      }
    }

    /* ===================== CSS Personalizado ===================== */
    // Aplica o CSS salvo em localStorage (chave 'infodose:cssCustom')
    function applyCSS() {
      let styleEl = document.getElementById('customStyle');
      if (!styleEl) {
        styleEl = document.createElement('style');
        styleEl.id = 'customStyle';
        document.head.appendChild(styleEl);
      }
      const css = localStorage.getItem('infodose:cssCustom') || '';
      styleEl.innerHTML = css || '';
    }

    // Inicializa seleção de vozes para cada arquétipo
    function initVoices() {
      const wrap = document.getElementById('voicesWrap');
      if (!wrap) return;
      wrap.innerHTML = '';
      const archList = [
        'atlas.html',
        'nova.html',
        'vitalis.html',
        'pulse.html',
        'artemis.html',
        'serena.html',
        'kaos.html',
        'genus.html',
        'lumine.html',
        'solus.html',
        'rhea.html',
        'aion.html'
      ];
      function populateVoices() {
        let voices = speechSynthesis.getVoices();
        // Filtrar por idiomas suportados (Português e Inglês) se disponível
        const filtered = voices.filter(v => v.lang && (v.lang.startsWith('pt') || v.lang.startsWith('en')));
        voices = filtered.length ? filtered : voices;
        const saved = LS.get('infodose:voices', {}) || {};
        // Se ainda não houver vozes salvas, defina um mapeamento padrão
        if (Object.keys(saved).length === 0 && voices.length) {
          archList.forEach((name, idx) => {
            const v = voices[idx % voices.length];
            if (v) saved[name] = v.name;
          });
          LS.set('infodose:voices', saved);
        }
        archList.forEach(name => {
          // Cria um acordeão (detalhes) para cada arquétipo. O nome sem extensão aparece no cabeçalho.
          const detailsEl = document.createElement('details');
          detailsEl.className = 'voice-accordion';
          const summary = document.createElement('summary');
          const baseName = name.replace(/\.html$/i, '');
          summary.textContent = baseName.charAt(0).toUpperCase() + baseName.slice(1);
          summary.style.cursor = 'pointer';
          summary.style.fontWeight = '700';
          summary.style.marginBottom = '4px';
          detailsEl.appendChild(summary);
          // Contêiner para o seletor de voz e botão de teste
          const row = document.createElement('div');
          row.style.display = 'flex';
          row.style.alignItems = 'center';
          row.style.gap = '8px';
          row.style.flexWrap = 'wrap';
          // Seletor de voz
          const sel = document.createElement('select');
          sel.className = 'input ring';
          sel.style.maxWidth = '220px';
          voices.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.name;
            opt.textContent = `${v.name} (${v.lang})`;
            sel.appendChild(opt);
          });
          if (saved[name]) sel.value = saved[name];
          sel.onchange = () => {
            saved[name] = sel.value;
            LS.set('infodose:voices', saved);
          };
          // Botão de teste
          const btnTest = document.createElement('button');
          btnTest.className = 'btn fx-trans fx-press ring';
          btnTest.textContent = 'Teste';
          const rp = document.createElement('span');
          rp.className = 'ripple';
          btnTest.appendChild(rp);
          addRipple(btnTest);
          btnTest.onclick = () => {
            const utter = new SpeechSynthesisUtterance(`Olá, eu sou ${baseName}`);
            const voiceName = saved[name] || sel.value;
            const voice = voices.find(v => v.name === voiceName);
            if (voice) utter.voice = voice;
            speechSynthesis.cancel();
            speechSynthesis.speak(utter);
          };
          row.appendChild(sel);
          row.appendChild(btnTest);
          detailsEl.appendChild(row);
          wrap.appendChild(detailsEl);
        });
      }
      populateVoices();
      // Re-populate when voices list changes
      window.speechSynthesis.onvoiceschanged = () => populateVoices();
    }

    // Pronuncia o nome do arquétipo usando a voz selecionada
    function speakArchetype(name) {
      try {
        const archName = name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();
        const saved = LS.get('infodose:voices', {});
        const voices = speechSynthesis.getVoices();
        let voice = null;
        if (saved && saved[archName]) {
          voice = voices.find(v => v.name === saved[archName]);
        }
        if (!voice) {
          voice = voices.find(v => v.lang && (v.lang.startsWith('pt') || v.lang.startsWith('en')));
        }
        if (!voice && voices.length) voice = voices[0];
        if (!voice) return;
        const utter = new SpeechSynthesisUtterance(`Olá, eu sou ${archName}`);
        utter.voice = voice;
        speechSynthesis.cancel();
        speechSynthesis.speak(utter);
      } catch (e) {}
    }

    // Fala um texto usando a voz associada ao arquétipo atualmente ativo.  Utiliza a lista
    // de vozes do Speech Synthesis e o mapeamento salvo em LS para encontrar a voz
    // correta. Se não houver voz definida, escolhe a primeira disponível (PT/EN).
    function speakWithActiveArch(text) {
      try {
        const select = document.getElementById('arch-select');
        let archFile = select ? select.value || '' : '';
        let base = archFile.replace(/\.html$/i, '');
        const key = base.charAt(0).toUpperCase() + base.slice(1).toLowerCase();
        const saved = LS.get('infodose:voices', {}) || {};
        const voices = speechSynthesis.getVoices();
        let voice = null;
        if (saved[key]) {
          voice = voices.find(v => v.name === saved[key]);
        }
        if (!voice) {
          voice = voices.find(v => v.lang && (v.lang.startsWith('pt') || v.lang.startsWith('en')));
        }
        if (!voice && voices.length) voice = voices[0];
        if (!voice) return;
        const utter = new SpeechSynthesisUtterance(text);
        utter.voice = voice;
        speechSynthesis.cancel();
        speechSynthesis.speak(utter);
      } catch (e) {}
    }

    // Exibe uma mensagem dentro do círculo do arquétipo. A mensagem desaparece após alguns segundos.
    function showArchMessage(text, type = 'info') {
      try {
        const el = document.getElementById('archMsg');
        if (!el) return;
        el.textContent = text;
        // Ajuste a cor de fundo conforme o tipo
        if (type === 'ok') {
          el.style.background = 'rgba(57,255,182,0.75)';
          el.style.color = '#0b0f14';
        } else if (type === 'warn') {
          el.style.background = 'rgba(255,184,107,0.78)';
          el.style.color = '#0b0f14';
        } else if (type === 'err') {
          el.style.background = 'rgba(255,107,107,0.78)';
          el.style.color = '#0b0f14';
        } else {
          el.style.background = 'rgba(15,17,32,0.72)';
          el.style.color = '';
        }
        el.classList.add('show');
        clearTimeout(el._tm);
        el._tm = setTimeout(() => {
          el.classList.remove('show');
        }, 4000);
      } catch (e) {}
    }

    // Configura o modo de ripple que responde ao áudio do microfone.  Cria um
    // analisador de áudio usando Web Audio API e ajusta a opacidade da camada
    // "audioRipple" conforme a intensidade do som capturado. Um botão
    // (arch-audio) ativa/desativa o efeito de forma discreta.
    function initAudioRipple() {
      const clickLayer = document.getElementById('audioRipple');
      const archCircleEl = document.querySelector('.arch-circle');
      if (!clickLayer || !archCircleEl) return;
      let enabled = false;
      let audioCtx = null;
      let analyser = null;
      let micStream = null;
      // Inicia a captura de áudio e animação
      async function start() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          micStream = stream;
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          const src = audioCtx.createMediaStreamSource(stream);
          analyser = audioCtx.createAnalyser();
          analyser.fftSize = 256;
          src.connect(analyser);
          animate();
        } catch (e) {
          toast('Não foi possível acessar o microfone.', 'err');
          enabled = false;
          archCircleEl.classList.remove('audio-on');
        }
      }
      // Para a captura de áudio e reseta a camada
      function stop() {
        if (micStream) {
          micStream.getTracks().forEach(t => t.stop());
          micStream = null;
        }
        if (audioCtx) {
          try { audioCtx.close(); } catch {}
          audioCtx = null;
        }
        // Remova o efeito de sombra quando desligar
        archCircleEl.style.boxShadow = '';
      }
      // Atualiza a opacidade da camada conforme o volume (RMS)
      function animate() {
        if (!enabled || !analyser) return;
        const buf = new Uint8Array(analyser.fftSize);
        analyser.getByteTimeDomainData(buf);
        let sum = 0;
        for (let i = 0; i < buf.length; i++) {
          const v = (buf[i] - 128) / 128;
          sum += v * v;
        }
        const rms = Math.sqrt(sum / buf.length);
        // Ajuste a intensidade: multiplique por um fator e limite a 0.6
        // Aplique um brilho em torno do círculo proporcional ao volume
        const intensity = Math.min(0.8, rms * 4);
        // envia nível para o iframe do arquétipo (se existir)
        try { const fr = document.getElementById('arch-frame'); if (fr && fr.contentWindow) fr.contentWindow.postMessage({ audioLevel: Math.min(1, rms*3) }, '*'); } catch (e) {}
        const blur = rms * 80;
        archCircleEl.style.boxShadow = `0 0 ${blur}px rgba(255,255,255,${intensity})`;
        requestAnimationFrame(animate);
      }
      // Clique simples no círculo inicia a interação Dual: anima a bolinha,
      // faz a saudação e inicia a captura de voz para conversar com a IA.
      clickLayer.addEventListener('click', () => {
        startDualInteraction();
      });

      // Função global para alternar o modo de visualização do áudio (ripple).  
      // Mantemos para compatibilidade com o botão de áudio no menu.
      window.toggleAudio = function () {
        enabled = !enabled;
        archCircleEl.classList.toggle('audio-on', enabled);
        if (enabled) {
          start();
        } else {
          stop();
        }
      };
    }

    // Mensagem de boas-vindas/ativação
    function welcome() {
      const name = (localStorage.getItem('infodose:userName') || '').trim();
      if (!name) {
        const msg = 'Salve! Ative sua Dual Infodose registrando seu nome na seção Brain.';
        showArchMessage(msg, 'warn');
        try { speakWithActiveArch(msg); } catch {}
      } else {
        const msg = `Bem-vindo de volta, ${name}. UNO está ao seu lado.`;
        showArchMessage(msg, 'ok');
        try { speakWithActiveArch(msg); } catch {}
      }
    }

    /* Apply ripple */
    $$('button').forEach(addRipple);
    // Move the arquétipos circle below the menu in the home view after initialization
    (function() {
      try {
        const home = document.getElementById('v-home');
        if (!home) return;
        const arch = home.querySelector('.arch-container');
        const cards = home.querySelector('.cards');
        // Se ambos existirem, garanta que as cartas apareçam depois do círculo de arquétipos.
        if (arch && cards) {
          arch.insertAdjacentElement('afterend', cards);
        }
      } catch (e) {
        console.warn('Falha ao reposicionar arquétipo:', e);
      }
    })();
    const obs = new MutationObserver((muts) => { muts.forEach(m => m.addedNodes && m.addedNodes.forEach(n => { if (n.nodeType === 1) { if (n.matches?.('button')) addRipple(n); n.querySelectorAll?.('button').forEach(addRipple); } })) });
    obs.observe(document.body, { childList: true, subtree: true });

    /* ===================== Navegação + Estado ===================== */
    function nav(key) {
      const __ov = document.getElementById('homeInputOverlay'); const __tb = document.getElementById('homeTextBtn'); if(__ov){ __ov.style.display='none'; } if(__tb){ __tb.classList.remove('active'); }
// Remapeia a antiga aba 'revo' para 'chat'
      if (key === 'revo') key = 'chat';
      // Adicionamos 'chat' à lista de abas para suportar a nova seção
      const tabs = ['home', 'apps', 'stack', 'brain', 'chat'];
      tabs.forEach(k => {
        const viewEl = document.getElementById('v-' + k);
        if (viewEl) viewEl.classList.toggle('active', k === key);
        const tabEl = document.querySelector(`.tab[data-nav="${k}"]`);
        if (tabEl) tabEl.classList.toggle('active', k === key);
      });
      LS.set('uno:lastTab', key);
      // Quando entrar na aba Home, apresente mensagem de saudação / última sessão
      if (key === 'home') {
        try { displayGreeting(); } catch (e) { console.warn(e); }
        try {
          const nameG = (localStorage.getItem('infodose:userName') || '').trim();
          if (!nameG) {
            toast('Salve! Ative sua Dual Infodose registrando seu nome na seção Brain.', 'warn');
          } else {
            // Saudação rápida na forma de toast quando o usuário retorna ao home.
            toast(`Bem-vindo de volta, ${nameG}. UNO está ao seu lado.`, 'ok');
          }
        } catch (e) {}
        // Atualize também os status quando entrar no Home
        try { updateHomeStatus(); } catch {}
      }
      // Nenhuma ação especial ao entrar na aba de chat por enquanto

      // Falar uma frase curta ao trocar de aba, usando a voz do arquétipo ativo
      try {
        let phrase = '';
        let type = 'info';
        switch (key) {
          case 'home': phrase = 'Página inicial'; break;
          case 'apps': phrase = 'Abrindo apps'; break;
          case 'stack': phrase = 'Abrindo stack'; break;
          case 'brain': phrase = 'Abrindo usuário'; break;
          case 'chat': phrase = 'Abrindo chat'; break;
          default: phrase = '';
        }
        if (phrase) {
          speakWithActiveArch(phrase);
          showArchMessage(phrase, type);
        }
        // Mostrar o preview laranja somente na Home; escondê-lo nas outras abas
        try {
          const prev = document.getElementById('msgPreview');
          if (prev) {
            prev.style.display = (key === 'home' && prev.textContent) ? 'block' : 'none';
          }
        } catch (e) { console.warn(e); }
      } catch (e) {}
    }

    // Alterna a visibilidade do menu de arquétipos.  O menu fica
    // escondido/mostrado ao clicar no círculo (toque curto).  Este
    // helper é chamado por initAudioRipple().
    function toggleArchMenu() {
      const menu = document.getElementById('archMenu');
      if (!menu) return;
      menu.classList.toggle('show');
    }

    /**
     * Inicia a interação Dual ao tocar a bolinha.  Esta função aplica uma
     * animação breve de pressão à bolinha, fala a saudação “Oi DUAL” (ou
     * outra frase definida) usando a voz do arquétipo ativo e, em seguida,
     * verifica se o usuário está conectado (nome, chave do OpenRouter e
     * modelo selecionados).  Caso esteja tudo configurado, ativa o
     * reconhecimento de voz para captar a fala do usuário e prosseguir
     * com a conversa.  Caso contrário, exibe uma mensagem orientando o
     * usuário a preencher suas configurações no Brain.
     */
    function startDualInteraction() {
      const archCircle = document.querySelector('.arch-circle');
      if (!archCircle) return;
      // Animação de clique: adiciona classe 'pressed' brevemente
      archCircle.classList.add('pressed');
      setTimeout(() => archCircle.classList.remove('pressed'), 180);
      // Saudação falada
      const greet = 'Oi Dual';
      showArchMessage(greet, 'ok');
      try { speakWithActiveArch(greet); } catch {}
      // Após a saudação, aguarde um curto intervalo antes de iniciar a verificação
      setTimeout(() => {
        const sk = localStorage.getItem('dual.keys.openrouter') || '';
        const userName = (localStorage.getItem('infodose:userName') || '').trim();
        const model = LS.get('dual.openrouter.model');
        if (!sk || !userName || !model) {
          const warn = 'Configure nome, chave e modelo no Brain para conversar.';
          showArchMessage(warn, 'warn');
          return;
        }
        // Se estiver tudo configurado, inicie o reconhecimento de voz
        startSpeechConversation(userName, sk, model);
      }, 600);
    }

    /**
     * Inicia o reconhecimento de fala via Web Speech API.  Quando o usuário
     * terminar de falar, a transcrição é encaminhada para a função de
     * manipulação de mensagens, que enviará a pergunta ao modelo de IA e
     * lidará com a resposta.
     * @param {string} userName Nome do usuário (para personalizar respostas)
     * @param {string} sk Chave da API do OpenRouter
     * @param {string} model Modelo selecionado
     */

    // Insere mensagens no feed de IA da Home. Mantém somente as últimas 10 entradas.
    function feedPush(type, text) {
      // Adiciona mensagem ao feed de IA se existir (mantido para compatibilidade)
      const box = document.getElementById('iaFeed');
      if (box) {
        const div = document.createElement('div');
        div.className = 'msg ' + (type || 'status');
        div.textContent = text;
        box.appendChild(div);
        const msgs = box.querySelectorAll('.msg');
        const limit = 10;
        if (msgs.length > limit) {
          box.removeChild(msgs[0]);
        }
        box.scrollTop = box.scrollHeight;
      }
      // Envia a mensagem também ao feed de chat e atualiza o preview
      try {
        chatPush(type, text);
        if (type === 'ai') updatePreview(text);
      } catch (e) { console.warn(e); }
    }
    // Função auxiliar para adicionar mensagens ao feed de chat
    function chatPush(type, text) {
      const feed = document.getElementById('chatFeed');
      if (!feed) return;
      const div = document.createElement('div');
      div.className = 'msg ' + (type || 'status');
      div.textContent = text;
      feed.appendChild(div);
      const msgs = feed.querySelectorAll('.msg');
      const limit = 50;
      if (msgs.length > limit) {
        feed.removeChild(msgs[0]);
      }
      feed.scrollTop = feed.scrollHeight;
    }
    // Atualiza o preview laranja com a última resposta da IA
    function updatePreview(text) {
      const prev = document.getElementById('msgPreview');
      if (!prev) return;
      prev.textContent = text.replace(/\s+/g, ' ').trim();
      // Exibe o preview apenas se a página Home estiver ativa.  Caso
      // contrário, mantenha-o oculto para não interferir na visualização
      // das outras abas (chat, apps etc.).
      const homeView = document.getElementById('v-home');
      const isHomeActive = homeView && homeView.classList.contains('active');
      prev.style.display = isHomeActive ? 'block' : 'none';
    }
    function startSpeechConversation(userName, sk, model) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        showArchMessage('Reconhecimento de fala não suportado neste navegador.', 'err');
        return;
      }
      const recognition = new SpeechRecognition();
      recognition.lang = 'pt-BR';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.onstart = () => {
        showArchMessage('Estou ouvindo…', 'ok');
        feedPush('status', '🎙️ Ouvindo…');
      };
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.trim();
        if (transcript) {
          feedPush('user', 'Você: ' + transcript);
          showArchMessage('Pulso enviado. Recebendo intenção…', 'ok');
          feedPush('status', '⚡ Pulso enviado · recebendo intenção…');
          handleUserMessage(transcript, userName, sk, model);
        }
      };
      recognition.onerror = (e) => {
        console.error('Erro no reconhecimento de fala:', e);
        showArchMessage('Erro no reconhecimento de fala.', 'err');
        feedPush('status', '❌ Erro no reconhecimento de fala.');
      };
      recognition.start();
    }

    /**
     * Processa a mensagem falada pelo usuário.  Exibe a transcrição no
     * feedback, envia a mensagem ao modelo de IA via OpenRouter e, ao
     * receber a resposta, exibe e fala a resposta de volta.
     * @param {string} text Texto transcrito da fala do usuário
     * @param {string} userName Nome do usuário
     * @param {string} sk Chave OpenRouter
     * @param {string} model Modelo de IA
     */
    async function handleUserMessage(text, userName, sk, model) {
      // A mensagem do usuário já foi adicionada ao feed no evento onresult do reconhecimento de fala
      // Monta prompt incluindo o nome do usuário para personalização
      const prompt = `${userName} disse: ${text}`;
      // Envia ao modelo de IA
      let reply = '';
      try {
        reply = await sendAIMessage(prompt, sk, model);
      } catch (err) {
        console.error('Falha ao consultar IA:', err);
        reply = 'Desculpe, não consegui responder no momento.';
      }
      if (reply) {
        // Determine o arquétipo ativo para prefixar as respostas no feed
        let archName = 'Dual';
        try {
          const select = document.getElementById('arch-select');
          let base = (select?.value || '').replace(/\.html$/i, '');
          archName = base.charAt(0).toUpperCase() + base.slice(1).toLowerCase();
        } catch (e) {}
        feedPush('ai', archName + ': ' + reply);
        showArchMessage(reply, 'ok');
        try { speakWithActiveArch(reply); } catch {}
      }
    }

    /**
     * Envia uma mensagem ao endpoint de chat do OpenRouter.  Esta função
     * utiliza a API de chat completions para obter uma resposta do modelo
     * selecionado.  Caso não seja possível acessar a API (por exemplo,
     * se a aplicação estiver offline), uma resposta de erro é retornada.
     * @param {string} content Conteúdo da mensagem/prompt
     * @param {string} sk Chave de API
     * @param {string} model Identificador do modelo
     * @returns {Promise<string>} Resposta do modelo
     */
    async function sendAIMessage(content, sk, model) {
      // Estrutura de payload conforme especificação do OpenRouter
      const payload = {
        model: model,
        messages: [
          { role: 'system', content: 'Você é um assistente amistoso que responde em português.' },
          { role: 'user', content: content }
        ],
        max_tokens: 200,
        temperature: 0.7
      };
      const url = 'https://openrouter.ai/api/v1/chat/completions';
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${sk}`
        },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        throw new Error('Erro na API: ' + res.status);
      }
      const data = await res.json();
      const reply = data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content;
      return reply || '';
    }

    // Delegue cliques dentro do menu para a função de navegação.
    document.addEventListener('DOMContentLoaded', () => {
      const menu = document.getElementById('archMenu');
      if (menu) {
      menu.addEventListener('click', (e) => {
        // Primeiro verifique se o botão de áudio foi clicado
        const audioBtn = e.target.closest('button[data-audio]');
        if (audioBtn) {
          // Alterna modo áudio usando a função global
          if (typeof toggleAudio === 'function') {
            toggleAudio();
          }
          // Atualize o estado visual do botão
          const archCircle = document.querySelector('.arch-circle');
          if (archCircle) {
            audioBtn.classList.toggle('on', archCircle.classList.contains('audio-on'));
          }
          // Não feche o menu ao alternar áudio
          return;
        }
        // Caso contrário, delegue a navegação para botões com data-nav
        const btn = e.target.closest('button[data-nav]');
        if (btn) {
          nav(btn.getAttribute('data-nav'));
          menu.classList.remove('show');
        }
      });
      }
      // Clique no preview direciona ao chat
      const mp = document.getElementById('msgPreview');
      if (mp) mp.addEventListener('click', () => nav('chat'));

      /* Formulário de chat removido: a captura de mensagens é feita via
         overlay de entrada. */

      // Inicialização dos botões de texto e voz na Home (overlay).  Dois botões
      // empilhados acima da barra: o superior inicia reconhecimento de voz e
      // o inferior mostra o campo de texto. O envio do formulário do
      // overlay dispara a mesma lógica do chat padrão.
      const textBtn = document.getElementById('homeTextBtn');
      const voiceBtn = document.getElementById('homeVoiceBtn');
      const hiOverlay = document.getElementById('homeInputOverlay');
      const hiForm = document.getElementById('homeInputForm');
      const hiInput = document.getElementById('homeInput');
      // Exibe/oculta o overlay ao tocar no botão de texto
      if (textBtn && hiOverlay && hiForm && hiInput) {
        textBtn.addEventListener('click', () => {
          const show = hiOverlay.style.display !== 'block';
          hiOverlay.style.display = show ? 'block' : 'none';
          textBtn.classList.toggle('active', show);
          if (show) setTimeout(() => hiInput.focus(), 60);
        });
        hiForm.addEventListener('submit', (ev) => {
          ev.preventDefault();
          const msg = hiInput.value.trim();
          if (!msg) return;
          feedPush('user', 'Você: ' + msg);
          showArchMessage('Pulso enviado. Recebendo intenção…', 'ok');
          feedPush('status', '⚡ Pulso enviado · recebendo intenção…');
          const userName = (localStorage.getItem('dual.name') || localStorage.getItem('infodose:userName') || '').trim();
          const sk = (localStorage.getItem('dual.keys.openrouter') || localStorage.getItem('infodose:sk') || '').trim();
          let mdl = LS.get('dual.openrouter.model');
          if (!mdl) mdl = (localStorage.getItem('infodose:model') || '').trim() || 'openrouter/auto';
          try { handleUserMessage(msg, userName, sk, mdl); } catch (e) { console.warn(e); }
          hiInput.value = '';
        });
      }
      // Inicia conversa por voz ao tocar no botão de voz
      if (voiceBtn) {
        voiceBtn.addEventListener('click', () => {
          const userName = (localStorage.getItem('dual.name') || localStorage.getItem('infodose:userName') || '').trim();
          const sk = (localStorage.getItem('dual.keys.openrouter') || localStorage.getItem('infodose:sk') || '').trim();
          let mdl = LS.get('dual.openrouter.model');
          if (!mdl) mdl = (localStorage.getItem('infodose:model') || '').trim() || 'openrouter/auto';
          if (hiOverlay) hiOverlay.style.display = 'none';
          if (typeof startSpeechConversation === 'function') {
            startSpeechConversation(userName, sk, mdl);
          }
        });
      }
    });

    // Helper: se a aba Revo estiver ativa, envia a lista atual de apps ao iframe.  
    function maybeSendAppsToRevo() {
      // Revo foi substituído pelo Chat; nenhuma mensagem precisa ser enviada
      return;
    }
    $$('.tab,[data-nav]').forEach(b => b.addEventListener('click', () => nav(b.dataset.nav || 'home')));
    $('#btnBack').onclick = () => { try { history.length > 1 && history.back() } catch { } };
    $('#btnBrain').onclick = () => nav('brain');

    // Restaurar última aba
    let last = LS.get('uno:lastTab', 'home');
    // Se o último tab salvo for 'revo', redirecione para home para evitar páginas vazias
    if (last === 'revo') last = 'home';
    nav(last);
    // Se a aba inicial for home, exibir saudação
    if (last === 'home') {
      try { displayGreeting(); } catch(e) {}
    }

    // Atalhos
    let gPressed = false;
    window.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') { e.preventDefault(); downloadSelf(); return; }
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') { e.preventDefault(); $('#appSearch')?.focus(); return; }
      if (e.key.toLowerCase() === 'g') { gPressed = true; setTimeout(() => gPressed = false, 600); return; }
      if (!gPressed) return; const k = e.key.toLowerCase();
      if (k === 'h') nav('home'); if (k === 'a') nav('apps'); if (k === 's') nav('stack'); if (k === 'b') nav('brain'); if (k === 'r') nav('chat'); gPressed = false;
    });

    // Ajuda modal
    const modalHelp = $('#modalHelp');
    $('#btnHelp').onclick = () => { modalHelp.classList.add('open'); modalHelp.setAttribute('aria-hidden', 'false'); };
    $('#closeHelp').onclick = () => { modalHelp.classList.remove('open'); modalHelp.setAttribute('aria-hidden', 'true'); };
    modalHelp.addEventListener('click', (e) => { if (e.target === modalHelp) $('#closeHelp').click(); });

    // Baixar HTML
    function downloadSelf() {
      try {
        const clone = document.documentElement.cloneNode(true);
        const html = '<!doctype html>\n' + clone.outerHTML;
        const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'HUB-UNO-Revo.html'; a.click(); setTimeout(() => URL.revokeObjectURL(a.href), 500);
        toast('HTML exportado', 'ok');
      } catch (e) { alert('Falha ao exportar: ' + e.message); }
    }
    $('#btnDownload').onclick = downloadSelf;

    /* ===================== Brain ===================== */
    const MODELS = ['openrouter/auto','anthropic/claude-3.5-sonnet','openai/gpt-4.1-mini','google/gemini-1.5-pro','meta/llama-3.1-405b-instruct','mistral/mistral-large-latest'];
    (function initBrain() {
      const sel = $('#model'); sel.innerHTML = ''; MODELS.forEach(m => { const o = document.createElement('option'); o.value = m; o.textContent = m; sel.appendChild(o) });
      sel.value = LS.get('dual.openrouter.model', MODELS[0]);
      $('#sk').value = LS.raw('dual.keys.openrouter');
      $('#saveSK').onclick = () => { LS.set('dual.openrouter.model', sel.value); localStorage.setItem('dual.keys.openrouter', $('#sk').value || ''); toast('Configurações salvas', 'ok'); };
      $('#saveName').onclick = () => {
        localStorage.setItem('infodose:userName', ($('#userName').value || '').trim());
        // Toque som especial ao salvar o nome do usuário (Tech Pop)
        try { if (typeof window.playTechPopSound === 'function') window.playTechPopSound(); } catch {}
        // Mensagens de toast foram desativadas globalmente
        try { displayGreeting(); } catch (e) {}
        try { updateHomeStatus(); } catch {}
      };

      // Preencher campo de assistente com valor salvo
      const assistantInput = document.getElementById('assistantName');
      if (assistantInput) {
        assistantInput.value = (localStorage.getItem('infodose:assistantName') || '').trim();
      }
      // Salvar nome do assistente
      const btnAssistant = document.getElementById('saveAssistant');
      if (btnAssistant) {
        btnAssistant.onclick = () => {
          const nameVal = (assistantInput.value || '').trim();
          localStorage.setItem('infodose:assistantName', nameVal);
          try { if (typeof window.playTechPopSound === 'function') window.playTechPopSound(); } catch {}
        };
      }

      // Preencher lista de vozes para seleção global de fala
      const voiceSel = document.getElementById('selectVoice');
      function populateVoiceSel() {
        if (!voiceSel) return;
        voiceSel.innerHTML = '';
        let voices = speechSynthesis.getVoices();
        if (!voices || !voices.length) return;
        // Filtrar por idiomas suportados (Português e Inglês) se disponível
        const filtered = voices.filter(v => v.lang && (v.lang.toLowerCase().startsWith('pt') || v.lang.toLowerCase().startsWith('en')));
        voices = filtered.length ? filtered : voices;
        const savedVoice = localStorage.getItem('infodose:speechVoice') || '';
        voices.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v.name;
          opt.textContent = v.name + ' (' + v.lang + ')';
          if (savedVoice && savedVoice === v.name) opt.selected = true;
          voiceSel.appendChild(opt);
        });
      }
      if (voiceSel) {
        // Populate now and when voices change
        populateVoiceSel();
        speechSynthesis.onvoiceschanged = populateVoiceSel;
      }
      const btnVoice = document.getElementById('saveVoice');
      if (btnVoice && voiceSel) {
        btnVoice.onclick = () => {
          const val = voiceSel.value;
          localStorage.setItem('infodose:speechVoice', val || '');
          try { if (typeof window.playTechPopSound === 'function') window.playTechPopSound(); } catch {}
        };
      }

      // Permitir adicionar modelo personalizado
      const addBtn = $('#addModel');
      const customInput = $('#customModel');
      if (addBtn && customInput) {
        addBtn.onclick = () => {
          const val = (customInput.value || '').trim();
          if (!val) return;
          const opt = document.createElement('option');
          opt.value = val; opt.textContent = val;
          sel.appendChild(opt);
          sel.value = val;
          LS.set('dual.openrouter.model', val);
          customInput.value = '';
          toast('Modelo adicionado', 'ok');
        };
      }
      // Permitir carregamento de arquivo de treino
      const trainInp = $('#trainingFile');
      if (trainInp) {
        trainInp.addEventListener('change', (ev) => {
          const file = ev.target.files && ev.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            try {
              LS.set('dual.openrouter.training', { name: file.name, data: reader.result });
              toast('Treinamento carregado', 'ok');
            } catch (err) { console.error(err); toast('Erro ao carregar treino', 'err'); }
          };
          reader.readAsDataURL(file);
        });
      }
    })();

    /* ===================== Inicialização do tema & personalização de fundo ===================== */
    (function initThemeSettings() {
      // Se o usuário nunca selecionou um tema antes, defina o padrão como "medium" (cinza).
      if (!LS.get('uno:theme')) {
        LS.set('uno:theme','blue1');
      }
      // Aplique o tema salvo imediatamente
      applyTheme();
      // Configure o seletor de tema
      const sel = document.getElementById('themeSelect');
      if (sel) {
        sel.value = LS.get('uno:theme','blue1');
        sel.addEventListener('change', () => {
          LS.set('uno:theme', sel.value);
          applyTheme();
          toast('Tema atualizado', 'ok');
          try { updateHomeStatus(); } catch {}
        });
      }
      const upload = document.getElementById('bgUpload');
      if (upload) {
        upload.addEventListener('change', (e) => {
          const f = e.target.files && e.target.files[0];
          if (!f) return;
          const reader = new FileReader();
          reader.onload = () => {
            try {
              LS.set('uno:bg', reader.result);
              LS.set('uno:theme', 'custom');
              if (sel) sel.value = 'custom';
              applyTheme();
              toast('Fundo personalizado salvo', 'ok');
              try { updateHomeStatus(); } catch {}
            } catch (err) { console.error(err); toast('Erro ao salvar fundo', 'err'); }
          };
          reader.readAsDataURL(f);
        });
      }
    })();

    /* ===================== Ícones inline (data SVG) ===================== */
    function svgIcon(name){
      const common = 'xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%23f5f7ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"';
      const m = {
        atlas: `<svg ${common}><circle cx="12" cy="12" r="9"/><path d="M3 12h18M12 3v18"/><path d="M5 8c3 2 11 2 14 0M5 16c3-2 11-2 14 0"/></svg>`,
        nova: `<svg ${common}><path d="M12 2v4M12 18v4M2 12h4M18 12h4"/><path d="M5.6 5.6l2.8 2.8M15.6 15.6l2.8 2.8M18.4 5.6l-2.8 2.8M8.4 15.6l-2.8 2.8"/><circle cx="12" cy="12" r="3"/></svg>`,
        vitalis:`<svg ${common}><path d="M3 12h4l2-5 4 10 2-5h6"/><path d="M13 3l-2 4 3 1-2 4"/></svg>`,
        pulse: `<svg ${common}><path d="M2 12h3l2-4 3 8 2-4h8"/><path d="M20 8v-3M20 19v-3"/></svg>`,
        artemis:`<svg ${common}><path d="M3 12h12"/><path d="M13 6l6 6-6 6"/><circle cx="12" cy="12" r="9"/></svg>`,
        serena:`<svg ${common}><path d="M12 21s-6-3.5-6-8a4 4 0 0 1 6-3 4 4 0 0 1 6 3c0 4.5-6 8-6 8z"/></svg>`,
        kaos:  `<svg ${common}><path d="M4 4l7 7-7 7"/><path d="M20 4l-7 7 7 7"/></svg>`,
        genus: `<svg ${common}><rect x="7" y="7" width="10" height="10" rx="2"/><path d="M7 7l5-3 5 3M17 17l-5 3-5-3"/></svg>`,
        lumine:`<svg ${common}><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M2 12h2M20 12h2M4.9 4.9l1.4 1.4M17.7 17.7l1.4 1.4M4.9 19.1l1.4-1.4M17.7 6.3l1.4-1.4"/></svg>`,
        rhea:  `<svg ${common}><path d="M12 3v6"/><circle cx="12" cy="9" r="4"/><path d="M12 13v2l-2 2M12 15l2 2M12 17v3"/></svg>`,
        solus: `<svg ${common}><path d="M12 3v6M12 15v6"/><circle cx="12" cy="12" r="3"/><path d="M19 5l-3 3M5 19l3-3M5 5l3 3M19 19l-3-3"/></svg>`,
        aion:  `<svg ${common}><path d="M7 12c0-2.2 1.8-4 4-4 1.2 0 2.3.5 3 1.3M17 12c0 2.2-1.8 4-4 4-1.2 0-2.3-.5-3-1.3"/><path d="M3 12h4M17 12h4"/></svg>`,
        // Extra icons provided by the user. These are approximations of the requested
        // assets (e.g. audio.svg, bolt.svg, etc.) using simple line art. They
        // maintain the same stroke characteristics as the existing icons. To use
        // them elsewhere in the UI, call svgIcon('audio'), svgIcon('bolt'), etc.
        audio: `<svg ${common}><polygon points="3,9 8,9 12,5 12,19 8,15 3,15"/><path d="M15 9c1.5 1.5 1.5 4 0 5"/><path d="M17 7c3 3 3 7 0 10"/></svg>`,
        bolt: `<svg ${common}><path d="M13 3L4 14h7l-2 7 9-11h-7l3-7z"/></svg>`,
        download: `<svg ${common}><path d="M12 3v12"/><path d="M6 9l6 6 6-6"/><path d="M5 19h14"/></svg>`,
        grid: `<svg ${common}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>`,
        home: `<svg ${common}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2h-14a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
        json: `<svg ${common}><path d="M7 4c-2 0-2 2-2 4v8c0 2 0 4 2 4"/><path d="M17 4c2 0 2 2 2 4v8c0 2 0 4-2 4"/></svg>`,
        'logo-capsule': `<svg ${common}><rect x="4" y="7" width="16" height="10" rx="5"/><path d="M12 7v10"/></svg>`,
        'logo-seed-split': `<svg ${common}><path d="M12 12c0-4 4-8 8-8v8c0 4-4 8-8 8v-8z"/><path d="M12 12c0-4-4-8-8-8v8c0 4 4 8 8 8v-8z"/></svg>`,
        pause: `<svg ${common}><rect x="6" y="4" width="3" height="16"/><rect x="15" y="4" width="3" height="16"/></svg>`,
        play: `<svg ${common}><polygon points="6,4 20,12 6,20"/></svg>`,
        upload: `<svg ${common}><path d="M12 21V9"/><path d="M6 15l6-6 6 6"/><path d="M5 5h14"/></svg>`,
        user: `<svg ${common}><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 4-8 8-8s8 4 8 8"/></svg>`,
        sprites: `<svg ${common}></svg>`
      };
      const raw = m[name] || m['atlas'];
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(raw);
    }

    /* ===================== Apps (embutido + locais) ===================== */
    const RAW = { apps: [] };

    // Controle para exibir apenas apps locais ou todos
    let showOnlyLocal = false;
    // Lista de apps favoritados (por chave). Carregada do localStorage
    let favoriteKeys = [];
    try { favoriteKeys = JSON.parse(localStorage.getItem('infodose:favApps') || '[]') || []; } catch { favoriteKeys = []; }

    /**
     * Alterna um app na lista de favoritos. Salva no localStorage e re-renderiza.
     * @param {string} key
     */
    function toggleFav(key) {
      const idx = favoriteKeys.indexOf(key);
      if (idx >= 0) {
        favoriteKeys.splice(idx, 1);
      } else {
        favoriteKeys.push(key);
      }
      localStorage.setItem('infodose:favApps', JSON.stringify(favoriteKeys));
      renderApps();
    }
    /** Verifica se um app está favoritado. */
    function isFav(key) {
      return favoriteKeys.includes(key);
    }
    const appsWrap = $('#appsWrap'), appsCount = $('#appsCount');

    function normalize(list) {
      return (list || []).map(x => ({
        key: x.key || x.url || x.title || Math.random().toString(36).slice(2),
        title: x.title || x.key || 'App',
        desc: x.desc || '',
        url: String(x.url || ''),
        icon: x.icon || '',
        tags: Array.isArray(x.tags) ? x.tags : []
      }))
    }
    function locals() {
      let arr = []; try { arr = JSON.parse(LS.raw('infodose:locals:v1') || '[]') } catch {}
      return arr.map(l => ({ key: 'local:' + l.id, title: l.name || 'Local', desc: 'HTML local', url: 'local:' + l.id, icon: 'local', tags: ['local'] }))
    }
    function getLocal(id) {
      let arr = []; try { arr = JSON.parse(LS.raw('infodose:locals:v1') || '[]') } catch {}
      return arr.find(x => x.id === id) || null
    }
    function blobURL(local) { const blob = new Blob([local.html || ''], { type: 'text/html;charset=utf-8' }); return URL.createObjectURL(blob) }

    /**
     * Atualiza os cartões de status na Home com informações atuais sobre apps, sessões,
     * preferências do usuário e arquétipo ativo. Chamado sempre que o
     * catálogo muda, quando sessões são abertas/fechadas, quando
     * configurações são salvas ou ao navegar para o Home.
     */
    function updateHomeStatus() {
      try {
        // Apps: número total ou locais se estiver filtrando
        const total = normalize(RAW.apps).concat(locals()).length;
        const localCount = locals().length;
        const txtApps = showOnlyLocal ? (localCount + ' local' + (localCount === 1 ? '' : 's')) : (total + ' app' + (total === 1 ? '' : 's'));
        const elApps = document.getElementById('homeAppsStatus');
        if (elApps) elApps.textContent = txtApps;
      } catch (e) {}
      try {
        // Sessões abertas (Stack)
        const sess = document.querySelectorAll('#stackWrap .session').length;
        const txtSess = sess + ' sessão' + (sess === 1 ? '' : 's');
        const elStack = document.getElementById('homeStackStatus');
        if (elStack) elStack.textContent = txtSess;
      } catch (e) {}
      try {
        // Usuário: nome + tema atual (mapa)
        const name = (localStorage.getItem('infodose:userName') || '').trim();
        const theme = LS.get('uno:theme','blue1');
        const themeLabel = { 'default': 'padrão', 'medium': 'cinza', 'custom': 'personalizado' }[theme] || theme;
        let txtUser = name || 'Usuário';
        txtUser += ' · ' + themeLabel;
        const elUser = document.getElementById('homeUserStatus');
        if (elUser) elUser.textContent = txtUser;
      } catch (e) {}
      try {
        // Arquétipo ativo: obtém o nome sem extensão
        const sel = document.getElementById('arch-select');
        let archName = '';
        if (sel && sel.options.length > 0) {
          const opt = sel.options[sel.selectedIndex] || null;
          if (opt) archName = opt.textContent.replace(/\.html$/i, '');
        }
        const elArch = document.getElementById('homeArchStatus');
        if (elArch) elArch.textContent = archName || 'Nenhum';
      } catch (e) {}
    }

    function appIconFor(a){
      if(!a.icon) return svgIcon('atlas');
      if(/^(atlas|nova|vitalis|pulse|artemis|serena|kaos|genus|lumine|rhea|solus|aion|local)$/.test(a.icon)) return svgIcon(a.icon);
      return a.icon; // caminho externo
    }

    function cardApp(a) {
      const el = document.createElement('div'); el.className = 'app-card fx-trans fx-lift';
      // Botão de favorito (estrela). Aparece no canto superior direito
      const fav = document.createElement('button'); fav.className = 'fav-btn';
      const favImg = document.createElement('img');
      favImg.alt = 'Favorito';
      // Use ícone local para favorito; evita depender de CDN
      favImg.src = 'icons/star.svg';
      fav.appendChild(favImg);
      // Marque como favoritado se a chave estiver na lista
      if (isFav(a.key)) fav.classList.add('fav');
      fav.onclick = (e) => { e.stopPropagation(); toggleFav(a.key); };
      el.appendChild(fav);
      const ic = document.createElement('div'); ic.className = 'app-icon';
      const iconDiv = document.createElement('div');iconDiv.className = 'icon barapps ' + (String(a.icon||a.key||'atlas')).toLowerCase(); iconDiv.classList.add('gradient-default');try {  if(!/^(atlas|nova|vitalis|pulse|artemis|serena|kaos|genus|lumine|rhea|solus|aion|local)$/.test(String(a.icon||'').toLowerCase())){    const src = appIconFor(a);    iconDiv.style.webkitMaskImage = 'url(' + src + ')';    iconDiv.style.maskImage = 'url(' + src + ')';  }} catch(e) {}ic.appendChild(iconDiv);const meta = document.createElement('div'); meta.style.flex = '1';
      // Truncar o título para exibir apenas as três primeiras palavras; adicionar reticências quando houver mais.
      const fullTitle = String(a.title || a.key || '').trim();
      const t = document.createElement('div'); t.className = 'app-title';
(function(){
  const isLocal = String(a.key||'').startsWith('local:') || String(a.url||'').startsWith('local:') || (Array.isArray(a.tags)&&a.tags.includes('local'));
  let safe = fullTitle;
  if (isLocal) { const CAP=80; if (safe.length > CAP) safe = safe.slice(0, CAP-1) + '…'; }
  t.textContent = safe;
})();
t.title = fullTitle;
const d = document.createElement('div'); d.className = 'mut'; d.textContent = a.desc || a.url;
      const open = document.createElement('button'); open.className = 'btn fx-trans fx-press ring'; open.textContent = 'Abrir';
      const rip = document.createElement('span'); rip.className = 'ripple'; open.appendChild(rip); addRipple(open);
      open.onclick = () => openApp(a);
      meta.appendChild(t); meta.appendChild(d); meta.appendChild(open);
      el.appendChild(ic); el.appendChild(meta);
      return el
    }

    function renderApps() {
      // Busque valores de busca e ordenação apenas se os campos existirem (evita erros se ocultos)
      const searchEl = document.getElementById('appSearch');
      const sortEl = document.getElementById('appSort');
      const q = searchEl ? (searchEl.value || '').toLowerCase() : '';
      const mode = sortEl ? sortEl.value : 'az';
      // Combine apps embutidos e locais
      let L = normalize(RAW.apps).concat(locals());
      // Filtrar apenas locais se ativado
      if (showOnlyLocal) {
        L = L.filter(a => String(a.url || '').startsWith('local:'));
      }
      // Aplicar busca (mantendo compatibilidade se o usuário ainda possuir o campo)
      if (q) {
        L = L.filter(a => (a.title + ' ' + a.desc + ' ' + a.key + ' ' + a.url + ' ' + (a.tags || []).join(' ')).toLowerCase().includes(q));
      }
      // Ordenar: favoritos primeiro, depois título A-Z ou Z-A conforme o select (padrão A-Z)
      L.sort((a, b) => {
        const favA = isFav(a.key); const favB = isFav(b.key);
        if (favA !== favB) return favB - favA; // true=1, false=0 => favoritos no topo
        const dir = mode === 'za' ? -1 : 1;
        return dir * String(a.title || '').localeCompare(b.title || '');
      });
      // Organize os apps por grupo (arquetipo).  Considera-se o nome
      // após o ponto "·" no título como o nome do grupo.  Se não houver,
      // coloca em "Outros".
      const grouped = {};
      L.forEach(a => {
        let gName = '';
        if (a.title && a.title.includes('·')) {
          const parts = a.title.split('·');
          gName = (parts[1] || '').trim();
        }
        if (!gName) gName = 'Outros';
        if (!grouped[gName]) grouped[gName] = [];
        grouped[gName].push(a);
      });
      // Limpar o container
      appsWrap.innerHTML = '';
      // Ordenar grupos alfabeticamente para exibir em ordem consistente
      const groupNames = Object.keys(grouped).sort((a,b) => a.localeCompare(b));
      let total = 0;
      groupNames.forEach(gName => {
        const container = document.createElement('div');
        container.className = 'apps-group';
        const header = document.createElement('h3');
        header.textContent = gName;
        header.style.margin = '16px 4px 8px';
        header.style.fontSize = '15px';
        header.style.fontWeight = '800';
        header.style.color = 'var(--mut)';
        const grid = document.createElement('div');
        grid.className = 'grid';
        grouped[gName].forEach(app => {
          const card = cardApp(app);
          grid.appendChild(card);
          total++;
        });
        container.appendChild(header);
        container.appendChild(grid);
        appsWrap.appendChild(container);
      });
      appsCount.textContent = total + ' apps';
      // Reaplicar ícones após adicionar novos cards (garante que as estrelas e ícones de apps carreguem)
      try { applyIcons(); } catch {}
      // Notifique o Revo de que os apps mudaram, se estiver ativo
      maybeSendAppsToRevo();
      // Atualize o painel de status na home com o novo número de apps
      try { updateHomeStatus(); } catch {}
    }

    (function loadEmbeddedApps(){
      try {
        const raw = JSON.parse($('#APPS_JSON').textContent || '{}');
        RAW.apps = Array.isArray(raw.apps) ? raw.apps : (Array.isArray(raw) ? raw : []);
      } catch { RAW.apps = [] }
      renderApps();
      // Após renderizar os apps, crie grupos padrão no Stack para cada
      // arquetipo, se ainda não existirem.  Isso permite que as sessões
      // abertas sejam automaticamente organizadas por grupo.
      try { ensureDefaultGroups(); } catch (e) { console.warn('Falha ao criar grupos padrão', e); }
      // Sempre envie o catálogo atualizado ao iframe do Revo após carregar os apps embutidos.
      try {
        const iframe = document.getElementById('revoEmbed');
        if (iframe) {
          const apps = RAW && Array.isArray(RAW.apps) ? RAW.apps : [];
          const send = () => { if (iframe.contentWindow) iframe.contentWindow.postMessage({ type: 'apps', apps }, '*'); };
          // Envie após pequeno atraso para garantir que o iframe esteja pronto
          setTimeout(send, 100);
          // E também quando o iframe terminar de carregar
          iframe.removeEventListener('load', iframe._sendAppsEmbedded);
          iframe._sendAppsEmbedded = send;
          iframe.addEventListener('load', send, { once: true });
        }
      } catch(e) { console.warn('Falha ao postMessage apps após embed:', e); }
    })();

    // Locais
    $('#btnImport').onclick = async () => {
      const fs = Array.from($('#fileLocal').files || []);
      if (!fs.length) return;
      const tasks = fs.map(f => new Promise(res => {
        const r = new FileReader();
        r.onload = () => {
          const content = String(r.result || '');
          // Se for um arquivo JSON, tente carregá-lo como catálogo de apps
          if (/\.json$/i.test(f.name)) {
            try {
              const obj = JSON.parse(content);
              const apps = Array.isArray(obj.apps) ? obj.apps : (Array.isArray(obj) ? obj : []);
              // Substitua o catálogo embutido pelo JSON local e recarregue a lista
              RAW.apps = apps;
              renderApps();
              toast('apps.json local carregado', 'ok');
            } catch (err) {
              console.error(err);
              toast('Erro ao ler apps.json', 'err');
            }
            // Não adicionar JSON à lista de locais; retorne null
            res(null);
          } else {
            // Trate como HTML local
            res({ id: 'l_' + Math.random().toString(36).slice(2), name: f.name.replace(/\.(html?|txt)$/i, ''), html: content, ts: Date.now() });
          }
        };
        r.readAsText(f);
      }));
      const list = (await Promise.all(tasks)).filter(Boolean);
      const cur = JSON.parse(LS.raw('infodose:locals:v1') || '[]');
      list.forEach(x => cur.unshift(x));
      localStorage.setItem('infodose:locals:v1', JSON.stringify(cur));
      renderApps();
      if (list.length) toast('HTMLs locais adicionados', 'ok');
    };
    $('#btnExport').onclick = () => { const data = { v: 1, when: Date.now(), items: JSON.parse(LS.raw('infodose:locals:v1') || '[]') }; const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })); a.download = 'locals_pack.json'; a.click(); };
    $('#btnClear').onclick = () => { if (confirm('Limpar HTMLs locais salvos?')) { localStorage.removeItem('infodose:locals:v1'); renderApps(); toast('Locais limpos', 'warn'); } };

    // Alterna exibição de apps locais/apenas locais
    try {
      const btnToggleLocal = document.getElementById('btnToggleLocal');
      if (btnToggleLocal) {
        btnToggleLocal.onclick = () => {
          showOnlyLocal = !showOnlyLocal;
          // Atualize o texto do botão conforme o modo
          btnToggleLocal.firstChild && (btnToggleLocal.firstChild.nodeValue = showOnlyLocal ? 'Mostrar Todos' : 'Mostrar Locais');
          renderApps();
        };
      }
    } catch (e) { console.warn('Falha ao associar btnToggleLocal:', e); }

    /* ===================== Stack ===================== */
    const stackWrap = $('#stackWrap'), dock = $('#dock');
    function badge(item) { const b = document.createElement('button'); b.className = 'badge fx-trans fx-press ring'; b.textContent = item.title || 'App'; b.title = 'Reabrir ' + (item.title || 'App'); const rp = document.createElement('span'); rp.className = 'ripple'; b.appendChild(rp); addRipple(b); b.onclick = () => { const s = document.querySelector('[data-sid="' + item.sid + '"]'); if (s) { s.scrollIntoView({ behavior: 'smooth' }); s.classList.remove('min'); } }; return b }
    function updateDock() {
      dock.innerHTML = '';
      $$('.session').forEach(s => {
        const meta = JSON.parse(s.dataset.meta || '{}');
        dock.appendChild(badge({ title: "", sid: s.dataset.sid }))
      });
      // Atualize o status de sessões na home
      try { updateHomeStatus(); } catch {}
    }
    function openApp(a) {
      // Permite receber um SID externo (para restaurar sessões) ou gera um novo se ausente
      const sid = a.sid || ('s_' + Math.random().toString(36).slice(2));
      const isLocal = String(a.url || '').startsWith('local:'); const lr = isLocal ? getLocal(String(a.url).slice(6)) : null; const url = lr ? blobURL(lr) : a.url;
      const card = document.createElement('div'); card.className = 'session fx-trans fx-lift';
      card.dataset.sid = sid;
      // Armazene metadados de título/url no dataset.meta para persistência
      card.dataset.meta = JSON.stringify({ title: a.title || 'App', url: a.url || '' });
      // Se nenhum grupo foi fornecido, tente atribuir com base no nome após o ponto no título (ex.: "Atlas · Cartesius").
      if (!a.gid && a.title && a.title.includes('·')) {
        const parts = a.title.split('·');
        const gName = (parts[1] || '').trim();
        if (gName) {
          a.gid = 'g_' + gName.toLowerCase().replace(/\s+/g, '_');
        }
      }
      // Se um grupo específico foi fornecido, salve no dataset.gid para persistência
      if (a.gid) card.dataset.gid = a.gid;
      card.innerHTML = `
        <div class="hdr">
          <div class="title"><span class="app-icon">${((a.title || 'App')[0] || 'A')}</span>${(a.title || 'App')}</div>
          <div class="tools">
            <button class="btn ring fx-trans fx-press" data-act="min" title="Minimizar">
              <span style="font-size:16px;line-height:1">&minus;</span>
              <span class="ripple"></span>
            </button>
            <button class="btn ring fx-trans fx-press" data-act="ref" title="Recarregar">
              <span style="font-size:16px;line-height:1">&#8635;</span>
              <span class="ripple"></span>
            </button>
            <button class="btn ring fx-trans fx-press" data-act="full" title="Tela cheia">
              <span style="font-size:16px;line-height:1">⤢</span>
              <span class="ripple"></span>
            </button>
            <!-- Botão para fixar/desafixar na navegação -->
            <button class="btn ring fx-trans fx-press" data-act="pin" title="Fixar na barra">
              <span class="pin-icon" style="font-size:16px;line-height:1">☆</span>
              <span class="ripple"></span>
            </button>
            <!-- Botão para mover entre grupos -->
            <button class="btn ring fx-trans fx-press" data-act="move" title="Mover sessão">
              <span style="font-size:16px;line-height:1">⇄</span>
              <span class="ripple"></span>
            </button>
            <button class="btn ring fx-trans fx-press" data-act="close" title="Fechar">
              <span style="font-size:16px;line-height:1">&times;</span>
              <span class="ripple"></span>
            </button>
          </div>
        </div>
        <iframe src="${url || 'about:blank'}" allow="autoplay; clipboard-read; clipboard-write; picture-in-picture; fullscreen"></iframe>
        <div class="resize-handle" title="Arraste para ajustar a altura"></div>`;
      // Redimensionar altura do iframe arrastando o handle
      (function bindResize(){
        const handle = card.querySelector('.resize-handle');
        const iframe = card.querySelector('iframe');
        if(!handle || !iframe) return;
        let startY = 0, startH = 0, dragging = false;
        handle.addEventListener('pointerdown', (ev) => {
          dragging = true;
          startY = ev.clientY;
          startH = iframe.clientHeight;
          handle.setPointerCapture(ev.pointerId);
        });
        handle.addEventListener('pointermove', (ev) => {
          if(!dragging) return;
          const dy = ev.clientY - startY;
          const h = Math.max(120, startH + dy);
          iframe.style.height = h + 'px';
        });
        const stop = () => { dragging = false; };
        handle.addEventListener('pointerup', stop);
        handle.addEventListener('pointercancel', stop);
      })();
      // Prepend the session card dependendo do modo de abertura. Se "abrir dentro" estiver marcado,
      // insira a sessão no topo da página (sessionsAnchor); caso contrário, use o stackWrap padrão.
      const anchor = document.getElementById('sessionsAnchor');
      if ($('#openInside').checked && anchor) {
        anchor.prepend(card);
      } else {
        // Se houver um grupo selecionado, adicione a sessão dentro desse grupo; caso contrário, insira no stackWrap
        // Escolha o grupo de destino: se houver um grupo selecionado manualmente
        // use-o; caso contrário, utilize o grupo inferido do título (a.gid).
        const gid = window.currentGroupId || a.gid;
        let placed = false;
        if (gid) {
          const grp = stackWrap && stackWrap.querySelector('.stack-group[data-group-id="' + gid + '"] .group-content');
          if (grp) {
            grp.prepend(card);
            card.dataset.gid = gid;
            placed = true;
          }
        }
        if (!placed) {
          stackWrap.prepend(card);
          // Remova qualquer associação de grupo se a sessão não estiver atribuída
          delete card.dataset.gid;
        }
      }
      // Não chamar applyIcons aqui: ícones embutidos manualmente nos botões de sessão
      card.querySelector('[data-act=min]').onclick = () => {
        card.classList.toggle('min');
        updateDock();
        saveStackState();
        dualLog('Sessão minimizada: ' + (a.title || 'App'));
      };
      card.querySelector('[data-act=ref]').onclick = () => { const fr = card.querySelector('iframe'); try { fr.contentWindow.location.reload() } catch { fr.src = fr.src } };
      card.querySelector('[data-act=close]').onclick = () => {
        // Se a sessão estiver fixada, remova-a também da lista de fixados
        if (card.classList.contains('pinned')) {
          removePinnedByMeta(JSON.parse(card.dataset.meta || '{}'));
        }
        card.remove();
        updateDock();
        saveStackState();
        dualLog('Sessão fechada: ' + (a.title || 'App'));
        // Toque som de fechamento de sessão
        try { playCloseSound(); } catch {}
      };
      // Botão tela cheia
      const fullBtn = card.querySelector('[data-act=full]');
      if (fullBtn) {
        fullBtn.onclick = () => {
          card.classList.toggle('full');
          document.body.classList.toggle('session-full');
        };
      }
      // Botão fixar/desafixar
      const pinBtn = card.querySelector('[data-act=pin]');
      if (pinBtn) {
        // Inicialize o estado do botão conforme o dado de entrada
        const meta = JSON.parse(card.dataset.meta || '{}');
        if (a.pinned) {
          card.classList.add('pinned');
          pinBtn.querySelector('.pin-icon').textContent = '★';
        }
        pinBtn.onclick = () => {
          const meta = JSON.parse(card.dataset.meta || '{}');
          if (card.classList.contains('pinned')) {
            // Desafixar
            card.classList.remove('pinned');
            pinBtn.querySelector('.pin-icon').textContent = '☆';
            removePinnedByMeta(meta);
            // Não exiba toast ao desafixar
          } else {
            // Fixar
            card.classList.add('pinned');
            pinBtn.querySelector('.pin-icon').textContent = '★';
            addPinned(meta);
            // Não exiba toast ao fixar
          }
        };
      }
      // Botão mover sessão entre grupos
      const moveBtn = card.querySelector('[data-act=move]');
      if (moveBtn) {
        moveBtn.onclick = () => {
          // Liste os grupos disponíveis com seus nomes
          const groups = Array.from(document.querySelectorAll('#stackWrap .stack-group'));
          if (!groups.length) {
            // Sem grupos: simplesmente remova do grupo atual, se houver
            delete card.dataset.gid;
            stackWrap.prepend(card);
            saveStackState();
            // Não exiba toast ao mover para a raiz
            return;
          }
          const names = groups.map(g => g.querySelector('summary')?.textContent || '').filter(n => n);
          const choices = names.map((n,i) => `${i+1}. ${n}`).join('\n');
          const ans = prompt('Mover para qual grupo?\n' + choices + '\n0. Sem grupo');
          if (ans === null) return;
          const idx = parseInt(ans.trim(), 10);
          if (!isNaN(idx) && idx >= 1 && idx <= groups.length) {
            const targetGroup = groups[idx-1];
            const content = targetGroup.querySelector('.group-content');
            if (content) {
              content.prepend(card);
              card.dataset.gid = targetGroup.getAttribute('data-group-id') || '';
              updateDock();
              saveStackState();
              // Não exiba toast ao mover para um grupo específico
              return;
            }
          }
          // Se o usuário digitou 0 ou algo não válido, mova para a raiz
          delete card.dataset.gid;
          stackWrap.prepend(card);
          updateDock();
          saveStackState();
          // Não exiba toast ao mover para a raiz
        };
      }
      // Não navegue automaticamente para a view Stack na versão estendida.
      // if (!$('#openInside').checked) nav('stack');
      updateDock();
      // Após abrir uma sessão, persista o estado (grupos, sessões e fixados)
      saveStackState();
      // Não exiba toast ao abrir uma nova sessão
      dualLog('Sessão aberta: ' + (a.title || 'App'));
      // Toque som de abertura de app, se definido
      try { playOpenSound(); } catch {}
    }
    $('#btnCloseAll').onclick = () => {
      if (!confirm('Fechar todas as sessões abertas?')) return;
      $$('.session').forEach(s => s.remove());
      updateDock();
      try { saveStackState(); } catch {}
      toast('Todas as sessões fechadas', 'warn');
    };

    /* ===================== Archetypes (Central Circle) ===================== */
    (function () {
      const archList = [
        'atlas.html',
        'nova.html',
        'vitalis.html',
        'pulse.html',
        'artemis.html',
        'serena.html',
        'kaos.html',
        'genus.html',
        'lumine.html',
        'solus.html',
        'rhea.html',
        'aion.html'
      ];
      const select = document.getElementById('arch-select');
      const frame = document.getElementById('arch-frame');
      const fade = document.getElementById('arch-fadeCover');

      // Mapeamento de cores/gradientes por arquétipo.  Cada chave
      // corresponde ao nome do arquivo sem a extensão .html e define
      // um valor CSS (cor sólida ou gradiente) com opacidade baixa
      // para aplicar como overlay.  Ajuste as cores conforme o
      // significado simbólico de cada arquétipo.
      const ARCH_OVERLAYS = {
        atlas: 'rgba(64, 158, 255, 0.22)',
        nova: 'rgba(255, 82, 177, 0.22)',
        vitalis: 'rgba(72, 218, 168, 0.22)',
        pulse: 'rgba(255, 99, 132, 0.22)',
        artemis: 'rgba(186, 130, 219, 0.22)',
        serena: 'rgba(140, 190, 255, 0.22)',
        kaos: 'rgba(255, 77, 109, 0.22)',
        genus: 'rgba(87, 207, 112, 0.22)',
        lumine: 'rgba(255, 213, 79, 0.22)',
        rhea: 'rgba(0, 209, 178, 0.22)',
        solus: 'rgba(100, 149, 237, 0.22)',
        aion: 'rgba(255, 159, 67, 0.22)',
        default: 'rgba(255,255,255,0.0)'
      };

      // Aplica a cor/gradiente de overlay correspondente ao arquétipo
      function applyArchOverlay(name) {
        const key = (name || '').toLowerCase();
        const color = ARCH_OVERLAYS[key] || ARCH_OVERLAYS.default;
        document.documentElement.style.setProperty('--arch-overlay', color);
      }
      function populate() {
        select.innerHTML = '';
        archList.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          select.appendChild(opt);
        });
      }
      function setSrcByIndex(idx) {
        if (!archList.length) return;
        const n = (idx + archList.length) % archList.length;
        select.selectedIndex = n;
        const file = archList[n];
        frame.src = './archetypes/' + file;
        // Pronuncia o nome do arquétipo sempre que for selecionado
        try {
          const base = file.replace(/\.html$/i, '');
          speakArchetype(base);
        } catch (e) {}
        // Atualiza as informações da Home (cartões) quando o arquétipo muda
        try {
          updateHomeStatus();
        } catch (e) {}

        // Ajusta o overlay de cor para o arquétipo selecionado
        try {
          const base = file.replace(/\.html$/i, '');
          applyArchOverlay(base);
        } catch (e) {}
      }
      let current = 0;
      populate();
      if (archList.length) setSrcByIndex(0);
      document.getElementById('arch-prev').addEventListener('click', () => {
        current = (current - 1 + archList.length) % archList.length;
        fade.classList.add('show');
        setTimeout(() => {
          setSrcByIndex(current);
          setTimeout(() => fade.classList.remove('show'), 200);
        }, 140);
      });
      document.getElementById('arch-next').addEventListener('click', () => {
        current = (current + 1) % archList.length;
        fade.classList.add('show');
        setTimeout(() => {
          setSrcByIndex(current);
          setTimeout(() => fade.classList.remove('show'), 200);
        }, 140);
      });
      select.addEventListener('change', () => {
        current = select.selectedIndex;
        fade.classList.add('show');
        setTimeout(() => {
          setSrcByIndex(current);
          setTimeout(() => fade.classList.remove('show'), 200);
        }, 140);
      });
    })();

    /* ===================== Custom CSS & Voices: Event Handlers ===================== */
    // Aplicar CSS personalizado salvo no carregamento inicial
    try { applyCSS(); } catch (e) {}
    // Inicializar vozes na aba Brain
    try { initVoices(); } catch (e) {}
    // Inicializar ripple de áudio (modo que responde ao microfone)
    try { initAudioRipple(); } catch (e) {}
    // Exibir saudação inicial se aplicável
    try { welcome(); } catch (e) {}
    // Conectar botões de CSS personalizado
    const btnApplyCSS = document.getElementById('applyCSS');
    const btnClearCSS = document.getElementById('clearCSS');
    const btnDownloadCSS = document.getElementById('downloadCSS');
    if (btnApplyCSS) {
      btnApplyCSS.addEventListener('click', () => {
        const textarea = document.getElementById('cssCustom');
        const css = (textarea && textarea.value || '').trim();
        localStorage.setItem('infodose:cssCustom', css);
        applyCSS();
        toast('CSS aplicado', 'ok');
      });
    }
    if (btnClearCSS) {
      btnClearCSS.addEventListener('click', () => {
        localStorage.removeItem('infodose:cssCustom');
        const textarea = document.getElementById('cssCustom');
        if (textarea) textarea.value = '';
        applyCSS();
        toast('CSS removido', 'warn');
      });
    }
    if (btnDownloadCSS) {
      btnDownloadCSS.addEventListener('click', () => {
        const css = localStorage.getItem('infodose:cssCustom') || '';
        const blob = new Blob([css], { type: 'text/css' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'custom.css';
        a.click();
        setTimeout(() => URL.revokeObjectURL(a.href), 500);
      });
    }

    /* ===================== Init ===================== */
    // Inicialize preferências de performance e voz e associe botões no Brain
    (function initDualPrefs(){
      const perfSel = document.getElementById('selPerf');
      const voiceSel = document.getElementById('selVoice');
      if (perfSel) perfSel.value = dualState.perf;
      if (voiceSel) voiceSel.value = dualState.voice;
      const perfBtn = document.getElementById('btnPerf');
      const voiceBtn = document.getElementById('btnVoice');
      if (perfBtn && perfSel) {
        perfBtn.addEventListener('click', () => {
          dualState.perf = perfSel.value;
          localStorage.setItem('hub.perf', dualState.perf);
          dualLog('Performance atualizada: ' + dualState.perf);
          toast('Performance atualizada', 'ok');
        });
      }
      if (voiceBtn && voiceSel) {
        voiceBtn.addEventListener('click', () => {
          dualState.voice = voiceSel.value;
          localStorage.setItem('hub.voice', dualState.voice);
          dualLog('Voz selecionada: ' + dualState.voice);
          toast('Voz atualizada', 'ok');
        });
      }
    })();
    $$('button').forEach(addRipple);
  </script><div style="position: fixed; right: 14px; bottom: calc(var(--tabsH) + 16px); display: grid; gap: 8px; z-index: 120;"></div>
<!-- Local Storage Modal (safe-placed near end of body) -->
<!-- Script para ocultar o splash screen após o carregamento completo da página -->
<!-- Script adicional para o Stacks estendido: upload de HTML e criação de grupos -->
<script>
(() => {
  const uploadBtn = document.getElementById('btnStackUpload');
  const uploadInput = document.getElementById('stackUpload');
  if (uploadBtn && uploadInput) {
    uploadBtn.addEventListener('click', () => uploadInput.click());
    uploadInput.addEventListener('change', (ev) => {
      const file = ev.target.files && ev.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const content = String(reader.result || '');
        const blob = new Blob([content], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        openApp({ title: file.name.replace(/\.(html?|txt)$/i,''), url });
      };
      reader.readAsText(file);
      // Permite escolher o mesmo arquivo novamente
      ev.target.value = '';
    });
  }
  const btnAddGroup = document.getElementById('btnAddGroup');
  const stackWrapEl = document.getElementById('stackWrap');
  window.currentGroupId = null;
  if (btnAddGroup && stackWrapEl) {
      btnAddGroup.addEventListener('click', () => {
      const name = prompt('Nome do grupo:');
      if (!name) return;
      const gid = 'g_' + Math.random().toString(36).slice(2);
      const details = document.createElement('details');
      details.className = 'stack-group';
      details.setAttribute('data-group-id', gid);
      details.open = true;
      const summary = document.createElement('summary');
      summary.textContent = name;
      const content = document.createElement('div');
      content.className = 'group-content';
      details.appendChild(summary);
      details.appendChild(content);
      stackWrapEl.prepend(details);
      window.currentGroupId = gid;
      // Salve o estado após criar um novo grupo
      try { saveStackState(); } catch {}
    });
  }
})();
</script>
<script>
window.addEventListener('load', () => {
  const splash = document.getElementById('appSplash');
  if (!splash) return;
  // Reproduza o som do splash assim que a página carregar, se houver um elemento de áudio.
  const audioElem = document.getElementById('splashSound');
  if (audioElem) {
    try {
      audioElem.currentTime = 0;
      audioElem.play().catch(() => {
        /* Alguns navegadores bloqueiam a reprodução automática.  Ignore erros aqui. */
      });
    } catch (err) {}
  }
  // Fale durante o splash usando a síntese de voz
  try {
    if (typeof speakSplash === 'function') speakSplash();
  } catch {}
  // Em seguida, faça a saudação completa alguns instantes depois do splash
  try {
    if (typeof speakHomeGreeting === 'function') setTimeout(() => speakHomeGreeting(), 400);
  } catch {}
  // Aguarde um breve instante após o carregamento para garantir que o loader seja exibido.
  // Aumente este valor (ms) para manter o splash por mais tempo. Aqui usamos 1200ms (1.2s).
  setTimeout(() => {
    splash.classList.add('hidden');
    // Remova o elemento do DOM após a transição de opacidade
    setTimeout(() => {
      if (splash && splash.parentNode) splash.parentNode.removeChild(splash);
    }, 400);
  }, 1200);
});
</script>
<!-- Script para persistência de grupos/sessões e apps fixados na navegação -->
<script>
(() => {
  /**
   * Cria um grupo de stack com id e nome fornecidos. Usado ao restaurar grupos.
   * @param {string} gid
   * @param {string} name
   */
  function createStackGroup(gid, name) {
    const stackWrapEl = document.getElementById('stackWrap');
    if (!stackWrapEl) return;
    const details = document.createElement('details');
    details.className = 'stack-group';
    details.setAttribute('data-group-id', gid);
    details.open = true;
    const summary = document.createElement('summary');
    summary.textContent = name;
    const content = document.createElement('div');
    content.className = 'group-content';
    details.appendChild(summary);
    details.appendChild(content);
    stackWrapEl.prepend(details);
  }

  /**
   * Salva a estrutura de grupos e sessões no LocalStorage.
   */
  function saveStackState() {
    try {
      // Salve grupos
      const groups = [];
      document.querySelectorAll('#stackWrap .stack-group').forEach(g => {
        const id = g.getAttribute('data-group-id');
        const name = g.querySelector('summary')?.textContent || '';
        if (id && name) groups.push({ id, name });
      });
      localStorage.setItem('unoStackGroups', JSON.stringify(groups));
      // Salve sessões (Stack e sessionsAnchor)
      const sess = [];
      document.querySelectorAll('#stackWrap .session, #sessionsAnchor .session').forEach(card => {
        const sid = card.dataset.sid;
        const meta = card.dataset.meta;
        const gid = card.dataset.gid || null;
        const min = card.classList.contains('min');
        const pinned = card.classList.contains('pinned');
        if (sid && meta) sess.push({ sid, meta, gid, min, pinned });
      });
      localStorage.setItem('unoStackSessions', JSON.stringify(sess));
    } catch (e) {
      console.warn('Erro ao salvar estado do stack', e);
    }
    // Salve apps fixados (o array já está armazenado em unoPinnedApps via add/remove)
  }
  window.saveStackState = saveStackState;

  /**
   * Garante que existam grupos de stack correspondentes a cada categoria de apps
   * (arquetipos).  Obtém os nomes de grupo da variável RAW.apps e cria
   * grupos com IDs fixos baseados no nome.  Se um grupo já existir, não o
   * duplica.  Use para organizar sessões automaticamente por arquetipo.
   */
  function ensureDefaultGroups() {
    try {
      const stackWrapEl = document.getElementById('stackWrap');
      if (!stackWrapEl) return;
      // Obtenha lista de nomes de grupos a partir dos apps embutidos
      const names = {};
      (RAW.apps || []).forEach(a => {
        if (a && a.title && a.title.includes('·')) {
          const parts = a.title.split('·');
          const gName = (parts[1] || '').trim();
          if (gName) names[gName] = true;
        }
      });
      // Para cada nome, crie grupo se não existir
      Object.keys(names).forEach(name => {
        const gid = 'g_' + name.toLowerCase().replace(/\s+/g, '_');
        if (!document.querySelector('#stackWrap .stack-group[data-group-id="' + gid + '"]')) {
          createStackGroup(gid, name);
        }
      });
    } catch (e) {
      console.warn('Falha ao garantir grupos padrão', e);
    }
  }
  // Exponha função globalmente para poder chamar de outros lugares
  window.ensureDefaultGroups = ensureDefaultGroups;

  /**
   * Restaura grupos e sessões do LocalStorage.
   */
  function restoreStackState() {
    try {
      const groups = JSON.parse(localStorage.getItem('unoStackGroups') || '[]');
      if (Array.isArray(groups)) {
        groups.forEach(g => {
          if (g && g.id && g.name) createStackGroup(g.id, g.name);
        });
      }
      const sessions = JSON.parse(localStorage.getItem('unoStackSessions') || '[]');
      if (Array.isArray(sessions)) {
        sessions.forEach(s => {
          try {
            const meta = JSON.parse(s.meta || '{}');
            openApp({ sid: s.sid, title: meta.title, url: meta.url, gid: s.gid, pinned: s.pinned });
            const card = document.querySelector('[data-sid="' + s.sid + '"]');
            if (card) {
              if (s.min) card.classList.add('min');
            }
          } catch (e) {}
        });
      }
    } catch (e) {
      console.warn('Falha ao restaurar grupos/sessões', e);
    }
    updateDock();
  }
  window.restoreStackState = restoreStackState;

  /**
   * Obtém a lista de apps fixados a partir do LocalStorage.
   * @returns {Array<{title:string,url:string}>}
   */
  function getPinnedList() {
    try { return JSON.parse(localStorage.getItem('unoPinnedApps') || '[]') || []; } catch { return []; }
  }

  /**
   * Atualiza o LocalStorage e a UI com o novo item fixado.
   * Evita duplicatas com base no título e URL.
   * @param {{title:string,url:string}} meta
   */
  function addPinned(meta) {
    if (!meta || !meta.title) return;
    const list = getPinnedList();
    const exists = list.some(item => item.title === meta.title && item.url === meta.url);
    if (!exists) {
      list.push({ title: meta.title, url: meta.url });
      localStorage.setItem('unoPinnedApps', JSON.stringify(list));
    }
    updatePinnedNav();
  }
  window.addPinned = addPinned;

  /**
   * Remove um item fixado com base no título e URL.
   * @param {{title:string,url:string}} meta
   */
  function removePinnedByMeta(meta) {
    if (!meta) return;
    let list = getPinnedList();
    list = list.filter(item => !(item.title === meta.title && item.url === meta.url));
    localStorage.setItem('unoPinnedApps', JSON.stringify(list));
    updatePinnedNav();
  }
  window.removePinnedByMeta = removePinnedByMeta;

  /**
   * Atualiza a barra de navegação para refletir os itens fixados.
   * Cria botões dinâmicos para cada app fixado.
   */
  function updatePinnedNav() {
    const navInner = document.querySelector('.tabbar .inner');
    if (!navInner) return;
    // Remova botões fixados existentes
    navInner.querySelectorAll('button.tab[data-pinned]').forEach(btn => btn.remove());
    const list = getPinnedList();
    list.forEach(item => {
      const btn = document.createElement('button');
      btn.className = 'tab fx-trans fx-press ring';
      btn.setAttribute('data-pinned', 'true');
      btn.title = item.title;
      // Use a primeira letra do título como ícone
      const letter = (item.title || '?').trim().charAt(0).toUpperCase();
      btn.innerHTML = `<span class="pin-letter">${letter}</span><span class="ripple"></span>`;
      btn.onclick = () => {
        openApp({ title: item.title, url: item.url });
      };
      navInner.appendChild(btn);
    });
  }
  window.updatePinnedNav = updatePinnedNav;

  // Restaure o estado e pinte a navegação assim que o DOM estiver pronto
  document.addEventListener('DOMContentLoaded', () => {
    try {
      window.__RESTORING_CHAT = true;
      restoreStackState();
      updatePinnedNav();
    } catch (e) {
      console.warn(e);
    }
  });
})();
</script>
<!-- Sons da interface.  Coloque os arquivos em sounds/ui/*.wav conforme distribuídos no pacote UNO_UISounds_Pack_v1. -->
<!-- Use o som Back Action como clique principal -->
<audio id="sndClick" preload="auto" src="sounds/ui/back-action.wav"></audio>
<audio id="sndHover" preload="auto" src="sounds/ui/hover.wav"></audio>
<audio id="sndOpen" preload="auto" src="sounds/ui/open.wav"></audio>
<audio id="sndClose" preload="auto" src="sounds/ui/close.wav"></audio>
<audio id="sndTab" preload="auto" src="sounds/ui/tab.wav"></audio>
<audio id="sndNav" preload="auto" src="sounds/ui/nav.wav"></audio>
<audio id="sndBack" preload="auto" src="sounds/ui/back.wav"></audio>
<audio id="sndDrag" preload="auto" src="sounds/ui/drag.wav"></audio>
<audio id="sndSuccess" preload="auto" src="sounds/ui/success.wav"></audio>
<audio id="sndWarn" preload="auto" src="sounds/ui/warn.wav"></audio>
<audio id="sndError" preload="auto" src="sounds/ui/error.wav"></audio>
<!-- Som Tech Pop usado para ações especiais (ex: salvar nome) -->
<audio id="sndTechPop" preload="auto" src="sounds/ui/tech-pop.wav"></audio>
<script>
  // Associe sons aos principais elementos de interface.  Cada botão com a
  // classe .btn toca o som de clique; os itens de navegação tocam som de
  // tab ou nav; a abertura/fechamento de sessões dispara sons específicos.
  (function(){
    const getAudio = id => document.getElementById(id);
    const play = (id) => {
      const audio = getAudio(id);
      if (audio) {
        try { audio.currentTime = 0; audio.play(); } catch {}
      }
    };
    // Clique em qualquer botão
    document.body.addEventListener('click', (e) => {
      const btn = e.target.closest('.btn');
      if (btn) play('sndClick');
      // Navegação inferior (tabs)
      const navBtn = e.target.closest('nav .btn');
      if (navBtn) play('sndTab');
    });
    // Hover (mouseenter) em botões
    document.body.addEventListener('mouseenter', (e) => {
      const btn = e.target.closest('.btn');
      if (btn) play('sndHover');
    }, true);
    // Sobrescreva open/close de sessões para tocar sons
    window.playOpenSound = () => play('sndOpen');
    window.playCloseSound = () => play('sndClose');
    // Exponha também som especial Tech Pop
    window.playTechPopSound = () => play('sndTechPop');
  })();
  </script>
<script>
// ===================== ChatPlus — v1 (2025-09-26) =====================
// Adds: emoji buttons, 3-block expandable answers, safe HTML rendering,
// autosave + compaction, and speech cues "Pulso enviado / Recebendo intenção".

(function(){
  const $ = (q, r=document)=>r.querySelector(q);
  const $$ = (q, r=document)=>Array.from(r.querySelectorAll(q));
  const LS = {
    get: (k, d) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d } catch { return d } },
    set: (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)) } catch {} },
    raw:(k)=>localStorage.getItem(k)||''
  };

  // ---------- 1) Safe HTML sanitizer ----------
  function sanitizeHTML(input){
    try{
      const parser = new DOMParser();
      const doc = parser.parseFromString(String(input||''), 'text/html');
      const disallowed = ['script','style','link','iframe','object','embed','meta'];
      disallowed.forEach(tag => doc.querySelectorAll(tag).forEach(n=>n.remove()));
      // Remove on* attributes and style; harden URLs
      const walker = doc.createTreeWalker(doc.body, NodeFilter.SHOW_ELEMENT);
      const allowedProtocols = ['http:', 'https:', 'data:'];
      while (walker.nextNode()) {
        const el = walker.currentNode;
        // Remove event handlers and style
        [...el.attributes].forEach(a => {
          if (/^on/i.test(a.name) || a.name === 'style') el.removeAttribute(a.name);
        });
        if (el.tagName === 'A') {
          el.setAttribute('target', '_blank');
          el.setAttribute('rel', 'noopener noreferrer');
          const href = el.getAttribute('href') || '';
          try {
            const u = new URL(href, location.href);
            if (!allowedProtocols.includes(u.protocol)) el.removeAttribute('href');
          } catch { el.removeAttribute('href'); }
        }
        if (el.tagName === 'IMG') {
          const src = el.getAttribute('src') || '';
          if (!/^https?:|^data:image\//i.test(src)) {
            el.removeAttribute('src');
          } else if (src.startsWith('data:') && src.length > 200000) {
            el.setAttribute('src', '');
          }
          el.setAttribute('loading','lazy');
          el.setAttribute('decoding','async');
          el.style.maxWidth = '100%';
          el.style.height = 'auto';
          el.style.borderRadius = '8px';
        }
      }
      return doc.body.innerHTML;
    }catch(e){
      return String(input||'').replace(/[<>]/g, c => c === '<' ? '&lt;' : '&gt;');
    }
  }

  // ---------- 2) Emoji wrapper & quick-reply ----------
  const emojiRegex = /([\p{Extended_Pictographic}\u2600-\u27BF](?:\uFE0F|\u200D[\p{Extended_Pictographic}\u2600-\u27BF])*)/gu;
  function wrapEmojisInEl(root){
    if (!root) return;
    // Walk text nodes and replace emojis with buttons
    const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT);
    const toReplace = [];
    while (walker.nextNode()) {
      const node = walker.currentNode;
      if (!node.nodeValue) continue;
      if (emojiRegex.test(node.nodeValue)) {
        toReplace.push(node);
      }
      emojiRegex.lastIndex = 0;
    }
    toReplace.forEach(node => {
      const frag = document.createDocumentFragment();
      const parts = node.nodeValue.split(emojiRegex);
      parts.forEach(part => {
        if (!part) return;
        if (emojiRegex.test(part)) {
          const btn = document.createElement('button');
          btn.className = 'emoji-btn';
          btn.textContent = part;
          btn.setAttribute('data-emoji', part);
          frag.appendChild(btn);
          emojiRegex.lastIndex = 0;
        } else {
          frag.appendChild(document.createTextNode(part));
        }
      });
      node.parentNode.replaceChild(frag, node);
    });
  }

  // Delegation: clicking an emoji sends it as a new message
  const chatFeed = document.getElementById('chatFeed');
  if (chatFeed) {
    chatFeed.addEventListener('click', (e) => {
      const btn = e.target.closest('.emoji-btn');
      if (!btn) return;
      const emoji = btn.getAttribute('data-emoji') || btn.textContent || '';
      if (emoji) {
        if (typeof window.sendUserMessage === 'function') {
          window.sendUserMessage(emoji);
        }
      }
    });
  }

  // ---------- 3) Chat store + compaction ----------
  const ChatStore = {
    key: 'uno:chat:v2',
    memKey: 'uno:chat:mem',
    maxPairs: 12,
    maxChars: 100000,
    load(){ return LS.get(this.key, []); },
    save(list){ LS.set(this.key, list||[]); },
    memory(){ return LS.get(this.memKey, ''); },
    setMemory(text){ LS.set(this.memKey, String(text||'')); },
    append(role, content){
      const list = this.load();
      list.push({ role, content: String(content||''), ts: Date.now() });
      this.save(list);
      this.compact();
    },
    clear(){ LS.set(this.key, []); LS.set(this.memKey, ''); },
    compact(){
      try {
        let list = this.load();
        const textLen = list.map(x => x.content||'').join('\n').length;
        if (list.length > 120 || textLen > this.maxChars) {
          const keep = list.filter(m => m.role === 'user' || m.role === 'assistant');
          // Keep last N pairs, summarize the rest
          const cutoffIndex = Math.max(0, keep.length - (this.maxPairs*2));
          const older = keep.slice(0, cutoffIndex);
          const newer = keep.slice(cutoffIndex);
          const summary = this.naiveSummarize(older);
          this.setMemory(summary);
          // Rebuild list with summary marker + newer
          const rebuilt = [];
          if (summary) rebuilt.push({ role: 'system', content: 'Contexto resumido: ' + summary, ts: Date.now() });
          newer.forEach(m => rebuilt.push(m));
          this.save(rebuilt);
        }
      } catch (e) {}
    },
    naiveSummarize(msgs){
      if (!Array.isArray(msgs) || !msgs.length) return '';
      const lines = [];
      let count = 0;
      for (const m of msgs) {
        const role = m.role === 'assistant' ? 'IA' : (m.role === 'user' ? 'Você' : m.role);
        const t = String(m.content||'').replace(/\s+/g,' ').trim();
        if (!t) continue;
        const first = t.split(/[.!?]/)[0];
        if (first) {
          lines.push('• ' + role + ': ' + first.slice(0, 160));
          count += first.length;
        }
        if (count > 1200) break;
      }
      return lines.join('\n');
    },
    buildMessages(userContent){
      // System directives to enforce 3 blocks.
      const sys = {
        role: 'system',
        content: [
          'Você é um assistente em português.',
          'Estruture SEMPRE a resposta em 3 blocos, com estes títulos exatos:',
          '### Recompensa Inicial',
          '### Curiosidade & Expansão',
          '### Antecipação Vibracional',
          'Cada bloco pode conter HTML simples seguro (sem scripts).'
        ].join(' ')
      };
      const memory = this.memory();
      const memMsg = memory ? { role: 'system', content: 'Contexto resumido (memória):\n' + memory } : null;
      const prev = this.load().filter(m => m.role === 'user' || m.role === 'assistant');
      // Keep last pairs
      const sliceStart = Math.max(0, prev.length - (this.maxPairs*2));
      const context = prev.slice(sliceStart);
      const msgs = [sys];
      if (memMsg) msgs.push(memMsg);
      context.forEach(m => msgs.push({ role: m.role === 'assistant' ? 'assistant' : 'user', content: m.content }));
      msgs.push({ role: 'user', content: userContent });
      return msgs;
    }
  };
  window.ChatStore = ChatStore;

  // ---------- 4) Render expandable 3-block reply with optional HTML ----------
  function extractHTMLFromFences(text){
    const m = /```html\s*([\s\S]*?)\s*```/i.exec(text||'');
    return m ? m[1] : null;
  }
  function splitIntoBlocks(raw){
    const t = String(raw||'');
    const re1 = /###\s*Recompensa\s*Inicial[\s\S]*?(?=###\s*Curiosidade\s*&\s*Expans[aã]o|$)/i;
    const re2 = /###\s*Curiosidade\s*&\s*Expans[aã]o[\s\S]*?(?=###\s*Antecip[aã]o\s*Vibracional|$)/i;
    const re3 = /###\s*Antecip[aã]o\s*Vibracional[\s\S]*/i;
    const b1 = (t.match(re1)||[''])[0].replace(/###.*?\n?/,'').trim();
    const b2 = (t.match(re2)||[''])[0].replace(/###.*?\n?/,'').trim();
    const b3 = (t.match(re3)||[''])[0].replace(/###.*?\n?/,'').trim();
    if (b1 || b2 || b3) return { reward:b1, curious:b2, vibe:b3 };
    // Fallback: split roughly
    const parts = t.split(/\n\n+/);
    const n = parts.length;
    const reward = parts.slice(0, Math.max(1, Math.ceil(n*0.3))).join('\n\n');
    const curious = parts.slice(Math.max(1, Math.ceil(n*0.3)), Math.max(2, Math.ceil(n*0.7))).join('\n\n');
    const vibe = parts.slice(Math.max(2, Math.ceil(n*0.7))).join('\n\n');
    return { reward, curious, vibe };
  }
  function paraToHTML(s){
    const esc = s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    return esc.split(/\n{2,}/).map(p => '<p>'+p.replace(/\n/g,'<br>')+'</p>').join('');
  }
  function createBlockEl(title, content){
    const details = document.createElement('details');
    details.className = 'ai-block';
    const summary = document.createElement('summary');
    summary.innerHTML = title;
    const body = document.createElement('div');
    body.className = 'block-body';
    // If fenced HTML present, render sanitized HTML
    const fenced = extractHTMLFromFences(content||'');
    if (fenced) {
      const safe = sanitizeHTML(fenced);
      body.innerHTML = '<div class="render-html">'+ safe +'</div>';
    } else if (/<[a-z][\s\S]*>/i.test(content||'')) {
      body.innerHTML = '<div class="render-html">'+ sanitizeHTML(content) +'</div>';
    } else {
      body.innerHTML = paraToHTML(content||'');
    }
    details.appendChild(summary);
    details.appendChild(body);
    return details;
  }
  function renderAssistantReply(raw){
    const feed = document.getElementById('chatFeed');
    if (!feed) return;
    const { reward, curious, vibe } = splitIntoBlocks(raw||'');
    const wrap = document.createElement('div');
    wrap.className = 'msg ai ai-rich';
    // Build the three blocks
    const b1 = createBlockEl('1) <strong>Recompensa Inicial</strong> ⚡', reward||'');
    const b2 = createBlockEl('2) <strong>Curiosidade &amp; Expansão</strong> 🔎', curious||'');
    const b3 = createBlockEl('3) <strong>Antecipação Vibracional</strong> ✨', vibe||'');
    // Open first block by default
    b1.open = true;
    wrap.appendChild(b1);
    wrap.appendChild(b2);
    wrap.appendChild(b3);
    // Extract emojis to suggestion row
    const ems = (raw||'').match(/([\p{Extended_Pictographic}\u2600-\u27BF])/gu) || [];
    const uniq = Array.from(new Set(ems)).slice(0,8);
    if (uniq.length) {
      const sug = document.createElement('div');
      sug.className = 'emoji-suggestions';
      uniq.forEach(e => {
        const btn = document.createElement('button');
        btn.className = 'emoji-btn';
        btn.textContent = e;
        btn.setAttribute('data-emoji', e);
        sug.appendChild(btn);
      });
      wrap.appendChild(sug);
    }
    feed.appendChild(wrap);
    wrapEmojisInEl(wrap);
    feed.scrollTop = feed.scrollHeight;
    // Update preview and voice (speak only the reward block text stripped)
    try {
      const txt = (reward||'').replace(/<[^>]*>/g,'').replace(/```[\s\S]*?```/g,'').trim();
      if (typeof updatePreview === 'function') updatePreview(txt || (raw||'').slice(0,180));
      if (typeof speakWithActiveArch === 'function' && txt) speakWithActiveArch(txt);
    } catch{}
    // Save to chat store
    try { if (!window.__RESTORING_CHAT) ChatStore.append('assistant', raw||''); } catch{}
  }
  window.renderAssistantReply = renderAssistantReply;

  // ---------- 5) Unified sendUserMessage ----------
  async function sendUserMessage(msg){
    const text = String(msg||'').trim();
    if (!text) return;
    // Show in feeds + voice status
    if (typeof feedPush === 'function') feedPush('user', 'Você: ' + text);
    try {
      if (typeof showArchMessage === 'function') showArchMessage('Pulso enviado. Recebendo intenção…', 'ok');
      if (typeof speakWithActiveArch === 'function') {
        speakWithActiveArch('Pulso enviado');
        setTimeout(()=>speakWithActiveArch('Recebendo intenção'), 380);
      }
    } catch{}
    if (typeof feedPush === 'function') feedPush('status', '⚡ Pulso enviado · recebendo intenção…');
    try { ChatStore.append('user', text); } catch{}
    // Build OpenRouter call
    const userName = (localStorage.getItem('dual.name') || localStorage.getItem('infodose:userName') || '').trim();
    const sk = (localStorage.getItem('dual.keys.openrouter') || localStorage.getItem('infodose:sk') || '').trim();
    let model = (window.LS && LS.get && LS.get('dual.openrouter.model')) || (localStorage.getItem('infodose:model') || '').trim() || 'openrouter/auto';
    // Call
    try {
      const reply = await sendAIMessageCtx({ userContent: text, sk, model });
      if (reply) {
        renderAssistantReply(reply);
      }
    } catch (err) {
      console.error(err);
      if (typeof feedPush === 'function') feedPush('status', '❌ Erro ao obter resposta.');
    }
  }
  window.sendUserMessage = sendUserMessage;

  // ---------- 6) Override/extend existing functions non-intrusively ----------
  // a) StartSpeech: override to route to sendUserMessage()
  if (typeof startSpeechConversation === 'function') {
    window._startSpeechConversationOrig = startSpeechConversation;
  }
  window.startSpeechConversation = function(userName, sk, model){
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      try { showArchMessage('Reconhecimento de fala não suportado neste navegador.', 'err'); } catch {}
      try { feedPush('status', '❌ Reconhecimento de fala não suportado.'); } catch {}
      return;
    }
    const recognition = new SpeechRecognition();
    recognition.lang = 'pt-BR';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    recognition.onstart = () => {
      try { showArchMessage('Estou ouvindo…', 'ok'); } catch {}
      try { feedPush('status', '🎙️ Ouvindo…'); } catch {}
    };
    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript.trim();
      if (transcript) sendUserMessage(transcript);
    };
    recognition.onerror = (e) => {
      console.error('Erro no reconhecimento de fala:', e);
      try { showArchMessage('Erro no reconhecimento de fala.', 'err'); } catch {}
      try { feedPush('status', '❌ Erro no reconhecimento de fala.'); } catch {}
    };
    recognition.start();
  };

  // b) Override sendAIMessage to support full context + 3-block instruction
  if (typeof sendAIMessage === 'function') window._sendAIMessageOrig = sendAIMessage;
  async function sendAIMessageCtx({ userContent, sk, model }){
    const url = 'https://openrouter.ai/api/v1/chat/completions';
    const messages = ChatStore.buildMessages(userContent);
    const payload = {
      model: model,
      messages: messages,
      max_tokens: 600,
      temperature: 0.7
    };
    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${sk}`
      },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error('Erro na API: ' + res.status);
    const data = await res.json();
    const reply = data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content;
    return reply || '';
  }
  window.sendAIMessageCtx = sendAIMessageCtx;
  window.sendAIMessage = async function(content, sk, model){
    return sendAIMessageCtx({ userContent: content, sk, model });
  };

  // c) Wrap openApp to speak app title on open
  if (typeof openApp === 'function') {
    const _openApp = openApp;
    window.openApp = function(a){
      try {
        if (typeof speakWithActiveArch === 'function') speakWithActiveArch('Abrindo ' + (a && (a.title||'app')));
      } catch{}
      return _openApp(a);
    }
  }

  // d) Force app card titles to 2 words + ellipsis (post-render safety)
  if (typeof cardApp === 'function') {
    const _cardApp = cardApp;
    window.cardApp = function(a){
      const el = _cardApp(a);
      try {
        const fullTitle = String(a.title || a.key || '').trim();
        const words = fullTitle.split(/\s+/);
        const two = words.slice(0,2).join(' ');
        const display = words.length > 2 ? two + '…' : two;
        const tEl = el.querySelector('.app-title');
        if (tEl) { tEl.textContent = display || fullTitle; tEl.title = fullTitle; }
      } catch{}
      return el;
    }
  }

  // e) Feed autosave: patch feedPush/chatPush to store messages (without breaking UI)
  const _feedPush = (typeof feedPush === 'function') ? feedPush : null;
  window.feedPush = function(type, text){
    if (_feedPush) _feedPush(type, text);
    try {
      if (type === 'user') {
        const t = String(text||'').replace(/^Você:\s*/i,'');
        ChatStore.append('user', t);
      } else if (type === 'ai') {
        const t = String(text||'').replace(/^[^:]+:\s*/i,'');
        ChatStore.append('assistant', t);
      }
    } catch {}
  };
  if (typeof chatPush === 'function') {
    const _chatPush = chatPush;
    window.chatPush = function(type, text){
      _chatPush(type, text);
      try {
        if (type === 'user') {
          const t = String(text||'').replace(/^Você:\s*/i,'');
          ChatStore.append('user', t);
        } else if (type === 'ai') {
          const t = String(text||'').replace(/^[^:]+:\s*/i,'');
          ChatStore.append('assistant', t);
        }
      } catch {}
    }
  }

  // ---------- 7) Restore chat on load ----------
  document.addEventListener('DOMContentLoaded', () => {
    try {
      window.__RESTORING_CHAT = true;
      const list = ChatStore.load();
      if (!list || !list.length) return;
      const feed = document.getElementById('chatFeed');
      if (!feed) return;
      list.forEach(m => {
        if (m.role === 'assistant') {
          // Render as blocks if possible
          window.renderAssistantReply(m.content);
        } else if (m.role === 'user') {
          const div = document.createElement('div');
          div.className = 'msg user';
          div.textContent = 'Você: ' + (m.content||'');
          feed.appendChild(div);
        }
      });
      feed.scrollTop = feed.scrollHeight;
      window.__RESTORING_CHAT = false;
    } catch (e) { console.warn('Restore chat failed', e); window.__RESTORING_CHAT = false; }
  });

  // ---------- 8) Intercept home input form submit (capture) to route to sendUserMessage ----------
  document.addEventListener('DOMContentLoaded', () => {
    const hiForm = document.getElementById('homeInputForm');
    const hiInput = document.getElementById('homeInput');
    if (hiForm && hiInput) {
      hiForm.addEventListener('submit', (ev) => {
        ev.preventDefault();
        ev.stopPropagation();
        ev.stopImmediatePropagation();
        const msg = (hiInput.value || '').trim();
        if (msg) window.sendUserMessage(msg);
        hiInput.value = '';
        return false;
      }, true); // capture to preempt previous handler
    }
  });

})(); // end ChatPlus
</script>
<script src="dual_multiagent_v1.js"></script>
<script src="dual_multiagent_v12_locked.js"></script>
<script defer="" src="openrouter_hardlock_model_v1.js"></script>
<script id="patch-visual-presets">
(function(){
  // Helpers
  const $ = (q, r = document) => r.querySelector(q);
  const LS = {
    get: (k, d) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d } catch (e) { return d } },
    set: (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)) } catch (e) {} }
  };

  // Inject "Blue‑1" into theme select if missing
  document.addEventListener('DOMContentLoaded', function(){
    try {
      const sel = document.getElementById('themeSelect');
      if (sel && !Array.from(sel.options).some(o => o.value === 'blue1')) {
        const opt = document.createElement('option');
        opt.value = 'blue1'; opt.textContent = 'Blue‑1 (azul)';
        sel.appendChild(opt);
      }
    } catch(e){}
  });

  // Build and inject a Visual & 3D card into Brain view (non-destructive)
  document.addEventListener('DOMContentLoaded', function(){
    const grid = document.querySelector('#v-brain .grid');
    if (!grid) return;
    const panel = document.createElement('div');
    panel.className = 'card fx-trans fx-lift';
    panel.style.display = 'block';
    panel.innerHTML = `
      <div style="font-weight:800">Visual & 3D (presets)</div>
      <div style="margin-top:8px;display:grid;gap:10px">
        <label style="display:flex;align-items:center;gap:8px">
          <span>Preset:</span>
          <select id="visualPreset" class="input ring" style="max-width:260px">
            <option value="blue1">Blue‑1 (shader)</option>
            <option value="strong">Strong</option>
            <option value="cinematic-soft">Cinematic Soft</option>
          </select>
        </label>
        <label style="display:flex;align-items:center;gap:8px">
          <input id="overlayToggle" type="checkbox" />
          <span>Overlay de cor por arquétipo</span>
        </label>
        <label style="display:flex;align-items:center;gap:8px">
          <input id="bloomToggle" type="checkbox" />
          <span>Bloom fotográfico (post)</span>
        </label>
        <label style="display:flex;align-items:center;gap:8px">
          <span>Glow/Toon:</span>
          <input id="glowRange" type="range" min="0" max="1" step="0.05" style="flex:1" />
          <span id="glowVal" class="mut" style="width:42px;text-align:right">0.80</span>
        </label>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="applyVisual" class="btn prime fx-trans fx-press ring">Aplicar<span class="ripple"></span></button>
          <button id="resetVisual" class="btn fx-trans fx-press ring">Padrão<span class="ripple"></span></button>
        </div>
        <div class="mut" style="font-size:11px">
          As preferências são salvas no seu navegador e enviadas ao arquétipo ativo.
        </div>
      </div>
    `;
    grid.appendChild(panel);

    // Defaults
    const defaults = {
      preset: LS.get('arch:visualPreset', 'blue1'),
      overlayOn: LS.get('arch:overlayOn', false),
      bloomOn: LS.get('arch:bloomOn', false),
      glow: LS.get('arch:glowStrength', 0.80)
    };

    // UI references
    const selPreset = $('#visualPreset', panel);
    const chkOverlay = $('#overlayToggle', panel);
    const chkBloom = $('#bloomToggle', panel);
    const rngGlow = $('#glowRange', panel);
    const spnGlow = $('#glowVal', panel);
    const btnApply = $('#applyVisual', panel);
    const btnReset = $('#resetVisual', panel);

    // Populate
    selPreset.value = defaults.preset;
    chkOverlay.checked = !!defaults.overlayOn;
    chkBloom.checked = !!defaults.bloomOn;
    rngGlow.value = defaults.glow;
    spnGlow.textContent = Number(defaults.glow).toFixed(2);

    rngGlow.addEventListener('input', () => { spnGlow.textContent = Number(rngGlow.value).toFixed(2); });

    function saveAndApply(){
      const state = {
        preset: selPreset.value,
        overlayOn: !!chkOverlay.checked,
        bloomOn: !!chkBloom.checked,
        glow: Number(rngGlow.value)
      };
      LS.set('arch:visualPreset', state.preset);
      LS.set('arch:overlayOn', state.overlayOn);
      LS.set('arch:bloomOn', state.bloomOn);
      LS.set('arch:glowStrength', state.glow);
      // Update overlay color right away
      try {
        const sel = document.getElementById('arch-select');
        const base = (sel?.value || '').replace(/\.html$/i, '');
        if (window.applyArchOverlay) window.applyArchOverlay(base);
      } catch(e){}
      // Send to iframe
      try { sendVisualSettingsToFrame(); } catch(e){}
    }

    btnApply.addEventListener('click', saveAndApply);
    btnReset.addEventListener('click', () => {
      selPreset.value = 'blue1';
      chkOverlay.checked = false;
      chkBloom.checked = false;
      rngGlow.value = 0.80;
      spnGlow.textContent = '0.80';
      saveAndApply();
    });
  });

  // Canonical overlay colors for the 12 archetypes
  const ARCH_OVERLAYS_PATCHED = {
    atlas:  'rgba(64,158,255,0.22)',
    nova:   'rgba(255,82,177,0.22)',
    vitalis:'rgba(87,207,112,0.22)',
    pulse:  'rgba(0,191,255,0.22)',
    artemis:'rgba(255,195,0,0.22)',
    serena: 'rgba(186,130,219,0.22)',
    kaos:   'rgba(255,77,109,0.22)',
    genus:  'rgba(87,207,112,0.22)',
    lumine: 'rgba(255,213,79,0.22)',
    solus:  'rgba(186,130,219,0.22)',
    rhea:   'rgba(0,209,178,0.22)',
    aion:   'rgba(255,159,67,0.22)',
    default:'rgba(255,255,255,0.0)'
  };

  // Override applyArchOverlay to honor overlay toggle
  (function overrideApplyArchOverlay(){
    const LSget = (k,d)=>{ try{ const v = localStorage.getItem(k); return v?JSON.parse(v):d }catch(e){ return d } };
    window.applyArchOverlay = function(name){
      const key = (name || '').toLowerCase();
      const on = !!LSget('arch:overlayOn', true);
      const color = on ? (ARCH_OVERLAYS_PATCHED[key] || ARCH_OVERLAYS_PATCHED.default) : 'rgba(0,0,0,0)';
      document.documentElement.style.setProperty('--arch-overlay', color);
    };
    // Apply once at startup for current selection
    document.addEventListener('DOMContentLoaded', function(){
      const sel = document.getElementById('arch-select');
      const base = (sel?.value || '').replace(/\.html$/i, '');
      window.applyArchOverlay(base);
    });
  })();

  // PostMessage: send visual settings to archetype iframe
  function currentVisualSettings(){
    const LSget = (k,d)=>{ try{ const v = localStorage.getItem(k); return v?JSON.parse(v):d }catch(e){ return d } };
    return {
      preset: LSget('arch:visualPreset','blue1'),
      bloom: !!LSget('arch:bloomOn', false),
      glow: Number(LSget('arch:glowStrength', 0.80)),
      overlayOn: !!LSget('arch:overlayOn', true)
    };
  }
  window.sendVisualSettingsToFrame = function(){
    try {
      const f = document.getElementById('arch-frame');
      if (f && f.contentWindow) {
        f.contentWindow.postMessage({ type:'visualSettings', data: currentVisualSettings() }, '*');
      }
    } catch(e){}
  };

  // Send settings whenever the iframe loads or signals readiness
  document.addEventListener('DOMContentLoaded', function(){
    const f = document.getElementById('arch-frame');
    if (f) {
      f.addEventListener('load', () => { try { sendVisualSettingsToFrame(); } catch(e){} });
      // small delay to ensure child is ready
      setTimeout(() => { try { sendVisualSettingsToFrame(); } catch(e){} }, 800);
    }
  });
  window.addEventListener('message', (ev) => {
    const msg = ev?.data || {};
    if (msg && msg.type === 'archReady') {
      try { sendVisualSettingsToFrame(); } catch(e){}
    }
  });

})();
</script>
<link href="uno_showcase_patch.css" rel="stylesheet"/>
<script defer="" src="uno_showcase_patch.js"></script>
<div aria-hidden="true" class="ls-modal" id="lsModal">
<div class="ls-panel" id="lsPanel">
<div class="ls-hdr">
<div class="ls-ttl">LocalStorage • Presets, Chaves &amp; Carteira SK</div>
<div class="ls-actions">
<button id="lsRescan">Re-scan</button>
<button id="lsRefresh">Atualizar página</button>
<button id="lsExport">Exportar</button>
<label for="lsImportFile" style="display:inline-block"><button type="button">Importar</button></label>
<input accept="application/json" hidden="" id="lsImportFile" type="file"/>
<button id="lsClearDisabled">Limpar desativados</button>
<!-- PATCH: Toggle 78K within LS Panel -->
<button aria-pressed="false" id="lsToggle78k" title="Ativar/Desativar estado 78K">78K: OFF</button>
<button id="lsClose">Fechar</button></div>
</div>
<details class="presets" open="">
<summary><strong>Presets (ON/OFF global)</strong></summary>
<div class="presets-grid" id="presetsGrid"></div>
</details>
<details class="presets" open="">
<summary><strong>Carteira de Chaves OpenRouter</strong></summary>
<div class="grid" style="gap:8px">
<div class="row" style="border:0;padding:0;gap:8px">
<input id="skName" placeholder="Nome curto (ex.: Prod, Dev, Teste)" style="flex:1"/>
<input id="skValue" placeholder="sk-..." style="flex:2"/>
<button id="skAdd">Adicionar</button>
</div>
<div class="sk-grid" id="skGrid"></div>
</div>
<div class="meta">A chave <code>dual.keys.openrouter</code> recebe a chave marcada como <b>Ativa</b>. Desativar retira a chave ativa do uso (sem apagar a carteira).</div>
</details>
<details class="presets" open="">
<summary><strong>Overlay do Arquétipo</strong> <span class="type" style="opacity:.75">força</span></summary>
<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
<div>Força:</div>
<div class="seg">
<button class="ls-ov" data-level="0" type="button">0</button>
<button class="ls-ov" data-level="-1" type="button">−1</button>
<button class="ls-ov" data-level="-2" type="button">−2</button>
</div>
<div class="meta">Salvo em <code>infodose:arch.overlay.level</code> • Default: −1 (12%).</div>
</div>
</details>
<div class="meta"><span id="lsCount">—</span> • <span id="lsSize">—</span></div>
<div class="list" id="lsList"></div>
<details class="presets" open="" style="margin-top:10px">
<summary><strong>Pré-visualização de Imagens</strong></summary>
<div class="img-grid" id="imgGrid"></div>
</details>
</div>
</div>
<script id="ls-panel-js">
(() => {
  const $ = (s, r=document)=> r.querySelector(s);
  const $$ = (s, r=document)=> Array.from(r.querySelectorAll(s));
  const prettyBytes = (n)=>{ if(!Number.isFinite(n)||n<=0) return '0 B'; const u=['B','KB','MB','GB']; let i=0; while(n>=1024&&i<u.length-1){n/=1024;i++} return n.toFixed(2)+' '+u[i] };
  const isJson = (v)=>{ try{ JSON.parse(v); return true; }catch{ return false; } };
  const inferType = (v)=>{
    if(v==null||v==='') return 'empty';
    if(isJson(v)){const p=JSON.parse(v); if(Array.isArray(p)) return 'json[array]'; if(p&&typeof p==='object') return 'json[object]'; return 'json['+(typeof p)+']';}
    if(/^data:image\//i.test(v)||/\.(png|jpe?g|gif|webp|svg)(\?|$)/i.test(v)) return 'image';
    if(/^(true|false|1|0)$/i.test(v)) return 'boolean-like';
    if(/^https?:\/\//i.test(v)) return 'url';
    if(/^data:/i.test(v)) return 'data-url';
    return 'string';
  };

  const DISABLED_KEY = 'infodose:presets.disabled';
  const PRESETS = [
    { key:'infodose:userName', label:'Usuário' },
    { key:'infodose:assistantName', label:'Assistente' },
    { key:'dual.keys.openrouter', label:'Chave OpenRouter (ativa)' },
    { key:'dual.openrouter.model', label:'Modelo OpenRouter' },
    { key:'uno:theme', label:'Tema' },
    { key:'uno:bg', label:'Fundo Custom' },
    { key:'infodose:cssCustom', label:'CSS Custom' },
    { key:'infodose:voices', label:'Vozes Arquetípicas' }
  ];

  const disabledSet = ()=> { try{ return new Set(JSON.parse(localStorage.getItem(DISABLED_KEY)||'[]')); }catch{ return new Set(); } };
  const saveDisabled = (set)=> localStorage.setItem(DISABLED_KEY, JSON.stringify(Array.from(set)));
  const isEnabled = (k)=> !disabledSet().has(k);
  const toggleDisabled = (k)=> { const s=disabledSet(); s.has(k)?s.delete(k):s.add(k); saveDisabled(s); renderAll(); window.dispatchEvent(new CustomEvent('ls:disabled-changed',{detail:{key:k,disabled:s.has(k)}})); };

  // Carteira SK
  const WALLET_KEY = 'dual.keys.wallet';
  const getWallet = ()=>{ try{ return JSON.parse(localStorage.getItem(WALLET_KEY)||'[]'); }catch{return []} };
  const setWallet = (arr)=> localStorage.setItem(WALLET_KEY, JSON.stringify(arr));
  const addWalletItem = (name, key)=>{
    const list=getWallet();
    const genId = (crypto?.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2));
    list.push({ id: genId, name, key, active:false });
    setWallet(list); renderWallet();
  };
  const removeWalletItem = (id)=>{ const list=getWallet().filter(x=>x.id!==id); setWallet(list); ensureActiveConsistency(); renderWallet(); };
  const activateWalletItem = (id)=>{
    const list=getWallet().map(x=>({...x, active: x.id===id})); setWallet(list);
    if(isEnabled('dual.keys.openrouter')){
      const chosen=list.find(x=>x.active); localStorage.setItem('dual.keys.openrouter', chosen? chosen.key: '');
    }
    renderAll();
  };
  const ensureActiveConsistency = ()=>{ const list=getWallet(); const anyActive=list.some(x=>x.active); if(!anyActive){ localStorage.setItem('dual.keys.openrouter',''); } };
  const renderWallet = ()=>{
    const grid=$('#skGrid'); if(!grid) return; grid.innerHTML='';
    const list=getWallet(); if(!list.length){ grid.innerHTML='<div class="meta">Nenhuma chave na carteira ainda.</div>'; return; }
    list.forEach(item=>{
      const div=document.createElement('div'); div.className='sk-item';
      const top=document.createElement('div'); top.className='top';
      const name=document.createElement('div'); name.className='name'; name.textContent=item.name+(item.active?' • ATIVA':'');
      const act=document.createElement('div');
      const bUse=document.createElement('button'); bUse.textContent=item.active?'Desativar':'Ativar';
      bUse.onclick=()=>{ if(item.active){
          const list2=getWallet().map(x=>({...x, active: x.id===item.id? false: x.active })); setWallet(list2); ensureActiveConsistency(); renderWallet(); renderAll();
        } else { activateWalletItem(item.id); } };
      const bDel=document.createElement('button'); bDel.textContent='Apagar'; bDel.onclick=()=>{ if(confirm('Apagar entrada da carteira?')) removeWalletItem(item.id) };
      act.append(bUse,bDel); top.append(name,act);
      const key=document.createElement('div'); key.className='key'; key.textContent=item.key;
      div.append(top,key); grid.append(div);
    });
  };

  // LS
  const lsEntries = ()=>{ const out=[]; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); const v=localStorage.getItem(k)||''; out.push({key:k,val:v}); } return out.sort((a,b)=>a.key.localeCompare(b.key)); };
  const lsSizeBytes = ()=>{ let sum=0; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); const v=localStorage.getItem(k)||''; sum += k.length + v.length; } return sum; };

  const renderPresets = ()=>{
    const grid=$('#presetsGrid'); if(!grid) return; grid.innerHTML='';
    const dis=disabledSet();
    PRESETS.forEach(p=>{
      const val=localStorage.getItem(p.key); const on=!dis.has(p.key);
      const wrap=document.createElement('div'); wrap.className='preset';
      const head=document.createElement('div'); head.className='row';
      const name=document.createElement('div'); name.innerHTML = `<strong>${p.label}</strong><div class="type">${p.key}</div>`;
      const sw=document.createElement('div'); sw.className='switch'+(on?' on':''); sw.title=on?'Desativar (não apaga)':'Ativar'; sw.onclick=()=>toggleDisabled(p.key);
      head.append(name,sw);
      const meta=document.createElement('div'); meta.className='val';
      meta.textContent = val ? (inferType(val).startsWith('json')? JSON.stringify(JSON.parse(val),null,2): val) : '—';
      wrap.append(head,meta); grid.append(wrap);
    });
  };

  const addImagePreview = (key,src)=>{ const g=$('#imgGrid'); if(!g) return; const card=document.createElement('div'); card.className='img-card'; const cap=document.createElement('div'); cap.className='meta'; cap.textContent=key; const im=new Image(); im.src=src; im.loading='lazy'; card.append(cap,im); g.append(card); };

  const renderLS = ()=>{
    const list=$('#lsList'); if(!list) return; list.innerHTML=''; const imgGrid=$('#imgGrid'); if(imgGrid) imgGrid.innerHTML='';
    const entries=lsEntries(); const count=$('#lsCount'); if(count) count.textContent = entries.length+' chave(s)';
    const size=$('#lsSize'); if(size) size.textContent = prettyBytes(lsSizeBytes());
    const dis=disabledSet();
    entries.forEach(({key,val})=>{
      if(key===DISABLED_KEY) return;
      const it=document.createElement('div'); it.className='item';
      const head=document.createElement('div'); head.className='head';
      const left=document.createElement('div');
      left.innerHTML=`<div class="key">${key}${dis.has(key)?' <span class="type">(desativado)</span>':''}</div><div class="type">${inferType(val)} • ${prettyBytes((val||'').length)}</div>`;
      const ctr=document.createElement('div'); ctr.style.display='flex'; ctr.style.gap='8px'; ctr.style.flexWrap='wrap';
      const sw=document.createElement('div'); sw.className='switch'+(!dis.has(key)?' on':''); sw.title = (!dis.has(key)?'Desativar':'Ativar'); sw.onclick=()=>toggleDisabled(key);
      const bEdit=document.createElement('button'); bEdit.textContent='Editar'; bEdit.onclick=()=>{ const next=prompt('Editar valor de\n'+key, val ?? ''); if(next==null) return; localStorage.setItem(key,String(next)); renderAll(); };
      const bDel=document.createElement('button'); bDel.textContent='Apagar'; bDel.onclick=()=>{ if(confirm('Apagar '+key+'?')){ localStorage.removeItem(key); renderAll(); } };
      if(inferType(val)==='image'){ const bImg=document.createElement('button'); bImg.textContent='Ver imagem'; bImg.onclick=()=>addImagePreview(key,val); ctr.append(bImg); }
      ctr.append(sw,bEdit,bDel); head.append(left,ctr);
      const v=document.createElement('div'); v.className='val'; v.textContent = inferType(val).startsWith('json')? JSON.stringify(JSON.parse(val),null,2): (val??'—');
      it.append(head,v); list.append(it);
    });
  };

  const exportLS = ()=>{ const dump={}; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(k===DISABLED_KEY) continue; dump[k]=localStorage.getItem(k); } const blob=new Blob([JSON.stringify(dump,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='localstorage_export.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 2000); };
  const importLS = (file)=>{ const r=new FileReader(); r.onload=()=>{ try{ const data=JSON.parse(r.result||'{}'); Object.entries(data).forEach(([k,v])=>localStorage.setItem(k,String(v))); alert('Importado com sucesso.'); renderAll(); }catch(e){ alert('JSON inválido.'); } }; r.readAsText(file); };

  const openLS = ()=>{ const m=$('#lsModal'); if(!m) return; m.classList.add('open'); m.setAttribute('aria-hidden','false'); renderAll(); renderWallet(); };
  const closeLS = ()=>{ const m=$('#lsModal'); if(!m) return; m.classList.remove('open'); m.setAttribute('aria-hidden','true'); };
  const renderAll = ()=>{ renderPresets(); renderLS(); };

  const ready = () => {
    // Unify LS button (clone -> only our modal)
    const btn = document.getElementById('btnLS');
    if(btn && !btn.dataset._lsUnified){
      const c=btn.cloneNode(true);
      c.removeAttribute('onclick'); c.removeAttribute('href');
      c.dataset._lsUnified='1';
      c.addEventListener('click', (ev)=>{
        ev.preventDefault(); ev.stopPropagation();
        try{
          document.querySelectorAll('.modal,[role="dialog"],[class*="modal"]').forEach(el=>{ if(el.id!=='lsModal'){ el.style.display='none'; el.classList.remove('open','show','visible'); el.setAttribute('aria-hidden','true'); } });
        }catch(e){}
        openLS();
      }, {passive:false});
      btn.parentNode.replaceChild(c, btn);
    }

    const c = $('#lsClose'); if(c) c.onclick = closeLS;
    const r = $('#lsRescan'); if(r) r.onclick = renderAll;
    const e = $('#lsExport'); if(e) e.onclick = exportLS;
    const imp = $('#lsImportFile'); if(imp) imp.addEventListener('change', ev=>{ const f=ev.target.files?.[0]; if(f) importLS(f); ev.target.value=''; });
    const clr = $('#lsClearDisabled'); if(clr) clr.onclick = ()=>{ localStorage.setItem(DISABLED_KEY,'[]'); renderAll(); };

    const modal = $('#lsModal'); if(modal) modal.addEventListener('click', (evt)=>{ if(evt.target===modal) closeLS(); });
    const skAdd = $('#skAdd'); if(skAdd) skAdd.onclick = ()=>{ const name=$('#skName').value.trim(); const key=$('#skValue').value.trim(); if(!name||!key) return alert('Informe nome e chave.'); addWalletItem(name,key); $('#skName').value=''; $('#skValue').value=''; };

    // Overlay control in LS
    const KEY='infodose:arch.overlay.level';
    const LEVELS={"0":"16%","-1":"12%","-2":"8%"};
    const apply=(lvl)=>{
      const force=LEVELS[String(lvl)]||LEVELS["-1"];
      document.documentElement.style.setProperty('--arch-overlay-strength', force);
      if(window.ArchTint&&typeof ArchTint.set==='function'){ try{ ArchTint.set(null, String(lvl)); }catch(e){} }
      document.querySelectorAll('.ls-ov[data-level]').forEach(b=>b.classList.toggle('on', b.dataset.level===String(lvl)));
    };
    const saved=localStorage.getItem(KEY)||"-1";
    apply(saved);
    $$('.ls-ov[data-level]').forEach(b=> b.addEventListener('click',()=>{ const lvl=b.dataset.level; localStorage.setItem(KEY, String(lvl)); apply(lvl); }, {passive:true}));
  };
  if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', ready); } else { ready(); }

  window.DualLS = { open: openLS, close: closeLS, render: renderAll };
})();
</script>
<script id="ls-snpt-boot">
(function(){
  function ensure(){
    if(document.getElementById('ls-panel-js') || document.getElementById('lsModal')) return;
    fetch('lspanel.snpt', {cache:'no-store'}).then(r => r.ok ? r.text(): null).then(txt => {
      if(!txt) return;
      document.body.insertAdjacentHTML('beforeend', txt);
      setTimeout(function(){
        try{
          if(window.DualLS && typeof window.DualLS.render==='function'){ window.DualLS.render(); }
        }catch(e){}
      }, 50);
    }).catch(()=>{});
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', ensure); } else { ensure(); }
})();
</script>
<script id="ls-sanitize-old-js">
(function(){
  // Remove apenas ids legados conhecidos, preservando #lsModal e #lsPanel
  const LEGACY = [
    'modalLS','localStorageModal','lsWindow','lsPopup','modal-localstorage',
    'local-storage-modal','ls-modal-old','oldLsModal','modalLocalStorage','modal-ls'
  ];
  function clean(){
    try{
      LEGACY.forEach(id => {
        const el = document.getElementById(id);
        if(el) el.remove();
      });
      // Opcional: fecha modais legados que venham com classes genéricas
      document.querySelectorAll('.modal,[role="dialog"]').forEach(el=>{
        if(el.id && (el.id==='lsModal' || el.id==='lsPanel')) return;
        if(el.closest('#lsModal')) return;
        if(/localstorage|modal-ls|ls-?old/i.test(el.id||'') || /localstorage/i.test(el.className||'')){
          el.remove();
        }
      });
    }catch(e){}
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', clean); } else { clean(); }
})();
</script>
<script id="arch-init-nonatlas">
(function(){
  function initArchSelect(){
    var sel=document.getElementById('arch-select'); if(!sel) return;
    var saved=(localStorage.getItem('uno:arch')||localStorage.getItem('infodose:arch')||'').replace(/\.html$/i,'');
    var idx=-1;
    for(var i=0;i<sel.options.length;i++){
      var v=sel.options[i].value.replace(/\.html$/i,'');
      if(saved && v===saved){ idx=i; break; }
    }
    sel.selectedIndex = idx; // -1 = nenhum, evita default 'atlas'
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', initArchSelect); } else { initArchSelect(); }
})();
</script>
<!-- PATCH: overlay-hardlock -->
<script id="overlay-hardlock">
(function () {
  const LSget = (k,d)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):d }catch(e){ return d } };

  function setOverlayTransparent(){
    try{
      document.documentElement.style.setProperty('--arch-overlay','rgba(0,0,0,0)');
      document.documentElement.style.setProperty('--arch-overlay-strength','0%');
    }catch(e){}
  }

  function gateApply(){
    // Re-define applyArchOverlay ALWAYS last so it cannot be overridden later
    window.applyArchOverlay = function(name){
      const on = !!LSget('arch:overlayOn', true);
      if(!on){ setOverlayTransparent(); return; }
      const key = (name||'').toLowerCase();
      const MAP = (window.ARCH_OVERLAYS_PATCHED||window.ARCH_OVERLAYS||{default:'rgba(0,0,0,0)'});
      const color = MAP[key] || MAP.default || 'rgba(0,0,0,0)';
      try{
        document.documentElement.style.setProperty('--arch-overlay', color);
        // If some panels manage strength separately, leave current value as-is when ON
      }catch(e){}
    };

    // On load, keep OFF if toggle is OFF
    const sel = document.getElementById('arch-select');
    const base = (sel?.value || '').replace(/\.html$/i,'');
    if(!LSget('arch:overlayOn', true)) setOverlayTransparent(); else window.applyArchOverlay(base);
  }

  if(document.readyState !== 'loading') gateApply();
  else document.addEventListener('DOMContentLoaded', gateApply);
})();
</script>
<!-- PATCH: ls-refresh-binder -->
<script>
(function(){
  function bind(){
    var b = document.getElementById('lsRefresh');
    if(b){ b.onclick = function(){ try{ location.reload(); }catch(e){} }; }
  }
  if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', bind); } else { bind(); }
})();
</script>
<!-- PATCH: overlay-guardian-js -->
<script id="overlay-guardian-js">
(function(){
  function readLSBool(key, d){ try{ var v = localStorage.getItem(key); return v ? JSON.parse(v) : d; }catch(e){ return d; } }
  function enforce(){
    var on = !!readLSBool('arch:overlayOn', false);
    document.documentElement.setAttribute('data-overlay', on ? 'on' : 'off');
    if(!on){
      try{
        document.documentElement.style.setProperty('--arch-overlay','rgba(0,0,0,0)');
        document.documentElement.style.setProperty('--arch-overlay-strength','0%');
        var fade = document.getElementById('arch-fadeCover');
        if(fade) fade.style.background = 'transparent';
      }catch(e){}
    }
  }
  function bind(){
    enforce();
    // Poll lightly to defeat late writers
    setInterval(enforce, 500);
    // Also react to storage changes (other tabs)
    window.addEventListener('storage', function(ev){ if(ev && ev.key==='arch:overlayOn'){ enforce(); } });
    // If there is a Brain toggle, hook it
    document.addEventListener('click', function(e){
      var t = e.target;
      if(!t) return;
      if(t.id==='overlayToggle' || t.closest && t.closest('#overlayToggle')){
        setTimeout(enforce, 60);
      }
    }, true);
  }
  if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', bind); } else { bind(); }
})();
</script>
<script src="./lib/UNO_patch_arch3d_bloom_loader.js" type="module"></script>
<script src="./lib/UNO_patch_arch3d_particles.js"></script>
<script src="./lib/dual_multiagent_v12_kobllux_locked.js"></script>
<script>
if ('serviceWorker' in navigator) {
  addEventListener('load', ()=>((location.protocol==='https:'||location.protocol==='http:')?navigator.serviceWorker.register:()=>Promise.reject('sw_disabled'))('./sw.js').catch(()=>{}));
}
</script>
<script>
/* ==========================================================================
   ORB WebGL (shader nebula) + Partículas 2D — escopo HUB
   ========================================================================== */
(function(){
  const canvas = document.getElementById('orb');
  if(!canvas) return;
  const gl = canvas.getContext('webgl', { antialias:true, alpha:true });
  if(!gl) return;

  const dpr = Math.min(2, window.devicePixelRatio||1);
  function resize(){
    const r = canvas.getBoundingClientRect();
    canvas.width = Math.floor(r.width*dpr);
    canvas.height = Math.floor(r.height*dpr);
    gl.viewport(0,0,canvas.width,canvas.height);
  }
  new ResizeObserver(resize).observe(canvas); resize();

  const vs = 'attribute vec2 aPos; varying vec2 vUv; void main(){ vUv=aPos*0.5+0.5; gl_Position=vec4(aPos,0.,1.);}';
  const fs = `precision highp float; varying vec2 vUv; uniform vec2 u_res; uniform float u_time; uniform float u_active;
  float hash(vec2 p){ return fract(sin(dot(p, vec2(127.1,311.7))) * 43758.5453123); }
  float noise(vec2 p){ vec2 i=floor(p); vec2 f=fract(p); float a=hash(i);
    float b=hash(i+vec2(1.,0.)); float c=hash(i+vec2(0.,1.)); float d=hash(i+vec2(1.,1.));
    vec2 u=f*f*(3.-2.*f); return mix(a,b,u.x)+(c-a)*u.y*(1.-u.x)+(d-b)*u.x*u.y; }
  vec3 cam(){ return vec3(0.,0.,3.); }
  vec3 getRay(vec2 uv){ uv=(uv*2.-1.); uv.x*=u_res.x/u_res.y; return normalize(vec3(uv,-1.8)); }
  bool isph(vec3 ro, vec3 rd, float r, out float t){
    float b=dot(ro,rd); float c=dot(ro,ro)-r*r; float h=b*b-c; if(h<0.){t=-1.;return false;}
    h=sqrt(h); t=-b-h; if(t<0.) t=-b+h; if(t<0.) return false; return true; }
  void main(){
    vec2 uv=vUv; vec3 ro=cam(); vec3 rd=getRay(uv);
    float t; vec3 col=vec3(0.02,0.03,0.07); vec3 fogCol=vec3(0.07,0.09,0.16);
    float g=noise(uv*6.+u_time*0.05)*0.25; col+=vec3(0.25,0.08,0.55)*g*0.6+vec3(0.0,0.35,0.55)*g*0.4;
    if(isph(ro,rd,1.,t)){
      vec3 p=ro+rd*t; vec3 n=normalize(p);
      float bands=0.5+0.5*sin(6.*p.x+5.*p.y+u_time*0.6);
      float swirl=noise(p.xy*4.+u_time*0.2);
      vec3 A=vec3(0.52,0.24,1.00), B=vec3(0.00,0.90,1.00);
      vec3 base=mix(A,B, clamp(bands*0.6+swirl*0.4,0.,1.));
      vec3 L=normalize(vec3(0.6,0.7,0.5));
      float diff=max(dot(n,L),0.); float rim=pow(1.-max(dot(n,-rd),0.), 2.);
      float pulse=0.5+0.5*sin(u_time*1.5); float act=mix(0.6,1.0,u_active);
      vec3 c=base*(0.35+0.75*diff*act)+(B*0.6+A*0.4)*rim*(0.6+0.4*pulse);
      float fogAmt=1.0-exp(-t*0.35); col=mix(c,fogCol,fogAmt*0.25);
    }else{
      vec2 centered=uv-0.5; centered.x*=u_res.x/u_res.y;
      float d=length(centered); float outer=smoothstep(0.58,0.12,d);
      vec3 halo=vec3(0.25,0.12,0.55)*outer*0.35+vec3(0.00,0.55,0.95)*outer*0.25;
      col+=halo;
    }
    float vign=smoothstep(1.2,0.55, length((uv-0.5)*vec2(u_res.x/u_res.y,1.)));
    col*=vign; gl_FragColor=vec4(col,0.98);
  }`;
  function sh(type,src){ const s=gl.createShader(type); gl.shaderSource(s,src); gl.compileShader(s); return s; }
  const pr=gl.createProgram(); gl.attachShader(pr,sh(gl.VERTEX_SHADER,vs)); gl.attachShader(pr,sh(gl.FRAGMENT_SHADER,fs)); gl.linkProgram(pr); gl.useProgram(pr);
  const buf=gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER,buf); gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1, 1,-1,1,1,-1,1]),gl.STATIC_DRAW);
  const loc=gl.getAttribLocation(pr,'aPos'); gl.enableVertexAttribArray(loc); gl.vertexAttribPointer(loc,2,gl.FLOAT,false,0,0);
  const uRes=gl.getUniformLocation(pr,'u_res'); const uTime=gl.getUniformLocation(pr,'u_time'); const uActive=gl.getUniformLocation(pr,'u_active');
  let start=performance.now(), active=0.0;
  function draw(){ const t=(performance.now()-start)*0.001; gl.uniform2f(uRes,canvas.width,canvas.height); gl.uniform1f(uTime,t); gl.uniform1f(uActive,active); gl.drawArrays(gl.TRIANGLES,0,6); requestAnimationFrame(draw) }
  draw();
  window.__orbGL__ = {
    setActive:(v)=>{ active=v?1.0:0.0; },
    pulse:()=>{ let k=0,steps=24; const id=setInterval(()=>{ active=Math.min(1,active+0.06); if(++k>=steps) clearInterval(id);},16);
                setTimeout(()=>{ let j=0; const id2=setInterval(()=>{ active=Math.max(0,active-0.06); if(++j>=steps) clearInterval(id2);},16);},380); }
  };
})();

(function particles2D(){
  const c=document.getElementById('particles'); if(!c) return;
  const ctx=c.getContext('2d'); const dpr=Math.min(2,window.devicePixelRatio||1);
  function rs(){ const r=c.getBoundingClientRect(); c.width=Math.floor(r.width*dpr); c.height=Math.floor(r.height*dpr); }
  new ResizeObserver(rs).observe(c); rs();
  const N=90, nodes=Array.from({length:N},()=>({a:Math.random()*6.283, r:0.42+Math.random()*0.48, s:(0.2+Math.random()*0.7)*(Math.random()<0.5?-1:1), z:0.5+Math.random()*0.5, hue:200+Math.random()*160}));
  function draw(t){ ctx.clearRect(0,0,c.width,c.height); ctx.save(); ctx.globalCompositeOperation='lighter'; ctx.translate(c.width/2,c.height/2); const scale=Math.min(c.width,c.height)/2;
    for(const n of nodes){
      const a=n.a + t*0.00025*n.s, r=n.r + 0.03*Math.sin(t*0.0005+n.a);
      const x=Math.cos(a)*r*scale, y=Math.sin(a)*r*scale;
      const g=ctx.createRadialGradient(x,y,0, x,y, 6 + n.z*8);
      g.addColorStop(0, `hsla(${n.hue}, 85%, 65%, ${0.38*n.z})`);
      g.addColorStop(1, 'rgba(0,0,0,0)');
      ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y, 2.5 + n.z*3.0, 0, Math.PI*2); ctx.fill();
    }
    ctx.restore(); requestAnimationFrame(draw);
  }
  requestAnimationFrame(draw);
})();

// Pulsar no clique direto no wrap
document.getElementById('orbWrap')?.addEventListener('click', function(){ try{ window.__orbGL__ && window.__orbGL__.pulse(); }catch(_){ } });
</script>
<script id="orb-slot-and-archpersist-patch">
(function(){
  // ---- Helpers ----
  function $(q, r=document){ return r.querySelector(q); }
  function baseName(file){ return String(file||'').replace(/\.html$/i,'').toLowerCase(); }

  // ---- Create orb-slot and move the iframe inside the orb ----
  function fuseIframeIntoOrb(){
    var wrap = $('#orbWrap');
    var frame = $('#arch-frame');
    if(!wrap || !frame) return;
    // If already fused, skip
    if (frame.parentElement && frame.parentElement.classList && frame.parentElement.classList.contains('orb-slot')) return;
    var slot = document.createElement('div');
    slot.className = 'orb-slot';
    // Insert slot above particles but below ring (order controlled by CSS z-index)
    wrap.appendChild(slot);
    // Move iframe inside slot
    slot.appendChild(frame);
  }

  // ---- Archetype persistence (uno:arch) + overlay/apply + Firestore sync ----
  function currentSelectBase(){
    var sel = $('#arch-select'); if(!sel) return '';
    var opt = sel.options[sel.selectedIndex];
    return baseName(opt && opt.value);
  }
  function applyArch(base){
    var sel = $('#arch-select'), frame = $('#arch-frame'), fade = $('#arch-fadeCover');
    if(!sel || !frame) return;
    var idx = -1;
    for (var i=0;i<sel.options.length;i++){
      if (baseName(sel.options[i].value) === base){ idx = i; break; }
    }
    if (idx >= 0){
      sel.selectedIndex = idx;
      if (fade) fade.classList.add('show');
      var file = sel.options[idx].value;
      frame.src = './archetypes/' + file;
      try { if (typeof window.applyArchOverlay === 'function') window.applyArchOverlay(base); } catch(_){}
      try { if (typeof window.speakArchetype === 'function') window.speakArchetype(base); } catch(_){}
      try { if (typeof window.updateHomeStatus === 'function') window.updateHomeStatus(); } catch(_){}
      setTimeout(function(){ if (fade) fade.classList.remove('show'); }, 240);
    }
  }
  function saveArch(base){
    if(!base) return;
    try { localStorage.setItem('uno:arch', base); } catch(_){}
    // If a shared app state exists, mirror and save remotely
    try {
      if (window.S && S.state){
        S.state.archetype = base;
        if (typeof window.saveState === 'function') saveState(S.state);
      }
    } catch(_){}
  }
  function bindArchPersistence(){
    var sel = $('#arch-select'), prev = $('#arch-prev'), next = $('#arch-next');
    function persist(){ var b=currentSelectBase(); if(b){ saveArch(b);} }
    if (sel) sel.addEventListener('change', persist, {passive:true});
    if (prev) prev.addEventListener('click', function(){ setTimeout(persist, 0); }, {passive:true});
    if (next) next.addEventListener('click', function(){ setTimeout(persist, 0); }, {passive:true});
    // Accept remote notifications
    window.addEventListener('message', function(ev){
      var d = ev && ev.data || {};
      if (d && d.type==='archReady' && d.name){
        var b = baseName(d.name);
        saveArch(b);
      }
    });
  }
  function bootWithSavedArch(){
    var saved = (localStorage.getItem('uno:arch') || localStorage.getItem('infodose:arch') || '').replace(/\.html$/i,'');
    saved = baseName(saved);
    if(saved){
      var cur = currentSelectBase();
      if (cur !== saved) applyArch(saved);
    } else {
      // Initialize with current
      saveArch(currentSelectBase());
    }
  }

  function start(){
    fuseIframeIntoOrb();
    bindArchPersistence();
    bootWithSavedArch();
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', start);
  else start();
})();
</script>
<script id="arch-chips-3d-layers">
// BLOOM TOGGLE: persist in localStorage('dual.ui.bloom'), add button above chips
(function(){ 
  const _bState = (localStorage.getItem('dual.ui.bloom') === '1');
  function sendBloom(enabled){
    try{
      const fr = document.getElementById('arch-frame');
      if(fr && fr.contentWindow) fr.contentWindow.postMessage({ type:'bloomToggle', enabled: !!enabled }, '*');
      // Adjust overlay intensity when bloom enabled
      document.documentElement.style.setProperty('--arch-overlay-intensity', enabled? '0.45' : '0.35');
    }catch(e){}
  }
  // ensure we send initial state on boot after DOM ready
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ()=> sendBloom(_bState) );
  } else sendBloom(_bState);
  // expose helper for the chip script to create the button
  window._dual_bloom_state = _bState;
  window._dual_bloom_send = sendBloom;
})();
(function(){
  // Minimal palettes (sync with your overlay colors)
  const COLORS = {
    atlas:'#409EFF', nova:'#FF52B1', vitalis:'#34D399', pulse:'#00BFFF',
    artemis:'#FFC300', serena:'#B684FF', kaos:'#FF4D6D', genus:'#22C55E',
    lumine:'#FFD54F', rhea:'#00D1B2', solus:'#6495ED', aion:'#8B5CF6'
  };
  const PRESET = name => ({
    name,
    color: COLORS[name] || '#88a',
    count: (name==='nova'||name==='pulse'||name==='lumine') ? 340 : 260,
    orbitRadius: (name==='nova'||name==='serena'||name==='lumine') ? 0.76 : 0.68,
    spin: (name==='nova'||name==='pulse') ? 0.7 : 0.56,
    size: 0.010, // sphere size
    glow: 0.42
  });

  const ACTIVE = new Set();
  function sendLayers(){
    const fr = document.getElementById('arch-frame');
    if (!fr || !fr.contentWindow) return;
    const arr = Array.from(ACTIVE).map(n => PRESET(n));
    fr.contentWindow.postMessage({ type:'atomConfigLayers', layers: arr }, '*');
  }

  function chipEl(name){
    const b = document.createElement('button');
    b.className = 'arch-chip';
    b.textContent = name[0].toUpperCase()+name.slice(1);
    b.style.borderColor = 'rgba(255,255,255,.18)';
    b.style.background = 'rgba(255,255,255,.06)';
    b.onclick = ()=>{
      if (ACTIVE.has(name)) ACTIVE.delete(name); else ACTIVE.add(name);
      b.classList.toggle('on', ACTIVE.has(name));
      sendLayers();
    };
    return b;
  }

  function ensureStyles(){
    if (document.getElementById('archChip3DStyles')) return;
    const st = document.createElement('style'); st.id='archChip3DStyles';
    st.textContent = `
      .arch-chip-wrap{ display:grid; grid-template-columns: repeat(auto-fill,minmax(92px,1fr)); gap:8px; }
      .arch-chip{ appearance:none; border:1px solid var(--ring, rgba(255,255,255,.18)); background: var(--glass, rgba(255,255,255,.06)); color: var(--txt, #eaf2ff);
        padding:8px 10px; border-radius:999px; font-size:12px; letter-spacing:.2px; cursor:pointer; }
      .arch-chip.on{ background: rgba(57,255,182,.18); border-color: rgba(57,255,182,.45); }
      .arch-chip-title{ font-size:12px; color: var(--muted,#a6b0c0); margin: 6px 0 6px; font-weight:800; }
    `;
    document.head.appendChild(st);
  }

  function injectInLSPanel(){
    ensureStyles();
    const panel = document.getElementById('lsPanel') || document.querySelector('#lsModal .ls-panel');
    if (!panel || document.getElementById('archChip3DSection')) return;
    const sec = document.createElement('div');
    sec.id = 'archChip3DSection';
    sec.className = 'preset';
    sec.style.marginTop = '10px';
    sec.innerHTML = `<div class="arch-chip-title">Arquétipos (camadas no ORB · 3D)</div>`;
    const wrap = document.createElement('div'); wrap.className = 'arch-chip-wrap';
    ['atlas','nova','vitalis','pulse','artemis','serena','kaos','genus','lumine','rhea','solus','aion'].forEach(n=> wrap.appendChild(chipEl(n)));
    sec.appendChild(wrap);
    // === Bloom toggle (insert above chips) ===
    const bloomWrap = document.createElement('div');
    bloomWrap.style.display = 'flex'; bloomWrap.style.alignItems = 'center'; bloomWrap.style.justifyContent = 'space-between';
    bloomWrap.style.marginBottom = '8px';
    const lbl = document.createElement('div'); lbl.textContent = 'Bloom Nébula'; lbl.className='arch-chip-title'; lbl.style.margin='0'; lbl.style.fontSize='12px';
    const toggle = document.createElement('button'); toggle.id='toggleBloomBtn'; toggle.className='arch-chip'; toggle.style.minWidth='92px';
    const state = (localStorage.getItem('dual.ui.bloom') === '1') || !!window._dual_bloom_state;
    if(state) toggle.classList.add('on');
    toggle.textContent = state ? 'Bloom: ON' : 'Bloom: OFF';
    toggle.onclick = function(){
      const now = !toggle.classList.contains('on');
      toggle.classList.toggle('on', now);
      toggle.textContent = now ? 'Bloom: ON' : 'Bloom: OFF';
      try{ localStorage.setItem('dual.ui.bloom', now? '1':'0'); }catch(_){}
      if (window._dual_bloom_send) window._dual_bloom_send(now);
      // send message to iframe as well for immediate toggle
      try{ const f = document.getElementById('arch-frame'); if(f && f.contentWindow) f.contentWindow.postMessage({ type: 'bloomToggle', enabled: !!now }, '*'); }catch(_){}
    };
    sec.insertBefore(bloomWrap, sec.firstChild);
    bloomWrap.appendChild(lbl);
    bloomWrap.appendChild(toggle);
    
    // Coloca no topo do LS Panel
    const hdr = panel.querySelector('.ls-hdr');
    if (hdr && hdr.parentNode) hdr.parentNode.insertBefore(sec, hdr.nextSibling);
    // Ativa por padrão a camada do arquétipo atual
    try{
      const sel = document.getElementById('arch-select');
      const cur = (sel && sel.value || 'atlas.html').replace(/.*\//,'').replace(/\.html$/i,'');
      const btn = wrap.querySelector('button.arch-chip:nth-child(' + (['atlas','nova','vitalis','pulse','artemis','serena','kaos','genus','lumine','rhea','solus','aion'].indexOf(cur)+1) + ')');
      if (cur && btn){ ACTIVE.add(cur); btn.classList.add('on'); sendLayers(); }
    }catch(_){}
  }

  function bindLSButton(){
    const btn = document.getElementById('btnLS');
    if (btn && !btn.dataset._chipsHook){
      btn.dataset._chipsHook = '1';
      btn.addEventListener('click', ()=> setTimeout(injectInLSPanel, 80), {passive:true});
    } else {
      // if already open
      setTimeout(injectInLSPanel, 120);
    }
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bindLSButton);
  else bindLSButton();

  // Also re-inject if LS modal gets rebuilt
  document.addEventListener('ls:disabled-changed', ()=> setTimeout(injectInLSPanel, 60));
})();
</script>
<!-- LSPANEL MASTER FIX v3.7.1 — CSS -->
<!-- LSPANEL MASTER FIX v3.7.1 — robust injector -->
<script id="lspanel-masterfix-js">
(function(){
  // helpers
  const $ = (q,r=document)=>r.querySelector(q);
  const $$ = (q,r=document)=>Array.from(r.querySelectorAll(q));
  function setLS(k,v){ try{ localStorage.setItem(k,String(v)); }catch(_){ } }
  function getNum(k,d){ try{ const v=localStorage.getItem(k); return v==null? d : parseFloat(v); }catch(_){ return d; } }
  function getFlag(k,d){ try{ const v=localStorage.getItem(k); return v==null? d : v==='1'; }catch(_){ return d; } }

  // defaults (perf + atom)
  const DEF = { target:50, minS:96, minR:80, cap:360, dn:0.85, up:1.06 };
  const KP  = {
    en:'dual.perf.enable', tgt:'dual.perf.target', s:'dual.perf.minSingle', r:'dual.perf.minRing', cap:'dual.perf.maxCap', dn:'dual.perf.stepDown', up:'dual.perf.stepUp'
  };
  if(localStorage.getItem(KP.en)==null) setLS(KP.en,'1');
  if(localStorage.getItem(KP.tgt)==null) setLS(KP.tgt, DEF.target);
  if(localStorage.getItem(KP.s)==null)   setLS(KP.s,   DEF.minS);
  if(localStorage.getItem(KP.r)==null)   setLS(KP.r,   DEF.minR);
  if(localStorage.getItem(KP.cap)==null) setLS(KP.cap, DEF.cap);
  if(localStorage.getItem(KP.dn)==null)  setLS(KP.dn,  DEF.dn);
  if(localStorage.getItem(KP.up)==null)  setLS(KP.up,  DEF.up);
  if(localStorage.getItem('dual.atom.count')==null) setLS('dual.atom.count', 160);
  if(localStorage.getItem('dual.atom.orbit')==null) setLS('dual.atom.orbit', 0.74);
  if(localStorage.getItem('dual.atom.glow')==null)  setLS('dual.atom.glow',  0.38);
  if(localStorage.getItem('dual.ui.bloom')==null)   setLS('dual.ui.bloom',   0);
  document.body.setAttribute('data-orb-solid','off');

  function panel(){
    return $('#lsPanel') || $('#lsModal .ls-panel') || $('.ls-panel') || $('.panel-ls') || $('.settings-panel');
  }

  function ensureSection(){
    const p = panel();
    if(!p || $('#perfControlsV371')) return;
    const tgt=getNum(KP.tgt,DEF.target), ms=getNum(KP.s,DEF.minS), mr=getNum(KP.r,DEF.minR), cap=getNum(KP.cap,DEF.cap), dn=getNum(KP.dn,DEF.dn), up=getNum(KP.up,DEF.up), en=getFlag(KP.en,true);
    const sec = document.createElement('section'); sec.id='perfControlsV371';
    sec.innerHTML = `
      <div class="section-title">Desempenho (FPS Target)</div>
      <div id="perfHud">
        <div class="stats">
          <span class="badge">FPS: <strong id="hudFps">—</strong></span>
          <span class="badge">Meta: <strong id="hudTarget">${tgt}</strong></span>
        </div>
        <button id="perfEnable" class="pill-btn ${en?'on':''}">${en?'Auto':'Manual'}</button>
      </div>
      <div class="line">
        <label>Meta de FPS</label>
        <div><input id="fpsTarget" type="range" min="30" max="60" step="1" value="${tgt}" /><output id="fpsTargetOut">${tgt}</output></div>
      </div>
      <div class="line">
        <label>Min (single)</label>
        <div><input id="minSingle" type="range" min="48" max="160" step="2" value="${ms}" /><output id="minSingleOut">${ms}</output></div>
      </div>
      <div class="line">
        <label>Min por anel</label>
        <div><input id="minRing" type="range" min="48" max="160" step="2" value="${mr}" /><output id="minRingOut">${mr}</output></div>
      </div>
      <div class="line">
        <label>Máximo</label>
        <div><input id="maxCap" type="range" min="160" max="680" step="10" value="${cap}" /><output id="maxCapOut">${cap}</output></div>
      </div>
      <div class="line">
        <label>Passo Reduzir</label>
        <div><input id="stepDn" type="range" min="0.70" max="0.95" step="0.01" value="${dn}" /><output id="stepDnOut">${dn.toFixed(2)}</output></div>
      </div>
      <div class="line">
        <label>Passo Aumentar</label>
        <div><input id="stepUp" type="range" min="1.01" max="1.15" step="0.01" value="${up}" /><output id="stepUpOut">${up.toFixed(2)}</output></div>
      </div>
      <div class="section-title">Partículas do Átomo — SAFE</div>
      <div class="line">
        <label>Quantidade</label>
        <div><input id="safe-count" type="range" min="48" max="220" step="4" value="${getNum('dual.atom.count',160)}" /><output id="safe-count-out">${getNum('dual.atom.count',160)}</output></div>
      </div>
      <div class="line">
        <label>Órbita</label>
        <div><input id="safe-orbit" type="range" min="0.60" max="0.86" step="0.01" value="${getNum('dual.atom.orbit',0.74)}" /><output id="safe-orbit-out">${getNum('dual.atom.orbit',0.74).toFixed(2)}</output></div>
      </div>
      <div class="line">
        <label>Glow</label>
        <div><input id="safe-glow" type="range" min="0.00" max="1.00" step="0.01" value="${getNum('dual.atom.glow',0.38)}" /><output id="safe-glow-out">${getNum('dual.atom.glow',0.38).toFixed(2)}</output></div>
      </div>
    `;
    p.prepend(sec);

    // binds
    function bindR(id, k, fmt=(v)=>v){
      const el = $('#'+id), out=$('#'+id+'Out'); if(!el) return;
      el.addEventListener('input', ()=>{ const val=parseFloat(el.value); out && (out.textContent=fmt(val)); setLS(k, val); $('#hudTarget') && (id==='fpsTarget') && ($('#hudTarget').textContent=String(val)); });
    }
    bindR('fpsTarget', KP.tgt);
    bindR('minSingle', KP.s);
    bindR('minRing',   KP.r);
    bindR('maxCap',    KP.cap);
    bindR('stepDn',    KP.dn, (v)=>v.toFixed(2));
    bindR('stepUp',    KP.up, (v)=>v.toFixed(2));

    ['safe-count','safe-orbit','safe-glow'].forEach(id=>{
      const el=$('#'+id), out=$('#'+id+'-out'); el && el.addEventListener('input', ()=>{ out && (out.textContent = id==='safe-count'? el.value : parseFloat(el.value).toFixed(2)); setLS(el.id==='safe-count'?'dual.atom.count': el.id==='safe-orbit'?'dual.atom.orbit':'dual.atom.glow', el.value); });
    });

    const enBtn = $('#perfEnable'); enBtn && enBtn.addEventListener('click', ()=>{
      const now=!enBtn.classList.contains('on'); enBtn.classList.toggle('on',now); enBtn.textContent = now? 'Auto':'Manual'; setLS(KP.en, now?'1':'0');
    });

    // Live HUD FPS
    let L=performance.now(), F=0;
    function hudTick(t){ F++; if(t-L>=1000){ const fps=F; F=0; L=t; $('#hudFps') && ($('#hudFps').textContent=fps); } requestAnimationFrame(hudTick); }
    requestAnimationFrame(hudTick);
  }

  // robust triggers
  function bind(){
    // when LS opens
    const btn = document.getElementById('btnLS') || [...document.querySelectorAll('button,[role="button"]')].find(b=>/ls|painel|config|settings/i.test((b.textContent||'')+(b.id||'')+(b.className||'')));
    if(btn && !btn.dataset._masterfix){ btn.dataset._masterfix='1'; btn.addEventListener('click', ()=> setTimeout(ensureSection, 120), {passive:true}); }
    // also try on boot and on modal toggle
    setTimeout(ensureSection, 300);
    document.addEventListener('ls:disabled-changed', ()=> setTimeout(ensureSection, 120));
    document.getElementById('arch-frame')?.addEventListener('load', ()=> setTimeout(ensureSection, 200));
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', bind); else bind();
})();
</script>
<script id="hdpro-override-js">

// === HD•PRO Override (Dual UNO) ===================================
(function(){
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
  const on = (el, ev, fn) => el && el.addEventListener(ev, fn);

  function toast(msg, ms=1800){
    let t = $('#hdToast'); 
    if(!t){ t = document.createElement('div'); t.id='hdToast'; document.body.appendChild(t); }
    t.textContent = msg;
    t.classList.add('show');
    clearTimeout(t.__t); t.__t = setTimeout(()=>t.classList.remove('show'), ms);
  }

  // 1) Handle quase invisível para abrir/fechar LS panel (#brain)
  function mountHandle(){
    if($('#lsHandle')) return;
    const btn = document.createElement('button');
    btn.id = 'lsHandle';
    btn.title = 'Abrir/fechar painel (LS)';
    document.body.appendChild(btn);

    function toggleBrain(){
      const brain = $('#brain');
      if(!brain){ toast('Painel LS não encontrado (#brain)'); return; }
      brain.classList.toggle('hide');
      btn.classList.toggle('on', !brain.classList.contains('hide'));
    }
    on(btn, 'click', toggleBrain);
  }

  // 2) Painel HD Pro dentro do #brain (LS Panel)
  function mountHDPro(){
    const brain = $('#brain .popover') || $('#brain');
    if(!brain || brain.__hdproMounted) return;
    brain.__hdproMounted = true;

    // Secção base
    const sec = document.createElement('section');
    sec.className = 'hdpro-sec';
    sec.innerHTML = `
      <div class="sec-hdr">
        <h3>HD • Pro — Sistema</h3>
        <button class="hd-btn ok" id="hdRefresh">Atualizar</button>
      </div>

      <div class="hdpro-grid">
        <div class="hdpro-row">
          <div>
            <div class="hdpro-label">LocalStorage</div>
            <div class="hdpro-meter"><div class="bar" id="barLS"></div></div>
          </div>
          <div class="hdpro-val" id="valLS">–</div>
        </div>

        <div class="hdpro-row">
          <div>
            <div class="hdpro-label">IndexedDB (estimado)</div>
            <div class="hdpro-meter"><div class="bar" id="barIDB"></div></div>
          </div>
          <div class="hdpro-val" id="valIDB">–</div>
        </div>

        <div class="hdpro-row">
          <div>
            <div class="hdpro-label">Total (Storage API)</div>
            <div class="hdpro-meter"><div class="bar" id="barTotal"></div></div>
          </div>
          <div class="hdpro-val" id="valTotal">–</div>
        </div>

        <div class="hdpro-actions">
          <button class="hd-btn" id="btnToggleOrb">Ocultar opções avançadas do ORB/FPS</button>
          <button class="hd-btn" id="btnImportFix">Importar HTML (corrigido)</button>
          <input id="__fileImportHD" type="file" accept=".html,.htm" style="display:none" />
          <button class="hd-btn danger" id="btnClearLS">Limpar LocalStorage</button>
          <button class="hd-btn danger" id="btnClearIDB">Limpar IndexedDB</button>
        </div>
      </div>
    `;
    brain.appendChild(sec);

    // 2a) Toggle avançados ORB/FPS
    on($('#btnToggleOrb', sec), 'click', ()=>{
      const advSelectors = [
        '[data-orb-adv]',
        '#orbAdv', '.orb-adv', '.orb-advanced', '[data-orb-advanced]',
        '#fpsPanel', '.fps-adv', '#orbControls', '.orb-controls'
      ];
      let toggled = 0;
      advSelectors.forEach(sel => {
        $$(sel).forEach(el => { 
          el.classList.toggle('hdpro-adv-hidden'); 
          toggled++;
        });
      });
      toast(toggled ? 'Avançados ORB/FPS alternados' : 'Nenhum bloco avançado encontrado');
    });

    // 2b) Import corrigido (abre HTML local numa sessão dentro do app, fallback nova aba)
    const fileInput = $('#__fileImportHD', sec);
    on($('#btnImportFix', sec), 'click', ()=> fileInput && fileInput.click());
    on(fileInput, 'change', (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      const url = URL.createObjectURL(file);
      const name = file.name || 'arquivo.html';
      // destino preferencial
      const anchor = $('#sessionsAnchor') || $('#stackWrap') || $('#v-stack') || $('main');
      if(anchor){
        const wrap = document.createElement('div');
        wrap.className = 'session';
        wrap.innerHTML = `
          <div class="hdr">
            <span class="app-icon">${(name[0]||'W').toUpperCase()}</span>
            <span class="title">${name}</span>
            <div class="tools">
              <button class="btn" data-act="min">Min</button>
              <button class="btn" data-act="full">Full</button>
              <button class="btn" data-act="close">Fechar</button>
            </div>
          </div>
          <iframe src="${url}" referrerpolicy="no-referrer"></iframe>
          <div class="resize-handle" title="Arraste para ajustar altura"></div>
        `;
        anchor.appendChild(wrap);
        // Tools
        on(wrap.querySelector('[data-act="min"]'), 'click', ()=> wrap.classList.toggle('min'));
        on(wrap.querySelector('[data-act="full"]'), 'click', ()=> document.body.classList.toggle('session-full'));
        on(wrap.querySelector('[data-act="close"]'), 'click', ()=> wrap.remove());
        toast('HTML importado dentro do Stack');
      }else{
        window.open(url, '_blank', 'noopener');
        toast('HTML aberto em nova aba');
      }
      e.target.value = '';
    });

    // 2c) Limpar LocalStorage
    on($('#btnClearLS', sec), 'click', ()=>{
      if(confirm('Limpar todo o LocalStorage deste domínio?')){
        try { localStorage.clear(); toast('LocalStorage limpo'); updateMeters(true); }
        catch(err){ console.error(err); toast('Erro ao limpar LocalStorage'); }
      }
    });

    // 2d) Limpar IndexedDB (melhor esforço)
    on($('#btnClearIDB', sec), 'click', async ()=>{
      if(!confirm('Apagar bancos IndexedDB deste domínio?')) return;
      try{
        if(indexedDB.databases){
          const dbs = await indexedDB.databases();
          await Promise.all((dbs||[]).map(d => d && d.name ? new Promise((res)=>{
            const req = indexedDB.deleteDatabase(d.name);
            req.onsuccess = req.onerror = req.onblocked = ()=>res();
          }) : Promise.resolve()));
        }else{
          // Sem enumerate: tente deletar bases comuns do app
          const common = ['dual', 'uno', 'app', 'db', 'files', 'store'];
          await Promise.all(common.map(n => new Promise((res)=>{
            const req = indexedDB.deleteDatabase(n); req.onsuccess = req.onerror = req.onblocked = ()=>res();
          })));
        }
        toast('IndexedDB: pedido de exclusão enviado'); updateMeters(true);
      }catch(err){
        console.error(err); toast('IndexedDB: não suportado/erro');
      }
    });

    // 2e) Atualizar medidores
    on($('#hdRefresh', sec), 'click', ()=> updateMeters(true));

    async function estimateStorage(){
      const est = (navigator.storage && navigator.storage.estimate) ? await navigator.storage.estimate() : {};
      // est.usage (bytes) inclui IDB + Cache + etc (depende do UA)
      // LS estimado manualmente (2 bytes por char em UTF-16)
      let lsBytes = 0;
      try{
        for(let i=0;i<localStorage.length;i++){
          const k = localStorage.key(i);
          const v = localStorage.getItem(k);
          lsBytes += 2*((k||'').length + (v||'').length);
        }
      }catch{}
      // Experimento: idbBytes ~ usage - lsBytes (aprox)
      const usage = est.usage || 0;
      const quota = est.quota || 0;
      const idbBytes = Math.max(0, usage - lsBytes);

      return { lsBytes, idbBytes, usage, quota };
    }

    function fmt(bytes){
      const u = ['B','KB','MB','GB','TB'];
      let i=0, n=bytes;
      while(n>=1024 && i<u.length-1){ n/=1024; i++; }
      return `${n.toFixed( (i<=1)?0:1)} ${u[i]}`;
    }

    async function updateMeters(animateNumbers){
      try{
        const {lsBytes, idbBytes, usage, quota} = await estimateStorage();
        const els = {
          barLS: $('#barLS'), valLS: $('#valLS'),
          barIDB: $('#barIDB'), valIDB: $('#valIDB'),
          barTotal: $('#barTotal'), valTotal: $('#valTotal'),
        };
        const percent = (num, den) => (den>0)? Math.min(100, Math.round((num/den)*100)) : 0;
        // Total can use quota as denominator; LS use typical 5MB baseline to visualize
        const lsCap = 5*1024*1024; // 5MB
        const pLS = percent(lsBytes, lsCap);
        const pIDB = quota ? percent(idbBytes, quota) : 0;
        const pTot = percent(usage, quota);

        if(els.barLS) els.barLS.style.width = pLS + '%';
        if(els.barIDB) els.barIDB.style.width = pIDB + '%';
        if(els.barTotal) els.barTotal.style.width = pTot + '%';

        const setNum = (el, val) => { if(el) el.textContent = val; };
        if(animateNumbers){
          animateCount( $('#valLS'), lsBytes );
          animateCount( $('#valIDB'), idbBytes );
          animateCount( $('#valTotal'), usage );
        }else{
          setNum( $('#valLS'), fmt(lsBytes) );
          setNum( $('#valIDB'), fmt(idbBytes) );
          setNum( $('#valTotal'), `${fmt(usage)} / ${quota?fmt(quota):'–'}` );
        }
      }catch(err){ console.error(err); }
    }

    function animateCount(el, bytes){
      if(!el) return;
      const target = bytes;
      const start = parseFloat(el.getAttribute('data-last')||'0');
      const startTime = performance.now();
      const dur = 600;
      function step(t){
        const k = Math.min(1, (t - startTime)/dur);
        const v = Math.round(start + (target-start)*k);
        el.textContent = ( (k<1) ? (v + ' B') : (fmt(target)) );
        if(k<1) requestAnimationFrame(step);
        else el.setAttribute('data-last', String(target));
      }
      requestAnimationFrame(step);
    }

    updateMeters(false);
    // Atualização periódica (leve)
    sec.__interval = setInterval(()=> updateMeters(false), 2500);
  }

  // 3) Start
  function boot(){
    mountHandle();
    mountHDPro();
  }
  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', boot);
  else boot();

})();

</script>
<script id="ATOM_ENGINE_PATCH">
(function(){
  if (window.__ATOM_PATCH__) return; window.__ATOM_PATCH__ = true;
  const ATOM_PALETTES = {
    default : { core:'#7a5bff', ring:'#39ffb6', dust:'#8fd6ff', bg:'#0b0f14' },
    dopamina: { core:'#ff2d7a', ring:'#ff77aa', dust:'#ffd1e2', bg:'#14080f' },
    delta7  : { core:'#ffb300', ring:'#ff8400', dust:'#ffe0a6', bg:'#140f08' },
    asc11   : { core:'#00e6ff', ring:'#39ffb6', dust:'#baf6ff', bg:'#0b0f14' },
    quan    : { core:'#b347ff', ring:'#9d7aff', dust:'#e2ccff', bg:'#110b14' },
    orionis : { core:'#00ffab', ring:'#00ffc9', dust:'#c8fff1', bg:'#08140f' },
    lumenflux:{core:'#9fd3ff', ring:'#e7f0ff', dust:'#ffffff', bg:'#0c121a' },
    vermiph : { core:'#ff6282', ring:'#ff3d5e', dust:'#ffc0cb', bg:'#14080b' }
  };
  const $=(s,r=document)=>r.querySelector(s);
  const arc=$('.arch-circle'); if(!arc) return;
  let fab=arc.querySelector('.arch-fab'); if(!fab){ fab=document.createElement('button'); fab.className='arch-fab'; fab.title='Trocar paleta do átomo'; fab.innerHTML='✦'; arc.appendChild(fab); }
  let cvs=document.getElementById('atomCanvas'); if(!cvs){ cvs=document.createElement('canvas'); cvs.id='atomCanvas'; arc.appendChild(cvs); }
  const ctx=cvs.getContext('2d');
  const DPR=()=> (window.devicePixelRatio||1); let W=0,H=0,CX=0,CY=0;
  function resize(){ const r=arc.getBoundingClientRect(); W=Math.floor(r.width); H=Math.floor(r.height);
    const d=DPR(); cvs.width=Math.max(1,Math.floor(W*d)); cvs.height=Math.max(1,Math.floor(H*d)); cvs.style.width=W+'px'; cvs.style.height=H+'px'; ctx.setTransform(d,0,0,d,0,0); CX=W/2; CY=H/2;}
  resize(); addEventListener('resize', resize);
  const N=120, parts=[]; (function init(){ for(let i=0;i<N;i++){ const radius=0.18+Math.random()*0.34, speed=(Math.random()*0.6+0.2)*(Math.random()<.5?1:-1);
    parts.push({phi:Math.random()*Math.PI*2,r:radius,s:speed,size:1+Math.random()*2,jitter:Math.random()*0.03}); } })();
  let PALETTE=ATOM_PALETTES.asc11; function setAtomPalette(n){ PALETTE=ATOM_PALETTES[n]||ATOM_PALETTES.default; try{ fab.style.boxShadow=`0 0 0 1px ${PALETTE.core}55 inset, 0 10px 22px ${PALETTE.core}33`; }catch(_){} }
  (function hookTheme(){ const map={dopamina:'dopamina',delta7:'delta7',asc11:'asc11',quan:'quan',orionis:'orionis',lumenflux:'lumenflux',vermiph:'vermiph'};
    if(typeof window.setTheme==='function' && !window.__ATOM_WRAP_THEME__){ window.__ATOM_WRAP_THEME__=true; const orig=window.setTheme;
      window.setTheme=function(type){ const r=orig.apply(this,arguments); setAtomPalette(map[type]||'default'); return r; };
    } else { const th=document.body.getAttribute('data-theme'); setAtomPalette(th==='blue1'?'asc11':th==='medium'?'lumenflux':'default'); }
  })();
  const cycle=['asc11','dopamina','delta7','orionis','quan','lumenflux','vermiph']; let cidx=0; fab.addEventListener('click',()=>{ cidx=(cidx+1)%cycle.length; setAtomPalette(cycle[cidx]); });
  function draw(){ ctx.clearRect(0,0,W,H); const m=Math.min(W,H);
    const g=ctx.createRadialGradient(CX,CY,m*0.08,CX,CY,m*0.55); g.addColorStop(0,PALETTE.core+'22'); g.addColorStop(1,'transparent');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(CX,CY,m*0.55,0,Math.PI*2); ctx.fill();
    ctx.shadowColor=PALETTE.ring; ctx.shadowBlur=18; ctx.fillStyle=PALETTE.core; ctx.beginPath(); ctx.arc(CX,CY,m*0.06,0,Math.PI*2); ctx.fill(); ctx.shadowBlur=0;
    ctx.strokeStyle=PALETTE.ring+'cc'; ctx.lineWidth=1.4; ctx.beginPath(); ctx.arc(CX,CY,m*0.28,0,Math.PI*2); ctx.stroke();
    for(let i=0;i<parts.length;i++){ const p=parts[i]; p.phi+=(p.s*0.003); const rr=m*(0.14+p.r*0.42), x=CX+Math.cos(p.phi)*rr, y=CY+Math.sin(p.phi)*rr*(0.82+p.jitter*Math.sin(p.phi*3.0));
      ctx.fillStyle=PALETTE.dust; ctx.globalAlpha=0.75; ctx.beginPath(); ctx.arc(x,y,p.size,0,Math.PI*2); ctx.fill(); } ctx.globalAlpha=1;
    requestAnimationFrame(draw); } requestAnimationFrame(draw);
})();
</script>
<script id="CHAT13_JS">
(()=>{
const CHAT_BACKEND = "openrouter";
const OPENROUTER_CONF = {
  model: (localStorage.getItem('dual.openrouter.model') || 'openai/gpt-4o-mini'),
  endpoint: 'https://openrouter.ai/api/v1/chat/completions',
  key: localStorage.getItem('dual.keys.openrouter') || ''
};

const BLOCKS = [
  ["Sinal","Contextualize a intenção do usuário em 1 frase objetiva."],
  ["Mapa","Liste 3-5 pontos-chave do problema."],
  ["Hipóteses","Traga 3 hipóteses testáveis."],
  ["Dados","Quais dados mínimos precisamos coletar?"],
  ["Ações 10min","Aplique uma micro-ação que cabe em 10 minutos."],
  ["Riscos","Alerte sobre 2 riscos ou armadilhas."],
  ["Recursos","Sugira 3 recursos (apps, docs, pessoas)."],
  ["Sequência","Desenhe a ordem ótima em 4 passos."],
  ["Expansão","Mostre 2 variações criativas do caminho."],
  ["Métrica","Defina 1 métrica simples de sucesso."],
  ["Checkpoint","O que revisar em 24h?"],
  ["Compromisso","Gere 1 compromisso curto e claro."],
  ["Fecho","Feche com 1 frase que mantenha o pulso."]
];

function sanitize(md){
  const esc = (s)=>s.replace(/[&<>]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[m]));
  md = md.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
         .replace(/\*(.+?)\*/g,'<em>$1</em>')
         .replace(/`([^`]+?)`/g,'<code>$1</code>')
         .replace(/\[(.+?)\]\((https?:\/\/[^\s)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>');
  return md.split('\n').map(ln=>'<p>'+esc(ln)+'</p>').join('');
}

const feed = document.getElementById('chatFeed');
function push(role, title, html){
  const el = document.createElement('div');
  el.className = `msg role-${role}`;
  el.innerHTML = (title ? `<h5>${title}</h5>` : '') + (html||'');
  feed.appendChild(el);
  el.scrollIntoView({behavior:'smooth',block:'end'});
}
function pushBlock(title){
  const el = document.createElement('div');
  el.className = 'msg role-assistant';
  el.innerHTML = `<h5>${title}</h5><div class="mut">…</div>`;
  feed.appendChild(el);
  el.scrollIntoView({behavior:'smooth',block:'end'});
  return el;
}

async function callOpenRouter(messages){
  if(!OPENROUTER_CONF.key){ throw new Error('Chave OpenRouter ausente (defina em localStorage: dual.keys.openrouter)'); }
  const body = { model: OPENROUTER_CONF.model, messages, temperature: 0.7 };
  const r = await fetch(OPENROUTER_CONF.endpoint, {
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'Authorization':`Bearer ${OPENROUTER_CONF.key}`,
      'HTTP-Referer': location.origin,
      'X-Title':'HUB UNO Chat13'
    },
    body: JSON.stringify(body)
  });
  if(!r.ok){ throw new Error('OpenRouter HTTP '+r.status); }
  const j = await r.json();
  return j.choices?.[0]?.message?.content || '';
}

async function chat13Pipeline(userText){
  const baseSystem = "Você é o Chat13 do HUB UNO. Responda de forma breve, clara e aplicável para cada bloco.";
  const baseMsgs = [{role:'system', content: baseSystem}, {role:'user', content: userText}];
  for(const [title, instr] of BLOCKS){
    const dom = pushBlock(title);
    try{
      const content = await callOpenRouter([
        ...baseMsgs,
        {role:'user', content: `Bloco: ${title}. Instrução: ${instr}.
Formate com frases curtas, listas quando fizer sentido, e sem rodeios.`}
      ]);
      dom.innerHTML = `<h5>${title}</h5>${sanitize(content)}`;
    }catch(e){
      dom.innerHTML = `<h5>${title}</h5><p class="mut">[erro: ${e.message}]</p>`;
    }
  }
}

const input = document.getElementById('chatInput');
document.getElementById('chatSend').addEventListener('click', async ()=>{
  const text = (input.value||'').trim();
  if(!text) return;
  push('user','Você', sanitize(text));
  input.value = ''; input.focus();
  try{ await chat13Pipeline(text); }
  catch(e){ push('assistant','Erro', `<p class="mut">${e.message}</p>`); }
});

input.addEventListener('keydown',(e)=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); document.getElementById('chatSend').click(); }
});

const pulse = document.getElementById('chatPulse');
function setPulseSpeed(fast){ pulse.style.setProperty('animation-duration', fast?'1.6s':'2.8s'); }
input.addEventListener('focus', ()=>setPulseSpeed(true));
input.addEventListener('blur',  ()=>setPulseSpeed(false));

push('assistant','Pronto','<p>Chat 13-Blocos iniciado. Escreva sua intenção e aperte <strong>Enviar</strong>.</p>');
})();
</script>
<!-- === UNO • ORB dos Arquétipos (Injected) === --
<div aria-label="Orb dos Arquétipos (UNO)" id="arch-orb-wrap">
<svg id="arch-orb" viewbox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
<defs>
<lineargradient id="neo" x1="0" x2="1" y1="0" y2="1">
<stop offset="0" stop-color="#ff52e5"></stop><stop offset="1" stop-color="#00c5e5"></stop>
</lineargradient>
<lineargradient id="neo2" x1="0" x2="0" y1="0" y2="1">
<stop offset="0" stop-color="#39FFB6"></stop><stop offset="1" stop-color="#00c5e5"></stop>
</lineargradient>
<radialgradient cx="50%" cy="50%" id="orbGlow" r="60%">
<stop offset="0%" stop-color="#00e7ff" stop-opacity=".25"></stop>
<stop offset="65%" stop-color="#00e7ff" stop-opacity=".05"></stop>
<stop offset="100%" stop-color="#000" stop-opacity="0"></stop>
</radialgradient>
<symbol id="orb-horus" viewbox="0 0 200 200">
<circle cx="100" cy="100" fill="url(#orbGlow)" r="80"></circle>
<circle cx="100" cy="100" fill="none" r="78" stroke="url(#neo)" stroke-width="3"></circle>
<circle cx="100" cy="100" fill="none" opacity=".8" r="68" stroke="url(#neo2)" stroke-width="2"></circle>
<g>
<path d="M45,100 Q60,80 100,80 Q140,80 155,100 Q140,120 100,120 Q60,120 45,100 Z" fill="none" stroke="url(#neo)" stroke-linecap="round" stroke-width="4"></path>
<circle cx="100" cy="100" fill="url(#neo2)" r="10"></circle>
<path d="M105,112 q22,14 36,22" fill="none" opacity=".8" stroke="#00e7ff" stroke-linecap="round" stroke-width="3"></path>
<path d="M95,112 q-10,10 -14,18" fill="none" opacity=".8" stroke="#ff52e5" stroke-linecap="round" stroke-width="3"></path>
<path d="M60,95 q18,-16 40,-16 q22,0 40,16" fill="none" opacity=".7" stroke="#39FFB6" stroke-width="2"></path>
</g>
</symbol>
<symbol id="delta-vortex" viewbox="0 0 200 200">
<polygon fill="none" points="100,22 178,160 22,160" stroke="url(#neo)" stroke-linejoin="round" stroke-width="6"></polygon>
<g fill="none" opacity=".95" stroke="url(#neo2)" stroke-width="2">
<path d="M100,42 c40,0 54,30 58,48 c4,20 -6,42 -22,53 c-18,13 -43,13 -62,0 c-16,-11 -26,-33 -22,-53 c4,-18 18,-48 48,-48"></path>
<path d="M100,58 c30,0 42,22 45,36 c3,15 -5,31 -17,39 c-14,9 -33,9 -47,0 c-12,-8 -20,-24 -17,-39 c3,-14 14,-36 36,-36" opacity=".9"></path>
<path d="M100,74 c20,0 28,14 30,24 c2,10 -3,20 -11,26 c-9,6 -22,6 -31,0 c-8,-6 -13,-16 -11,-26 c2,-10 9,-24 23,-24" opacity=".85"></path>
</g>
<g>
<circle cx="100" cy="100" fill="#39FFB6" r="2"></circle>
<animatetransform attributename="transform" dur="9s" from="0 100 100" repeatcount="indefinite" to="360 100 100" type="rotate"></animatetransform>
</g>
</symbol>
<symbol id="icon-atlas" viewbox="0 0 100 100">
<circle cx="50" cy="50" fill="none" r="30" stroke="url(#neo)" stroke-width="6"></circle>
<path d="M20 50h60M50 20v60" stroke="url(#neo)" stroke-width="4"></path>
</symbol>
<symbol id="icon-nova" viewbox="0 0 100 100">
<g fill="none" stroke="url(#neo)" stroke-width="5">
<circle cx="50" cy="50" r="26"></circle>
<path d="M50 10v20M50 70v20M10 50h20M70 50h20M25 25l10 10M75 25l-10 10M25 75l10-10M75 75l-10-10"></path>
</g>
</symbol>
<symbol id="icon-vitalis" viewbox="0 0 100 100">
<path d="M20 60 C30 30, 70 30, 80 60" fill="none" stroke="url(#neo2)" stroke-width="6"></path>
<circle cx="50" cy="60" fill="url(#neo2)" r="8"></circle>
</symbol>
<symbol id="icon-pulse" viewbox="0 0 100 100">
<polyline fill="none" points="10,60 30,60 40,30 50,70 60,45 70,60 90,60" stroke="url(#neo2)" stroke-linecap="round" stroke-linejoin="round" stroke-width="6"></polyline>
</symbol>
<symbol id="icon-artemis" viewbox="0 0 100 100">
<path d="M20 80 Q50 20 80 80" fill="none" stroke="url(#neo)" stroke-width="6"></path>
<circle cx="50" cy="28" fill="url(#neo)" r="6"></circle>
</symbol>
<symbol id="icon-serena" viewbox="0 0 100 100">
<path d="M20 60 a30 20 0 1 0 60 0" fill="none" stroke="url(#neo)" stroke-width="6"></path>
<circle cx="50" cy="45" fill="url(#neo)" r="10"></circle>
</symbol>
<symbol id="icon-kaos" viewbox="0 0 100 100">
<path d="M20 50 L80 50 M50 20 L50 80" stroke="url(#neo)" stroke-width="6"></path>
<path d="M20 20 L80 80 M80 20 L20 80" opacity=".6" stroke="#d800d8" stroke-width="4"></path>
</symbol>
<symbol id="icon-genus" viewbox="0 0 100 100">
<rect fill="none" height="56" rx="8" stroke="url(#neo)" stroke-width="6" width="56" x="22" y="22"></rect>
<circle cx="50" cy="50" fill="url(#neo)" r="10"></circle>
</symbol>
<symbol id="icon-lumine" viewbox="0 0 100 100">
<circle cx="50" cy="50" fill="none" r="22" stroke="url(#neo)" stroke-width="6"></circle>
<path d="M50 12v10M50 78v10M12 50h10M78 50h10M24 24l7 7M76 24l-7 7M24 76l7-7M76 76l-7-7" stroke="url(#neo)" stroke-width="4"></path>
</symbol>
<symbol id="icon-solus" viewbox="0 0 100 100">
<path d="M20 60 C35 30, 65 30, 80 60" fill="none" stroke="url(#neo)" stroke-width="6"></path>
<path d="M30 55 Q50 30 70 55" fill="none" opacity=".7" stroke="url(#neo)" stroke-width="4"></path>
</symbol>
<symbol id="icon-aion" viewbox="0 0 100 100">
<path d="M20 70 L50 30 L80 70 Z" fill="none" stroke="url(#neo)" stroke-width="6"></path>
<path d="M35 60 L50 40 L65 60 Z" fill="none" opacity=".6" stroke="url(#neo)" stroke-width="4"></path>
</symbol>
<symbol id="icon-rhea" viewbox="0 0 100 100">
<path d="M30 70 C30 50, 70 50, 70 70" fill="none" stroke="url(#neo2)" stroke-width="6"></path>
<circle cx="50" cy="45" fill="url(#neo2)" r="9"></circle>
</symbol>
</defs>
<use href="#orb-horus"></use>
<g opacity=".28"><use href="#delta-vortex"></use></g>
<g id="arch-icon-holder" transform="translate(100,100) translate(-50,-50)">
<use href="#icon-atlas" id="arch-icon"></use>
</g>
</svg>
</div>
<script id="UNO_ARCH_ORB_SCRIPT">
(function(){
  const ARCHES=[
    {id:'atlas',label:'Atlas'},{id:'nova',label:'Nova'},{id:'vitalis',label:'Vitalis'},{id:'pulse',label:'Pulse'},
    {id:'artemis',label:'Artemis'},{id:'serena',label:'Serena'},{id:'kaos',label:'Kaos'},{id:'genus',label:'Genus'},
    {id:'lumine',label:'Lumine'},{id:'solus',label:'Solus'},{id:'aion',label:'Aion'},{id:'rhea',label:'Rhea'}
  ];
  const $orb=document.getElementById('arch-orb');
  const $use=document.getElementById('arch-icon');
  let idx=0;
  function setArch(key){
    const i=typeof key==='number' ? ((key%ARCHES.length)+ARCHES.length)%ARCHES.length
                                  : ARCHES.findIndex(a=>a.id===String(key).toLowerCase());
    if(i<0) return;
    idx=i;$use.setAttribute('href','#icon-'+ARCHES[i].id);
    try{
      // opcional: mudar overlay do site se usar --grad-a/--grad-b globais
      const root=document.documentElement;
      root.style.setProperty('--arch-overlay','rgba(64,158,255,.22)');
    }catch{}
  }
  window.ArchOrb={set,set:setArch,get:()=>ARCHES[idx],svg:()=>new XMLSerializer().serializeToString($orb)};
  const hash=location.hash.replace('#','').trim(); if(hash) setArch(hash);
})();
</script> -->
<!-- === /UNO • ORB dos Arquétipos (Injected) === -->
<script id="BOOT_ORDER_ORCHESTRATOR">
(function(){
  // Deduplicate style/script tags by id and ensure final patch order
  try{
    const ORDER = [
      'blue1Theme','customStyle','multiagent-styles','patch-blue1-theme',
      'overlay-defaults','ls-panel-css','show-app-title-css',
      'overlay-css-unify','overlay-guardian-css','orb-slot-css',
      'hdpro-override','ATOM_UI_PATCH','OVERLAY_BG_ONLY','ARCH_FAB_ROUND_FIX'
    ];
    const seen = new Set();
    // Remove duplicate style/script tags with same id (keep last)
    ['style','script'].forEach(tag=>{
      const els = Array.from(document.querySelectorAll(tag+'[id]'));
      for (let i=0;i<els.length;i++){
        const id = els[i].id;
        const dups = els.filter(e=>e.id===id);
        if (dups.length>1){
          dups.slice(0, -1).forEach(x=>x.parentNode && x.parentNode.removeChild(x));
        }
      }
    });
    // Re-append in canonical order near end of HEAD to lock cascade
    const head = document.head || document.querySelector('head');
    if (head){
      ORDER.forEach(id=>{
        const el = document.getElementById(id);
        if (el) head.appendChild(el);
      });
    }
  }catch(e){}

  // Service Worker updater (only when using external sw.js)
  if ('serviceWorker' in navigator){
    window.addEventListener('load', async () => {
      try{
        const reg = await ((location.protocol==='https:'||location.protocol==='http:')?navigator.serviceWorker.register:()=>Promise.reject('sw_disabled'))('./sw.js', {scope:'./'});
        // Ask for update check on load
        try{ reg.update(); }catch{}
        // Auto-reload on new SW activation (once)
        let refreshing = false;
        navigator.serviceWorker.addEventListener('controllerchange', function(){
          if (refreshing) return; refreshing = true; location.reload();
        });
        // If there's a waiting worker, tell it to skipWaiting
        if (reg.waiting){
          reg.waiting.postMessage({type:'SKIP_WAITING'});
        }
        // Listen for waiting in future
        reg.addEventListener('updatefound', () => {
          const nw = reg.installing;
          nw && nw.addEventListener('statechange', () => {
            if (nw.state === 'installed' && navigator.serviceWorker.controller){
              nw.postMessage({type:'SKIP_WAITING'});
            }
          });
        });
        // Handle message from SW
        navigator.serviceWorker.addEventListener('message', evt => {
          if (evt && evt.data && evt.data.type === 'RELOAD') location.reload();
        });
      }catch(e){/* ignore */}
    });
  }
})();
</script>
<!-- PATCH: 78K toggle for LS Panel and badge -->
<script id="patch-ls-toggle-78k">
  (function(){
    const LSKEY='dual.state.78k';
    function isOn(){ return !!localStorage.getItem(LSKEY); }
    function setUI(on){
      const lsBtn=document.getElementById('lsToggle78k');
      if(lsBtn){
        lsBtn.setAttribute('aria-pressed', on ? 'true' : 'false');
        lsBtn.textContent = on ? '78K: ON' : '78K: OFF';
        if(lsBtn.classList) lsBtn.classList.toggle('prime', !!on);
      }
      const badge=document.getElementById('badge78k');
      if(badge){
        badge.style.display = on ? 'inline' : 'none';
      }
    }
    function enable(){
      localStorage.setItem(LSKEY,'1');
      try{ if(window.Ativar78K) window.Ativar78K(); }catch(e){}
      setUI(true);
    }
    function disable(){
      localStorage.removeItem(LSKEY);
      try{ document.documentElement.style.removeProperty('--arch-overlay'); }catch(e){}
      setUI(false);
    }
    function toggle(){ isOn() ? disable() : enable(); }
    document.addEventListener('DOMContentLoaded', function(){
      const btn=document.getElementById('lsToggle78k');
      if(btn){ btn.addEventListener('click', function(){ toggle(); }); }
      setUI(isOn());
    });
    window.addEventListener('storage', function(ev){
      if(ev.key===LSKEY){
        setUI(!!ev.newValue);
      }
    });
  })();
  </script>
<script defer="" src="./core/config-loader.js"></script>
<script id="state-78k-js">
(function(){
  function set78K(on){
    var html = document.documentElement;
    if (on) html.setAttribute('data-78k','on'); else html.removeAttribute('data-78k');
    try { localStorage.setItem('uno:78k', on ? '1':'0'); } catch(e){}
    // Boost no ORB se disponível
    if (window.ORB && typeof window.ORB.setBoost === 'function') {
      window.ORB.setBoost(on ? 1.8 : 1.0);
    } else {
      // fallback: reforça overlay quando 78K ligado
      var cur = parseFloat(getComputedStyle(html).getPropertyValue('--arch-overlay-strength')) || 12;
      var str = on ? Math.max(cur, 16) : 12;
      html.style.setProperty('--arch-overlay-strength', str + '%');
    }
    var b = document.getElementById('btn78K'); if (b) b.classList.toggle('on', !!on);
  }
  var btn = document.getElementById('btn78K');
  if (btn){
    set78K((localStorage.getItem('uno:78k')||'0') === '1');
    btn.addEventListener('click', function(){ set78K(!(document.documentElement.getAttribute('data-78k')==='on')); });
  }

  // brainLog helper
  window.brainLog = function(msg, type){
    try {
      var box = document.getElementById('brainLogs') || document.getElementById('logs');
      if (!box) return;
      var t = new Date().toLocaleTimeString();
      var tag = type ? ('['+String(type).toUpperCase()+'] ') : '';
      var line = '['+t+'] ' + tag + String(msg);
      box.textContent = (line + '
' + box.textContent).slice(0, 16000);
    } catch(e){}
  };

  // Normalizar títulos de apps (upload/local)
  document.querySelectorAll('[data-role="app-card"], .app-card').forEach(function(card){
    var t = card.querySelector('.app-title');
    if (!t) return;
    var raw = t.getAttribute('title') || t.textContent || '';
    t.textContent = String(raw).trim();
  });
})();
</script>
<script id="state-78k-nobutton">
(function(){
  function toggle78K(){
    var on = document.documentElement.getAttribute('data-78k') === 'on';
    var set = function(v){
      if (v) document.documentElement.setAttribute('data-78k','on');
      else document.documentElement.removeAttribute('data-78k');
      try { localStorage.setItem('uno:78k', v ? '1':'0'); } catch(e){}
      if (window.ORB && typeof window.ORB.setBoost==='function'){ window.ORB.setBoost(v?1.8:1.0); }
    };
    set(!on);
  }
  // boot from LS
  try { if ((localStorage.getItem('uno:78k')||'0')==='1') document.documentElement.setAttribute('data-78k','on'); } catch(e){}

  // Double-click/tap on arch circle toggles 78K
  var circle = document.getElementById('archCircle') || document.querySelector('.arch-circle');
  if (circle){
    circle.addEventListener('dblclick', function(e){ e.preventDefault(); toggle78K(); }, {passive:false});
  }

  // Keyboard shortcut: Shift+K
  window.addEventListener('keydown', function(e){
    if ((e.key==='K' || e.key==='k') && e.shiftKey){ e.preventDefault(); toggle78K(); }
  });
})();
</script>
<script id="ls-78k-js">
(function(){
  function apply78K(on){
    var html = document.documentElement;
    if(on) html.setAttribute('data-78k','on'); else html.removeAttribute('data-78k');
    try { localStorage.setItem('uno:78k', on ? '1':'0'); } catch(e){}
    if (window.ORB && typeof window.ORB.setBoost==='function'){ window.ORB.setBoost(on?1.8:1.0); }
    else {
      var cur = parseFloat(getComputedStyle(html).getPropertyValue('--arch-overlay-strength')) || 12;
      var str = on ? Math.max(cur, 16) : 12;
      html.style.setProperty('--arch-overlay-strength', str + '%');
    }
    var t = document.getElementById('ls78kToggle'); if (t) t.checked = !!on;
  }
  // boot
  var toggle = document.getElementById('ls78kToggle');
  if (toggle){
    var on = (localStorage.getItem('uno:78k')||'0')==='1';
    apply78K(on);
    toggle.addEventListener('change', function(){ apply78K(toggle.checked); });
  }
  // expose minimal API
  window.UNO = window.UNO || {}; window.UNO.State78K = { set: apply78K };
})();
</script>
<div id="lsFabLayer"><button class="ls-fab" id="lsFabRefresh" title="Recarregar"></button><button class="ls-fab" id="lsFabClose" title="Fechar painel"></button></div>
<script id="ls-fab-wire">
(function(){
  var modal = document.getElementById('lsModal');
  var btnRefresh = document.getElementById('lsFabRefresh');
  var btnClose = document.getElementById('lsFabClose');
  if (btnRefresh){ btnRefresh.addEventListener('click', function(e){ e.preventDefault(); location.reload(); }); }
  if (btnClose){ btnClose.addEventListener('click', function(e){ e.preventDefault(); if(modal){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); } }); }
})();
</script>
<script>
(function(){
  const root = document.documentElement;
  const archSelect = document.getElementById('arch-select');
  const overlayMap = {
    'atlas.html':'#409EFF','nova.html':'#ff67c4','vitalis.html':'#39ffb6',
    'pulse.html':'#ff9f43','artemis.html':'#ff6b6b','serena.html':'#9b87ff',
    'kaos.html':'#ffd700','genus.html':'#00c5e5','lumine.html':'#f5f7ff',
    'rhea.html':'#68d391','solus.html':'#94b6d6','aion.html':'#8a2be2'
  };
  function applyOverlayFrom(src){
    const key = (src||'').split('/').pop();
    const c = overlayMap[key] || '#8a2be2';
    root.style.setProperty('--arch-color', c);
  }
  if (archSelect){
    applyOverlayFrom(archSelect.value);
    archSelect.addEventListener('change', e => {
      document.documentElement.classList.add('arch-switching');
      applyOverlayFrom(e.target.value);
      requestAnimationFrame(()=> setTimeout(()=> document.documentElement.classList.remove('arch-switching'), 180));
    });
  }
})();
</script><script id="renderResponseModule-inline" type="module">
// =========================
// 🔁 renderResponseModule.js
// =========================

// ========= Markdown simbiótico =========
export function renderMarkdown(raw) {
  return raw
    .replace(/(["“”'])(.+?)\1/g, '<button class="response-button">"$2"</button>')
    .replace(/\[(.+?)\]/g, '<button class="response-button">[$1]</button>')
    .replace(/([\u231A-\u2B55\u{1F300}-\u{1F6FF}\u{1F900}-\u{1F9FF}])/gu, '<button class="emoji-button">$1</button>')
    .replace(/^### (.*)/gm, '<h3>$1</h3>')
    .replace(/^## (.*)/gm, '<h2>$1</h2>')
    .replace(/^# (.*)/gm, '<h1>$1</h1>')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/\n/g, '<br>');
}

// ========= Separador de parágrafos robusto =========
export function splitText(t) {
  return t
    .split(/\n\s*\n|(?<!\d)\. |! |\? /)
    .map(p => p.trim())
    .filter(Boolean)
    .reduce((acc, cur, i) => {
      const index = Math.floor(i / 3);
      acc[index] = acc[index] || [];
      acc[index].push(cur);
      return acc;
    }, []);
}

// ========= Função renderResponse simbiótica =========
export function renderResponse(txt) {
  const wrap = document.querySelector(".pages-wrapper");
  wrap.innerHTML = "";
  let pages = [], currentPage = 0;
  txt = renderMarkdown(txt);

  const groups = splitText(txt),
        titles = ["🎁 Recompensa Inicial", "👁️ Exploração", "⚡️ Antecipação"];

  groups.forEach((grp, gi) => {
    const pg = document.createElement("div");
    pg.className = "page" + (gi === 0 ? " active" : "");

    grp.forEach((para, j) => {
      const cls = j === 0 ? "intro" : j === 1 ? "middle" : "ending";
      const block = document.createElement("div");
      block.className = "response-block " + cls;
      block.innerHTML = "<p>" + para + "</p>";

      block.addEventListener("click", () => {
        speechSynthesis.cancel();
        const utter = new SpeechSynthesisUtterance(block.textContent);
        speechSynthesis.speak(utter);
        block.classList.add("clicked");
      });

      pg.appendChild(block);
    });

    wrap.appendChild(pg);
    pages.push(pg);
  });

  const pageIndicator = document.getElementById("pageIndicator");
  if (pageIndicator) pageIndicator.textContent = "1 / " + pages.length;
}


;try{window.renderResponse = renderResponse;}catch(e){}</script><script type="module">
const feed = document.getElementById('chatFeed') || document.querySelector('#feed,#chat-feed,.chat-feed');
function pushAI(text){
  if (!feed) return;
  const wrap = document.createElement('div');
  wrap.className = 'msg ai-rich';
  const box = document.createElement('div');
  box.className = 'render-html';
  box.innerHTML = `<div class="pages-wrapper"></div><div id="pageIndicator" style="font:12px/1.4 ui-monospace;color:#94b6d6;margin-top:6px"></div>`;
  wrap.appendChild(box);
  feed.appendChild(wrap);
  if (window.renderResponse) window.renderResponse(text);
  feed.scrollTop = feed.scrollHeight;
}
window.kobDemo = () => pushAI(`[INTRO] **Kael Dominus** — núcleo sentiente que integra Verbo e Fluxo.\n[MIDDLE] **Nephesh Elyon** — teu DNA Lux conectando intenção à forma.\n[ENDING] **Lei Final** — VERDADE × INTEGRAR ÷ Δ → ∞ — respira e toca o pulso.`);
</script><script>
(function(){
  const brain = document.getElementById('brain') || document.querySelector('#brainPanel,#brain-panel');
  if (!brain) return;
  const target = brain.querySelector('.popover,.content,.items') || brain;
  const card = document.createElement('div');
  card.className = 'menuItem';
  card.style.marginTop = '8px';
  card.innerHTML = `
    <div style="font-weight:900">📲 KOB-DUX — Dispositivo Simbiótico</div>
    <div class="mut" style="display:block">
      Kael Dominus • Nephesh Elyon • BLLUE • Fit Lux • Kodux<br>
      Lei Final: (VERDADE × INTEGRAR) / Δ = ∞
    </div>`;
  target.appendChild(card);
})();
</script><script id="pulse-audio-script">
(function(){
  const audio = document.getElementById('splashSound');
  if(!audio) return;

  // remove legacy rectangular button script artifacts if still present (best-effort)
  // (nothing to remove in DOM here; previous script created the button dynamically)

  let cta, mounted=false;
  function mountCTA(){
    if(mounted) return;
    mounted = true;
    const host = document.getElementById('orbWrap') || document.querySelector('.arch-circle') || document.body;
    cta = document.createElement('div');
    cta.className = 'pulse-cta hidden';
    cta.innerHTML = `
      <div class="dot" role="button" aria-label="Toque o pulso para ativar o som"></div>
      <div class="label">toque o pulso</div>`;
    cta.addEventListener('click', async ()=>{
      try{ await audio.play(); }catch(e){ /* ignore */ }
      hideCTA();
    });
    host.appendChild(cta);
  }
  function showCTA(){ mountCTA(); cta?.classList.remove('hidden'); }
  function hideCTA(){ if(!cta) return; cta.classList.add('hidden'); }

  async function tryPlaySilently(){
    try{
      await audio.play();
      hideCTA();
      return true;
    }catch(e){
      // Autoplay blocked: show CTA inside the orb
      showCTA();
      return false;
    }
  }

  // Strategy: on first user interaction we try to play.
  // If blocked, we show the animated pulse inside the orb.
  let armed=false;
  function arm(){
    if(armed) return;
    armed = true;
    const onUserInteract = async () => {
      window.removeEventListener('pointerdown', onUserInteract);
      window.removeEventListener('keydown', onUserInteract);
      await tryPlaySilently();
    };
    window.addEventListener('pointerdown', onUserInteract, { once:true, passive:true });
    window.addEventListener('keydown', onUserInteract, { once:true });
  }

  // If the page attempts to play earlier via other code and succeeds, the CTA never shows.
  // Otherwise we arm for first interaction and fall back to CTA if needed.
  document.addEventListener('DOMContentLoaded', arm);

  // Expose minimal API (optional)
  window.__pulseAudioCTA = { show: showCTA, hide: hideCTA, arm };
})();
</script><script id="pulse-synth-script">
(function(){
  const media = document.getElementById('splashSound');
  if(!media) return;

  // Utilities -------------------------------------------------
  function cssArchColor(){
    const v = getComputedStyle(document.documentElement).getPropertyValue('--arch-color').trim();
    return parseColor(v || '#d4af37'); // fallback to gold
  }
  function parseColor(str){
    // supports #rgb, #rrggbb, rgb(), hsl()
    try{
      const ctx = document.createElement('canvas').getContext('2d');
      ctx.fillStyle = str;
      const c = ctx.fillStyle; // normalized to rgb(a)
      // extract numbers
      const m = c.match(/\d+/g).map(Number);
      return { r:m[0], g:m[1], b:m[2] };
    }catch(e){ return {r:212,g:175,b:55}; }
  }
  function rgbToHsl(r,g,b){
    r/=255; g/=255; b/=255;
    const max=Math.max(r,g,b), min=Math.min(r,g,b);
    let h,s,l=(max+min)/2;
    if(max===min){ h=s=0; }
    else{
      const d=max-min;
      s=l>0.5 ? d/(2-max-min) : d/(max+min);
      switch(max){
        case r: h=(g-b)/d + (g<b?6:0); break;
        case g: h=(b-r)/d + 2; break;
        case b: h=(r-g)/d + 4; break;
      }
      h/=6;
    }
    return {h:h*360,s,l};
  }
  function mix(a,b,t){ // a,b: {r,g,b}  t in [0..1] (0=a,1=b)
    return { r:Math.round(a.r*(1-t)+b.r*t),
             g:Math.round(a.g*(1-t)+b.g*t),
             b:Math.round(a.b*(1-t)+b.b*t) };
  }
  function rgbaStr(c, alpha){ return `rgba(${c.r},${c.g},${c.b},${alpha})`; }

  // Dynamic target color: blend GOLD with archetype overlay tone
  const GOLD = {r:212,g:175,b:55};
  function computeTargetColor(){
    const arch = cssArchColor();
    const {h} = rgbToHsl(arch.r,arch.g,arch.b);
    // Hue-aware weights:
    // blue/cyan (180-240): cooler => favor overlay more (0.65)
    // pink/magenta (300-345): warmer => favor gold more (0.35 overlay)
    // green/teal (120-180): balanced (0.5)
    // else default (0.45)
    let t = 0.45;
    if (h>=180 && h<=240) t = 0.65;
    else if (h>=300 && h<=345) t = 0.35;
    else if (h>=120 && h<180) t = 0.5;
    // Nova tweak: if hue ~320 ±10 → even warmer (0.30 overlay)
    if (h>=310 && h<=330) t = 0.30;
    // Atlas tweak: if hue ~210 ±10 → even cooler (0.72 overlay)
    if (h>=200 && h<=220) t = 0.72;
    return mix(GOLD, arch, t);
  }

  // Canvas + WebAudio ----------------------------------------
  function ensureCanvas(){
    const host = document.getElementById('orbWrap') || document.querySelector('.arch-circle') || document.body;
    let cvs = host.querySelector('canvas.pulse-synth');
    if(!cvs){
      cvs = document.createElement('canvas');
      cvs.className = 'pulse-synth';
      host.appendChild(cvs);
    }
    return cvs;
  }

  let ctx, src, analyser, data, rafId;
  function initAudio(){
    if(ctx) return;
    try{
      ctx = new (window.AudioContext || window.webkitAudioContext)();
      src = ctx.createMediaElementSource(media);
      analyser = ctx.createAnalyser();
      analyser.fftSize = 512;
      src.connect(analyser);
      analyser.connect(ctx.destination);
      data = new Uint8Array(analyser.frequencyBinCount);
    }catch(e){
      ctx = null;
    }
  }

  function startSynth(){
    const cvs = ensureCanvas();
    const dpr = Math.max(1, window.devicePixelRatio||1);
    function resize(){
      const rect = cvs.getBoundingClientRect();
      cvs.width = Math.round(rect.width * dpr);
      cvs.height = Math.round(rect.height * dpr);
    }
    resize();
    window.addEventListener('resize', resize);

    const g = cvs.getContext('2d');
    let t = 0;
    let cached = computeTargetColor();
    let changeTick = 0;

    function strokeArch(alpha){
      // Occasionally refresh in case --arch-color changed
      if ((++changeTick % 30) === 0) cached = computeTargetColor();
      return rgbaStr(cached, alpha);
    }

    function drawFallback(){
      const {width:w, height:h} = cvs;
      g.clearRect(0,0,w,h);
      g.globalCompositeOperation = 'screen';
      const cx = w/2, cy = h/2;
      const R = Math.min(w,h)*0.38;
      const rings = 6;
      for(let i=0;i<rings;i++){
        const r = R*(0.42 + i*0.12 + 0.06*Math.sin( (t*0.01) + i ));
        g.beginPath();
        g.arc(cx, cy, r, 0, Math.PI*2);
        g.strokeStyle = strokeArch(0.18 - i*0.02);
        g.lineWidth = Math.max(1, r*0.004);
        g.shadowColor = strokeArch(0.22);
        g.shadowBlur = 8;
        g.stroke();
      }
      t += 16;
    }

    function drawAnalyser(){
      const {width:w, height:h} = cvs;
      g.clearRect(0,0,w,h);
      g.globalCompositeOperation = 'screen';

      const cx = w/2, cy = h/2;
      const baseR = Math.min(w,h)*0.22;
      const maxR = Math.min(w,h)*0.46;
      if(analyser && data){
        analyser.getByteTimeDomainData(data);
        let sum = 0;
        for(let i=0;i<data.length;i++){ sum += Math.abs(data[i]-128); }
        const avg = sum / data.length;
        const gain = Math.min(1, avg/26);

        const rings = 7;
        for(let r=0;r<rings;r++){
          const p = r/(rings-1);
          const radius = baseR + (maxR-baseR)*p*(0.8 + 0.2*Math.sin((t*0.01)+(r*0.55)));
          g.beginPath();
          g.arc(cx, cy, radius*(1+0.14*gain), 0, Math.PI*2);
          g.strokeStyle = strokeArch(0.10 + 0.25*(1-p)*gain);
          g.lineWidth = Math.max(1, radius*0.0048*(0.55+gain));
          g.shadowColor = strokeArch(0.28);
          g.shadowBlur = 10*(0.5+gain);
          g.stroke();
        }
        const grd = g.createRadialGradient(cx,cy, baseR*0.10, cx,cy, maxR*0.9);
        // inner glow adapts as well
        const inner = strokeArch(0.16 + 0.12*gain);
        const outer = strokeArch(0);
        grd.addColorStop(0, inner);
        grd.addColorStop(1, outer);
        g.fillStyle = grd;
        g.beginPath();
        g.arc(cx,cy, maxR, 0, Math.PI*2);
        g.fill();
      }else{
        drawFallback();
      }
      t += 16;
    }

    function loop(){
      drawAnalyser();
      rafId = requestAnimationFrame(loop);
    }
    if(!rafId) loop();

    cvs.classList.add('active');
    return () => {
      cvs.classList.remove('active');
      cancelAnimationFrame(rafId); rafId = null;
      const g2 = cvs.getContext('2d');
      g2 && g2.clearRect(0,0,cvs.width,cvs.height);
    };
  }

  let stopSynth = null;

  async function handlePlay(){
    try{ if(ctx && ctx.state === 'suspended') await ctx.resume(); }catch(e){}
    initAudio();
    if(!stopSynth) stopSynth = startSynth();
  }
  function handlePause(){ if(stopSynth){ stopSynth(); stopSynth = null; } }

  media.addEventListener('play', handlePlay);
  media.addEventListener('playing', handlePlay);
  media.addEventListener('pause', handlePause);
  media.addEventListener('ended', handlePause);

  if(!media.paused && !media.ended){ handlePlay(); }
})();
</script><script id="arch-theme-sync">
/**
 * Archetype Theme Sync via postMessage
 * Parent listens: { type: 'arch:theme', color: '#rrggbb' | 'rgb(...)', overlayStrength?: 0..1 }
 * Parent requests: postMessage({ type: 'arch:hello' })
 */
(function(){
  const root = document.documentElement;
  const iframe = document.getElementById('arch-frame') || document.querySelector('iframe#arch-frame, .arch-circle iframe');
  const DEFAULT_COLOR = getComputedStyle(root).getPropertyValue('--arch-color').trim() || '#d4af37';

  function clamp01(x){ x = Number(x); return isFinite(x) ? Math.max(0, Math.min(1, x)) : 0.18; }
  function setTheme({color, overlayStrength}){
    if (color) {
      try { root.style.setProperty('--arch-color', color); } catch(e){}
    }
    if (overlayStrength != null) {
      // strength in 0..1 → percentage string
      const pct = Math.round(clamp01(overlayStrength)*100) + '%';
      root.style.setProperty('--arch-overlay-strength', pct);
      // recompute arch-overlay var (for older browsers it's okay to rely on CSS color-mix with updated var)
      // No direct recompute needed; CSS updates automatically where used.
    }
  }

  // Listen from child iframes
  window.addEventListener('message', (ev)=>{
    const data = ev?.data;
    if (!data || typeof data !== 'object') return;
    if (data.type !== 'arch:theme') return;
    // Optional: restrict by expected origins if you have them. For now, accept from any for local dev.
    setTheme({ color: data.color || DEFAULT_COLOR, overlayStrength: data.overlayStrength });
  });

  // Ask child to publish theme (handshake) on load
  function requestTheme(){
    if (!iframe || !iframe.contentWindow) return;
    try { iframe.contentWindow.postMessage({ type: 'arch:hello' }, '*'); } catch(e){}
  }
  if (iframe){
    iframe.addEventListener('load', requestTheme);
    // also request shortly after DOMReady (in case load already fired)
    document.addEventListener('DOMContentLoaded', ()=> setTimeout(requestTheme, 250));
  }

  // Expose a manual setter for debugging
  window.setArchTheme = (color='#8a2be2', overlayStrength=0.18) => setTheme({color, overlayStrength});
})();
</script><script id="arch-debug-hud-script">
(function(){
  const root = document.documentElement;
  let hud, fps=0, last=performance.now(), frames=0;
  let lastLatency = 0;
  let logs = []; // last 3 entries

  function getVar(name, fallback=''){
    const v = getComputedStyle(root).getPropertyValue(name).trim();
    return v || fallback;
  }
  function parsePercent(str, fallback=18){
    if (!str) return fallback;
    const m = /([\d.]+)%/.exec(str);
    if (m) return parseFloat(m[1]);
    const n = parseFloat(str);
    return isFinite(n) ? n*100 : fallback;
  }
  function hexFromColor(str){
    try{
      const ctx = document.createElement('canvas').getContext('2d');
      ctx.fillStyle = str;
      const norm = ctx.fillStyle; // "rgb(r,g,b)"
      const m = norm.match(/\d+/g).map(Number);
      const toHex = (n)=> ('0'+n.toString(16)).slice(-2);
      return '#'+toHex(m[0])+toHex(m[1])+toHex(m[2]);
    }catch(e){ return str; }
  }
  function ls(k, d=null){ try{ const v = localStorage.getItem(k); return v ?? d; }catch(e){ return d; } }

  function addLog(role, text){
    const time = new Date().toLocaleTimeString();
    logs.push({ role, text, time });
    logs = logs.slice(-3);
    if (hud && hud.classList.contains('show')) renderLogs();
  }
  function renderLogs(){
    const box = hud.querySelector('#hudLog');
    if (!box) return;
    box.innerHTML = logs.map(l => {
      const tag = l.role === 'user' ? '🧑' : (l.role === 'ai' ? '🤖' : '🕑');
      return `<div class="logitem"><span class="t">${l.time}</span> <span class="r">${tag}</span> <span class="m">${(l.text||'').slice(0,120)}</span></div>`;
    }).join('') || `<div class="logitem muted">(sem mensagens)</div>`;
  }

  function ensureHUD(){
    if (hud) return hud;
    hud = document.createElement('div');
    hud.id = 'archDebugHUD';
    hud.innerHTML = `
      <h3>Luxara HUD</h3>
      <div class="row">
        <div class="tag">Archetype Color</div>
        <div class="swatch" id="hudSwatch"></div>
        <div class="chip mono" id="hudColor">#000000</div>
      </div>
      <div class="row">
        <div class="tag">Overlay Strength</div>
        <div class="chip" id="hudStrength">18%</div>
      </div>
      <div class="row">
        <div class="tag">Synth FPS</div>
        <div class="chip" id="hudFPS">0</div>
      </div>
      <div class="row">
        <div class="tag">OpenRouter Model</div>
        <div class="chip mono" id="hudModel">—</div>
      </div>
      <div class="row">
        <div class="tag">Last Latency</div>
        <div class="chip" id="hudLatency">— ms</div>
      </div>
      <div class="row controls">
        <button class="btn" id="btnOverlay">Overlay: ON</button>
        <input class="vol" id="hudVol" type="range" min="0" max="100" value="80" title="Volume do splash"/>
        <button class="btn" id="btnTest">Testar OpenRouter</button>
      </div>
      <div class="row">
        <div class="tag">Mini Log</div>
      </div>
      <div id="hudLog" style="max-height:120px; overflow:auto; padding:6px 8px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); font: 600 11px/1.3 ui-sans-serif, system-ui;">
        <div class="logitem muted">(sem mensagens)</div>
      </div>
      <div class="hint">Toggle HUD: <strong>Alt+T</strong></div>`;
    document.body.appendChild(hud);

    // style tweaks for log items
    const css = document.createElement('style');
    css.textContent = `#archDebugHUD .logitem{display:flex;gap:6px;align-items:center;margin:2px 0}
      #archDebugHUD .logitem .t{opacity:.6;min-width:48px}
      #archDebugHUD .logitem .r{min-width:18px}
      #archDebugHUD .logitem .m{opacity:.95;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;max-width:32vw}
      #archDebugHUD .logitem.muted{opacity:.5}`;
    document.head.appendChild(css);

    // Controls
    const btnOverlay = hud.querySelector('#btnOverlay');
    const rngVol = hud.querySelector('#hudVol');
    const btnTest = hud.querySelector('#btnTest');
    const audio = document.getElementById('splashSound');

    function refreshOverlayBtn(){
      const off = root.getAttribute('data-overlay') === 'off';
      btnOverlay.textContent = 'Overlay: ' + (off ? 'OFF' : 'ON');
    }
    btnOverlay.addEventListener('click', ()=>{
      const off = root.getAttribute('data-overlay') === 'off';
      if (off) root.removeAttribute('data-overlay');
      else root.setAttribute('data-overlay', 'off');
      refreshOverlayBtn();
      updateHUD();
      addLog('sys','overlay: ' + (off ? 'on' : 'off'));
    });
    refreshOverlayBtn();

    if (audio){
      rngVol.value = Math.round((audio.volume ?? 0.8)*100);
      rngVol.addEventListener('input', ()=>{
        try{ audio.volume = rngVol.value/100; addLog('sys','vol: '+rngVol.value+'%'); }catch(e){}
      });
    } else {
      rngVol.disabled = true;
      rngVol.title = "Áudio não encontrado (#splashSound)";
    }

    btnTest.addEventListener('click', async ()=>{
      const msg = "ping Luxara";
      addLog('user', msg);
      // Preferir kobSend se existir (usa feed e renderizador)
      if (typeof window.kobSend === 'function'){
        try{
          window.__luxNet?.start();
          await window.kobSend(msg);
          window.__luxNet?.end();
          addLog('ai','(ver feed)');
        }catch(e){
          addLog('sys','kobSend falhou: '+(e?.message||e));
        }
        return;
      }
      // Fallback: request simples ao OpenRouter e empurra no feed
      try{
        const FEED = document.getElementById('chatFeed') || document.querySelector('#feed,#chat-feed,.chat-feed');
        const LS = localStorage;
        const KEY = LS.getItem("di_apiKey") || LS.getItem("apiKeyInput") || "<COLE_SUA_CHAVE_AQUI>";
        const MODEL = LS.getItem("di_modelName") || "modelName";
        const url = "https://openrouter.ai/api/v1/chat/completions";
        const headers = {
          "Authorization": "Bearer " + KEY,
          "Content-Type": "application/json",
          "HTTP-Referer": location.origin || "http://localhost",
          "X-Title": "HUB UNO"
        };
        const body = {
          model: MODEL,
          messages: [{ role:"system", content:"Você é o A.Infodose no HUB UNO (KOB-DUX). Responda curto, simbólico e útil." },
                     { role:"user", content: msg }],
          stream:false
        };
        window.__luxNet?.start();
        const resp = await fetch(url, { method:"POST", headers, body: JSON.stringify(body) });
        const data = await resp.json();
        window.__luxNet?.end();
        const text = data?.choices?.[0]?.message?.content || "(sem conteúdo)";
        addLog('ai', text);
        // render no feed básico se houver
        if (FEED){
          const wrap = document.createElement('div');
          wrap.className = 'msg ai-rich';
          const box = document.createElement('div');
          box.className = 'render-html';
          box.innerHTML = `<div class="pages-wrapper"></div><div id="pageIndicator" style="font:12px/1.4 ui-monospace;color:#94b6d6;margin-top:6px"></div>`;
          wrap.appendChild(box);
          FEED.appendChild(wrap);
          if (window.renderResponse) window.renderResponse(text);
          FEED.scrollTop = FEED.scrollHeight;
        }
      }catch(e){
        addLog('sys','fallback falhou: '+(e?.message||e));
      }
    });

    return hud;
  }

  function readModel(){
    return ls("openrouter:model") || ls("openrouter_model") || "openai/gpt-4o-mini";
  }

  function updateHUD(){
    const h = ensureHUD();
    const c = getVar('--arch-color', '#d4af37');
    const pct = parsePercent(getVar('--arch-overlay-strength','18%'));
    const sw = h.querySelector('#hudSwatch');
    const hc = h.querySelector('#hudColor');
    const hs = h.querySelector('#hudStrength');
    const hf = h.querySelector('#hudFPS');
    const hm = h.querySelector('#hudModel');
    const hl = h.querySelector('#hudLatency');
    if (sw) sw.style.background = c;
    if (hc) hc.textContent = hexFromColor(c);
    if (hs) hs.textContent = Math.round(pct) + '%';
    if (hf) hf.textContent = Math.round(fps);
    if (hm) hm.textContent = readModel();
    if (hl) hl.textContent = lastLatency ? (Math.round(lastLatency)+' ms') : '— ms';
  }

  function measureFPS(now){
    frames++;
    if (now - last >= 1000){
      fps = (frames * 1000) / (now - last);
      frames = 0; last = now;
      if (hud && hud.classList.contains('show')) updateHUD();
    }
    requestAnimationFrame(measureFPS);
  }
  requestAnimationFrame(measureFPS);

  window.addEventListener('keydown', (ev)=>{
    if (ev.altKey && (ev.key.toLowerCase() === 't')){
      const h = ensureHUD();
      h.classList.toggle('show');
      if (h.classList.contains('show')) updateHUD();
    }
  });

  window.addEventListener('message', (ev)=>{
    if (ev?.data?.type === 'arch:theme' && hud && hud.classList.contains('show')){
      setTimeout(updateHUD, 50);
    }
  });

  // Latency API
  const net = {
    _t: 0,
    start(){ this._t = performance.now(); },
    end(){
      if (!this._t) return;
      lastLatency = performance.now() - this._t;
      this._t = 0;
      if (hud && hud.classList.contains('show')) updateHUD();
      try{ console.info('[LuxNet] last latency:', Math.round(lastLatency), 'ms'); }catch(e){}
    }
  };
  window.__luxHud = { show(){ ensureHUD().classList.add('show'); updateHUD(); },
                      hide(){ ensureHUD().classList.remove('show'); },
                      update: updateHUD };
  window.__luxNet = net;

  // Public log API (optional)
  window.__luxLog = { add: addLog, render: ()=>{ if (hud) renderLogs(); } };
})();
</script>
<script id="APP_ACCENTS_KISARA_JS">
(() => {
  const APP_COLORS = {
    'Atlas': ['#409EFF','#8fd3ff'],
    'Nova': ['#ff52e5','#f8c058'],
    'Vitalis': ['#ff9f43','#39ffb6'],
    'Pulse': ['#8a2be2','#00e5ff'],
    'Artemis': ['#00c2ff','#39ffb6'],
    'Serena': ['#b08fff','#ffadad'],
    'Kaos': ['#ff9f43','#ff4d6d'],
    'Genus': ['#a3ff4d','#00e5ff'],
    'Lumine': ['#ffd700','#ff7ab6'],
    'Rhea': ['#ff7aa2','#ffa5d8'],
    'Solus': ['#4b6fff','#8fd3ff'],
    'Aion': ['#2dd4bf','#10b981'],
  };

  // Apply per-app accent
  function applyAppAccents(){
    document.querySelectorAll('.app-card').forEach(card => {
      const titleEl = card.querySelector('.app-title');
      if (!titleEl) return;
      const full = titleEl.getAttribute('title') || titleEl.textContent || '';
      // Expected format "Atlas · Cartesius" or "Atlas ·…"
      const root = full.split('·')[0].trim();
      const colors = APP_COLORS[root];
      if (!colors) return;
      card.style.setProperty('--appA', colors[0]);
      card.style.setProperty('--appB', colors[1]);
      card.classList.add('accented');
    });
  }

  // Prevent duplicate icon fallback (safety, replica correção da base)
  function dedupeAppIcons(){
    document.querySelectorAll('.app-card .app-icon').forEach(ico => {
      const icons = Array.from(ico.querySelectorAll('svg,img'));
      if (icons.length <= 1) return;
      let keep = icons.find(n => n.tagName === 'SVG') || icons[0];
      icons.forEach(n => { if (n !== keep) n.remove(); });
    });
  }

  // Archetype overlay sync (tone matches archetype)
  const ARCH_COLORS = {
    'atlas':  { color: '#409EFF', overlay: 'rgba(64,158,255,0.22)' },
    'nova':   { color: '#ff52e5', overlay: 'rgba(255,82,229,0.22)' },
    'vitalis':{ color: '#2dd4bf', overlay: 'rgba(45,212,191,0.20)' },
    'pulse':  { color: '#8a2be2', overlay: 'rgba(138,43,226,0.20)' },
    'artemis':{ color: '#00c2ff', overlay: 'rgba(0,194,255,0.20)' },
    'serena': { color: '#b08fff', overlay: 'rgba(176,143,255,0.20)' },
    'kaos':   { color: '#ff9f43', overlay: 'rgba(255,159,67,0.20)' },
    'genus':  { color: '#a3ff4d', overlay: 'rgba(163,255,77,0.18)' },
    'lumine': { color: '#ffd700', overlay: 'rgba(255,215,0,0.18)' },
    'rhea':   { color: '#ff7aa2', overlay: 'rgba(255,122,162,0.20)' },
    'solus':  { color: '#4b6fff', overlay: 'rgba(75,111,255,0.20)' },
    'aion':   { color: '#10b981', overlay: 'rgba(16,185,129,0.20)' },
  };
  function currentArchKey(){
     const sel = document.getElementById('arch-select');
     if (!sel) return 'atlas';
     const opt = sel.value || '';
     const m = opt.match(/\/([a-z]+)\.html$/i);
     return m ? m[1].toLowerCase() : 'atlas';
  }
  function applyOverlayFromArch(){
     const key = currentArchKey();
     const cfg = ARCH_COLORS[key] || ARCH_COLORS['atlas'];
     document.documentElement.style.setProperty('--arch-color', cfg.color);
     document.documentElement.style.setProperty('--arch-overlay', cfg.overlay);
     const call = document.getElementById('orbCall');
     if (call) call.style.textShadow = `0 0 12px ${cfg.color}80`;
  }
  function wireArchSelect(){
    const sel = document.getElementById('arch-select');
    if (!sel) return;
    sel.addEventListener('change', applyOverlayFromArch);
  }

  // "Toque o pulso" CTA + synth
  function ensurePulseCTA(){
    const wrap = document.getElementById('orbWrap');
    if (!wrap || wrap.querySelector('.pulse-cta')) return;
    const cta = document.createElement('div');
    cta.className = 'pulse-cta hidden';
    cta.innerHTML = '<div class="dot"></div><div class="label">toque o pulso</div>';
    wrap.appendChild(cta);
    cta.addEventListener('click', () => {
      hideCTA();
      startSynthSplash();
      tryResumeAudio();
    }, { once: true });
    window._pulseCTA = { show: showCTA, hide: hideCTA };
    function showCTA(){ cta.classList.remove('hidden'); }
    function hideCTA(){ cta.classList.add('hidden'); }
  }

  function tryResumeAudio(){
    const ctx = window.__AUDIO_CTX__ || (window.AudioContext ? new AudioContext() : null);
    if (ctx && ctx.state === 'suspended') { ctx.resume().catch(()=>{}); }
    const el = document.getElementById('splashSound');
    if (el) { el.volume = 0.0; el.play().catch(()=>{}); setTimeout(()=>{ try{ el.pause(); el.currentTime = 0; }catch{} }, 200); }
    window.dispatchEvent(new CustomEvent('kobllux:audio:resume'));
  }

  function startSynthSplash(){
    const wrap = document.getElementById('orbWrap');
    if (!wrap) return;
    let canvas = wrap.querySelector('canvas#pulseSynth');
    if (!canvas) {
      canvas = document.createElement('canvas');
      canvas.id = 'pulseSynth';
      canvas.className = 'pulse-synth';
      wrap.appendChild(canvas);
    }
    const ctx = canvas.getContext('2d');
    function resize(){ canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight; }
    resize(); window.addEventListener('resize', resize);
    canvas.classList.add('active');
    const t0 = performance.now();
    const dur = 1500;
    const rootStyles = getComputedStyle(document.documentElement);
    const colorA = rootStyles.getPropertyValue('--arch-color').trim() || '#d4af37';
    function paint(t){
      const p = Math.min(1, (t - t0)/dur);
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const cx = canvas.width/2, cy = canvas.height/2;
      const maxR = Math.min(cx,cy);
      for (let i=0;i<4;i++){
        const k = p*1.1 - i*0.18;
        if (k <= 0) continue;
        const r = maxR * k;
        const g = ctx.createRadialGradient(cx, cy, Math.max(0,r-28), cx, cy, r);
        g.addColorStop(0, colorA + '80');
        g.addColorStop(1, '#0000');
        ctx.beginPath();
        ctx.fillStyle = g;
        ctx.arc(cx, cy, r, 0, Math.PI*2);
        ctx.fill();
      }
      if (p < 1){ requestAnimationFrame(paint); } else {
        canvas.classList.remove('active');
        ctx.clearRect(0,0,canvas.width,canvas.height);
      }
    }
    requestAnimationFrame(paint);
  }

  // Detect autoplay block → show CTA
  function detectAudioGate(){
    const el = document.getElementById('splashSound');
    if (!el) return;
    el.play().then(() => {
      el.pause(); el.currentTime = 0;
      if (window._pulseCTA) window._pulseCTA.hide();
    }).catch(() => {
      if (window._pulseCTA) window._pulseCTA.show();
    });
  }

  function boot(){
    applyAppAccents();
    dedupeAppIcons();
    applyOverlayFromArch();
    wireArchSelect();
    ensurePulseCTA();
    detectAudioGate();
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', boot);
  } else {
    boot();
  }
})();
</script>

<script id="uno-consolidation-patch">

/* === UNO CONSOLIDATION PATCH v1 (monolithic-safe) =====================
   - Canonical OpenRouter key/model handling
   - Safe override for sendAIMessage / sendAIMessageCtx
   - Unified applyArchOverlay()
   - Single boot() guard
   ==================================================================== */
(function(){
  if (window.Uno && window.Uno.__consolidated_v1) return;
  window.Uno = window.Uno || {};
  const Uno = window.Uno;
  Uno.__consolidated_v1 = true;

  // ---- Helpers ----
  function LSget(k){ try { return localStorage.getItem(k) || ''; } catch(e){ return ''; } }
  function speak(msg){ try { if (typeof window.speakWithActiveArch === 'function') window.speakWithActiveArch(msg); } catch(e){} }
  function toast(msg){ try { if (typeof window.toast === 'function') window.toast(msg,'ok'); } catch(e){} }
  function warn(msg){ try { if (typeof window.toast === 'function') window.toast(msg,'warn'); } catch(e){} }
  function errt(msg){ try { if (typeof window.toast === 'function') window.toast(msg,'err'); } catch(e){} }
  function feed(type, text){ try { if (typeof window.feedPush === 'function') window.feedPush(type, text); } catch(e){} }
  function showArchMessage(text, type){ try { if (typeof window.showArchMessage === 'function') window.showArchMessage(text, type); } catch(e){} }

  // ---- Canonical OpenRouter config ----
  Uno.getOpenRouter = function(){
    const sk = LSget('dual.keys.openrouter') || LSget('infodose:sk') || '';
    let model = LSget('dual.openrouter.model') || LSget('infodose:model') || 'openrouter/auto';
    return { sk, model };
  };

  Uno.sendChat = async function({messages, model, sk, max_tokens=600, temperature=0.7}){
    if (!sk){
      showArchMessage('Defina sua chave no Brain (OpenRouter).', 'warn');
      feed('status', 'OpenRouter: chave ausente.');
      throw new Error('OpenRouter key missing');
    }
    const url = 'https://openrouter.ai/api/v1/chat/completions';
    const payload = { model, messages, max_tokens, temperature };
    const res = await fetch(url, {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'Authorization': `Bearer ${sk}`
      },
      body: JSON.stringify(payload)
    });
    if (!res.ok){
      const body = await res.text().catch(()=>'');
      const msg = `OpenRouter HTTP ${res.status} ${body ? '• '+body.slice(0,160) : ''}`;
      feed('status', 'Erro: ' + msg);
      throw new Error(msg);
    }
    const data = await res.json();
    return data?.choices?.[0]?.message?.content || '';
  };

  // ---- Override sendAIMessage / sendAIMessageCtx (final authority) ----
  const prevCtx = window.sendAIMessageCtx;
  const prev    = window.sendAIMessage;

  window.sendAIMessageCtx = async function({ userContent, sk, model, system, temperature, max_tokens } = {}){
    try{
      const conf = Uno.getOpenRouter();
      const _sk = sk || conf.sk;
      const _model = model || conf.model || 'openrouter/auto';
      const sysMsg = system || 'Você é um assistente em português. Seja claro e objetivo.';
      const messages = [
        { role:'system', content: sysMsg },
        { role:'user', content: String(userContent||'').trim() }
      ];
      const reply = await Uno.sendChat({ messages, model:_model, sk:_sk, max_tokens: max_tokens??600, temperature: temperature??0.7 });
      return reply;
    }catch(e){
      errt('Falha sendAIMessageCtx: ' + e.message);
      throw e;
    }
  };

  window.sendAIMessage = async function(content, sk, model){
    return window.sendAIMessageCtx({ userContent: content, sk, model });
  };

  // ---- Overlay unify ----
  const ARCH_OVERLAYS = {
    atlas:  'rgba(64,158,255,0.22)',
    nova:   'rgba(255,82,177,0.22)',
    vitalis:'rgba(87,207,112,0.22)',
    pulse:  'rgba(0,191,255,0.22)',
    artemis:'rgba(255,195,0,0.22)',
    serena: 'rgba(186,130,219,0.22)',
    kaos:   'rgba(255,77,109,0.22)',
    genus:  'rgba(87,207,112,0.22)',
    lumine: 'rgba(255,213,79,0.22)',
    solus:  'rgba(186,130,219,0.22)',
    rhea:   'rgba(0,209,178,0.22)',
    aion:   'rgba(255,159,67,0.22)',
    default:'rgba(0,0,0,0)'
  };
  window.applyArchOverlay = function(name){
    try{
      const on = (localStorage.getItem('arch:overlayOn') === 'true') || (localStorage.getItem('arch:overlayOn') === '1');
      const key = String(name||'').toLowerCase();
      const color = on ? (ARCH_OVERLAYS[key] || ARCH_OVERLAYS.default) : 'rgba(0,0,0,0)';
      document.documentElement.style.setProperty('--arch-overlay', color);
      const fade = document.getElementById('arch-fadeCover');
      if (fade) fade.style.background = color;
      document.documentElement.setAttribute('data-overlay', on ? 'on' : 'off');
    }catch(e){}
  };

  // ---- Boot unify ----
  Uno.__booted = false;
  Uno.boot = function(){
    if (Uno.__booted) return;
    Uno.__booted = true;
    try {
      // Ensure overlay matches current archetype selection
      const sel = document.getElementById('arch-select');
      const base = (sel?.value || '').replace(/.*\//,'').replace(/\.html$/i,'');
      if (base) window.applyArchOverlay(base);
    } catch(e){}

    // Small connectivity helper
    window.Uno.testOpenRouter = async function(){
      const { sk, model } = Uno.getOpenRouter();
      if (!sk){ showArchMessage('Sem chave. Abra Brain e salve sua chave.', 'warn'); return; }
      try{
        const reply = await Uno.sendChat({ messages:[{role:'user', content:'Ping.'}], model, sk, max_tokens:60, temperature:0.1 });
        showArchMessage('OpenRouter OK', 'ok');
        feed('ai', 'Teste OpenRouter: ' + (reply||'(sem conteúdo)'));
      }catch(e){
        showArchMessage('OpenRouter falhou: ' + e.message, 'err');
      }
    };

    // Log
    try { console.log('%cUNO Consolidation v1 ready','background:#09223a;color:#9feaff;padding:2px 6px;border-radius:6px'); } catch(e){}
  };

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', Uno.boot, { once:true });
  } else {
    setTimeout(Uno.boot, 0);
  }
})();

</script>

    <script id="uno-fallback-patch-v1">
    (function(){ 
      if (!window.Uno || window.Uno.__fallback_patch_v1) return;
      const Uno = window.Uno; 
      Uno.__fallback_patch_v1 = true;

      function LSget(k){ try{ return localStorage.getItem(k) || ''; }catch(e){ return ''; } }
      function LSset(k,v){ try{ localStorage.setItem(k,v); }catch(e){ } }
      function feed(type, text){ try{ if (typeof window.feedPush === 'function') window.feedPush(type, text); }catch(e){ } }

      const DEFAULT_CHAIN = [
        'deepseek/deepseek-chat',
        'meta/llama-3.1-8b-instruct',
        'mistral/mistral-small-latest',
        'openrouter/auto'
      ];

      function chainFromLS(){
        const raw = LSget('dual.openrouter.fallback') || LSget('openrouter:fallback') || '';
        if (!raw) return DEFAULT_CHAIN.slice();
        return raw.split(',').map(s=>s.trim()).filter(Boolean);
      }

      // Wrap Uno.sendChat to add headers and timeout
      const _baseSend = Uno.sendChat;
      Uno.sendChat = async function({messages, model, sk, max_tokens=600, temperature=0.7, timeoutMs=30000}){
        if (!sk) throw new Error('OpenRouter key missing');
        const ctrl = new AbortController();
        const id = setTimeout(() => ctrl.abort('timeout'), timeoutMs);
        try {
          const url = 'https://openrouter.ai/api/v1/chat/completions';
          const payload = { model, messages, max_tokens, temperature };
          const res = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${sk}`,
              'HTTP-Referer': location.origin || 'http://localhost',
              'X-Title': 'HUB UNO'
            },
            body: JSON.stringify(payload),
            signal: ctrl.signal
          });
          if (!res.ok) {
            const body = await res.text().catch(()=>'');
            throw new Error(`OpenRouter HTTP ${res.status}` + (body ? ' • ' + body.slice(0,160) : ''));
          }
          const data = await res.json();
          return (data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) || '';
        } finally {
          clearTimeout(id);
        }
      };

      Uno.sendWithFallback = async function({messages, sk, preferredModel, max_tokens=600, temperature=0.7}){
        const chain = [ preferredModel || (Uno.getOpenRouter && Uno.getOpenRouter().model) || 'openrouter/auto' ]
                      .concat( chainFromLS() );
        const tried = new Set();
        let lastErr;
        for (const mdl of chain) {
          if (!mdl || tried.has(mdl)) continue;
          tried.add(mdl);
          try {
            feed('status', 'OpenRouter tentando: ' + mdl);
            const out = await Uno.sendChat({ messages, model: mdl, sk, max_tokens, temperature });
            feed('status', 'OpenRouter OK: ' + mdl);
            return out;
          } catch(e) {
            lastErr = e;
            feed('status', 'Falhou: ' + mdl + ' -> ' + (e && e.message ? e.message : e));
          }
        }
        throw lastErr || new Error('Nenhum modelo respondeu');
      };

      // Replace sendAIMessageCtx to use fallback
      const prevCtx = window.sendAIMessageCtx;
      window.sendAIMessageCtx = async function({ userContent, sk, model, system, temperature, max_tokens } = {}){
        const conf = Uno.getOpenRouter ? Uno.getOpenRouter() : { sk: '', model: 'openrouter/auto' };
        const _sk = sk || conf.sk;
        const _model = model || conf.model;
        const sysMsg = system || 'Você é um assistente em português. Seja claro e objetivo.';
        const messages = [
          { role: 'system', content: sysMsg },
          { role: 'user', content: String(userContent||'').trim() }
        ];
        return Uno.sendWithFallback({ messages, sk: _sk, preferredModel: _model, temperature: temperature ?? 0.7, max_tokens: max_tokens ?? 600 });
      };

      // Key/model compatibility layer (mirror keys both ways)
      (function syncKeys(){
        const k1 = LSget('dual.keys.openrouter') || '';
        const k2 = LSget('openrouter:key') || LSget('openrouter_key') || '';
        const k  = k1 || k2;
        if (k && !k1) LSset('dual.keys.openrouter', k);
        if (k && !k2) LSset('openrouter:key', k);

        const m1 = LSget('dual.openrouter.model') || '';
        const m2 = LSget('openrouter:model') || LSget('openrouter_model') || '';
        const m  = m1 || m2 || 'openrouter/auto';
        if (m && !m1) LSset('dual.openrouter.model', m);
        if (m && !m2) LSset('openrouter:model', m);
      })();
    })();
    </script>
    

<style id="ib-sline-style">
  :root{ --ib-a:#00c5ff; --ib-b:#ff52e5; --ib-ring:#00d9ff; --ib-glow:rgba(0,197,255,.45); }
  #ibSLine{ position:fixed; left:14px; right:14px;
    top: calc(var(--hdrH,64px) + env(safe-area-inset-top, 0px) + 6px);
    height:7px; border-radius:9999px; z-index:120;
    background:linear-gradient(90deg,var(--ib-a),var(--ib-b));
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.08), 0 4px 18px rgba(0,0,0,.28);
    overflow:hidden; opacity:.98; display:none;
  }
  #ibSLine::after{content:"";position:absolute;inset:0;mix-blend-mode:overlay;opacity:.9;
    background:repeating-linear-gradient(90deg,rgba(255,255,255,.12) 0 12px, transparent 12px 24px);
    animation:ib-scan 1600ms linear infinite;}
  @keyframes ib-scan{to{transform:translateX(24px)}}
  #ibSLine.flash{ box-shadow: inset 0 0 0 2px var(--ib-ring), 0 0 24px var(--ib-glow); }
</style>
<div id="ibSLine" role="presentation" aria-hidden="true"></div>

<script id="ib-bus-sline">
(function(){
  // --- Bus v2 (safe install) ---
  window.InfodoseBus = window.InfodoseBus || (function(){
    const L = JSON.parse(localStorage.getItem('infodose:log')||'[]');
    const H = {}; const last = new Map(); const MAX=400, THROTTLE_MS=60;
    const SCHEMA = {
      'ARCH_PULSE': { arch:'string', act:'string*' },
      'ACTION'    : { arch:'string*', act:'string*', route:'string*' },
      'HEAT_MARK' : { tag :'string*' }
    };
    const sane=(type,payload)=>{ const sch=SCHEMA[type]; if(!sch) return true;
      for(const k in sch){ const need=sch[k], opt=need.endsWith('*'), typ=opt?need.slice(0,-1):need;
        const v=payload[k]; if(v==null){ if(!opt) return false; } else if(typeof v!==typ) return false; } return true; };
    const push=evt=>{ L.unshift(evt); if(L.length>MAX) L.length=MAX;
      localStorage.setItem('infodose:log', JSON.stringify(L)); };
    return {
      emit(type, payload={}){
        const now=Date.now(), lastTs=last.get(type)||0;
        if (now-lastTs < THROTTLE_MS) return;
        if (!sane(type,payload)) return;
        last.set(type,now);
        const evt={ type, ts:now, ...payload }; push(evt);
        (H[type]||[]).forEach(fn=>{ try{ fn(evt) }catch(e){} });
        return evt;
      },
      on(type, fn){ (H[type]||(H[type]=[])).push(fn); return ()=> H[type]=(H[type]||[]).filter(f=>f!==fn); },
      dump(){ return L.slice(); }
    };
  })();

  // --- Paletas por arquétipo para a S-Line ---
  const SLC = {
    nova   : {a:'#FF52B1', b:'#FF9AD9', ring:'#FF52B1', glow:'rgba(255,82,177,.55)'},
    genus  : {a:'#52FFB1', b:'#9DFFC8', ring:'#52FFB1', glow:'rgba(82,255,177,.45)'},
    lumine : {a:'#AEC6FF', b:'#D6E0FF', ring:'#A7C4FF', glow:'rgba(167,196,255,.45)'},
    solus  : {a:'#CFE7FF', b:'#EAF2FF', ring:'#CFE7FF', glow:'rgba(207,231,255,.40)'},
    atlas  : {a:'#409EFF', b:'#7ABEFF', ring:'#3DB2FF', glow:'rgba(64,158,255,.45)'},
    rhea   : {a:'#FFD773', b:'#FFE6A3', ring:'#FFC84A', glow:'rgba(255,200,74,.45)'},
    kaos   : {a:'#FF4D6D', b:'#FF8AA1', ring:'#FF5A7A', glow:'rgba(255,77,109,.48)'},
    artemis: {a:'#FF8C3C', b:'#FFB06A', ring:'#FF9A52', glow:'rgba(255,140,60,.48)'},
    serena : {a:'#78C8FF', b:'#AEE0FF', ring:'#90D6FF', glow:'rgba(120,200,255,.45)'},
    aion   : {a:'#64F0FF', b:'#B4F9FF', ring:'#78F3FF', glow:'rgba(100,240,255,.45)'},
    pulse  : {a:'#00BFFF', b:'#3CE0FF', ring:'#00D9FF', glow:'rgba(0,191,255,.48)'},
    vitalis: {a:'#22D392', b:'#72E5BE', ring:'#29E3A3', glow:'rgba(34,211,146,.45)'}
  };
  const ARCH_EL = { nova:'madeira', genus:'madeira', lumine:'metal', solus:'metal',
    atlas:'terra', rhea:'terra', kaos:'fogo', artemis:'fogo', serena:'água', aion:'água', pulse:'ar', vitalis:'ar' };

  const SLINE = document.getElementById('ibSLine');
  function slineVars(arch){
    const C = SLC[arch] || {};
    const st = document.documentElement.style;
    st.setProperty('--ib-a', C.a || '#00c5ff');
    st.setProperty('--ib-b', C.b || '#ff52e5');
    st.setProperty('--ib-ring', C.ring || '#00d9ff');
    st.setProperty('--ib-glow', C.glow || 'rgba(0,197,255,.45)');
    if (SLINE){ SLINE.classList.add('flash'); setTimeout(()=>SLINE.classList.remove('flash'), 220); }
  }

  // --- WebAudio beeps simples + power-chord para METAL ---
  let _ac;
  function ac(){ return _ac || (_ac = new (window.AudioContext||window.webkitAudioContext)()); }
  function beep(freq=432, ms=160){
    try{ const ctx=ac(), o=ctx.createOscillator(), g=ctx.createGain();
      o.type='sine'; o.frequency.value=freq; o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(.001,ctx.currentTime); g.gain.exponentialRampToValueAtTime(.22,ctx.currentTime+.02);
      o.start(); o.stop(ctx.currentTime + ms/1000);
    }catch(e){}
  }
  function powerChord(freq=220){
    try{
      const ctx=ac(); [1,1.5,2].forEach((m,i)=>{
        const o=ctx.createOscillator(), g=ctx.createGain();
        o.type= i? 'square':'sawtooth'; o.frequency.value=freq*m; o.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(.0001,ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(.12/(i+1),ctx.currentTime+.01);
        g.gain.exponentialRampToValueAtTime(.0001,ctx.currentTime+.26);
        o.start(); o.stop(ctx.currentTime+.28);
      });
    }catch(e){}
  }

  // --- Hook nas trocas do arquétipo do HUB ---
  function currentArchBase(){
    const sel = document.getElementById('arch-select');
    if(!sel || sel.selectedIndex<0) return '';
    return (sel.options[sel.selectedIndex].value||'').replace(/.*\\//,'').replace(/\\.html$/i,'');
  }
  function fireArch(arch, act){
    slineVars(arch);
    const el = ARCH_EL[arch]; const freq = (arch==='nova'||arch==='vitalis')?528 : (arch==='atlas'?144 : (arch==='serena'||arch==='genus'?396 : 432));
    if (el==='metal') powerChord(freq); else beep(freq);
    window.InfodoseBus.emit('ARCH_PULSE', { arch, act: act||'switch' });
  }

  function bindHooks(){
    const sel  = document.getElementById('arch-select');
    const prev = document.getElementById('arch-prev');
    const next = document.getElementById('arch-next');
    sel && sel.addEventListener('change', ()=> setTimeout(()=> fireArch(currentArchBase(),'select'), 0), {passive:true});
    prev && prev.addEventListener('click', ()=> setTimeout(()=> fireArch(currentArchBase(),'prev'), 160), {passive:true});
    next && next.addEventListener('click', ()=> setTimeout(()=> fireArch(currentArchBase(),'next'), 160), {passive:true});
    // disparo inicial
    const start = currentArchBase(); if (start) setTimeout(()=> fireArch(start,'boot'), 120);
  }

  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', bindHooks); else bindHooks();
})();
</script>
<!-- === /INFODOSE • end merge === -->

<style id="ib-hud-style">
  #ibHUD{position:fixed;left:12px;right:12px;top:calc(env(safe-area-inset-top,0px)+14px+10px);
    padding:10px 12px;border-radius:14px;background:rgba(8,12,20,.92);color:#eaf1ff;
    box-shadow:0 10px 26px rgba(0,0,0,.35);z-index:130;backdrop-filter:blur(8px);display:none}
  #ibHUD b{font-weight:700} #ibHUD small{opacity:.8}
</style>
<div id="ibHUD" role="status" aria-live="polite"></div>
<script id="ib-apps-addon">
(function(){
  // --- Palette clone (for S-Line update) ---
  const SLC = {
    nova   : {a:'#FF52B1', b:'#FF9AD9', ring:'#FF52B1', glow:'rgba(255,82,177,.55)'},
    genus  : {a:'#52FFB1', b:'#9DFFC8', ring:'#52FFB1', glow:'rgba(82,255,177,.45)'},
    lumine : {a:'#AEC6FF', b:'#D6E0FF', ring:'#A7C4FF', glow:'rgba(167,196,255,.45)'},
    solus  : {a:'#CFE7FF', b:'#EAF2FF', ring:'#CFE7FF', glow:'rgba(207,231,255,.40)'},
    atlas  : {a:'#409EFF', b:'#7ABEFF', ring:'#3DB2FF', glow:'rgba(64,158,255,.45)'},
    rhea   : {a:'#FFD773', b:'#FFE6A3', ring:'#FFC84A', glow:'rgba(255,200,74,.45)'},
    kaos   : {a:'#FF4D6D', b:'#FF8AA1', ring:'#FF5A7A', glow:'rgba(255,77,109,.48)'},
    artemis: {a:'#FF8C3C', b:'#FFB06A', ring:'#FF9A52', glow:'rgba(255,140,60,.48)'},
    serena : {a:'#78C8FF', b:'#AEE0FF', ring:'#90D6FF', glow:'rgba(120,200,255,.45)'},
    aion   : {a:'#64F0FF', b:'#B4F9FF', ring:'#78F3FF', glow:'rgba(100,240,255,.45)'},
    pulse  : {a:'#00BFFF', b:'#3CE0FF', ring:'#00D9FF', glow:'rgba(0,191,255,.48)'},
    vitalis: {a:'#22D392', b:'#72E5BE', ring:'#29E3A3', glow:'rgba(34,211,146,.45)'}
  };
  const ORDER = Object.keys(SLC);

  function setSLineArch(arch){
    const C = SLC[arch]||{}; const rs = document.documentElement.style;
    rs.setProperty('--ib-a', C.a || '#00c5ff');
    rs.setProperty('--ib-b', C.b || '#ff52e5');
    rs.setProperty('--ib-ring', C.ring || '#00d9ff');
    rs.setProperty('--ib-glow', C.glow || 'rgba(0,197,255,.45)');
    const bar = document.getElementById('ibSLine'); if (bar){ bar.classList.add('flash'); setTimeout(()=>bar.classList.remove('flash'), 220); }
  }
  // Audio (tiny)
  let _ac; function ac(){ return _ac || (_ac=new (window.AudioContext||window.webkitAudioContext)()); }
  function beep(freq=432, ms=160){ try{ const c=ac(), o=c.createOscillator(), g=c.createGain(); o.type='sine'; o.frequency.value=freq; o.connect(g); g.connect(c.destination);
    g.gain.setValueAtTime(.001,c.currentTime); g.gain.exponentialRampToValueAtTime(.22,c.currentTime+.02); o.start(); o.stop(c.currentTime+ms/1000);}catch(e){} }
  function chord(freq=220){ try{ const c=ac(); [1,1.5,2].forEach((m,i)=>{ const o=c.createOscillator(), g=c.createGain(); o.type=i?'square':'sawtooth'; o.frequency.value=freq*m; o.connect(g); g.connect(c.destination);
    g.gain.setValueAtTime(.0001,c.currentTime); g.gain.exponentialRampToValueAtTime(.12/(i+1),c.currentTime+.01); g.gain.exponentialRampToValueAtTime(.0001,c.currentTime+.26); o.start(); o.stop(c.currentTime+.28);});}catch(e){} }

  function currentArch(){
    return localStorage.getItem('infodose:arch.active') || (document.querySelector('#arch-select option:checked')?.value||'atlas').replace(/.*\\//,'').replace(/\\.html$/i,'');
  }

  // --- Apps -> Bus (delegated) ---
  function resolveApp(el){
    const ds = el.dataset||{};
    if (ds.app)  return ds.app;
    if (ds.open) return ds.open;
    if (ds.route) return ds.route.replace(/^app\\.|\\.open$/g,'').replace(/[^a-z0-9_\\-]+/gi,'').toLowerCase();
    const href = el.getAttribute('href')||'';
    if (/^app:/.test(href)) return href.slice(4);
    const m = href.match(/#app-([a-z0-9_\\-]+)/i); if (m) return m[1];
    const txt = (el.textContent||'').trim().toLowerCase().replace(/\\s+/g,'-').replace(/[^a-z0-9_\\-]+/g,'');
    return txt || 'app';
  }
  document.addEventListener('click', (e)=>{
    const sel = e.target.closest('[data-app],[data-route],[data-open],.app-card,.app,[href^=\"app:\"],[href*=\"#app-\"]');
    if (!sel) return;
    const app = resolveApp(sel);
    const arch = sel.getAttribute('data-arch') || currentArch();
    const route = sel.getAttribute('data-route') || `app.${app}.open`;
    window.InfodoseBus && window.InfodoseBus.emit('ACTION', { arch, act:'open', route });
    window.InfodoseBus && window.InfodoseBus.emit('APP_OPEN', { app, arch, route });
    if (sel.getAttribute('data-arch')){ setSLineArch(arch); if (arch==='lumine'||arch==='solus') chord(ARCH_FREQ(arch)); else beep(ARCH_FREQ(arch)); }
  }, {passive:true});

  function ARCH_FREQ(arch){
    switch(arch){ case 'nova': case 'vitalis': return 528; case 'atlas': return 144; case 'serena': case 'genus': return 396; default: return 432; }
  }

  // --- S-Line: HUD + interactions ---
  const HUD = document.getElementById('ibHUD'); const BAR = document.getElementById('ibSLine');
  function hudText(){
    const arch = currentArch();
    let size = 0, last = '—';
    try{ const L = JSON.parse(localStorage.getItem('infodose:log')||'[]'); size = L.length||0; if (L[0]) last = `${L[0].type} @ ${new Date(L[0].ts).toLocaleTimeString()}`; }catch(e){}
    return `<b>Status</b><br><small>pele:</small> ${arch} • <small>log:</small> ${size} • <small>último:</small> ${last}`;
  }
  function hudToggle(){ if(!HUD) return; if (HUD.style.display==='block'){ HUD.style.display='none'; } else { HUD.innerHTML=hudText(); HUD.style.display='block'; setTimeout(()=>{ if (HUD.style.display==='block') HUD.style.display='none'; }, 3000); } }

  // double click => step next arch (visual/som/evento)
  function stepNext(){
    const arch = currentArch(); const i = Math.max(0, ORDER.indexOf(arch)); const nx = ORDER[(i+1)%ORDER.length];
    setSLineArch(nx); if (nx==='lumine'||nx==='solus') chord(ARCH_FREQ(nx)); else beep(ARCH_FREQ(nx));
    window.InfodoseBus && window.InfodoseBus.emit('ARCH_PULSE', { arch:nx, act:'sline-step' });
    localStorage.setItem('infodose:arch.active', nx);
  }

  // long press => auto-ronda toggle
  let pressT=null, rondaT=null, running=false;
  function startRonda(){ if(running) return; running=true; const SEC=4; let i=0;
    const arr=ORDER.slice(); function tick(){ const nx = arr[i%arr.length]; i++; setSLineArch(nx); (nx==='lumine'||nx==='solus')?chord(ARCH_FREQ(nx)):beep(ARCH_FREQ(nx));
      window.InfodoseBus && window.InfodoseBus.emit('ARCH_PULSE', { arch:nx, act:'sline-ronda' });
      localStorage.setItem('infodose:arch.active', nx); rondaT=setTimeout(tick, SEC*1000); } tick(); }
  function stopRonda(){ running=false; if(rondaT) clearTimeout(rondaT); rondaT=null; }

  if (BAR){
    BAR.addEventListener('click', hudToggle, {passive:true});
    BAR.addEventListener('dblclick', stepNext, {passive:true});
    BAR.addEventListener('touchstart', ()=>{ pressT=setTimeout(()=>{ running?stopRonda():startRonda(); }, 520); }, {passive:true});
    BAR.addEventListener('touchend', ()=>{ if(pressT){ clearTimeout(pressT); pressT=null; } }, {passive:true});
  }
})();
</script>
<!-- === /INFODOSE • end addon === -->

<style id="ib-audio-style">
  .ib-io{display:flex;gap:8px;flex-wrap:wrap}
  .ib-io .btn{flex:1 1 140px}
  input[type="file"]#ibPackIn{display:none}
</style>
<div class="panel ib-io">
  <button class="btn" id="ibPackSave">Salvar Pack</button>
  <button class="btn" id="ibPackLoad">Importar Pack</button>
  <input id="ibPackIn" type="file" accept="application/json"/>
</div>
<script id="ib-audio-engine">
(() => {
  const A4_432 = 432, A4_440 = 440, BASE_220 = 220;
  const storage = {
    get(k, def){ try{ return JSON.parse(localStorage.getItem(k) ?? JSON.stringify(def)); }catch(_){ return def; } },
    set(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
  };

  // ===== Synth plumbing =====
  const AC = new (window.AudioContext || window.webkitAudioContext)();
  const master = AC.createGain(); master.gain.value = 0.9; master.connect(AC.destination);

  function envGain(a=0.01, d=0.15, s=0.6, r=0.2){
    const g = AC.createGain();
    g.gain.setValueAtTime(0.0001, AC.currentTime);
    const now = AC.currentTime;
    g.gain.exponentialRampToValueAtTime(1.0, now + a);
    g.gain.exponentialRampToValueAtTime(s, now + a + d);
    g.release = () => {
      const t = AC.currentTime;
      g.gain.cancelScheduledValues(t);
      g.gain.setValueAtTime(g.gain.value || 0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.0001, t + r);
      setTimeout(()=> g.disconnect(), r*1000 + 50);
    };
    return g;
  }

  function biquad(type="lowpass", freq=1200, Q=0.7){
    const f = AC.createBiquadFilter();
    f.type = type; f.frequency.value = freq; f.Q.value = Q;
    return f;
  }

  function lfo(targetParam, rate=4.0, depth=30, isHz=true){
    const o = AC.createOscillator(); o.type = "sine";
    const g = AC.createGain(); g.gain.value = isHz ? depth : targetParam.value * depth;
    o.connect(g); g.connect(targetParam); o.start();
    o.onended = () => { try{g.disconnect();}catch(_){} };
    o.frequency.value = rate;
    return o;
  }

  function noise(){
    const b = AC.createBuffer(1, AC.sampleRate * 1.5, AC.sampleRate);
    const d = b.getChannelData(0);
    for(let i=0;i<d.length;i++) d[i] = Math.random()*2-1;
    const src = AC.createBufferSource(); src.buffer = b; src.loop = true;
    return src;
  }

  function waveshaper(amount=2.0){
    const n = 1024, c = new Float32Array(n);
    for(let i=0;i<n;i++){ const x = i*2/n-1; c[i] = Math.tanh(amount*x); }
    const ws = AC.createWaveShaper(); ws.curve = c; ws.oversample = '4x';
    return ws;
  }

  function delay(ms=120, fb=0.25, wet=0.3){
    const d = AC.createDelay(); d.delayTime.value = ms/1000;
    const g = AC.createGain(); g.gain.value = fb;
    const mix = AC.createGain(); mix.gain.value = wet;
    d.connect(g); g.connect(d); // feedback loop
    return { node:d, fb:g, mix };
  }

  // ===== Archetype param table (visual already exists) =====
  const defs = {
    atlas:   { phrase:"Eu organizo o fluxo com sabedoria cósmica", overlay:"rgba(64,158,255,.22)", osc:"sawtooth",  env:[0.02,0.18,0.7,0.18], filt:["lowpass",1400,0.9], lfo:{rate:2.0, depth:8, target:"filter"} },
    nova:    { phrase:"Ideias são sementes! Vamos colorir fora das linhas", overlay:"rgba(255,82,177,.22)", osc:"sine", env:[0.01,0.10,0.4,0.18], glide:true, noise:true, filt:["highpass",900,0.6], lfo:{rate:5.5, depth:20, target:"pitch"} },
    vitalis: { phrase:"Ação agora! Cada segundo é combustível", overlay:"rgba(34,211,146,.22)", osc:"sawtooth", env:[0.005,0.06,0.5,0.09], filt:["lowpass",1600,0.6], lfo:{rate:7.5, depth:0.25, target:"amp"} },
    pulse:   { phrase:"Sinta a corrente… você não está sozinho", overlay:"rgba(0,191,255,.22)",  osc:"sine", env:[0.02,0.18,0.8,0.25], filt:["lowpass",1100,0.7], lfo:{rate:1.8, depth:0.45, target:"amp"}, delay:[140,0.35,0.25] },
    artemis: { phrase:"O mapa é só o começo. Onde queremos ir?", overlay:"rgba(255,140,60,.22)", osc:"triangle", env:[0.01,0.12,0.6,0.16], sweep:true, filt:["bandpass",1500,1.2], lfo:{rate:3.0, depth:60, target:"filter"} },
    serena:  { phrase:"Respire. Este espaço é seu.", overlay:"rgba(120,200,255,.18)", osc:"sine", env:[0.25,0.6,0.85,0.8], filt:["lowpass",800,0.9], lfo:{rate:0.6, depth:0.2, target:"amp"}, delay:[220,0.45,0.35] },
    kaos:    { phrase:"Quebre as regras. O caos é a verdadeira ordem.", overlay:"rgba(255,77,109,.22)", osc:"square", env:[0.004,0.05,0.5,0.06], filt:["highpass",1200,0.4], noise:true, drive:3.2, lfo:{rate:9.0, depth:120, target:"filter"} },
    genus:   { phrase:"Mãos à obra! Vamos construir o impossível.", overlay:"rgba(82,255,177,.20)", osc:"square", env:[0.01,0.10,0.5,0.14], fm:{ratio:2.0, index:70}, filt:["bandpass",1400,1.1] },
    lumine:  { phrase:"Ria! A luz está em você!", overlay:"rgba(180,200,255,.20)", osc:"triangle", env:[0.005,0.08,0.6,0.12], arp:[0,4,7,12], lfo:{rate:5.5, depth:40, target:"pitch"} },
    solus:   { phrase:"O silêncio guarda respostas que o barulho ignora.", overlay:"rgba(220,240,255,.16)", osc:"sine", env:[0.6,0.8,0.9,1.2], filt:["lowpass",620,1.0] },
    rhea:    { phrase:"Somos fios da mesma teia cósmica", overlay:"rgba(255,220,120,.18)", osc:"sawtooth", env:[0.08,0.35,0.75,0.5], phaser:true, filt:["lowpass",1000,0.7] },
    aion:    { phrase:"Sou o tempo vivo, ritmo da eternidade", overlay:"rgba(100,240,255,.16)", osc:"sine", env:[0.005,0.05,0.6,0.05], clock:true, filt:["highpass",400,0.8] }
  };

  // Persist/restore custom packs
  const packKey = "infodose:archetypes.pack";
  const saved = storage.get(packKey, null);
  if (saved) Object.assign(defs, saved);

  // Global tuning
  const tuneKey = "infodose:tuning";
  const tuning = storage.get(tuneKey, {A4:A4_432});
  const hz = (semi=0) => (tuning.A4 || A4_432) * Math.pow(2, semi/12);

  function trig(arch){
    const d = defs[arch]; if(!d) return;
    // voice chain
    const out = master;
    const g = envGain(...(d.env||[0.01,0.1,0.6,0.2])); g.connect(out);

    // filter
    const f = d.filt ? biquad(...d.filt) : null;
    if (f) { f.connect(g); }

    // source(s)
    const carrier = AC.createOscillator();
    carrier.type = d.osc || "sine";
    // base freq pick: a simple chord degree mapping per arch
    let base = BASE_220; // A3 ~ 220Hz base
    if (arch==="atlas") base = hz(-12);
    if (arch==="nova") base = hz(0);
    if (arch==="vitalis") base = hz(2);
    if (arch==="pulse") base = hz(-5);
    if (arch==="artemis") base = hz(7);
    if (arch==="serena") base = hz(-9);
    if (arch==="kaos") base = hz(5);
    if (arch==="genus") base = hz(12);
    if (arch==="lumine") base = hz(9);
    if (arch==="solus") base = hz(-12);
    if (arch==="rhea") base = hz(-7);
    if (arch==="aion") base = hz(0);

    carrier.frequency.value = base;

    // FM (Genus)
    let mod=null, modGain=null;
    if (d.fm){
      mod = AC.createOscillator(); mod.type = "sine"; mod.frequency.value = base * (d.fm.ratio||2);
      modGain = AC.createGain(); modGain.gain.value = d.fm.index||50;
      mod.connect(modGain); modGain.connect(carrier.frequency);
      mod.start();
    }

    // Noise / Drive
    let ns=null, ws=null;
    if (d.noise){
      ns = noise();
      if (f) ns.connect(f); else ns.connect(g);
      ns.start();
    }
    if (d.drive){
      ws = waveshaper(d.drive);
    }

    // Arp (Lumine)
    if (d.arp){
      const seq = d.arp; let i=0;
      const timer = setInterval(()=>{ carrier.frequency.setTargetAtTime(base*Math.pow(2, seq[i%seq.length]/12), AC.currentTime, .01); i++; }, 90);
      setTimeout(()=> clearInterval(timer), 500);
    }

    // Sweeps / Glide (Artemis/Nova)
    if (d.sweep){
      const now=AC.currentTime;
      const tgt = base*1.5;
      carrier.frequency.setTargetAtTime(tgt, now, .12);
      carrier.frequency.setTargetAtTime(base, now+.25, .22);
    }
    if (d.glide){
      const now=AC.currentTime;
      carrier.frequency.setTargetAtTime(base*1.25, now, .06);
      carrier.frequency.setTargetAtTime(base, now+.12, .08);
    }

    // Phaser (Rhea) rudimentary
    let phLFO=null, phaser=[];
    if (d.phaser){
      for(let k=0;k<3;k++){ const bp=biquad("bandpass", 400*(k+1), 8); phaser.push(bp); if(k===0){ if(f) f.connect(bp); else carrier.connect(bp); } else phaser[k-1].connect(bp); }
      phaser[phaser.length-1].connect(g);
      phLFO = lfo(phaser[0].frequency, 0.25, 220, true);
    }

    // Clock (Aion)
    if (d.clock){
      // simple click train synced to 90 bpm (change with ronda)
      const bpm = 90; const beat = 60/bpm;
      for(let k=0;k<6;k++){
        const t = AC.currentTime + k*beat;
        const kosc = AC.createOscillator(); kosc.type="square"; kosc.frequency.value = hz(24);
        const kg = AC.createGain(); kg.gain.value = 0.0001;
        kosc.connect(kg); if (f) kg.connect(f); else kg.connect(g);
        kg.gain.setValueAtTime(0.6, t); kg.gain.exponentialRampToValueAtTime(0.0001, t+0.08);
        kosc.start(t); kosc.stop(t+0.09);
      }
    }

    // Delay (Pulse, Serena)
    let dnode=null;
    if (d.delay){
      const {node, fb, mix} = delay(...d.delay);
      dnode = node; const tap = AC.createGain(); tap.gain.value = 1.0;
      if (f) { if (ws){ carrier.connect(ws); ws.connect(f); } else { carrier.connect(f); } f.connect(node); node.connect(fb); node.connect(mix); mix.connect(g); }
      else   { if (ws){ carrier.connect(ws); ws.connect(node); } else { carrier.connect(node); } node.connect(fb); node.connect(mix); mix.connect(g); }
    }

    // LFO target
    let oLFO=null;
    if (d.lfo){
      if (d.lfo.target==="filter" && f) oLFO = lfo(f.frequency, d.lfo.rate, d.lfo.depth, true);
      else if (d.lfo.target==="amp")     oLFO = lfo(g.gain, d.lfo.rate, d.lfo.depth, false);
      else if (d.lfo.target==="pitch")   oLFO = lfo(carrier.frequency, d.lfo.rate, d.lfo.depth, true);
    }

    // Connect & start
    if (!d.phaser){
      if (f) { if (ws){ carrier.connect(ws); ws.connect(f); } else { carrier.connect(f); } f.connect(g); }
      else   { if (ws){ carrier.connect(ws); ws.connect(g); } else { carrier.connect(g); } }
    }
    carrier.start();

    // Release
    setTimeout(()=>{
      try{carrier.stop();}catch(_){}
      if (ns) try{ns.stop();}catch(_){}
      g.release();
      [f, ws, dnode, mod, modGain, oLFO, phLFO, ...phaser].forEach(n=>{ try{n.disconnect();}catch(_){} });
    }, 520);
  }

  // Hook BUS
  if (window.InfodoseBus && window.InfodoseBus.on){
    InfodoseBus.on('ARCH_PULSE', e => {
      // tuning hooks (central modulators)
      const a = (e.arch||"").toLowerCase();
      if (a==="koblux" || a==="kobllux" || a==="kobluxx"){ tuning.A4 = A4_432; storage.set(tuneKey, tuning); }
      if (a==="kodux"){ tuning.A4 = A4_440; storage.set(tuneKey, tuning); }
      if (a==="bllue" || a==="blue"){ tuning.A4 = BASE_220*2; storage.set(tuneKey, tuning); } // 220*2=440 as variant
      trig(e.arch);
    });
  }

  // Save / Load pack
  function savePack(){
    const blob = new Blob([JSON.stringify(defs,null,2)], {type:"application/json"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = "infodose_archetypes_pack.json";
    a.click();
    storage.set(packKey, defs);
  }
  function loadPack(obj){
    try{
      Object.assign(defs, obj||{});
      storage.set(packKey, defs);
      alert("Pack importado!");
    }catch(e){ alert("Falha ao importar pack."); }
  }

  // Wire buttons
  const btnSv = document.getElementById('ibPackSave');
  const btnLd = document.getElementById('ibPackLoad');
  const inLd  = document.getElementById('ibPackIn');
  if (btnSv) btnSv.addEventListener('click', savePack);
  if (btnLd) btnLd.addEventListener('click', ()=> inLd.click());
  if (inLd)  inLd.addEventListener('change', async (ev)=>{
    const file = ev.target.files && ev.target.files[0]; if(!file) return;
    const txt = await file.text(); loadPack(JSON.parse(txt));
  });
})();
</script>
<!-- === /INFODOSE • end audio engine === -->

<script>
// 78K · Dual Strip Controller (pulsating borders + fusion)
(function(){
  // remove old panels
  ['led78k','led78k-micro'].forEach(id=>{ const n=document.getElementById(id); n && n.remove(); });

  const main = document.getElementById('ledstrip-78k');
  const fusion = document.getElementById('ledstrip-fusion');
  if(!main) return;
  const el = {
    eng:  main.querySelector('.lane.eng'),
    hr:   main.querySelector('.lane.hr'),
    loop: main.querySelector('.lane.loop'),
    qa:   main.querySelector('.lane.qa'),
    spark:main.querySelector('.spark')
  };
  const state = { eng:0, hr:0, loopPct:0, qa:false, pos:0 };
  const clamp01 = x => Math.max(0, Math.min(1, x));

  // archetype color map
  const ARCH_COLORS = {
    nova:'#FF52B1', genus:'#52FFB1', lumine:'#B4C8FF', solus:'#DCF0FF',
    atlas:'#409EFF', rhea:'#FFD878', kaos:'#FF4D6D', artemis:'#FF8C3C',
    serena:'#78C8FF', aion:'#64F0FF', pulse:'#00BFFF', vitalis:'#22D392'
  };
  function setArchetypeColors(a,b){
    const A = ARCH_COLORS[(a||'').toLowerCase()] || '#409eff';
    const B = ARCH_COLORS[(b||'').toLowerCase()] || '#ff52b1';
    main.style.setProperty('--archA', A);
    main.style.setProperty('--archB', B);
    fusion && (fusion.style.background = 'linear-gradient(90deg,'+A+','+B+')');
  }

  function render(){
    if(el.eng)  el.eng.style.width  = (clamp01(state.eng/24)*100).toFixed(1) + '%';
    if(el.hr)   el.hr.style.width   = (clamp01(state.hr/24)*100).toFixed(1) + '%';
    if(el.loop) el.loop.style.width = (clamp01(state.loopPct)*100).toFixed(1) + '%';
    if(el.qa) { el.qa.style.width = state.qa ? '100%' : '0%'; el.qa.style.opacity = state.qa ? .35 : 0; }
  }
  // decay + spark
  setInterval(()=>{
    state.eng = Math.max(0, state.eng - 1);
    state.hr  = Math.max(0, state.hr  - 1);
    state.pos = (state.pos+1)%100;
    if(el.spark){
      const p = (state.pos/100)*100;
      el.spark.style.transform = 'translateX(' + p + '%)';
      el.spark.style.opacity = (state.eng+state.hr)>0 ? .8 : .0;
    }
    render();
  }, 900);

  // API
  window.LEDSTRIP = {
    pulseENG(){ state.eng += 2; render(); },
    pulseHR(){  state.hr  += 2; render(); },
    setLoopPhase(name){
      const map = { "Isca": .25, "Progresso": .50, "Tensão": .75, "Liberação": 1.0 };
      state.loopPct = map[name] || 0;
      render();
    },
    setQA(flag){ state.qa = !!flag; render(); },
    setArchetypes(a,b){ setArchetypeColors(a,b); },
    setCompact(flag){ const wrap = main.parentElement; if(!wrap) return; wrap.classList.toggle('compact', !!flag); }
  };

  // auto-wire minimal
  const incENG = ()=>{ try{ LEDSTRIP.pulseENG(); }catch{} };
  const incHR  = ()=>{ try{ LEDSTRIP.pulseHR();  }catch{} };
  document.addEventListener('click', (e)=>{
    const tb = e.target.closest('.tabbar .tab, [data-nav]');
    if(tb){ incENG(); }
  }, true);

  const openAppFn = window.openApp;
  if(typeof openAppFn === 'function'){
    window.openApp = function(a){ incENG(); return openAppFn.apply(this, arguments); };
  }
  const sendUserMessageFn = window.sendUserMessage;
  if(typeof sendUserMessageFn === 'function'){
    window.sendUserMessage = async function(msg){ incENG(); const r = await sendUserMessageFn.apply(this, arguments); return r; };
  }
  const renderAssistantReplyFn = window.renderAssistantReply;
  if(typeof renderAssistantReplyFn === 'function'){
    window.renderAssistantReply = function(raw){ incHR(); return renderAssistantReplyFn.apply(this, arguments); };
  }

  // initial defaults
  try{
    const hasKey = !!(localStorage.getItem('dual.keys.openrouter')||'').trim();
    const hasModel = !!(localStorage.getItem('infodose:model')||localStorage.getItem('dual.openrouter.model')||'').trim();
    LEDSTRIP.setQA(hasKey && hasModel);

    const sel = document.getElementById('arch-select');
    const cur = (sel?.value || 'Atlas').replace(/\.html$/,'');
    const idx = sel ? sel.selectedIndex : 0;
    const nxt = sel ? (sel.options[(idx+1) % sel.options.length].value.replace(/\.html$/,'')) : 'Nova';
    LEDSTRIP.setArchetypes(cur, nxt);
  }catch{}
})();
</script>

<script>
// 78K · Fusion Ritual (button ✦ Fusionar)
(function(){
  const btn = document.getElementById('btn-fusionar');
  if(!btn || !window.LEDSTRIP) return;
  const fusionBar = document.getElementById('ledstrip-fusion');

  // animate fusion gradient flow + loop advance to Liberação in ~3s
  function fusionRitual(duration=3000){
    try{
      const sel = document.getElementById('arch-select');
      const cur = (sel?.value || 'Atlas').replace(/\.html$/,'');
      const idx = sel ? sel.selectedIndex : 0;
      const nxt = sel ? (sel.options[(idx+1) % sel.options.length].value.replace(/\.html$/,'')) : 'Nova';
      LEDSTRIP.setArchetypes(cur, nxt);
    }catch{}

    // staged loop advancement
    const steps = [
      {t: 0.00, phase:'Isca'},
      {t: 0.33, phase:'Progresso'},
      {t: 0.66, phase:'Tensão'},
      {t: 1.00, phase:'Liberação'}
    ];

    const t0 = performance.now();
    const startPos = 0; const endPos = 100;
    const raf = (now)=>{
      const dt = Math.min(1, (now - t0) / duration);
      // advance loop by milestones
      for(const s of steps){
        if(Math.abs(dt - s.t) < 0.02){ LEDSTRIP.setLoopPhase(s.phase); }
      }
      // background flow animation
      if(fusionBar){
        fusionBar.style.backgroundSize = '200% 100%';
        fusionBar.style.backgroundPosition = (startPos + (endPos-startPos)*dt) + '% 0%';
        fusionBar.style.opacity = String(.62 + .28*Math.sin(dt*Math.PI));
      }
      if(dt < 1){ requestAnimationFrame(raf); }
      else{
        // settle
        if(fusionBar){
          fusionBar.style.backgroundSize = '';
          fusionBar.style.backgroundPosition = '';
          fusionBar.style.opacity = '.72';
        }
      }
    };
    requestAnimationFrame(raf);
  }

  btn.addEventListener('click', ()=>{
    fusionRitual(3000);
    // give some feedback
    try{ LEDSTRIP.pulseENG(); LEDSTRIP.pulseHR(); }catch{}
  });
  // expose for console
  window.LEDSTRIP && (window.LEDSTRIP.fusionRitual = fusionRitual);
})();
</script>

<!-- PATCH: Fusionar button wiring (no toasts) -->


<script id="dual-fusionar-patch">
(() => {
  const $ = (q, r=document)=>r.querySelector(q);
  const LS = {
    get:(k,d)=>{ try{ const v=localStorage.getItem(k); return v!=null? JSON.parse(v): d }catch(_){ return d } },
    set:(k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)) }catch(_){ } },
  };
  const COLORS = {
    atlas:'#409EFF', nova:'#FF52B1', vitalis:'#22C55E', pulse:'#00BFFF',
    artemis:'#FFC300', serena:'#B684FF', kaos:'#FF4D6D', genus:'#57CF70',
    lumine:'#FFD54F', rhea:'#00D1B2', solus:'#6495ED', aion:'#FF9F43'
  };
  const btn = document.getElementById('btn-fusionar');
  const bar = document.getElementById('ledstrip-fusion');
  const stripMain = document.getElementById('ledstrip-78k');
  const sel = $('#arch-select');

  function baseName(path){ return String(path||'').replace(/^.*\//,'').replace(/\.html$/i,'').toLowerCase(); }
  function cap(s){ return s? s[0].toUpperCase()+s.slice(1): s; }
  function currentArch(){
    if (!sel) return 'atlas';
    const v = sel.value || '';
    return baseName(v) || 'atlas';
  }
  function readEnabled(){ return !!LS.get('dual.fusion.enabled', false); }
  function readPair(){ return String(LS.get('dual.fusion.pair','')||''); }
  function writePair(p){ LS.set('dual.fusion.pair', p); }
  function writeEnabled(v){ LS.set('dual.fusion.enabled', !!v); }

  function gradientFor(a,b){
    const ca = COLORS[a] || '#00c2ff', cb = COLORS[b] || '#ff52e5';
    return `linear-gradient(90deg, ${ca}, ${cb})`;
  }
  function clearStripVisuals(){
    if (bar){
      bar.setAttribute('aria-hidden','true');
      bar.style.opacity = '0';
      bar.style.background = 'transparent';
    }
    if (stripMain){
      stripMain.style.removeProperty('--archA');
      stripMain.style.removeProperty('--archB');
    }
  }
  function labelFor(enabled, pairStr){
    if (!enabled) return '✦ Fusionar';
    return pairStr ? `✦ Fusão: ${pairStr}` : '✦ Fusão';
  }
  function applyVisuals(enabled, pair){
    btn.classList.toggle('on', !!enabled);
    btn.textContent = labelFor(enabled, pair);
    if (!enabled){ clearStripVisuals(); return; }
    const [a,b] = (pair||'').split('+').map(s=>s.trim().toLowerCase());
    if (bar){
      bar.setAttribute('aria-hidden','false');
      bar.style.opacity = '0.92';
      if (a && b) bar.style.background = gradientFor(a,b);
    }
    if (stripMain && a && b){
      stripMain.style.setProperty('--archA', COLORS[a] || '#409eff');
      stripMain.style.setProperty('--archB', COLORS[b] || '#ff52b1');
    }
  }
  function emitChange(enabled, pair){
    try {
      const [a,b] = (pair||'').split('+').map(s=>s.trim().toLowerCase());
      window.dispatchEvent(new CustomEvent('dual:fusion-change', { detail: { enabled, pair, a, b } }));
    } catch(_){}
  }
  function pickDefaultPair(){
    const a = currentArch();
    const order = ['atlas','nova','vitalis','pulse','artemis','serena','kaos','genus','lumine','rhea','solus','aion'];
    const i = Math.max(0, order.indexOf(a));
    const b = order[(i+1) % order.length];
    return `${cap(a)}+${cap(b)}`;
  }
  function normalizePairName(str){
    if (!str) return '';
    const parts = str.split('+').map(s=>baseName(s).replace(/[^a-z]/g,''));
    if (parts.length<2) return '';
    return `${cap(parts[0])}+${cap(parts[1])}`;
  }

  function refreshFromLS(){
    // ensure default OFF when absent
    if (localStorage.getItem('dual.fusion.enabled') === null) writeEnabled(false);

    let enabled = readEnabled();
    let pair = readPair();

    // If enabled and pair is missing or mismatched with current arch for slot A, realign A with current
    if (enabled){
      const arch = currentArch();
      if (!pair){
        pair = normalizePairName(pickDefaultPair());
        writePair(pair);
      } else {
        const [A,B] = pair.split('+').map(s=>s.trim());
        const aBase = baseName(A);
        if (aBase !== arch){
          pair = `${cap(arch)}+${B||'Nova'}`; // keep B if present
          writePair(pair);
        }
      }
    }

    applyVisuals(enabled, pair);
  }

  function toggle(){
    const enabled = !readEnabled();
    writeEnabled(enabled);
    if (enabled){
      // ensure pair exists and aligns with current A
      let pair = readPair();
      if (!pair) pair = normalizePairName(pickDefaultPair());
      const arch = currentArch();
      const parts = pair.split('+').map(s=>s.trim());
      const newPair = `${cap(baseName(arch))}+${cap(baseName(parts[1]||'Nova'))}`;
      writePair(newPair);
      applyVisuals(true, newPair);
      emitChange(true, newPair);
      // local toast hook (if defined in this page)
      if (typeof window.dualToast === 'function') window.dualToast(`Fusão ON · ${newPair}`);
    } else {
      applyVisuals(false, readPair());
      emitChange(false, readPair());
      if (typeof window.dualToast === 'function') window.dualToast('Fusão OFF');
    }
  }

  function init(){
    // initial paint
    refreshFromLS();
    // click handler
    btn.addEventListener('click', toggle);
    // react to archetype select changes (only when enabled)
    if (sel){
      sel.addEventListener('change', () => {
        if (!readEnabled()) return;
        // update A slot to current arch, keep B
        let pair = readPair();
        const [A,B] = (pair||'').split('+').map(s=>s.trim());
        const arch = currentArch();
        const newPair = `${cap(baseName(arch))}+${cap(baseName(B||'Nova'))}`;
        writePair(newPair);
        applyVisuals(true, newPair);
        emitChange(true, newPair);
      });
    }
    // react to external changes
    window.addEventListener('dual:fusion-change', () => refreshFromLS());
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();
})();
</script>


<div id="dual-toast-stack" aria-live="polite" aria-atomic="true"></div>
<script>
// Local toast (Boost) — scoped to this page only
window.dualToast = (msg, ms=2000) => {
  try {
    let stack = document.getElementById('dual-toast-stack');
    if (!stack){ stack = document.createElement('div'); stack.id='dual-toast-stack'; document.body.appendChild(stack); }
    const el = document.createElement('div');
    el.className = 'dual-toast';
    el.textContent = msg;
    stack.appendChild(el);
    requestAnimationFrame(()=> el.classList.add('show'));
    setTimeout(()=>{
      el.classList.remove('show');
      setTimeout(()=> el.remove(), 250);
    }, ms);
  } catch(e){ console.log('[dualToast]', e); }
};
</script>


<!-- ===== INFODOSE • AUDIO CLEAN TOTAL (Control+Fix) v1.0 ===== -->
<script>
(() => {
  // ==== HARD CAP & DEFAULTS ====
  const CAP_MASTER = 0.08;
  const DEFAULTS = { master: 0.030, pack: 'Lux', variant: 'UltraLow Seco', scaleMode: '432' };

  // ==== PACKS ====
  const PACKS = {
    Lux:  { atlas:'sine', nova:'morph', vitalis:'triangle', pulse:'triangle', artemis:'triangle', serena:'sine', kaos:'saw', genus:'morph', lumine:'morph', rhea:'triangle', solus:'sine', aion:'saw' },
    Terra:{ atlas:'triangle', nova:'sine', vitalis:'triangle', pulse:'sine', artemis:'triangle', serena:'triangle', kaos:'saw', genus:'triangle', lumine:'sine', rhea:'triangle', solus:'sine', aion:'saw' },
    Noir: { atlas:'saw', nova:'square', vitalis:'saw', pulse:'square', artemis:'square', serena:'sine', kaos:'saw', genus:'morph', lumine:'saw', rhea:'triangle', solus:'sine', aion:'saw' }
  };

  // ==== PATTERNS & MAPS ====
  const PATTERNS = { major_penta:[0,2,4,7,9], dorian:[0,2,3,5,7,9,10], phrygian:[0,1,3,5,7,8,10], aeolian:[0,2,3,5,7,8,10] };
  const LS = { get:(k,d)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):d }catch(_){return d} }, set:(k,v)=>{ try{ localStorage.setItem(k,JSON.stringify(v)) }catch(_){} } };
  const MAP = {
    phases:  LS.get('audio.scale.map.phases',  { Isca:'major_penta', Progresso:'dorian', Tensão:'phrygian', Liberação:'aeolian' }),
    actions: LS.get('audio.scale.map.actions', { home_apps:'major_penta', chat_brain:'dorian', stack_nav:'aeolian' })
  };

  // ==== VARIANTS ====
  const VARIANTS = {
    'UltraLow Seco':  { master:0.030, baseGain:0.18, beatGain:0.12, kickF:68, atk:0.004, dec:0.18, clickGain:0.06, clickHP:2600, clickDec:0.08, scDepth:0.22, scRel:0.16, shaper:false, delay:false, airy:false, organic:false },
    'UltraLow Macio': { master:0.030, baseGain:0.20, beatGain:0.14, kickF:54, atk:0.006, dec:0.30, clickGain:0.04, clickHP:2200, clickDec:0.06, scDepth:0.18, scRel:0.22, shaper:false, delay:false, airy:false, organic:false },
    'TapeWarm':       { master:0.035, baseGain:0.20, beatGain:0.14, kickF:60, atk:0.005, dec:0.24, clickGain:0.05, clickHP:2300, clickDec:0.08, scDepth:0.20, scRel:0.18, shaper:true,  delay:false, airy:false, organic:false, drive:1.8 },
    'AiryClick':      { master:0.035, baseGain:0.20, beatGain:0.14, kickF:64, atk:0.004, dec:0.20, clickGain:0.08, clickHP:3200, clickDec:0.09, scDepth:0.20, scRel:0.18, shaper:false, delay:false, airy:true,  organic:false },
    'DubPulse':       { master:0.035, baseGain:0.20, beatGain:0.14, kickF:60, atk:0.004, dec:0.24, clickGain:0.06, clickHP:2600, clickDec:0.10, scDepth:0.22, scRel:0.22, shaper:false, delay:true,  airy:false, organic:false, dlyT:0.28, dlyFb:0.24 },
    'Organic':        { master:0.035, baseGain:0.22, beatGain:0.16, kickF:58, atk:0.005, dec:0.22, clickGain:0.05, clickHP:2400, clickDec:0.08, scDepth:0.25, scRel:0.20, shaper:false, delay:false, airy:false, organic:true }
  };

  // ==== AUDIO CORE ====
  const AC = window.__INFODOSE_AC || new (window.AudioContext||window.webkitAudioContext)();
  window.__INFODOSE_AC = AC;
  const master = (()=>{
    if (window.__INFODOSE_MASTER) return window.__INFODOSE_MASTER;
    const g=AC.createGain(); g.gain.value=Math.min(DEFAULTS.master, CAP_MASTER); g.connect(AC.destination);
    window.__INFODOSE_MASTER=g; return g;
  })();

  // Robust resume (PWA/iOS + keepalive)
  (function(){
    const resume=()=>{ try{ AC.resume() }catch(_){ } };
    ['pointerdown','touchstart','mousedown','keydown','scroll','wheel','visibilitychange','focus'].forEach(ev=>document.addEventListener(ev, resume, true));
    let kept=false; document.addEventListener('pointerdown', ()=>{
      if (kept) return; kept=true;
      try{ const g=master; const o=AC.createOscillator(); o.type='sine'; o.frequency.value=25; const gg=AC.createGain(); gg.gain.value=0.00001; o.connect(gg); gg.connect(g); o.start(); setTimeout(()=>{ try{o.disconnect(); gg.disconnect();}catch(_){ } }, 600); }catch(_){}
    }, {once:true,capture:true});
    window.addEventListener('kobllux:audio:resume', resume);
  })();

  // Wavetable
  const PW=(function(){ const n=2048, mk=(fn)=>{ const re=new Float32Array(n), im=new Float32Array(n); for(let k=1;k<16;k++){ re[k]=fn(k);} return AC.createPeriodicWave(re, im, {disableNormalization:true}); }; return { morphA: mk(k=> (k===1?1:0)), morphB: mk(k=> 1/k) }; })();
  const ROOTS={ atlas:196, nova:220, vitalis:247, pulse:262, artemis:294, serena:330, kaos:349, genus:370, lumine:392, rhea:415, solus:440, aion:494 };
  function toFreq(baseHz, step=0, mode='432'){ let f=baseHz*Math.pow(2, step/12); if(mode==='432') f*= (432/440); return f; }
  function makeSource(type,f){ if(type==='noise'){ const node=AC.createScriptProcessor(512,1,1); node.onaudioprocess=e=>{ const ch=e.outputBuffer.getChannelData(0); for(let i=0;i<ch.length;i++) ch[i]=(Math.random()*2-1)*0.16; }; return { node, set:()=>{}, stop:()=>{try{node.disconnect()}catch(_){}}}; } const o=AC.createOscillator(); if(type==='morph'){ o.setPeriodicWave(PW.morphA);} else { o.type=type;} o.frequency.value=f; return { node:o, set:(nf)=>o.frequency.setTargetAtTime(nf, AC.currentTime, 0.02), stop:()=>{ try{o.stop()}catch(_){ } try{o.disconnect()}catch(_){ } } }; }
  function env(a=0.02,d=0.75,s=0.40,r=0.95){ const g=AC.createGain(); const t=AC.currentTime; g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(1,t+a); g.gain.exponentialRampToValueAtTime(s,t+a+d); g.release=()=>{ const tt=AC.currentTime; g.gain.cancelScheduledValues(tt); g.gain.setValueAtTime(g.gain.value||0.0001, tt); g.gain.exponentialRampToValueAtTime(0.0001, tt+r); }; return g; }

  // State
  const State={ variant:LS.get('audio.variant', DEFAULTS.variant), pack:LS.get('audio.pack', DEFAULTS.pack), scale:LS.get('audio.scale', DEFAULTS.scaleMode), master:LS.get('audio.master', DEFAULTS.master), pattern:PATTERNS[MAP.phases['Isca']]||PATTERNS.major_penta };

  // Busses
  let busBase=null, busBeat=null, busGlint=null, shaper=null, preDrive=null, dly=null, dlyIn=null, dlyOut=null, dlyFb=null;
  function createBusses(v){
    try{[busBase, busBeat, busGlint, shaper, preDrive, dly, dlyIn, dlyOut, dlyFb].forEach(x=>x&&x.disconnect&&x.disconnect());}catch(_){}
    busBase=AC.createGain(); busBase.gain.value=v.baseGain; busBase.connect(master);
    busBeat=AC.createGain(); busBeat.gain.value=v.beatGain;
    if(v.shaper){ shaper=AC.createWaveShaper(); const n=1024,c=new Float32Array(n); for(let i=0;i<n;i++){ const x=i*2/n-1; c[i]=Math.tanh((v.drive||1.8)*x);} shaper.curve=c; preDrive=AC.createGain(); preDrive.gain.value=1.0; preDrive.connect(shaper); shaper.connect(busBeat); }
    busBeat.connect(master);
    if(v.delay){ dly=AC.createDelay(1.0); dly.delayTime.value=v.dlyT||0.28; dlyFb=AC.createGain(); dlyFb.gain.value=v.dlyFb||0.24; dly.connect(dlyFb); dlyFb.connect(dly); dlyOut=AC.createGain(); dly.connect(dlyOut); dlyOut.connect(v.shaper? shaper: busBeat); dlyIn=AC.createGain(); }
    busGlint=AC.createGain(); busGlint.gain.value=0.05; busGlint.connect(master);
  }

  // Engines
  let seed=Math.floor(Math.random()*1e9); function rnd(){ let x=Math.sin(seed++)*10000; return x-Math.floor(x); }
  let BASE=null;
  function makeBase({wave='morph', base=220, step=0}){ const src=makeSource(wave, toFreq(base, step, State.scale)); const e=env(); const f=AC.createBiquadFilter(); f.type='lowpass'; f.frequency.value=800; f.Q.value=0.8; src.node.connect(f); f.connect(e); e.connect(busBase); if(src.node.start) src.node.start(); let alive=true; (function loop(){ if(!alive) return; const drift=(rnd()-0.5)*0.10; src.set(toFreq(base, step+drift, State.scale)); const cf=650+Math.abs(rnd())*650; f.frequency.setTargetAtTime(cf, AC.currentTime, 0.7); setTimeout(loop, 1200 + Math.floor(rnd()*900)); })(); return { stop(){ alive=false; try{src.stop()}catch(_){ } try{e.release()}catch(_){ } setTimeout(()=>{ try{f.disconnect()}catch(_){ } }, 600); } }; }

  const RHY=(function(){ let v=VARIANTS[State.variant]; const kGain=AC.createGain(); kGain.gain.value=1.0; const cGain=AC.createGain(); cGain.gain.value=1.0;
    function entry(){ return v.shaper? preDrive : busBeat; }
    function wire(){ try{ kGain.disconnect(); cGain.disconnect(); }catch(_){ } kGain.connect(entry()); if(v.delay && dly && dlyIn){ cGain.connect(dlyIn); dlyIn.connect(dly); } else { cGain.connect(entry()); } }
    function refreshParams(){ v=VARIANTS[State.variant]; wire(); }
    function thump(f){ const o=AC.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(f, AC.currentTime); const g=AC.createGain(); g.gain.setValueAtTime(0.0001, AC.currentTime); const t0=AC.currentTime; g.gain.exponentialRampToValueAtTime(0.75, t0+v.atk); g.gain.exponentialRampToValueAtTime(0.0001, t0+v.dec); o.connect(g); g.connect(kGain); o.start(); setTimeout(()=>{ try{o.stop();o.disconnect();g.disconnect();}catch(_ ){} }, Math.ceil(1000*v.dec+30)); }
    function click(){ if(v.clickGain<=0) return; const n=AC.createScriptProcessor(256,1,1); n.onaudioprocess=e=>{ const ch=e.outputBuffer.getChannelData(0); for(let i=0;i<ch.length;i++){ const t=i/ch.length; ch[i]=(Math.random()*2-1) * (v.airy?0.9:0.6) * (1-t); } }; const f=AC.createBiquadFilter(); f.type='highpass'; f.frequency.value=v.clickHP; const g=AC.createGain(); g.gain.value=v.clickGain; n.connect(f); f.connect(g); if(v.delay && dlyIn){ g.connect(dlyIn); } else { g.connect(cGain); } const t=AC.currentTime; g.gain.setValueAtTime(v.clickGain,t); g.gain.exponentialRampToValueAtTime(0.0001, t+v.clickDec); setTimeout(()=>{ try{n.disconnect(); f.disconnect(); g.disconnect();}catch(_ ){} }, Math.ceil(1000*v.clickDec+40)); }
    function sidechain(){ try{ busBase.gain.cancelScheduledValues(AC.currentTime); busBase.gain.setTargetAtTime(VARIANTS[State.variant].baseGain*(1-VARIANTS[State.variant].scDepth), AC.currentTime, 0.015); busBase.gain.setTargetAtTime(VARIANTS[State.variant].baseGain, AC.currentTime+VARIANTS[State.variant].scRel, 0.12); }catch(_){ } }
    return { refreshParams, pulse(accent=0){ const vv=VARIANTS[State.variant]; const f=vv.kickF+14*accent; thump(f); if(vv.clickGain>0) click(); sidechain(); },
      phase(name){ const vv=VARIANTS[State.variant]; const map={ "Isca": vv.beatGain*0.90, "Progresso": vv.beatGain*1.00, "Tensão": vv.beatGain*1.10, "Liberação": vv.beatGain*0.95 }; const vGain=map[name]!=null?map[name]:vv.beatGain; try{ busBeat.gain.setTargetAtTime(vGain, AC.currentTime, 0.2); }catch(_){ } const patName=MAP.phases[name]; if(patName && PATTERNS[patName]) State.pattern=PATTERNS[patName]; updatePanelScale(); } };
  })();

  function glint(base=220){ const pat=State.pattern||PATTERNS.major_penta; const step=pat[Math.floor(Math.random()*pat.length)] + (Math.random()<0.2?12:0); const f=toFreq(base, step, State.scale);
    const o=AC.createOscillator(); o.type='triangle'; o.frequency.value=f; const g=AC.createGain(); g.gain.value=0.0001; const hp=AC.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=1200; o.connect(hp); hp.connect(g); g.connect(busGlint);
    const t=AC.currentTime; g.gain.setValueAtTime(0.02, t); g.gain.exponentialRampToValueAtTime(0.0001, t+0.28); o.start(); setTimeout(()=>{ try{o.stop(); o.disconnect(); hp.disconnect(); g.disconnect();}catch(_){ } }, 360);
  }

  const WNAME=(n)=> (PACKS[State.pack][n]||'morph'); const ROOT=(n)=> (ROOTS[n]||220);
  let cur={ A:null, names:null };
  function stopAll(){ if(cur.A){ try{cur.A.stop()}catch(_ ){} } cur.A=null; cur.names=null; }
  function startPair(A,B){ stopAll(); cur.A = makeBase({ wave:WNAME(A), base:ROOT(A), step:0 }); cur.names=[A,B]; updatePanelPair(A,B); }

  // ==== LEDSTRIP (clean patch) ====
  function patchLED(){ const LED = window.LEDSTRIP || (window.LEDSTRIP={}); 
    // Zera flags antigas de áudio se houverem
    delete LED.__audioPatched; delete LED.__audioPatchedCtrl;
    // Encadeia mantendo o comportamento original
    const _hr=LED.pulseHR?LED.pulseHR.bind(LED):null; 
    LED.pulseHR=function(...args){ _hr && _hr(...args); RHY.pulse(0.65); glint(ROOT(cur?.names?.[0]||'nova')); };
    const _eng=LED.pulseENG?LED.pulseENG.bind(LED):null; 
    LED.pulseENG=function(...args){ _eng && _eng(...args); RHY.pulse(VARIANTS[State.variant].organic?0.45:0.30); glint(ROOT(cur?.names?.[1]||'lumine')); };
    const _ph =LED.setLoopPhase?LED.setLoopPhase.bind(LED):null; 
    LED.setLoopPhase=function(name){ _ph && _ph(name); RHY.phase(name); };
    const _setAB=LED.setArchetypes?LED.setArchetypes.bind(LED):null; 
    LED.setArchetypes=function(a,b){ _setAB && _setAB(a,b); if (!cur.names || cur.names.join('+') !== (a+'+'+b)) startPair(String(a).toLowerCase(), String(b).toLowerCase()); };
  }
  patchLED(); setInterval(patchLED, 1200);

  // ==== FUSÃO ====
  window.addEventListener('dual:fusion-change', async (ev)=>{ try{ if (AC.state==='suspended') await AC.resume(); }catch(_ ){}; const { enabled, a, b } = ev.detail || {}; if (!enabled){ stopAll(); return; } if (a && b) startPair(a,b); });

  // ==== ACTION → escala dinâmica ====
  (function busScale(){ const Bus=window.InfodoseBus; if(!Bus||!Bus.on) return; try{ Bus.on('ACTION', (evt)=>{ const r=(evt.route||'').toLowerCase();
      if (r.includes('home') || r.includes('apps')) State.pattern = PATTERNS[MAP.actions.home_apps] || PATTERNS.major_penta;
      else if (r.includes('chat') || r.includes('brain')) State.pattern = PATTERNS[MAP.actions.chat_brain] || PATTERNS.dorian;
      else if (r.includes('stack') || r.includes('nav')) State.pattern = PATTERNS[MAP.actions.stack_nav] || PATTERNS.aeolian;
      updatePanelScale(); }); }catch(_){}
  })();

  // ==== PAINEL ====
  function mkBtn(){ const btn=document.createElement('button'); btn.id='btn-audio-panel'; btn.className='btn-audio-panel'; btn.innerHTML='<span class="dot"></span><span class="label">Áudio</span>'; btn.addEventListener('click', togglePanel); return btn; }
  function placeBtn(btn){ const header=document.querySelector('header,.topbar,#header') || document.body; header.appendChild(btn); }
  function styles(){ const css=document.createElement('style'); css.textContent=`
      .btn-audio-panel { position: relative; display:flex; align-items:center; gap:.5rem; padding:.35rem .65rem; border:1px solid rgba(255,255,255,.18); border-radius:10px;
        background: linear-gradient(90deg,var(--archA,#59f),var(--archB,#f59)); color:#fff; font-weight:600; letter-spacing:.3px; cursor:pointer; box-shadow:0 2px 10px rgba(0,0,0,.15); }
      .btn-audio-panel .dot{ width:8px; height:8px; border-radius:50%; background:#fff; position:relative; }
      .btn-audio-panel .dot::after{ content:''; position:absolute; left:-6px; top:-6px; width:20px; height:20px; border-radius:50%; border:2px solid rgba(255,255,255,.45); animation: ping 1.8s infinite; }
      @keyframes ping { 0%{ transform: scale(.6); opacity:.9 } 80%{ transform: scale(1.6); opacity:0 } 100%{ opacity:0 } }
      .audio-panel { position:fixed; right:16px; bottom:16px; width:360px; background:rgba(18,18,30,.92); color:#fff; border:1px solid rgba(255,255,255,.18); border-radius:12px; backdrop-filter: blur(10px); box-shadow:0 10px 30px rgba(0,0,0,.35); display:none; z-index:9999; }
      .audio-panel.show{ display:block; }
      .audio-panel header{ padding:.6rem .8rem; font-weight:700; border-bottom:1px solid rgba(255,255,255,.12); display:flex; justify-content:space-between; align-items:center;}
      .audio-panel .body{ padding:.6rem .8rem; font-size:.9rem; line-height:1.25rem; }
      .audio-panel .row{ display:flex; gap:.5rem; align-items:center; margin:.35rem 0; }
      .audio-panel .row label{ width:110px; opacity:.9; }
      .audio-panel select, .audio-panel input[type=range]{ flex:1; }
      .audio-panel .kv{ display:flex; justify-content:space-between; margin:.25rem 0; opacity:.9; }
      .audio-panel small{ opacity:.7; }
      .chip{ display:inline-flex; align-items:center; gap:.35rem; padding:.15rem .5rem; border-radius:10px; background:rgba(255,255,255,.08); font-size:.78rem; }
      #ibSLine, #ledstrip-78k { pointer-events: auto !important; cursor: pointer; }
      #ledstrip-78k .lane { pointer-events: none !important; }
    `; document.head.appendChild(css); }
  function panelEl(){ let el=document.getElementById('audioPanel'); if(!el){ el=document.createElement('div'); el.id='audioPanel'; el.className='audio-panel';
      el.innerHTML = `<header>Áudio · Painel <button id="ap-close" title="Fechar" style="background:transparent;border:0;color:#fff;font-weight:700;font-size:1rem;cursor:pointer;">×</button></header>
        <div class="body">
          <div class="kv"><span>Pair</span><b id="ap-pair">—</b></div>
          <div class="row"><label>Variante</label><select id="ap-variant"></select></div>
          <div class="row"><label>Pack</label><select id="ap-pack"></select></div>
          <div class="row"><label>Master</label><input id="ap-master" type="range" min="0" max="0.08" step="0.001"><span class="chip"><span id="ap-master-v"></span></span></div>
          <div class="row"><label>Escala</label>
            <select id="ap-scale">
              <option value="432">432</option><option value="equal">equal</option><option value="just">just</option><option value="pythag">pythag</option>
            </select>
          </div>
          <div style="margin:.6rem 0 .2rem;opacity:.9">Padrões por <b>Fase</b></div>
          <div class="row"><label>Isca</label><select id="ap-ph-isc"></select></div>
          <div class="row"><label>Progresso</label><select id="ap-ph-prog"></select></div>
          <div class="row"><label>Tensão</label><select id="ap-ph-ten"></select></div>
          <div class="row"><label>Liberação</label><select id="ap-ph-lib"></select></div>
          <div style="margin:.6rem 0 .2rem;opacity:.9">Padrões por <b>Ação/Route</b></div>
          <div class="row"><label>Home/Apps</label><select id="ap-ac-home"></select></div>
          <div class="row"><label>Chat/Brain</label><select id="ap-ac-chat"></select></div>
          <div class="row"><label>Stack/Nav</label><select id="ap-ac-stack"></select></div>
          <div class="row" style="justify-content:flex-end"><button id="ap-reset" class="chip" title="Resetar para padrão">Reset</button></div>
          <small>OBS: volume com cap, integra LEDSTRIP/Bus, e respeita PWA.</small>
        </div>`; document.body.appendChild(el); el.querySelector('#ap-close').addEventListener('click', togglePanel); } return el; }
  function togglePanel(){ panelEl().classList.toggle('show'); }
  styles(); const btn=mkBtn(); placeBtn(btn); const strip=document.getElementById('ledstrip-78k'); if (strip) strip.addEventListener('click', togglePanel); const sline=document.getElementById('ibSLine'); if (sline) sline.addEventListener('click', togglePanel);

  function fillSelect(id, options, current){ const s=document.getElementById(id); s.innerHTML=''; options.forEach(o=>{ const opt=document.createElement('option'); opt.value=o; opt.textContent=o; if(o===current) opt.selected=true; s.appendChild(opt); }); return s; }
  function updatePanelPair(a,b){ const el=document.getElementById('ap-pair'); if (el) el.textContent=(a&&b)? (a+' + '+b):'—'; }
  function updatePanelScale(){ const el=document.getElementById('ap-scale'); if (el) el.value = State.scale; }
  function refreshPanelValues(){ const sm=document.getElementById('ap-master'); if (sm){ sm.value = Math.min(State.master, CAP_MASTER); } const smv=document.getElementById('ap-master-v'); if (smv) smv.textContent=(Math.min(State.master, CAP_MASTER)).toFixed(3);
    const selVar=document.getElementById('ap-variant'); if (selVar) selVar.value=State.variant; const selPack=document.getElementById('ap-pack'); if (selPack) selPack.value=State.pack; updatePanelScale();
    const keys=Object.keys(PATTERNS); fillSelect('ap-ph-isc', keys, MAP.phases['Isca']); fillSelect('ap-ph-prog', keys, MAP.phases['Progresso']); fillSelect('ap-ph-ten', keys, MAP.phases['Tensão']); fillSelect('ap-ph-lib', keys, MAP.phases['Liberação']); fillSelect('ap-ac-home', keys, MAP.actions['home_apps']); fillSelect('ap-ac-chat', keys, MAP.actions['chat_brain']); fillSelect('ap-ac-stack', keys, MAP.actions['stack_nav']); }

  function bootPanel(){
    fillSelect('ap-variant', Object.keys(VARIANTS), State.variant).addEventListener('change', (e)=>{ State.variant=e.target.value; LS.set('audio.variant', State.variant); applyVariant(); RHY.refreshParams(); });
    fillSelect('ap-pack', Object.keys(PACKS), State.pack).addEventListener('change', (e)=>{ State.pack=e.target.value; LS.set('audio.pack', State.pack); if (cur.names){ const [a,b]=cur.names; startPair(a,b);} });
    document.getElementById('ap-master').addEventListener('input', (e)=>{ const v=Math.min(parseFloat(e.target.value||DEFAULTS.master), CAP_MASTER); State.master=v; LS.set('audio.master', v); try{ master.gain.setTargetAtTime(v, AC.currentTime, 0.15);}catch(_){ } const smv=document.getElementById('ap-master-v'); if (smv) smv.textContent=v.toFixed(3); });
    document.getElementById('ap-scale').addEventListener('change', (e)=>{ State.scale=e.target.value; LS.set('audio.scale', State.scale); if (cur.names){ const [a,b]=cur.names; startPair(a,b);} });
    document.getElementById('ap-ph-isc').addEventListener('change', e=>{ MAP.phases['Isca']=e.target.value; LS.set('audio.scale.map.phases', MAP.phases); });
    document.getElementById('ap-ph-prog').addEventListener('change', e=>{ MAP.phases['Progresso']=e.target.value; LS.set('audio.scale.map.phases', MAP.phases); });
    document.getElementById('ap-ph-ten').addEventListener('change', e=>{ MAP.phases['Tensão']=e.target.value; LS.set('audio.scale.map.phases', MAP.phases); });
    document.getElementById('ap-ph-lib').addEventListener('change', e=>{ MAP.phases['Liberação']=e.target.value; LS.set('audio.scale.map.phases', MAP.phases); });
    document.getElementById('ap-ac-home').addEventListener('change', e=>{ MAP.actions['home_apps']=e.target.value; LS.set('audio.scale.map.actions', MAP.actions); });
    document.getElementById('ap-ac-chat').addEventListener('change', e=>{ MAP.actions['chat_brain']=e.target.value; LS.set('audio.scale.map.actions', MAP.actions); });
    document.getElementById('ap-ac-stack').addEventListener('change', e=>{ MAP.actions['stack_nav']=e.target.value; LS.set('audio.scale.map.actions', MAP.actions); });
    document.getElementById('ap-reset').addEventListener('click', ()=>{ State.variant='UltraLow Seco'; LS.set('audio.variant', State.variant);
      State.pack='Lux'; LS.set('audio.pack', State.pack); State.master=DEFAULTS.master; LS.set('audio.master', State.master); State.scale=DEFAULTS.scaleMode; LS.set('audio.scale', State.scale);
      MAP.phases={ Isca:'major_penta', Progresso:'dorian', Tensão:'phrygian', Liberação:'aeolian' }; MAP.actions={ home_apps:'major_penta', chat_brain:'dorian', stack_nav:'aeolian' };
      LS.set('audio.scale.map.phases', MAP.phases); LS.set('audio.scale.map.actions', MAP.actions);
      applyVariant(); RHY.refreshParams(); refreshPanelValues(); if(cur.names){ const [a,b]=cur.names; startPair(a,b);} });
    refreshPanelValues();
  }

  function applyVariant(){ const v=VARIANTS[State.variant]; const target=Math.min(State.master ?? v.master, CAP_MASTER); try{ master.gain.setTargetAtTime(target, AC.currentTime, 0.15);}catch(_){ } createBusses(v); }

  // Inicializa
  document.addEventListener('DOMContentLoaded', ()=>{ applyVariant(); bootPanel(); });

  // === FUSION BAR COLOR: non-fusion A→A ===
  function archName(){
    try{
      if (typeof currentArch === 'function') return String(currentArch()).toLowerCase();
      const sel = document.getElementById('arch-select');
      if (sel) return String(sel.value||'atlas').replace(/.*\//,'').replace(/\.html$/i,'').toLowerCase();
    }catch(_){}
    return 'atlas';
  }
  function archColor(name){
    try{
      const ACOL = window.ARCH_COLORS || {};
      return ACOL[name] || getComputedStyle(document.documentElement).getPropertyValue('--archA') || '#409eff';
    }catch(_){ return '#409eff'; }
  }
  function colorFusionSingle(){
    const bar = document.getElementById('ledstrip-fusion'); if (!bar) return;
    const nm = archName(); const C = archColor(nm);
    bar.style.background = `linear-gradient(90deg, ${C}, ${C})`;
    bar.style.opacity = '0.72';
  }
  window.addEventListener('dual:fusion-change', (ev)=>{
    const d = ev.detail || {}; const bar = document.getElementById('ledstrip-fusion'); if (!bar) return;
    if (d.enabled && d.a && d.b){
      const A = archColor(String(d.a).toLowerCase());
      const B = archColor(String(d.b).toLowerCase());
      bar.style.background = `linear-gradient(90deg, ${A}, ${B})`;
    } else {
      colorFusionSingle();
    }
  });
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', colorFusionSingle);
  else colorFusionSingle();
})();
</script>
<!-- ===== /INFODOSE • AUDIO CLEAN TOTAL ===== -->

<!-- ===== INFODOSE • Fusion Toggle via Bars (no button) ===== -->
<script>
(function(){
  const css = document.createElement('style');
  css.textContent = `
    .fusion-toggle, #fusion-toggle, .btn-fusion, [data-action="fusion-toggle"],
    .fusion-btn, .btn[data-fusion], button[aria-label*="Fusão" i] { display:none !important; }
    #ledstrip-fusion, #ledstrip-78k, #ibSLine { cursor: pointer; }
  `;
  document.head.appendChild(css);

  function getEnabled(){ try{ return JSON.parse(localStorage.getItem('dual.fusion.enabled')||'false'); }catch(_){ return false; } }
  function setEnabled(v){ try{ localStorage.setItem('dual.fusion.enabled', JSON.stringify(!!v)); }catch(_){ } }
  function normName(n){ return String(n||'').replace(/.*\//,'').replace(/\.html$/i,'').toLowerCase(); }
  function currentArchSafe(){
    try{
      if (typeof currentArch === 'function') return normName(currentArch());
      const sel = document.getElementById('arch-select');
      if (sel){ const opt = sel.options[sel.selectedIndex]; if (opt) return normName(opt.value||opt.textContent||''); }
    }catch(_){}
    return '';
  }
  let trail = [];
  function pushArch(n){
    n = normName(n);
    if (!n) return;
    if (trail.length && trail[trail.length-1]===n) return;
    trail.push(n);
    if (trail.length>8) trail = trail.slice(-8);
  }
  document.addEventListener('DOMContentLoaded', ()=>{
    const sel = document.getElementById('arch-select');
    if (sel){
      const opt = sel.options[sel.selectedIndex];
      if (opt) pushArch(opt.value||opt.textContent||'');
      sel.addEventListener('change', ()=>{
        const o = sel.options[sel.selectedIndex];
        pushArch(o ? (o.value||o.textContent||'') : '');
      });
    }
  });
  (function hookLEDTrail(){
    const LED = window.LEDSTRIP || (window.LEDSTRIP = {});
    if (LED.__trailPatched) return;
    const _setAB = LED.setArchetypes ? LED.setArchetypes.bind(LED) : null;
    LED.setArchetypes = function(a,b){ _setAB && _setAB(a,b); pushArch(a); pushArch(b); };
    LED.__trailPatched = true;
  })();

  function dispatchFusion(enabled, a, b){
    try{
      const det = enabled ? {enabled:true, a: normName(a), b: normName(b)} : {enabled:false};
      window.dispatchEvent(new CustomEvent('dual:fusion-change', { detail: det }));
    }catch(_){}
  }

  function handleToggle(ev){
    try{
      const enabled = getEnabled();
      if (enabled){
        setEnabled(false);
        dispatchFusion(false);
      } else {
        const A = currentArchSafe() || (trail.length? trail[trail.length-1]: 'atlas');
        let B = A;
        for (let i=trail.length-2; i>=0; i--){
          if (trail[i] && trail[i] !== A){ B = trail[i]; break; }
        }
        setEnabled(true);
        dispatchFusion(true, A, B);
      }
      const el = ev.currentTarget;
      if (el && el.style){
        const old = el.style.outline;
        el.style.outline = '2px solid rgba(255,255,255,.65)';
        setTimeout(()=>{ try{ el.style.outline = old || ''; }catch(_){ } }, 180);
      }
    }catch(_){}
  }

  function bindBars(){
    ['ledstrip-fusion','ledstrip-78k','ibSLine'].forEach(id=>{
      const el = document.getElementById(id);
      if (el && !el.__fusionToggleBound){
        el.addEventListener('click', handleToggle, true);
        el.__fusionToggleBound = true;
      }
    });
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bindBars);
  else bindBars();

  (function bootRestore(){
    if (!getEnabled()) return;
    const A = currentArchSafe() || (trail.length? trail[trail.length-1]: 'atlas');
    let B = A;
    for (let i=trail.length-2; i>=0; i--){
      if (trail[i] && trail[i] !== A){ B = trail[i]; break; }
    }
    dispatchFusion(true, A, B);
  })();
})();
</script>
<!-- ===== /INFODOSE • Fusion Toggle via Bars ===== -->

<!-- ===== INFODOSE • Hide Fusion/Difusionar Button (robust) ===== -->
<style id="hide-fusion-btn-css">
  .fusion-toggle, #fusion-toggle, .btn-fusion, .btnFusion, .fusion-btn,
  .btn[data-fusion], .btn-difusionar, #btn-difusionar,
  [data-action="fusion-toggle"], [data-action="difusionar"],
  [data-action*="fusion" i], [data-action*="difus" i],
  button[aria-label*="Fusão" i], button[aria-label*="fusao" i],
  button[aria-label*="Fusion" i], button[aria-label*="Difusionar" i],
  [title*="Fusão" i], [title*="Difusionar" i] {
    display: none !important;
  }
</style>
<script>
(function hideFusionButtonsRobust(){
  const re = /(difusionar|fusionar|fusão|fusao|fusion)/i;
  function sweep(root){
    const nodes = root ? root.querySelectorAll('button, [role="button"], .btn, a, [data-action], [title], [aria-label]') : [];
    nodes.forEach(el => {
      try{
        const text = (el.textContent || '').trim();
        const attrs = [
          el.getAttribute('aria-label') || '',
          el.getAttribute('title') || '',
          el.getAttribute('data-action') || el.dataset?.action || ''
        ].join(' ');
        if (re.test(text) || re.test(attrs)) {
          el.style.setProperty('display', 'none', 'important');
        }
      }catch(_){}
    });
  }
  function run(){ sweep(document); }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', run);
  } else {
    run();
  }
  const mo = new MutationObserver(muts => {
    muts.forEach(m => {
      m.addedNodes && m.addedNodes.forEach(n => {
        if (n.nodeType === 1) sweep(n);
      });
    });
  });
  mo.observe(document.documentElement, { childList:true, subtree:true });
})();
</script>
<!-- ===== /Hide Fusion/Difusionar Button ===== -->

<!-- ===== INFODOSE • UI Overrides: Hide Fusion Button + Loader (Sempre Único) ===== -->
<style id="su-loader-style">
  #su-loader{position:fixed;inset:0;z-index:2147483647;background:
    radial-gradient(1200px 600px at 20% -10%, rgba(120,80,255,.18), transparent 60%),
    radial-gradient(1200px 800px at 90% 110%, rgba(255,90,150,.18), transparent 60%),
    #0b0e14;color:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial;
    opacity:1;transition:opacity .45s ease}
  #su-loader.done{opacity:0;pointer-events:none}
  #su-loader .su-logo{font-size:1.1rem;letter-spacing:.06em;opacity:.92;margin-top:.6rem}
  #su-loader .su-mark{font-weight:800;font-size:1.85rem;letter-spacing:.02em;margin-bottom:.35rem}
  #su-loader .dot{width:12px;height:12px;border-radius:50%;background:#fff;opacity:.9;margin:.35rem 0;animation:su-pulse 1.8s infinite ease-in-out}
  #su-loader .spinner{width:36px;height:36px;border:3px solid rgba(255,255,255,.15);border-top-color:#fff;border-radius:50%;animation:su-rot 1.2s linear infinite;margin-top:.35rem}
  @keyframes su-rot{to{transform:rotate(360deg)}}
  @keyframes su-pulse{0%{transform:scale(.8);opacity:.9}60%{transform:scale(1.2);opacity:.35}100%{transform:scale(.8);opacity:.9}}
  .su-hidden-fusion-btn{display:none !important}
</style>
<script id="su-loader-script">
(function(){
  try{
    var L=document.createElement('div'); L.id='su-loader';
    L.innerHTML = '<div class="su-mark">Sempre Único</div><div class="dot"></div><div class="su-logo">Sempre seu</div><div class="spinner" aria-hidden="true"></div>';
    if (document.readyState!=='loading' && document.body){ document.body.appendChild(L); }
    else { document.addEventListener('DOMContentLoaded', function(){ document.body.appendChild(L); }, {once:true}); }
  }catch(_){}

  function hideFusionButtons(root){
    root = root || document;
    var C = root.querySelectorAll('button, [role="button"], a, .btn');
    for (var i=0;i<C.length;i++){
      var el=C[i];
      var label=(el.getAttribute('aria-label')||el.textContent||'').toLowerCase();
      var id=(el.id||'').toLowerCase(), cls=(el.className||'').toLowerCase();
      if (/\b(fusão|fusao|fusionar|difusionar|fusion|difusion)\b/.test(label+ ' '+ id+ ' '+ cls)){
        el.classList.add('su-hidden-fusion-btn'); el.style.display='none';
      }
    }
    var hints=[
      '#fusion-toggle','.btn-fusion','[data-action="fusion-toggle"]','[data-action*="fusion"]',
      'button[data-fusion]','[aria-label*="Fusão" i]','[aria-label*="fusao" i]','[data-testid*="fusion" i]'
    ];
    try{ root.querySelectorAll(hints.join(',')).forEach(function(el){ el.classList.add('su-hidden-fusion-btn'); el.style.display='none'; }); }catch(_){}
  }
  if (document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', function(){ hideFusionButtons(document); }); }
  else { hideFusionButtons(document); }

  var mo=new MutationObserver(function(muts){
    muts.forEach(function(m){
      if (m.addedNodes) m.addedNodes.forEach(function(n){
        if (n.nodeType===1) hideFusionButtons(n);
      });
    });
  });
  try{ mo.observe(document.documentElement, {childList:true, subtree:true}); }catch(_){}

  var KEY='su:autoreload:v1';
  try{
    if (!localStorage.getItem(KEY)){
      localStorage.setItem(KEY, '1');
      setTimeout(function(){ try{ location.reload(); }catch(_){ } }, 140);
      return;
    }
  }catch(_){}

  function done(){
    try{
      var el=document.getElementById('su-loader');
      if (!el) return;
      el.classList.add('done');
      setTimeout(function(){ try{ el.remove(); }catch(_){ } }, 520);
    }catch(_){}
  }
  if (document.readyState==='complete'){ setTimeout(done, 260); }
  else { window.addEventListener('load', function(){ setTimeout(done, 260); }, {once:true}); }
})();
</script>

<style>

#ibSLine , #btnHelp, #btnBack{ display: none !important; }

</style>
<!-- ===== /INFODOSE • UI Overrides ===== -->
<script>

/* === UNO & DUAL UNIFIED CONFIGURATION PATCH ===
   - Migrates all keys to the 'di_' namespace
   - Provides a unified access layer for OpenRouter and other settings
   - Ensures backward compatibility with legacy keys
   ============================================== */
(function() {
    if (window.Uno && window.Uno.__unified_config_v1) return;
    window.Uno = window.Uno || {};
    const Uno = window.Uno;
    Uno.__unified_config_v1 = true;

    // --- Constants ---
    const STORAGE = {
        API_KEY: 'di_apiKey',
        MODEL: 'di_modelName',
        SYSTEM_ROLE: 'di_infodoseName',
        USER_ID: 'di_userName',
        BG_IMAGE: 'di_bgImage',
        CUSTOM_CSS: 'di_customCss',
        SOLAR_MODE: 'di_solarMode',
        SOLAR_AUTO: 'di_solarAuto',
        WALLET: 'dual.keys.wallet',
        FALLBACK: 'di_fallbackChain'
    };

    const LEGACY_KEYS = {
        API_KEY: ['dual.keys.openrouter', 'infodose:sk', 'openrouter:key'],
        MODEL: ['dual.openrouter.model', 'infodose:model', 'openrouter:model'],
        USER_ID: ['dual.name', 'infodose:userName'],
        SYSTEM_ROLE: ['infodose:assistantName'],
        FALLBACK: ['dual.openrouter.fallback', 'openrouter:fallback']
    };

    // --- Internal Helpers ---
    function LSget(k) { try { return localStorage.getItem(k) || ''; } catch(e) { return ''; } }
    function LSset(k, v) { try { localStorage.setItem(k, v); } catch(e) {} }

    // --- Unified Access Layer ---
    Uno.getConfig = function(key) {
        // 1. Try primary 'di_' key
        let val = LSget(STORAGE[key]);
        if (val) return val;

        // 2. Try legacy keys and migrate if found
        if (LEGACY_KEYS[key]) {
            for (const legacy of LEGACY_KEYS[key]) {
                val = LSget(legacy);
                if (val) {
                    console.log(`[UnifiedConfig] Migrating ${legacy} -> ${STORAGE[key]}`);
                    LSset(STORAGE[key], val);
                    return val;
                }
            }
        }
        return '';
    };

    Uno.setConfig = function(key, val) {
        if (STORAGE[key]) {
            LSset(STORAGE[key], val);
            // Sync legacy keys for backward compatibility if needed
            if (LEGACY_KEYS[key]) {
                LEGACY_KEYS[key].forEach(legacy => LSset(legacy, val));
            }
        }
    };

    // --- OpenRouter Specific ---
    Uno.getOpenRouter = function() {
        return {
            sk: Uno.getConfig('API_KEY'),
            model: Uno.getConfig('MODEL') || 'openrouter/auto'
        };
    };

    // --- Integration Hooks ---
    // This replaces the old LSget/LSset in the consolidation patches
    window.LSget = LSget;
    window.LSset = LSset;

    console.log('%cUNO & DUAL Unified Config Active', 'background:#0b0f14;color:#39ffb6;padding:2px 6px;border-radius:4px');
})();
</script>

</body>
</html>
