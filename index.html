<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>UNO — Dual UNIFIED (mobile v1.2)</title>
<meta name="theme-color" content="#0b0f17"/>
<link rel="icon" href="assets/icons/app.svg"/>
<style>
/* ===== THEME ===== */
:root{
  --bg:#0b0f17; --ink:#e9f6ff; --muted:#97b1c6; --line:rgba(255,255,255,.16);
  --rad:18px; --pad:12px; --glass:rgba(255,255,255,.06);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font:500 15px/1.35 system-ui,-apple-system,Inter,Roboto,sans-serif;overflow-x:hidden}

/* Safe areas iOS */
:root{ --sa-top:env(safe-area-inset-top); --sa-bot:env(safe-area-inset-bottom) }

/* BACKGROUND */
#bg{position:fixed;inset:0;z-index:-2;background:#070b12 url("dual_uno_assets_v1/img/bg/bg_nebula_01.png") center/cover no-repeat}
#bg video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:none}

/* APP LAYOUT */
.app{position:relative;min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto}

/* ===== TOP HUD (compact, com margem segura) ===== */
header{display:flex;gap:8px;align-items:center;justify-content:flex-end;padding:calc(var(--sa-top)+8px) 12px 8px}
.hud{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.badge{display:inline-flex;gap:.35rem;align-items:center;padding:.35rem .6rem;border:1px solid var(--line);border-radius:10px;color:var(--muted);background:rgba(255,255,255,.04);font-size:.78rem}
.badge svg{width:14px;height:14px}

/* ===== CORE (anel + dot) ===== */
.center{display:grid;place-items:center;padding:6px}
.core{position:relative;width:min(86vw,520px);aspect-ratio:1/1;display:grid;place-items:center}
.core .ring{position:absolute;inset:0;background:url("dual_uno_assets_v1/img/core/ring_glow_01.png") center/contain no-repeat;filter:saturate(1.1)}
.core .dot{width:22px;height:22px;border-radius:50%;background:url("dual_uno_assets_v1/img/core/dot_core_01.png") center/cover no-repeat;box-shadow:0 0 24px rgba(92,255,250,.55)}
.core .controls{position:absolute;top:8%;display:flex;gap:8px;padding:6px 8px;border-radius:14px;backdrop-filter:blur(10px)}
.icon-btn{appearance:none;background:rgba(255,255,255,.06);border:1px solid var(--line);border-radius:12px;display:grid;place-items:center;width:40px;height:40px}
.icon-btn svg{width:18px;height:18px}

/* ===== SIDEBAR (unificação) ===== */
.sidebar{position:fixed;top:0;right:0;height:100dvh;width:min(86vw,340px);transform:translateX(100%);transition:.28s ease;z-index:998}
.sidebar.open{transform:translateX(0)}
.side-card{height:100%;display:flex;flex-direction:column;gap:10px;padding:14px;border-left:1px solid var(--line);background:linear-gradient(180deg,rgba(11,15,23,.96),rgba(11,15,23,.86));backdrop-filter:blur(12px)}
.side-head{display:flex;align-items:center;justify-content:space-between;gap:8px}
.side-head .ttl{font-weight:800}
.side-scroller{flex:1 1 auto;overflow:auto;display:grid;gap:10px;padding-right:8px}
.row{display:flex;align-items:center;gap:10px}
.row .grow{flex:1 1 auto;min-width:0}
.thumb{width:36px;height:36px;border-radius:10px;border:1px solid var(--line);background:#0a0d14 center/cover no-repeat}
input[type="file"]{display:none}
.label-btn{display:inline-flex;align-items:center;gap:.5rem;padding:.55rem .7rem;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.04)}
.switch{position:relative;display:inline-block;width:44px;height:26px}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;inset:0;background:#233041;border-radius:999px}
.slider:before{content:"";position:absolute;height:20px;width:20px;left:3px;top:3px;background:#cfe9ff;border-radius:50%;transition:.2s}
.switch input:checked+.slider{background:#294d6b}
.switch input:checked+.slider:before{transform:translateX(18px)}
.small{font-size:.82rem;color:var(--muted)}

/* ===== PANEL (apps + uploads + iframe sandbox) ===== */
.panel{margin:10px;padding:12px;border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.05);backdrop-filter:blur(14px)}
.grid2{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.apps-list{margin-top:10px;display:grid;gap:8px}
.app-row{display:flex;gap:10px;align-items:center;padding:10px;border:1px solid rgba(255,255,255,.1);border-radius:12px;background:rgba(255,255,255,.03)}
.meta{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* Overlay iFrame */
.overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:1000}
.overlay.show{display:flex}
.ifr-wrap{width:90vw;max-height:90vh;background:rgba(11,15,23,.96);border:1px solid var(--line);border-radius:18px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,.6)}
@media(min-width:768px){.ifr-wrap{width:66vw}}
.ifr-head{display:flex;align-items:center;justify-content:space-between;padding:.6rem .8rem;border-bottom:1px solid var(--line);background:rgba(255,255,255,.04)}
.ifr-body{width:100%;height:min(76vh,640px);border:0;background:#0a0d14}

/* ===== FOOTER nav (icon-only, com safe-area) ===== */
footer{height:68px}
.footer-bar{position:fixed;left:50%;bottom:calc(var(--sa-bot) + 12px);transform:translateX(-50%);display:flex;gap:28px;align-items:center;padding:.7rem 1.1rem;border-radius:999px;border:1px solid var(--line);backdrop-filter:blur(12px);background:linear-gradient(90deg,rgba(255,80,240,.12),rgba(0,180,255,.12));z-index:997}
.nav-btn{appearance:none;background:none;border:0;display:grid;place-items:center;width:40px;height:40px}
.nav-btn svg{width:22px;height:22px;color:#d6eaff}

/* FAB (Botão Único) */
.fab{position:fixed;right:16px;bottom:calc(84px + var(--sa-bot));width:58px;height:58px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--line);backdrop-filter:blur(8px);box-shadow:0 10px 30px rgba(0,0,0,.3);background:rgba(255,255,255,.08);z-index:999}

/* Handle lateral (abre/fecha sidebar) */
.handle{position:fixed;top:calc(50% - 24px);right:8px;z-index:999;display:grid;place-items:center;width:36px;height:48px;border-radius:14px;border:1px solid var(--line);background:rgba(255,255,255,.06);backdrop-filter:blur(10px)}

/* KIOSK: esconder UI */
.kiosk header,.kiosk .footer-bar,.kiosk .fab,.kiosk .handle,.kiosk .panel,.kiosk .sidebar{display:none !important}

/* ORIENTATION LOCK (retrato obrigatório) */
.rotate-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.8);z-index:1200}
.rotate-overlay.show{display:flex}
.rotate-card{padding:18px 22px;border-radius:16px;border:1px solid var(--line);background:rgba(11,15,23,.95)}
.rotate-card .small{opacity:.9}

/* Utility */
.ellip{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-inline-size:20ch}
.icon-only .label{display:none}
</style>
</head>
<body>
<div id="bg"><video id="bgvid" muted loop playsinline></video></div>

<div class="app" id="app">
  <!-- ===== TOP HUD ===== -->
  <header>
    <div class="hud">
      <span class="badge" title="Frames por segundo">FPS <b id="fps">~</b></span>
      <span class="badge" title="Latência do loop">LAT <b id="lat">~</b>ms</span>
      <span class="badge" title="Long Tasks">LT <b id="lt">0</b></span>
      <span class="badge" title="Layout Shift">CLS <b id="cls">0.00</b></span>
      <button class="icon-btn" id="btnPlay" title="Ping de áudio" aria-label="Áudio">{svgPlay}</button>
      <button class="icon-btn" id="btnKiosk" title="Esconder UI (foco no fundo)" aria-label="Kiosk">{svgEyeOff}</button>
    </div>
  </header>

  <!-- ===== CORE ===== -->
  <main>
    <section class="center">
      <div class="core">
        <div class="ring" id="ring"></div>
        <div class="dot" id="dot"></div>
        <div class="controls">
          <button class="icon-btn" id="ringPrev" title="Anel anterior" aria-label="Anterior">{svgChevronL}</button>
          <button class="icon-btn" id="ringNext" title="Próximo anel" aria-label="Próximo">{svgChevronR}</button>
          <button class="icon-btn" id="btnToggleAnim" title="Animar/pausar anel" aria-label="Animação">{svgBolt}</button>
        </div>
      </div>
    </section>

    <!-- ===== APPS / UPLOADS ===== -->
    <section class="panel" id="appsPane">
      <div class="grid2 icon-only" id="gridActions">
        <!-- ÍCONES APENAS (labels escondidas por CSS) -->
        <label class="label-btn" for="bgUpload" title="Trocar Fundo" aria-label="Upload Fundo">{svgImage}<span class="label">Fundo</span></label>
        <label class="label-btn" for="ringUpload" title="Adicionar Anel" aria-label="Upload Ring">{svgTarget}<span class="label">Anel</span></label>
        <label class="label-btn" for="dotUpload" title="Trocar Dot" aria-label="Upload Dot">{svgDot}<span class="label">Dot</span></label>
        <label class="label-btn" for="logoUpload" title="Trocar Logo" aria-label="Upload Logo">{svgLogo}<span class="label">Logo</span></label>

        <label class="label-btn" for="htmlUpload" title="Carregar HTML como App" aria-label="Upload HTML">{svgHtml}<span class="label">HTML</span></label>
        <button class="label-btn" id="btnLoadApps" title="Ler apps.json">{svgJson}<span class="label">apps.json</span></button>
        <button class="label-btn" id="btnExport" title="Exportar ZIP (stub)">{svgDownload}<span class="label">ZIP</span></button>
        <button class="label-btn" id="btnAppsToggle" title="Estilo do painel">{svgGrid}<span class="label">Painel</span></button>
      </div>

      <!-- FILE INPUTS -->
      <input type="file" id="bgUpload" accept="image/*,video/webm,video/mp4"/>
      <input type="file" id="ringUpload" accept="image/png,image/svg+xml"/>
      <input type="file" id="dotUpload" accept="image/png,image/svg+xml"/>
      <input type="file" id="logoUpload" accept="image/*,image/svg+xml"/>
      <input type="file" id="htmlUpload" accept="text/html"/>

      <div class="apps-list" id="appsList"></div>
    </section>
  </main>

  <!-- ===== FOOTER ===== -->
  <footer>
    <div class="footer-bar">
      <button class="nav-btn" title="Início" id="navHome">{svgHome}</button>
      <button class="nav-btn" title="Apps" id="navApps">{svgGrid}</button>
      <button class="nav-btn" title="Perfil" id="navUser">{svgUser}</button>
    </div>
  </footer>

  <!-- FAB (Botão Único) -->
  <button class="fab" id="btnInfodose" title="Ação Única">{svgBolt}</button>

  <!-- Handle lateral para abrir/fechar sidebar -->
  <button class="handle" id="btnHandle" title="Unificar/abrir controle">{svgMenu}</button>
</div>

<!-- ===== SIDEBAR: CONTROLE TOTAL ===== -->
<aside class="sidebar" id="sidebar">
  <div class="side-card">
    <div class="side-head">
      <div class="ttl">Controles</div>
      <button class="icon-btn" id="btnSideClose" title="Fechar">{svgX}</button>
    </div>

    <div class="side-scroller">
      <!-- Logo viewer/swap -->
      <div class="row"><div class="thumb" id="thumbLogo"></div><div class="grow">
        <div><b>Logo</b></div>
        <div class="small ellip" id="metaLogo">—</div>
      </div><label class="label-btn" for="logoUpload">Trocar</label></div>

      <!-- Fundo viewer/swap -->
      <div class="row"><div class="thumb" id="thumbBg"></div><div class="grow">
        <div><b>Fundo</b></div>
        <div class="small ellip" id="metaBg">—</div>
      </div><label class="label-btn" for="bgUpload">Trocar</label></div>

      <!-- Anel & Dot -->
      <div class="row"><div class="thumb" id="thumbRing"></div><div class="grow">
        <div><b>Anel</b></div>
        <div class="small ellip" id="metaRing">—</div>
      </div><label class="label-btn" for="ringUpload">Adicionar</label></div>

      <div class="row"><div class="thumb" id="thumbDot"></div><div class="grow">
        <div><b>Dot</b></div>
        <div class="small ellip" id="metaDot">—</div>
      </div><label class="label-btn" for="dotUpload">Trocar</label></div>

      <!-- Ícones: alternar texto/ícone -->
      <div class="row"><div class="grow">
        <div><b>UI</b></div>
        <div class="small">Mostrar rótulos de texto nos botões (padrão: ícone apenas)</div>
      </div>
      <label class="switch" title="Rótulos de texto">
        <input type="checkbox" id="toggleLabels"/>
        <span class="slider"></span>
      </label></div>

      <!-- Kiosk switch -->
      <div class="row"><div class="grow">
        <div><b>Modo Foco</b></div>
        <div class="small">Ocultar menus, deixando apenas o background e o núcleo.</div>
      </div>
      <label class="switch" title="Kiosk">
        <input type="checkbox" id="toggleKiosk"/>
        <span class="slider"></span>
      </label></div>

    </div>
  </div>
</aside>

<!-- ===== ORIENTATION (retrato) ===== -->
<div class="rotate-overlay" id="rotateOverlay">
  <div class="rotate-card">
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:6px">{svgRotate}<b>Gire para retrato</b></div>
    <div class="small">A interface foi otimizada para modo retrato. Obrigado! 🙂</div>
  </div>
</div>

<!-- ===== OVERLAY iFRAME (apps/HTML) ===== -->
<div class="overlay" id="overlay">
  <div class="ifr-wrap" role="dialog" aria-modal="true" aria-label="Sandbox">
    <div class="ifr-head">
      <div class="ellip" id="ifrTitle">Sandbox</div>
      <div style="display:flex;gap:6px">
        <button class="icon-btn" id="ifrClose" title="Fechar">{svgX}</button>
      </div>
    </div>
    <iframe class="ifr-body" id="sandboxModal" referrerpolicy="no-referrer" sandbox="allow-scripts allow-forms allow-popups allow-pointer-lock allow-downloads allow-same-origin"></iframe>
  </div>
</div>

<script>
/* ===== ICONS (inline, evita paths quebrados) ===== */
const ICONS = {
  play: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="8,5 19,12 8,19"/></svg>`,
  eyeOff:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3l18 18"/><path d="M10.58 10.58A2 2 0 0 0 13.42 13.4"/><path d="M9.88 4.24A10.94 10.94 0 0 1 21 12c-1.64 2.88-4.7 6-9 6-1.35 0-2.6-.25-3.74-.7"/></svg>`,
  chevronL:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>`,
  chevronR:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>`,
  bolt:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 3 4 14 12 14 11 21 20 10 12 10"/></svg>`,
  image:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>`,
  target:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="8"/><circle cx="12" cy="12" r="2"/></svg>`,
  dot:`<svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="4"/></svg>`,
  logo:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3l6 4v10l-6 4-6-4V7z"/></svg>`,
  html:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 4h13v16H3V4z"/><path d="M10 8h7M7 12h10M7 16h10"/></svg>`,
  json:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 7v10M19 7v10"/><path d="M9 7h2v10H9M13 7h2v10h-2"/></svg>`,
  download:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>`,
  grid:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>`,
  home:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12l9-9 9 9"/><path d="M9 21V9h6v12"/></svg>`,
  user:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="7" r="4"/><path d="M5.5 21a7.5 7.5 0 0 1 13 0"/></svg>`,
  menu:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>`,
  x:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`,
  rotate:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="3" width="12" height="18" rx="2"/><path d="M12 19v2m-4-1h8"/></svg>`
};
// inject icons
for(const [k,v] of Object.entries(ICONS)){
  document.body.innerHTML = document.body.innerHTML.replaceAll(`{svg${k[0].toUpperCase()+k.slice(1)}}`, v);
}

/* ===== BG helpers ===== */
const UNO = {
  setBgVideo(src){ const v=$('#bgvid'); v.src=src; v.style.display='block'; v.play().catch(()=>{}); updateThumb('Bg', src); },
  setBgImage(src){ const v=$('#bgvid'); try{v.pause();}catch{} v.removeAttribute('src'); v.load(); v.style.display='none'; $('#bg').style.backgroundImage = `url("${src}")`; updateThumb('Bg', src); }
};
window.UNO = UNO;

/* ===== Mini metrics ===== */
let t0=performance.now(), rafCount=0, lastFpsT=performance.now();
function loop(now){ const dt=now-t0; t0=now; $('#lat').textContent=Math.max(1,Math.round(dt)); rafCount++; if(now-lastFpsT>1000){ $('#fps').textContent=rafCount; rafCount=0; lastFpsT=now; } requestAnimationFrame(loop); }
requestAnimationFrame(loop);
if('PerformanceObserver' in window){
  try{ new PerformanceObserver(l=>{ for(const e of l.getEntries()){ if(e.duration>50){ const el=$('#lt'); el.textContent=(parseInt(el.textContent,10)||0)+1; }}}).observe({entryTypes:['longtask']}); }catch(e){}
  try{ let cls=0; new PerformanceObserver(l=>{ for(const e of l.getEntries()){ if(!e.hadRecentInput){ cls+=e.value; } } $('#cls').textContent=cls.toFixed(3); }).observe({type:'layout-shift', buffered:true}); }catch(e){}
}

/* ===== Helpers ===== */
const $=s=>document.querySelector(s);
const state = { rings:["dual_uno_assets_v1/img/core/ring_glow_01.png","dual_uno_assets_v1/img/core/ring_glow_02.png","dual_uno_assets_v1/img/core/ring_glow_03.png","dual_uno_assets_v1/img/core/ring_glow_04.png"], rIndex:0, apps:[] };
const ringEl = $('#ring');
function setRing(i){ state.rIndex=(i+state.rings.length)%state.rings.length; ringEl.style.backgroundImage=`url("${state.rings[state.rIndex]}")`; updateThumb('Ring', state.rings[state.rIndex]); $('#metaRing').textContent = short(state.rings[state.rIndex]); }
function short(u){ return (u||'').toString().slice(0,48)+(u&&u.length>48?'…':''); }

/* ===== Ring anim ===== */
let animRunning = true, angle = 0;
(function animate(){ if(animRunning){ angle += 0.3; ringEl.style.transform = `rotate(${angle}deg)`; } requestAnimationFrame(animate); })();

/* ===== Audio ping ===== */
let actx,out,gain,audioReady=false;
async function initAudio(){ if(audioReady) return; actx=new (window.AudioContext||window.webkitAudioContext)(); const code=`class B extends AudioWorkletProcessor{static get parameterDescriptors(){return[{name:'on',defaultValue:0},{name:'freq',defaultValue:220}]} process(i,o,p){const out=o[0];const on=p.on[0],f=p.freq[0];for(let ch=0; ch<out.length; ch++){const b=out[ch];for(let n=0;n<b.length;n++){let s=0;if(on>0.5){s=(Math.random()*2-1)*0.18+Math.sin(2*Math.PI*(currentFrame+n)/sampleRate*f)*0.22;}b[n]=s;}}return true}}registerProcessor('b',B);`;
  await actx.audioWorklet.addModule(URL.createObjectURL(new Blob([code],{type:'text/javascript'})));
  out=new AudioWorkletNode(actx,'b'); gain=actx.createGain(); gain.gain.value=0.0; out.connect(gain).connect(actx.destination); audioReady=true; }
function ping(){ if(!audioReady) return; out.parameters.get('on').setValueAtTime(1, actx.currentTime); gain.gain.cancelScheduledValues(actx.currentTime); gain.gain.linearRampToValueAtTime(0.9, actx.currentTime+0.01); gain.gain.exponentialRampToValueAtTime(0.0001, actx.currentTime+0.35); setTimeout(()=> out.parameters.get('on').setValueAtTime(0, actx.currentTime), 140); }

/* ===== Apps render / overlay ===== */
function renderApps(arr){ const list=$('#appsList'); list.innerHTML=''; (arr||[]).forEach((a,i)=>{ const row=document.createElement('div'); row.className='app-row'; row.innerHTML=`<span class="badge">#${i+1}</span><div style="flex:1 1 auto;min-width:0"><div><strong class="ellip" title="${a.name||'App'}">${a.name||'App'}</strong></div><div class="meta ellip" title="${a.url}">${a.url}</div></div><button class="label-btn" data-open="${i}" title="Abrir">${ICONS.play}</button>`; list.appendChild(row); }); list.onclick=e=>{ const i=e.target?.closest('[data-open]')?.dataset?.open; if(i!=null){ openSandbox((arr||[])[i]); } } }
const overlay = $('#overlay');
const sandboxModal = $('#sandboxModal');
const ifrTitle = $('#ifrTitle');
function openSandbox(app){ if(!app) return; ifrTitle.textContent = app.name||'Sandbox'; sandboxModal.src = app.url; overlay.classList.add('show'); }
function closeOverlay(){ overlay.classList.remove('show'); sandboxModal.removeAttribute('src'); }
$('#ifrClose').onclick = closeOverlay; overlay.addEventListener('click', (e)=>{ if(e.target===overlay){ closeOverlay(); }});

/* ===== File -> dataURL helpers ===== */
function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
function updateThumb(kind, src){ const id = kind==='Bg'?'thumbBg':kind==='Ring'?'thumbRing':kind==='Dot'?'thumbDot':'thumbLogo'; const el=$('#'+id); if(!el) return; el.style.backgroundImage=`url('${src}')`; const meta = $('#meta'+kind); if(meta) meta.textContent = short(src); }

/* ===== UI events ===== */
$('#ringPrev').onclick=()=>setRing(state.rIndex-1);
$('#ringNext').onclick=()=>setRing(state.rIndex+1);
$('#btnToggleAnim').onclick=()=>{ animRunning=!animRunning; if(!animRunning) ringEl.style.transform=''; };
$('#btnPlay').onclick=async()=>{ await initAudio(); if(actx.state==='suspended') await actx.resume(); ping(); };
$('#btnKiosk').onclick=()=>{ document.body.classList.toggle('kiosk'); $('#toggleKiosk').checked = document.body.classList.contains('kiosk'); };
$('#btnInfodose').onclick=()=> alert('Ação única ⚡');
$('#navApps').onclick=()=> $('#appsPane').scrollIntoView({behavior:'smooth'});
$('#navHome').onclick=()=> window.scrollTo({top:0,behavior:'smooth'});
$('#navUser').onclick=()=> alert('Perfil em breve');

/* Sidebar */
const sidebar=$('#sidebar');
$('#btnHandle').onclick=()=> sidebar.classList.toggle('open');
$('#btnSideClose').onclick=()=> sidebar.classList.remove('open');

/* Labels toggle */
$('#toggleLabels').onchange=(e)=>{ const on=e.target.checked; const grid = $('#gridActions'); if(on){ grid.classList.remove('icon-only'); } else { grid.classList.add('icon-only'); } };

/* Kiosk toggle */
$('#toggleKiosk').onchange=(e)=>{ if(e.target.checked) document.body.classList.add('kiosk'); else document.body.classList.remove('kiosk'); };

/* Upload BG */
$('#bgUpload').addEventListener('change', async (e)=>{ const f=e.target.files?.[0]; if(!f) return; const url=await fileToDataURL(f); if(f.type.startsWith('video')) UNO.setBgVideo(url); else UNO.setBgImage(url); });
/* Upload RING */
$('#ringUpload').addEventListener('change', async (e)=>{ const f=e.target.files?.[0]; if(!f) return; const url=await fileToDataURL(f); state.rings.push(url); setRing(state.rings.length-1); });
/* Upload DOT */
$('#dotUpload').addEventListener('change', async (e)=>{ const f=e.target.files?.[0]; if(!f) return; const url=await fileToDataURL(f); $('#dot').style.backgroundImage = `url('${url}')`; updateThumb('Dot', url); });
/* Upload LOGO (só preview/controle) */
$('#logoUpload').addEventListener('change', async (e)=>{ const f=e.target.files?.[0]; if(!f) return; const url=await fileToDataURL(f); updateThumb('Logo', url); });

/* Upload HTML => cria blob: URL e adiciona na lista (sem depender só de localStorage) */
$('#htmlUpload').addEventListener('change', async (e)=>{ const f=e.target.files?.[0]; if(!f) return; const html = await f.text(); const blob = new Blob([html], {type:'text/html'}); const url = URL.createObjectURL(blob); const name = f.name.replace(/\.[^.]+$/, ''); state.apps.push({ name: `HTML: ${name}`, url }); renderApps(state.apps); openSandbox({name, url}); });

/* apps.json opcional (se existir) */
$('#btnLoadApps').onclick=async()=>{ try{ const r=await fetch('./apps/apps.json'); const j=await r.json(); const arr=(j.apps||j)||[]; state.apps = arr.concat(state.apps); renderApps(state.apps); }catch(e){ console.warn('Falha no apps.json', e); } };

/* Painel estilo */
$('#btnAppsToggle').onclick=()=>{ $('#appsPane').classList.toggle('neon'); };

/* Export ZIP (stub) */
$('#btnExport').onclick=()=> alert('Export ZIP virá em seguida (stub)');

/* Orientation lock (retrato) */
function checkOrientation(){ const isPortrait = window.matchMedia('(orientation: portrait)').matches; $('#rotateOverlay').classList.toggle('show', !isPortrait); }
window.addEventListener('orientationchange', checkOrientation);
window.addEventListener('resize', checkOrientation);
checkOrientation();

/* init */
setRing(0);
updateThumb('Dot', 'dual_uno_assets_v1/img/core/dot_core_01.png');
updateThumb('Ring', state.rings[0]);
</script>
</body>
</html>
