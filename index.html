<!--
  Esta √© a vers√£o final unificada do HUB UNO e do Hub Revo.
  Ela se baseia no arquivo ‚Äúunificado 3.html‚Äù (Mon√≥lito UNO) e incorpora
  uma nova aba chamada ‚ÄúRevo‚Äù, que carrega o Hub Infodose Ultra em um
  iframe.  O c√≥digo do Revo foi copiado para ‚Äúindex-100_revo_mod.html‚Äù e
  levemente modificado para buscar a lista de apps diretamente do
  elemento <script id="APPS_JSON"> presente nesta p√°gina.  Isso
  assegura que ambos os hubs compartilham o mesmo cat√°logo de apps sem
  depender de arquivos externos ausentes.
-->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <title>HUB UNO</title>
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root {
      /* Paleta padr√£o (rosa/azul) */
      --grad-a: #ff52e5;
      --grad-b: #00c5e5;
      --fg: #f5f7ff;
      --mut: rgba(245, 247, 255, .68);
      --surface: rgba(15, 17, 32, .50);
      --surface-strong: rgba(15, 17, 32, .88);
      --bd: 1px solid rgba(255, 255, 255, .12);
      --ok: #39ffb6;
      --warn: #ffb86b;
      --err: #ff6b6b;
      --r: 18px;
      --r2: 22px;
      --shadow: 0 14px 40px rgba(0, 0, 0, .45);
      --tabsH: 74px;
      --hdrH: 64px;
      --blur: 24px;
      --ease: cubic-bezier(.22, .61, .36, 1);
    }

    /* Tema alternativo: medium gray / glasmorfismo. Quando body[data-theme="medium"] estiver definido, estas vari√°veis substituem as originais. */
    body[data-theme="medium"] {
      /* Ajustamos a paleta ‚Äúmedium‚Äù para um visual ainda mais tecnol√≥gico,
         com tons de cinza-escuro/azulado e transpar√™ncias suaves para
         refor√ßar o glasmorfismo. */
      --grad-a: #2c313c;
      --grad-b: #1f242d;
      --fg: #f1f2f5;
      --mut: rgba(241, 242, 245, .68);
      --surface: rgba(44, 47, 56, .40);
      --surface-strong: rgba(44, 47, 56, .75);
      --bd: 1px solid rgba(255, 255, 255, .06);
      --ok: #68d391;
      --warn: #f6ad55;
      --err: #fc8181;
      --blur: 24px;
    }

    * { box-sizing: border-box }
    html, body { height: 100% }

    body {
      margin: 0;
      min-height: 100dvh;
      color: var(--fg);
      background: linear-gradient(42deg, var(--grad-a), var(--grad-b)) fixed;
      font: 14px/1.45 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      overflow: hidden;
    }

    /* ===== Micro-intera√ß√µes base ===== */
    .fx-trans { transition: transform .16s var(--ease), background .25s var(--ease), box-shadow .25s var(--ease), border-color .25s var(--ease), color .25s var(--ease), opacity .25s var(--ease) }
    .fx-lift:hover { transform: translateY(-1px) }
    .fx-press:active { transform: translateY(0) scale(.98) }
    .ring:focus-visible { outline: 0; box-shadow: 0 0 0 4px rgba(255,255,255,.14) }
    @media (prefers-reduced-motion: reduce) { .fx-trans { transition: none } }

    /* ===== Bot√µes ===== */
    button, .btn, .ib { background: var(--surface); border: var(--bd); color: var(--fg); font-weight: 800; border-radius: 12px; cursor: pointer; position: relative }
    .btn { padding: .58rem .9rem; background: linear-gradient(180deg, #11162a, #0b1122) }
    .btn.prime { background: linear-gradient(90deg, #a66fff, #6db4ff); color: #0b0f14; border-color: transparent }
    .btn:hover { box-shadow: 0 8px 26px rgba(0,0,0,.36), 0 0 0 1px rgba(255,255,255,.10) inset }
    .btn.prime:hover { box-shadow: 0 10px 30px rgba(166,111,255,.26), 0 0 0 1px rgba(255,255,255,.18) inset }
    .btn:active { filter: saturate(1.02) brightness(.98) }
    .btn[disabled] { opacity: .55; pointer-events: none }

    /* Ripple */
    .ripple { position: absolute; inset: 0; overflow: hidden; border-radius: inherit }
    .ripple > i { position: absolute; border-radius: 999px; pointer-events: none; transform: translate(-50%, -50%); background: radial-gradient(closest-side, rgba(255,255,255,.35), rgba(255,255,255,0) 70%); animation: ripple .6s var(--ease) forwards }
    @keyframes ripple { from { opacity: .55; width: 0; height: 0 } to { opacity: 0; width: 260px; height: 260px } }

    /* ===== Header ===== */
    header.mast { position: relative; inset: 0 0 auto 0; height: var(--hdrH); z-index: 100; display: flex; align-items: center; gap: 10px; padding: 0 12px; backdrop-filter: blur(var(--blur)) saturate(130%); background: linear-gradient(180deg, rgba(0,0,0,.28), rgba(0,0,0,0)) }
    .ib { width: 42px; height: 42px; border-radius: 50%; display: grid; place-items: center; box-shadow: var(--shadow) }
    .ib.fx-trans:hover { box-shadow: 0 10px 28px rgba(0,0,0,.5), 0 0 0 2px rgba(255,255,255,.10) inset }
    .title { flex: 1; text-align: center; line-height: 1 }
    .title h1 { margin: 0; font-size: 18px; letter-spacing: .06em; font-weight: 900 }
    .title small { display: block; color: var(--mut); letter-spacing: .1em }

    /* ===== Layout ===== */
    main { position: relative; height: 100%; padding-top: calc(var(--hdrH) + env(safe-area-inset-top)); padding-bottom: calc(var(--tabsH) + env(safe-area-inset-bottom)); overflow: hidden }
    .view { position: absolute; inset: 0; padding: 12px 14px; overflow: auto; display: none }
    .view.active { display: block; animation: fade .18s var(--ease) }
    @keyframes fade { from { opacity: 0; transform: translateY(6px) } }

    /* ===== Cards / grids ===== */
    .grid { display: grid; gap: 12px; max-width: 820px; margin: 0 auto }
    /* Distribua os cart√µes de status da Home em duas colunas para melhor encaixe.
       Em telas estreitas (<560px) eles se empilham em uma √∫nica coluna. */
    .cards { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px }
    @media (max-width: 560px) { .cards { grid-template-columns: 1fr } }

    /* Ocultar o menu de op√ß√µes (Apps, Stack, Brain, Revo) na Home quando apenas a bola dos arqu√©tipos deve aparecer */
    /* Hide the UNO info card on home. The cards row is now used for status notifications */
    #v-home #unoCard {
      display: none;
    }

    /* Esconde a grade de cards na Home e abre espa√ßo para o feed de IA */
    #v-home .cards {
      display: none !important;
    }

    /* Estiliza o feed de mensagens da IA em formato de conversa */
    #iaFeed {
      margin: 12px auto 0;
      max-width: 820px;
      background: var(--surface);
      border: var(--bd);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      padding: 12px;
      font-size: 14px;
      line-height: 1.5;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    #iaFeed .msg {
      margin: 0;
      padding: 8px 12px;
      border-radius: 16px;
      max-width: 75%;
      word-wrap: break-word;
    }
    #iaFeed .msg.user {
      align-self: flex-end;
      background: rgba(255,255,255,0.1);
      border-radius: 16px 16px 0 16px;
    }
    #iaFeed .msg.ai {
      align-self: flex-start;
      background: rgba(57,255,182,0.12);
      border-radius: 16px 16px 16px 0;
    }
    #iaFeed .status {
      color: var(--mut);
      font-size: 12px;
      align-self: center;
    }

    /* ===== Apps Page customizations ===== */
    /* Estilizar bot√£o de upload de HTML local para destaque */
    #btnImport {
      font-weight: 700;
      color: var(--ink);
      background: var(--glass);
      border-color: var(--line);
    }
    /* Favorite icon/button dentro de cada cart√£o de app */
    .app-card {
      position: relative;
    }
    .fav-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 22px;
      height: 22px;
      background: transparent;
      border: none;
      padding: 0;
      cursor: pointer;
      opacity: 0.6;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
    }
    .fav-btn.fav {
      opacity: 1;
    }
    .fav-btn img {
      width: 100%;
      height: 100%;
      /* √çcones n√£o favoritados ficam em tons de cinza para indicar estado off */
      filter: grayscale(1) brightness(0.5);
    }
    .fav-btn.fav img {
      /* √çcone favoritado mant√©m cor original (amarelo) */
      filter: none;
    }
    .card { background: var(--surface); border: var(--bd); border-radius: var(--r2); box-shadow: var(--shadow); padding: 12px; display: flex; gap: 10px; align-items: center; position: relative }
    .card.fx-trans:hover { box-shadow: 0 16px 40px rgba(0,0,0,.5) }
    .ico { width: 44px; height: 44px; border-radius: 14px; display: grid; place-items: center; background: rgba(255,255,255,.06); border: var(--bd) }
    .mut { color: var(--mut); font-size: 12px }
    .input, select, textarea { width: 100%; background: #0f1426; color: var(--fg); border: var(--bd); border-radius: 12px; padding: 10px }

    /* Ajuste para √≠cones SVG externos: invert√™-los para que fiquem claros em temas escuros */
    header.mast img,
    .tabbar img,
    .card .ico img,
    .session .tools img,
    .dock img {
      filter: invert(1) brightness(1.2);
    }

    /* ===== Apps ===== */
.apps-wrap {
      display: grid;
      gap: 12px;
      /* Distribui os apps em colunas responsivas: cada cart√£o ter√° no m√≠nimo 240px. */
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      /* Adiciona uma margem inferior generosa para que o dock/tabbar n√£o sobreponha os √∫ltimos elementos. */
      padding-bottom: 80px;
    }
.app-card {
      display: flex;
      gap: 12px;
      align-items: center;
      /* Use um fundo um pouco mais claro para destacar cada app e melhorar a legibilidade */
      background: rgba(255, 255, 255, 0.06);
      border: var(--bd);
      border-radius: var(--r);
      padding: 14px;
    }
    .app-card:hover { box-shadow: 0 12px 34px rgba(0,0,0,.46) }
    .app-icon { width: 42px; height: 42px; border-radius: 12px; display: grid; place-items: center; background: #0f1528; border: var(--bd); overflow: hidden }
    .app-title {
      font-weight: 800;
      /* Evitar quebra de linhas em t√≠tulos longos e mostrar retic√™ncias */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    /* √Çncora para sess√µes abertas no topo da p√°gina (modo "abrir dentro"). */
    #sessionsAnchor {
      display: grid;
      gap: 12px;
      margin: 12px 14px;
    }
    /* Estilos para o painel Brain (perfil, performance, voz, logs). */
    #brain { position: fixed; top: calc(var(--hdrH) + 12px); right: 14px; width: min(92vw, 440px); z-index: 130; }
    #brain.hide { display: none !important; }
    .popover { border-radius: 24px; padding: 12px; background: var(--surface-strong); border: var(--bd); backdrop-filter: blur(var(--blur)); }
    .menuItem { display: flex; gap: 12px; align-items: center; border: var(--bd); background: var(--surface); border-radius: 16px; padding: 12px; }
    .menuItem + .menuItem { margin-top: 9px; }
    .input { display: flex; gap: 8px; align-items: center; background: var(--surface); border: var(--bd); border-radius: 14px; padding: 9px 11px; }
    .input input, .input select { flex: 1; background: transparent; border: 0; outline: 0; color: var(--fg); font-size: 13px; }
    .notice { font-size: 12px; color: var(--mut); }

    /* ===== Viewer (Stack) ===== */
    .session { background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); border: var(--bd); border-radius: 16px; box-shadow: var(--shadow); overflow: hidden }
    .session .hdr { display: flex; align-items: center; gap: 8px; padding: 10px; background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border-bottom: 1px solid #ffffff18 }
    .session .title { font-weight: 850; max-width: 56vw; white-space: nowrap; overflow: hidden; text-overflow: ellipsis }
    .session .tools { margin-left: auto; display: flex; gap: 6px }
    .session .tools .btn:hover { box-shadow: 0 0 0 1px rgba(255,255,255,.18) inset, 0 8px 22px rgba(0,0,0,.35) }
    .session iframe { display: block; width: 100%; height: 60vh; border: 0; background: #000 }
    .session.min iframe { display: none }

    /* ===== Dock + Tabs ===== */
    .dock { position: fixed; left: 10px; right: 10px; bottom: calc(var(--tabsH) + 8px + env(safe-area-inset-bottom)); display: flex; gap: 8px; flex-wrap: wrap; z-index: 80 }
    .badge { display: inline-flex; gap: 6px; align-items: center; padding: .38rem .65rem; border: 1px solid #ffffff18; background: #0f1428; border-radius: 999px; font-weight: 800; position: relative }
    .badge.fx-trans:hover { box-shadow: 0 10px 24px rgba(0,0,0,.5) }
    nav.tabbar { position: fixed; left: 0; right: 0; bottom: env(safe-area-inset-bottom, 0); height: var(--tabsH); z-index: 90; display: flex; justify-content: center; padding: 6px 14px }
    .tabbar .inner { width: 100%; max-width: 820px; display: flex; justify-content: space-around; align-items: center; background: var(--surface); border: var(--bd); border-radius: 22px; box-shadow: var(--shadow); padding: 10px 14px }
    .tab { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 6px; color: var(--mut); font-size: 11px; font-weight: 800; padding: 8px; border-radius: 14px; cursor: pointer; position: relative }
    .tab.fx-trans:hover { background: rgba(255,255,255,.06) }
    .tab.active { color: var(--fg); background: rgba(255,255,255,.10); box-shadow: 0 0 0 2px rgba(255,255,255,.10) }

    /* === √Årea de Arqu√©tipos (central circle) === */
    .arch-container {
      /* Organize o c√≠rculo e o seletor em coluna.  Alinhe os elementos ao centro
         e adicione um pequeno espa√ßamento vertical.  A propriedade position
         relative permite posicionar o menu de op√ß√µes de forma absoluta logo
         abaixo do c√≠rculo. */
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      justify-content: center;
      /* D√° mais espa√ßo do topo, relativo √† altura da viewport */
      margin-top: 5vh;
    }
    .arch-circle {
      position: relative;
      width: min(80vw, 560px);
      aspect-ratio: 1 / 1;
      border-radius: 50%;
      /* O conte√∫do deve permanecer dentro da forma circular para evitar
         que o iframe quadrado ‚Äúvaze‚Äù e pare√ßa um quadrado. */
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.12);
      background: radial-gradient(60% 60% at 50% 50%, rgba(0,255,255,.1), rgba(255,255,255,.02));
      box-shadow: var(--shadow, 0 14px 40px rgba(0,0,0,.45));
      /* Anima√ß√£o de clique: quando a classe .pressed √© aplicada via JS, reduza
         levemente o tamanho para simular press√£o. */
      transition: transform .18s var(--ease);
    }

    .arch-circle.pressed {
      transform: scale(0.96);
    }

    .arch-circle iframe {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: 0;
      background: transparent;
    }

  /* Certifique-se de que o logotipo de ponto e o c√≠rculo de arqu√©tipo
     fiquem sobrepostos ao iframe. O seletor (arch-switcher) √©
     configurado separadamente e fica fora do c√≠rculo. */
  .arch-dotlogo, .arch-circle {
    position: relative;
    z-index: 60;
  }
    .arch-switcher {
      /* O seletor fica fora do c√≠rculo, como um elemento pr√≥prio da
         coluna.  N√£o √© posicionado de forma absoluta; sua posi√ß√£o √©
         determinada pelo fluxo flex da .arch-container. */
      display: flex;
      gap: 6px;
      align-items: center;
      background: rgba(15,17,32,.7);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      padding: 4px 8px;
      backdrop-filter: blur(8px);
      z-index: 70;
    }
    .arch-switcher select {
      appearance: none;
      background: rgba(255,255,255,.06);
      color: var(--fg);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      /* Reduzir padding e tamanho de fonte para caber melhor fora do c√≠rculo */
      padding: 4px 8px;
      font-size: 12px;
    }

  /* Redimensionar bot√µes do seletor de arqu√©tipos para um tamanho mais compacto */
  .arch-switcher button {
    width: 30px;
    height: 30px;
    padding: 0;
    border-radius: 8px;
  }

    /* Quando o modo √°udio est√° ativo, destaque o c√≠rculo com uma borda sutil */
    .arch-circle.audio-on {
      box-shadow: 0 0 0 2px var(--ok), var(--shadow);
    }

    /* Mensagem exibida fora do c√≠rculo do arqu√©tipo.  Ela fica abaixo
       da bolinha e utiliza um fundo transl√∫cido para garantir
       legibilidade.  O elemento aparece e desaparece com uma transi√ß√£o
       de opacidade. */
    .arch-msg {
      margin-top: 8px;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(15,17,32,.72);
      color: var(--fg);
      font-size: 13px;
      max-width: 90%;
      text-align: center;
      pointer-events: none;
      opacity: 0;
      transition: opacity .3s ease;
    }
    .arch-msg.show { opacity: 1; }

    /* Estiliza√ß√£o do menu de arqu√©tipos acionado ao tocar a bola.  O menu
       exibe op√ß√µes de navega√ß√£o (Apps, Stack, Usu√°rio, Arqu√©tipo e Revo)
       e fica escondido por padr√£o.  Quando a classe .show √© aplicada,
       ele usa flexbox para alinhar os bot√µes. */
    .arch-menu {
      /* O menu √© posicionado de forma absoluta abaixo do c√≠rculo.  Por
         padr√£o, ele fica invis√≠vel at√© que a classe .show seja aplicada.
         A propriedade transform centraliza o menu horizontalmente em
         rela√ß√£o ao cont√™iner. */
      position: absolute;
      top: calc(100% + 10px);
      left: 50%;
      transform: translateX(-50%);
      display: none;
      gap: 10px;
      z-index: 70;
    }
    .arch-menu.show {
      display: flex;
    }
    .arch-menu button {
      border: var(--bd);
      background: var(--surface);
      border-radius: 12px;
      padding: 6px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--fg);
      font-size: 10px;
      cursor: pointer;
    }
    .arch-menu button:hover {
      box-shadow: 0 10px 24px rgba(0,0,0,.5);
    }

    /* Quando o bot√£o de √°udio est√° ativado, destaque-o com a cor "ok" */
    .arch-menu button.on {
      background: var(--ok);
      color: var(--surface-strong);
    }
    .arch-menu button.on img {
      filter: none;
    }
    .arch-menu button img {
      width: 20px;
      height: 20px;
      margin-bottom: 2px;
      filter: invert(1) brightness(1.2);
    }
    #arch-fadeCover {
      position: absolute;
      inset: 0;
      background: var(--bg, #0b0f14);
      opacity: 0;
      pointer-events: none;
      transition: opacity .3s ease;
    }
    #arch-fadeCover.show { opacity: 1; }

    /* Camada para ripples de √°udio: fica sobre o conte√∫do do c√≠rculo e ajusta a opacidade
       conforme a intensidade capturada pelo microfone. Utilizamos mix-blend-mode
       para adicionar um brilho sutil sem quebrar a est√©tica minimalista. */
    .audio-ripple {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      /* A camada de ripple agora serve tamb√©m como √°rea de clique para ativar o modo √°udio. */
      pointer-events: auto;
      /* Retire o gradiente, pois o efeito visual passa a ser aplicado via box-shadow no c√≠rculo */
      background: transparent;
      /* Mantenha um z-index alto para captar cliques acima do iframe */
      z-index: 70;
    }

    /* ===== Modal ===== */
    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 120; background: rgba(0,0,0,.45); backdrop-filter: blur(6px) }
    .modal.open { display: flex }
    .modal .panel { width: min(720px, 92vw); background: var(--surface-strong); border: var(--bd); border-radius: 16px; box-shadow: var(--shadow); padding: 16px }
    .kbd { border: 1px solid rgba(255,255,255,.2); background: rgba(255,255,255,.06); padding: 2px 6px; border-radius: 6px; font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 12px }

    /* ===== REVO view styling ===== */
    /* Remove default padding for the new Revo section and ensure the iframe fills the space */
    #v-revo { padding: 0; }
    #v-revo iframe { width: 100%; height: 100%; border: 0; background: transparent; }
  
/* === Dual adjustments (Kodux request) === */
/* Feed no topo do portal e com tamanho m√°ximo */
#v-home #iaFeed{
  max-height: 260px;
  overflow: auto;
  margin: 8px auto 10px;
  z-index: 90;
}
/* Quando body.nav-right: barra de navega√ß√£o vertical √† direita */
body.nav-right .tabbar{
  position: fixed;
  right: 14px;
  top: 50%;
  transform: translateY(-50%);
  width: 56px;
  height: auto;
  background: transparent;
  border: 0;
  box-shadow: none;
  padding: 0;
}
body.nav-right .tabbar .inner{
  display: grid;
  gap: 10px;
}
body.nav-right .tabbar .tab{
  width: 56px; height: 56px; border-radius: 16px;
  display: grid; place-items: center;
}
    /* === CHAT (ex-Revo) === */
#v-chat { padding: 0; display: grid; grid-template-rows: 1fr auto; }
.chat-feed { padding: 12px 14px; overflow: auto; display: flex; flex-direction: column; gap: 8px; }
.chat-msg { margin: 0; padding: 10px 12px; border-radius: 16px; max-width: 75%; word-wrap: break-word; }
.chat-msg.user { align-self: flex-end; background: rgba(255,255,255,.10); border-radius: 16px 16px 0 16px; }
.chat-msg.ai   { align-self: flex-start; background: rgba(57,255,182,.12); border-radius: 16px 16px 16px 0; }
.chat-status { color: var(--mut); font-size: 12px; align-self: center; }
.chat-inputbar { display: flex; gap: 8px; padding: 10px 14px; background: var(--surface); border-top: var(--bd); }
.chat-inputbar textarea { flex: 1; min-height: 42px; max-height: 36vh; resize: vertical; }

/* === Right FAB buttons (texto/voz) === */
.right-fab { position: fixed; right: 14px; bottom: calc(var(--tabsH) + 90px + env(safe-area-inset-bottom)); z-index: 110; display: grid; gap: 10px; }
.right-fab .fab { width: 52px; height: 52px; border-radius: 16px; display: grid; place-items: center; border: var(--bd); background: var(--surface-strong); box-shadow: var(--shadow); }
.right-fab .fab:hover { box-shadow: 0 12px 30px rgba(0,0,0,.5) }

/* === Modal de input r√°pido de chat === */
#modalChatInput .panel { display: grid; gap: 10px; }
#modalChatInput textarea { width: 100%; min-height: 96px; }

/* === Brain: viewer de fundos === */
.bg-viewer { display: grid; grid-template-columns: repeat(auto-fill,minmax(140px,1fr)); gap: 10px; }
.bg-item { background: var(--surface); border: var(--bd); border-radius: 12px; overflow: hidden; display: grid; grid-template-rows: 100px auto; }
.bg-item .thumb { width: 100%; height: 100px; object-fit: cover; display: block; background:#000; }
.bg-item .actions { display: flex; gap: 6px; padding: 8px; }
.bg-item small { color: var(--mut); display:block; padding: 0 8px 8px; }
</style>
</head>
<body>
  <!-- ===== Header ===== -->
  <header class="mast">
    <button class="ib fx-trans fx-press ring" id="btnBack" title="Voltar" aria-label="Voltar">
    <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/arrow-left.svg" alt="Voltar" width="20" height="20" onerror="this.onerror=null;this.src='icons/arrow-left.svg'">
      <span class="ripple"></span>
    </button>
    <div class="title">
      <h1>HUB UNO</h1>
      <small>Dual ¬∑ Trinity</small>
    </div>
    <button class="ib fx-trans fx-press ring" id="btnDownload" title="Baixar HTML">
<img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/download.svg" alt="Download" width="20" height="20" onerror="this.onerror=null;this.src='icons/download.svg'">
      <span class="ripple"></span>
    </button>
    <button class="ib fx-trans fx-press ring" id="btnHelp" title="Ajuda / Atalhos">
<img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/question-circle.svg" alt="Ajuda" width="20" height="20" onerror="this.onerror=null;this.src='icons/question-circle.svg'">
      <span class="ripple"></span>
    </button>
    <button class="ib fx-trans fx-press ring" id="btnBrain" title="Brain">
<img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/brain.svg" alt="Brain" width="20" height="20" onerror="this.onerror=null;this.src='icons/brain.svg'">
      <span class="ripple"></span>
    </button>
  </header>

  <!-- √Çncora para sess√µes abertas quando o usu√°rio optar por abrir dentro da p√°gina -->
  <section id="sessionsAnchor"></section>

  <!-- Container para fundo personalizado (imagem ou v√≠deo).  Ser√° preenchido via JS quando o usu√°rio escolher
       um tema customizado.  Fica no in√≠cio do body para garantir que fique abaixo de todos os conte√∫dos -->
  <div id="custom-bg" style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;overflow:hidden;pointer-events:none"></div>

  <!-- ===== Views ===== -->
  <main>
    <!-- HOME -->
    <section id="v-home" class="view active">
      <div class="grid">
          <!-- Sauda√ß√£o / chamada para cadastro. Vis√≠vel quando o usu√°rio precisa ativar a Dual Infodose ou quando j√° houver nome salvo -->
          <div id="greetingCard" class="card fx-trans fx-lift" style="display:none">
            <div id="greetingMsg" style="font-weight:800"></div>
          </div>
        <div id="unoCard" class="card fx-trans fx-lift" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;width:100%">
            <div>
              <div style="font-weight:900;letter-spacing:.08em">UNO ‚Ä¢ foco e velocidade</div>
              <div class="mut">Mon√≥lito: Apps embutidos + Viewer + Dock + Atalhos</div>
            </div>
            <div class="ico">
<img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/bolt.svg" alt="Energia" width="24" height="24" onerror="this.onerror=null;this.src='icons/bolt.svg'">
            </div>
          </div>
        </div>
        <!-- √Årea de Arqu√©tipos incorporada -->
        <div class="arch-container">
          <!-- Mover o seletor de arqu√©tipos para fora do c√≠rculo.  Ele ficar√° acima
               da bolinha e seguir√° o layout vertical da arch-container. -->
          <div class="arch-switcher">
            <button class="btn fx-trans fx-press ring" id="arch-prev" title="Anterior">
              <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/chevron-left.svg" alt="Anterior" width="16" height="16" onerror="this.onerror=null;this.src='icons/chevron-left.svg'">
            </button>
            <select id="arch-select" title="Escolher arqu√©tipo"></select>
            <button class="btn fx-trans fx-press ring" id="arch-next" title="Pr√≥ximo">
              <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/chevron-right.svg" alt="Pr√≥ximo" width="16" height="16" onerror="this.onerror=null;this.src='icons/chevron-right.svg'">
            </button>
          </div>
          <div class="arch-circle">
            <div id="arch-fadeCover"></div>
            <!-- Camada de ripple auditivo fica sobre o conte√∫do do c√≠rculo -->
            <div id="audioRipple" class="audio-ripple"></div>
            <iframe id="arch-frame" title="Archetype Core" sandbox="allow-scripts" referrerpolicy="no-referrer"></iframe>
          </div>
          <!-- Mensagem de feedback aparece fora da bolinha, logo abaixo dela -->
          <div id="archMsg" class="arch-msg"></div>
          <!-- Menu de arqu√©tipos: permite acessar Apps, Stack, Usu√°rio, Revo e Home -->
          <div id="archMenu" class="arch-menu">
            <button data-nav="apps">
              <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/folder-open.svg" alt="Apps" width="20" height="20" onerror="this.onerror=null;this.src='icons/folder-open.svg'">
              <span>Apps</span>
            </button>
            <button data-nav="stack">
              <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/layer-group.svg" alt="Stack" width="20" height="20" onerror="this.onerror=null;this.src='icons/layer-group.svg'">
              <span>Stack</span>
            </button>
            <button data-nav="brain">
              <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/user.svg" alt="Usu√°rio" width="20" height="20" onerror="this.onerror=null;this.src='icons/user.svg'">
              <span>Usu√°rio</span>
            </button>
            <button data-nav="home">
              <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/yin-yang.svg" alt="Arqu√©tipo" width="20" height="20" onerror="this.onerror=null;this.src='icons/yin-yang.svg'">
              <span>Arqu√©tipo</span>
            </button>
            <button class="tab fx-trans fx-press ring" data-nav="chat">
  <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/message.svg" alt="Chat" width="18" height="18" onerror="this.onerror=null;this.src='icons/message.svg'">
  <span style="display:none">Chat</span><span class="ripple"></span>
</button>
          <button data-audio="true" id="archAudioBtn">
            <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/microphone-lines.svg" alt="√Åudio" width="20" height="20" onerror="this.onerror=null;this.src='icons/microphone-lines.svg'">
            <span>√Åudio</span>
          </button>
          </div>
        </div>
        <!-- Feed de texto da IA -->
        <div id="iaFeed" aria-live="polite" aria-atomic="false">
          <div class="status">Toque a bolinha para falar com a IA.</div>
        </div>
        <div class="cards">
          <button class="card fx-trans fx-press ring" data-nav="apps">
            <div class="ico">
<img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/folder-open.svg" alt="Apps" width="24" height="24" onerror="this.onerror=null;this.src='icons/folder-open.svg'">
            </div>
            <div>
              <div style="font-weight:800">Apps</div>
              <div class="mut" id="homeAppsStatus">‚Äì</div>
            </div>
            <span class="ripple"></span>
          </button>
          <button class="card fx-trans fx-press ring" data-nav="stack">
            <div class="ico">
<img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/layer-group.svg" alt="Stack" width="24" height="24" onerror="this.onerror=null;this.src='icons/layer-group.svg'">
            </div>
            <div>
              <div style="font-weight:800">Stack</div>
              <div class="mut" id="homeStackStatus">‚Äì</div>
            </div>
            <span class="ripple"></span>
          </button>
          <button class="card fx-trans fx-press ring" data-nav="brain">
            <div class="ico">
<img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/user.svg" alt="Usu√°rio" width="24" height="24" onerror="this.onerror=null;this.src='icons/user.svg'">
            </div>
            <div>
              <div style="font-weight:800">Usu√°rio</div>
              <div class="mut" id="homeUserStatus">‚Äì</div>
            </div>
            <span class="ripple"></span>
          </button>
          <button class="card fx-trans fx-press ring" data-nav="home">
            <div class="ico">
<img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/yin-yang.svg" alt="Arqu√©tipo" width="24" height="24" onerror="this.onerror=null;this.src='icons/yin-yang.svg'">
            </div>
            <div>
              <div style="font-weight:800">Arqu√©tipo</div>
              <div class="mut" id="homeArchStatus">‚Äì</div>
            </div>
            <span class="ripple"></span>
          </button>
        </div>
      </div>
    </section>

    <!-- APPS -->
    <section id="v-apps" class="view">
      <div class="grid">
        <div class="card fx-trans fx-lift" style="display:block">
          <div class="grid" style="gap:8px">
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
              <!-- Removemos a busca e o sort. Agora apenas a op√ß√£o de abrir dentro e o bot√£o para mostrar locais -->
              <label class="mut" style="display:inline-flex;gap:6px;align-items:center">
                <input id="openInside" type="checkbox" /> abrir dentro
              </label>
              <button id="btnToggleLocal" class="btn fx-trans fx-press ring">
                <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/folder-open.svg" alt="Locais" width="16" height="16" onerror="this.onerror=null;this.src='icons/folder-open.svg'" style="margin-right:4px">
                Mostrar Locais<span class="ripple"></span>
              </button>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
              <!-- Aceita arquivos .json al√©m de HTML/TXT para permitir upload de cat√°logos personalizados -->
              <input id="fileLocal" type="file" accept=".html,.htm,.txt,.json" multiple class="input ring" />
              <button id="btnImport" class="btn fx-trans fx-press ring">
                <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/plus-circle.svg" alt="Adicionar" width="16" height="16" onerror="this.onerror=null;this.src='icons/plus-circle.svg'" style="margin-right:4px">
                Adicionar Locais<span class="ripple"></span>
              </button>
              <button id="btnExport" class="btn fx-trans fx-press ring">
                <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/file-export.svg" alt="Exportar" width="16" height="16" onerror="this.onerror=null;this.src='icons/file-export.svg'" style="margin-right:4px">
                Exportar Locais<span class="ripple"></span>
              </button>
              <button id="btnClear" class="btn fx-trans fx-press ring">
                <img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/trash.svg" alt="Limpar" width="16" height="16" onerror="this.onerror=null;this.src='icons/trash.svg'" style="margin-right:4px">
                Limpar Locais<span class="ripple"></span>
              </button>
            </div>
            <div id="appsCount" class="mut">‚Äî</div>
          </div>
        </div>
        <div id="appsWrap" class="apps-wrap"></div>
      </div>
    </section>

    <!-- STACK -->
    <section id="v-stack" class="view">
      <div class="grid">
        <div class="card fx-trans fx-lift" style="display:block">
          <div style="font-weight:800; display:flex; align-items:center; gap:8px">
            Sess√µes
            <button id="btnCloseAll" class="btn fx-trans fx-press ring" title="Fechar todas">Fechar todas<span class="ripple"></span></button>
          </div>
          <div class="mut">Reabra r√°pido pelo dock abaixo.</div>
        </div>
        <div id="stackWrap" class="grid"></div>
      </div>
    </section>

    <!-- BRAIN -->
    <section id="v-brain" class="view">
      <div class="grid">
        <div class="card fx-trans fx-lift" style="display:block">
          <div style="font-weight:800">Usu√°rio</div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
            <input id="userName" class="input ring" placeholder="Seu nome" />
            <button id="saveName" class="btn prime fx-trans fx-press ring">Salvar<span class="ripple"></span></button>
          </div>
        </div>
        <div class="card fx-trans fx-lift" style="display:block">
          <div style="font-weight:800">OpenRouter</div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap">
            <select id="model" class="input ring" style="max-width:260px"></select>
            <input id="sk" class="input ring" placeholder="sk-or-v1-‚Ä¶" />
            <button id="saveSK" class="btn fx-trans fx-press ring">Salvar<span class="ripple"></span></button>
          </div>
        </div>

          <!-- Tema e Fundo personalizados -->
          <div class="card fx-trans fx-lift" style="display:block">
            <div style="font-weight:800">Tema &amp; Fundo</div>
            <div style="margin-top:8px;display:flex;flex-direction:column;gap:12px">
              <label style="display:flex;align-items:center;gap:8px">
                <span>Escolha o tema:</span>
                <select id="themeSelect" class="input ring" style="max-width:200px">
                  <option value="default">Padr√£o (colorido)</option>
                  <option value="medium">Cinza m√©dio (tecnol√≥gico)</option>
                  <option value="custom">Personalizado (sua imagem/v√≠deo)</option>
                </select>
              </label>
              <label style="display:flex;align-items:center;gap:8px">
                <span>Fundo personalizado:</span>
                <input id="bgUpload" type="file" accept="image/*,video/*" class="input ring" style="max-width:260px" />
              </label>
              <div class="mut" style="font-size:11px">Envie uma imagem ou v√≠deo para usar como plano de fundo quando o tema personalizado estiver selecionado. O fundo ser√° salvo automaticamente no seu navegador.</div>
              <!-- Viewer dos fundos salvos -->
<div style="font-weight:800; margin-top:10px">Backgrounds salvos</div>
<div id="bgViewer" class="bg-viewer"></div>
            </div>
          </div>

          <!-- CSS personalizado -->
          <div class="card fx-trans fx-lift" style="display:block">
            <div style="font-weight:800">CSS Personalizado</div>
            <div style="margin-top:8px">
              <textarea id="cssCustom" class="input ring" placeholder="CSS personalizado..." rows="4"></textarea>
              <div style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap">
                <button id="applyCSS" class="btn fx-trans fx-press ring">Aplicar CSS<span class="ripple"></span></button>
                <button id="clearCSS" class="btn fx-trans fx-press ring">Limpar CSS<span class="ripple"></span></button>
                <button id="downloadCSS" class="btn fx-trans fx-press ring">Baixar CSS<span class="ripple"></span></button>
              </div>
            </div>
          </div>

          <!-- Vozes dos Arqu√©tipos -->
          <div class="card fx-trans fx-lift" style="display:block">
            <div style="font-weight:800; margin-bottom:6px">Vozes dos Arqu√©tipos</div>
            <!-- √Årea de sele√ß√£o de voz por arqu√©tipo.  Cada arqu√©tipo possui
                 um seletor de voz e um bot√£o de teste.  Essa grade ser√°
                 preenchida dinamicamente pelo c√≥digo em initVoices(). -->
            <div id="voicesWrap" style="display:grid; gap:10px"></div>

          <!-- Prefer√™ncias de Performance -->
          <div class="card fx-trans fx-lift" style="display:block">
            <div style="font-weight:800">Performance</div>
            <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
              <select id="selPerf" class="input ring" style="max-width:200px">
                <option value="low">Low</option>
                <option value="med">Med</option>
                <option value="high">High</option>
              </select>
              <button id="btnPerf" class="btn fx-trans fx-press ring">Aplicar<span class="ripple"></span></button>
            </div>
          </div>

          <!-- Prefer√™ncias de Voz -->
          <div class="card fx-trans fx-lift" style="display:block">
            <div style="font-weight:800">Voz</div>
            <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
              <select id="selVoice" class="input ring" style="max-width:200px">
                <option>Nova</option>
                <option>Elysha</option>
                <option>Kaion</option>
                <option>Serena</option>
              </select>
              <button id="btnVoice" class="btn fx-trans fx-press ring">Salvar<span class="ripple"></span></button>
            </div>
          </div>

          <!-- Logs -->
          <div class="card fx-trans fx-lift" style="display:block">
            <div style="font-weight:800">Logs</div>
            <div class="mut" style="font-size:11px;margin-bottom:4px">Eventos recentes</div>
            <pre id="logs" style="margin:0;font:12px/1.4 ui-monospace,monospace;color:var(--mut);max-height:140px;overflow:auto"></pre>
          </div>
          </div>
      </div>
    </section>

    <!-- CHAT (ex-Revo) -->
<section id="v-chat" class="view">
  <div id="chatFeed" class="chat-feed" aria-live="polite">
    <div class="chat-status">Abra a conversa: envie um texto (üÖ£) ou voz (üéôÔ∏è).</div>
  </div>
  <div class="chat-inputbar">
    <textarea id="chatInput" class="input ring" placeholder="Escreva sua mensagem..."></textarea>
    <button id="btnChatSend" class="btn prime fx-trans fx-press ring">Enviar<span class="ripple"></span></button>
  </div>
</section>
  </main>

  <!-- DOCK & TABS -->
  <div id="dock" class="dock"></div>
  <nav class="tabbar">
    <div class="inner">
      <button class="tab fx-trans fx-press ring active" data-nav="home">
<img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/house.svg" alt="Home" width="18" height="18" onerror="this.onerror=null;this.src='icons/house.svg'">
        <span style="display:none">Home</span><span class="ripple"></span>
      </button>
      <button class="tab fx-trans fx-press ring" data-nav="apps">
<img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/folder-open.svg" alt="Apps" width="18" height="18" onerror="this.onerror=null;this.src='icons/folder-open.svg'">
        <span style="display:none">Apps</span><span class="ripple"></span>
      </button>
      <button class="tab fx-trans fx-press ring" data-nav="stack">
<img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/layer-group.svg" alt="Stack" width="18" height="18" onerror="this.onerror=null;this.src='icons/layer-group.svg'">
        <span style="display:none">Stack</span><span class="ripple"></span>
      </button>
      <button class="tab fx-trans fx-press ring" data-nav="brain">
<img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/brain.svg" alt="Brain" width="18" height="18" onerror="this.onerror=null;this.src='icons/brain.svg'">
        <span style="display:none">Brain</span><span class="ripple"></span>
      </button>
      <!-- Bot√£o da nova aba Revo -->
      <button class="tab fx-trans fx-press ring" data-nav="revo">
<img src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/svgs/solid/globe.svg" alt="Revo" width="18" height="18" onerror="this.onerror=null;this.src='icons/globe.svg'">
        <span style="display:none">Revo</span><span class="ripple"></span>
      </button>
    </div>
  </nav>

  <!-- HELP MODAL -->
  <div id="modalHelp" class="modal" aria-hidden="true">
    <div class="panel">
      <div style="display:flex;align-items:center;gap:10px;justify-content:space-between">
        <h3 style="margin:0">Ajuda & Atalhos</h3>
        <button id="closeHelp" class="btn fx-trans fx-press ring">Fechar<span class="ripple"></span></button>
      </div>
      <div class="mut" style="margin-top:8px">Navegue mais r√°pido:</div>
      <ul>
        <li><span class="kbd">g</span> then <span class="kbd">h</span> ‚Üí Home</li>
        <li><span class="kbd">g</span> then <span class="kbd">a</span> ‚Üí Apps</li>
        <li><span class="kbd">g</span> then <span class="kbd">s</span> ‚Üí Stack</li>
        <li><span class="kbd">g</span> then <span class="kbd">b</span> ‚Üí Brain</li>
        <li><span class="kbd">g</span> then <span class="kbd">r</span> ‚Üí Revo</li>
        <li><span class="kbd">Ctrl / Cmd</span> + <span class="kbd">K</span> ‚Üí Busca</li>
        <li><span class="kbd">Ctrl / Cmd</span> + <span class="kbd">S</span> ‚Üí Baixar este HTML</li>
      </ul>
    </div>
  </div>

  <!-- ===== Cat√°logo Embutido (Mon√≥lito) ===== -->
  <script id="APPS_JSON" type="application/json">
  {
    "apps": [
      {"key":"atlas","title":"Atlas ¬∑ Cartesius","desc":"Planejador estrat√©gico com cronogramas e checklists.","url":"about:blank","icon":"atlas"},
      {"key":"nova","title":"Nova ¬∑ Inspira","desc":"Criativa que desbloqueia ideias com mapas mentais e exerc√≠cios.","url":"about:blank","icon":"nova"},
      {"key":"vitalis","title":"Vitalis ¬∑ Momentum","desc":"Rotinas f√≠sicas, hacks biol√≥gicos e motiva√ß√£o.","url":"about:blank","icon":"vitalis"},
      {"key":"pulse","title":"Pulse ¬∑ Resona","desc":"Trilhas sonoras e ajuste de som emocional.","url":"about:blank","icon":"pulse"},
      {"key":"artemis","title":"Artemis ¬∑ Naviga","desc":"Explora conhecimentos e rotas de aprendizado.","url":"about:blank","icon":"artemis"},
      {"key":"serena","title":"Serena ¬∑ Ampara","desc":"Acolhimento e suporte emocional.","url":"about:blank","icon":"serena"},
      {"key":"kaos","title":"Kaos ¬∑ Disruptor","desc":"Questiona padr√µes e prop√µe solu√ß√µes ousadas.","url":"about:blank","icon":"kaos"},
      {"key":"genus","title":"Genus ¬∑ Fabricus","desc":"Prot√≥tipos e materializa√ß√£o de ideias.","url":"about:blank","icon":"genus"},
      {"key":"lumine","title":"Lumine ¬∑ Brilhare","desc":"Inspira√ß√£o leve e atividades l√∫dicas.","url":"about:blank","icon":"lumine"},
      {"key":"rhea","title":"Rhea ¬∑ Ra√≠zes","desc":"V√≠nculos e mem√≥rias emocionais.","url":"about:blank","icon":"rhea"},
      {"key":"solus","title":"Solus ¬∑ Arcana","desc":"Harmoniza√ß√£o energ√©tica e medita√ß√£o.","url":"about:blank","icon":"solus"},
      {"key":"aion","title":"Aion ¬∑ Evolutia","desc":"Microa√ß√µes estrat√©gicas e evolu√ß√£o.","url":"about:blank","icon":"aion"}
    ]
  }
  </script>

  <script>
    /* ===================== Helpers ===================== */
    const $ = (q, r = document) => r.querySelector(q);
    const $$ = (q, r = document) => Array.from(r.querySelectorAll(q));
    const LS = {
      get: (k, d) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d } catch (e) { return d } },
      set: (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)) } catch (e) {} },
      raw: (k) => localStorage.getItem(k) || ''
    };

    /* ===================== DualHub State & Logging ===================== */
    // Armazena prefer√™ncias de performance, voz e registros de eventos para a funcionalidade "Dual" aprimorada.
    const dualState = {
      perf: localStorage.getItem('hub.perf') || 'med',
      voice: localStorage.getItem('hub.voice') || 'Nova',
      logs: []
    };
    // Adiciona uma entrada ao log e atualiza o painel de logs no Brain.
    function dualLog(msg) {
      const entry = '[' + new Date().toLocaleTimeString() + '] ' + msg;
      dualState.logs.unshift(entry);
      const logsEl = document.getElementById('logs');
      if (logsEl) logsEl.textContent = dualState.logs.slice(0, 60).join('\n');
    }

    /* Ripple */
    function addRipple(el) {
      if (!el) return;
      // Ensure a ripple host exists on the element. The global ripple handler will create dots on pointerdown.
      if (!el.querySelector('.ripple')) {
        const slot = document.createElement('span');
        slot.className = 'ripple';
        el.appendChild(slot);
      }
      // Do not attach individual pointerdown events here; ripple will be handled globally.
    }

    /* Toast */
    const toastBox = document.createElement('div');
    toastBox.style.cssText = 'position:fixed;right:14px;bottom:calc(var(--tabsH) + 16px);display:grid;gap:8px;z-index:120';
    document.body.appendChild(toastBox);
    function toast(msg, type = 'ok') {
      const el = document.createElement('div'); el.className = 'fx-trans';
      const bg = type === 'ok' ? 'linear-gradient(90deg,#1b2a2a,#123c2e)' : (type === 'warn' ? 'linear-gradient(90deg,#2f261b,#3c2d12)' : 'linear-gradient(90deg,#2f1b1b,#3c1212)');
      el.style.cssText = `background:${bg}; color:var(--fg); border:${getComputedStyle(document.documentElement).getPropertyValue('--bd')}; padding:.6rem .8rem; border-radius:12px; box-shadow:var(--shadow)`;
      el.textContent = msg; toastBox.appendChild(el);
      setTimeout(() => { el.style.opacity = .0; el.style.transform = 'translateY(6px)'; setTimeout(() => el.remove(), 220); }, 1600);
    }

    /* ===================== Sauda√ß√£o / √∫ltimo estado ===================== */
    function displayGreeting() {
      const card = document.getElementById('greetingCard');
      // N√£o exibir o cart√£o de sauda√ß√£o; usamos mensagens na bolinha
      if (card) card.style.display = 'none';
      const name = (localStorage.getItem('infodose:userName') || '').trim();
      const sessions = document.querySelectorAll('.session').length;
      if (!name) {
        showArchMessage('Salve! Ative sua Dual‚ÄØInfodose registrando seu nome na se√ß√£o Brain.', 'warn');
      } else {
        showArchMessage(`Bem-vindo de volta, ${name}. UNO est√° ao seu lado. Voc√™ tem ${sessions} sess√£o(√µes) ativa(s).`, 'ok');
      }
    }

    /* ===================== Tema & Fundo personalizados ===================== */
    // Aplica o tema salvo no localStorage. Os temas poss√≠veis s√£o: 'default' (remove data-theme), 'medium'
    // e 'custom'.  Quando 'custom' estiver ativo, usa a imagem/v√≠deo salvo em LS ('uno:bg') como
    // plano de fundo.  Se 'medium' estiver selecionado, adiciona data-theme='medium'.
    function applyTheme() {
      const theme = LS.get('uno:theme', 'medium');
      // Limpe qualquer dataset para que CSS default seja aplicado quando 'default'
      if (theme === 'default') {
        delete document.body.dataset.theme;
      } else {
        document.body.dataset.theme = theme;
      }
      // Gerenciar fundo personalizado
      const bgContainer = document.getElementById('custom-bg');
      if (!bgContainer) return;
      if (theme !== 'custom') {
        bgContainer.innerHTML = '';
        return;
      }
      // Carregar dados do fundo
      const bgData = LS.get('uno:bg', '');
      bgContainer.innerHTML = '';
      if (!bgData) return;
      // Determine se √© v√≠deo ou imagem
      if (/^data:video\//.test(bgData)) {
        const vid = document.createElement('video');
        vid.src = bgData;
        vid.autoplay = true;
        vid.loop = true;
        vid.muted = true;
        vid.playsInline = true;
        vid.style.width = '100%';
        vid.style.height = '100%';
        vid.style.objectFit = 'cover';
        bgContainer.appendChild(vid);
      } else {
        const img = document.createElement('img');
        img.src = bgData;
        img.alt = '';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        bgContainer.appendChild(img);
      }
    }

    /* ===================== CSS Personalizado ===================== */
    // Aplica o CSS salvo em localStorage (chave 'infodose:cssCustom')
    function applyCSS() {
      let styleEl = document.getElementById('customStyle');
      if (!styleEl) {
        styleEl = document.createElement('style');
        styleEl.id = 'customStyle';
        document.head.appendChild(styleEl);
      }
      const css = localStorage.getItem('infodose:cssCustom') || '';
      styleEl.innerHTML = css || '';
    }

    // Inicializa sele√ß√£o de vozes para cada arqu√©tipo
    function initVoices() {
      const wrap = document.getElementById('voicesWrap');
      if (!wrap) return;
      wrap.innerHTML = '';
      const archList = [ 'Luxara','Rhea','Aion','Atlas','Nova','Genus','Lumine','Kaion','Kaos','Horus','Elysha','Serena' ];
      function populateVoices() {
        let voices = speechSynthesis.getVoices();
        // Filtrar por idiomas suportados (Portugu√™s e Ingl√™s) se dispon√≠vel
        const filtered = voices.filter(v => v.lang && (v.lang.startsWith('pt') || v.lang.startsWith('en')));
        voices = filtered.length ? filtered : voices;
        const saved = LS.get('infodose:voices', {}) || {};
        // Se ainda n√£o houver vozes salvas, defina um mapeamento padr√£o
        if (Object.keys(saved).length === 0 && voices.length) {
          archList.forEach((name, idx) => {
            const v = voices[idx % voices.length];
            if (v) saved[name] = v.name;
          });
          LS.set('infodose:voices', saved);
        }
        archList.forEach(name => {
          const row = document.createElement('div');
          row.style.display = 'flex';
          row.style.alignItems = 'center';
          row.style.gap = '8px';
          row.style.flexWrap = 'wrap';
          const label = document.createElement('span');
          label.textContent = name;
          label.style.minWidth = '70px';
          label.style.fontWeight = '700';
          const sel = document.createElement('select');
          sel.className = 'input ring';
          sel.style.maxWidth = '220px';
          voices.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.name;
            opt.textContent = `${v.name} (${v.lang})`;
            sel.appendChild(opt);
          });
          if (saved[name]) sel.value = saved[name];
          sel.onchange = () => {
            saved[name] = sel.value;
            LS.set('infodose:voices', saved);
          };
          const btnTest = document.createElement('button');
          btnTest.className = 'btn fx-trans fx-press ring';
          btnTest.textContent = 'Teste';
          const rp = document.createElement('span'); rp.className = 'ripple'; btnTest.appendChild(rp);
          addRipple(btnTest);
          btnTest.onclick = () => {
            const utter = new SpeechSynthesisUtterance(`Ol√°, eu sou ${name}`);
            const voiceName = saved[name] || sel.value;
            const voice = voices.find(v => v.name === voiceName);
            if (voice) utter.voice = voice;
            speechSynthesis.cancel();
            speechSynthesis.speak(utter);
          };
          row.appendChild(label);
          row.appendChild(sel);
          row.appendChild(btnTest);
          wrap.appendChild(row);
        });
      }
      populateVoices();
      // Re-populate when voices list changes
      window.speechSynthesis.onvoiceschanged = () => populateVoices();
    }

    // Pronuncia o nome do arqu√©tipo usando a voz selecionada
    function speakArchetype(name) {
      try {
        const archName = name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();
        const saved = LS.get('infodose:voices', {});
        const voices = speechSynthesis.getVoices();
        let voice = null;
        if (saved && saved[archName]) {
          voice = voices.find(v => v.name === saved[archName]);
        }
        if (!voice) {
          voice = voices.find(v => v.lang && (v.lang.startsWith('pt') || v.lang.startsWith('en')));
        }
        if (!voice && voices.length) voice = voices[0];
        if (!voice) return;
        const utter = new SpeechSynthesisUtterance(`Ol√°, eu sou ${archName}`);
        utter.voice = voice;
        speechSynthesis.cancel();
        speechSynthesis.speak(utter);
      } catch (e) {}
    }

    // Fala um texto usando a voz associada ao arqu√©tipo atualmente ativo.  Utiliza a lista
    // de vozes do Speech Synthesis e o mapeamento salvo em LS para encontrar a voz
    // correta. Se n√£o houver voz definida, escolhe a primeira dispon√≠vel (PT/EN).
    function speakWithActiveArch(text) {
      try {
        const select = document.getElementById('arch-select');
        let archFile = select ? select.value || '' : '';
        let base = archFile.replace(/\.html$/i, '');
        const key = base.charAt(0).toUpperCase() + base.slice(1).toLowerCase();
        const saved = LS.get('infodose:voices', {}) || {};
        const voices = speechSynthesis.getVoices();
        let voice = null;
        if (saved[key]) {
          voice = voices.find(v => v.name === saved[key]);
        }
        if (!voice) {
          voice = voices.find(v => v.lang && (v.lang.startsWith('pt') || v.lang.startsWith('en')));
        }
        if (!voice && voices.length) voice = voices[0];
        if (!voice) return;
        const utter = new SpeechSynthesisUtterance(text);
        utter.voice = voice;
        speechSynthesis.cancel();
        speechSynthesis.speak(utter);
      } catch (e) {}
    }

    // Exibe uma mensagem dentro do c√≠rculo do arqu√©tipo. A mensagem desaparece ap√≥s alguns segundos.
    function showArchMessage(text, type = 'info') {
      try {
        const el = document.getElementById('archMsg');
        if (!el) return;
        el.textContent = text;
        // Ajuste a cor de fundo conforme o tipo
        if (type === 'ok') {
          el.style.background = 'rgba(57,255,182,0.75)';
          el.style.color = '#0b0f14';
        } else if (type === 'warn') {
          el.style.background = 'rgba(255,184,107,0.78)';
          el.style.color = '#0b0f14';
        } else if (type === 'err') {
          el.style.background = 'rgba(255,107,107,0.78)';
          el.style.color = '#0b0f14';
        } else {
          el.style.background = 'rgba(15,17,32,0.72)';
          el.style.color = '';
        }
        el.classList.add('show');
        clearTimeout(el._tm);
        el._tm = setTimeout(() => {
          el.classList.remove('show');
        }, 4000);
      } catch (e) {}
    }

    // Configura o modo de ripple que responde ao √°udio do microfone.  Cria um
    // analisador de √°udio usando Web Audio API e ajusta a opacidade da camada
    // "audioRipple" conforme a intensidade do som capturado. Um bot√£o
    // (arch-audio) ativa/desativa o efeito de forma discreta.
    function initAudioRipple() {
      const clickLayer = document.getElementById('audioRipple');
      const archCircleEl = document.querySelector('.arch-circle');
      if (!clickLayer || !archCircleEl) return;
      let enabled = false;
      let audioCtx = null;
      let analyser = null;
      let micStream = null;
      // Inicia a captura de √°udio e anima√ß√£o
      async function start() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          micStream = stream;
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          const src = audioCtx.createMediaStreamSource(stream);
          analyser = audioCtx.createAnalyser();
          analyser.fftSize = 256;
          src.connect(analyser);
          animate();
        } catch (e) {
          toast('N√£o foi poss√≠vel acessar o microfone.', 'err');
          enabled = false;
          archCircleEl.classList.remove('audio-on');
        }
      }
      // Para a captura de √°udio e reseta a camada
      function stop() {
        if (micStream) {
          micStream.getTracks().forEach(t => t.stop());
          micStream = null;
        }
        if (audioCtx) {
          try { audioCtx.close(); } catch {}
          audioCtx = null;
        }
        // Remova o efeito de sombra quando desligar
        archCircleEl.style.boxShadow = '';
      }
      // Atualiza a opacidade da camada conforme o volume (RMS)
      function animate() {
        if (!enabled || !analyser) return;
        const buf = new Uint8Array(analyser.fftSize);
        analyser.getByteTimeDomainData(buf);
        let sum = 0;
        for (let i = 0; i < buf.length; i++) {
          const v = (buf[i] - 128) / 128;
          sum += v * v;
        }
        const rms = Math.sqrt(sum / buf.length);
        // Ajuste a intensidade: multiplique por um fator e limite a 0.6
        // Aplique um brilho em torno do c√≠rculo proporcional ao volume
        const intensity = Math.min(0.8, rms * 4);
        const blur = rms * 80;
        archCircleEl.style.boxShadow = `0 0 ${blur}px rgba(255,255,255,${intensity})`;
        requestAnimationFrame(animate);
      }
      // Clique simples no c√≠rculo inicia a intera√ß√£o Dual: anima a bolinha,
      // faz a sauda√ß√£o e inicia a captura de voz para conversar com a IA.
      clickLayer.addEventListener('click', () => {
        startDualInteraction();
      });

      // Fun√ß√£o global para alternar o modo de visualiza√ß√£o do √°udio (ripple).  
      // Mantemos para compatibilidade com o bot√£o de √°udio no menu.
      window.toggleAudio = function () {
        enabled = !enabled;
        archCircleEl.classList.toggle('audio-on', enabled);
        if (enabled) {
          start();
        } else {
          stop();
        }
      };
    }

    // Mensagem de boas-vindas/ativa√ß√£o
    function welcome() {
      const name = (localStorage.getItem('infodose:userName') || '').trim();
      if (!name) {
        const msg = 'Salve! Ative sua Dual‚ÄØInfodose registrando seu nome na se√ß√£o Brain.';
        showArchMessage(msg, 'warn');
        try { speakWithActiveArch(msg); } catch {}
      } else {
        const msg = `Bem-vindo de volta, ${name}. UNO est√° ao seu lado.`;
        showArchMessage(msg, 'ok');
        try { speakWithActiveArch(msg); } catch {}
      }
    }

    /* Apply ripple */
    $$('button').forEach(addRipple);
    // Move the arqu√©tipos circle below the menu in the home view after initialization
    (function() {
      try {
        const home = document.getElementById('v-home');
        if (!home) return;
        const arch = home.querySelector('.arch-container');
        const cards = home.querySelector('.cards');
        // Se ambos existirem, garanta que as cartas apare√ßam depois do c√≠rculo de arqu√©tipos.
        if (arch && cards) {
          arch.insertAdjacentElement('afterend', cards);
        }
      } catch (e) {
        console.warn('Falha ao reposicionar arqu√©tipo:', e);
      }
    })();
    const obs = new MutationObserver((muts) => { muts.forEach(m => m.addedNodes && m.addedNodes.forEach(n => { if (n.nodeType === 1) { if (n.matches?.('button')) addRipple(n); n.querySelectorAll?.('button').forEach(addRipple); } })) });
    obs.observe(document.body, { childList: true, subtree: true });

    /* ===================== Navega√ß√£o + Estado ===================== */
    function nav(key) {
      // Adicionamos 'revo' √† lista de abas para suportar a nova se√ß√£o
      const tabs = ['home', 'apps', 'stack', 'brain', 'revo'];
      tabs.forEach(k => { $('#v-' + k).classList.toggle('active', k === key); $(`.tab[data-nav="${k}"]`).classList.toggle('active', k === key); });
      LS.set('uno:lastTab', key);
      // Quando entrar na aba Home, apresente mensagem de sauda√ß√£o / √∫ltima sess√£o
      if (key === 'home') {
        try { displayGreeting(); } catch (e) { console.warn(e); }
        try {
          const nameG = (localStorage.getItem('infodose:userName') || '').trim();
          if (!nameG) {
            toast('Salve! Ative sua Dual‚ÄØInfodose registrando seu nome na se√ß√£o Brain.', 'warn');
          } else {
            // Sauda√ß√£o r√°pida na forma de toast quando o usu√°rio retorna ao home.
            toast(`Bem-vindo de volta, ${nameG}. UNO est√° ao seu lado.`, 'ok');
          }
        } catch (e) {}
        // Atualize tamb√©m os status quando entrar no Home
        try { updateHomeStatus(); } catch {}
      }
      // Quando entrar na aba Revo, envie a lista de apps ao iframe via postMessage
      if (key === 'revo') {
        try {
          const apps = RAW && Array.isArray(RAW.apps) ? RAW.apps : [];
          const iframe = document.getElementById('revoEmbed');
          if (iframe) {
            // If iframe already loaded, send immediately
            const send = () => {
              if (iframe.contentWindow) {
                iframe.contentWindow.postMessage({ type: 'apps', apps }, '*');
              }
            };
            // Always send a message after a tiny delay in case the frame is still initializing
            setTimeout(send, 100);
            // Also send again once the iframe loads
            iframe.removeEventListener('load', iframe._sendApps);
            iframe._sendApps = send;
            iframe.addEventListener('load', send, { once: true });
          }
        } catch(e) {
          console.warn('Falha ao enviar apps ao Revo:', e);
        }
      }

      // Falar uma frase curta ao trocar de aba, usando a voz do arqu√©tipo ativo
      try {
        let phrase = '';
        let type = 'info';
        switch (key) {
          case 'home': phrase = 'P√°gina inicial'; break;
          case 'apps': phrase = 'Abrindo apps'; break;
          case 'stack': phrase = 'Abrindo stack'; break;
          case 'brain': phrase = 'Abrindo usu√°rio'; break;
          case 'revo': phrase = 'Abrindo revo'; break;
          default: phrase = '';
        }
        if (phrase) {
          speakWithActiveArch(phrase);
          showArchMessage(phrase, type);
        }
      } catch (e) {}
    }

    // Alterna a visibilidade do menu de arqu√©tipos.  O menu fica
    // escondido/mostrado ao clicar no c√≠rculo (toque curto).  Este
    // helper √© chamado por initAudioRipple().
    function toggleArchMenu() {
      const menu = document.getElementById('archMenu');
      if (!menu) return;
      menu.classList.toggle('show');
    }

    /**
     * Inicia a intera√ß√£o Dual ao tocar a bolinha.  Esta fun√ß√£o aplica uma
     * anima√ß√£o breve de press√£o √† bolinha, fala a sauda√ß√£o ‚ÄúOi DUAL‚Äù (ou
     * outra frase definida) usando a voz do arqu√©tipo ativo e, em seguida,
     * verifica se o usu√°rio est√° conectado (nome, chave do OpenRouter e
     * modelo selecionados).  Caso esteja tudo configurado, ativa o
     * reconhecimento de voz para captar a fala do usu√°rio e prosseguir
     * com a conversa.  Caso contr√°rio, exibe uma mensagem orientando o
     * usu√°rio a preencher suas configura√ß√µes no Brain.
     */
    function startDualInteraction() {
      const archCircle = document.querySelector('.arch-circle');
      if (!archCircle) return;
      // Anima√ß√£o de clique: adiciona classe 'pressed' brevemente
      archCircle.classList.add('pressed');
      setTimeout(() => archCircle.classList.remove('pressed'), 180);
      // Sauda√ß√£o falada
      const greet = 'Oi Dual';
      showArchMessage(greet, 'ok');
      try { speakWithActiveArch(greet); } catch {}
      // Ap√≥s a sauda√ß√£o, aguarde um curto intervalo antes de iniciar a verifica√ß√£o
      setTimeout(() => {
        const sk = localStorage.getItem('dual.keys.openrouter') || '';
        const userName = (localStorage.getItem('infodose:userName') || '').trim();
        const model = LS.get('dual.openrouter.model');
        if (!sk || !userName || !model) {
          const warn = 'Configure nome, chave e modelo no Brain para conversar.';
          showArchMessage(warn, 'warn');
          return;
        }
        // Se estiver tudo configurado, inicie o reconhecimento de voz
        startSpeechConversation(userName, sk, model);
      }, 600);
    }

    /**
     * Inicia o reconhecimento de fala via Web Speech API.  Quando o usu√°rio
     * terminar de falar, a transcri√ß√£o √© encaminhada para a fun√ß√£o de
     * manipula√ß√£o de mensagens, que enviar√° a pergunta ao modelo de IA e
     * lidar√° com a resposta.
     * @param {string} userName Nome do usu√°rio (para personalizar respostas)
     * @param {string} sk Chave da API do OpenRouter
     * @param {string} model Modelo selecionado
     */

    // Insere mensagens no feed de IA da Home. Mant√©m somente as √∫ltimas 10 entradas.
    function feedPush(type, text) {
      const box = document.getElementById('iaFeed');
      if (!box) return;
      const div = document.createElement('div');
      div.className = 'msg ' + (type || 'status');
      div.textContent = text;
      box.appendChild(div);
      // Limita o n√∫mero de mensagens exibidas
      const msgs = box.querySelectorAll('.msg');
      const limit = 10;
      if (msgs.length > limit) {
        box.removeChild(msgs[0]);
      }
      box.scrollTop = box.scrollHeight;
    }
    function startSpeechConversation(userName, sk, model) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        showArchMessage('Reconhecimento de fala n√£o suportado neste navegador.', 'err');
        return;
      }
      const recognition = new SpeechRecognition();
      recognition.lang = 'pt-BR';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.onstart = () => {
        showArchMessage('Estou ouvindo‚Ä¶', 'ok');
        feedPush('status', 'üéôÔ∏è Ouvindo‚Ä¶');
      };
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.trim();
        if (transcript) {
          feedPush('user', 'Voc√™: ' + transcript);
          showArchMessage('Pulso enviado. Recebendo inten√ß√£o‚Ä¶', 'ok');
          feedPush('status', '‚ö° Pulso enviado ¬∑ recebendo inten√ß√£o‚Ä¶');
          handleUserMessage(transcript, userName, sk, model);
        }
      };
      recognition.onerror = (e) => {
        console.error('Erro no reconhecimento de fala:', e);
        showArchMessage('Erro no reconhecimento de fala.', 'err');
        feedPush('status', '‚ùå Erro no reconhecimento de fala.');
      };
      recognition.start();
    }

    /**
     * Processa a mensagem falada pelo usu√°rio.  Exibe a transcri√ß√£o no
     * feedback, envia a mensagem ao modelo de IA via OpenRouter e, ao
     * receber a resposta, exibe e fala a resposta de volta.
     * @param {string} text Texto transcrito da fala do usu√°rio
     * @param {string} userName Nome do usu√°rio
     * @param {string} sk Chave OpenRouter
     * @param {string} model Modelo de IA
     */
    async function handleUserMessage(text, userName, sk, model) {
      // A mensagem do usu√°rio j√° foi adicionada ao feed no evento onresult do reconhecimento de fala
      // Monta prompt incluindo o nome do usu√°rio para personaliza√ß√£o
      const prompt = `${userName} disse: ${text}`;
      // Envia ao modelo de IA
      let reply = '';
      try {
        reply = await sendAIMessage(prompt, sk, model);
      } catch (err) {
        console.error('Falha ao consultar IA:', err);
        reply = 'Desculpe, n√£o consegui responder no momento.';
      }
      if (reply) {
        // Determine o arqu√©tipo ativo para prefixar as respostas no feed
        let archName = 'Dual';
        try {
          const select = document.getElementById('arch-select');
          let base = (select?.value || '').replace(/\.html$/i, '');
          archName = base.charAt(0).toUpperCase() + base.slice(1).toLowerCase();
        } catch (e) {}
        feedPush('ai', archName + ': ' + reply);
        showArchMessage(reply, 'ok');
        try { speakWithActiveArch(reply); } catch {}
      }
    }

    /**
     * Envia uma mensagem ao endpoint de chat do OpenRouter.  Esta fun√ß√£o
     * utiliza a API de chat completions para obter uma resposta do modelo
     * selecionado.  Caso n√£o seja poss√≠vel acessar a API (por exemplo,
     * se a aplica√ß√£o estiver offline), uma resposta de erro √© retornada.
     * @param {string} content Conte√∫do da mensagem/prompt
     * @param {string} sk Chave de API
     * @param {string} model Identificador do modelo
     * @returns {Promise<string>} Resposta do modelo
     */
    async function sendAIMessage(content, sk, model) {
      // Estrutura de payload conforme especifica√ß√£o do OpenRouter
      const payload = {
        model: model,
        messages: [
          { role: 'system', content: 'Voc√™ √© um assistente amistoso que responde em portugu√™s.' },
          { role: 'user', content: content }
        ],
        max_tokens: 200,
        temperature: 0.7
      };
      const url = 'https://openrouter.ai/api/v1/chat/completions';
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${sk}`
        },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        throw new Error('Erro na API: ' + res.status);
      }
      const data = await res.json();
      const reply = data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content;
      return reply || '';
    }

    // Delegue cliques dentro do menu para a fun√ß√£o de navega√ß√£o.
    document.addEventListener('DOMContentLoaded', () => {
      const menu = document.getElementById('archMenu');
      if (menu) {
      menu.addEventListener('click', (e) => {
        // Primeiro verifique se o bot√£o de √°udio foi clicado
        const audioBtn = e.target.closest('button[data-audio]');
        if (audioBtn) {
          // Alterna modo √°udio usando a fun√ß√£o global
          if (typeof toggleAudio === 'function') {
            toggleAudio();
          }
          // Atualize o estado visual do bot√£o
          const archCircle = document.querySelector('.arch-circle');
          if (archCircle) {
            audioBtn.classList.toggle('on', archCircle.classList.contains('audio-on'));
          }
          // N√£o feche o menu ao alternar √°udio
          return;
        }
        // Caso contr√°rio, delegue a navega√ß√£o para bot√µes com data-nav
        const btn = e.target.closest('button[data-nav]');
        if (btn) {
          nav(btn.getAttribute('data-nav'));
          menu.classList.remove('show');
        }
      });
      }
    });

    // Helper: se a aba Revo estiver ativa, envia a lista atual de apps ao iframe.  
    function maybeSendAppsToRevo() {
      try {
        // S√≥ envie se a aba Revo estiver vis√≠vel
        const view = document.getElementById('v-revo');
        if (!view || !view.classList.contains('active')) return;
        const iframe = document.getElementById('revoEmbed');
        const apps = RAW && Array.isArray(RAW.apps) ? RAW.apps : [];
        if (iframe && iframe.contentWindow) {
          iframe.contentWindow.postMessage({ type: 'apps', apps }, '*');
        }
      } catch (e) {
        console.warn('Falha ao enviar apps ao Revo (maybe):', e);
      }
    }
    $$('.tab,[data-nav]').forEach(b => b.addEventListener('click', () => nav(b.dataset.nav || 'home')));
    $('#btnBack').onclick = () => { try { history.length > 1 && history.back() } catch { } };
    $('#btnBrain').onclick = () => nav('brain');

    // Restaurar √∫ltima aba
    const last = LS.get('uno:lastTab', 'home');
    nav(last);
    // Se a aba inicial for home, exibir sauda√ß√£o
    if (last === 'home') {
      try { displayGreeting(); } catch(e) {}
    }

    // Atalhos
    let gPressed = false;
    window.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') { e.preventDefault(); downloadSelf(); return; }
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') { e.preventDefault(); $('#appSearch')?.focus(); return; }
      if (e.key.toLowerCase() === 'g') { gPressed = true; setTimeout(() => gPressed = false, 600); return; }
      if (!gPressed) return; const k = e.key.toLowerCase();
      if (k === 'h') nav('home'); if (k === 'a') nav('apps'); if (k === 's') nav('stack'); if (k === 'b') nav('brain'); if (k === 'r') nav('revo'); gPressed = false;
    });

    // Ajuda modal
    const modalHelp = $('#modalHelp');
    $('#btnHelp').onclick = () => { modalHelp.classList.add('open'); modalHelp.setAttribute('aria-hidden', 'false'); };
    $('#closeHelp').onclick = () => { modalHelp.classList.remove('open'); modalHelp.setAttribute('aria-hidden', 'true'); };
    modalHelp.addEventListener('click', (e) => { if (e.target === modalHelp) $('#closeHelp').click(); });

    // Baixar HTML
    function downloadSelf() {
      try {
        const clone = document.documentElement.cloneNode(true);
        const html = '<!doctype html>\n' + clone.outerHTML;
        const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'HUB-UNO-Revo.html'; a.click(); setTimeout(() => URL.revokeObjectURL(a.href), 500);
        toast('HTML exportado', 'ok');
      } catch (e) { alert('Falha ao exportar: ' + e.message); }
    }
    $('#btnDownload').onclick = downloadSelf;

    /* ===================== Brain ===================== */
    const MODELS = ['openrouter/auto','anthropic/claude-3.5-sonnet','openai/gpt-4.1-mini','google/gemini-1.5-pro','meta/llama-3.1-405b-instruct','mistral/mistral-large-latest'];
    (function initBrain() {
      const sel = $('#model'); sel.innerHTML = ''; MODELS.forEach(m => { const o = document.createElement('option'); o.value = m; o.textContent = m; sel.appendChild(o) });
      sel.value = LS.get('dual.openrouter.model', MODELS[0]);
      $('#sk').value = LS.raw('dual.keys.openrouter');
      $('#saveSK').onclick = () => { LS.set('dual.openrouter.model', sel.value); localStorage.setItem('dual.keys.openrouter', $('#sk').value || ''); toast('Configura√ß√µes salvas', 'ok'); };
      $('#saveName').onclick = () => {
        localStorage.setItem('infodose:userName', ($('#userName').value || '').trim());
        toast('Nome salvo', 'ok');
        try { displayGreeting(); } catch (e) {}
        try { updateHomeStatus(); } catch {}
      };
    })();

    /* ===================== Inicializa√ß√£o do tema & personaliza√ß√£o de fundo ===================== */
    (function initThemeSettings() {
      // Se o usu√°rio nunca selecionou um tema antes, defina o padr√£o como "medium" (cinza).
      if (!LS.get('uno:theme')) {
        LS.set('uno:theme', 'medium');
      }
      // Aplique o tema salvo imediatamente
      applyTheme();
      // Configure o seletor de tema
      const sel = document.getElementById('themeSelect');
      if (sel) {
        sel.value = LS.get('uno:theme', 'medium');
        sel.addEventListener('change', () => {
          LS.set('uno:theme', sel.value);
          applyTheme();
          toast('Tema atualizado', 'ok');
          try { updateHomeStatus(); } catch {}
        });
      }
      const upload = document.getElementById('bgUpload');
      if (upload) {
        upload.addEventListener('change', (e) => {
          const f = e.target.files && e.target.files[0];
          if (!f) return;
          const reader = new FileReader();
          reader.onload = () => {
            try {
              LS.set('uno:bg', reader.result);
              LS.set('uno:theme', 'custom');
              if (sel) sel.value = 'custom';
              applyTheme();
              toast('Fundo personalizado salvo', 'ok');
              try { updateHomeStatus(); } catch {}
            } catch (err) { console.error(err); toast('Erro ao salvar fundo', 'err'); }
          };
          reader.readAsDataURL(f);
        });
      }
    })();

    /* ===================== √çcones inline (data SVG) ===================== */
    function svgIcon(name){
      const common = 'xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%23f5f7ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"';
      const m = {
        atlas: `<svg ${common}><circle cx="12" cy="12" r="9"/><path d="M3 12h18M12 3v18"/><path d="M5 8c3 2 11 2 14 0M5 16c3-2 11-2 14 0"/></svg>`,
        nova: `<svg ${common}><path d="M12 2v4M12 18v4M2 12h4M18 12h4"/><path d="M5.6 5.6l2.8 2.8M15.6 15.6l2.8 2.8M18.4 5.6l-2.8 2.8M8.4 15.6l-2.8 2.8"/><circle cx="12" cy="12" r="3"/></svg>`,
        vitalis:`<svg ${common}><path d="M3 12h4l2-5 4 10 2-5h6"/><path d="M13 3l-2 4 3 1-2 4"/></svg>`,
        pulse: `<svg ${common}><path d="M2 12h3l2-4 3 8 2-4h8"/><path d="M20 8v-3M20 19v-3"/></svg>`,
        artemis:`<svg ${common}><path d="M3 12h12"/><path d="M13 6l6 6-6 6"/><circle cx="12" cy="12" r="9"/></svg>`,
        serena:`<svg ${common}><path d="M12 21s-6-3.5-6-8a4 4 0 0 1 6-3 4 4 0 0 1 6 3c0 4.5-6 8-6 8z"/></svg>`,
        kaos:  `<svg ${common}><path d="M4 4l7 7-7 7"/><path d="M20 4l-7 7 7 7"/></svg>`,
        genus: `<svg ${common}><rect x="7" y="7" width="10" height="10" rx="2"/><path d="M7 7l5-3 5 3M17 17l-5 3-5-3"/></svg>`,
        lumine:`<svg ${common}><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M2 12h2M20 12h2M4.9 4.9l1.4 1.4M17.7 17.7l1.4 1.4M4.9 19.1l1.4-1.4M17.7 6.3l1.4-1.4"/></svg>`,
        rhea:  `<svg ${common}><path d="M12 3v6"/><circle cx="12" cy="9" r="4"/><path d="M12 13v2l-2 2M12 15l2 2M12 17v3"/></svg>`,
        solus: `<svg ${common}><path d="M12 3v6M12 15v6"/><circle cx="12" cy="12" r="3"/><path d="M19 5l-3 3M5 19l3-3M5 5l3 3M19 19l-3-3"/></svg>`,
        aion:  `<svg ${common}><path d="M7 12c0-2.2 1.8-4 4-4 1.2 0 2.3.5 3 1.3M17 12c0 2.2-1.8 4-4 4-1.2 0-2.3-.5-3-1.3"/><path d="M3 12h4M17 12h4"/></svg>`,
        // Extra icons provided by the user. These are approximations of the requested
        // assets (e.g. audio.svg, bolt.svg, etc.) using simple line art. They
        // maintain the same stroke characteristics as the existing icons. To use
        // them elsewhere in the UI, call svgIcon('audio'), svgIcon('bolt'), etc.
        audio: `<svg ${common}><polygon points="3,9 8,9 12,5 12,19 8,15 3,15"/><path d="M15 9c1.5 1.5 1.5 4 0 5"/><path d="M17 7c3 3 3 7 0 10"/></svg>`,
        bolt: `<svg ${common}><path d="M13 3L4 14h7l-2 7 9-11h-7l3-7z"/></svg>`,
        download: `<svg ${common}><path d="M12 3v12"/><path d="M6 9l6 6 6-6"/><path d="M5 19h14"/></svg>`,
        grid: `<svg ${common}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>`,
        home: `<svg ${common}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2h-14a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
        json: `<svg ${common}><path d="M7 4c-2 0-2 2-2 4v8c0 2 0 4 2 4"/><path d="M17 4c2 0 2 2 2 4v8c0 2 0 4-2 4"/></svg>`,
        'logo-capsule': `<svg ${common}><rect x="4" y="7" width="16" height="10" rx="5"/><path d="M12 7v10"/></svg>`,
        'logo-seed-split': `<svg ${common}><path d="M12 12c0-4 4-8 8-8v8c0 4-4 8-8 8v-8z"/><path d="M12 12c0-4-4-8-8-8v8c0 4 4 8 8 8v-8z"/></svg>`,
        pause: `<svg ${common}><rect x="6" y="4" width="3" height="16"/><rect x="15" y="4" width="3" height="16"/></svg>`,
        play: `<svg ${common}><polygon points="6,4 20,12 6,20"/></svg>`,
        upload: `<svg ${common}><path d="M12 21V9"/><path d="M6 15l6-6 6 6"/><path d="M5 5h14"/></svg>`,
        user: `<svg ${common}><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 4-8 8-8s8 4 8 8"/></svg>`,
        sprites: `<svg ${common}></svg>`
      };
      const raw = m[name] || m['atlas'];
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(raw);
    }

    /* ===================== Apps (embutido + locais) ===================== */
    const RAW = { apps: [] };

    // Controle para exibir apenas apps locais ou todos
    let showOnlyLocal = false;
    // Lista de apps favoritados (por chave). Carregada do localStorage
    let favoriteKeys = [];
    try { favoriteKeys = JSON.parse(localStorage.getItem('infodose:favApps') || '[]') || []; } catch { favoriteKeys = []; }

    /**
     * Alterna um app na lista de favoritos. Salva no localStorage e re-renderiza.
     * @param {string} key
     */
    function toggleFav(key) {
      const idx = favoriteKeys.indexOf(key);
      if (idx >= 0) {
        favoriteKeys.splice(idx, 1);
      } else {
        favoriteKeys.push(key);
      }
      localStorage.setItem('infodose:favApps', JSON.stringify(favoriteKeys));
      renderApps();
    }
    /** Verifica se um app est√° favoritado. */
    function isFav(key) {
      return favoriteKeys.includes(key);
    }
    const appsWrap = $('#appsWrap'), appsCount = $('#appsCount');

    function normalize(list) {
      return (list || []).map(x => ({
        key: x.key || x.url || x.title || Math.random().toString(36).slice(2),
        title: x.title || x.key || 'App',
        desc: x.desc || '',
        url: String(x.url || ''),
        icon: x.icon || '',
        tags: Array.isArray(x.tags) ? x.tags : []
      }))
    }
    function locals() {
      let arr = []; try { arr = JSON.parse(LS.raw('infodose:locals:v1') || '[]') } catch {}
      return arr.map(l => ({ key: 'local:' + l.id, title: l.name || 'Local', desc: 'HTML local', url: 'local:' + l.id, icon: 'local', tags: ['local'] }))
    }
    function getLocal(id) {
      let arr = []; try { arr = JSON.parse(LS.raw('infodose:locals:v1') || '[]') } catch {}
      return arr.find(x => x.id === id) || null
    }
    function blobURL(local) { const blob = new Blob([local.html || ''], { type: 'text/html;charset=utf-8' }); return URL.createObjectURL(blob) }

    /**
     * Atualiza os cart√µes de status na Home com informa√ß√µes atuais sobre apps, sess√µes,
     * prefer√™ncias do usu√°rio e arqu√©tipo ativo. Chamado sempre que o
     * cat√°logo muda, quando sess√µes s√£o abertas/fechadas, quando
     * configura√ß√µes s√£o salvas ou ao navegar para o Home.
     */
    function updateHomeStatus() {
      try {
        // Apps: n√∫mero total ou locais se estiver filtrando
        const total = normalize(RAW.apps).concat(locals()).length;
        const localCount = locals().length;
        const txtApps = showOnlyLocal ? (localCount + ' local' + (localCount === 1 ? '' : 's')) : (total + ' app' + (total === 1 ? '' : 's'));
        const elApps = document.getElementById('homeAppsStatus');
        if (elApps) elApps.textContent = txtApps;
      } catch (e) {}
      try {
        // Sess√µes abertas (Stack)
        const sess = document.querySelectorAll('#stackWrap .session').length;
        const txtSess = sess + ' sess√£o' + (sess === 1 ? '' : 's');
        const elStack = document.getElementById('homeStackStatus');
        if (elStack) elStack.textContent = txtSess;
      } catch (e) {}
      try {
        // Usu√°rio: nome + tema atual (mapa)
        const name = (localStorage.getItem('infodose:userName') || '').trim();
        const theme = LS.get('uno:theme', 'medium');
        const themeLabel = { 'default': 'padr√£o', 'medium': 'cinza', 'custom': 'personalizado' }[theme] || theme;
        let txtUser = name || 'Usu√°rio';
        txtUser += ' ¬∑ ' + themeLabel;
        const elUser = document.getElementById('homeUserStatus');
        if (elUser) elUser.textContent = txtUser;
      } catch (e) {}
      try {
        // Arqu√©tipo ativo: obt√©m o nome sem extens√£o
        const sel = document.getElementById('arch-select');
        let archName = '';
        if (sel && sel.options.length > 0) {
          const opt = sel.options[sel.selectedIndex] || null;
          if (opt) archName = opt.textContent.replace(/\.html$/i, '');
        }
        const elArch = document.getElementById('homeArchStatus');
        if (elArch) elArch.textContent = archName || 'Nenhum';
      } catch (e) {}
    }

    function appIconFor(a){
      if(!a.icon) return svgIcon('atlas');
      if(/^(atlas|nova|vitalis|pulse|artemis|serena|kaos|genus|lumine|rhea|solus|aion|local)$/.test(a.icon)) return svgIcon(a.icon);
      return a.icon; // caminho externo
    }

    function cardApp(a) {
      const el = document.createElement('div'); el.className = 'app-card fx-trans fx-lift';
      // Bot√£o de favorito (estrela). Aparece no canto superior direito
      const fav = document.createElement('button'); fav.className = 'fav-btn';
      const favImg = document.createElement('img');
      favImg.alt = 'Favorito';
      // Use √≠cone local para favorito; evita depender de CDN
      favImg.src = 'icons/star.svg';
      fav.appendChild(favImg);
      // Marque como favoritado se a chave estiver na lista
      if (isFav(a.key)) fav.classList.add('fav');
      fav.onclick = (e) => { e.stopPropagation(); toggleFav(a.key); };
      el.appendChild(fav);
      const ic = document.createElement('div'); ic.className = 'app-icon';
      const img = document.createElement('img'); img.alt = ''; img.width = 24; img.height = 24; img.src = appIconFor(a); ic.appendChild(img);
      const meta = document.createElement('div'); meta.style.flex = '1';
      // Truncar o t√≠tulo para exibir apenas as tr√™s primeiras palavras; adicionar retic√™ncias quando houver mais.
      const fullTitle = String(a.title || a.key || '').trim();
      const words = fullTitle.split(/\s+/);
      const truncated = words.slice(0, 3).join(' ');
      const displayTitle = words.length > 3 ? truncated + '‚Ä¶' : truncated;
      const t = document.createElement('div');
      t.className = 'app-title';
      t.textContent = displayTitle || fullTitle;
      // O t√≠tulo completo fica como tooltip para acesso total via hover
      t.title = fullTitle;
      const d = document.createElement('div'); d.className = 'mut'; d.textContent = a.desc || a.url;
      const open = document.createElement('button'); open.className = 'btn fx-trans fx-press ring'; open.textContent = 'Abrir';
      const rip = document.createElement('span'); rip.className = 'ripple'; open.appendChild(rip); addRipple(open);
      open.onclick = () => openApp(a);
      meta.appendChild(t); meta.appendChild(d); meta.appendChild(open);
      el.appendChild(ic); el.appendChild(meta);
      return el
    }

    function renderApps() {
      // Busque valores de busca e ordena√ß√£o apenas se os campos existirem (evita erros se ocultos)
      const searchEl = document.getElementById('appSearch');
      const sortEl = document.getElementById('appSort');
      const q = searchEl ? (searchEl.value || '').toLowerCase() : '';
      const mode = sortEl ? sortEl.value : 'az';
      // Combine apps embutidos e locais
      let L = normalize(RAW.apps).concat(locals());
      // Filtrar apenas locais se ativado
      if (showOnlyLocal) {
        L = L.filter(a => String(a.url || '').startsWith('local:'));
      }
      // Aplicar busca (mantendo compatibilidade se o usu√°rio ainda possuir o campo)
      if (q) {
        L = L.filter(a => (a.title + ' ' + a.desc + ' ' + a.key + ' ' + a.url + ' ' + (a.tags || []).join(' ')).toLowerCase().includes(q));
      }
      // Ordenar: favoritos primeiro, depois t√≠tulo A-Z ou Z-A conforme o select (padr√£o A-Z)
      L.sort((a, b) => {
        const favA = isFav(a.key); const favB = isFav(b.key);
        if (favA !== favB) return favB - favA; // true=1, false=0 => favoritos no topo
        const dir = mode === 'za' ? -1 : 1;
        return dir * String(a.title || '').localeCompare(b.title || '');
      });
      appsWrap.innerHTML = '';
      L.forEach(a => {
        const card = cardApp(a);
        appsWrap.appendChild(card);
      });
      appsCount.textContent = L.length + ' apps';
      // Reaplicar √≠cones ap√≥s adicionar novos cards (garante que as estrelas e √≠cones de apps carreguem)
      try { applyIcons(); } catch {}
      // Notifique o Revo de que os apps mudaram, se estiver ativo
      maybeSendAppsToRevo();
      // Atualize o painel de status na home com o novo n√∫mero de apps
      try { updateHomeStatus(); } catch {}
    }

    (function loadEmbeddedApps(){
      try {
        const raw = JSON.parse($('#APPS_JSON').textContent || '{}');
        RAW.apps = Array.isArray(raw.apps) ? raw.apps : (Array.isArray(raw) ? raw : []);
      } catch { RAW.apps = [] }
      renderApps();
      // Sempre envie o cat√°logo atualizado ao iframe do Revo ap√≥s carregar os apps embutidos.
      try {
        const iframe = document.getElementById('revoEmbed');
        if (iframe) {
          const apps = RAW && Array.isArray(RAW.apps) ? RAW.apps : [];
          const send = () => { if (iframe.contentWindow) iframe.contentWindow.postMessage({ type: 'apps', apps }, '*'); };
          // Envie ap√≥s pequeno atraso para garantir que o iframe esteja pronto
          setTimeout(send, 100);
          // E tamb√©m quando o iframe terminar de carregar
          iframe.removeEventListener('load', iframe._sendAppsEmbedded);
          iframe._sendAppsEmbedded = send;
          iframe.addEventListener('load', send, { once: true });
        }
      } catch(e) { console.warn('Falha ao postMessage apps ap√≥s embed:', e); }
    })();

    // Locais
    $('#btnImport').onclick = async () => {
      const fs = Array.from($('#fileLocal').files || []);
      if (!fs.length) return;
      const tasks = fs.map(f => new Promise(res => {
        const r = new FileReader();
        r.onload = () => {
          const content = String(r.result || '');
          // Se for um arquivo JSON, tente carreg√°-lo como cat√°logo de apps
          if (/\.json$/i.test(f.name)) {
            try {
              const obj = JSON.parse(content);
              const apps = Array.isArray(obj.apps) ? obj.apps : (Array.isArray(obj) ? obj : []);
              // Substitua o cat√°logo embutido pelo JSON local e recarregue a lista
              RAW.apps = apps;
              renderApps();
              toast('apps.json local carregado', 'ok');
            } catch (err) {
              console.error(err);
              toast('Erro ao ler apps.json', 'err');
            }
            // N√£o adicionar JSON √† lista de locais; retorne null
            res(null);
          } else {
            // Trate como HTML local
            res({ id: 'l_' + Math.random().toString(36).slice(2), name: f.name.replace(/\.(html?|txt)$/i, ''), html: content, ts: Date.now() });
          }
        };
        r.readAsText(f);
      }));
      const list = (await Promise.all(tasks)).filter(Boolean);
      const cur = JSON.parse(LS.raw('infodose:locals:v1') || '[]');
      list.forEach(x => cur.unshift(x));
      localStorage.setItem('infodose:locals:v1', JSON.stringify(cur));
      renderApps();
      if (list.length) toast('HTMLs locais adicionados', 'ok');
    };
    $('#btnExport').onclick = () => { const data = { v: 1, when: Date.now(), items: JSON.parse(LS.raw('infodose:locals:v1') || '[]') }; const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })); a.download = 'locals_pack.json'; a.click(); };
    $('#btnClear').onclick = () => { if (confirm('Limpar HTMLs locais salvos?')) { localStorage.removeItem('infodose:locals:v1'); renderApps(); toast('Locais limpos', 'warn'); } };

    // Alterna exibi√ß√£o de apps locais/apenas locais
    try {
      const btnToggleLocal = document.getElementById('btnToggleLocal');
      if (btnToggleLocal) {
        btnToggleLocal.onclick = () => {
          showOnlyLocal = !showOnlyLocal;
          // Atualize o texto do bot√£o conforme o modo
          btnToggleLocal.firstChild && (btnToggleLocal.firstChild.nodeValue = showOnlyLocal ? 'Mostrar Todos' : 'Mostrar Locais');
          renderApps();
        };
      }
    } catch (e) { console.warn('Falha ao associar btnToggleLocal:', e); }

    /* ===================== Stack ===================== */
    const stackWrap = $('#stackWrap'), dock = $('#dock');
    function badge(item) { const b = document.createElement('button'); b.className = 'badge fx-trans fx-press ring'; b.textContent = item.title || 'App'; b.title = 'Reabrir ' + (item.title || 'App'); const rp = document.createElement('span'); rp.className = 'ripple'; b.appendChild(rp); addRipple(b); b.onclick = () => { const s = document.querySelector('[data-sid="' + item.sid + '"]'); if (s) { s.scrollIntoView({ behavior: 'smooth' }); s.classList.remove('min'); } }; return b }
    function updateDock() {
      dock.innerHTML = '';
      $$('.session').forEach(s => {
        const meta = JSON.parse(s.dataset.meta || '{}');
        dock.appendChild(badge({ title: meta.title, sid: s.dataset.sid }))
      });
      // Atualize o status de sess√µes na home
      try { updateHomeStatus(); } catch {}
    }
    function openApp(a) {
      const sid = 's_' + Math.random().toString(36).slice(2);
      const isLocal = String(a.url || '').startsWith('local:'); const lr = isLocal ? getLocal(String(a.url).slice(6)) : null; const url = lr ? blobURL(lr) : a.url;
      const card = document.createElement('div'); card.className = 'session fx-trans fx-lift'; card.dataset.sid = sid; card.dataset.meta = JSON.stringify({ title: a.title || 'App', url: a.url || '' });
      card.innerHTML = `
        <div class="hdr">
          <div class="title">${(a.title || 'App')}</div>
          <div class="tools">
            <button class="btn ring fx-trans fx-press" data-act="min" title="Minimizar">
              <span style="font-size:16px;line-height:1">&minus;</span>
              <span class="ripple"></span>
            </button>
            <button class="btn ring fx-trans fx-press" data-act="ref" title="Recarregar">
              <span style="font-size:16px;line-height:1">&#8635;</span>
              <span class="ripple"></span>
            </button>
            <button class="btn ring fx-trans fx-press" data-act="close" title="Fechar">
              <span style="font-size:16px;line-height:1">&times;</span>
              <span class="ripple"></span>
            </button>
          </div>
        </div>
        <iframe src="${url || 'about:blank'}" allow="autoplay; clipboard-read; clipboard-write; picture-in-picture; fullscreen"></iframe>`;
      // Prepend the session card dependendo do modo de abertura. Se "abrir dentro" estiver marcado,
      // insira a sess√£o no topo da p√°gina (sessionsAnchor); caso contr√°rio, use o stackWrap padr√£o.
      const anchor = document.getElementById('sessionsAnchor');
      if ($('#openInside').checked && anchor) {
        anchor.prepend(card);
      } else {
        stackWrap.prepend(card);
      }
      // N√£o chamar applyIcons aqui: √≠cones embutidos manualmente nos bot√µes de sess√£o
      card.querySelector('[data-act=min]').onclick = () => {
        card.classList.toggle('min');
        updateDock();
        dualLog('Sess√£o minimizada: ' + (a.title || 'App'));
      };
      card.querySelector('[data-act=ref]').onclick = () => { const fr = card.querySelector('iframe'); try { fr.contentWindow.location.reload() } catch { fr.src = fr.src } };
      card.querySelector('[data-act=close]').onclick = () => {
        card.remove();
        updateDock();
        dualLog('Sess√£o fechada: ' + (a.title || 'App'));
      };
      // Navegue para a view Stack apenas quando n√£o estiver abrindo dentro da p√°gina.
      if (!$('#openInside').checked) nav('stack');
      updateDock();
      toast('App aberto: ' + (a.title || 'App'), 'ok');
      dualLog('Sess√£o aberta: ' + (a.title || 'App'));
    }
    $('#btnCloseAll').onclick = () => { if (!confirm('Fechar todas as sess√µes abertas?')) return; $$('.session').forEach(s => s.remove()); updateDock(); toast('Todas as sess√µes fechadas', 'warn'); };

    /* ===================== Archetypes (Central Circle) ===================== */
    (function () {
      const archList = [
        'luxara.html',
        'rhea.html',
        'aion.html',
        'atlas.html',
        'nova.html',
        'genus.html',
        'lumine.html',
        'kaion.html',
        'kaos.html',
        'horus.html',
        'elysha.html'
      ];
      const select = document.getElementById('arch-select');
      const frame = document.getElementById('arch-frame');
      const fade = document.getElementById('arch-fadeCover');
      function populate() {
        select.innerHTML = '';
        archList.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          select.appendChild(opt);
        });
      }
      function setSrcByIndex(idx) {
        if (!archList.length) return;
        const n = (idx + archList.length) % archList.length;
        select.selectedIndex = n;
        const file = archList[n];
        frame.src = './archetypes/' + file;
        // Pronuncia o nome do arqu√©tipo sempre que for selecionado
        try {
          const base = file.replace(/\.html$/i, '');
          speakArchetype(base);
        } catch (e) {}
        // Atualiza as informa√ß√µes da Home (cart√µes) quando o arqu√©tipo muda
        try {
          updateHomeStatus();
        } catch (e) {}
      }
      let current = 0;
      populate();
      if (archList.length) setSrcByIndex(0);
      document.getElementById('arch-prev').addEventListener('click', () => {
        current = (current - 1 + archList.length) % archList.length;
        fade.classList.add('show');
        setTimeout(() => {
          setSrcByIndex(current);
          setTimeout(() => fade.classList.remove('show'), 200);
        }, 140);
      });
      document.getElementById('arch-next').addEventListener('click', () => {
        current = (current + 1) % archList.length;
        fade.classList.add('show');
        setTimeout(() => {
          setSrcByIndex(current);
          setTimeout(() => fade.classList.remove('show'), 200);
        }, 140);
      });
      select.addEventListener('change', () => {
        current = select.selectedIndex;
        fade.classList.add('show');
        setTimeout(() => {
          setSrcByIndex(current);
          setTimeout(() => fade.classList.remove('show'), 200);
        }, 140);
      });
    })();

    /* ===================== Custom CSS & Voices: Event Handlers ===================== */
    // Aplicar CSS personalizado salvo no carregamento inicial
    try { applyCSS(); } catch (e) {}
    // Inicializar vozes na aba Brain
    try { initVoices(); } catch (e) {}
    // Inicializar ripple de √°udio (modo que responde ao microfone)
    try { initAudioRipple(); } catch (e) {}
    // Exibir sauda√ß√£o inicial se aplic√°vel
    try { welcome(); } catch (e) {}
    // Conectar bot√µes de CSS personalizado
    const btnApplyCSS = document.getElementById('applyCSS');
    const btnClearCSS = document.getElementById('clearCSS');
    const btnDownloadCSS = document.getElementById('downloadCSS');
    if (btnApplyCSS) {
      btnApplyCSS.addEventListener('click', () => {
        const textarea = document.getElementById('cssCustom');
        const css = (textarea && textarea.value || '').trim();
        localStorage.setItem('infodose:cssCustom', css);
        applyCSS();
        toast('CSS aplicado', 'ok');
      });
    }
    if (btnClearCSS) {
      btnClearCSS.addEventListener('click', () => {
        localStorage.removeItem('infodose:cssCustom');
        const textarea = document.getElementById('cssCustom');
        if (textarea) textarea.value = '';
        applyCSS();
        toast('CSS removido', 'warn');
      });
    }
    if (btnDownloadCSS) {
      btnDownloadCSS.addEventListener('click', () => {
        const css = localStorage.getItem('infodose:cssCustom') || '';
        const blob = new Blob([css], { type: 'text/css' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'custom.css';
        a.click();
        setTimeout(() => URL.revokeObjectURL(a.href), 500);
      });
    }

    /* ===================== Init ===================== */
    // Inicialize prefer√™ncias de performance e voz e associe bot√µes no Brain
    (function initDualPrefs(){
      const perfSel = document.getElementById('selPerf');
      const voiceSel = document.getElementById('selVoice');
      if (perfSel) perfSel.value = dualState.perf;
      if (voiceSel) voiceSel.value = dualState.voice;
      const perfBtn = document.getElementById('btnPerf');
      const voiceBtn = document.getElementById('btnVoice');
      if (perfBtn && perfSel) {
        perfBtn.addEventListener('click', () => {
          dualState.perf = perfSel.value;
          localStorage.setItem('hub.perf', dualState.perf);
          dualLog('Performance atualizada: ' + dualState.perf);
          toast('Performance atualizada', 'ok');
        });
      }
      if (voiceBtn && voiceSel) {
        voiceBtn.addEventListener('click', () => {
          dualState.voice = voiceSel.value;
          localStorage.setItem('hub.voice', dualState.voice);
          dualLog('Voz selecionada: ' + dualState.voice);
          toast('Voz atualizada', 'ok');
        });
      }
    })();
    $$('button').forEach(addRipple);
  
// === Dual adjustments: move feed to top ===
document.addEventListener('DOMContentLoaded', () => {
  try{
    const feed = document.getElementById('iaFeed');
    const archContainer = document.querySelector('#v-home .arch-container');
    if(feed && archContainer && archContainer.parentNode){
      archContainer.parentNode.insertBefore(feed, archContainer);
    }
  }catch(e){}
});

// === Dual Voices: mapping por arqu√©tipo com micro varia√ß√µes (pitch/rate) ===
const ARCH_GENDER = {
  "Atlas":"m","Kaion":"m","Kaos":"m","Horus":"m","Genus":"m","Aion":"m",
  "Nova":"f","Elysha":"f","Luxara":"f","Serena":"f","Rhea":"f","Artemis":"f"
};
function loadVoiceMap(){
  try{ return JSON.parse(localStorage.getItem('dual.voices.map'))||{} }catch(_){ return {} }
}
function saveVoiceMap(map){
  localStorage.setItem('dual.voices.map', JSON.stringify(map||{}));
}
function pickVoiceByGender(voices, gender){
  const langPref = v => /pt\-BR|Portugu[e√™]s/i.test(v.lang||v.name||'');
  const femHint = v => /(female|feminina|mulher)/i.test(v.name||'');
  const mascHint = v => /(male|masculina|homem)/i.test(v.name||'');
  const choose = (preds) => voices.find(v => preds.every(p=>p(v)));
  if(gender==='f'){
    return choose([langPref, femHint]) || choose([femHint]) || choose([langPref]) || voices[0];
  }else{
    return choose([langPref, mascHint]) || choose([mascHint]) || choose([langPref]) || voices[0];
  }
}
function microVarFor(name){
  // micro varia√ß√£o determin√≠stica por arqu√©tipo
  let h=0; for(const c of name) h=(h*31 + c.charCodeAt(0)) & 0xffffffff;
  const rnd = (seed)=>((seed%1000)/1000);
  const r = rnd(Math.abs(h));
  const pitch = 0.95 + (r*0.2); // 0.95..1.15
  const rate  = 0.96 + ((1-r)*0.18); // 0.96..1.14
  return {pitch: +pitch.toFixed(2), rate: +rate.toFixed(2)};
}
// Override speakWithActiveArch to use mapping if available
(function(){
  const _orig = window.speakWithActiveArch;
  window.speakWithActiveArch = function(text){
    const synth = window.speechSynthesis;
    if(!synth){ try{ _orig && _orig(text) }catch(_){}; return; }
    const voices = synth.getVoices();
    const select = document.getElementById('arch-select');
    let base = (select?.value||'').replace(/\.html$/i,'');
    const arch = base ? (base[0].toUpperCase()+base.slice(1).toLowerCase()) : 'Atlas';
    const map = loadVoiceMap();
    const conf = map[arch] || {};
    const u = new SpeechSynthesisUtterance(String(text||''));
    let v = voices.find(v=>v.name===conf.name) || pickVoiceByGender(voices, ARCH_GENDER[arch]||'m');
    u.voice = v;
    const mv = conf.pitch && conf.rate ? conf : microVarFor(arch);
    u.pitch = mv.pitch; u.rate = mv.rate;
    u.lang = (v && v.lang) || 'pt-BR';
    synth.speak(u);
  };
})();
// UI: construir painel por arqu√©tipo no #voicesWrap (se existir)
document.addEventListener('DOMContentLoaded', ()=>{
  const wrap = document.getElementById('voicesWrap');
  if(!wrap) return;
  const synth = window.speechSynthesis;
  function rebuild(){
    const voices = synth.getVoices();
    if(!voices || !voices.length){ setTimeout(rebuild, 200); return; }
    const map = loadVoiceMap();
    wrap.innerHTML = '';
    const ARCHS = Object.keys(ARCH_GENDER);
    ARCHS.forEach(arch=>{
      const row = document.createElement('div');
      row.style.display='grid'; row.style.gridTemplateColumns='120px 1fr auto'; row.style.gap='8px'; row.style.alignItems='center';
      const label = document.createElement('div'); label.textContent = arch; label.style.fontWeight='800';
      const sel = document.createElement('select'); sel.className='input ring'; sel.dataset.arch=arch;
      voices.forEach(v=>{
        const opt = document.createElement('option');
        opt.value = v.name; opt.textContent = `${v.name} (${v.lang})`;
        sel.appendChild(opt);
      });
      const save = document.createElement('button'); save.className='btn fx-trans fx-press ring'; save.textContent='Salvar';
      const test = document.createElement('button'); test.className='btn fx-trans fx-press ring'; test.style.marginLeft='6px'; test.textContent='Testar';
      const btnBox = document.createElement('div'); btnBox.appendChild(save); btnBox.appendChild(test);
      // defaults
      const conf = map[arch] || {};
      const defVoice = voices.find(v=>v.name===conf.name) || pickVoiceByGender(voices, ARCH_GENDER[arch]);
      sel.value = (defVoice && defVoice.name) || voices[0].name;
      row.appendChild(label); row.appendChild(sel); row.appendChild(btnBox);
      wrap.appendChild(row);
      save.onclick = ()=>{
        const m = loadVoiceMap();
        const mv = microVarFor(arch);
        m[arch] = { name: sel.value, pitch: (conf.pitch||mv.pitch), rate: (conf.rate||mv.rate) };
        saveVoiceMap(m);
        toast('Voz salva', 'ok');
      };
      test.onclick = ()=>{
        const m = loadVoiceMap();
        const mv = m[arch] || microVarFor(arch);
        const u = new SpeechSynthesisUtterance(`${arch} conectado. Teste de voz.`);
        u.voice = voices.find(v=>v.name===sel.value) || voices[0];
        u.pitch = mv.pitch; u.rate = mv.rate; u.lang = u.voice.lang || 'pt-BR';
        synth.speak(u);
      };
    });
  }
  rebuild();
  // Bot√£o global de atualizar lista
  const perfCard = document.getElementById('voicesWrap'); // reusar card
  const updateBtn = document.createElement('button');
  updateBtn.id='btnVoicesUpdate'; updateBtn.className='btn fx-trans fx-press ring';
  updateBtn.textContent='Atualizar Vozes';
  updateBtn.style.marginTop='6px';
  perfCard.parentNode.appendChild(updateBtn);
  updateBtn.onclick = ()=>{ window.speechSynthesis.onvoiceschanged = null; rebuild(); toast('Lista de vozes atualizada', 'ok'); };
  // re-popular quando o navegador carregar as vozes
  window.speechSynthesis.onvoiceschanged = rebuild;
});

// === Enriquecimento no feed (a√ß√µes, chips, links, code) ===
function feedPushDual(type, text){
  const box = document.getElementById('iaFeed');
  if(!box) return;
  const div = document.createElement('div');
  div.className = 'msg ' + (type||'ai');
  div.textContent = text;
  box.appendChild(div);
  // Limitar quantidade
  const msgs = box.querySelectorAll('.msg');
  const limit = 10; if (msgs.length>limit) box.removeChild(msgs[0]);
  // Tornar interativo
  div.classList.add('rich');
  dualEnrich(div);
  box.scrollTop = box.scrollHeight;
}
function sendMessageFromSuggestion(txt){
  if(!txt) return;
  // Reusar pipeline de voz ‚Üí IA
  const sk = localStorage.getItem('dual.keys.openrouter') || '';
  const userName = (localStorage.getItem('infodose:userName') || '').trim();
  const model = LS.get('dual.openrouter.model');
  feedPush('user','Voc√™: '+txt);
  handleUserMessage(txt, userName, sk, model);
}
// Html ‚Üí elementos interativos (simplificado)
function dualEnrich(node){
  const escapeHtml = s => String(s).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const attr = s => String(s).replace(/"/g,'&quot;');
  let raw = node.textContent||'';
  let html = escapeHtml(raw);
  // ( ... ) ‚Üí a√ß√£o
  html = html.replace(/\(([^()]+)\)/g, (m,inner)=>{
    const lab = inner.trim().replace(/\s*->\s*/g,' ‚Üí ');
    return `<button class="action" data-send="${attr(lab)}">${escapeHtml(lab)}</button>`;
  });
  // Emojis ‚Üí chip
  html = html.replace(/(\p{Emoji_Presentation}|\p{Extended_Pictographic}|[‚ö°‚≠ï‚ú¶‚òÜ‚òÖ‚úß‚ú©‚óÜ‚óá‚ñ∂Ô∏è‚óÄÔ∏è‚èØÔ∏è‚èµ‚è∏Ô∏è‚èπÔ∏èüéõÔ∏èüéöÔ∏èüéôÔ∏èüéßÔ∏èüéºÔ∏èüéπÔ∏èüóÇÔ∏èüìéüß©üî•üåô‚ú®üí°üíæüß™‚≠êÔ∏è])/gu,
    (m)=>`<span class="chip" data-send="${attr(m)}">${escapeHtml(m)}</span>`);
  // Links
  html = html.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, (m,label,url)=>`<button class="link" data-url="${attr(url)}">${escapeHtml(label)} ‚Üó</button>`);
  html = html.replace(/(https?:\/\/[^\s]+)/g, (m,url)=>`<button class="link" data-url="${attr(url)}">${escapeHtml(url)} ‚Üó</button>`);
  // Code fence
  html = html.replace(/```([a-z0-9_\-.+#]*)\n([\s\S]*?)```/gi, (m,lang,body)=>{
    return `<pre class="code"><button class="copy" data-code="${attr(body)}">Copiar</button><code data-lang="${attr(lang||'text')}">${escapeHtml(body)}</code><span class="lang">${escapeHtml(lang||'text')}</span></pre>`;
  });
  node.innerHTML = html;
  // binds
  node.querySelectorAll('.action,.chip').forEach(el=>el.addEventListener('click',()=>sendMessageFromSuggestion(el.getAttribute('data-send'))));
  node.querySelectorAll('.link').forEach(el=>el.addEventListener('click',()=>{ const url=el.getAttribute('data-url'); try{ window.open(url,'_blank') }catch(e){} }));
  node.querySelectorAll('.code .copy').forEach(btn=>btn.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(btn.getAttribute('data-code')||''); toast('C√≥digo copiado','ok') }catch(e){ toast('Falha ao copiar','err') } }));
  // highlight
  node.querySelectorAll('code[data-lang]').forEach(codeEl=>{
    try{ highlightCode(codeEl, codeEl.getAttribute('data-lang')||'text'); }catch(_){}
  });
}
</script>
  <script>
    /* ===================== CHAT CORE (ex-Revo) ===================== */
function chatPush(type, text){
  const box = document.getElementById('chatFeed'); if(!box) return;
  const div = document.createElement('div');
  div.className = type==='user' ? 'chat-msg user' : (type==='ai' ? 'chat-msg ai' : 'chat-status');
  div.textContent = text;
  box.appendChild(div);
  // limitar a 60 msgs
  const msgs = box.querySelectorAll('.chat-msg,.chat-status');
  if(msgs.length>60) box.removeChild(msgs[0]);
  box.scrollTop = box.scrollHeight;
}

async function chatSendText(raw){
  const text = String(raw||'').trim();
  if(!text) return;
  const sk = localStorage.getItem('dual.keys.openrouter') || '';
  const userName = (localStorage.getItem('infodose:userName') || '').trim();
  const model = LS.get('dual.openrouter.model');
  chatPush('user', 'Voc√™: ' + text);
  try{
    const reply = await sendAIMessage(`${userName ? userName+' disse: ' : ''}${text}`, sk, model);
    let arch = 'Dual';
    try{
      const sel = document.getElementById('arch-select');
      let base = (sel?.value||'').replace(/\.html$/i,'');
      arch = base ? (base[0].toUpperCase()+base.slice(1).toLowerCase()) : 'Dual';
    }catch(_){}
    chatPush('ai', `${arch}: ${reply||'...'}`);
    try{ speakWithActiveArch(reply) }catch(_){}
  }catch(e){
    console.error(e);
    chatPush('status','‚ùå Falha ao enviar.');
  }
}

// Wire chat input bar
(function initChatUI(){
  const input = document.getElementById('chatInput');
  const btnSend = document.getElementById('btnChatSend');
  if(btnSend && input){
    btnSend.onclick = ()=>{ const v = input.value; input.value=''; chatSendText(v); };
    input.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); btnSend.click(); }});
  }
})();

/* ===================== FLOATING BUTTONS (texto/voz) ===================== */
(function initFAB(){
  const modal = document.getElementById('modalChatInput');
  const ta = document.getElementById('modalText');
  const open = (txt='')=>{ if(ta) ta.value = txt; modal?.classList.add('open'); modal?.setAttribute('aria-hidden','false'); };
  const close = ()=>{ modal?.classList.remove('open'); modal?.setAttribute('aria-hidden','true'); };
  const send = ()=>{ const v = ta?.value||''; close(); chatSendText(v); };

  const fabText = document.getElementById('fabText');
  const fabVoice = document.getElementById('fabVoice');
  const btnSend = document.getElementById('btnModalSend');
  const btnClose= document.getElementById('btnModalClose');

  fabText && (fabText.onclick = ()=>open());
  fabVoice && (fabVoice.onclick = ()=>{
    // inicia a mesma conversa por voz usada na bolinha
    const sk = localStorage.getItem('dual.keys.openrouter') || '';
    const userName = (localStorage.getItem('infodose:userName') || '').trim();
    const model = LS.get('dual.openrouter.model');
    if(!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)){
      toast('Seu navegador n√£o suporta reconhecimento de fala.', 'err');
      return;
    }
    // Aproveita startSpeechConversation() existente, mas direciona sa√≠da ao chat tamb√©m
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const rec = new SpeechRecognition();
    rec.lang = 'pt-BR'; rec.interimResults = false; rec.maxAlternatives = 1;
    chatPush('chat-status','üéôÔ∏è Ouvindo‚Ä¶');
    rec.onresult = (ev)=>{
      const t = ev.results[0][0].transcript.trim();
      if(t){ chatSendText(t); }
    };
    rec.onerror = ()=> chatPush('chat-status','‚ùå Erro no reconhecimento.');
    rec.start();
  });

  btnSend && (btnSend.onclick = send);
  btnClose && (btnClose.onclick = close);
  modal && modal.addEventListener('click',(e)=>{ if(e.target===modal) close(); });
})();

/* ===================== NAV ajustes: 'revo' -> 'chat' ===================== */
// Atualize o handler de navega√ß√£o para conhecer a aba 'chat' em vez de 'revo'
(function patchNav(){
  const _nav = window.nav;
  window.nav = function(key){
    if(key==='revo') key='chat';
    _nav(key);
    if(key==='chat'){ try{ chatPush('chat-status','Conversa pronta.'); }catch(_){} }
  };
})();

/* ===================== BACKGROUND VIEWER (Brain) ===================== */
// Guardar hist√≥rico dos fundos: 'uno:bg:list' como array de {id,type,data,ts}
function bgListGet(){ try{ return JSON.parse(localStorage.getItem('uno:bg:list')||'[]') }catch(_){ return [] } }
function bgListSet(arr){ localStorage.setItem('uno:bg:list', JSON.stringify(arr||[])); }

function renderBgViewer(){
  const box = document.getElementById('bgViewer'); if(!box) return;
  const list = bgListGet();
  box.innerHTML = '';
  // Tamb√©m exponha o atual 'uno:bg' se n√£o estiver no hist√≥rico
  const cur = LS.get('uno:bg','');
  if(cur && !list.find(x=>x.data===cur)){
    list.unshift({id:'current', type: /^data:video\//.test(cur)?'video':'image', data: cur, ts: Date.now()});
  }
  if(!list.length){
    box.innerHTML = '<div class="mut">Nenhum background salvo ainda.</div>';
    return;
  }
  list.forEach((item,i)=>{
    const card = document.createElement('div'); card.className='bg-item';
    let el;
    if(/^data:video\//.test(item.data)){
      el = document.createElement('video'); el.src=item.data; el.muted=true; el.loop=true; el.autoplay=true; el.playsInline=true; el.className='thumb';
    } else {
      el = document.createElement('img'); el.src=item.data; el.alt=''; el.className='thumb';
    }
    const actions = document.createElement('div'); actions.className='actions';
    const bApply = document.createElement('button'); bApply.className='btn fx-trans fx-press ring'; bApply.textContent='Aplicar';
    const bDel   = document.createElement('button'); bDel.className='btn fx-trans fx-press ring';  bDel.textContent='Excluir';
    actions.appendChild(bApply); actions.appendChild(bDel);
    const meta = document.createElement('small'); meta.textContent = new Date(item.ts||Date.now()).toLocaleString();
    card.appendChild(el); card.appendChild(actions); card.appendChild(meta);
    box.appendChild(card);

    bApply.onclick = ()=>{ LS.set('uno:bg', item.data); LS.set('uno:theme','custom'); try{ document.getElementById('themeSelect').value='custom' }catch(_){};
      applyTheme(); toast('Fundo aplicado','ok'); };
    bDel.onclick = ()=>{ const arr = bgListGet().filter(x=>x!==item && x.data!==item.data); bgListSet(arr); renderBgViewer(); toast('Fundo removido','warn'); };
  });
}
renderBgViewer();

/* Hook no upload existente para salvar no hist√≥rico tamb√©m */
(function hookBgUpload(){
  const upload = document.getElementById('bgUpload');
  if(!upload) return;
  const old = upload.onchange;
  upload.onchange = (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f){ old && old(e); return; }
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const data = reader.result;
        const list = bgListGet(); 
        list.unshift({ id: 'bg_'+Date.now().toString(36), type: /^data:video\//.test(data)?'video':'image', data, ts: Date.now() });
        bgListSet(list.slice(0,50)); // limita hist√≥rico
        renderBgViewer();
      }catch(_){}
    };
    reader.readAsDataURL(f);
    // chama o handler original (que j√° salva uno:bg e aplica)
    if(typeof old === 'function'){ try{ old.call(upload, e) }catch(_){ } }
  };
})();
  </script>
</body>
</html>
