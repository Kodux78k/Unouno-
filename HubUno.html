<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"/>
<title>HUB UNO ‚Äî Home + Chat</title>
<meta name="theme-color" content="#0b0f14"/>
<style>
  :root{
    --grad-a:#ff52e5; --grad-b:#00c5e5;
    --fg:#f5f7ff; --mut:rgba(245,247,255,.68);
    --surface:rgba(15,17,32,.50); --surface-strong:rgba(15,17,32,.88);
    --bd:1px solid rgba(255,255,255,.12);
    --ok:#39ffb6; --warn:#ffb86b; --err:#ff6b6b;
    --r:18px; --r2:22px; --shadow:0 14px 40px rgba(0,0,0,.45);
    --tabsH:74px; --hdrH:64px; --blur:24px; --ease:cubic-bezier(.22,.61,.36,1);
  }
  body[data-theme="medium"]{
    --grad-a:#2c313c; --grad-b:#1f242d; --fg:#f1f2f5; --mut:rgba(241,242,245,.68);
    --surface:rgba(44,47,56,.40); --surface-strong:rgba(44,47,56,.75);
    --bd:1px solid rgba(255,255,255,.06); --ok:#68d391; --warn:#f6ad55; --err:#fc8181;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;color:var(--fg);background:linear-gradient(42deg,var(--grad-a),var(--grad-b)) fixed;
       font:14px/1.45 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; -webkit-font-smoothing:antialiased; overflow:hidden;}

  .fx-trans{transition:transform .16s var(--ease), background .25s var(--ease), box-shadow .25s var(--ease), border-color .25s var(--ease), color .25s var(--ease), opacity .25s var(--ease)}
  .fx-lift:hover{transform:translateY(-1px)} .fx-press:active{transform:translateY(0) scale(.98)}
  .ring:focus-visible{outline:0; box-shadow:0 0 0 4px rgba(255,255,255,.14)}
  button,.btn,.ib{background:var(--surface); border:var(--bd); color:var(--fg); font-weight:800; border-radius:12px; cursor:pointer; position:relative}
  .btn{padding:.58rem .9rem; background:linear-gradient(180deg,#11162a,#0b1122)}
  .btn.prime{background:linear-gradient(90deg,#a66fff,#6db4ff); color:#0b0f14; border-color:transparent}
  .ripple{position:absolute; inset:0; overflow:hidden; border-radius:inherit}
  .ripple>i{position:absolute; border-radius:999px; pointer-events:none; transform:translate(-50%,-50%);
    background:radial-gradient(closest-side, rgba(255,255,255,.35), rgba(255,255,255,0) 70%); animation:ripple .6s var(--ease) forwards}
  @keyframes ripple{from{opacity:.55; width:0; height:0} to{opacity:0; width:260px; height:260px}}

  header.mast{position:relative; height:var(--hdrH); z-index:100; display:flex; align-items:center; gap:10px; padding:0 12px;
    backdrop-filter:blur(var(--blur)) saturate(130%); background:linear-gradient(180deg, rgba(0,0,0,.28), rgba(0,0,0,0))}
  .ib{width:42px;height:42px;border-radius:50%;display:grid;place-items:center;box-shadow:var(--shadow)}
  .title{flex:1;text-align:center;line-height:1}
  .title h1{margin:0;font-size:18px;letter-spacing:.06em;font-weight:900}
  .title small{display:block;color:var(--mut);letter-spacing:.1em}

  main{position:relative;height:100%;padding-top:calc(var(--hdrH)+env(safe-area-inset-top));
       padding-bottom:calc(var(--tabsH)+env(safe-area-inset-bottom)); overflow:hidden}
  .view{position:absolute; inset:0; padding:12px 14px; overflow:auto; display:none}
  .view.active{display:block; animation:fade .18s var(--ease)} @keyframes fade{from{opacity:0; transform:translateY(6px)}}

  .grid{display:grid; gap:12px; max-width:820px; margin:0 auto}
  .cards{display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:12px}
  @media (max-width:560px){.cards{grid-template-columns:1fr}}
  .card{background:var(--surface); border:var(--bd); border-radius:var(--r2); box-shadow:var(--shadow); padding:12px; display:flex; gap:10px; align-items:center; position:relative}
  .ico{width:44px;height:44px;border-radius:14px;display:grid;place-items:center;background:rgba(255,255,255,.06);border:var(--bd)}
  .mut{color:var(--mut); font-size:12px}

  /* ===== Chat ===== */
  #v-chat{padding-bottom:110px} /* espa√ßo para input bar */
  .chat-wrap{display:flex; flex-direction:column; gap:10px; max-width:820px; margin:0 auto}
  .msg{max-width:82%; padding:10px 12px; border-radius:16px; border:var(--bd); background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
       box-shadow:var(--shadow); position:relative}
  .msg.user{margin-left:auto; background:linear-gradient(180deg, rgba(166,111,255,.18), rgba(109,180,255,.10))}
  .msg.bot{margin-right:auto; background:linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.06))}
  .msg .meta{display:flex; gap:8px; align-items:center; color:var(--mut); font-size:11px; margin-top:4px}
  .msg button.play{border:none; background:transparent; padding:0 4px; opacity:.8}
  .msg button.play:hover{opacity:1}
  .chat-input{position:fixed; left:10px; right:10px; bottom:calc(var(--tabsH) + 10px + env(safe-area-inset-bottom));
    display:flex; gap:8px; align-items:center; background:var(--surface-strong); border:var(--bd); border-radius:18px; padding:8px 10px; box-shadow:var(--shadow); z-index:95}
  .chat-input input{flex:1; background:transparent; border:0; outline:0; color:var(--fg); font-size:14px}
  .chat-input .act{display:grid; place-items:center; width:38px; height:38px; border-radius:12px}
  .chat-empty{opacity:.7; text-align:center; margin-top:12px; font-size:13px}

  /* ===== Dock + Tabs ===== */
  .dock{position:fixed; left:10px; right:10px; bottom:calc(var(--tabsH) + 8px + env(safe-area-inset-bottom)); display:flex; gap:8px; flex-wrap:wrap; z-index:80}
  .badge{display:inline-flex; gap:6px; align-items:center; padding:.38rem .65rem; border:1px solid #ffffff18; background:#0f1428; border-radius:999px; font-weight:800; position:relative}
  nav.tabbar{position:fixed; left:0; right:0; bottom:env(safe-area-inset-bottom,0); height:var(--tabsH); z-index:90; display:flex; justify-content:center; padding:6px 14px}
  .tabbar .inner{width:100%; max-width:820px; display:flex; justify-content:space-around; align-items:center; background:var(--surface); border:var(--bd); border-radius:22px; box-shadow:var(--shadow); padding:10px 14px}
  .tab{flex:1; display:flex; flex-direction:column; align-items:center; gap:6px; color:var(--mut); font-size:11px; font-weight:800; padding:8px; border-radius:14px; cursor:pointer; position:relative}
  .tab.active{color:var(--fg); background:rgba(255,255,255,.10); box-shadow:0 0 0 2px rgba(255,255,255,.10)}

  /* ===== Archetype area (Home resumida) ===== */
  .arch-container{position:relative; display:flex; flex-direction:column; align-items:center; gap:8px; justify-content:center; margin-top:24px}
  .arch-circle{position:relative; width:min(80vw,560px); aspect-ratio:1/1; border-radius:50%; overflow:hidden;
    border:1px solid rgba(255,255,255,.12); background:radial-gradient(60% 60% at 50% 50%, rgba(0,255,255,.1), rgba(255,255,255,.02)); box-shadow:var(--shadow); transition:transform .18s var(--ease)}
  .arch-circle.pressed{transform:scale(.96)}
  .arch-circle iframe{position:absolute; inset:0; width:100%; height:100%; border:0; background:transparent}
  .arch-switcher{display:flex; gap:6px; align-items:center; background:rgba(15,17,32,.7); border:1px solid rgba(255,255,255,.12); border-radius:999px; padding:4px 8px; backdrop-filter:blur(8px); z-index:70}
  .arch-switcher select{appearance:none; background:rgba(255,255,255,.06); color:var(--fg); border:1px solid rgba(255,255,255,.12); border-radius:999px; padding:4px 8px; font-size:12px}
  .arch-menu{position:absolute; top:calc(100% + 10px); left:50%; transform:translateX(-50%); display:none; gap:10px; z-index:70}
  .arch-menu.show{display:flex}
  .arch-menu button{border:var(--bd); background:var(--surface); border-radius:12px; padding:6px 8px; display:flex; flex-direction:column; align-items:center; color:var(--fg); font-size:10px}
  .arch-msg{margin-top:8px; padding:6px 10px; border-radius:12px; background:rgba(15,17,32,.72); color:var(--fg); font-size:13px; max-width:90%; text-align:center; pointer-events:none; opacity:0; transition:opacity .3s ease}
  .arch-msg.show{opacity:1}
  .audio-ripple{position:absolute; inset:0; border-radius:50%; pointer-events:auto; z-index:70}
  #v-home #unoCard{display:none}
</style>
</head>
<body>
  <header class="mast">
    <button class="ib fx-trans fx-press ring" id="btnBack" title="Voltar" aria-label="Voltar">‚¨ÖÔ∏è<span class="ripple"></span></button>
    <div class="title"><h1>HUB UNO</h1><small>Dual ¬∑ Trinity</small></div>
    <button class="ib fx-trans fx-press ring" id="btnDownload" title="Baixar HTML">‚¨áÔ∏è<span class="ripple"></span></button>
    <button class="ib fx-trans fx-press ring" id="btnHelp" title="Ajuda / Atalhos">‚ùî<span class="ripple"></span></button>
    <button class="ib fx-trans fx-press ring" id="btnBrain" title="Brain">üß†<span class="ripple"></span></button>
  </header>

  <section id="sessionsAnchor"></section>
  <div id="custom-bg" style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;overflow:hidden;pointer-events:none"></div>

  <main>
    <!-- HOME (mant√©m estrutura compacta com c√≠rculo + cards + bot√µes) -->
    <section id="v-home" class="view active">
      <div class="grid">
        <div class="arch-container">
          <div class="arch-switcher">
            <button class="btn fx-trans fx-press ring" id="arch-prev" title="Anterior">‚óÄ</button>
            <select id="arch-select" title="Escolher arqu√©tipo"></select>
            <button class="btn fx-trans fx-press ring" id="arch-next" title="Pr√≥ximo">‚ñ∂</button>
          </div>
          <div class="arch-circle">
            <div id="arch-fadeCover"></div>
            <div id="audioRipple" class="audio-ripple"></div>
            <iframe id="arch-frame" title="Archetype Core" sandbox="allow-scripts" referrerpolicy="no-referrer"></iframe>
          </div>
          <div id="archMsg" class="arch-msg"></div>
          <div id="archMenu" class="arch-menu">
            <button data-nav="apps"><span>Apps</span></button>
            <button data-nav="stack"><span>Stack</span></button>
            <button data-nav="brain"><span>Usu√°rio</span></button>
            <button data-nav="home"><span>Arqu√©tipo</span></button>
            <button data-nav="chat"><span>Chat</span></button>
            <button data-audio="true" id="archAudioBtn"><span>√Åudio</span></button>
          </div>
        </div>
        <div class="cards">
          <button class="card fx-trans fx-press ring" data-nav="apps">
            <div class="ico">üóÇ</div><div><div style="font-weight:800">Apps</div><div class="mut" id="homeAppsStatus">‚Äì</div></div><span class="ripple"></span>
          </button>
          <button class="card fx-trans fx-press ring" data-nav="stack">
            <div class="ico">üìö</div><div><div style="font-weight:800">Stack</div><div class="mut" id="homeStackStatus">‚Äì</div></div><span class="ripple"></span>
          </button>
          <button class="card fx-trans fx-press ring" data-nav="brain">
            <div class="ico">üë§</div><div><div style="font-weight:800">Usu√°rio</div><div class="mut" id="homeUserStatus">‚Äì</div></div><span class="ripple"></span>
          </button>
          <button class="card fx-trans fx-press ring" data-nav="home">
            <div class="ico">‚òØ</div><div><div style="font-weight:800">Arqu√©tipo</div><div class="mut" id="homeArchStatus">‚Äì</div></div><span class="ripple"></span>
          </button>
        </div>
      </div>
    </section>

    <!-- APPS / STACK / BRAIN (m√≠nimos para exemplo) -->
    <section id="v-apps" class="view"><div class="grid"><div class="card">Cat√°logo (simplificado para foco no Chat).</div></div></section>
    <section id="v-stack" class="view"><div class="grid"><div class="card">Sess√µes aqui.</div><div id="stackWrap" class="grid"></div></div></section>
    <section id="v-brain" class="view"><div class="grid">
      <div class="card fx-trans fx-lift">
        <div style="font-weight:800">Usu√°rio</div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
          <input id="userName" class="btn" placeholder="Seu nome" style="flex:1; background:#0f1426; border:var(--bd)"/>
          <button id="saveName" class="btn prime fx-trans fx-press ring">Salvar<span class="ripple"></span></button>
        </div>
      </div>
      <div class="card fx-trans fx-lift">
        <div style="font-weight:800">OpenRouter</div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap">
          <select id="model" class="btn" style="max-width:260px; background:#0f1426; border:var(--bd)"></select>
          <input id="sk" class="btn" placeholder="sk-or-v1-‚Ä¶" style="flex:1; background:#0f1426; border:var(--bd)"/>
          <button id="saveSK" class="btn fx-trans fx-press ring">Salvar<span class="ripple"></span></button>
        </div>
      </div>
      <div class="card"><div style="font-weight:800">Logs</div><pre id="logs" style="margin:0;font:12px/1.4 ui-monospace,monospace;color:var(--mut);max-height:140px;overflow:auto"></pre></div>
    </div></section>

    <!-- ===== CHAT (NOVO) ===== -->
    <section id="v-chat" class="view">
      <div class="chat-wrap" id="chatWrap">
        <div class="chat-empty">Comece uma conversa com seu arqu√©tipo. Toque no üéôÔ∏è para falar.</div>
      </div>
      <div class="chat-input">
        <button class="act btn fx-trans fx-press ring" id="btnMic" title="Falar">üéôÔ∏è<span class="ripple"></span></button>
        <input id="chatInput" type="text" placeholder="Digite ou fale com seu arqu√©tipo‚Ä¶"/>
        <button class="act btn fx-trans fx-press ring" id="btnSend" title="Enviar">‚û§<span class="ripple"></span></button>
      </div>
    </section>

    <!-- REVO (placeholder) -->
    <section id="v-revo" class="view"><div class="grid"><div class="card">Revo embed (mantido fora deste recorte).</div></div></section>
  </main>

  <div id="dock" class="dock"></div>
  <nav class="tabbar">
    <div class="inner">
      <button class="tab fx-trans fx-press ring active" data-nav="home">üè†<span style="display:none">Home</span><span class="ripple"></span></button>
      <button class="tab fx-trans fx-press ring" data-nav="apps">üóÇ<span style="display:none">Apps</span><span class="ripple"></span></button>
      <button class="tab fx-trans fx-press ring" data-nav="stack">üìö<span style="display:none">Stack</span><span class="ripple"></span></button>
      <button class="tab fx-trans fx-press ring" data-nav="chat">üí¨<span style="display:none">Chat</span><span class="ripple"></span></button>
      <button class="tab fx-trans fx-press ring" data-nav="brain">üß†<span style="display:none">Brain</span><span class="ripple"></span></button>
      <button class="tab fx-trans fx-press ring" data-nav="revo">üåê<span style="display:none">Revo</span><span class="ripple"></span></button>
    </div>
  </nav>

  <!-- ===== Apps embutidos m√≠nimos (para contagem/status) ===== -->
  <script id="APPS_JSON" type="application/json">{ "apps":[
    {"key":"atlas","title":"Atlas ¬∑ Cartesius","desc":"Planejador estrat√©gico.","url":"about:blank","icon":"atlas"},
    {"key":"nova","title":"Nova ¬∑ Inspira","desc":"Ideias e mapas mentais.","url":"about:blank","icon":"nova"}
  ]}</script>

<script>
/* =============== Helpers & LS =============== */
const $=(q,r=document)=>r.querySelector(q), $$=(q,r=document)=>Array.from(r.querySelectorAll(q));
const LS={get:(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch(e){return d}}, set:(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}}, raw:(k)=>localStorage.getItem(k)||''};
function addRipple(el){ if(!el) return; if(!el.querySelector('.ripple')){const s=document.createElement('span'); s.className='ripple'; el.appendChild(s);} }
$$('button').forEach(addRipple);

/* =============== Logs =============== */
const dualState={perf:localStorage.getItem('hub.perf')||'med', voice:localStorage.getItem('hub.voice')||'Nova', logs:[]};
function dualLog(msg){ const e='['+new Date().toLocaleTimeString()+'] '+msg; dualState.logs.unshift(e); const l=$('#logs'); if(l) l.textContent=dualState.logs.slice(0,60).join('\\n');}

/* =============== Toast =============== */
const toastBox=document.createElement('div'); toastBox.style.cssText='position:fixed;right:14px;bottom:calc(var(--tabsH) + 16px);display:grid;gap:8px;z-index:120'; document.body.appendChild(toastBox);
function toast(msg,type='ok'){ const el=document.createElement('div'); el.className='fx-trans';
  const bg= type==='ok'?'linear-gradient(90deg,#1b2a2a,#123c2e)':(type==='warn'?'linear-gradient(90deg,#2f261b,#3c2d12)':'linear-gradient(90deg,#2f1b1b,#3c1212)');
  el.style.cssText=`background:${bg};color:var(--fg);border:${getComputedStyle(document.documentElement).getPropertyValue('--bd')};padding:.6rem .8rem;border-radius:12px;box-shadow:var(--shadow)`;
  el.textContent=msg; toastBox.appendChild(el); setTimeout(()=>{el.style.opacity=.0; el.style.transform='translateY(6px)'; setTimeout(()=>el.remove(),220)},1600);}

/* =============== Tema inicial (medium por padr√£o) =============== */
if(!LS.get('uno:theme')) LS.set('uno:theme','medium');
applyTheme();
function applyTheme(){
  const theme=LS.get('uno:theme','medium');
  if(theme==='default') delete document.body.dataset.theme; else document.body.dataset.theme=theme;
  const bg=$('#custom-bg'); if(!bg) return; if(theme!=='custom'){ bg.innerHTML=''; return; }
  const d=LS.get('uno:bg',''); bg.innerHTML=''; if(!d) return;
  if(/^data:video\\//.test(d)){ const v=document.createElement('video'); Object.assign(v,{src:d,autoplay:true,loop:true,muted:true,playsInline:true}); v.style.width='100%'; v.style.height='100%'; v.style.objectFit='cover'; bg.appendChild(v);}
  else { const i=document.createElement('img'); i.src=d; i.style.width='100%'; i.style.height='100%'; i.style.objectFit='cover'; bg.appendChild(i); }
}

/* =============== Sauda√ß√µes & Status Home =============== */
function showArchMessage(text,type='info'){ const el=$('#archMsg'); if(!el) return; el.textContent=text;
  if(type==='ok'){el.style.background='rgba(57,255,182,0.75)'; el.style.color='#0b0f14';}
  else if(type==='warn'){el.style.background='rgba(255,184,107,0.78)'; el.style.color='#0b0f14';}
  else if(type==='err'){el.style.background='rgba(255,107,107,0.78)'; el.style.color='#0b0f14';}
  else{el.style.background='rgba(15,17,32,0.72)'; el.style.color='';}
  el.classList.add('show'); clearTimeout(el._tm); el._tm=setTimeout(()=>el.classList.remove('show'),4000);
}
function speakWithActiveArch(text){ try{
  const sel=$('#arch-select'); let f=sel?sel.value||'':''; const key=(f.replace(/\\.html$/i,'')||'Nova'); const saved=LS.get('infodose:voices',{})||{};
  const voices=speechSynthesis.getVoices(); let voice=saved[key] ? voices.find(v=>v.name===saved[key]) : voices.find(v=>v.lang&&(v.lang.startsWith('pt')||v.lang.startsWith('en')));
  if(!voice && voices.length) voice=voices[0]; if(!voice) return; const u=new SpeechSynthesisUtterance(text); u.voice=voice; speechSynthesis.cancel(); speechSynthesis.speak(u);
}catch(e){} }

/* =============== Navega√ß√£o =============== */
function nav(key){
  const tabs=['home','apps','stack','chat','brain','revo'];
  tabs.forEach(k=>{$('#v-'+k).classList.toggle('active',k===key); $(`.tab[data-nav="${k}"]`).classList.toggle('active',k===key);});
  LS.set('uno:lastTab',key);
  const phrases={home:'P√°gina inicial',apps:'Abrindo apps',stack:'Abrindo stack',brain:'Abrindo usu√°rio',chat:'Abrindo chat',revo:'Abrindo revo'};
  if(phrases[key]){ speakWithActiveArch(phrases[key]); showArchMessage(phrases[key]); }
  if(key==='home') updateHomeStatus();
}
$$('.tab,[data-nav]').forEach(b=>b.addEventListener('click',()=>nav(b.dataset.nav||'home')));
$('#btnBack').onclick=()=>{ try{history.length>1&&history.back()}catch{} };
$('#btnBrain').onclick=()=>nav('brain');
const last=LS.get('uno:lastTab','home'); nav(last);

/* =============== Apps m√≠nimos p/ status da Home =============== */
const RAW={apps:[]};
(function loadEmbeddedApps(){
  try{ const raw=JSON.parse($('#APPS_JSON').textContent||'{}'); RAW.apps=Array.isArray(raw.apps)?raw.apps:[] }catch{ RAW.apps=[] }
  updateHomeStatus();
})();
function updateHomeStatus(){
  try{ const total=(RAW.apps||[]).length; const el=$('#homeAppsStatus'); if(el) el.textContent=total+' app'+(total===1?'':'s'); }catch(e){}
  try{ const sess=document.querySelectorAll('#stackWrap .session').length; const el=$('#homeStackStatus'); if(el) el.textContent=sess+' sess√£o'+(sess===1?'':'s'); }catch(e){}
  try{ const name=(localStorage.getItem('infodose:userName')||'').trim(); const theme=LS.get('uno:theme','medium');
       const label={'default':'padr√£o','medium':'cinza','custom':'personalizado'}[theme]||theme;
       const el=$('#homeUserStatus'); if(el) el.textContent=(name||'Usu√°rio')+' ¬∑ '+label; }catch(e){}
  try{ const sel=$('#arch-select'); let n=''; if(sel&&sel.options.length){ const opt=sel.options[sel.selectedIndex]; if(opt) n=opt.textContent.replace(/\\.html$/i,''); }
       const el=$('#homeArchStatus'); if(el) el.textContent=n||'Nenhum'; }catch(e){}
}

/* =============== Archetypes (lista simples) =============== */
(function(){
  const list=['luxara.html','rhea.html','aion.html','atlas.html','nova.html','genus.html','lumine.html','kaion.html','kaos.html','horus.html','elysha.html'];
  const sel=$('#arch-select'), frame=$('#arch-frame'), fade=$('#arch-fadeCover'); let cur=0;
  function populate(){ sel.innerHTML=''; list.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); }); }
  function setSrcByIndex(i){ if(!list.length) return; const n=(i+list.length)%list.length; cur=n; sel.selectedIndex=n; const file=list[n]; frame.src='./archetypes/'+file;
    try{ speakWithActiveArch('Ol√°, eu sou '+file.replace(/\\.html$/i,'')); }catch(e){} updateHomeStatus(); }
  populate(); if(list.length) setSrcByIndex(0);
  $('#arch-prev').addEventListener('click',()=>{ fade.classList.add('show'); setTimeout(()=>{ setSrcByIndex(cur-1); setTimeout(()=>fade.classList.remove('show'),200); },140); });
  $('#arch-next').addEventListener('click',()=>{ fade.classList.add('show'); setTimeout(()=>{ setSrcByIndex(cur+1); setTimeout(()=>fade.classList.remove('show'),200); },140); });
  sel.addEventListener('change',()=>{ cur=sel.selectedIndex; fade.classList.add('show'); setTimeout(()=>{ setSrcByIndex(cur); setTimeout(()=>fade.classList.remove('show'),200); },140); });
})();

/* =============== Audio ripple + clique na bolinha =============== */
(function initAudioRipple(){
  const clickLayer=$('#audioRipple'); const archCircleEl=document.querySelector('.arch-circle'); if(!clickLayer||!archCircleEl) return;
  let enabled=false, audioCtx=null, analyser=null, micStream=null;
  async function start(){ try{ const stream=await navigator.mediaDevices.getUserMedia({audio:true}); micStream=stream;
      audioCtx=new (window.AudioContext||window.webkitAudioContext)(); const src=audioCtx.createMediaStreamSource(stream);
      analyser=audioCtx.createAnalyser(); analyser.fftSize=256; src.connect(analyser); animate(); }catch(e){ toast('N√£o foi poss√≠vel acessar o microfone.','err'); enabled=false; archCircleEl.classList.remove('audio-on'); } }
  function stop(){ if(micStream){ micStream.getTracks().forEach(t=>t.stop()); micStream=null; } if(audioCtx){ try{audioCtx.close()}catch{} audioCtx=null; archCircleEl.style.boxShadow=''; }
  function animate(){ if(!enabled||!analyser) return; const buf=new Uint8Array(analyser.fftSize); analyser.getByteTimeDomainData(buf);
    let sum=0; for(let i=0;i<buf.length;i++){ const v=(buf[i]-128)/128; sum+=v*v; } const rms=Math.sqrt(sum/buf.length);
    const intensity=Math.min(0.8, rms*4), blur=rms*80; archCircleEl.style.boxShadow=`0 0 ${blur}px rgba(255,255,255,${intensity})`; requestAnimationFrame(animate); }
  clickLayer.addEventListener('click', ()=> startDualInteraction());
  window.toggleAudio=function(){ enabled=!enabled; archCircleEl.classList.toggle('audio-on',enabled); if(enabled) start(); else stop(); };
})();
function startDualInteraction(){ const archCircle=$('.arch-circle'); if(!archCircle) return; archCircle.classList.add('pressed'); setTimeout(()=>archCircle.classList.remove('pressed'),180);
  const greet='Oi Dual'; showArchMessage(greet,'ok'); try{ speakWithActiveArch(greet);}catch{} }

/* =============== Brain b√°sicos =============== */
const MODELS=['openrouter/auto','anthropic/claude-3.5-sonnet','openai/gpt-4.1-mini','google/gemini-1.5-pro','meta/llama-3.1-405b-instruct','mistral/mistral-large-latest'];
(function initBrain(){ const sel=$('#model'); sel.innerHTML=''; MODELS.forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; sel.appendChild(o) });
  sel.value=LS.get('dual.openrouter.model', MODELS[0]); $('#sk').value=LS.raw('dual.keys.openrouter');
  $('#saveSK').onclick=()=>{ LS.set('dual.openrouter.model', sel.value); localStorage.setItem('dual.keys.openrouter',$('#sk').value||''); toast('Configura√ß√µes salvas','ok'); };
  $('#saveName').onclick=()=>{ localStorage.setItem('infodose:userName', ($('#userName').value||'').trim()); toast('Nome salvo','ok'); updateHomeStatus(); };
})();

/* =============== Chat Engine =============== */
const chatWrap=$('#chatWrap'), chatInput=$('#chatInput'), btnSend=$('#btnSend'), btnMic=$('#btnMic');
function addMsg(text, who='bot'){ const box=document.createElement('div'); box.className='msg '+(who==='user'?'user':'bot');
  const content=document.createElement('div'); content.textContent=text; box.appendChild(content);
  const meta=document.createElement('div'); meta.className='meta';
  const ts=new Date().toLocaleTimeString(); meta.innerHTML=`<span>${ts}</span>`;
  if(who==='bot'){ const play=document.createElement('button'); play.className='play'; play.title='Ouvir'; play.textContent='‚ñ∂Ô∏è';
    play.onclick=()=>speakWithActiveArch(text); meta.prepend(play); }
  box.appendChild(meta); $('.chat-empty', chatWrap)?.remove(); chatWrap.appendChild(box); chatWrap.scrollTop=chatWrap.scrollHeight; return box; }

async function sendAIMessage(content, sk, model){
  const payload={model, messages:[{role:'system',content:'Voc√™ √© um assistente amistoso que responde em portugu√™s.'},{role:'user',content:content}], max_tokens:200, temperature:0.7};
  const url='https://openrouter.ai/api/v1/chat/completions';
  const res=await fetch(url,{method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${sk}`}, body:JSON.stringify(payload)});
  if(!res.ok) throw new Error('API: '+res.status); const data=await res.json();
  return data.choices?.[0]?.message?.content || '';
}

async function handleUserMessage(text){
  if(!text.trim()) return;
  addMsg(text,'user');
  const userName=(localStorage.getItem('infodose:userName')||'').trim()||'Dual';
  const sk=localStorage.getItem('dual.keys.openrouter')||''; const model=LS.get('dual.openrouter.model', MODELS[0]);
  let reply='';
  try{
    if(sk){ reply=await sendAIMessage(`${userName} disse: ${text}`, sk, model); }
    else{
      // Fallback offline: resposta curta com persona do arqu√©tipo ativo
      const sel=$('#arch-select'); const arch=(sel && sel.value ? sel.value.replace(/\\.html$/i,'') : 'Nova');
      const presets={
        Nova:(t)=>`Vamos expandir isso juntos: "${t}". Experimente uma varia√ß√£o com 10% a mais de risco criativo.`,
        Atlas:(t)=>`Plano r√°pido: 1) Definir objetivo de "${t}". 2) 3 microa√ß√µes. 3) Iterar em 30min.`,
        Kaos:(t)=>`Desalinha e relinha: que regra voc√™ pode quebrar em "${t}" sem perder o sentido?`
      };
      reply=(presets[arch]?.(text)) || `(${arch}) Entendi: "${text}". Vamos em frente.`;
    }
  }catch(e){ reply='Desculpe, n√£o consegui responder agora.'; }
  const b=addMsg(reply,'bot'); try{ speakWithActiveArch(reply); }catch{}
}

btnSend.onclick=()=>{ const t=chatInput.value; chatInput.value=''; handleUserMessage(t); };
chatInput.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); btnSend.click(); } });

btnMic.onclick=()=>{
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ toast('Reconhecimento de fala n√£o suportado.','err'); return; }
  const r=new SR(); r.lang='pt-BR'; r.interimResults=false; r.maxAlternatives=1;
  r.onresult=(ev)=>{ const tx=ev.results[0][0].transcript.trim(); handleUserMessage(tx); };
  r.onerror=()=>toast('Erro no microfone','err'); r.start(); toast('Estou ouvindo‚Ä¶','ok');
};

/* =============== Download HTML + Ajuda =============== */
function downloadSelf(){ try{ const clone=document.documentElement.cloneNode(true); const html='<!doctype html>\\n'+clone.outerHTML;
  const blob=new Blob([html],{type:'text/html;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='HUB-UNO-Chat.html'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500); toast('HTML exportado','ok'); }catch(e){ alert('Falha ao exportar: '+e.message); } }
$('#btnDownload').onclick=downloadSelf;
const modalHelp=document.createElement('div'); modalHelp.className='modal'; modalHelp.innerHTML='<div class="panel"><h3 style="margin:0">Ajuda</h3><div class="mut" style="margin-top:8px">g+h Home ¬∑ g+c Chat ¬∑ Ctrl/Cmd+S exporta</div></div>';
document.body.appendChild(modalHelp); $('#btnHelp').onclick=()=>{ modalHelp.classList.add('open'); modalHelp.setAttribute('aria-hidden','false'); };
modalHelp.addEventListener('click',e=>{ if(e.target===modalHelp){ modalHelp.classList.remove('open'); modalHelp.setAttribute('aria-hidden','true'); }});
window.addEventListener('keydown',e=>{ if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='s'){ e.preventDefault(); downloadSelf(); return; }
  if(e.key.toLowerCase()==='g'){ window._gT=true; setTimeout(()=>window._gT=false,600); return; }
  if(!window._gT) return; const k=e.key.toLowerCase(); if(k==='h') nav('home'); if(k==='c') nav('chat'); if(k==='a') nav('apps'); if(k==='s') nav('stack'); if(k==='b') nav('brain'); if(k==='r') nav('revo'); window._gT=false;});
/* =============== Sauda√ß√£o inicial =============== */
(function welcome(){ const name=(localStorage.getItem('infodose:userName')||'').trim();
  if(!name){ showArchMessage('Salve! Ative sua Dual Infodose registrando seu nome na se√ß√£o Brain.','warn'); }
  else{ showArchMessage(`Bem-vindo de volta, ${name}. UNO est√° ao seu lado.`,'ok'); }
})();
</script>
</body>
</html>